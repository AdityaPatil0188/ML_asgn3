\input{preamble} % ok, start here. % \begin{document} \title{commutative algebra} \maketitle \phantomsection \label{section-phantom} \tableofcontents \section{introduction} \label{section-introduction} \noindent basic commutative algebra will be explained in this document. a reference is \cite{matca}. \section{conventions} \label{section-conventions} \noindent a ring is commutative with $1$. the zero ring is a ring. in fact it is the only ring that does not have a prime ideal. the kronecker symbol $\delta_{ij}$ will be used. if $r \to s$ is a ring map and $\mathfrak q$ a prime of $s$, then we use the notation ``$\mathfrak p = r \cap \mathfrak q$'' to indicate the prime which is the inverse image of $\mathfrak q$ under $r \to s$ even if $r$ is not a subring of $s$ and even if $r \to s$ is not injective. \section{basic notions} \label{section-rings-basic} \noindent the following is a list of basic notions in commutative algebra. some of these notions are discussed in more detail in the text that follows and some are defined in the list, but others are considered basic and will not be defined. if you are not familiar with most of the italicized concepts, then we suggest looking at an introductory text on algebra before continuing. \begin{enumerate} \item $r$ is a {\it ring}, \label{item-ring} \item $x\in r$ is {\it nilpotent}, \label{item-ring-element-nilpotent} \item $x\in r$ is a {\it zerodivisor}, \label{item-ring-element-zerodivisor} \item $x\in r$ is a {\it unit}, \label{item-ring-element-unit} \item $e \in r$ is an {\it idempotent}, \label{item-ring-element-idempotent} \item an idempotent $e \in r$ is called {\it trivial} if $e = 1$ or $e = 0$, \label{item-idempotent-trivial} \item $\varphi : r_1 \to r_2$ is a {\it ring homomorphism}, \label{item-ring-homomorphism} \item \label{item-ring-homomorphism-finite-presentation} $\varphi : r_1 \to r_2$ is {\it of finite presentation}, or {\it $r_2$ is a finitely presented $r_1$-algebra}, see definition \ref{definition-finite-type}, \item \label{item-ring-homomorphism-finite-type} $\varphi : r_1 \to r_2$ is {\it of finite type}, or {\it $r_2$ is a finite type $r_1$-algebra}, see definition \ref{definition-finite-type}, \item \label{item-ring-homomorphism-finite} $\varphi : r_1 \to r_2$ is {\it finite}, or {\it $r_2$ is a finite $r_1$-algebra}, \item $r$ is a {\it (integral) domain}, \label{item-ring-domain} \item $r$ is {\it reduced}, \label{item-ring-reduced} \item $r$ is {\it noetherian}, \label{item-ring-noetherian} \item $r$ is a {\it principal ideal domain} or a {\it pid}, \label{item-ring-pid} \item $r$ is a {\it euclidean domain}, \label{item-ring-euclidean} \item $r$ is a {\it unique factorization domain} or a {\it ufd}, \label{item-ring-ufd} \item $r$ is a {\it discrete valuation ring} or a {\it dvr}, \label{item-ring-dvr} \item $k$ is a {\it field}, \label{item-field} \item $l/k$ is a {\it field extension}, \label{item-field-extension} \item $l/k$ is an {\it algebraic field extension}, \label{item-field-extension-algebraic} \item $\{t_i\}_{i\in i}$ is a {\it transcendence basis} for $l$ over $k$, \label{item-transcendence-basis} \item the {\it transcendence degree} $\text{trdeg}(l/k)$ of $l$ over $k$, \label{item-transcendence-degree} \item the field $k$ is {\it algebraically closed}, \label{item-algebraically-closed} \item \label{item-extend-into-algebraically-closed} if $l/k$ is algebraic, and $\omega/k$ an extension with $\omega$ algebraically closed, then there exists a ring map $l \to \omega$ extending the map on $k$, \item $i \subset r$ is an {\it ideal}, \label{item-ideal} \item $i \subset r$ is {\it radical}, \label{item-ideal-radical} \item if $i$ is an ideal then we have its {\it radical} $\sqrt{i}$, \label{item-radical-ideal} \item \label{item-ideal-nilpotent} $i \subset r$ is {\it nilpotent} means that $i^n = 0$ for some $n \in \mathbf{n}$, \item \label{item-ideal-locally-nilpotent} $i \subset r$ is {\it locally nilpotent} means that every element of $i$ is nilpotent, \item $\mathfrak p \subset r$ is a {\it prime ideal}, \label{item-prime-ideal} \item \label{item-prime-product-ideals} if $\mathfrak p \subset r$ is prime and if $i, j \subset r$ are ideal, and if $ij\subset \mathfrak p$, then $i \subset \mathfrak p$ or $j \subset \mathfrak p$. \item $\mathfrak m \subset r$ is a {\it maximal ideal}, \label{item-maximal-ideal} \item any nonzero ring has a maximal ideal, \label{item-exists-maximal-ideal} \item \label{item-jacobson-radical} the {\it jacobson radical} of $r$ is $\text{rad}(r) = \bigcap_{\mathfrak m \subset r} \mathfrak m$ the intersection of all the maximal ideals of $r$, \item the ideal $(t)$ {\it generated} by a subset $t \subset r$, \label{item-ideal-generated-by} \item the {\it quotient ring} $r/i$, \label{item-quotient-ring} \item an ideal $i$ in the ring $r$ is prime if and only if $r/i$ is a domain, \label{item-characterize-prime-ideal} \item \label{item-characterize-maximal-ideal} an ideal $i$ in the ring $r$ is maximal if and only if the ring $r/i$ is a field, \item \label{item-inverse-image-ideal} if $\varphi : r_1 \to r_2$ is a ring homomorphism, and if $i \subset r_2$ is an ideal, then $\varphi^{-1}(i)$ is an ideal of $r_1$, \item \label{item-image-ideal} if $\varphi : r_1 \to r_2$ is a ring homomorphism, and if $i \subset r_1$ is an ideal, then $\varphi(i) \cdot r_2$ (sometimes denoted $i \cdot r_2$, or $ir_2$) is the ideal of $r_2$ generated by $\varphi(i)$, \item \label{item-inverse-image-prime} if $\varphi : r_1 \to r_2$ is a ring homomorphism, and if $\mathfrak p \subset r_2$ is a prime ideal, then $\varphi^{-1}(\mathfrak p)$ is a prime ideal of $r_1$, \item $m$ is an {\it $r$-module}, \label{item-module} \item \label{item-annihilator} for $m \in m$ the {\it annihilator} $i = \{f \in r \mid fm = 0\}$ of $m$ in $r$, \item $n \subset m$ is an {\it $r$-submodule}, \label{item-submodule} \item $m$ is a {\it noetherian $r$-module}, \label{item-noetherian-module} \item $m$ is a {\it finite $r$-module}, \label{item-finite-module} \item $m$ is a {\it finitely generated $r$-module}, \label{item-finitely-generated-module} \item $m$ is a {\it finitely presented $r$-module}, \label{item-finitely-presented-module} \item $m$ is a {\it free $r$-module}, \label{item-free-module} \item \label{item-extension-free} if $0 \to k \to l \to m \to 0$ is a short exact sequence of $r$-modules and $k$, $m$ are free, then $l$ is free, \item if $n \subset m \subset l$ are $r$-modules, then $l/m = (l/n)/(m/n)$, \label{item-isomorphism-theorem} \item $s$ is a {\it multiplicative subset of $r$}, \label{item-multiplicative-subset} \item the {\it localization} $r \to s^{-1}r$ of $r$, \label{item-localization-ring} \item \label{item-localization-zero} if $r$ is a ring and $s$ is a multiplicative subset of $r$ then $s^{-1}r$ is the zero ring if and only if $s$ contains $0$, \item \label{item-localize-nonzerodivisors} if $r$ is a ring and if the multiplicative subset $s$ consists completely of nonzerodivisors, then $r \to s^{-1}r$ is injective, \item if $\varphi : r_1 \to r_2$ is a ring homomorphism, and $s$ is a multiplicative subset of $r_1$, then $\varphi(s)$ is a multiplicative subset of $r_2$, \item \label{item-products-multiplicative-subsets} if $s$, $s'$ are multiplicative subsets of $r$, and if $ss'$ denotes the set of products $ss' = \{r \in r \mid \exists s\in s, \exists s' \in s', r = ss'\}$ then $ss'$ is a multiplicative subset of $r$, \item \label{item-localization-localization} if $s$, $s'$ are multiplicative subsets of $r$, and if $\overline{s}$ denotes the image of $s$ in $(s')^{-1}r$, then $(ss')^{-1}r = \overline{s}^{-1}((s')^{-1}r)$, \item the {\it localization} $s^{-1}m$ of the $r$-module $m$, \label{item-localization-module} \item \label{item-localization-exact} the functor $m \mapsto s^{-1}m$ preserves injective maps, surjective maps, and exactness, \item \label{item-localization-localization-module} if $s$, $s'$ are multiplicative subsets of $r$, and if $m$ is an $r$-module, then $(ss')^{-1}m = s^{-1}((s')^{-1}m)$, \item \label{item-localize-ideal} if $r$ is a ring, $i$ an ideal of $r$, and $s$ a multiplicative subset of $r$, then $s^{-1}i$ is an ideal of $s^{-1}r$, and we have $s^{-1}r/s^{-1}i = \overline{s}^{-1}(r/i)$, where $\overline{s}$ is the image of $s$ in $r/i$, \item \label{item-ideal-in-localization} if $r$ is a ring, and $s$ a multiplicative subset of $r$, then any ideal $i'$ of $s^{-1}r$ is of the form $s^{-1}i$, where one can take $i$ to be the inverse image of $i'$ in $r$, \item \label{item-submodule-in-localization} if $r$ is a ring, $m$ an $r$-module, and $s$ a multiplicative subset of $r$, then any submodule $n'$ of $s^{-1}m$ is of the form $s^{-1}n$ for some submodule $n \subset m$, where one can take $n$ to be the inverse image of $n'$ in $m$, \item if $s = \{1, f, f^2, \ldots\}$ then $r_f = s^{-1}r$ and $m_f = s^{-1}m$, \label{item-localize-f} \item \label{item-localize-p} if $s = r \setminus \mathfrak p = \{x\in r \mid x\not\in \mathfrak p\}$ for some prime ideal $\mathfrak p$, then it is customary to denote $r_{\mathfrak p} = s^{-1}r$ and $m_{\mathfrak p} = s^{-1}m$, \item a {\it local ring} is a ring with exactly one maximal ideal, \label{item-local-ring} \item a {\it semi-local ring} is a ring with finitely many maximal ideals, \label{item-semi-local-ring} \item \label{item-localize-p-local-ring} if $\mathfrak p$ is a prime in $r$, then $r_{\mathfrak p}$ is a local ring with maximal ideal $\mathfrak p r_{\mathfrak p}$, \item \label{item-residue-field} the {\it residue field}, denoted $\kappa(\mathfrak p)$, of the prime $\mathfrak p$ in the ring $r$ is the field of fractions of the domain $r/\mathfrak p$; it is equal to $r_\mathfrak p/\mathfrak pr_\mathfrak p = (r \setminus \mathfrak p)^{-1}r/\mathfrak p$, \item given $r$ and $m_1$, $m_2$ the {\it tensor product} $m_1 \otimes_r m_2$, \label{item-tensor-product} \item \label{item-cauchy-binet} given matrices $a$ and $b$ in a ring $r$ of sizes $m \times n$ and $n \times m$ we have $\det(ab) = \sum \det(a_s)\det({}_sb)$ in $r$ where the sum is over subsets $s \subset \{1, \ldots, n\}$ of size $m$ and $a_s$ is the $m \times m$ submatrix of $a$ with columns corresponding to $s$ and ${}_sb$ is the $m \times m$ submatrix of $b$ with rows corresponding to $s$, \item etc. \end{enumerate} \section{snake lemma} \label{section-snake} \noindent the snake lemma and its variants are discussed in the setting of abelian categories in homology, section \ref{homology-section-abelian-categories}. \begin{lemma} \label{lemma-snake} \begin{reference} \cite[iii, lemma 3.3]{cartan-eilenberg} \end{reference} given a commutative diagram $$ \xymatrix{ & x \ar[r] \ar[d]^\alpha & y \ar[r] \ar[d]^\beta & z \ar[r] \ar[d]^\gamma & 0 \\ 0 \ar[r] & u \ar[r] & v \ar[r] & w } $$ of abelian groups with exact rows, there is a canonical exact sequence $$ \ker(\alpha) \to \ker(\beta) \to \ker(\gamma) \to \coker(\alpha) \to \coker(\beta) \to \coker(\gamma) $$ moreover: if $x \to y$ is injective, then the first map is injective; if $v \to w$ is surjective, then the last map is surjective. \end{lemma} \begin{proof} the map $\partial : \ker(\gamma) \to \coker(\alpha)$ is defined as follows. take $z \in \ker(\gamma)$. choose $y \in y$ mapping to $z$. then $\beta(y) \in v$ maps to zero in $w$. hence $\beta(y)$ is the image of some $u \in u$. set $\partial z = \overline{u}$, the class of $u$ in the cokernel of $\alpha$. proof of exactness is omitted. \end{proof} \section{finite modules and finitely presented modules} \label{section-module-finite-type} \noindent just some basic notation and lemmas. \begin{definition} \label{definition-module-finite-type} let $r$ be a ring. let $m$ be an $r$-module. \begin{enumerate} \item we say $m$ is a {\it finite $r$-module}, or a {\it finitely generated $r$-module} if there exist $n \in \mathbf{n}$ and $x_1, \ldots, x_n \in m$ such that every element of $m$ is an $r$-linear combination of the $x_i$. equivalently, this means there exists a surjection $r^{\oplus n} \to m$ for some $n \in \mathbf{n}$. \item we say $m$ is a {\it finitely presented $r$-module} or an {\it $r$-module of finite presentation} if there exist integers $n, m \in \mathbf{n}$ and an exact sequence $$ r^{\oplus m} \longrightarrow r^{\oplus n} \longrightarrow m \longrightarrow 0 $$ \end{enumerate} \end{definition} \noindent informally, $m$ is a finitely presented $r$-module if and only if it is finitely generated and the module of relations among these generators is finitely generated as well. a choice of an exact sequence as in the definition is called a {\it presentation} of $m$. \begin{lemma} \label{lemma-lift-map} let $r$ be a ring. let $\alpha : r^{\oplus n} \to m$ and $\beta : n \to m$ be module maps. if $\im(\alpha) \subset \im(\beta)$, then there exists an $r$-module map $\gamma : r^{\oplus n} \to n$ such that $\alpha = \beta \circ \gamma$. \end{lemma} \begin{proof} let $e_i = (0, \ldots, 0, 1, 0, \ldots, 0)$ be the $i$th basis vector of $r^{\oplus n}$. let $x_i \in n$ be an element with $\alpha(e_i) = \beta(x_i)$ which exists by assumption. set $\gamma(a_1, \ldots, a_n) = \sum a_i x_i$. by construction $\alpha = \beta \circ \gamma$. \end{proof} \begin{lemma} \label{lemma-extension} let $r$ be a ring. let $$ 0 \to m_1 \to m_2 \to m_3 \to 0 $$ be a short exact sequence of $r$-modules. \begin{enumerate} \item if $m_1$ and $m_3$ are finite $r$-modules, then $m_2$ is a finite $r$-module. \item if $m_1$ and $m_3$ are finitely presented $r$-modules, then $m_2$ is a finitely presented $r$-module. \item if $m_2$ is a finite $r$-module, then $m_3$ is a finite $r$-module. \item if $m_2$ is a finitely presented $r$-module and $m_1$ is a finite $r$-module, then $m_3$ is a finitely presented $r$-module. \item if $m_3$ is a finitely presented $r$-module and $m_2$ is a finite $r$-module, then $m_1$ is a finite $r$-module. \end{enumerate} \end{lemma} \begin{proof} proof of (1). if $x_1, \ldots, x_n$ are generators of $m_1$ and $y_1, \ldots, y_m \in m_2$ are elements whose images in $m_3$ are generators of $m_3$, then $x_1, \ldots, x_n, y_1, \ldots, y_m$ generate $m_2$. \medskip\noindent part (3) is immediate from the definition. \medskip\noindent proof of (5). assume $m_3$ is finitely presented and $m_2$ finite. choose a presentation $$ r^{\oplus m} \to r^{\oplus n} \to m_3 \to 0 $$ by lemma \ref{lemma-lift-map} there exists a map $r^{\oplus n} \to m_2$ such that the solid diagram $$ \xymatrix{ & r^{\oplus m} \ar[r] \ar@{..>}[d] & r^{\oplus n} \ar[r] \ar[d] & m_3 \ar[r] \ar[d]^{\text{id}} & 0 \\ 0 \ar[r] & m_1 \ar[r] & m_2 \ar[r] & m_3 \ar[r] & 0 } $$ commutes. this produces the dotted arrow. by the snake lemma (lemma \ref{lemma-snake}) we see that we get an isomorphism $$ \coker(r^{\oplus m} \to m_1) \cong \coker(r^{\oplus n} \to m_2) $$ in particular we conclude that $\coker(r^{\oplus m} \to m_1)$ is a finite $r$-module. since $\im(r^{\oplus m} \to m_1)$ is finite by (3), we see that $m_1$ is finite by part (1). \medskip\noindent proof of (4). assume $m_2$ is finitely presented and $m_1$ is finite. choose a presentation $r^{\oplus m} \to r^{\oplus n} \to m_2 \to 0$. choose a surjection $r^{\oplus k} \to m_1$. by lemma \ref{lemma-lift-map} there exists a factorization $r^{\oplus k} \to r^{\oplus n} \to m_2$ of the composition $r^{\oplus k} \to m_1 \to m_2$. then $r^{\oplus k + m} \to r^{\oplus n} \to m_3 \to 0$ is a presentation. \medskip\noindent proof of (2). assume that $m_1$ and $m_3$ are finitely presented. the argument in the proof of part (1) produces a commutative diagram $$ \xymatrix{ 0 \ar[r] & r^{\oplus n} \ar[d] \ar[r] & r^{\oplus n + m} \ar[d] \ar[r] & r^{\oplus m} \ar[d] \ar[r] & 0 \\ 0 \ar[r] & m_1 \ar[r] & m_2 \ar[r] & m_3 \ar[r] & 0 } $$ with surjective vertical arrows. by the snake lemma we obtain a short exact sequence $$ 0 \to \ker(r^{\oplus n} \to m_1) \to \ker(r^{\oplus n + m} \to m_2) \to \ker(r^{\oplus m} \to m_3) \to 0 $$ by part (5) we see that the outer two modules are finite. hence the middle one is finite too. by (4) we see that $m_2$ is of finite presentation. \end{proof} \begin{lemma} \label{lemma-trivial-filter-finite-module} \begin{slogan} finite modules have filtrations such that successive quotients are cyclic modules. \end{slogan} let $r$ be a ring, and let $m$ be a finite $r$-module. there exists a filtration by finite $r$-submodules $$ 0 = m_0 \subset m_1 \subset \ldots \subset m_n = m $$ such that each quotient $m_i/m_{i - 1}$ is isomorphic to $r/i_i$ for some ideal $i_i$ of $r$. \end{lemma} \begin{proof} by induction on the number of generators of $m$. let $x_1, \ldots, x_r \in m$ be generators. let $m' = rx_1 \subset m$. then $m/m'$ has $r - 1$ generators and the induction hypothesis applies. and clearly $m' \cong r/i_1$ with $i_1 = \{f \in r \mid fx_1 = 0\}$. \end{proof} \begin{lemma} \label{lemma-finite-over-subring} let $r \to s$ be a ring map. let $m$ be an $s$-module. if $m$ is finite as an $r$-module, then $m$ is finite as an $s$-module. \end{lemma} \begin{proof} in fact, any $r$-generating set of $m$ is also an $s$-generating set of $m$, since the $r$-module structure is induced by the image of $r$ in $s$. \end{proof} \section{ring maps of finite type and of finite presentation} \label{section-finite-type} \begin{definition} \label{definition-finite-type} let $r \to s$ be a ring map. \begin{enumerate} \item we say $r \to s$ is of {\it finite type}, or that {\it $s$ is a finite type $r$-algebra} if there exist an $n \in \mathbf{n}$ and an surjection of $r$-algebras $r[x_1, \ldots, x_n] \to s$. \item we say $r \to s$ is of {\it finite presentation} if there exist integers $n, m \in \mathbf{n}$ and polynomials $f_1, \ldots, f_m \in r[x_1, \ldots, x_n]$ and an isomorphism of $r$-algebras $r[x_1, \ldots, x_n]/(f_1, \ldots, f_m) \cong s$. \end{enumerate} \end{definition} \noindent informally, $r \to s$ is of finite presentation if and only if $s$ is finitely generated as an $r$-algebra and the ideal of relations among the generators is finitely generated. a choice of a surjection $r[x_1, \ldots, x_n] \to s$ as in the definition is sometimes called a {\it presentation} of $s$. \begin{lemma} \label{lemma-compose-finite-type} the notions finite type and finite presentation have the following permanence properties. \begin{enumerate} \item a composition of ring maps of finite type is of finite type. \item a composition of ring maps of finite presentation is of finite presentation. \item given $r \to s' \to s$ with $r \to s$ of finite type, then $s' \to s$ is of finite type. \item given $r \to s' \to s$, with $r \to s$ of finite presentation, and $r \to s'$ of finite type, then $s' \to s$ is of finite presentation. \end{enumerate} \end{lemma} \begin{proof} we only prove the last assertion. write $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ and $s' = r[y_1, \ldots, y_a]/i$. say that the class $\bar y_i$ of $y_i$ maps to $h_i \bmod (f_1, \ldots, f_m)$ in $s$. then it is clear that $s = s'[x_1, \ldots, x_n]/(f_1, \ldots, f_m, h_1 - \bar y_1, \ldots, h_a - \bar y_a)$. \end{proof} \begin{lemma} \label{lemma-finite-presentation-independent} let $r \to s$ be a ring map of finite presentation. for any surjection $\alpha : r[x_1, \ldots, x_n] \to s$ the kernel of $\alpha$ is a finitely generated ideal in $r[x_1, \ldots, x_n]$. \end{lemma} \begin{proof} write $s = r[y_1, \ldots, y_m]/(f_1, \ldots, f_k)$. choose $g_i \in r[y_1, \ldots, y_m]$ which are lifts of $\alpha(x_i)$. then we see that $s = r[x_i, y_j]/(f_l, x_i - g_i)$. choose $h_j \in r[x_1, \ldots, x_n]$ such that $\alpha(h_j)$ corresponds to $y_j \bmod (f_1, \ldots, f_k)$. consider the map $\psi : r[x_i, y_j] \to r[x_i]$, $x_i \mapsto x_i$, $y_j \mapsto h_j$. then the kernel of $\alpha$ is the image of $(f_l, x_i - g_i)$ under $\psi$ and we win. \end{proof} \begin{lemma} \label{lemma-finitely-presented-over-subring} let $r \to s$ be a ring map. let $m$ be an $s$-module. assume $r \to s$ is of finite type and $m$ is finitely presented as an $r$-module. then $m$ is finitely presented as an $s$-module. \end{lemma} \begin{proof} this is similar to the proof of part (4) of lemma \ref{lemma-compose-finite-type}. we may assume $s = r[x_1, \ldots, x_n]/j$. choose $y_1, \ldots, y_m \in m$ which generate $m$ as an $r$-module and choose relations $\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ which generate the kernel of $r^{\oplus m} \to m$. for any $i = 1, \ldots, n$ and $j = 1, \ldots, m$ write $$ x_i y_j = \sum a_{ijk} y_k $$ for some $a_{ijk} \in r$. consider the $s$-module $n$ generated by $y_1, \ldots, y_m$ subject to the relations $\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ and $x_i y_j = \sum a_{ijk} y_k$, $i = 1, \ldots, n$ and $j = 1, \ldots, m$. then $n$ has a presentation $$ s^{\oplus nm + t} \longrightarrow s^{\oplus m} \longrightarrow n \longrightarrow 0 $$ by construction there is a surjective map $\varphi : n \to m$. to finish the proof we show $\varphi$ is injective. suppose $z = \sum b_j y_j \in n$ for some $b_j \in s$. we may think of $b_j$ as a polynomial in $x_1, \ldots, x_n$ with coefficients in $r$. by applying the relations of the form $x_i y_j = \sum a_{ijk} y_k$ we can inductively lower the degree of the polynomials. hence we see that $z = \sum c_j y_j$ for some $c_j \in r$. hence if $\varphi(z) = 0$ then the vector $(c_1, \ldots, c_m)$ is an $r$-linear combination of the vectors $(a_{i1}, \ldots, a_{im})$ and we conclude that $z = 0$ as desired. \end{proof} \section{finite ring maps} \label{section-finite} \noindent here is the definition. \begin{definition} \label{definition-finite-ring-map} let $\varphi : r \to s$ be a ring map. we say $\varphi : r \to s$ is {\it finite} if $s$ is finite as an $r$-module. \end{definition} \begin{lemma} \label{lemma-finite-module-over-finite-extension} let $r \to s$ be a finite ring map. let $m$ be an $s$-module. then $m$ is finite as an $r$-module if and only if $m$ is finite as an $s$-module. \end{lemma} \begin{proof} one of the implications follows from lemma \ref{lemma-finite-over-subring}. to see the other assume that $m$ is finite as an $s$-module. pick $x_1, \ldots, x_n \in s$ which generate $s$ as an $r$-module. pick $y_1, \ldots, y_m \in m$ which generate $m$ as an $s$-module. then $x_i y_j$ generate $m$ as an $r$-module. \end{proof} \begin{lemma} \label{lemma-finite-transitive} suppose that $r \to s$ and $s \to t$ are finite ring maps. then $r \to t$ is finite. \end{lemma} \begin{proof} if $t_i$ generate $t$ as an $s$-module and $s_j$ generate $s$ as an $r$-module, then $t_i s_j$ generate $t$ as an $r$-module. (also follows from lemma \ref{lemma-finite-module-over-finite-extension}.) \end{proof} \begin{lemma} \label{lemma-finite-finite-type} let $\varphi : r \to s$ be a ring map. \begin{enumerate} \item if $\varphi$ is finite, then $\varphi$ is of finite type. \item if $s$ is of finite presentation as an $r$-module, then $\varphi$ is of finite presentation. \end{enumerate} \end{lemma} \begin{proof} for (1) if $x_1, \ldots, x_n \in s$ generate $s$ as an $r$-module, then $x_1, \ldots, x_n$ generate $s$ as an $r$-algebra. for (2), suppose that $\sum r_j^ix_i = 0$, $j = 1, \ldots, m$ is a set of generators of the relations among the $x_i$ when viewed as $r$-module generators of $s$. furthermore, write $1 = \sum r_ix_i$ for some $r_i \in r$ and $x_ix_j = \sum r_{ij}^k x_k$ for some $r_{ij}^k \in r$. then $$ s = r[t_1, \ldots, t_n]/ (\sum r_j^it_i,\ 1 - \sum r_it_i,\ t_it_j - \sum r_{ij}^k t_k) $$ as an $r$-algebra which proves (2). \end{proof} \noindent for more information on finite ring maps, please see section \ref{section-finite-ring-extensions}. \section{colimits} \label{section-colimits} \noindent some of the material in this section overlaps with the general discussion on colimits in categories, sections \ref{categories-section-limits} -- \ref{categories-section-posets-limits}. the notion of a preordered set is defined in categories, definition \ref{categories-definition-directed-set}. it is a slightly weaker notion than a partially ordered set. \begin{definition} \label{definition-directed-system} let $(i, \leq)$ be a preordered set. a {\it system $(m_i, \mu_{ij})$ of $r$-modules over $i$} consists of a family of $r$-modules $\{m_i\}_{i\in i}$ indexed by $i$ and a family of $r$-module maps $\{\mu_{ij} : m_i \to m_j\}_{i \leq j}$ such that for all $i \leq j \leq k$ $$ \mu_{ii} = \text{id}_{m_i}\quad \mu_{ik} = \mu_{jk}\circ \mu_{ij} $$ we say $(m_i, \mu_{ij})$ is a {\it directed system} if $i$ is a directed set. \end{definition} \noindent this is the same as the notion defined in categories, definition \ref{categories-definition-system-over-poset} and section \ref{categories-section-posets-limits}. we refer to categories, definition \ref{categories-definition-colimit} for the definition of a colimit of a diagram/system in any category. \begin{lemma} \label{lemma-colimit} let $(m_i, \mu_{ij})$ be a system of $r$-modules over the preordered set $i$. the colimit of the system $(m_i, \mu_{ij})$ is the quotient $r$-module $(\bigoplus_{i\in i} m_i) /q$ where $q$ is the $r$-submodule generated by all elements $$ \iota_i(x_i) - \iota_j(\mu_{ij}(x_i)) $$ where $\iota_i : m_i \to \bigoplus_{i\in i} m_i$ is the natural inclusion. we denote the colimit $m = \colim_i m_i$. we denote $\pi : \bigoplus_{i\in i} m_i \to m$ the projection map and $\phi_i = \pi \circ \iota_i : m_i \to m$. \end{lemma} \begin{proof} this lemma is a special case of categories, lemma \ref{categories-lemma-colimits-coproducts-coequalizers} but we will also prove it directly in this case. namely, note that $\phi_i = \phi_j\circ \mu_{ij}$ in the above construction. to show the pair $(m, \phi_i)$ is the colimit we have to show it satisfies the universal property: for any other such pair $(y, \psi_i)$ with $\psi_i : m_i \to y$, $\psi_i = \psi_j\circ \mu_{ij}$, there is a unique $r$-module homomorphism $g : m \to y$ such that the following diagram commutes: $$ \xymatrix{ m_i \ar[rr]^{\mu_{ij}} \ar[dr]^{\phi_i} \ar[ddr]_{\psi_i} & & m_j\ar[dl]_{\phi_j} \ar[ddl]^{\psi_j} \\ & m \ar[d]^{g}\\ & y } $$ and this is clear because we can define $g$ by taking the map $\psi_i$ on the summand $m_i$ in the direct sum $\bigoplus m_i$. \end{proof} \begin{lemma} \label{lemma-directed-colimit} let $(m_i, \mu_{ij})$ be a system of $r$-modules over the preordered set $i$. assume that $i$ is directed. the colimit of the system $(m_i, \mu_{ij})$ is canonically isomorphic to the module $m$ defined as follows: \begin{enumerate} \item as a set let $$ m = \left(\coprod\nolimits_{i \in i} m_i\right)/\sim $$ where for $m \in m_i$ and $m' \in m_{i'}$ we have $$ m \sim m' \leftrightarrow \mu_{ij}(m) = \mu_{i'j}(m')\text{ for some }j \geq i, i' $$ \item as an abelian group for $m \in m_i$ and $m' \in m_{i'}$ we define the sum of the classes of $m$ and $m'$ in $m$ to be the class of $\mu_{ij}(m) + \mu_{i'j}(m')$ where $j \in i$ is any index with $i \leq j$ and $i' \leq j$, and \item as an $r$-module define for $m \in m_i$ and $x \in r$ the product of $x$ and the class of $m$ in $m$ to be the class of $xm$ in $m$. \end{enumerate} the canonical maps $\phi_i : m_i \to m$ are induced by the canonical maps $m_i \to \coprod_{i \in i} m_i$. \end{lemma} \begin{proof} omitted. compare with categories, section \ref{categories-section-directed-colimits}. \end{proof} \begin{lemma} \label{lemma-zero-directed-limit} let $(m_i, \mu_{ij})$ be a directed system. let $m = \colim m_i$ with $\mu_i : m_i \to m$. then, $\mu_i(x_i) = 0$ for $x_i \in m_i$ if and only if there exists $j \geq i$ such that $\mu_{ij}(x_i) = 0$. \end{lemma} \begin{proof} this is clear from the description of the directed colimit in lemma \ref{lemma-directed-colimit}. \end{proof} \begin{example} \label{example-zero-colimit-different} consider the partially ordered set $i = \{a, b, c\}$ with $a < b$ and $a < c$ and no other strict inequalities. a system $(m_a, m_b, m_c, \mu_{ab}, \mu_{ac})$ over $i$ consists of three $r$-modules $m_a, m_b, m_c$ and two $r$-module homomorphisms $\mu_{ab} : m_a \to m_b$ and $\mu_{ac} : m_a \to m_c$. the colimit of the system is just $$ m := \colim_{i \in i} m_i = \coker(m_a \to m_b \oplus m_c) $$ where the map is $\mu_{ab} \oplus -\mu_{ac}$. thus the kernel of the canonical map $m_a \to m$ is $\ker(\mu_{ab}) + \ker(\mu_{ac})$. and the kernel of the canonical map $m_b \to m$ is the image of $\ker(\mu_{ac})$ under the map $\mu_{ab}$. hence clearly the result of lemma \ref{lemma-zero-directed-limit} is false for general systems. \end{example} \begin{definition} \label{definition-homomorphism-directed-systems} let $(m_i, \mu_{ij})$, $(n_i, \nu_{ij})$ be systems of $r$-modules over the same preordered set $i$. a {\it homomorphism of systems} $\phi$ from $(m_i, \mu_{ij})$ to $(n_i, \nu_{ij})$ is by definition a family of $r$-module homomorphisms $\phi_i : m_i \to n_i$ such that $\phi_j \circ \mu_{ij} = \nu_{ij} \circ \phi_i$ for all $i \leq j$. \end{definition} \noindent this is the same notion as a transformation of functors between the associated diagrams $m : i \to \text{mod}_r$ and $n : i \to \text{mod}_r$, in the language of categories. the following lemma is a special case of categories, lemma \ref{categories-lemma-functorial-colimit}. \begin{lemma} \label{lemma-homomorphism-limit} let $(m_i, \mu_{ij})$, $(n_i, \nu_{ij})$ be systems of $r$-modules over the same preordered set. a morphism of systems $\phi = (\phi_i)$ from $(m_i, \mu_{ij})$ to $(n_i, \nu_{ij})$ induces a unique homomorphism $$ \colim \phi_i : \colim m_i \longrightarrow \colim n_i $$ such that $$ \xymatrix{ m_i \ar[r] \ar[d]_{\phi_i} & \colim m_i \ar[d]^{\colim \phi_i} \\ n_i \ar[r] & \colim n_i } $$ commutes for all $i \in i$. \end{lemma} \begin{proof} write $m = \colim m_i$ and $n = \colim n_i$ and $\phi = \colim \phi_i$ (as yet to be constructed). we will use the explicit description of $m$ and $n$ in lemma \ref{lemma-colimit} without further mention. the condition of the lemma is equivalent to the condition that $$ \xymatrix{ \bigoplus_{i\in i} m_i \ar[r] \ar[d]_{\bigoplus\phi_i} & m \ar[d]^\phi \\ \bigoplus_{i\in i} n_i \ar[r] & n } $$ commutes. hence it is clear that if $\phi$ exists, then it is unique. to see that $\phi$ exists, it suffices to show that the kernel of the upper horizontal arrow is mapped by $\bigoplus \phi_i$ to the kernel of the lower horizontal arrow. to see this, let $j \leq k$ and $x_j \in m_j$. then $$ (\bigoplus \phi_i)(x_j - \mu_{jk}(x_j)) = \phi_j(x_j) - \phi_k(\mu_{jk}(x_j)) = \phi_j(x_j) - \nu_{jk}(\phi_j(x_j)) $$ which is in the kernel of the lower horizontal arrow as required. \end{proof} \begin{lemma} \label{lemma-directed-colimit-exact} \begin{slogan} filtered colimits are exact. directed colimits are exact. \end{slogan} let $i$ be a directed set. let $(l_i, \lambda_{ij})$, $(m_i, \mu_{ij})$, and $(n_i, \nu_{ij})$ be systems of $r$-modules over $i$. let $\varphi_i : l_i \to m_i$ and $\psi_i : m_i \to n_i$ be morphisms of systems over $i$. assume that for all $i \in i$ the sequence of $r$-modules $$ \xymatrix{ l_i \ar[r]^{\varphi_i} & m_i \ar[r]^{\psi_i} & n_i } $$ is a complex with homology $h_i$. then the $r$-modules $h_i$ form a system over $i$, the sequence of $r$-modules $$ \xymatrix{ \colim_i l_i \ar[r]^\varphi & \colim_i m_i \ar[r]^\psi & \colim_i n_i } $$ is a complex as well, and denoting $h$ its homology we have $$ h = \colim_i h_i. $$ \end{lemma} \begin{proof} it is clear that $ \xymatrix{ \colim_i l_i \ar[r]^\varphi & \colim_i m_i \ar[r]^\psi & \colim_i n_i } $ is a complex. for each $i \in i$, there is a canonical $r$-module morphism $h_i \to h$ (sending each $[m] \in h_i = \ker(\psi_i) / \im(\varphi_i)$ to the residue class in $h = \ker(\psi) / \im(\varphi)$ of the image of $m$ in $\colim_i m_i$). these give rise to a morphism $\colim_i h_i \to h$. it remains to show that this morphism is surjective and injective. \medskip\noindent we are going to repeatedly use the description of colimits over $i$ as in lemma \ref{lemma-directed-colimit} without further mention. let $h \in h$. since $h = \ker(\psi)/\im(\varphi)$ we see that $h$ is the class mod $\im(\varphi)$ of an element $[m]$ in $\ker(\psi) \subset \colim_i m_i$. choose an $i$ such that $[m]$ comes from an element $m \in m_i$. choose a $j \geq i$ such that $\nu_{ij}(\psi_i(m)) = 0$ which is possible since $[m] \in \ker(\psi)$. after replacing $i$ by $j$ and $m$ by $\mu_{ij}(m)$ we see that we may assume $m \in \ker(\psi_i)$. this shows that the map $\colim_i h_i \to h$ is surjective. \medskip\noindent suppose that $h_i \in h_i$ has image zero on $h$. since $h_i = \ker(\psi_i)/\im(\varphi_i)$ we may represent $h_i$ by an element $m \in \ker(\psi_i) \subset m_i$. the assumption on the vanishing of $h_i$ in $h$ means that the class of $m$ in $\colim_i m_i$ lies in the image of $\varphi$. hence there exists a $j \geq i$ and an $l \in l_j$ such that $\varphi_j(l) = \mu_{ij}(m)$. clearly this shows that the image of $h_i$ in $h_j$ is zero. this proves the injectivity of $\colim_i h_i \to h$. \end{proof} \begin{example} \label{example-colimit-not-exact} taking colimits is not exact in general. consider the partially ordered set $i = \{a, b, c\}$ with $a < b$ and $a < c$ and no other strict inequalities, as in example \ref{example-zero-colimit-different}. consider the map of systems $(0, \mathbf{z}, \mathbf{z}, 0, 0) \to (\mathbf{z}, \mathbf{z}, \mathbf{z}, 1, 1)$. from the description of the colimit in example \ref{example-zero-colimit-different} we see that the associated map of colimits is not injective, even though the map of systems is injective on each object. hence the result of lemma \ref{lemma-directed-colimit-exact} is false for general systems. \end{example} \begin{lemma} \label{lemma-almost-directed-colimit-exact} let $\mathcal{i}$ be an index category satisfying the assumptions of categories, lemma \ref{categories-lemma-split-into-directed}. then taking colimits of diagrams of abelian groups over $\mathcal{i}$ is exact (i.e., the analogue of lemma \ref{lemma-directed-colimit-exact} holds in this situation). \end{lemma} \begin{proof} by categories, lemma \ref{categories-lemma-split-into-directed} we may write $\mathcal{i} = \coprod_{j \in j} \mathcal{i}_j$ with each $\mathcal{i}_j$ a filtered category, and $j$ possibly empty. by categories, lemma \ref{categories-lemma-directed-category-system} taking colimits over the index categories $\mathcal{i}_j$ is the same as taking the colimit over some directed set. hence lemma \ref{lemma-directed-colimit-exact} applies to these colimits. this reduces the problem to showing that coproducts in the category of $r$-modules over the set $j$ are exact. in other words, exact sequences $l_j \to m_j \to n_j$ of $r$ modules we have to show that $$ \bigoplus\nolimits_{j \in j} l_j \longrightarrow \bigoplus\nolimits_{j \in j} m_j \longrightarrow \bigoplus\nolimits_{j \in j} n_j $$ is exact. this can be verified by hand, and holds even if $j$ is empty. \end{proof} \section{localization} \label{section-localization} \begin{definition} \label{definition-multiplicative-subset} let $r$ be a ring, $s$ a subset of $r$. we say $s$ is a {\it multiplicative subset of $r$} if $1\in s$ and $s$ is closed under multiplication, i.e., $s, s' \in s \rightarrow ss' \in s$. \end{definition} \noindent given a ring $a$ and a multiplicative subset $s$, we define a relation on $a \times s$ as follows: $$ (x, s) \sim (y, t) \leftrightarrow \exists u \in s \text{ such that } (xt-ys)u = 0 $$ it is easily checked that this is an equivalence relation. let $x/s$ (or $\frac{x}{s}$) be the equivalence class of $(x, s)$ and $s^{-1}a$ be the set of all equivalence classes. define addition and multiplication in $s^{-1}a$ as follows: $$ x/s + y/t = (xt + ys)/st, \quad x/s \cdot y/t = xy/st $$ one can check that $s^{-1}a$ becomes a ring under these operations. \begin{definition} \label{definition-localization} this ring is called the {\it localization of $a$ with respect to $s$}. \end{definition} \noindent we have a natural ring map from $a$ to its localization $s^{-1}a$, $$ a \longrightarrow s^{-1}a, \quad x \longmapsto x/1 $$ which is sometimes called the {\it localization map}. in general the localization map is not injective, unless $s$ contains no zerodivisors. for, if $x/1 = 0$, then there is a $u\in s$ such that $xu = 0$ in $a$ and hence $x = 0$ since there are no zerodivisors in $s$. the localization of a ring has the following universal property. \begin{proposition} \label{proposition-universal-property-localization} let $f : a \to b$ be a ring map that sends every element in $s$ to a unit of $b$. then there is a unique homomorphism $g : s^{-1}a \to b$ such that the following diagram commutes. $$ \xymatrix{ a \ar[rr]^{f} \ar[dr] & & b \\ & s^{-1}a \ar[ur]_g } $$ \end{proposition} \begin{proof} existence. we define a map $g$ as follows. for $x/s\in s^{-1}a$, let $g(x/s) = f(x)f(s)^{-1}\in b$. it is easily checked from the definition that this is a well-defined ring map. and it is also clear that this makes the diagram commutative. \medskip\noindent uniqueness. we now show that if $g' : s^{-1}a \to b$ satisfies $g'(x/1) = f(x)$, then $g = g'$. hence $f(s) = g'(s/1)$ for $s \in s$ by the commutativity of the diagram. but then $g'(1/s)f(s) = 1$ in $b$, which implies that $g'(1/s) = f(s)^{-1}$ and hence $g'(x/s) = g'(x/1)g'(1/s) = f(x)f(s)^{-1} = g(x/s)$. \end{proof} \begin{lemma} \label{lemma-localization-zero} the localization $s^{-1}a$ is the zero ring if and only if $0\in s$. \end{lemma} \begin{proof} if $0\in s$, any pair $(a, s)\sim (0, 1)$ by definition. if $0\not \in s$, then clearly $1/1 \neq 0/1$ in $s^{-1}a$. \end{proof} \begin{lemma} \label{lemma-localization-and-modules} let $r$ be a ring. let $s \subset r$ be a multiplicative subset. the category of $s^{-1}r$-modules is equivalent to the category of $r$-modules $n$ with the property that every $s \in s$ acts as an automorphism on $n$. \end{lemma} \begin{proof} the functor which defines the equivalence associates to an $s^{-1}r$-module $m$ the same module but now viewed as an $r$-module via the localization map $r \to s^{-1}r$. conversely, if $n$ is an $r$-module, such that every $s \in s$ acts via an automorphism $s_n$, then we can think of $n$ as an $s^{-1}r$-module by letting $x/s$ act via $x_n \circ s_n^{-1}$. we omit the verification that these two functors are quasi-inverse to each other. \end{proof} \noindent the notion of localization of a ring can be generalized to the localization of a module. let $a$ be a ring, $s$ a multiplicative subset of $a$ and $m$ an $a$-module. we define a relation on $m \times s$ as follows $$ (m, s) \sim (n, t) \leftrightarrow \exists u\in s \text{ such that } (mt-ns)u = 0 $$ this is clearly an equivalence relation. denote by $m/s$ (or $\frac{m}{s}$) be the equivalence class of $(m, s)$ and $s^{-1}m$ be the set of all equivalence classes. define the addition and scalar multiplication as follows $$ m/s + n/t = (mt + ns)/st,\quad m/s\cdot n/t = mn/st $$ it is clear that this makes $s^{-1}m$ an $s^{-1}a$-module. \begin{definition} \label{definition-localization-module} the $s^{-1}a$-module $s^{-1}m$ is called the {\it localization} of $m$ at $s$. \end{definition} \noindent note that there is an $a$-module map $m \to s^{-1}m$, $m \mapsto m/1$ which is sometimes called the {\it localization map}. it satisfies the following universal property. \begin{lemma} \label{lemma-universal-property-localization-module} let $r$ be a ring. let $s \subset r$ a multiplicative subset. let $m$, $n$ be $r$-modules. assume all the elements of $s$ act as automorphisms on $n$. then the canonical map $$ \hom_r(s^{-1}m, n) \longrightarrow \hom_r(m, n) $$ induced by the localization map, is an isomorphism. \end{lemma} \begin{proof} it is clear that the map is well-defined and $r$-linear. injectivity: let $\alpha \in \hom_r(s^{-1}m, n)$ and take an arbitrary element $m/s \in s^{-1}m$. then, since $s \cdot \alpha(m/s) = \alpha(m/1)$, we have $ \alpha(m/s) =s^{-1}(\alpha (m/1))$, so $\alpha$ is completely determined by what it does on the image of $m$ in $s^{-1}m$. surjectivity: let $\beta : m \rightarrow n$ be a given r-linear map. we need to show that it can be "extended" to $s^{-1}m$. define a map of sets $$ m \times s \rightarrow n,\quad (m,s) \mapsto s^{-1}\beta(m) $$ clearly, this map respects the equivalence relation from above, so it descends to a well-defined map $\alpha : s^{-1}m \rightarrow n$. it remains to show that this map is $r$-linear, so take $r, r' \in r$ as well as $s, s' \in s$ and $m, m' \in m$. then \begin{align*} \alpha(r \cdot m/s + r' \cdot m' /s') & = \alpha((r \cdot s' \cdot m + r' \cdot s \cdot m') /(ss')) \\ & = (ss')^{-1}\beta(r \cdot s' \cdot m + r' \cdot s \cdot m') \\ & = (ss')^{-1} (r \cdot s' \beta (m) + r' \cdot s \beta (m')) \\ & = r \alpha (m/s) + r' \alpha (m' /s') \end{align*} and we win. \end{proof} \begin{example} \label{example-localize-at-prime} let $a$ be a ring and let $m$ be an $a$-module. here are some important examples of localizations. \begin{enumerate} \item given $\mathfrak p$ a prime ideal of $a$ consider $s = a\setminus\mathfrak p$. it is immediately checked that $s$ is a multiplicative set. in this case we denote $a_\mathfrak p$ and $m_\mathfrak p$ the localization of $a$ and $m$ with respect to $s$ respectively. these are called the {\it localization of $a$, resp.\ $m$ at $\mathfrak p$}. \item let $f\in a$. consider $s = \{1, f, f^2, \ldots\}$. this is clearly a multiplicative subset of $a$. in this case we denote $a_f$ (resp. $m_f$) the localization $s^{-1}a$ (resp. $s^{-1}m$). this is called the {\it localization of $a$, resp.\ $m$ with respect to $f$}. note that $a_f = 0$ if and only if $f$ is nilpotent in $a$. \item let $s = \{f \in a \mid f \text{ is not a zerodivisor in }a\}$. this is a multiplicative subset of $a$. in this case the ring $q(a) = s^{-1}a$ is called either the {\it total quotient ring}, or the {\it total ring of fractions} of $a$. \item if $a$ is a domain, then the total quotient ring $q(a)$ is the field of fractions of $a$. please see fields, example \ref{fields-example-quotient-field}. \end{enumerate} \end{example} \begin{lemma} \label{lemma-localization-colimit} let $r$ be a ring. let $s \subset r$ be a multiplicative subset. let $m$ be an $r$-module. then $$ s^{-1}m = \colim_{f \in s} m_f $$ where the preorder on $s$ is given by $f \geq f' \leftrightarrow f = f'f''$ for some $f'' \in r$ in which case the map $m_{f'} \to m_f$ is given by $m/(f')^e \mapsto m(f'')^e/f^e$. \end{lemma} \begin{proof} omitted. hint: use the universal property of lemma \ref{lemma-universal-property-localization-module}. \end{proof} \noindent in the following paragraph, let $a$ denote a ring, and $m, n$ denote modules over $a$. \medskip\noindent if $s$ and $s'$ are multiplicative sets of $a$, then it is clear that $$ ss' = \{ss' : s\in s, \ s'\in s'\} $$ is also a multiplicative set of $a$. then the following holds. \begin{proposition} \label{proposition-localize-twice} let $\overline{s}$ be the image of $s$ in $s'^{-1}a$, then $(ss')^{-1}a$ is isomorphic to $\overline{s}^{-1}(s'^{-1}a)$. \end{proposition} \begin{proof} the map sending $x\in a$ to $x/1\in (ss')^{-1}a$ induces a map sending $x/s\in s'^{-1}a$ to $x/s \in (ss')^{-1}a$, by universal property. the image of the elements in $\overline{s}$ are invertible in $(ss')^{-1}a$. by the universal property we get a map $f : \overline{s}^{-1}(s'^{-1}a) \to (ss')^{-1}a$ which maps $(x/s')/(s/1)$ to $x/ss'$. \medskip\noindent on the other hand, the map from $a$ to $\overline{s}^{-1}(s'^{-1}a)$ sending $x\in a$ to $(x/1)/(1/1)$ also induces a map $g : (ss')^{-1}a \to \overline{s}^{-1}(s'^{-1}a)$ which sends $x/ss'$ to $(x/s')/(s/1)$, by the universal property again. it is immediately checked that $f$ and $g$ are inverse to each other, hence they are both isomorphisms. \end{proof} \noindent for the module $m$ we have \begin{proposition} \label{proposition-localize-twice-module} view $s'^{-1}m$ as an $a$-module, then $s^{-1}(s'^{-1}m)$ is isomorphic to $(ss')^{-1}m$. \end{proposition} \begin{proof} note that given a $a$-module m, we have not proved any universal property for $s^{-1}m$. hence we cannot reason as in the preceding proof; we have to construct the isomorphism explicitly. \medskip\noindent we define the maps as follows \begin{align*} & f : s^{-1}(s'^{-1}m) \longrightarrow (ss')^{-1}m, \quad \frac{x/s'}{s}\mapsto x/ss'\\ & g : (ss')^{-1}m \longrightarrow s^{-1}(s'^{-1}m), \quad x/t\mapsto \frac{x/s'}{s}\ \text{for some }s\in s, s'\in s', \text{ and } t = ss' \end{align*} we have to check that these homomorphisms are well-defined, that is, independent the choice of the fraction. this is easily checked and it is also straightforward to show that they are inverse to each other. \end{proof} \noindent if $u : m \to n$ is an $a$ homomorphism, then the localization indeed induces a well-defined $s^{-1}a$ homomorphism $s^{-1}u : s^{-1}m \to s^{-1}n$ which sends $x/s$ to $u(x)/s$. it is immediately checked that this construction is functorial, so that $s^{-1}$ is actually a functor from the category of $a$-modules to the category of $s^{-1}a$-modules. moreover this functor is exact, as we show in the following proposition. \begin{proposition} \label{proposition-localization-exact} \begin{slogan} localization is exact. \end{slogan} let $l\xrightarrow{u} m\xrightarrow{v} n$ be an exact sequence of $r$-modules. then $s^{-1}l \to s^{-1}m \to s^{-1}n$ is also exact. \end{proposition} \begin{proof} first it is clear that $s^{-1}l \to s^{-1}m \to s^{-1}n$ is a complex since localization is a functor. next suppose that $x/s$ maps to zero in $s^{-1}n$ for some $x/s \in s^{-1}m$. then by definition there is a $t\in s$ such that $v(xt) = v(x)t = 0$ in $n$, which means $xt \in \ker(v)$. by the exactness of $l \to m \to n$ we have $xt = u(y)$ for some $y$ in $l$. then $x/s$ is the image of $y/st$. this proves the exactness. \end{proof} \begin{lemma} \label{lemma-localize-quotient-modules} localization respects quotients, i.e. if $n$ is a submodule of $m$, then $s^{-1}(m/n)\simeq (s^{-1}m)/(s^{-1}n)$. \end{lemma} \begin{proof} from the exact sequence $$ 0 \longrightarrow n \longrightarrow m \longrightarrow m/n \longrightarrow 0 $$ we have $$ 0 \longrightarrow s^{-1}n \longrightarrow s^{-1}m \longrightarrow s^{-1}(m/n) \longrightarrow 0 $$ the corollary then follows. \end{proof} \noindent if, in the preceding corollary, we take $n = i$ and $m = a$ for an ideal $i$ of $a$, we see that $s^{-1}a/s^{-1}i \simeq s^{-1}(a/i)$ as $a$-modules. the next proposition shows that they are isomorphic as rings. \begin{proposition} \label{proposition-localize-quotient} let $i$ be an ideal of $a$, $s$ a multiplicative set of $a$. then $s^{-1}i$ is an ideal of $s^{-1}a$ and $\overline{s}^{-1}(a/i)$ is isomorphic to $s^{-1}a/s^{-1}i$, where $\overline{s}$ is the image of $s$ in $a/i$. \end{proposition} \begin{proof} the fact that $s^{-1}i$ is an ideal is clear since $i$ itself is an ideal. define $$ f : s^{-1}a\longrightarrow \overline{s}^{-1}(a/i), \quad x/s\mapsto \overline{x}/\overline{s} $$ where $\overline{x}$ and $\overline{s}$ are the images of $x$ and $s$ in $a/i$. we shall keep similar notations in this proof. this map is well-defined by the universal property of $s^{-1}a$, and $s^{-1}i$ is contained in the kernel of it, therefore it induces a map $$ \overline{f} : s^{-1}a/s^{-1}i \longrightarrow \overline{s}^{-1}(a/i), \quad \overline{x/s}\mapsto \overline{x}/\overline{s} $$ \medskip\noindent on the other hand, the map $a \to s^{-1}a/s^{-1}i$ sending $x$ to $\overline{x/1}$ induces a map $a/i \to s^{-1}a/s^{-1}i$ sending $\overline{x}$ to $\overline{x/1}$. the image of $\overline{s}$ is invertible in $s^{-1}a/s^{-1}i$, thus induces a map $$ g : \overline{s}^{-1}(a/i) \longrightarrow s^{-1}a/s^{-1}i, \quad \frac{\overline{x}}{\overline{s}}\mapsto \overline{x/s} $$ by the universal property. it is then clear that $\overline{f}$ and $g$ are inverse to each other, hence are both isomorphisms. \end{proof} \noindent we now consider how submodules behave in localization. \begin{lemma} \label{lemma-submodule-localization} any submodule $n'$ of $s^{-1}m$ is of the form $s^{-1}n$ for some $n\subset m$. indeed one can take $n$ to be the inverse image of $n'$ in $m$. \end{lemma} \begin{proof} let $n$ be the inverse image of $n'$ in $m$. then one can see that $s^{-1}n\supset n'$. to show they are equal, take $x/s$ in $s^{-1}n$, where $s\in s$ and $x\in n$. this yields that $x/1\in n'$. since $n'$ is an $s^{-1}r$-submodule we have $x/s = x/1\cdot 1/s\in n'$. this finishes the proof. \end{proof} \noindent taking $m = a$ and $n = i$ an ideal of $a$, we have the following corollary, which can be viewed as a converse of the first part of proposition \ref{proposition-localize-quotient}. \begin{lemma} \label{lemma-ideal-in-localization} \begin{slogan} ideals in the localization of a ring are localizations of ideals. \end{slogan} each ideal $i'$ of $s^{-1}a$ takes the form $s^{-1}i$, where one can take $i$ to be the inverse image of $i'$ in $a$. \end{lemma} \begin{proof} immediate from lemma \ref{lemma-submodule-localization}. \end{proof} \section{internal hom} \label{section-hom} \noindent if $r$ is a ring, and $m$, $n$ are $r$-modules, then $$ \hom_r(m, n) = \{ \varphi : m \to n\} $$ is the set of $r$-linear maps from $m$ to $n$. this set comes with the structure of an abelian group by setting $(\varphi + \psi)(m) = \varphi(m) + \psi(m)$, as usual. in fact, $\hom_r(m, n)$ is also an $r$-module via the rule $(x \varphi)(m) = x \varphi(m) = \varphi(xm)$. \medskip\noindent given maps $a : m \to m'$ and $b : n \to n'$ of $r$-modules, we can pre-compose and post-compose homomorphisms by $a$ and $b$. this leads to the following commutative diagram $$ \xymatrix{ \hom_r(m', n) \ar[d]_{- \circ a} \ar[r]_{b \circ -} & \hom_r(m', n') \ar[d]^{- \circ a} \\ \hom_r(m, n) \ar[r]^{b \circ -} & \hom_r(m, n') } $$ in fact, the maps in this diagram are $r$-module maps. thus $\hom_r$ defines an additive functor $$ \text{mod}_r^{opp} \times \text{mod}_r \longrightarrow \text{mod}_r, \quad (m, n) \longmapsto \hom_r(m, n) $$ \begin{lemma} \label{lemma-hom-exact} exactness and $\hom_r$. let $r$ be a ring. let $m_1$, $m_2$, $m_3$ be $r$-modules. let $m_1 \to m_2$ and $m_2 \to m_3$ be $r$-module maps. \begin{enumerate} \item $m_1 \to m_2 \to m_3 \to 0$ is exact if and only if $0 \to \hom_r(m_3, n) \to \hom_r(m_2, n) \to \hom_r(m_1, n)$ is exact for all $r$-modules $n$. \item $0 \to m_1 \to m_2 \to m_3$ is exact if and only if $0 \to \hom_r(n, m_1) \to \hom_r(n, m_2) \to \hom_r(n, m_3)$ is exact for all $r$-modules $n$. \end{enumerate} \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-hom-from-finitely-presented} let $r$ be a ring. let $m$ be a finitely presented $r$-module. let $n$ be an $r$-module. \begin{enumerate} \item for $f \in r$ we have $\hom_r(m, n)_f = \hom_{r_f}(m_f, n_f) = \hom_r(m_f, n_f)$, \item for a multiplicative subset $s$ of $r$ we have $$ s^{-1}\hom_r(m, n) = \hom_{s^{-1}r}(s^{-1}m, s^{-1}n) = \hom_r(s^{-1}m, s^{-1}n). $$ \end{enumerate} \end{lemma} \begin{proof} part (1) is a special case of part (2). the second equality in (2) follows from lemma \ref{lemma-localization-and-modules}. choose a presentation $$ \bigoplus\nolimits_{j = 1, \ldots, m} r \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} r \to m \to 0. $$ by lemma \ref{lemma-hom-exact} this gives an exact sequence $$ 0 \to \hom_r(m, n) \to \bigoplus\nolimits_{i = 1, \ldots, n} n \longrightarrow \bigoplus\nolimits_{j = 1, \ldots, m} n. $$ inverting $s$ and using proposition \ref{proposition-localization-exact} we get an exact sequence $$ 0 \to s^{-1}\hom_r(m, n) \to \bigoplus\nolimits_{i = 1, \ldots, n} s^{-1}n \longrightarrow \bigoplus\nolimits_{j = 1, \ldots, m} s^{-1}n $$ and the result follows since $s^{-1}m$ sits in an exact sequence $$ \bigoplus\nolimits_{j = 1, \ldots, m} s^{-1}r \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} s^{-1}r \to s^{-1}m \to 0 $$ which induces (by lemma \ref{lemma-hom-exact}) the exact sequence $$ 0 \to \hom_{s^{-1}r}(s^{-1}m, s^{-1}n) \to \bigoplus\nolimits_{i = 1, \ldots, n} s^{-1}n \longrightarrow \bigoplus\nolimits_{j = 1, \ldots, m} s^{-1}n $$ which is the same as the one above. \end{proof} \section{characterizing finite and finitely presented modules} \label{section-colim-and-hom} \noindent given a module $n$ over a ring $r$, you can characterize whether or not $n$ is a finite module or a finitely presented module in terms of the functor $\hom_r(n, -)$. \begin{lemma} \label{lemma-characterize-finite-module-hom} let $r$ be a ring. let $n$ be an $r$-module. the following are equivalent \begin{enumerate} \item $n$ is a finite $r$-module, \item for any filtered colimit $m = \colim m_i$ of $r$-modules the map $\colim \hom_r(n, m_i) \to \hom_r(n, m)$ is injective. \end{enumerate} \end{lemma} \begin{proof} assume (1) and choose generators $x_1, \ldots, x_m$ for $n$. if $n \to m_i$ is a module map and the composition $n \to m_i \to m$ is zero, then because $m = \colim_{i' \geq i} m_{i'}$ for each $j \in \{1, \ldots, m\}$ we can find a $i' \geq i$ such that $x_j$ maps to zero in $m_{i'}$. since there are finitely many $x_j$ we can find a single $i'$ which works for all of them. then the composition $n \to m_i \to m_{i'}$ is zero and we conclude the map is injective, i.e., part (2) holds. \medskip\noindent assume (2). for a finite subset $e \subset n$ denote $n_e \subset n$ the $r$-submodule generated by the elements of $e$. then $0 = \colim n/n_e$ is a filtered colimit. hence we see that $\text{id} : n \to n$ maps into $n_e$ for some $e$, i.e., $n$ is finitely generated. \end{proof} \noindent for purposes of reference, we define what it means to have a relation between elements of a module. \begin{definition} \label{definition-relation} let $r$ be a ring. let $m$ be an $r$-module. let $n \geq 0$ and $x_i \in m$ for $i = 1, \ldots, n$. a {\it relation} between $x_1, \ldots, x_n$ in $m$ is a sequence of elements $f_1, \ldots, f_n \in r$ such that $\sum_{i = 1, \ldots, n} f_i x_i = 0$. \end{definition} \begin{lemma} \label{lemma-module-colimit-fp} let $r$ be a ring and let $m$ be an $r$-module. then $m$ is the colimit of a directed system $(m_i, \mu_{ij})$ of $r$-modules with all $m_i$ finitely presented $r$-modules. \end{lemma} \begin{proof} consider any finite subset $s \subset m$ and any finite collection of relations $e$ among the elements of $s$. so each $s \in s$ corresponds to $x_s \in m$ and each $e \in e$ consists of a vector of elements $f_{e, s} \in r$ such that $\sum f_{e, s} x_s = 0$. let $m_{s, e}$ be the cokernel of the map $$ r^{\# e} \longrightarrow r^{\# s}, \quad (g_e)_{e\in e} \longmapsto (\sum g_e f_{e, s})_{s\in s}. $$ there are canonical maps $m_{s, e} \to m$. if $s \subset s'$ and if the elements of $e$ correspond, via this map, to relations in $e'$, then there is an obvious map $m_{s, e} \to m_{s', e'}$ commuting with the maps to $m$. let $i$ be the set of pairs $(s, e)$ with ordering by inclusion as above. it is clear that the colimit of this directed system is $m$. \end{proof} \begin{lemma} \label{lemma-characterize-finitely-presented-module-hom} let $r$ be a ring. let $n$ be an $r$-module. the following are equivalent \begin{enumerate} \item $n$ is a finitely presented $r$-module, \item for any filtered colimit $m = \colim m_i$ of $r$-modules the map $\colim \hom_r(n, m_i) \to \hom_r(n, m)$ is bijective. \end{enumerate} \end{lemma} \begin{proof} assume (1) and choose an exact sequence $f_{-1} \to f_0 \to n \to 0$ with $f_i$ finite free. then we have an exact sequence $$ 0 \to \hom_r(n, m) \to \hom_r(f_0, m) \to \hom_r(f_{-1}, m) $$ functorial in the $r$-module $m$. the functors $\hom_r(f_i, m)$ commute with filtered colimits as $\hom_r(r^{\oplus n}, m) = m^{\oplus n}$. since filtered colimits are exact (lemma \ref{lemma-directed-colimit-exact}) we see that (2) holds. \medskip\noindent assume (2). by lemma \ref{lemma-module-colimit-fp} we can write $n = \colim n_i$ as a filtered colimit such that $n_i$ is of finite presentation for all $i$. thus $\text{id}_n$ factors through $n_i$ for some $i$. this means that $n$ is a direct summand of a finitely presented $r$-module (namely $n_i$) and hence finitely presented. \end{proof} \section{tensor products} \label{section-tensor-product} \begin{definition} \label{definition-bilinear} let $r$ be a ring, $m, n, p$ be three $r$-modules. a mapping $f : m \times n \to p$ (where $m \times n$ is viewed only as cartesian product of two $r$-modules) is said to be {\it $r$-bilinear} if for each $x \in m$ the mapping $y\mapsto f(x, y)$ of $n$ into $p$ is $r$-linear, and for each $y\in n$ the mapping $x\mapsto f(x, y)$ is also $r$-linear. \end{definition} \begin{lemma} \label{lemma-tensor-product} let $m, n$ be $r$-modules. then there exists a pair $(t, g)$ where $t$ is an $r$-module, and $g : m \times n \to t$ an $r$-bilinear mapping, with the following universal property: for any $r$-module $p$ and any $r$-bilinear mapping $f : m \times n \to p$, there exists a unique $r$-linear mapping $\tilde{f} : t \to p$ such that $f = \tilde{f} \circ g$. in other words, the following diagram commutes: $$ \xymatrix{ m \times n \ar[rr]^f \ar[dr]_g & & p\\ & t \ar[ur]_{\tilde f} } $$ moreover, if $(t, g)$ and $(t', g')$ are two pairs with this property, then there exists a unique isomorphism $j : t \to t'$ such that $j\circ g = g'$. \end{lemma} \noindent the $r$-module $t$ which satisfies the above universal property is called the {\it tensor product} of $r$-modules $m$ and $n$, denoted as $m \otimes_r n$. \begin{proof} we first prove the existence of such $r$-module $t$. let $m, n$ be $r$-modules. let $t$ be the quotient module $p/q$, where $p$ is the free $r$-module $r^{(m \times n)}$ and $q$ is the $r$-module generated by all elements of the following types: ($x\in m, y\in n$) \begin{align*} (x + x', y) - (x, y) - (x', y), \\ (x, y + y') - (x, y) - (x, y'), \\ (ax, y) - a(x, y), \\ (x, ay) - a(x, y) \end{align*} let $\pi : m \times n \to t$ denote the natural map. this map is $r$-bilinear, as implied by the above relations when we check the bilinearity conditions. denote the image $\pi(x, y) = x \otimes y$, then these elements generate $t$. now let $f : m \times n \to p$ be an $r$-bilinear map, then we can define $f' : t \to p$ by extending the mapping $f'(x \otimes y) = f(x, y)$. clearly $f = f'\circ \pi$. moreover, $f'$ is uniquely determined by the value on the generating sets $\{x \otimes y : x\in m, y\in n\}$. suppose there is another pair $(t', g')$ satisfying the same properties. then there is a unique $j : t \to t'$ and also $j' : t' \to t$ such that $g' = j\circ g$, $g = j'\circ g'$. but then both the maps $(j\circ j') \circ g$ and $g$ satisfies the universal properties, so by uniqueness they are equal, and hence $j'\circ j$ is identity on $t$. similarly $(j'\circ j) \circ g' = g'$ and $j\circ j'$ is identity on $t'$. so $j$ is an isomorphism. \end{proof} \begin{lemma} \label{lemma-flip-tensor-product} let $m, n, p$ be $r$-modules, then the bilinear maps \begin{align*} (x, y) & \mapsto y \otimes x\\ (x + y, z) & \mapsto x \otimes z + y \otimes z\\ (r, x) & \mapsto rx \end{align*} induce unique isomorphisms \begin{align*} m \otimes_r n & \to n \otimes_r m, \\ (m\oplus n)\otimes_r p & \to (m \otimes_r p)\oplus(n \otimes_r p), \\ r \otimes_r m & \to m \end{align*} \end{lemma} \begin{proof} omitted. \end{proof} \noindent we may generalize the tensor product of two $r$-modules to finitely many $r$-modules, and set up a correspondence between the multi-tensor product with multilinear mappings. using almost the same construction one can prove that: \begin{lemma} \label{lemma-multilinear} let $m_1, \ldots, m_r$ be $r$-modules. then there exists a pair $(t, g)$ consisting of an $r$-module t and an $r$-multilinear mapping $g : m_1\times \ldots \times m_r \to t$ with the universal property: for any $r$-multilinear mapping $f : m_1\times \ldots \times m_r \to p$ there exists a unique $r$-module homomorphism $f' : t \to p$ such that $f'\circ g = f$. such a module $t$ is unique up to unique isomorphism. we denote it $m_1\otimes_r \ldots \otimes_r m_r$ and we denote the universal multilinear map $(m_1, \ldots, m_r) \mapsto m_1 \otimes \ldots \otimes m_r$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-transitive} the homomorphisms $$ (m \otimes_r n)\otimes_r p \to m \otimes_r n \otimes_r p \to m \otimes_r (n \otimes_r p) $$ such that $f((x \otimes y)\otimes z) = x \otimes y \otimes z$ and $g(x \otimes y \otimes z) = x \otimes (y \otimes z)$, $x\in m, y\in n, z\in p$ are well-defined and are isomorphisms. \end{lemma} \begin{proof} we shall prove $f$ is well-defined and is an isomorphism, and this proof carries analogously to $g$. fix any $z\in p$, then the mapping $(x, y)\mapsto x \otimes y \otimes z$, $x\in m, y\in n$, is $r$-bilinear in $x$ and $y$, and hence induces homomorphism $f_z : m \otimes n \to m \otimes n \otimes p$ which sends $f_z(x \otimes y) = x \otimes y \otimes z$. then consider $(m \otimes n)\times p \to m \otimes n \otimes p$ given by $(w, z)\mapsto f_z(w)$. the map is $r$-bilinear and thus induces $f : (m \otimes_r n)\otimes_r p \to m \otimes_r n \otimes_r p$ and $f((x \otimes y)\otimes z) = x \otimes y \otimes z$. to construct the inverse, we note that the map $\pi : m \times n \times p \to (m \otimes n)\otimes p$ is $r$-trilinear. therefore, it induces an $r$-linear map $h : m \otimes n \otimes p \to (m \otimes n)\otimes p$ which agrees with the universal property. here we see that $h(x \otimes y \otimes z) = (x \otimes y)\otimes z$. from the explicit expression of $f$ and $h$, $f\circ h$ and $h\circ f$ are identity maps of $m \otimes n \otimes p$ and $(m \otimes n)\otimes p$ respectively, hence $f$ is our desired isomorphism. \end{proof} \noindent doing induction we see that this extends to multi-tensor products. combined with lemma \ref{lemma-flip-tensor-product} we see that the tensor product operation on the category of $r$-modules is associative, commutative and distributive. \begin{definition} \label{definition-bimodule} an abelian group $n$ is called an {\it $(a, b)$-bimodule} if it is both an $a$-module and a $b$-module and for all $a \in a$ and $b \in b$ the multiplication by $a$ and $b$ commute, so $b(an) = a(bn)$ for all $n \in n$. in this situation we usually write the $b$-action on the right: so for $b \in b$ and $n \in n$ the result of multiplying $n$ by $b$ is denoted $nb$. with this convention the compatibility above is that $(ax)b = a(xb)$ for all $a\in a, b\in b, x\in n$. the shorthand $_an_b$ is used to denote an $(a, b)$-bimodule $n$. \end{definition} \begin{lemma} \label{lemma-tensor-with-bimodule} for $a$-module $m$, $b$-module $p$ and $(a, b)$-bimodule $n$, the modules $(m \otimes_a n)\otimes_b p$ and $m \otimes_a(n \otimes_b p)$ can both be given $(a, b)$-bimodule structure, and moreover $$ (m \otimes_a n)\otimes_b p \cong m \otimes_a(n \otimes_b p). $$ \end{lemma} \begin{proof} a priori $m \otimes_a n$ is an $a$-module, but we can give it a $b$-module structure by letting $$ (x \otimes y)b = x \otimes yb, \quad x\in m, y\in n, b\in b $$ thus $m \otimes_a n$ becomes an $(a, b)$-bimodule. similarly for $n \otimes_b p$, and thus for $(m \otimes_a n)\otimes_b p$ and $m \otimes_a(n \otimes_b p)$. by lemma \ref{lemma-transitive}, these two modules are isomorphic as both as $a$-module and $b$-module via the same mapping. \end{proof} \begin{lemma} \label{lemma-hom-from-tensor-product} for any three $r$-modules $m, n, p$, $$ \hom_r(m \otimes_r n, p) \cong \hom_r(m, \hom_r(n, p)) $$ \end{lemma} \begin{proof} an $r$-linear map $\hat{f}\in \hom_r(m \otimes_r n, p)$ corresponds to an $r$-bilinear map $f : m \times n \to p$. for each $x\in m$ the mapping $y\mapsto f(x, y)$ is $r$-linear by the universal property. thus $f$ corresponds to a map $\phi_f : m \to \hom_r(n, p)$. this map is $r$-linear since $$ \phi_f(ax + y)(z) = f(ax + y, z) = af(x, z)+f(y, z) = (a\phi_f(x)+\phi_f(y))(z), $$ for all $a \in r$, $x \in m$, $y \in m$ and $z \in n$. conversely, any $f \in \hom_r(m, \hom_r(n, p))$ defines an $r$-bilinear map $m \times n \to p$, namely $(x, y)\mapsto f(x)(y)$. so this is a natural one-to-one correspondence between the two modules $\hom_r(m \otimes_r n, p)$ and $\hom_r(m, \hom_r(n, p))$. \end{proof} \begin{lemma}[tensor products commute with colimits] \label{lemma-tensor-products-commute-with-limits} let $(m_i, \mu_{ij})$ be a system over the preordered set $i$. let $n$ be an $r$-module. then $$ \colim (m_i \otimes n) \cong (\colim m_i)\otimes n. $$ moreover, the isomorphism is induced by the homomorphisms $\mu_i \otimes 1: m_i \otimes n \to m \otimes n$ where $m = \colim_i m_i$ with natural maps $\mu_i : m_i \to m$. \end{lemma} \begin{proof} first proof. the functor $m' \mapsto m' \otimes_r n$ is left adjoint to the functor $n' \mapsto \hom_r(n, n')$ by lemma \ref{lemma-hom-from-tensor-product}. thus $m' \mapsto m' \otimes_r n$ commutes with all colimits, see categories, lemma \ref{categories-lemma-adjoint-exact}. \medskip\noindent second direct proof. let $p = \colim (m_i \otimes n)$ with coprojections $\lambda_i : m_i \otimes n \to p$. let $m = \colim m_i$ with coprojections $\mu_i : m_i \to m$. then for all $i\leq j$, the following diagram commutes: $$ \xymatrix{ m_i \otimes n \ar[r]_{\mu_i \otimes 1} \ar[d]_{\mu_{ij} \otimes 1} & m \otimes n \ar[d]^{\text{id}} \\ m_j \otimes n \ar[r]^{\mu_j \otimes 1} & m \otimes n } $$ by lemma \ref{lemma-homomorphism-limit} these maps induce a unique homomorphism $\psi : p \to m \otimes n$ such that $\mu_i \otimes 1 = \psi \circ \lambda_i$. \medskip\noindent to construct the inverse map, for each $i\in i$, there is the canonical $r$-bilinear mapping $g_i : m_i \times n \to m_i \otimes n$. this induces a unique mapping $\widehat{\phi} : m \times n \to p$ such that $\widehat{\phi} \circ (\mu_i \times 1) = \lambda_i \circ g_i$. it is $r$-bilinear. thus it induces an $r$-linear mapping $\phi : m \otimes n \to p$. from the commutative diagram below: $$ \xymatrix{ m_i \times n \ar[r]^{g_i} \ar[d]^{\mu_i \times \text{id}} & m_i \otimes n\ar[r]_{\text{id}} \ar[d]_{\lambda_i} & m_i \otimes n \ar[d]_{\mu_i \otimes \text{id}} \ar[rd]^{\lambda_i} \\ m \times n \ar[r]^{\widehat{\phi}} & p \ar[r]^{\psi} & m \otimes n \ar[r]^{\phi} & p } $$ we see that $\psi\circ\widehat{\phi} = g$, the canonical $r$-bilinear mapping $g : m \times n \to m \otimes n$. so $\psi\circ\phi$ is identity on $m \otimes n$. from the right-hand square and triangle, $\phi\circ\psi$ is also identity on $p$. \end{proof} \begin{lemma} \label{lemma-tensor-product-exact} let \begin{align*} m_1\xrightarrow{f} m_2\xrightarrow{g} m_3 \to 0 \end{align*} be an exact sequence of $r$-modules and homomorphisms, and let $n$ be any $r$-module. then the sequence \begin{equation} \label{equation-2ndex} m_1\otimes n\xrightarrow{f \otimes 1} m_2\otimes n \xrightarrow{g \otimes 1} m_3\otimes n \to 0 \end{equation} is exact. in other words, the functor $- \otimes_r n$ is {\it right exact}, in the sense that tensoring each term in the original right exact sequence preserves the exactness. \end{lemma} \begin{proof} for every $r$-module $p$ we apply the functor $\hom(-, \hom(n, p))$ to the first exact sequence. we obtain $$ 0 \to \hom(m_3, \hom(n, p)) \to \hom(m_2, \hom(n, p)) \to \hom(m_1, \hom(n, p)) $$ which is exact by lemma \ref{lemma-hom-exact} (1). by lemma \ref{lemma-hom-from-tensor-product} this becomes the sequence $$ 0 \to \hom(m_3 \otimes n, p) \to \hom(m_2 \otimes n, p) \to \hom(m_1 \otimes n, p) $$ which is therefore also exact. then using lemma \ref{lemma-hom-exact} (1) again, we arrive at the desired exact sequence. \end{proof} \begin{remark} \label{remark-tensor-product-not-exact} however, tensor product does not preserve exact sequences in general. in other words, if $m_1 \to m_2 \to m_3$ is exact, then it is not necessarily true that $m_1 \otimes n \to m_2 \otimes n \to m_3 \otimes n$ is exact for arbitrary $r$-module $n$. \end{remark} \begin{example} \label{example-tensor-product-not-exact} consider the injective map $2 : \mathbf{z}\to \mathbf{z}$ viewed as a map of $\mathbf{z}$-modules. let $n = \mathbf{z}/2$. then the induced map $\mathbf{z} \otimes \mathbf{z}/2 \to \mathbf{z} \otimes \mathbf{z}/2$ is not injective. this is because for $x \otimes y\in \mathbf{z} \otimes \mathbf{z}/2$, $$ (2 \otimes 1)(x \otimes y) = 2x \otimes y = x \otimes 2y = x \otimes 0 = 0 $$ therefore the induced map is the zero map while $\mathbf{z} \otimes n\neq 0$. \end{example} \begin{remark} \label{remark-flat-module} for $r$-modules $n$, if the functor $-\otimes_r n$ is exact, i.e. tensoring with $n$ preserves all exact sequences, then $n$ is said to be {\it flat} $r$-module. we will discuss this later in section \ref{section-flat}. \end{remark} \begin{lemma} \label{lemma-tensor-finiteness} let $r$ be a ring. let $m$ and $n$ be $r$-modules. \begin{enumerate} \item if $n$ and $m$ are finite, then so is $m \otimes_r n$. \item if $n$ and $m$ are finitely presented, then so is $m \otimes_r n$. \end{enumerate} \end{lemma} \begin{proof} suppose $m$ is finite. then choose a presentation $0 \to k \to r^{\oplus n} \to m \to 0$. this gives an exact sequence $k \otimes_r n \to n^{\oplus n} \to m \otimes_r n \to 0$ by lemma \ref{lemma-tensor-product-exact}. we conclude that if $n$ is finite too then $m \otimes_r n$ is a quotient of a finite module, hence finite, see lemma \ref{lemma-extension}. similarly, if both $n$ and $m$ are finitely presented, then we see that $k$ is finite and that $m \otimes_r n$ is a quotient of the finitely presented module $n^{\oplus n}$ by a finite module, namely $k \otimes_r n$, and hence finitely presented, see lemma \ref{lemma-extension}. \end{proof} \begin{lemma} \label{lemma-tensor-localization} let $m$ be an $r$-module. then the $s^{-1}r$-modules $s^{-1}m$ and $s^{-1}r \otimes_r m$ are canonically isomorphic, and the canonical isomorphism $f : s^{-1}r \otimes_r m \to s^{-1}m$ is given by $$ f((a/s) \otimes m) = am/s, \forall a \in r, m \in m, s \in s $$ \end{lemma} \begin{proof} obviously, the map $f' : s^{-1}r \times m \to s^{-1}m$ given by $f'(a/s, m) = am/s$ is bilinear, and thus by the universal property, this map induces a unique $s^{-1}r$-module homomorphism $f : s^{-1}r \otimes_r m \to s^{-1}m$ as in the statement of the lemma. actually every element in $s^{-1}m$ is of the form $m/s$, $m\in m, s\in s$ and every element in $s^{-1}r \otimes_r m$ is of the form $1/s \otimes m$. to see the latter fact, write an element in $s^{-1}r \otimes_r m$ as $$ \sum_k \frac{a_k}{s_k} \otimes m_k = \sum_k \frac{a_k t_k}{s} \otimes m_k = \frac{1}{s} \otimes \sum_k {a_k t_k}m_k = \frac{1}{s} \otimes m $$ where $m = \sum_k {a_k t_k}m_k$. then it is obvious that $f$ is surjective, and if $f(\frac{1}{s} \otimes m) = m/s = 0$ then there exists $t'\in s$ with $tm = 0$ in $m$. then we have $$ \frac{1}{s} \otimes m = \frac{1}{st} \otimes tm = \frac{1}{st} \otimes 0 = 0 $$ therefore $f$ is injective. \end{proof} \begin{lemma} \label{lemma-tensor-product-localization} let $m, n$ be $r$-modules, then there is a canonical $s^{-1}r$-module isomorphism $f : s^{-1}m \otimes_{s^{-1}r}s^{-1}n \to s^{-1}(m \otimes_r n)$, given by $$ f((m/s)\otimes(n/t)) = (m \otimes n)/st $$ \end{lemma} \begin{proof} we may use lemma \ref{lemma-tensor-with-bimodule} and lemma \ref{lemma-tensor-localization} repeatedly to see that these two $s^{-1}r$-modules are isomorphic, noting that $s^{-1}r$ is an $(r, s^{-1}r)$-bimodule: \begin{align*} s^{-1}(m \otimes_r n) & \cong s^{-1}r \otimes_r (m \otimes_r n)\\ & \cong s^{-1}m \otimes_r n\\ & \cong (s^{-1}m \otimes_{s^{-1}r}s^{-1}r)\otimes_r n\\ & \cong s^{-1}m \otimes_{s^{-1}r}(s^{-1}r \otimes_r n)\\ & \cong s^{-1}m \otimes_{s^{-1}r}s^{-1}n \end{align*} this isomorphism is easily seen to be the one stated in the lemma. \end{proof} \section{tensor algebra} \label{section-tensor-algebra} \noindent let $r$ be a ring. let $m$ be an $r$-module. we define the {\it tensor algebra of $m$ over $r$} to be the noncommutative $r$-algebra $$ \text{t}(m) = \text{t}_r(m) = \bigoplus\nolimits_{n \geq 0} \text{t}^n(m) $$ with $\text{t}^0(m) = r$, $\text{t}^1(m) = m$, $\text{t}^2(m) = m \otimes_r m$, $\text{t}^3(m) = m \otimes_r m \otimes_r m$, and so on. multiplication is defined by the rule that on pure tensors we have $$ (x_1 \otimes x_2 \otimes \ldots \otimes x_n) \cdot (y_1 \otimes y_2 \otimes \ldots \otimes y_m) = x_1 \otimes x_2 \otimes \ldots \otimes x_n \otimes y_1 \otimes y_2 \otimes \ldots \otimes y_m $$ and we extend this by linearity. \medskip\noindent we define the {\it exterior algebra $\wedge(m)$ of $m$ over $r$} to be the quotient of $\text{t}(m)$ by the two sided ideal generated by the elements $x \otimes x \in \text{t}^2(m)$. the image of a pure tensor $x_1 \otimes \ldots \otimes x_n$ in $\wedge^n(m)$ is denoted $x_1 \wedge \ldots \wedge x_n$. these elements generate $\wedge^n(m)$, they are $r$-linear in each $x_i$ and they are zero when two of the $x_i$ are equal (i.e., they are alternating as functions of $x_1, x_2, \ldots, x_n$). the multiplication on $\wedge(m)$ is graded commutative, i.e., every $x \in m$ and $y \in m$ satisfy $x \wedge y = - y \wedge x$. \medskip\noindent an example of this is when $m = rx_1 \oplus \ldots \oplus rx_n$ is a finite free module. in this case $\wedge(m)$ is free over $r$ with basis the elements $$ x_{i_1} \wedge \ldots \wedge x_{i_r} $$ with $0 \leq r \leq n$ and $1 \leq i_1 < i_2 < \ldots < i_r \leq n$. \medskip\noindent we define the {\it symmetric algebra $\text{sym}(m)$ of $m$ over $r$} to be the quotient of $\text{t}(m)$ by the two sided ideal generated by the elements $x \otimes y - y \otimes x \in \text{t}^2(m)$. the image of a pure tensor $x_1 \otimes \ldots \otimes x_n$ in $\text{sym}^n(m)$ is denoted just $x_1 \ldots x_n$. these elements generate $\text{sym}^n(m)$, these are $r$-linear in each $x_i$ and $x_1 \ldots x_n = x_1' \ldots x_n'$ if the sequence of elements $x_1, \ldots, x_n$ is a permutation of the sequence $x_1', \ldots, x_n'$. thus we see that $\text{sym}(m)$ is commutative. \medskip\noindent an example of this is when $m = rx_1 \oplus \ldots \oplus rx_n$ is a finite free module. in this case $\text{sym}(m) = r[x_1, \ldots, x_n]$ is a polynomial algebra. \begin{lemma} \label{lemma-free-tensor-algebra} let $r$ be a ring. let $m$ be an $r$-module. if $m$ is a free $r$-module, so is each symmetric and exterior power. \end{lemma} \begin{proof} omitted, but see above for the finite free case. \end{proof} \begin{lemma} \label{lemma-presentation-sym-exterior} let $r$ be a ring. let $m_2 \to m_1 \to m \to 0$ be an exact sequence of $r$-modules. there are exact sequences $$ m_2 \otimes_r \text{sym}^{n - 1}(m_1) \to \text{sym}^n(m_1) \to \text{sym}^n(m) \to 0 $$ and similarly $$ m_2 \otimes_r \wedge^{n - 1}(m_1) \to \wedge^n(m_1) \to \wedge^n(m) \to 0 $$ \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-present-sym-wedge} let $r$ be a ring. let $m$ be an $r$-module. let $x_i$, $i \in i$ be a given system of generators of $m$ as an $r$-module. let $n \geq 2$. there exists a canonical exact sequence $$ \bigoplus_{1 \leq j_1 < j_2 \leq n} \bigoplus_{i_1, i_2 \in i} \text{t}^{n - 2}(m) \oplus \bigoplus_{1 \leq j_1 < j_2 \leq n} \bigoplus_{i \in i} \text{t}^{n - 2}(m) \to \text{t}^n(m) \to \wedge^n(m) \to 0 $$ where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ in the first summand maps to \begin{align*} \underbrace{ m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_1} \text{ and } x_{i_2} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \\ + \underbrace{ m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_2} \text{ and } x_{i_1} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \end{align*} and $m_1 \otimes \ldots \otimes m_{n - 2}$ in the second summand maps to $$ \underbrace{ m_1 \otimes \ldots \otimes x_i \otimes \ldots \otimes x_i \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i} \text{ and } x_{i} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} $$ there is also a canonical exact sequence $$ \bigoplus_{1 \leq j_1 < j_2 \leq n} \bigoplus_{i_1, i_2 \in i} \text{t}^{n - 2}(m) \to \text{t}^n(m) \to \text{sym}^n(m) \to 0 $$ where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ maps to \begin{align*} \underbrace{ m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_1} \text{ and } x_{i_2} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \\ - \underbrace{ m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_2} \text{ and } x_{i_1} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \end{align*} \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-present-wedge} let $a \to b$ be a ring map. let $m$ be a $b$-module. let $n > 1$. the kernel of the $a$-linear map $m \otimes_a \ldots \otimes_a m \to \wedge^n_b(m)$ is generated as an $a$-module by the elements $m_1 \otimes \ldots \otimes m_n$ with $m_i = m_j$ for $i \not = j$, $m_1, \ldots, m_n \in m$ and the elements $m_1 \otimes \ldots \otimes bm_i \otimes \ldots \otimes m_n - m_1 \otimes \ldots \otimes bm_j \otimes \ldots \otimes m_n$ for $i \not = j$, $m_1, \ldots, m_n \in m$, and $b \in b$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-colimit-tensor-algebra} \begin{slogan} taking tensor algebras commutes with filtered colimits. \end{slogan} let $r$ be a ring. let $m_i$ be a directed system of $r$-modules. then $\colim_i \text{t}(m_i) = \text{t}(\colim_i m_i)$ and similarly for the symmetric and exterior algebras. \end{lemma} \begin{proof} omitted. hint: apply lemma \ref{lemma-tensor-products-commute-with-limits}. \end{proof} \begin{lemma} \label{lemma-tensor-algebra-localization} let $r$ be a ring and let $s \subset r$ be a multiplicative subset. then $s^{-1}t_r(m) = t_{s^{-1}r}(s^{-1}m)$ for any $r$-module $m$. similar for symmetric and exterior algebras. \end{lemma} \begin{proof} omitted. hint: apply lemma \ref{lemma-tensor-product-localization}. \end{proof} \section{base change} \label{section-base-change} \noindent we formally introduce base change in algebra as follows. \begin{definition} \label{definition-base-change} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. let $r \to r'$ be any ring map. the {\it base change} of $\varphi$ by $r \to r'$ is the ring map $r' \to s \otimes_r r'$. in this situation we often write $s' = s \otimes_r r'$. the {\it base change} of the $s$-module $m$ is the $s'$-module $m \otimes_r r'$. \end{definition} \noindent if $s = r[x_i]/(f_j)$ for some collection of variables $x_i$, $i \in i$ and some collection of polynomials $f_j \in r[x_i]$, $j \in j$, then $s \otimes_r r' = r'[x_i]/(f'_j)$, where $f'_j \in r'[x_i]$ is the image of $f_j$ under the map $r[x_i] \to r'[x_i]$ induced by $r \to r'$. this simple remark is the key to understanding base change. \begin{lemma} \label{lemma-base-change-finiteness} let $r \to s$ be a ring map. let $m$ be an $s$-module. let $r \to r'$ be a ring map and let $s' = s \otimes_r r'$ and $m' = m \otimes_r r'$ be the base changes. \begin{enumerate} \item if $m$ is a finite $s$-module, then the base change $m'$ is a finite $s'$-module. \item if $m$ is an $s$-module of finite presentation, then the base change $m'$ is an $s'$-module of finite presentation. \item if $r \to s$ is of finite type, then the base change $r' \to s'$ is of finite type. \item if $r \to s$ is of finite presentation, then the base change $r' \to s'$ is of finite presentation. \end{enumerate} \end{lemma} \begin{proof} proof of (1). take a surjective, $s$-linear map $s^{\oplus n} \to m \to 0$. by lemma \ref{lemma-flip-tensor-product} and \ref{lemma-tensor-product-exact} the result after tensoring with $r^\prime$ is a surjection ${s^\prime}^{\oplus n} \to m^\prime \rightarrow 0$, so $m^\prime$ is a finitely generated $s^\prime$-module. proof of (2). take a presentation $s^{\oplus m} \to s^{\oplus n} \to m \to 0$. by lemma \ref{lemma-flip-tensor-product} and \ref{lemma-tensor-product-exact} the result after tensoring with $r^\prime$ gives a finite presentation ${s^\prime}^{\oplus m} \to {s^\prime}^{\oplus n} \to m^\prime \to 0$, of the $s^\prime$-module $m^\prime$. proof of (3). this follows by the remark preceding the lemma as we can take $i$ to be finite by assumption. proof of (4). this follows by the remark preceding the lemma as we can take $i$ and $j$ to be finite by assumption. \end{proof} \noindent let $\varphi : r \to s$ be a ring map. given an $s$-module $n$ we obtain an $r$-module $n_r$ by the rule $r \cdot n = \varphi(r)n$. this is sometimes called the {\it restriction} of $n$ to $r$. \begin{lemma} \label{lemma-adjoint-tensor-restrict} let $r \to s$ be a ring map. the functors $\text{mod}_s \to \text{mod}_r$, $n \mapsto n_r$ (restriction) and $\text{mod}_r \to \text{mod}_s$, $m \mapsto m \otimes_r s$ (base change) are adjoint functors. in a formula $$ \hom_r(m, n_r) = \hom_s(m \otimes_r s, n) $$ \end{lemma} \begin{proof} if $\alpha : m \to n_r$ is an $r$-module map, then we define $\alpha' : m \otimes_r s \to n$ by the rule $\alpha'(m \otimes s) = s\alpha(m)$. if $\beta : m \otimes_r s \to n$ is an $s$-module map, we define $\beta' : m \to n_r$ by the rule $\beta'(m) = \beta(m \otimes 1)$. we omit the verification that these constructions are mutually inverse. \end{proof} \noindent the lemma above tells us that restriction has a left adjoint, namely base change. it also has a right adjoint. \begin{lemma} \label{lemma-adjoint-hom-restrict} let $r \to s$ be a ring map. the functors $\text{mod}_s \to \text{mod}_r$, $n \mapsto n_r$ (restriction) and $\text{mod}_r \to \text{mod}_s$, $m \mapsto \hom_r(s, m)$ are adjoint functors. in a formula $$ \hom_r(n_r, m) = \hom_s(n, \hom_r(s, m)) $$ \end{lemma} \begin{proof} if $\alpha : n_r \to m$ is an $r$-module map, then we define $\alpha' : n \to \hom_r(s, m)$ by the rule $\alpha'(n) = (s \mapsto \alpha(sn))$. if $\beta : n \to \hom_r(s, m)$ is an $s$-module map, we define $\beta' : n_r \to m$ by the rule $\beta'(n) = \beta(n)(1)$. we omit the verification that these constructions are mutually inverse. \end{proof} \begin{lemma} \label{lemma-hom-from-tensor-product-variant} let $r \to s$ be a ring map. given $s$-modules $m, n$ and an $r$-module $p$ we have $$ \hom_r(m \otimes_s n, p) = \hom_s(m, \hom_r(n, p)) $$ \end{lemma} \begin{proof} this can be proved directly, but it is also a consequence of lemmas \ref{lemma-adjoint-hom-restrict} and \ref{lemma-hom-from-tensor-product}. namely, we have \begin{align*} \hom_r(m \otimes_s n, p) & = \hom_s(m \otimes_s n, \hom_r(s, p)) \\ & = \hom_s(m, \hom_s(n, \hom_r(s, p))) \\ & = \hom_s(m, \hom_r(n, p)) \end{align*} as desired. \end{proof} \section{miscellany} \label{section-miscellany} \noindent the proofs in this section should not refer to any results except those from the section on basic notions, section \ref{section-rings-basic}. \begin{lemma} \label{lemma-product-ideals-in-prime} let $r$ be a ring, $i$ and $j$ two ideals and $\mathfrak p$ a prime ideal containing the product $ij$. then $\mathfrak{p}$ contains $i$ or $j$. \end{lemma} \begin{proof} assume the contrary and take $x \in i \setminus \mathfrak p$ and $y \in j \setminus \mathfrak p$. their product is an element of $ij \subset \mathfrak p$, which contradicts the assumption that $\mathfrak p$ was prime. \end{proof} \begin{lemma}[prime avoidance] \label{lemma-silly} \begin{slogan} 1. in an affine scheme if a finite number of points are contained in an open subset then they are contained in a smaller principal open subset. 2. affine opens are cofinal among the neighborhoods of a given finite set of an affine scheme \end{slogan} let $r$ be a ring. let $i_i \subset r$, $i = 1, \ldots, r$, and $j \subset r$ be ideals. assume \begin{enumerate} \item $j \not\subset i_i$ for $i = 1, \ldots, r$, and \item all but two of $i_i$ are prime ideals. \end{enumerate} then there exists an $x \in j$, $x\not\in i_i$ for all $i$. \end{lemma} \begin{proof} the result is true for $r = 1$. if $r = 2$, then let $x, y \in j$ with $x \not \in i_1$ and $y \not \in i_2$. we are done unless $x \in i_2$ and $y \in i_1$. then the element $x + y$ cannot be in $i_1$ (since that would mean $x + y - y \in i_1$) and it also cannot be in $i_2$. \medskip\noindent for $r \geq 3$, assume the result holds for $r - 1$. after renumbering we may assume that $i_r$ is prime. we may also assume there are no inclusions among the $i_i$. pick $x \in j$, $x \not \in i_i$ for all $i = 1, \ldots, r - 1$. if $x \not\in i_r$ we are done. so assume $x \in i_r$. if $j i_1 \ldots i_{r - 1} \subset i_r$ then $j \subset i_r$ (by lemma \ref{lemma-product-ideals-in-prime}) a contradiction. pick $y \in j i_1 \ldots i_{r - 1}$, $y \not \in i_r$. then $x + y$ works. \end{proof} \begin{lemma} \label{lemma-silly-silly} let $r$ be a ring. let $x \in r$, $i \subset r$ an ideal, and $\mathfrak p_i$, $i = 1, \ldots, r$ be prime ideals. suppose that $x + i \not \subset \mathfrak p_i$ for $i = 1, \ldots, r$. then there exists a $y \in i$ such that $x + y \not \in \mathfrak p_i$ for all $i$. \end{lemma} \begin{proof} we may assume there are no inclusions among the $\mathfrak p_i$. after reordering we may assume $x \not \in \mathfrak p_i$ for $i < s$ and $x \in \mathfrak p_i$ for $i \geq s$. if $s = r + 1$ then we are done. if not, then we can find $y \in i$ with $y \not \in \mathfrak p_s$. choose $f \in \bigcap_{i < s} \mathfrak p_i$ with $f \not \in \mathfrak p_s$. then $x + fy$ is not contained in $\mathfrak p_1, \ldots, \mathfrak p_s$. thus we win by induction on $s$. \end{proof} \begin{lemma}[chinese remainder] \label{lemma-chinese-remainder} let $r$ be a ring. \begin{enumerate} \item if $i_1, \ldots, i_r$ are ideals such that $i_a + i_b = r$ when $a \not = b$, then $i_1 \cap \ldots \cap i_r = i_1i_2\ldots i_r$ and $r/(i_1i_2\ldots i_r) \cong r/i_1 \times \ldots \times r/i_r$. \item if $\mathfrak m_1, \ldots, \mathfrak m_r$ are pairwise distinct maximal ideals then $\mathfrak m_a + \mathfrak m_b = r$ for $a \not = b$ and the above applies. \end{enumerate} \end{lemma} \begin{proof} let us first prove $i_1 \cap \ldots \cap i_r = i_1 \ldots i_r$ as this will also imply the injectivity of the induced ring homomorphism $r/(i_1 \ldots i_r) \rightarrow r/i_1 \times \ldots \times r/i_r$. the inclusion $i_1 \cap \ldots \cap i_r \supset i_1 \ldots i_r$ is always fulfilled since ideals are closed under multiplication with arbitrary ring elements. to prove the other inclusion, we claim that the ideals $$ i_1 \ldots \hat i_i \ldots i_r,\quad i = 1, \ldots, r $$ generate the ring $r$. we prove this by induction on $r$. it holds when $r = 2$. if $r > 2$, then we see that $r$ is the sum of the ideals $i_1 \ldots \hat i_i \ldots i_{r - 1}$, $i = 1, \ldots, r - 1$. hence $i_r$ is the sum of the ideals $i_1 \ldots \hat i_i \ldots i_r$, $i = 1, \ldots, r - 1$. applying the same argument with the reverse ordering on the ideals we see that $i_1$ is the sum of the ideals $i_1 \ldots \hat i_i \ldots i_r$, $i = 2, \ldots, r$. since $r = i_1 + i_r$ by assumption we see that $r$ is the sum of the ideals displayed above. therefore we can find elements $a_i \in i_1 \ldots \hat i_i \ldots i_r$ such that their sum is one. multiplying this equation by an element of $i_1 \cap \ldots \cap i_r$ gives the other inclusion. it remains to show that the canonical map $r/(i_1 \ldots i_r) \rightarrow r/i_1 \times \ldots \times r/i_r$ is surjective. for this, consider its action on the equation $1 = \sum_{i=1}^r a_i$ we derived above. on the one hand, a ring morphism sends 1 to 1 and on the other hand, the image of any $a_i$ is zero in $r/i_j$ for $j \neq i$. therefore, the image of $a_i$ in $r/i_i$ is the identity. so given any element $(\bar{b_1}, \ldots, \bar{b_r}) \in r/i_1 \times \ldots \times r/i_r$, the element $\sum_{i=1}^r a_i \cdot b_i$ is an inverse image in $r$. \medskip\noindent to see (2), by the very definition of being distinct maximal ideals, we have $\mathfrak{m}_a + \mathfrak{m}_b = r$ for $a \neq b$ and so the above applies. \end{proof} \begin{lemma} \label{lemma-matrix-left-inverse} let $r$ be a ring. let $n \geq m$. let $a$ be an $n \times m$ matrix with coefficients in $r$. let $j \subset r$ be the ideal generated by the $m \times m$ minors of $a$. \begin{enumerate} \item for any $f \in j$ there exists a $m \times n$ matrix $b$ such that $ba = f 1_{m \times m}$. \item if $f \in r$ and $ba = f 1_{m \times m}$ for some $m \times n$ matrix $b$, then $f^m \in j$. \end{enumerate} \end{lemma} \begin{proof} for $i \subset \{1, \ldots, n\}$ with $|i| = m$, we denote by $e_i$ the $m \times n$ matrix of the projection $$ r^{\oplus n} = \bigoplus\nolimits_{i \in \{1, \ldots, n\}} r \longrightarrow \bigoplus\nolimits_{i \in i} r $$ and set $a_i = e_i a$, i.e., $a_i$ is the $m \times m$ matrix whose rows are the rows of $a$ with indices in $i$. let $b_i$ be the adjugate (transpose of cofactor) matrix to $a_i$, i.e., such that $a_i b_i = b_i a_i = \det(a_i) 1_{m \times m}$. the $m \times m$ minors of $a$ are the determinants $\det a_i$ for all the $i \subset \{1, \ldots, n\}$ with $|i| = m$. if $f \in j$ then we can write $f = \sum c_i \det(a_i)$ for some $c_i \in r$. set $b = \sum c_i b_i e_i$ to see that (1) holds. \medskip\noindent if $f 1_{m \times m} = ba$ then by the cauchy-binet formula (\ref{item-cauchy-binet}) we have $f^m = \sum b_i \det(a_i)$ where $b_i$ is the determinant of the $m \times m$ matrix whose columns are the columns of $b$ with indices in $i$. \end{proof} \begin{lemma} \label{lemma-matrix-right-inverse} let $r$ be a ring. let $n \geq m$. let $a = (a_{ij})$ be an $n \times m$ matrix with coefficients in $r$, written in block form as $$ a = \left( \begin{matrix} a_1 \\ a_2 \end{matrix} \right) $$ where $a_1$ has size $m \times m$. let $b$ be the adjugate (transpose of cofactor) matrix to $a_1$. then $$ ab = \left( \begin{matrix} f 1_{m \times m} \\ c \end{matrix} \right) $$ where $f = \det(a_1)$ and $c_{ij}$ is (up to sign) the determinant of the $m \times m$ minor of $a$ corresponding to the rows $1, \ldots, \hat j, \ldots, m, i$. \end{lemma} \begin{proof} since the adjugate has the property $a_1b = b a_1 = f$ the first block of the expression for $ab$ is correct. note that $$ c_{ij} = \sum\nolimits_k a_{ik}b_{kj} = \sum (-1)^{j + k}a_{ik} \det(a_1^{jk}) $$ where $a_1^{ij}$ means $a_1$ with the $j$th row and $k$th column removed. this last expression is the row expansion of the determinant of the matrix in the statement of the lemma. \end{proof} \begin{lemma} \label{lemma-map-cannot-be-injective} \begin{slogan} a map of finite free modules cannot be injective if the source has rank bigger than the target. \end{slogan} let $r$ be a nonzero ring. let $n \geq 1$. let $m$ be an $r$-module generated by $< n$ elements. then any $r$-module map $f : r^{\oplus n} \to m$ has a nonzero kernel. \end{lemma} \begin{proof} choose a surjection $r^{\oplus n - 1} \to m$. we may lift the map $f$ to a map $f' : r^{\oplus n} \to r^{\oplus n - 1}$ (lemma \ref{lemma-lift-map}). it suffices to prove $f'$ has a nonzero kernel. the map $f' : r^{\oplus n} \to r^{\oplus n - 1}$ is given by a matrix $a = (a_{ij})$. if one of the $a_{ij}$ is not nilpotent, say $a = a_{ij}$ is not, then we can replace $r$ by the localization $r_a$ and we may assume $a_{ij}$ is a unit. since if we find a nonzero kernel after localization then there was a nonzero kernel to start with as localization is exact, see proposition \ref{proposition-localization-exact}. in this case we can do a base change on both $r^{\oplus n}$ and $r^{\oplus n - 1}$ and reduce to the case where $$ a = \left( \begin{matrix} 1 & 0 & 0 & \ldots \\ 0 & a_{22} & a_{23} & \ldots \\ 0 & a_{32} & \ldots \\ \ldots & \ldots \end{matrix} \right) $$ hence in this case we win by induction on $n$. if not then each $a_{ij}$ is nilpotent. set $i = (a_{ij}) \subset r$. note that $i^{m + 1} = 0$ for some $m \geq 0$. let $m$ be the largest integer such that $i^m \not = 0$. then we see that $(i^m)^{\oplus n}$ is contained in the kernel of the map and we win. \end{proof} \begin{lemma} \label{lemma-rank} \begin{slogan} the rank of a finite free module is well defined. \end{slogan} let $r$ be a nonzero ring. let $n, m \geq 0$ be integers. if $r^{\oplus n}$ is isomorphic to $r^{\oplus m}$ as $r$-modules, then $n = m$. \end{lemma} \begin{proof} immediate from lemma \ref{lemma-map-cannot-be-injective}. \end{proof} \section{cayley-hamilton} \label{section-cayley-hamilton} \begin{lemma} \label{lemma-charpoly} let $r$ be a ring. let $a = (a_{ij})$ be an $n \times n$ matrix with coefficients in $r$. let $p(x) \in r[x]$ be the characteristic polynomial of $a$ (defined as $\det(x\text{id}_{n \times n} - a)$). then $p(a) = 0$ in $\text{mat}(n \times n, r)$. \end{lemma} \begin{proof} we reduce the question to the well-known cayley-hamilton theorem from linear algebra in several steps: \begin{enumerate} \item if $\phi :s \rightarrow r$ is a ring morphism and $b_{ij}$ are inverse images of the $a_{ij}$ under this map, then it suffices to show the statement for $s$ and $(b_{ij})$ since $\phi$ is a ring morphism. \item if $\psi :r \hookrightarrow s$ is an injective ring morphism, it clearly suffices to show the result for $s$ and the $a_{ij}$ considered as elements of $s$. \item thus we may first reduce to the case $r = \mathbf{z}[x_{ij}]$, $a_{ij} = x_{ij}$ of a polynomial ring and then further to the case $r = \mathbf{q}(x_{ij})$ where we may finally apply cayley-hamilton. \end{enumerate} \end{proof} \begin{lemma} \label{lemma-charpoly-module} let $r$ be a ring. let $m$ be a finite $r$-module. let $\varphi : m \to m$ be an endomorphism. then there exists a monic polynomial $p \in r[t]$ such that $p(\varphi) = 0$ as an endomorphism of $m$. \end{lemma} \begin{proof} choose a surjective $r$-module map $r^{\oplus n} \to m$, given by $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ for some generators $x_i \in m$. choose $(a_{i1}, \ldots, a_{in}) \in r^{\oplus n}$ such that $\varphi(x_i) = \sum a_{ij} x_j$. in other words the diagram $$ \xymatrix{ r^{\oplus n} \ar[d]_a \ar[r] & m \ar[d]^\varphi \\ r^{\oplus n} \ar[r] & m } $$ is commutative where $a = (a_{ij})$. by lemma \ref{lemma-charpoly} there exists a monic polynomial $p$ such that $p(a) = 0$. then it follows that $p(\varphi) = 0$. \end{proof} \begin{lemma} \label{lemma-charpoly-module-ideal} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be a finite $r$-module. let $\varphi : m \to m$ be an endomorphism such that $\varphi(m) \subset im$. then there exists a monic polynomial $p = t^n + a_1 t^{n - 1} + \ldots + a_n \in r[t]$ such that $a_j \in i^j$ and $p(\varphi) = 0$ as an endomorphism of $m$. \end{lemma} \begin{proof} choose a surjective $r$-module map $r^{\oplus n} \to m$, given by $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ for some generators $x_i \in m$. choose $(a_{i1}, \ldots, a_{in}) \in i^{\oplus n}$ such that $\varphi(x_i) = \sum a_{ij} x_j$. in other words the diagram $$ \xymatrix{ r^{\oplus n} \ar[d]_a \ar[r] & m \ar[d]^\varphi \\ i^{\oplus n} \ar[r] & m } $$ is commutative where $a = (a_{ij})$. by lemma \ref{lemma-charpoly} the polynomial $p(t) = \det(t\text{id}_{n \times n} - a)$ has all the desired properties. \end{proof} \noindent as a fun example application we prove the following surprising lemma. \begin{lemma} \label{lemma-fun} let $r$ be a ring. let $m$ be a finite $r$-module. let $\varphi : m \to m$ be a surjective $r$-module map. then $\varphi$ is an isomorphism. \end{lemma} \begin{proof}[first proof] write $r' = r[x]$ and think of $m$ as a finite $r'$-module with $x$ acting via $\varphi$. set $i = (x) \subset r'$. by our assumption that $\varphi$ is surjective we have $im = m$. hence we may apply lemma \ref{lemma-charpoly-module-ideal} to $m$ as an $r'$-module, the ideal $i$ and the endomorphism $\text{id}_m$. we conclude that $(1 + a_1 + \ldots + a_n)\text{id}_m = 0$ with $a_j \in i$. write $a_j = b_j(x)x$ for some $b_j(x) \in r[x]$. translating back into $\varphi$ we see that $\text{id}_m = -(\sum_{j = 1, \ldots, n} b_j(\varphi)) \varphi$, and hence $\varphi$ is invertible. \end{proof} \begin{proof}[second proof] we perform induction on the number of generators of $m$ over $r$. if $m$ is generated by one element, then $m \cong r/i$ for some ideal $i \subset r$. in this case we may replace $r$ by $r/i$ so that $m = r$. in this case $\varphi : r \to r$ is given by multiplication on $m$ by an element $r \in r$. the surjectivity of $\varphi$ forces $r$ invertible, since $\varphi$ must hit $1$, which implies that $\varphi$ is invertible. \medskip\noindent now assume that we have proven the lemma in the case of modules generated by $n - 1$ elements, and are examining a module $m$ generated by $n$ elements. let $a$ mean the ring $r[t]$, and regard the module $m$ as an $a$-module by letting $t$ act via $\varphi$; since $m$ is finite over $r$, it is finite over $r[t]$ as well, and since we're trying to prove $\varphi$ injective, a set-theoretic property, we might as well prove the endomorphism $t : m \to m$ over $a$ injective. we have reduced our problem to the case our endomorphism is multiplication by an element of the ground ring. let $m' \subset m$ denote the sub-$a$-module generated by the first $n - 1$ of the generators of $m$, and consider the diagram $$ \xymatrix{ 0 \ar[r] & m' \ar[r]\ar[d]^{\varphi\mid_{m'}} & m\ar[d]^\varphi \ar[r] & m/m' \ar[d]^{\varphi \bmod m'} \ar[r] & 0 \\ 0 \ar[r] & m' \ar[r] & m \ar[r] & m/m' \ar[r] & 0, } $$ where the restriction of $\varphi$ to $m'$ and the map induced by $\varphi$ on the quotient $m/m'$ are well-defined since $\varphi$ is multiplication by an element in the base, and $m'$ and $m/m'$ are $a$-modules in their own right. by the case $n = 1$ the map $m/m' \to m/m'$ is an isomorphism. a diagram chase implies that $\varphi|_{m'}$ is surjective hence by induction $\varphi|_{m'}$ is an isomorphism. this forces the middle column to be an isomorphism by the snake lemma. \end{proof} \section{the spectrum of a ring} \label{section-spectrum-ring} \noindent we arbitrarily decide that the spectrum of a ring as a topological space is part of the algebra chapter, whereas an affine scheme is part of the chapter on schemes. \begin{definition} \label{definition-spectrum-ring} let $r$ be a ring. \begin{enumerate} \item the {\it spectrum} of $r$ is the set of prime ideals of $r$. it is usually denoted $\spec(r)$. \item given a subset $t \subset r$ we let $v(t) \subset \spec(r)$ be the set of primes containing $t$, i.e., $v(t) = \{ \mathfrak p \in \spec(r) \mid \forall f\in t, f\in \mathfrak p\}$. \item given an element $f \in r$ we let $d(f) \subset \spec(r)$ be the set of primes not containing $f$. \end{enumerate} \end{definition} \begin{lemma} \label{lemma-zariski-topology} let $r$ be a ring. \begin{enumerate} \item the spectrum of a ring $r$ is empty if and only if $r$ is the zero ring. \item every nonzero ring has a maximal ideal. \item every nonzero ring has a minimal prime ideal. \item given an ideal $i \subset r$ and a prime ideal $i \subset \mathfrak p$ there exists a prime $i \subset \mathfrak q \subset \mathfrak p$ such that $\mathfrak q$ is minimal over $i$. \item if $t \subset r$, and if $(t)$ is the ideal generated by $t$ in $r$, then $v((t)) = v(t)$. \item if $i$ is an ideal and $\sqrt{i}$ is its radical, see basic notion (\ref{item-radical-ideal}), then $v(i) = v(\sqrt{i})$. \item given an ideal $i$ of $r$ we have $\sqrt{i} = \bigcap_{i \subset \mathfrak p} \mathfrak p$. \item if $i$ is an ideal then $v(i) = \emptyset$ if and only if $i$ is the unit ideal. \item if $i$, $j$ are ideals of $r$ then $v(i) \cup v(j) = v(i \cap j)$. \item if $(i_a)_{a\in a}$ is a set of ideals of $r$ then $\bigcap_{a\in a} v(i_a) = v(\bigcup_{a\in a} i_a)$. \item if $f \in r$, then $d(f) \amalg v(f) = \spec(r)$. \item if $f \in r$ then $d(f) = \emptyset$ if and only if $f$ is nilpotent. \item if $f = u f'$ for some unit $u \in r$, then $d(f) = d(f')$. \item if $i \subset r$ is an ideal, and $\mathfrak p$ is a prime of $r$ with $\mathfrak p \not\in v(i)$, then there exists an $f \in r$ such that $\mathfrak p \in d(f)$, and $d(f) \cap v(i) = \emptyset$. \item if $f, g \in r$, then $d(fg) = d(f) \cap d(g)$. \item if $f_i \in r$ for $i \in i$, then $\bigcup_{i\in i} d(f_i)$ is the complement of $v(\{f_i \}_{i\in i})$ in $\spec(r)$. \item if $f \in r$ and $d(f) = \spec(r)$, then $f$ is a unit. \end{enumerate} \end{lemma} \begin{proof} we address each part in the corresponding item below. \begin{enumerate} \item this is a direct consequence of (2) or (3). \item let $\mathfrak{a}$ be the set of all proper ideals of $r$. this set is ordered by inclusion and is non-empty, since $(0) \in \mathfrak{a}$ is a proper ideal. let $a$ be a totally ordered subset of $\mathfrak a$. then $\bigcup_{i \in a} i$ is in fact an ideal. since 1 $\notin i$ for all $i \in a$, the union does not contain 1 and thus is proper. hence $\bigcup_{i \in a} i$ is in $\mathfrak{a}$ and is an upper bound for the set $a$. thus by zorn's lemma $\mathfrak{a}$ has a maximal element, which is the sought-after maximal ideal. \item since $r$ is nonzero, it contains a maximal ideal which is a prime ideal. thus the set $\mathfrak{a}$ of all prime ideals of $r$ is nonempty. $\mathfrak{a}$ is ordered by reverse-inclusion. let $a$ be a totally ordered subset of $\mathfrak{a}$. it's pretty clear that $j = \bigcap_{i \in a} i$ is in fact an ideal. not so clear, however, is that it is prime. let $xy \in j$. then $xy \in i$ for all $i \in a$. now let $b = \{i \in a | y \in i\}$. let $k = \bigcap_{i \in b} i$. since $a$ is totally ordered, either $k = j$ (and we're done, since then $y \in j$) or $k \supset j$ and for all $i \in a$ such that $i$ is properly contained in $k$, we have $y \notin i$. but that means that for all those $i, x \in i$, since they are prime. hence $x \in j$. in either case, $j$ is prime as desired. hence by zorn's lemma we get a maximal element which in this case is a minimal prime ideal. \item this is the same exact argument as (3) except you only consider prime ideals contained in $\mathfrak{p}$ and containing $i$. \item $(t)$ is the smallest ideal containing $t$. hence if $t \subset i$, some ideal, then $(t) \subset i$ as well. hence if $i \in v(t)$, then $i \in v((t))$ as well. the other inclusion is obvious. \item since $i \subset \sqrt{i}, v(\sqrt{i}) \subset v(i)$. now let $\mathfrak{p} \in v(i)$. let $x \in \sqrt{i}$. then $x^n \in i$ for some $n$. hence $x^n \in \mathfrak{p}$. but since $\mathfrak{p}$ is prime, a boring induction argument gets you that $x \in \mathfrak{p}$. hence $\sqrt{i} \subset \mathfrak{p}$ and $\mathfrak{p} \in v(\sqrt{i})$. \item let $f \in r \setminus \sqrt{i}$. then $f^n \notin i$ for all $n$. hence $s = \{1, f, f^2, \ldots\}$ is a multiplicative subset, not containing $0$. take a prime ideal $\bar{\mathfrak{p}} \subset s^{-1}r$ containing $s^{-1}i$. then the pull-back $\mathfrak{p}$ in $r$ of $\bar{\mathfrak{p}}$ is a prime ideal containing $i$ that does not intersect $s$. this shows that $\bigcap_{i \subset \mathfrak p} \mathfrak p \subset \sqrt{i}$. now if $a \in \sqrt{i}$, then $a^n \in i$ for some $n$. hence if $i \subset \mathfrak{p}$, then $a^n \in \mathfrak{p}$. but since $\mathfrak{p}$ is prime, we have $a \in \mathfrak{p}$. thus the equality is shown. \item $i$ is not the unit ideal if and only if $i$ is contained in some maximal ideal (to see this, apply (2) to the ring $r/i$) which is therefore prime. \item if $\mathfrak{p} \in v(i) \cup v(j)$, then $i \subset \mathfrak{p}$ or $j \subset \mathfrak{p}$ which means that $i \cap j \subset \mathfrak{p}$. now if $i \cap j \subset \mathfrak{p}$, then $ij \subset \mathfrak{p}$ and hence either $i$ of $j$ is in $\mathfrak{p}$, since $\mathfrak{p}$ is prime. \item $\mathfrak{p} \in \bigcap_{a \in a} v(i_a) \leftrightarrow i_a \subset \mathfrak{p}, \forall a \in a \leftrightarrow \mathfrak{p} \in v(\bigcup_{a\in a} i_a)$ \item if $\mathfrak{p}$ is a prime ideal and $f \in r$, then either $f \in \mathfrak{p}$ or $f \notin \mathfrak{p}$ (strictly) which is what the disjoint union says. \item if $a \in r$ is nilpotent, then $a^n = 0$ for some $n$. hence $a^n \in \mathfrak{p}$ for any prime ideal. thus $a \in \mathfrak{p}$ as can be shown by induction and $d(a) = \emptyset$. now, as shown in (7), if $a \in r$ is not nilpotent, then there is a prime ideal that does not contain it. \item $f \in \mathfrak{p} \leftrightarrow uf \in \mathfrak{p}$, since $u$ is invertible. \item if $\mathfrak{p} \notin v(i)$, then $\exists f \in i \setminus \mathfrak{p}$. then $f \notin \mathfrak{p}$ so $\mathfrak{p} \in d(f)$. also if $\mathfrak{q} \in d(f)$, then $f \notin \mathfrak{q}$ and thus $i$ is not contained in $\mathfrak{q}$. thus $d(f) \cap v(i) = \emptyset$. \item if $fg \in \mathfrak{p}$, then $f \in \mathfrak{p}$ or $g \in \mathfrak{p}$. hence if $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$, then $fg \notin \mathfrak{p}$. since $\mathfrak{p}$ is an ideal, if $fg \notin \mathfrak{p}$, then $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$. \item $\mathfrak{p} \in \bigcup_{i \in i} d(f_i) \leftrightarrow \exists i \in i, f_i \notin \mathfrak{p} \leftrightarrow \mathfrak{p} \in \spec(r) \setminus v(\{f_i\}_{i \in i})$ \item if $d(f) = \spec(r)$, then $v(f) = \emptyset$ and hence $fr = r$, so $f$ is a unit. \end{enumerate} \end{proof} \noindent the lemma implies that the subsets $v(t)$ from definition \ref{definition-spectrum-ring} form the closed subsets of a topology on $\spec(r)$. and it also shows that the sets $d(f)$ are open and form a basis for this topology. \begin{definition} \label{definition-zariski-topology} let $r$ be a ring. the topology on $\spec(r)$ whose closed sets are the sets $v(t)$ is called the {\it zariski} topology. the open subsets $d(f)$ are called the {\it standard opens} of $\spec(r)$. \end{definition} \noindent it should be clear from context whether we consider $\spec(r)$ just as a set or as a topological space. \begin{lemma} \label{lemma-spec-functorial} \begin{slogan} functoriality of the spectrum \end{slogan} suppose that $\varphi : r \to r'$ is a ring homomorphism. the induced map $$ \spec(\varphi) : \spec(r') \longrightarrow \spec(r), \quad \mathfrak p' \longmapsto \varphi^{-1}(\mathfrak p') $$ is continuous for the zariski topologies. in fact, for any element $f \in r$ we have $\spec(\varphi)^{-1}(d(f)) = d(\varphi(f))$. \end{lemma} \begin{proof} it is basic notion (\ref{item-inverse-image-prime}) that $\mathfrak p := \varphi^{-1}(\mathfrak p')$ is indeed a prime ideal of $r$. the last assertion of the lemma follows directly from the definitions, and implies the first. \end{proof} \noindent if $\varphi' : r' \to r''$ is a second ring homomorphism then the composition $$ \spec(r'') \longrightarrow \spec(r') \longrightarrow \spec(r) $$ equals $\spec(\varphi' \circ \varphi)$. in other words, $\spec$ is a contravariant functor from the category of rings to the category of topological spaces. \begin{lemma} \label{lemma-spec-localization} let $r$ be a ring. let $s \subset r$ be a multiplicative subset. the map $r \to s^{-1}r$ induces via the functoriality of $\spec$ a homeomorphism $$ \spec(s^{-1}r) \longrightarrow \{\mathfrak p \in \spec(r) \mid s \cap \mathfrak p = \emptyset \} $$ where the topology on the right hand side is that induced from the zariski topology on $\spec(r)$. the inverse map is given by $\mathfrak p \mapsto s^{-1}\mathfrak p = \mathfrak p(s^{-1}r)$. \end{lemma} \begin{proof} denote the right hand side of the arrow of the lemma by $d$. choose a prime $\mathfrak p' \subset s^{-1}r$ and let $\mathfrak p$ the inverse image of $\mathfrak p'$ in $r$. since $\mathfrak p'$ does not contain $1$ we see that $\mathfrak p$ does not contain any element of $s$. hence $\mathfrak p \in d$ and we see that the image is contained in $d$. let $\mathfrak p \in d$. by assumption the image $\overline{s}$ does not contain $0$. by basic notion (\ref{item-localization-zero}) $\overline{s}^{-1}(r/\mathfrak p)$ is not the zero ring. by basic notion (\ref{item-localize-ideal}) we see $s^{-1}r / s^{-1}\mathfrak p = \overline{s}^{-1}(r/\mathfrak p)$ is a domain, and hence $s^{-1}\mathfrak p$ is a prime. the equality of rings also shows that the inverse image of $s^{-1}\mathfrak p$ in $r$ is equal to $\mathfrak p$, because $r/\mathfrak p \to \overline{s}^{-1}(r/\mathfrak p)$ is injective by basic notion (\ref{item-localize-nonzerodivisors}). this proves that the map $\spec(s^{-1}r) \to \spec(r)$ is bijective onto $d$ with inverse as given. it is continuous by lemma \ref{lemma-spec-functorial}. finally, let $d(g) \subset \spec(s^{-1}r)$ be a standard open. write $g = h/s$ for some $h\in r$ and $s\in s$. since $g$ and $h/1$ differ by a unit we have $d(g) = d(h/1)$ in $\spec(s^{-1}r)$. hence by lemma \ref{lemma-spec-functorial} and the bijectivity above the image of $d(g) = d(h/1)$ is $d \cap d(h)$. this proves the map is open as well. \end{proof} \begin{lemma} \label{lemma-standard-open} let $r$ be a ring. let $f \in r$. the map $r \to r_f$ induces via the functoriality of $\spec$ a homeomorphism $$ \spec(r_f) \longrightarrow d(f) \subset \spec(r). $$ the inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot r_f$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-spec-localization}. \end{proof} \noindent it is not the case that every ``affine open'' of a spectrum is a standard open. see example \ref{example-affine-open-not-standard}. \begin{lemma} \label{lemma-spec-closed} let $r$ be a ring. let $i \subset r$ be an ideal. the map $r \to r/i$ induces via the functoriality of $\spec$ a homeomorphism $$ \spec(r/i) \longrightarrow v(i) \subset \spec(r). $$ the inverse is given by $\mathfrak p \mapsto \mathfrak p / i$. \end{lemma} \begin{proof} it is immediate that the image is contained in $v(i)$. on the other hand, if $\mathfrak p \in v(i)$ then $\mathfrak p \supset i$ and we may consider the ideal $\mathfrak p /i \subset r/i$. using basic notion (\ref{item-isomorphism-theorem}) we see that $(r/i)/(\mathfrak p/i) = r/\mathfrak p$ is a domain and hence $\mathfrak p/i$ is a prime ideal. from this it is immediately clear that the image of $d(f + i)$ is $d(f) \cap v(i)$, and hence the map is a homeomorphism. \end{proof} \begin{lemma} \label{lemma-quasi-compact} \begin{slogan} the spectrum of a ring is quasi-compact \end{slogan} let $r$ be a ring. the space $\spec(r)$ is quasi-compact. \end{lemma} \begin{proof} it suffices to prove that any covering of $\spec(r)$ by standard opens can be refined by a finite covering. thus suppose that $\spec(r) = \cup d(f_i)$ for a set of elements $\{f_i\}_{i\in i}$ of $r$. this means that $\cap v(f_i) = \emptyset$. according to lemma \ref{lemma-zariski-topology} this means that $v(\{f_i \}) = \emptyset$. according to the same lemma this means that the ideal generated by the $f_i$ is the unit ideal of $r$. this means that we can write $1$ as a {\it finite} sum: $1 = \sum_{i \in j} r_i f_i$ with $j \subset i$ finite. and then it follows that $\spec(r) = \cup_{i \in j} d(f_i)$. \end{proof} \begin{lemma} \label{lemma-topology-spec} let $r$ be a ring. the topology on $x = \spec(r)$ has the following properties: \begin{enumerate} \item $x$ is quasi-compact, \item $x$ has a basis for the topology consisting of quasi-compact opens, and \item the intersection of any two quasi-compact opens is quasi-compact. \end{enumerate} \end{lemma} \begin{proof} the spectrum of a ring is quasi-compact, see lemma \ref{lemma-quasi-compact}. it has a basis for the topology consisting of the standard opens $d(f) = \spec(r_f)$ (lemma \ref{lemma-standard-open}) which are quasi-compact by the first remark. the intersection of two standard opens is quasi-compact as $d(f) \cap d(g) = d(fg)$. given any two quasi-compact opens $u, v \subset x$ we may write $u = d(f_1) \cup \ldots \cup d(f_n)$ and $v = d(g_1) \cup \ldots \cup d(g_m)$. then $u \cap v = \bigcup d(f_ig_j)$ which is quasi-compact. \end{proof} \section{local rings} \label{section-local-rings} \noindent local rings are the bread and butter of algebraic geometry. \begin{definition} \label{definition-local-ring} a {\it local ring} is a ring with exactly one maximal ideal. if $r$ is a local ring, then the maximal ideal is often denoted $\mathfrak m_r$ and the field $r/\mathfrak m_r$ is called the {\it residue field} of the local ring $r$. we often say ``let $(r, \mathfrak m)$ be a local ring'' or ``let $(r, \mathfrak m, \kappa)$ be a local ring'' to indicate that $r$ is local, $\mathfrak m$ is its unique maximal ideal and $\kappa = r/\mathfrak m$ is its residue field. a {\it local homomorphism of local rings} is a ring map $\varphi : r \to s$ such that $r$ and $s$ are local rings and such that $\varphi(\mathfrak m_r) \subset \mathfrak m_s$. if it is given that $r$ and $s$ are local rings, then the phrase ``{\it local ring map $\varphi : r \to s$}'' means that $\varphi$ is a local homomorphism of local rings. \end{definition} \noindent a field is a local ring. any ring map between fields is a local homomorphism of local rings. \medskip\noindent the localization $r_\mathfrak p$ of a ring $r$ at a prime $\mathfrak p$ is a local ring with maximal ideal $\mathfrak p r_\mathfrak p$. namely, by lemma \ref{lemma-spec-localization} every prime ideal of $r_\mathfrak p$ is contained in the prime ideal $\mathfrak p r_\mathfrak p$ (hence this is a maximal ideal and the only maximal ideal of $r_\mathfrak p$). the residue field of $r_\mathfrak p$ is denoted $\kappa(\mathfrak p)$; we call it the {\it residue field of $\mathfrak p$}; by proposition \ref{proposition-localize-quotient} we may identify $\kappa(\mathfrak p)$ with the field of fractions of the domain $r/\mathfrak p$. via the composition $$ \spec(\kappa(\mathfrak p)) \to \spec(r_\mathfrak p) \to \spec(r) $$ the unique point of the source maps to the point $\mathfrak p$ of the target. \medskip\noindent let $\varphi : r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime and consider the prime $\mathfrak p = \varphi^{-1}(\mathfrak q)$ of $r$. since $\varphi(\mathfrak p) \subset \mathfrak q$ the induced ring map $$ r_\mathfrak p \to s_\mathfrak q,\quad r/g \mapsto \varphi(r)/\varphi(g) $$ is a local ring map and we obtain an induced map of residue fields $\kappa(\mathfrak p) \to \kappa(\mathfrak q)$. \begin{example} \label{example-not-local} if $r$ is a local ring and $\mathfrak p \subset r$ is a non-maximal prime ideal, then $r \to r_\mathfrak p$ is not a local homomorphism. \end{example} \begin{lemma} \label{lemma-characterize-local-ring} let $r$ be a ring. the following are equivalent: \begin{enumerate} \item $r$ is a local ring, \item $\spec(r)$ has exactly one closed point, \item $r$ has a maximal ideal $\mathfrak m$ and every element of $r \setminus \mathfrak m$ is a unit, and \item $r$ is not the zero ring and for every $x \in r$ either $x$ or $1 - x$ is invertible or both. \end{enumerate} \end{lemma} \begin{proof} let $r$ be a ring, and $\mathfrak m$ a maximal ideal. if $x \in r \setminus \mathfrak m$, and $x$ is not a unit then there is a maximal ideal $\mathfrak m'$ containing $x$. hence $r$ has at least two maximal ideals. conversely, if $\mathfrak m'$ is another maximal ideal, then choose $x \in \mathfrak m'$, $x \not \in \mathfrak m$. clearly $x$ is not a unit. this proves the equivalence of (1) and (3). the equivalence (1) and (2) is tautological. if $r$ is local then (4) holds since $x$ is either in $\mathfrak m$ or not. if (4) holds, and $\mathfrak m$, $\mathfrak m'$ are distinct maximal ideals then we may choose $x \in r$ such that $x \bmod \mathfrak m' = 0$ and $x \bmod \mathfrak m = 1$ by the chinese remainder theorem (lemma \ref{lemma-chinese-remainder}). this element $x$ is not invertible and neither is $1 - x$ which is a contradiction. thus (4) and (1) are equivalent. \end{proof} \begin{lemma} \label{lemma-characterize-local-ring-map} let $\varphi : r \to s$ be a ring map. assume $r$ and $s$ are local rings. the following are equivalent: \begin{enumerate} \item $\varphi$ is a local ring map, \item $\varphi(\mathfrak m_r) \subset \mathfrak m_s$, \item $\varphi^{-1}(\mathfrak m_s) = \mathfrak m_r$, and \item for any $x \in r$, if $\varphi(x)$ is invertible in $s$, then $x$ is invertible in $r$. \end{enumerate} \end{lemma} \begin{proof} conditions (1) and (2) are equivalent by definition. if (3) holds then (2) holds. conversely, if (2) holds, then $\varphi^{-1}(\mathfrak m_s)$ is a prime ideal containing the maximal ideal $\mathfrak m_r$, hence $\varphi^{-1}(\mathfrak m_s) = \mathfrak m_r$. finally, (4) is the contrapositive of (2) by lemma \ref{lemma-characterize-local-ring}. \end{proof} \begin{remark} \label{remark-fundamental-diagram} a fundamental commutative diagram associated to a ring map $\varphi : r \to s$ and a prime $\mathfrak p \subset r$ is the following $$ \xymatrix{ \kappa(\mathfrak p) \otimes_r s = s_{\mathfrak p}/{\mathfrak p}s_{\mathfrak p} & s_{\mathfrak p} \ar[l] & s \ar[r] \ar[l] & s/\mathfrak ps \ar[r] & (r \setminus \mathfrak p)^{-1}s/\mathfrak ps \\ \kappa(\mathfrak p) = r_{\mathfrak p}/{\mathfrak p}r_{\mathfrak p} \ar[u] & r_{\mathfrak p} \ar[u] \ar[l] & r \ar[u] \ar[r] \ar[l] & r/\mathfrak p \ar[u] \ar[r] & \kappa(\mathfrak p) \ar[u] } $$ in this diagram the outer left and outer right columns are identical. on spectra the horizontal maps induce homeomorphisms onto their images and the squares induce fibre squares of topological spaces (see lemmas \ref{lemma-spec-localization} and \ref{lemma-spec-closed}). this shows that $\mathfrak p$ is in the image of the map on spec if and only if $s \otimes_r \kappa(\mathfrak p)$ is not the zero ring. if there does exist a prime $\mathfrak q \subset s$ lying over $\mathfrak p$, i.e., with $\mathfrak p = \varphi^{-1}(\mathfrak q)$ then we can extend the diagram to the following diagram $$ \xymatrix{ \kappa(\mathfrak q) = s_{\mathfrak q}/{\mathfrak q}s_{\mathfrak q} & s_{\mathfrak q} \ar[l] & s \ar[r] \ar[l] & s/\mathfrak q \ar[r] & \kappa(\mathfrak q) \\ \kappa(\mathfrak p) \otimes_r s = s_{\mathfrak p}/{\mathfrak p}s_{\mathfrak p} \ar[u] & s_{\mathfrak p} \ar[u] \ar[l] & s \ar[u] \ar[r] \ar[l] & s/\mathfrak ps \ar[u] \ar[r] & (r \setminus \mathfrak p)^{-1}s/\mathfrak ps \ar[u] \\ \kappa(\mathfrak p) = r_{\mathfrak p}/{\mathfrak p}r_{\mathfrak p} \ar[u] & r_{\mathfrak p} \ar[u] \ar[l] & r \ar[u] \ar[r] \ar[l] & r/\mathfrak p \ar[u] \ar[r] & \kappa(\mathfrak p) \ar[u] } $$ in this diagram it is still the case that the outer left and outer right columns are identical and that on spectra the horizontal maps induce homeomorphisms onto their image. \end{remark} \begin{lemma} \label{lemma-in-image} let $\varphi : r \to s$ be a ring map. let $\mathfrak p$ be a prime of $r$. the following are equivalent \begin{enumerate} \item $\mathfrak p$ is in the image of $\spec(s) \to \spec(r)$, \item $s \otimes_r \kappa(\mathfrak p) \not = 0$, \item $s_{\mathfrak p}/\mathfrak p s_{\mathfrak p} \not = 0$, \item $(s/\mathfrak ps)_{\mathfrak p} \not = 0$, and \item $\mathfrak p = \varphi^{-1}(\mathfrak ps)$. \end{enumerate} \end{lemma} \begin{proof} we have already seen the equivalence of the first two in remark \ref{remark-fundamental-diagram}. the others are just reformulations of this. \end{proof} \section{the jacobson radical of a ring} \label{section-radical} \noindent we recall that the {\it jacobson radical} $\text{rad}(r)$ of a ring $r$ is the intersection of all maximal ideals of $r$. if $r$ is local then $\text{rad}(r)$ is the maximal ideal of $r$. \begin{lemma} \label{lemma-contained-in-radical} let $r$ be a ring with jacobson radical $\text{rad}(r)$. let $i \subset r$ be an ideal. the following are equivalent \begin{enumerate} \item $i \subset \text{rad}(r)$, and \item every element of $1 + i$ is a unit in $r$. \end{enumerate} in this case every element of $r$ which maps to a unit of $r/i$ is a unit. \end{lemma} \begin{proof} if $f \in \text{rad}(r)$, then $f \in \mathfrak m$ for all maximal ideals $\mathfrak m$ of $r$. hence $1 + f \not \in \mathfrak m$ for all maximal ideals $\mathfrak m$ of $r$. thus the closed subset $v(1 + f)$ of $\spec(r)$ is empty. this implies that $1 + f$ is a unit, see lemma \ref{lemma-zariski-topology}. \medskip\noindent conversely, assume that $1 + f$ is a unit for all $f \in i$. if $\mathfrak m$ is a maximal ideal and $i \not \subset \mathfrak m$, then $i + \mathfrak m = r$. hence $1 = f + g$ for some $g \in \mathfrak m$ and $f \in i$. then $g = 1 + (-f)$ is not a unit, contradiction. \medskip\noindent for the final statement let $f \in r$ map to a unit in $r/i$. then we can find $g \in r$ mapping to the multiplicative inverse of $f \bmod i$. then $fg = 1 \bmod i$. hence $fg$ is a unit of $r$ by (2) which implies that $f$ is a unit. \end{proof} \begin{lemma} \label{lemma-surjective-on-spec-units} let $\varphi : r \to s$ be a ring map such that the induced map $\spec(s) \to \spec(r)$ is surjective. then an element $x \in r$ is a unit if and only if $\varphi(x) \in s$ is a unit. \end{lemma} \begin{proof} if $x$ is a unit, then so is $\varphi(x)$. conversely, if $\varphi(x)$ is a unit, then $\varphi(x) \not \in \mathfrak q$ for all $\mathfrak q \in \spec(s)$. hence $x \not \in \varphi^{-1}(\mathfrak q) = \spec(\varphi)(\mathfrak q)$ for all $\mathfrak q \in \spec(s)$. since $\spec(\varphi)$ is surjective we conclude that $x$ is a unit by part (17) of lemma \ref{lemma-zariski-topology}. \end{proof} \section{nakayama's lemma} \label{section-nakayama} \noindent we quote from \cite{matca}: ``this simple but important lemma is due to t.~nakayama, g.~azumaya and w.~krull. priority is obscure, and although it is usually called the lemma of nakayama, late prof.~nakayama did not like the name.'' \begin{lemma}[nakayama's lemma] \label{lemma-nak} \begin{reference} \cite[1.m lemma (nak) page 11]{matca} \end{reference} \begin{history} we quote from \cite{matca}: ``this simple but important lemma is due to t.~nakayama, g.~azumaya and w.~krull. priority is obscure, and although it is usually called the lemma of nakayama, late prof.~nakayama did not like the name.'' \end{history} let $r$ be a ring with jacobson radical $\text{rad}(r)$. let $m$ be an $r$-module. let $i \subset r$ be an ideal. \begin{enumerate} \item \label{item-nakayama} if $im = m$ and $m$ is finite, then there exists an $f \in 1 + i$ such that $fm = 0$. \item if $im = m$, $m$ is finite, and $i \subset \text{rad}(r)$, then $m = 0$. \item if $n, n' \subset m$, $m = n + in'$, and $n'$ is finite, then there exists an $f \in 1 + i$ such that $fm \subset n$ and $m_f = n_f$. \item if $n, n' \subset m$, $m = n + in'$, $n'$ is finite, and $i \subset \text{rad}(r)$, then $m = n$. \item if $n \to m$ is a module map, $n/in \to m/im$ is surjective, and $m$ is finite, then there exists an $f \in 1 + i$ such that $n_f \to m_f$ is surjective. \item if $n \to m$ is a module map, $n/in \to m/im$ is surjective, $m$ is finite, and $i \subset \text{rad}(r)$, then $n \to m$ is surjective. \item if $x_1, \ldots, x_n \in m$ generate $m/im$ and $m$ is finite, then there exists an $f \in 1 + i$ such that $x_1, \ldots, x_n$ generate $m_f$ over $r_f$. \item if $x_1, \ldots, x_n \in m$ generate $m/im$, $m$ is finite, and $i \subset \text{rad}(r)$, then $m$ is generated by $x_1, \ldots, x_n$. \item if $im = m$, $i$ is nilpotent, then $m = 0$. \item if $n, n' \subset m$, $m = n + in'$, and $i$ is nilpotent then $m = n$. \item if $n \to m$ is a module map, $i$ is nilpotent, and $n/in \to m/im$ is surjective, then $n \to m$ is surjective. \item if $\{x_\alpha\}_{\alpha \in a}$ is a set of elements of $m$ which generate $m/im$ and $i$ is nilpotent, then $m$ is generated by the $x_\alpha$. \end{enumerate} \end{lemma} \begin{proof} proof of (\ref{item-nakayama}). choose generators $y_1, \ldots, y_m$ of $m$ over $r$. for each $i$ we can write $y_i = \sum z_{ij} y_j$ with $z_{ij} \in i$ (since $m = im$). in other words $\sum_j (\delta_{ij} - z_{ij})y_j = 0$. let $f$ be the determinant of the $m \times m$ matrix $a = (\delta_{ij} - z_{ij})$. note that $f \in 1 + i$ (since the matrix $a$ is entrywise congruent to the $m \times m$ identity matrix modulo $i$). by lemma \ref{lemma-matrix-left-inverse} (1), there exists an $m \times m$ matrix $b$ such that $ba = f 1_{m \times m}$. writing out we see that $\sum_{i} b_{hi} a_{ij} = f \delta_{hj}$ for all $h$ and $j$; hence, $\sum_{i, j} b_{hi} a_{ij} y_j = \sum_{j} f \delta_{hj} y_j = f y_h$ for every $h$. in other words, $0 = f y_h$ for every $h$ (since each $i$ satisfies $\sum_j a_{ij} y_j = 0$). this implies that $f$ annihilates $m$. \medskip\noindent by lemma \ref{lemma-contained-in-radical} an element of $1 + \text{rad}(r)$ is invertible element of $r$. hence we see that (\ref{item-nakayama}) implies (2). we obtain (3) by applying (1) to $m/n$ which is finite as $n'$ is finite. we obtain (4) by applying (2) to $m/n$ which is finite as $n'$ is finite. we obtain (5) by applying (3) to $m$ and the submodules $\im(n \to m)$ and $m$. we obtain (6) by applying (4) to $m$ and the submodules $\im(n \to m)$ and $m$. we obtain (7) by applying (5) to the map $r^{\oplus n} \to m$, $(a_1, \ldots, a_n) \mapsto a_1x_1 + \ldots + a_nx_n$. we obtain (8) by applying (6) to the map $r^{\oplus n} \to m$, $(a_1, \ldots, a_n) \mapsto a_1x_1 + \ldots + a_nx_n$. \medskip\noindent part (9) holds because if $m = im$ then $m = i^nm$ for all $n \geq 0$ and $i$ being nilpotent means $i^n = 0$ for some $n \gg 0$. parts (10), (11), and (12) follow from (9) by the arguments used above. \end{proof} \begin{lemma} \label{lemma-nak-localization} let $r$ be a ring, let $s \subset r$ be a multiplicative subset, let $i \subset r$ be an ideal, and let $m$ be a finite $r$-module. if $x_1, \ldots, x_r \in m$ generate $s^{-1}(m/im)$ as an $s^{-1}(r/i)$-module, then there exists an $f \in s + i$ such that $x_1, \ldots, x_r$ generate $m_f$ as an $r_f$-module.\footnote{special cases: (i) $i = 0$. the lemma says if $x_1, \ldots, x_r$ generate $s^{-1}m$, then $x_1, \ldots, x_r$ generate $m_f$ for some $f \in s$. (ii) $i = \mathfrak p$ is a prime ideal and $s = r \setminus \mathfrak p$. the lemma says if $x_1, \ldots, x_r$ generate $m \otimes_r \kappa(\mathfrak p)$ then $x_1, \ldots, x_r$ generate $m_f$ for some $f \in r$, $f \not \in \mathfrak p$.} \end{lemma} \begin{proof} special case $i = 0$. let $y_1, \ldots, y_s$ be generators for $m$ over $r$. since $s^{-1}m$ is generated by $x_1, \ldots, x_r$, for each $i$ we can write $y_i = \sum (a_{ij}/s_{ij})x_j$ in $s^{-1}m$ for some $a_{ij} \in r$ and $s_{ij} \in s$. multiplying by the product $s \in s$ of the $s_{ij}$ we see that $sy_i = \sum a'_{ij}x_j$ in $s^{-1}m$ for some $a'_{ij} \in r$. this in turn means there exist $t_i \in s$ such that $t_isy_i = \sum t_ia'_{ij}x_j$ in $m$. thus if $t \in s$ is the product of the $t_i$, then we see that $y_i$ is in the $r_{st}$-submodule generated by $x_1, \ldots, x_r$ of $m_{st}$. hence $x_1, \ldots, x_r$ generates $m_{st}$. \medskip\noindent general case. by the special case, we can find an $s \in s$ such that $x_1, \ldots, x_r$ generate $(m/im)_s$ over $(r/i)_s$. by lemma \ref{lemma-nak} we can find a $g \in 1 + i_s \subset r_s$ such that $x_1, \ldots, x_r$ generate $(m_s)_g$ over $(r_s)_g$. write $g = 1 + i/s'$. then $f = ss' + is$ works; details omitted. \end{proof} \begin{lemma} \label{lemma-when-surjective-local} let $a \to b$ be a local homomorphism of local rings. assume \begin{enumerate} \item $b$ is finite as an $a$-module, \item $\mathfrak m_b$ is a finitely generated ideal, \item $a \to b$ induces an isomorphism on residue fields, and \item $\mathfrak m_a/\mathfrak m_a^2 \to \mathfrak m_b/\mathfrak m_b^2$ is surjective. \end{enumerate} then $a \to b$ is surjective. \end{lemma} \begin{proof} to show that $a \to b$ is surjective, we view it as a map of $a$-modules and apply lemma \ref{lemma-nak} (6). we conclude it suffices to show that $a/\mathfrak m_a \to b/\mathfrak m_ab$ is surjective. as $a/\mathfrak m_a = b/\mathfrak m_b$ it suffices to show that $\mathfrak m_ab \to \mathfrak m_b$ is surjective. view $\mathfrak m_ab \to \mathfrak m_b$ as a map of $b$-modules and apply lemma \ref{lemma-nak} (6). we conclude it suffices to see that $\mathfrak m_ab/\mathfrak m_a\mathfrak m_b \to \mathfrak m_b/\mathfrak m_b^2$ is surjective. this follows from assumption (4). \end{proof} \section{open and closed subsets of spectra} \label{section-open-and-closed} \noindent it turns out that open and closed subsets of a spectrum correspond to idempotents of the ring. \begin{lemma} \label{lemma-idempotent-spec} let $r$ be a ring. let $e \in r$ be an idempotent. in this case $$ \spec(r) = d(e) \amalg d(1-e). $$ \end{lemma} \begin{proof} note that an idempotent $e$ of a domain is either $1$ or $0$. hence we see that \begin{eqnarray*} d(e) & = & \{ \mathfrak p \in \spec(r) \mid e \not\in \mathfrak p \} \\ & = & \{ \mathfrak p \in \spec(r) \mid e \not = 0\text{ in }\kappa(\mathfrak p) \} \\ & = & \{ \mathfrak p \in \spec(r) \mid e = 1\text{ in }\kappa(\mathfrak p) \} \end{eqnarray*} similarly we have \begin{eqnarray*} d(1-e) & = & \{ \mathfrak p \in \spec(r) \mid 1 - e \not\in \mathfrak p \} \\ & = & \{ \mathfrak p \in \spec(r) \mid e \not = 1\text{ in }\kappa(\mathfrak p) \} \\ & = & \{ \mathfrak p \in \spec(r) \mid e = 0\text{ in }\kappa(\mathfrak p) \} \end{eqnarray*} since the image of $e$ in any residue field is either $1$ or $0$ we deduce that $d(e)$ and $d(1-e)$ cover all of $\spec(r)$. \end{proof} \begin{lemma} \label{lemma-spec-product} let $r_1$ and $r_2$ be rings. let $r = r_1 \times r_2$. the maps $r \to r_1$, $(x, y) \mapsto x$ and $r \to r_2$, $(x, y) \mapsto y$ induce continuous maps $\spec(r_1) \to \spec(r)$ and $\spec(r_2) \to \spec(r)$. the induced map $$ \spec(r_1) \amalg \spec(r_2) \longrightarrow \spec(r) $$ is a homeomorphism. in other words, the spectrum of $r = r_1\times r_2$ is the disjoint union of the spectrum of $r_1$ and the spectrum of $r_2$. \end{lemma} \begin{proof} write $1 = e_1 + e_2$ with $e_1 = (1, 0)$ and $e_2 = (0, 1)$. note that $e_1$ and $e_2 = 1 - e_1$ are idempotents. we leave it to the reader to show that $r_1 = r_{e_1}$ is the localization of $r$ at $e_1$. similarly for $e_2$. thus the statement of the lemma follows from lemma \ref{lemma-idempotent-spec} combined with lemma \ref{lemma-standard-open}. \end{proof} \noindent we reprove the following lemma later after introducing a glueing lemma for functions. see section \ref{section-tilde-module-sheaf}. \begin{lemma} \label{lemma-disjoint-decomposition} let $r$ be a ring. for each $u \subset \spec(r)$ which is open and closed there exists a unique idempotent $e \in r$ such that $u = d(e)$. this induces a 1-1 correspondence between open and closed subsets $u \subset \spec(r)$ and idempotents $e \in r$. \end{lemma} \begin{proof} let $u \subset \spec(r)$ be open and closed. since $u$ is closed it is quasi-compact by lemma \ref{lemma-quasi-compact}, and similarly for its complement. write $u = \bigcup_{i = 1}^n d(f_i)$ as a finite union of standard opens. similarly, write $\spec(r) \setminus u = \bigcup_{j = 1}^m d(g_j)$ as a finite union of standard opens. since $\emptyset = d(f_i) \cap d(g_j) = d(f_i g_j)$ we see that $f_i g_j$ is nilpotent by lemma \ref{lemma-zariski-topology}. let $i = (f_1, \ldots, f_n) \subset r$ and let $j = (g_1, \ldots, g_m) \subset r$. note that $v(j)$ equals $u$, that $v(i)$ equals the complement of $u$, so $\spec(r) = v(i) \amalg v(j)$. by the remark on nilpotency above, we see that $(ij)^n = (0)$ for some sufficiently large integer $n$. since $\bigcup d(f_i) \cup \bigcup d(g_j) = \spec(r)$ we see that $i + j = r$, see lemma \ref{lemma-zariski-topology}. by raising this equation to the $2n$th power we conclude that $i^n + j^n = r$. write $1 = x + y$ with $x \in i^n$ and $y \in j^n$. then $0 = xy = x(1 - x)$ as $i^n j^n = (0)$. thus $x = x^2$ is idempotent and contained in $i^n \subset i$. the idempotent $y = 1 - x$ is contained in $j^n \subset j$. this shows that the idempotent $x$ maps to $1$ in every residue field $\kappa(\mathfrak p)$ for $\mathfrak p \in v(j)$ and that $x$ maps to $0$ in $\kappa(\mathfrak p)$ for every $\mathfrak p \in v(i)$. \medskip\noindent to see uniqueness suppose that $e_1, e_2$ are distinct idempotents in $r$. we have to show there exists a prime $\mathfrak p$ such that $e_1 \in \mathfrak p$ and $e_2 \not \in \mathfrak p$, or conversely. write $e_i' = 1 - e_i$. if $e_1 \not = e_2$, then $0 \not = e_1 - e_2 = e_1(e_2 + e_2') - (e_1 + e_1')e_2 = e_1 e_2' - e_1' e_2$. hence either the idempotent $e_1 e_2' \not = 0$ or $e_1' e_2 \not = 0$. an idempotent is not nilpotent, and hence we find a prime $\mathfrak p$ such that either $e_1e_2' \not \in \mathfrak p$ or $e_1'e_2 \not \in \mathfrak p$, by lemma \ref{lemma-zariski-topology}. it is easy to see this gives the desired prime. \end{proof} \begin{lemma} \label{lemma-characterize-spec-connected} let $r$ be a nonzero ring. then $\spec(r)$ is connected if and only if $r$ has no nontrivial idempotents. \end{lemma} \begin{proof} obvious from lemma \ref{lemma-disjoint-decomposition} and the definition of a connected topological space. \end{proof} \begin{lemma} \label{lemma-ideal-is-squared-union-connected} let $i \subset r$ be a finitely generated ideal of a ring $r$ such that $i = i^2$. then \begin{enumerate} \item there exists an idempotent $e \in r$ such that $i = (e)$, \item $r/i \cong r_{e'}$ for the idempotent $e' = 1 - e \in r$, and \item $v(i)$ is open and closed in $\spec(r)$. \end{enumerate} \end{lemma} \begin{proof} by nakayama's lemma \ref{lemma-nak} there exists an element $f = 1 + i$, $i \in i$ such that $fi = 0$. then $f^2 = f + fi = f$ is an idempotent. consider the idempotent $e = 1 - f = -i \in i$. for $j \in i$ we have $ej = j - fj = j$ hence $i = (e)$. this proves (1). \medskip\noindent parts (2) and (3) follow from (1). namely, we have $v(i) = v(e) = \spec(r) \setminus d(e)$ which is open and closed by either lemma \ref{lemma-idempotent-spec} or lemma \ref{lemma-disjoint-decomposition}. this proves (3). for (2) observe that the map $r \to r_{e'}$ is surjective since $x/(e')^n = x/e' = xe'/(e')^2 = xe'/e' = x/1$ in $r_{e'}$. the kernel of the map $r \to r_{e'}$ is the set of elements of $r$ annihilated by a positive power of $e'$. since $e'$ is idempotent this is the ideal of elements annihilated by $e'$ which is the ideal $i = (e)$ as $e + e' = 1$ is a pair of orthogonal idempotents. this proves (2). \end{proof} \section{connected components of spectra} \label{section-connected-components} \noindent connected components of spectra are not as easy to understand as one may think at first. this is because we are used to the topology of locally connected spaces, but the spectrum of a ring is in general not locally connected. \begin{lemma} \label{lemma-closed-union-connected-components} let $r$ be a ring. let $t \subset \spec(r)$ be a subset of the spectrum. the following are equivalent \begin{enumerate} \item $t$ is closed and is a union of connected components of $\spec(r)$, \item $t$ is an intersection of open and closed subsets of $\spec(r)$, and \item $t = v(i)$ where $i \subset r$ is an ideal generated by idempotents. \end{enumerate} moreover, the ideal in (3) if it exists is unique. \end{lemma} \begin{proof} by lemma \ref{lemma-topology-spec} and topology, lemma \ref{topology-lemma-closed-union-connected-components} we see that (1) and (2) are equivalent. assume (2) and write $t = \bigcap u_\alpha$ with $u_\alpha \subset \spec(r)$ open and closed. then $u_\alpha = d(e_\alpha)$ for some idempotent $e_\alpha \in r$ by lemma \ref{lemma-disjoint-decomposition}. then setting $i = (1 - e_\alpha)$ we see that $t = v(i)$, i.e., (3) holds. finally, assume (3). write $t = v(i)$ and $i = (e_\alpha)$ for some collection of idempotents $e_\alpha$. then it is clear that $t = \bigcap v(e_\alpha) = \bigcap d(1 - e_\alpha)$. \medskip\noindent suppose that $i$ is an ideal generated by idempotents. let $e \in r$ be an idempotent such that $v(i) \subset v(e)$. then by lemma \ref{lemma-zariski-topology} we see that $e^n \in i$ for some $n \geq 1$. as $e$ is an idempotent this means that $e \in i$. hence we see that $i$ is generated by exactly those idempotents $e$ such that $t \subset v(e)$. in other words, the ideal $i$ is completely determined by the closed subset $t$ which proves uniqueness. \end{proof} \begin{lemma} \label{lemma-connected-component} let $r$ be a ring. a connected component of $\spec(r)$ is of the form $v(i)$, where $i$ is an ideal generated by idempotents such that every idempotent of $r$ either maps to $0$ or $1$ in $r/i$. \end{lemma} \begin{proof} let $\mathfrak p$ be a prime of $r$. by lemma \ref{lemma-topology-spec} we have see that the hypotheses of topology, lemma \ref{topology-lemma-connected-component-intersection} are satisfied for the topological space $\spec(r)$. hence the connected component of $\mathfrak p$ in $\spec(r)$ is the intersection of open and closed subsets of $\spec(r)$ containing $\mathfrak p$. hence it equals $v(i)$ where $i$ is generated by the idempotents $e \in r$ such that $e$ maps to $0$ in $\kappa(\mathfrak p)$, see lemma \ref{lemma-disjoint-decomposition}. any idempotent $e$ which is not in this collection clearly maps to $1$ in $r/i$. \end{proof} \section{glueing properties} \label{section-more-glueing} \noindent in this section we put a number of standard results of the form: if something is true for all members of a standard open covering then it is true. in fact, it often suffices to check things on the level of local rings as in the following lemma. \begin{lemma} \label{lemma-characterize-zero-local} let $r$ be a ring. \begin{enumerate} \item for an element $x$ of an $r$-module $m$ the following are equivalent \begin{enumerate} \item $x = 0$, \item $x$ maps to zero in $m_\mathfrak p$ for all $\mathfrak p \in \spec(r)$, \item $x$ maps to zero in $m_{\mathfrak m}$ for all maximal ideals $\mathfrak m$ of $r$. \end{enumerate} in other words, the map $m \to \prod_{\mathfrak m} m_{\mathfrak m}$ is injective. \item given an $r$-module $m$ the following are equivalent \begin{enumerate} \item $m$ is zero, \item $m_{\mathfrak p}$ is zero for all $\mathfrak p \in \spec(r)$, \item $m_{\mathfrak m}$ is zero for all maximal ideals $\mathfrak m$ of $r$. \end{enumerate} \item given a complex $m_1 \to m_2 \to m_3$ of $r$-modules the following are equivalent \begin{enumerate} \item $m_1 \to m_2 \to m_3$ is exact, \item for every prime $\mathfrak p$ of $r$ the localization $m_{1, \mathfrak p} \to m_{2, \mathfrak p} \to m_{3, \mathfrak p}$ is exact, \item for every maximal ideal $\mathfrak m$ of $r$ the localization $m_{1, \mathfrak m} \to m_{2, \mathfrak m} \to m_{3, \mathfrak m}$ is exact. \end{enumerate} \item given a map $f : m \to m'$ of $r$-modules the following are equivalent \begin{enumerate} \item $f$ is injective, \item $f_{\mathfrak p} : m_\mathfrak p \to m'_\mathfrak p$ is injective for all primes $\mathfrak p$ of $r$, \item $f_{\mathfrak m} : m_\mathfrak m \to m'_\mathfrak m$ is injective for all maximal ideals $\mathfrak m$ of $r$. \end{enumerate} \item given a map $f : m \to m'$ of $r$-modules the following are equivalent \begin{enumerate} \item $f$ is surjective, \item $f_{\mathfrak p} : m_\mathfrak p \to m'_\mathfrak p$ is surjective for all primes $\mathfrak p$ of $r$, \item $f_{\mathfrak m} : m_\mathfrak m \to m'_\mathfrak m$ is surjective for all maximal ideals $\mathfrak m$ of $r$. \end{enumerate} \item given a map $f : m \to m'$ of $r$-modules the following are equivalent \begin{enumerate} \item $f$ is bijective, \item $f_{\mathfrak p} : m_\mathfrak p \to m'_\mathfrak p$ is bijective for all primes $\mathfrak p$ of $r$, \item $f_{\mathfrak m} : m_\mathfrak m \to m'_\mathfrak m$ is bijective for all maximal ideals $\mathfrak m$ of $r$. \end{enumerate} \end{enumerate} \end{lemma} \begin{proof} let $x \in m$ as in (1). let $i = \{f \in r \mid fx = 0\}$. it is easy to see that $i$ is an ideal (it is the annihilator of $x$). condition (1)(c) means that for all maximal ideals $\mathfrak m$ there exists an $f \in r \setminus \mathfrak m$ such that $fx =0$. in other words, $v(i)$ does not contain a closed point. by lemma \ref{lemma-zariski-topology} we see $i$ is the unit ideal. hence $x$ is zero, i.e., (1)(a) holds. this proves (1). \medskip\noindent part (2) follows by applying (1) to all elements of $m$ simultaneously. \medskip\noindent proof of (3). let $h$ be the homology of the sequence, i.e., $h = \ker(m_2 \to m_3)/\im(m_1 \to m_2)$. by proposition \ref{proposition-localization-exact} we have that $h_\mathfrak p$ is the homology of the sequence $m_{1, \mathfrak p} \to m_{2, \mathfrak p} \to m_{3, \mathfrak p}$. hence (3) is a consequence of (2). \medskip\noindent parts (4) and (5) are special cases of (3). part (6) follows formally on combining (4) and (5). \end{proof} \begin{lemma} \label{lemma-cover} \begin{slogan} zariski-local properties of modules and algebras \end{slogan} let $r$ be a ring. let $m$ be an $r$-module. let $s$ be an $r$-algebra. suppose that $f_1, \ldots, f_n$ is a finite list of elements of $r$ such that $\bigcup d(f_i) = \spec(r)$, in other words $(f_1, \ldots, f_n) = r$. \begin{enumerate} \item if each $m_{f_i} = 0$ then $m = 0$. \item if each $m_{f_i}$ is a finite $r_{f_i}$-module, then $m$ is a finite $r$-module. \item if each $m_{f_i}$ is a finitely presented $r_{f_i}$-module, then $m$ is a finitely presented $r$-module. \item let $m \to n$ be a map of $r$-modules. if $m_{f_i} \to n_{f_i}$ is an isomorphism for each $i$ then $m \to n$ is an isomorphism. \item let $0 \to m'' \to m \to m' \to 0$ be a complex of $r$-modules. if $0 \to m''_{f_i} \to m_{f_i} \to m'_{f_i} \to 0$ is exact for each $i$, then $0 \to m'' \to m \to m' \to 0$ is exact. \item if each $r_{f_i}$ is noetherian, then $r$ is noetherian. \item if each $s_{f_i}$ is a finite type $r_{f_i}$-algebra, then $s$ is a finite type $r$-algebra. \item if each $s_{f_i}$ is of finite presentation over $r_{f_i}$, then $s$ is a finitely presented $r$-algebra. \end{enumerate} \end{lemma} \begin{proof} we prove each of the parts in turn. \begin{enumerate} \item by proposition \ref{proposition-localize-twice} this implies $m_\mathfrak p = 0$ for all $\mathfrak p \in \spec(r)$, so we conclude by lemma \ref{lemma-characterize-zero-local}. \item for each $i$ take a finite generating set $x_i$ of $m_{f_i}$. without loss of generality, we may assume that the elements of $x_i$ are in the image of the localization map $m \rightarrow m_{f_i}$, so we take a finite set $y_i$ of preimages of the elements of $x_i$ in $m$. let $y$ be the union of these sets. this is still a finite set. consider the obvious $r$-linear map $r^y \rightarrow m$ sending the basis element $e_y$ to $y$. by assumption this map is surjective after localizing at an arbitrary prime ideal $\mathfrak p$ of $r$, so it is surjective by lemma \ref{lemma-characterize-zero-local} and $m$ is finitely generated. \item by (2) we have a short exact sequence $$ 0 \rightarrow k \rightarrow r^n \rightarrow m \rightarrow 0 $$ since localization is an exact functor and $m_{f_i}$ is finitely presented we see that $k_{f_i}$ is finitely generated for all $1 \leq i \leq n$ by lemma \ref{lemma-extension}. by (2) this implies that $k$ is a finite $r$-module and therefore $m$ is finitely presented. \item by proposition \ref{proposition-localize-twice} the assumption implies that the induced morphism on localizations at all prime ideals is an isomorphism, so we conclude by lemma \ref{lemma-characterize-zero-local}. \item by proposition \ref{proposition-localize-twice} the assumption implies that the induced sequence of localizations at all prime ideals is short exact, so we conclude by lemma \ref{lemma-characterize-zero-local}. \item we will show that every ideal of $r$ has a finite generating set: for this, let $i \subset r$ be an arbitrary ideal. by proposition \ref{proposition-localization-exact} each $i_{f_i} \subset r_{f_i}$ is an ideal. these are all finitely generated by assumption, so we conclude by (2). \item for each $i$ take a finite generating set $x_i$ of $s_{f_i}$. without loss of generality, we may assume that the elements of $x_i$ are in the image of the localization map $s \rightarrow s_{f_i}$, so we take a finite set $y_i$ of preimages of the elements of $x_i$ in $s$. let $y$ be the union of these sets. this is still a finite set. consider the algebra homomorphism $r[x_y]_{y \in y} \rightarrow s$ induced by $y$. since it is an algebra homomorphism, the image $t$ is an $r$-submodule of the $r$-module $s$, so we can consider the quotient module $s/t$. by assumption, this is zero if we localize at the $f_i$, so it is zero by (1) and therefore $s$ is an $r$-algebra of finite type. \item by the previous item, there exists a surjective $r$-algebra homomorphism $r[x_1, \ldots, x_n] \rightarrow s$. let $k$ be the kernel of this map. this is an ideal in $r[x_1, \ldots, x_n]$, finitely generated in each localization at $f_i$. since the $f_i$ generate the unit ideal in $r$, they also generate the unit ideal in $r[x_1, \ldots, x_n]$, so an application of (2) finishes the proof. \end{enumerate} \end{proof} \begin{lemma} \label{lemma-cover-upstairs} let $r \to s$ be a ring map. suppose that $g_1, \ldots, g_n$ is a finite list of elements of $s$ such that $\bigcup d(g_i) = \spec(s)$ in other words $(g_1, \ldots, g_n) = s$. \begin{enumerate} \item if each $s_{g_i}$ is of finite type over $r$, then $s$ is of finite type over $r$. \item if each $s_{g_i}$ is of finite presentation over $r$, then $s$ is of finite presentation over $r$. \end{enumerate} \end{lemma} \begin{proof} choose $h_1, \ldots, h_n \in s$ such that $\sum h_i g_i = 1$. \medskip\noindent proof of (1). for each $i$ choose a finite list of elements $x_{i, j} \in s_{g_i}$, $j = 1, \ldots, m_i$ which generate $s_{g_i}$ as an $r$-algebra. write $x_{i, j} = y_{i, j}/g_i^{n_{i, j}}$ for some $y_{i, j} \in s$ and some $n_{i, j} \ge 0$. consider the $r$-subalgebra $s' \subset s$ generated by $g_1, \ldots, g_n$, $h_1, \ldots, h_n$ and $y_{i, j}$, $i = 1, \ldots, n$, $j = 1, \ldots, m_i$. since localization is exact (proposition \ref{proposition-localization-exact}), we see that $s'_{g_i} \to s_{g_i}$ is injective. on the other hand, it is surjective by our choice of $y_{i, j}$. the elements $g_1, \ldots, g_n$ generate the unit ideal in $s'$ as $h_1, \ldots, h_n \in s'$. thus $s' \to s$ viewed as an $s'$-module map is an isomorphism by lemma \ref{lemma-cover}. \medskip\noindent proof of (2). we already know that $s$ is of finite type. write $s = r[x_1, \ldots, x_m]/j$ for some ideal $j$. for each $i$ choose a lift $g'_i \in r[x_1, \ldots, x_m]$ of $g_i$ and we choose a lift $h'_i \in r[x_1, \ldots, x_m]$ of $h_i$. then we see that $$ s_{g_i} = r[x_1, \ldots, x_m, y_i]/(j_i + (1 - y_ig'_i)) $$ where $j_i$ is the ideal of $r[x_1, \ldots, x_m, y_i]$ generated by $j$. small detail omitted. by lemma \ref{lemma-finite-presentation-independent} we may choose a finite list of elements $f_{i, j} \in j$, $j = 1, \ldots, m_i$ such that the images of $f_{i, j}$ in $j_i$ and $1 - y_ig'_i$ generate the ideal $j_i + (1 - y_ig'_i)$. set $$ s' = r[x_1, \ldots, x_m]/\left(\sum h'_ig'_i - 1, f_{i, j}; i = 1, \ldots, n, j = 1, \ldots, m_i\right) $$ there is a surjective $r$-algebra map $s' \to s$. the classes of the elements $g'_1, \ldots, g'_n$ in $s'$ generate the unit ideal and by construction the maps $s'_{g'_i} \to s_{g_i}$ are injective. thus we conclude as in part (1). \end{proof} \section{glueing functions} \label{section-tilde-module-sheaf} \noindent in this section we show that given an open covering $$ \spec(r) = \bigcup\nolimits_{i = 1}^n d(f_i) $$ by standard opens, and given an element $h_i \in r_{f_i}$ for each $i$ such that $h_i = h_j$ as elements of $r_{f_i f_j}$ then there exists a unique $h \in r$ such that the image of $h$ in $r_{f_i}$ is $h_i$. this result can be interpreted in two ways: \begin{enumerate} \item the rule $d(f) \mapsto r_f$ is a sheaf of rings on the standard opens, see sheaves, section \ref{sheaves-section-bases}. \item if we think of elements of $r_f$ as the ``algebraic'' or ``regular'' functions on $d(f)$, then these glue as would continuous, resp.\ differentiable functions on a topological, resp.\ differentiable manifold. \end{enumerate} \begin{lemma} \label{lemma-cover-module} let $r$ be a ring. let $f_1, \ldots, f_n$ be elements of $r$ generating the unit ideal. let $m$ be an $r$-module. the sequence $$ 0 \to m \xrightarrow{\alpha} \bigoplus\nolimits_{i = 1}^n m_{f_i} \xrightarrow{\beta} \bigoplus\nolimits_{i, j = 1}^n m_{f_i f_j} $$ is exact, where $\alpha(m) = (m/1, \ldots, m/1)$ and $\beta(m_1/f_1^{e_1}, \ldots, m_n/f_n^{e_n}) = (m_i/f_i^{e_i} - m_j/f_j^{e_j})_{(i, j)}$. \end{lemma} \begin{proof} it suffices to show that the localization of the sequence at any maximal ideal $\mathfrak m$ is exact, see lemma \ref{lemma-characterize-zero-local}. since $f_1, \ldots, f_n$ generate the unit ideal, there is an $i$ such that $f_i \not \in \mathfrak m$. after renumbering we may assume $i = 1$. note that $(m_{f_i})_\mathfrak m = (m_\mathfrak m)_{f_i}$ and $(m_{f_if_j})_\mathfrak m = (m_\mathfrak m)_{f_if_j}$, see proposition \ref{proposition-localize-twice-module}. in particular $(m_{f_1})_\mathfrak m = m_\mathfrak m$ and $(m_{f_1 f_i})_\mathfrak m = (m_\mathfrak m)_{f_i}$, because $f_1$ is a unit. note that the maps in the sequence are the canonical ones coming from lemma \ref{lemma-universal-property-localization-module} and the identity map on $m$. having said all of this, after replacing $r$ by $r_\mathfrak m$, $m$ by $m_\mathfrak m$, and $f_i$ by their image in $r_\mathfrak m$, and $f_1$ by $1 \in r_\mathfrak m$, we reduce to the case where $f_1 = 1$. \medskip\noindent assume $f_1 = 1$. injectivity of $\alpha$ is now trivial. let $m = (m_i) \in \bigoplus_{i = 1}^n m_{f_i}$ be in the kernel of $\beta$. then $m_1 \in m_{f_1} = m$. moreover, $\beta(m) = 0$ implies that $m_1$ and $m_i$ map to the same element of $m_{f_1f_i} = m_{f_i}$. thus $\alpha(m_1) = m$ and the proof is complete. \end{proof} \begin{lemma} \label{lemma-standard-covering} let $r$ be a ring, and let $f_1, f_2, \ldots f_n\in r$ generate the unit ideal in $r$. then the following sequence is exact: $$ 0 \longrightarrow r \longrightarrow \bigoplus\nolimits_i r_{f_i} \longrightarrow \bigoplus\nolimits_{i, j}r_{f_if_j} $$ where the maps $\alpha : r \longrightarrow \bigoplus_i r_{f_i}$ and $\beta : \bigoplus_i r_{f_i} \longrightarrow \bigoplus_{i, j} r_{f_if_j}$ are defined as $$ \alpha(x) = \left(\frac{x}{1}, \ldots, \frac{x}{1}\right) \text{ and } \beta\left(\frac{x_1}{f_1^{r_1}}, \ldots, \frac{x_n}{f_n^{r_n}}\right) = \left(\frac{x_i}{f_i^{r_i}}-\frac{x_j}{f_j^{r_j}}~\text{in}~r_{f_if_j}\right). $$ \end{lemma} \begin{proof} special case of lemma \ref{lemma-cover-module}. \end{proof} \noindent the following we have already seen above, but we state it explicitly here for convenience. \begin{lemma} \label{lemma-disjoint-implies-product} let $r$ be a ring. if $\spec(r) = u \amalg v$ with both $u$ and $v$ open then $r \cong r_1 \times r_2$ with $u \cong \spec(r_1)$ and $v \cong \spec(r_2)$ via the maps in lemma \ref{lemma-spec-product}. moreover, both $r_1$ and $r_2$ are localizations as well as quotients of the ring $r$. \end{lemma} \begin{proof} by lemma \ref{lemma-disjoint-decomposition} we have $u = d(e)$ and $v = d(1-e)$ for some idempotent $e$. by lemma \ref{lemma-standard-covering} we see that $r \cong r_e \times r_{1 - e}$ (since clearly $r_{e(1-e)} = 0$ so the glueing condition is trivial; of course it is trivial to prove the product decomposition directly in this case). the lemma follows. \end{proof} \begin{lemma} \label{lemma-when-injective-covering} let $r$ be a ring. let $f_1, \ldots, f_n \in r$. let $m$ be an $r$-module. then $m \to \bigoplus m_{f_i}$ is injective if and only if $$ m \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} m, \quad m \longmapsto (f_1m, \ldots, f_nm) $$ is injective. \end{lemma} \begin{proof} the map $m \to \bigoplus m_{f_i}$ is injective if and only if for all $m \in m$ and $e_1, \ldots, e_n \geq 1$ such that $f_i^{e_i}m = 0$, $i = 1, \ldots, n$ we have $m = 0$. this clearly implies the displayed map is injective. conversely, suppose the displayed map is injective and $m \in m$ and $e_1, \ldots, e_n \geq 1$ are such that $f_i^{e_i}m = 0$, $i = 1, \ldots, n$. if $e_i = 1$ for all $i$, then we immediately conclude that $m = 0$ from the injectivity of the displayed map. next, we prove this holds for any such data by induction on $e = \sum e_i$. the base case is $e = n$, and we have just dealt with this. if some $e_i > 1$, then set $m' = f_im$. by induction we see that $m' = 0$. hence we see that $f_i m = 0$, i.e., we may take $e_i = 1$ which decreases $e$ and we win. \end{proof} \noindent the following lemma is better stated and proved in the more general context of flat descent. however, it makes sense to state it here since it fits well with the above. \begin{lemma} \label{lemma-glue-modules} let $r$ be a ring. let $f_1, \ldots, f_n \in r$. suppose we are given the following data: \begin{enumerate} \item for each $i$ an $r_{f_i}$-module $m_i$. \item for each pair $i, j$ an $r_{f_if_j}$-module isomorphism $\psi_{ij} : (m_i)_{f_j} \to (m_j)_{f_i}$. \end{enumerate} which satisfy the ``cocycle condition'' that all the diagrams $$ \xymatrix{ (m_i)_{f_jf_k} \ar[rd]_{\psi_{ij}} \ar[rr]^{\psi_{ik}} & & (m_k)_{f_if_j} \\ & (m_j)_{f_if_k} \ar[ru]_{\psi_{jk}} } $$ commute (for all triples $i, j, k$). given this data define $$ m = \ker\left( \bigoplus\nolimits_{1 \leq i \leq n} m_i \longrightarrow \bigoplus\nolimits_{1 \leq i, j \leq n} (m_i)_{f_j} \right) $$ where $(m_1, \ldots, m_n)$ maps to the element whose $(i, j)$th entry is $m_i/1 - \psi_{ji}(m_j/1)$. then the natural map $m \to m_i$ induces an isomorphism $m_{f_i} \to m_i$. moreover $\psi_{ij}(m/1) = m/1$ for all $m \in m$ (with obvious notation). \end{lemma} \begin{proof} to show that $m_{f_1} \to m_1$ is an isomorphism, it suffices to show that its localization at every prime $\mathfrak p'$ of $r_{f_1}$ is an isomorphism, see lemma \ref{lemma-characterize-zero-local}. write $\mathfrak p' = \mathfrak p r_{f_1}$ for some prime $\mathfrak p \subset r$, $f_1 \not \in \mathfrak p$, see lemma \ref{lemma-standard-open}. since localization is exact (proposition \ref{proposition-localization-exact}), we see that \begin{align*} (m_{f_1})_{\mathfrak p'} & = m_\mathfrak p \\ & = \ker\left( \bigoplus\nolimits_{1 \leq i \leq n} m_{i, \mathfrak p} \longrightarrow \bigoplus\nolimits_{1 \leq i, j \leq n} ((m_i)_{f_j})_\mathfrak p \right) \\ & = \ker\left( \bigoplus\nolimits_{1 \leq i \leq n} m_{i, \mathfrak p} \longrightarrow \bigoplus\nolimits_{1 \leq i, j \leq n} (m_{i, \mathfrak p})_{f_j} \right) \end{align*} here we also used proposition \ref{proposition-localize-twice-module}. since $f_1$ is a unit in $r_\mathfrak p$, this reduces us to the case where $f_1 = 1$ by replacing $r$ by $r_\mathfrak p$, $f_i$ by the image of $f_i$ in $r_\mathfrak p$, $m$ by $m_\mathfrak p$, and $f_1$ by $1$. \medskip\noindent assume $f_1 = 1$. then $\psi_{1j} : (m_1)_{f_j} \to m_j$ is an isomorphism for $j = 2, \ldots, n$. if we use these isomorphisms to identify $m_j = (m_1)_{f_j}$, then we see that $\psi_{ij} : (m_1)_{f_if_j} \to (m_1)_{f_if_j}$ is the canonical identification. thus the complex $$ 0 \to m_1 \to \bigoplus\nolimits_{1 \leq i \leq n} (m_1)_{f_i} \longrightarrow \bigoplus\nolimits_{1 \leq i, j \leq n} (m_1)_{f_if_j} $$ is exact by lemma \ref{lemma-cover-module}. thus the first map identifies $m_1$ with $m$ in this case and everything is clear. \end{proof} \section{zerodivisors and total rings of fractions} \label{section-total-quotient-ring} \noindent the local ring at a minimal prime has the following properties. \begin{lemma} \label{lemma-minimal-prime-reduced-ring} let $\mathfrak p$ be a minimal prime of a ring $r$. every element of the maximal ideal of $r_{\mathfrak p}$ is nilpotent. if $r$ is reduced then $r_{\mathfrak p}$ is a field. \end{lemma} \begin{proof} if some element $x$ of ${\mathfrak p}r_{\mathfrak p}$ is not nilpotent, then $d(x) \not = \emptyset$, see lemma \ref{lemma-zariski-topology}. this contradicts the minimality of $\mathfrak p$. if $r$ is reduced, then ${\mathfrak p}r_{\mathfrak p} = 0$ and hence it is a field. \end{proof} \begin{lemma} \label{lemma-reduced-ring-sub-product-fields} let $r$ be a reduced ring. then \begin{enumerate} \item $r$ is a subring of a product of fields, \item $r \to \prod_{\mathfrak p\text{ minimal}} r_{\mathfrak p}$ is an embedding into a product of fields, \item $\bigcup_{\mathfrak p\text{ minimal}} \mathfrak p$ is the set of zerodivisors of $r$. \end{enumerate} \end{lemma} \begin{proof} by lemma \ref{lemma-minimal-prime-reduced-ring} each of the rings $r_\mathfrak p$ is a field. in particular, the kernel of the ring map $r \to r_\mathfrak p$ is $\mathfrak p$. by lemma \ref{lemma-zariski-topology} we have $\bigcap_{\mathfrak p} \mathfrak p = (0)$. hence (2) and (1) are true. if $x y = 0$ and $y \not = 0$, then $y \not \in \mathfrak p$ for some minimal prime $\mathfrak p$. hence $x \in \mathfrak p$. thus every zerodivisor of $r$ is contained in $\bigcup_{\mathfrak p\text{ minimal}} \mathfrak p$. conversely, suppose that $x \in \mathfrak p$ for some minimal prime $\mathfrak p$. then $x$ maps to zero in $r_\mathfrak p$, hence there exists $y \in r$, $y \not \in \mathfrak p$ such that $xy = 0$. in other words, $x$ is a zerodivisor. this finishes the proof of (3) and the lemma. \end{proof} \noindent the total ring of fractions $q(r)$ of a ring $r$ was introduced in example \ref{example-localize-at-prime}. \begin{lemma} \label{lemma-total-ring-fractions} let $r$ be a ring. let $s \subset r$ be a multiplicative subset consisting of nonzerodivisors. then $q(r) \cong q(s^{-1}r)$. in particular $q(r) \cong q(q(r))$. \end{lemma} \begin{proof} if $x \in s^{-1}r$ is a nonzerodivisor, and $x = r/f$ for some $r \in r$, $f \in s$, then $r$ is a nonzerodivisor in $r$. whence the lemma. \end{proof} \noindent we can apply glueing results to prove something about total rings of fractions $q(r)$ which we introduced in example \ref{example-localize-at-prime}. \begin{lemma} \label{lemma-total-ring-fractions-no-embedded-points} let $r$ be a ring. assume that $r$ has finitely many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$, and that $\mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ is the set of zerodivisors of $r$. then the total ring of fractions $q(r)$ is equal to $r_{\mathfrak q_1} \times \ldots \times r_{\mathfrak q_t}$. \end{lemma} \begin{proof} there are natural maps $q(r) \to r_{\mathfrak q_i}$ since any nonzerodivisor is contained in $r \setminus \mathfrak q_i$. hence a natural map $q(r) \to r_{\mathfrak q_1} \times \ldots \times r_{\mathfrak q_t}$. for any nonminimal prime $\mathfrak p \subset r$ we see that $\mathfrak p \not \subset \mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ by lemma \ref{lemma-silly}. hence $\spec(q(r)) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$ (as subsets of $\spec(r)$, see lemma \ref{lemma-spec-localization}). therefore $\spec(q(r))$ is a finite discrete set and it follows that $q(r) = a_1 \times \ldots \times a_t$ with $\spec(a_i) = \{\mathfrak{q}_i\}$, see lemma \ref{lemma-disjoint-implies-product}. moreover $a_i$ is a local ring, which is a localization of $r$. hence $a_i \cong r_{\mathfrak q_i}$. \end{proof} \section{irreducible components of spectra} \label{section-irreducible} \noindent we show that irreducible components of the spectrum of a ring correspond to the minimal primes in the ring. \begin{lemma} \label{lemma-irreducible} let $r$ be a ring. \begin{enumerate} \item for a prime $\mathfrak p \subset r$ the closure of $\{\mathfrak p\}$ in the zariski topology is $v(\mathfrak p)$. in a formula $\overline{\{\mathfrak p\}} = v(\mathfrak p)$. \item the irreducible closed subsets of $\spec(r)$ are exactly the subsets $v(\mathfrak p)$, with $\mathfrak p \subset r$ a prime. \item the irreducible components (see topology, definition \ref{topology-definition-irreducible-components}) of $\spec(r)$ are exactly the subsets $v(\mathfrak p)$, with $\mathfrak p \subset r$ a minimal prime. \end{enumerate} \end{lemma} \begin{proof} note that if $ \mathfrak p \in v(i)$, then $i \subset \mathfrak p$. hence, clearly $\overline{\{\mathfrak p\}} = v(\mathfrak p)$. in particular $v(\mathfrak p)$ is the closure of a singleton and hence irreducible. the second assertion implies the third. to show the second, let $v(i) \subset \spec(r)$ with $i$ a radical ideal. if $i$ is not prime, then choose $a, b\in r$, $a, b\not \in i$ with $ab\in i$. in this case $v(i, a) \cup v(i, b) = v(i)$, but neither $v(i, b) = v(i)$ nor $v(i, a) = v(i)$, by lemma \ref{lemma-zariski-topology}. hence $v(i)$ is not irreducible. \end{proof} \noindent in other words, this lemma shows that every irreducible closed subset of $\spec(r)$ is of the form $v(\mathfrak p)$ for some prime $\mathfrak p$. since $v(\mathfrak p) = \overline{\{\mathfrak p\}}$ we see that each irreducible closed subset has a unique generic point, see topology, definition \ref{topology-definition-generic-point}. in particular, $\spec(r)$ is a sober topological space. we record this fact in the following lemma. \begin{lemma} \label{lemma-spec-spectral} the spectrum of a ring is a spectral space, see topology, definition \ref{topology-definition-spectral-space}. \end{lemma} \begin{proof} formally this follows from lemma \ref{lemma-irreducible} and lemma \ref{lemma-topology-spec}. see also discussion above. \end{proof} \begin{lemma} \label{lemma-irreducible-components-containing-x} let $r$ be a ring. let $\mathfrak p \subset r$ be a prime. \begin{enumerate} \item the set of irreducible closed subsets of $\spec(r)$ passing through $\mathfrak p$ is in one-to-one correspondence with primes $\mathfrak q \subset r_{\mathfrak p}$. \item the set of irreducible components of $\spec(r)$ passing through $\mathfrak p$ is in one-to-one correspondence with minimal primes $\mathfrak q \subset r_{\mathfrak p}$. \end{enumerate} \end{lemma} \begin{proof} follows from lemma \ref{lemma-irreducible} and the description of $\spec(r_\mathfrak p)$ in lemma \ref{lemma-spec-localization} which shows that $\spec(r_\mathfrak p)$ corresponds to primes $\mathfrak q$ in $r$ with $\mathfrak q \subset \mathfrak p$. \end{proof} \begin{lemma} \label{lemma-standard-open-containing-maximal-point} let $r$ be a ring. let $\mathfrak p$ be a minimal prime of $r$. let $w \subset \spec(r)$ be a quasi-compact open not containing the point $\mathfrak p$. then there exists an $f \in r$, $f \not \in \mathfrak p$ such that $d(f) \cap w = \emptyset$. \end{lemma} \begin{proof} since $w$ is quasi-compact we may write it as a finite union of standard affine opens $d(g_i)$, $i = 1, \ldots, n$. since $\mathfrak p \not \in w$ we have $g_i \in \mathfrak p$ for all $i$. by lemma \ref{lemma-minimal-prime-reduced-ring} each $g_i$ is nilpotent in $r_{\mathfrak p}$. hence we can find an $f \in r$, $f \not \in \mathfrak p$ such that for all $i$ we have $f g_i^{n_i} = 0$ for some $n_i > 0$. then $d(f)$ works. \end{proof} \begin{lemma} \label{lemma-ring-with-only-minimal-primes} let $r$ be a ring. let $x = \spec(r)$ as a topological space. the following are equivalent \begin{enumerate} \item $x$ is profinite, \item $x$ is hausdorff, \item $x$ is totally disconnected. \item every quasi-compact open of $x$ is closed, \item there are no nontrivial inclusions between its prime ideals, \item every prime ideal is a maximal ideal, \item every prime ideal is minimal, \item every standard open $d(f) \subset x$ is closed, and \item add more here. \end{enumerate} \end{lemma} \begin{proof} first proof. it is clear that (5), (6), and (7) are equivalent. it is clear that (4) and (8) are equivalent as every quasi-compact open is a finite union of standard opens. the implication (7) $\rightarrow$ (4) follows from lemma \ref{lemma-standard-open-containing-maximal-point}. assume (4) holds. let $\mathfrak p, \mathfrak p'$ be distinct primes of $r$. choose an $f \in \mathfrak p'$, $f \not \in \mathfrak p$ (if needed switch $\mathfrak p$ with $\mathfrak p'$). then $\mathfrak p' \not \in d(f)$ and $\mathfrak p \in d(f)$. by (4) the open $d(f)$ is also closed. hence $\mathfrak p$ and $\mathfrak p'$ are in disjoint open neighbourhoods whose union is $x$. thus $x$ is hausdorff and totally disconnected. thus (4) $\rightarrow$ (2) and (3). if (3) holds then there cannot be any specializations between points of $\spec(r)$ and we see that (5) holds. if $x$ is hausdorff then every point is closed, so (2) implies (6). thus (2), (3), (4), (5), (6), (7) and (8) are equivalent. any profinite space is hausdorff, so (1) implies (2). if $x$ satisfies (2) and (3), then $x$ (being quasi-compact by lemma \ref{lemma-quasi-compact}) is profinite by topology, lemma \ref{topology-lemma-profinite}. \medskip\noindent second proof. besides the equivalence of (4) and (8) this follows from lemma \ref{lemma-spec-spectral} and purely topological facts, see topology, lemma \ref{topology-lemma-characterize-profinite-spectral}. \end{proof} \section{examples of spectra of rings} \label{section-examples-spectra} \noindent in this section we put some examples of spectra. \begin{example} \label{example-spec-zxmodx2minus4} in this example we describe $x = \spec(\mathbf{z}[x]/(x^2 - 4))$. let $\mathfrak{p}$ be an arbitrary prime in $x$. let $\phi : \mathbf{z} \to \mathbf{z}[x]/(x^2 - 4)$ be the natural ring map. then, $ \phi^{-1}(\mathfrak p)$ is a prime in $\mathbf{z}$. if $ \phi^{-1}(\mathfrak p) = (2)$, then since $\mathfrak p$ contains $2$, it corresponds to a prime ideal in $\mathbf{z}[x]/(x^2 - 4, 2) \cong (\mathbf{z}/2\mathbf{z})[x]/(x^2)$ via the map $ \mathbf{z}[x]/(x^2 - 4) \to \mathbf{z}[x]/(x^2 - 4, 2)$. any prime in $(\mathbf{z}/2\mathbf{z})[x]/(x^2)$ corresponds to a prime in $(\mathbf{z}/2\mathbf{z})[x]$ containing $(x^2)$. such primes will then contain $x$. since $(\mathbf{z}/2\mathbf{z}) \cong (\mathbf{z}/2\mathbf{z})[x]/(x)$ is a field, $(x)$ is a maximal ideal. since any prime contains $(x)$ and $(x)$ is maximal, the ring contains only one prime $(x)$. thus, in this case, $\mathfrak p = (2, x)$. now, if $ \phi^{-1}(\mathfrak p) = (q)$ for $q > 2$, then since $\mathfrak p$ contains $q$, it corresponds to a prime ideal in $\mathbf{z}[x]/(x^2 - 4, q) \cong (\mathbf{z}/q\mathbf{z})[x]/(x^2 - 4)$ via the map $ \mathbf{z}[x]/(x^2 - 4) \to \mathbf{z}[x]/(x^2 - 4, q)$. any prime in $(\mathbf{z}/q\mathbf{z})[x]/(x^2 - 4)$ corresponds to a prime in $(\mathbf{z}/q\mathbf{z})[x]$ containing $(x^2 - 4) = (x -2)(x + 2)$. hence, these primes must contain either $x -2$ or $x + 2$. since $(\mathbf{z}/q\mathbf{z})[x]$ is a pid, all nonzero primes are maximal, and so there are precisely 2 primes in $(\mathbf{z}/q\mathbf{z})[x]$ containing $(x-2)(x + 2)$, namely $(x-2)$ and $(x + 2)$. in conclusion, there exist two primes $(q, x-2)$ and $(q, x + 2)$ since $2 \neq -2 \in \mathbf{z}/(q)$. finally, we treat the case where $\phi^{-1}(\mathfrak p) = (0)$. notice that $\mathfrak p$ corresponds to a prime ideal in $\mathbf{z}[x]$ that contains $(x^2 - 4) = (x -2)(x + 2)$. hence, $\mathfrak p$ contains either $(x-2)$ or $(x + 2)$. hence, $\mathfrak p$ corresponds to a prime in $\mathbf{z}[x]/(x - 2)$ or one in $\mathbf{z}[x]/(x + 2)$ that intersects $\mathbf{z}$ only at $0$, by assumption. since $\mathbf{z}[x]/(x - 2) \cong \mathbf{z}$ and $\mathbf{z}[x]/(x + 2) \cong \mathbf{z}$, this means that $\mathfrak p$ must correspond to $0$ in one of these rings. thus, $\mathfrak p = (x - 2)$ or $\mathfrak p = (x + 2)$ in the original ring. \end{example} \begin{example} \label{example-spec-zx} in this example we describe $x = \spec(\mathbf{z}[x])$. fix $\mathfrak p \in x$. let $\phi : \mathbf{z} \to \mathbf{z}[x]$ and notice that $\phi^{-1}(\mathfrak p) \in \spec(\mathbf{z})$. if $\phi^{-1}(\mathfrak p) = (q)$ for $q$ a prime number $q > 0$, then $\mathfrak p$ corresponds to a prime in $(\mathbf{z}/(q))[x]$, which must be generated by a polynomial that is irreducible in $(\mathbf{z}/(q))[x]$. if we choose a representative of this polynomial with minimal degree, then it will also be irreducible in $\mathbf{z}[x]$. hence, in this case $\mathfrak p = (q, f_q)$ where $f_q$ is an irreducible polynomial in $\mathbf{z}[x]$ that is irreducible when viewed in $(\mathbf{z}/(q) [x])$. now, assume that $\phi^{-1}(\mathfrak p) = (0)$. in this case, $\mathfrak p$ must be generated by nonconstant polynomials which, since $\mathfrak p$ is prime, may be assumed to be irreducible in $\mathbf{z}[x]$. by gauss' lemma, these polynomials are also irreducible in $\mathbf{q}[x]$. since $\mathbf{q}[x]$ is a euclidean domain, if there are at least two distinct irreducibles $f, g$ generating $\mathfrak p$, then $1 = af + bg$ for $a, b \in \mathbf{q}[x]$. multiplying through by a common denominator, we see that $m = \bar{a}f + \bar{b} g$ for $\bar{a}, \bar{b} \in \mathbf{z}[x]$ and nonzero $m \in \mathbf{z}$. this is a contradiction. hence, $\mathfrak p$ is generated by one irreducible polynomial in $\mathbf{z}[x]$. \end{example} \begin{example} \label{example-spec-kxy} in this example we describe $x = \spec(k[x, y])$ when $k$ is an arbitrary field. clearly $(0)$ is prime, and any principal ideal generated by an irreducible polynomial will also be a prime since $k[x, y]$ is a unique factorization domain. now assume $\mathfrak p$ is an element of $x$ that is not principal. since $k[x, y]$ is a noetherian ufd, the prime ideal $\mathfrak p$ can be generated by a finite number of irreducible polynomials $(f_1, \ldots, f_n)$. now, i claim that if $f, g$ are irreducible polynomials in $k[x, y]$ that are not associates, then $(f, g) \cap k[x] \neq 0$. to do this, it is enough to show that $f$ and $g$ are relatively prime when viewed in $k(x)[y]$. in this case, $k(x)[y]$ is a euclidean domain, so by applying the euclidean algorithm and clearing denominators, we obtain $p = af + bg$ for $p, a, b \in k[x]$. thus, assume this is not the case, that is, that some nonunit $h \in k(x)[y]$ divides both $f$ and $g$. then, by gauss's lemma, for some $a, b \in k(x)$ we have $ah | f$ and $bh | g$ for $ah, bh \in k[x]$. by irreducibility, $ah = f$ and $bh = g$ (since $h \notin k(x)$). so, back in $k(x)[y]$, $f, g $ are associates, as $\frac{a}{b} g = f$. since $k(x)$ is the fraction field of $k[x]$, we can write $g = \frac{r}{s} f $ for elements $r , s \in k[x]$ sharing no common factors. this implies that $sg = rf$ in $k[x, y]$ and so $s$ must divide $f$ since $k[x, y]$ is a ufd. hence, $s = 1$ or $s = f$. if $s = f$, then $r = g$, implying $f, g \in k[x]$ and thus must be units in $k(x)$ and relatively prime in $k(x)[y]$, contradicting our hypothesis. if $s = 1$, then $g = rf$, another contradiction. thus, we must have $f, g$ relatively prime in $k(x)[y]$, a euclidean domain. thus, we have reduced to the case $\mathfrak p$ contains some irreducible polynomial $p \in k[x] \subset k[x, y]$. by the above, $\mathfrak p$ corresponds to a prime in the ring $k[x, y]/(p) = k(\alpha)[y]$, where $\alpha$ is an element algebraic over $k$ with minimum polynomial $p$. this is a pid, and so any prime ideal corresponds to $(0)$ or an irreducible polynomial in $k(\alpha)[y]$. thus, $\mathfrak p$ is of the form $(p)$ or $(p, f)$ where $f$ is a polynomial in $k[x, y]$ that is irreducible in the quotient $k[x, y]/(p)$. \end{example} \begin{example} \label{example-affine-open-not-standard} consider the ring $$ r = \{ f \in \mathbf{q}[z]\text{ with }f(0) = f(1) \}. $$ consider the map $$ \varphi : \mathbf{q}[a, b] \to r $$ defined by $\varphi(a) = z^2-z$ and $\varphi(b) = z^3-z^2$. it is easily checked that $(a^3 - b^2 + ab) \subset \ker(\varphi)$ and that $a^3 - b^2 + ab$ is irreducible. assume that $\varphi$ is surjective; then since $r$ is an integral domain (it is a subring of an integral domain), $\ker(\varphi)$ must be a prime ideal of $\mathbf{q}[a, b]$. the prime ideals which contain $(a^3-b^2 + ab)$ are $(a^3-b^2 + ab)$ itself and any maximal ideal $(f, g)$ with $f, g\in\mathbf{q}[a, b]$ such that $f$ is irreducible mod $g$. but $r$ is not a field, so the kernel must be $(a^3-b^2 + ab)$; hence $\varphi$ gives an isomorphism $r \to \mathbf{q}[a, b]/(a^3-b^2 + ab)$. \medskip\noindent to see that $\varphi$ is surjective, we must express any $f\in r$ as a $\mathbf{q}$-coefficient polynomial in $a(z) = z^2-z$ and $b(z) = z^3-z^2$. note the relation $za(z) = b(z)$. let $a = f(0) = f(1)$. then $z(z-1)$ must divide $f(z)-a$, so we can write $f(z) = z(z-1)g(z)+a = a(z)g(z)+a$. if $\deg(g) < 2$, then $h(z) = c_1z + c_0$ and $f(z) = a(z)(c_1z + c_0)+a = c_1b(z)+c_0a(z)+a$, so we are done. if $\deg(g)\geq 2$, then by the polynomial division algorithm, we can write $g(z) = a(z)h(z)+b_1z + b_0$ ($\deg(h)\leq\deg(g)-2$), so $f(z) = a(z)^2h(z)+b_1b(z)+b_0a(z)$. applying division to $h(z)$ and iterating, we obtain an expression for $f(z)$ as a polynomial in $a(z)$ and $b(z)$; hence $\varphi$ is surjective. \medskip\noindent now let $a \in \mathbf{q}$, $a \neq 0, \frac{1}{2}, 1$ and consider $$ r_a = \{ f \in \mathbf{q}[z, \frac{1}{z-a}]\text{ with }f(0) = f(1) \}. $$ this is a finitely generated $\mathbf{q}$-algebra as well: it is easy to check that the functions $z^2-z$, $z^3-z$, and $\frac{a^2-a}{z-a}+z$ generate $r_a$ as an $\mathbf{q}$-algebra. we have the following inclusions: $$ r\subset r_a\subset\mathbf{q}[z, \frac{1}{z-a}], \quad r\subset\mathbf{q}[z]\subset\mathbf{q}[z, \frac{1}{z-a}]. $$ recall (lemma \ref{lemma-spec-localization}) that for a ring t and a multiplicative subset $s\subset t$, the ring map $t \to s^{-1}t$ induces a map on spectra $\spec(s^{-1}t) \to \spec(t)$ which is a homeomorphism onto the subset $$ \{\mathfrak p \in \spec(t) \mid s \cap \mathfrak p = \emptyset\} \subset \spec(t). $$ when $s = \{ 1, f, f^2, \ldots\}$ for some $f\in t$, this is the open set $d(f)\subset t$. we now verify a corresponding property for the ring map $r \to r_a$: we will show that the map $\theta : \spec(r_a) \to \spec(r)$ induced by inclusion $r\subset r_a$ is a homeomorphism onto an open subset of $\spec(r)$ by verifying that $\theta$ is an injective local homeomorphism. we do so with respect to an open cover of $\spec(r_a)$ by two distinguished opens, as we now describe. for any $r\in\mathbf{q}$, let $\text{ev}_r : r \to \mathbf{q}$ be the homomorphism given by evaluation at $r$. note that for $r = 0$ and $r = 1-a$, this can be extended to a homomorphism $\text{ev}_r' : r_a \to \mathbf{q}$ (the latter because $\frac{1}{z-a}$ is well-defined at $z = 1-a$, since $a\neq\frac{1}{2}$). however, $\text{ev}_a$ does not extend to $r_a$. write $\mathfrak{m}_r = \ker(\text{ev}_r)$. we have $$ \mathfrak{m}_0 = (z^2-z, z^3-z), $$ $$ \mathfrak{m}_a = ((z-1 + a)(z-a), (z^2-1 + a)(z-a)), \text{ and} $$ $$ \mathfrak{m}_{1-a} = ((z-1 + a)(z-a), (z-1 + a)(z^2-a)). $$ to verify this, note that the right-hand sides are clearly contained in the left-hand sides. then check that the right-hand sides are maximal ideals by writing the generators in terms of $a$ and $b$, and viewing $r$ as $\mathbf{q}[a, b]/(a^3-b^2 + ab)$. note that $\mathfrak{m}_a$ is not in the image of $\theta$: we have $$ (z^2 - z)^2(z - a)\left(\frac{a^2 - a}{z - a} + z\right) = (z^2 - z)^2(a^2 - a) + (z^2 - z)^2(z - a)z $$ the left hand side is in $\mathfrak m_a r_a$ because $(z^2 - z)(z - a)$ is in $\mathfrak m_a$ and because $(z^2 - z)(\frac{a^2 - a}{z - a} + z)$ is in $r_a$. similarly the element $(z^2 - z)^2(z - a)z$ is in $\mathfrak m_a r_a$ because $(z^2 - z)$ is in $r_a$ and $(z^2 - z)(z - a)$ is in $\mathfrak m_a$. as $a \not \in \{0, 1\}$ we conclude that $(z^2 - z)^2 \in \mathfrak m_a r_a$. hence no ideal $i$ of $r_a$ can satisfy $i \cap r = \mathfrak m_a$, as such an $i$ would have to contain $(z^2 - z)^2$, which is in $r$ but not in $\mathfrak m_a$. the distinguished open set $d((z-1 + a)(z-a))\subset\spec(r)$ is equal to the complement of the closed set $\{\mathfrak{m}_a, \mathfrak{m}_{1-a}\}$. then check that $r_{(z-1 + a)(z-a)} = (r_a)_{(z-1 + a)(z-a)}$; calling this localized ring $r'$, then, it follows that the map $r \to r'$ factors as $r \to r_a \to r'$. by lemma \ref{lemma-spec-localization}, then, these maps express $\spec(r') \subset \spec(r_a)$ and $\spec(r') \subset \spec(r)$ as open subsets; hence $\theta : \spec(r_a) \to \spec(r)$, when restricted to $d((z-1 + a)(z-a))$, is a homeomorphism onto an open subset. similarly, $\theta$ restricted to $d((z^2 + z + 2a-2)(z-a)) \subset \spec(r_a)$ is a homeomorphism onto the open subset $d((z^2 + z + 2a-2)(z-a)) \subset \spec(r)$. depending on whether $z^2 + z + 2a-2$ is irreducible or not over $\mathbf{q}$, this former distinguished open set has complement equal to one or two closed points along with the closed point $\mathfrak{m}_a$. furthermore, the ideal in $r_a$ generated by the elements $(z^2 + z + 2a-a)(z-a)$ and $(z-1 + a)(z-a)$ is all of $r_a$, so these two distinguished open sets cover $\spec(r_a)$. hence in order to show that $\theta$ is a homeomorphism onto $\spec(r)-\{\mathfrak{m}_a\}$, it suffices to show that these one or two points can never equal $\mathfrak{m}_{1-a}$. and this is indeed the case, since $1-a$ is a root of $z^2 + z + 2a-2$ if and only if $a = 0$ or $a = 1$, both of which do not occur. \medskip\noindent despite this homeomorphism which mimics the behavior of a localization at an element of $r$, while $\mathbf{q}[z, \frac{1}{z-a}]$ is the localization of $\mathbf{q}[z]$ at the maximal ideal $(z-a)$, the ring $r_a$ is {\it not} a localization of $r$: any localization $s^{-1}r$ results in more units than the original ring $r$. the units of $r$ are $\mathbf{q}^\times$, the units of $\mathbf{q}$. in fact, it is easy to see that the units of $r_a$ are $\mathbf{q}^*$. namely, the units of $\mathbf{q}[z, \frac{1}{z - a}]$ are $c (z - a)^n$ for $c \in \mathbf{q}^*$ and $n \in \mathbf{z}$ and it is clear that these are in $r_a$ only if $n = 0$. hence $r_a$ has no more units than $r$ does, and thus cannot be a localization of $r$. \medskip\noindent we used the fact that $a\neq 0, 1$ to ensure that $\frac{1}{z-a}$ makes sense at $z = 0, 1$. we used the fact that $a\neq 1/2$ in a few places: (1) in order to be able to talk about the kernel of $\text{ev}_{1-a}$ on $r_a$, which ensures that $\mathfrak{m}_{1-a}$ is a point of $r_a$ (i.e., that $r_a$ is missing just one point of $r$). (2) at the end in order to conclude that $(z-a)^{k + \ell}$ can only be in $r$ for $k = \ell = 0$; indeed, if $a = 1/2$, then this is in $r$ as long as $k + \ell$ is even. hence there would indeed be more units in $r_a$ than in $r$, and $r_a$ could possibly be a localization of $r$. \end{example} \section{a meta-observation about prime ideals} \label{section-oka-families} \noindent this section is taken from the cring project. let $r$ be a ring and let $s \subset r$ be a multiplicative subset. a consequence of lemma \ref{lemma-spec-localization} is that an ideal $i \subset r$ maximal with respect to the property of not intersecting $s$ is prime. the reason is that $i = r \cap \mathfrak m$ for some maximal ideal $\mathfrak m$ of the ring $s^{-1}r$. it turns out that for many properties of ideals, the maximal ones are prime. a general method of seeing this was developed in \cite{lam-reyes}. in this section, we digress to explain this phenomenon. \medskip\noindent let $r$ be a ring. if $i$ is an ideal of $r$ and $a \in r$, we define $$ (i : a) = \left\{ x \in r \mid xa \in i\right\}. $$ more generally, if $j \subset r$ is an ideal, we define $$ (i : j) = \left\{ x \in r \mid xj \subset i\right\}. $$ \begin{lemma} \label{lemma-colon} let $r$ be a ring. for a principal ideal $j \subset r$, and for any ideal $i \subset j$ we have $i = j (i : j)$. \end{lemma} \begin{proof} say $j = (a)$. then $(i : j) = (i : a)$. since $i \subset j$ we see that any $y \in i$ is of the form $y = xa$ for some $x \in (i : a)$. hence $i \subset j (i : j)$. conversely, if $x \in (i : a)$, then $xj = (xa) \subset i$, which proves the other inclusion. \end{proof} \noindent let $\mathcal{f}$ be a collection of ideals of $r$. we are interested in conditions that will guarantee that the maximal elements in the complement of $\mathcal{f}$ are prime. \begin{definition} \label{definition-oka-family} let $r$ be a ring. let $\mathcal{f}$ be a set of ideals of $r$. we say $\mathcal{f}$ is an {\it oka family} if $r \in \mathcal{f}$ and whenever $i \subset r$ is an ideal and $(i : a), (i, a) \in \mathcal{f}$ for some $a \in r$, then $i \in \mathcal{f}$. \end{definition} \noindent let us give some examples of oka families. the first example is the basic example discussed in the introduction to this section. \begin{example} \label{example-oka-family-not-meet-multiplicative-set} let $r$ be a ring and let $s$ be a multiplicative subset of $r$. we claim that $\mathcal{f} = \{i \subset r \mid i \cap s \not = \emptyset\}$ is an oka family. namely, suppose that $(i : a), (i, a) \in \mathcal{f}$ for some $a \in r$. then pick $s \in (i, a) \cap s$ and $s' \in (i : a) \cap s$. then $ss' \in i \cap s$ and hence $i \in \mathcal{f}$. thus $\mathcal{f}$ is an oka family. \end{example} \begin{example} \label{example-oka-family-finitely-generated} let $r$ be a ring, $i \subset r$ an ideal, and $a \in r$. if $(i : a)$ is generated by $a_1, \ldots, a_n$ and $(i, a)$ is generated by $a, b_1, \ldots, b_m$ with $b_1, \ldots, b_m \in i$, then $i$ is generated by $aa_1, \ldots, aa_n, b_1, \ldots, b_m$. to see this, note that if $x \in i$, then $x \in (i, a)$ is a linear combination of $a, b_1, \ldots, b_m$, but the coefficient of $a$ must lie in $(i:a)$. as a result, we deduce that the family of finitely generated ideals is an oka family. \end{example} \begin{example} \label{example-oka-family-principal} let us show that the family of principal ideals of a ring $r$ is an oka family. indeed, suppose $i \subset r$ is an ideal, $a \in r$, and $(i, a)$ and $(i : a)$ are principal. note that $(i : a) = (i : (i, a))$. setting $j = (i, a)$, we find that $j$ is principal and $(i : j)$ is too. by lemma \ref{lemma-colon} we have $i = j (i : j)$. thus we find in our situation that since $j = (i, a)$ and $(i : j)$ are principal, $i$ is principal. \end{example} \begin{example} \label{example-oka-family-bound-cardinality} let $r$ be a ring. let $\kappa$ be an infinite cardinal. the family of ideals which can be generated by at most $\kappa$ elements is an oka family. the argument is analogous to the argument in example \ref{example-oka-family-finitely-generated} and is omitted. \end{example} \begin{example} \label{example-oka-family-property-modules} let $a$ be a ring, $i \subset a$ an ideal, and $a \in a$ an element. there is a short exact sequence $0 \to a/(i : a) \to a/i \to a/(i, a) \to 0$ where the first arrow is given by multiplication by $a$. thus if $p$ is a property of $a$-modules that is stable under extensions and holds for $0$, then the family of ideals $i$ such that $a/i$ has $p$ is an oka family. \end{example} \begin{proposition} \label{proposition-oka} if $\mathcal{f}$ is an oka family of ideals, then any maximal element of the complement of $\mathcal{f}$ is prime. \end{proposition} \begin{proof} suppose $i \not \in \mathcal{f}$ is maximal with respect to not being in $\mathcal{f}$ but $i$ is not prime. note that $i \not = r$ because $r \in \mathcal{f}$. since $i$ is not prime we can find $a, b \in r - i$ with $ab \in i$. it follows that $(i, a) \neq i$ and $(i : a)$ contains $b \not \in i$ so also $(i : a) \neq i$. thus $(i : a), (i, a)$ both strictly contain $i$, so they must belong to $\mathcal{f}$. by the oka condition, we have $i \in \mathcal{f}$, a contradiction. \end{proof} \noindent at this point we are able to turn most of the examples above into a lemma about prime ideals in a ring. \begin{lemma} \label{lemma-simple} let $r$ be a ring. let $s$ be a multiplicative subset of $r$. an ideal $i \subset r$ which is maximal with respect to the property that $i \cap s = \emptyset$ is prime. \end{lemma} \begin{proof} this is the example discussed in the introduction to this section. for an alternative proof, combine example \ref{example-oka-family-not-meet-multiplicative-set} with proposition \ref{proposition-oka}. \end{proof} \begin{lemma} \label{lemma-cohen} let $r$ be a ring. \begin{enumerate} \item an ideal $i \subset r$ maximal with respect to not being finitely generated is prime. \item if every prime ideal of $r$ is finitely generated, then every ideal of $r$ is finitely generated\footnote{later we will say that $r$ is noetherian.}. \end{enumerate} \end{lemma} \begin{proof} the first assertion is an immediate consequence of example \ref{example-oka-family-finitely-generated} and proposition \ref{proposition-oka}. for the second, suppose that there exists an ideal $i \subset r$ which is not finitely generated. the union of a totally ordered chain $\left\{i_\alpha\right\}$ of ideals that are not finitely generated is not finitely generated; indeed, if $i = \bigcup i_\alpha$ were generated by $a_1, \ldots, a_n$, then all the generators would belong to some $i_\alpha $ and would consequently generate it. by zorn's lemma, there is an ideal maximal with respect to being not finitely generated. by the first part this ideal is prime. \end{proof} \begin{lemma} \label{lemma-primes-principal} let $r$ be a ring. \begin{enumerate} \item an ideal $i \subset r$ maximal with respect to not being principal is prime. \item if every prime ideal of $r$ is principal, then every ideal of $r$ is principal. \end{enumerate} \end{lemma} \begin{proof} the first part follows from example \ref{example-oka-family-principal} and proposition \ref{proposition-oka}. for the second, suppose that there exists an ideal $i \subset r$ which is not principal. the union of a totally ordered chain $\left\{i_\alpha\right\}$ of ideals that not principal is not principal; indeed, if $i = \bigcup i_\alpha$ were generated by $a$, then $a$ would belong to some $i_\alpha $ and $a$ would generate it. by zorn's lemma, there is an ideal maximal with respect to not being principal. this ideal is necessarily prime by the first part. \end{proof} \begin{lemma} \label{lemma-characterize-domain} let $r$ be a ring. \begin{enumerate} \item an ideal maximal among the ideals which do not contain a nonzerodivisor is prime. \item if $r$ is nonzero and every nonzero prime ideal in $r$ contains a nonzerodivisor, then $r$ is a domain. \end{enumerate} \end{lemma} \begin{proof} consider the set $s$ of nonzerodivisors. it is a multiplicative subset of $r$. hence any ideal maximal with respect to not intersecting $s$ is prime, see lemma \ref{lemma-simple}. thus, if every nonzero prime ideal contains a nonzerodivisor, then $(0)$ is prime, i.e., $r$ is a domain. \end{proof} \begin{remark} \label{remark-cohen-bound-cardinality} let $r$ be a ring. let $\kappa$ be an infinite cardinal. by applying example \ref{example-oka-family-bound-cardinality} and proposition \ref{proposition-oka} we see that any ideal maximal with respect to the property of not being generated by $\kappa$ elements is prime. this result is not so useful because there exists a ring for which every prime ideal of $r$ can be generated by $\aleph_0$ elements, but some ideal cannot. namely, let $k$ be a field, let $t$ be a set whose cardinality is greater than $\aleph_0$ and let $$ r = k[\{x_n\}_{n \geq 1}, \{z_{t, n}\}_{t \in t, n \geq 0}]/ (x_n^2, z_{t, n}^2, x_n z_{t, n} - z_{t, n - 1}) $$ this is a local ring with unique prime ideal $\mathfrak m = (x_n)$. but the ideal $(z_{t, n})$ cannot be generated by countably many elements. \end{remark} \begin{example} \label{example-noetherian-topology-on-spec} \begin{reference} comment by lukas heger of november 12, 2020. \end{reference} let $r$ be a ring and $x = \spec(r)$. since closed subsets of $x$ correspond to radical ideas of $r$ (lemma \ref{lemma-zariski-topology}) we see that $x$ is a noetherian topological space if and only if we have acc for radical ideals. this holds if and only if every radical ideal is the radical of a finitely generated ideal (details omitted). let $$ \mathcal{f} = \{i \subset r \mid \sqrt{i} = \sqrt{(f_1, \ldots, f_n)}\text{ for some }n \text{ and }f_1, \ldots, f_n \in r\}. $$ the reader can show that $\mathcal{f}$ is an oka family by using the identity $$ \sqrt{i} = \sqrt{(i, a)(i : a)} $$ which holds for any ideal $i \subset r$ and any element $a \in r$. on the other hand, if we have a totally ordered chain of ideals $\{i_\alpha\}$ none of which are in $\mathcal{f}$, then the union $i = \bigcup i_\alpha$ cannot be in $\mathcal{f}$ either. otherwise $\sqrt{i} = \sqrt{(f_1, \ldots, f_n)}$, then $f_i^e \in i$ for some $e$, then $f_i^e \in i_\alpha$ for some $\alpha$ independent of $i$, then $\sqrt{i_\alpha} = \sqrt{(f_1, \ldots, f_n)}$, contradiction. thus if the set of ideals not in $\mathcal{f}$ is nonempty, then it has maximal elements and exactly as in lemma \ref{lemma-cohen} we conclude that $x$ is a noetherian topological space if and only if every prime ideal of $r$ is equal to $\sqrt{(f_1, \ldots, f_n)}$ for some $f_1, \ldots, f_n \in r$. if we ever need this result we will carefully state and prove this result here. \end{example} \section{images of ring maps of finite presentation} \label{section-images-finite-presentation} \noindent in this section we prove some results on the topology of maps $\spec(s) \to \spec(r)$ induced by ring maps $r \to s$, mainly chevalley's theorem. in order to do this we will use the notions of constructible sets, quasi-compact sets, retrocompact sets, and so on which are defined in topology, section \ref{topology-section-constructible}. \begin{lemma} \label{lemma-qc-open} let $u \subset \spec(r)$ be open. the following are equivalent: \begin{enumerate} \item $u$ is retrocompact in $\spec(r)$, \item $u$ is quasi-compact, \item $u$ is a finite union of standard opens, and \item there exists a finitely generated ideal $i \subset r$ such that $x \setminus v(i) = u$. \end{enumerate} \end{lemma} \begin{proof} we have (1) $\rightarrow$ (2) because $\spec(r)$ is quasi-compact, see lemma \ref{lemma-quasi-compact}. we have (2) $\rightarrow$ (3) because standard opens form a basis for the topology. proof of (3) $\rightarrow$ (1). let $u = \bigcup_{i = 1\ldots n} d(f_i)$. to show that $u$ is retrocompact in $\spec(r)$ it suffices to show that $u \cap v$ is quasi-compact for any quasi-compact open $v$ of $\spec(r)$. write $v = \bigcup_{j = 1\ldots m} d(g_j)$ which is possible by (2) $\rightarrow$ (3). each standard open is homeomorphic to the spectrum of a ring and hence quasi-compact, see lemmas \ref{lemma-standard-open} and \ref{lemma-quasi-compact}. thus $u \cap v = (\bigcup_{i = 1\ldots n} d(f_i)) \cap (\bigcup_{j = 1\ldots m} d(g_j)) = \bigcup_{i, j} d(f_i g_j)$ is a finite union of quasi-compact opens hence quasi-compact. to finish the proof note that (4) is equivalent to (3) by lemma \ref{lemma-zariski-topology}. \end{proof} \begin{lemma} \label{lemma-affine-map-quasi-compact} let $\varphi : r \to s$ be a ring map. the induced continuous map $f : \spec(s) \to \spec(r)$ is quasi-compact. for any constructible set $e \subset \spec(r)$ the inverse image $f^{-1}(e)$ is constructible in $\spec(s)$. \end{lemma} \begin{proof} we first show that the inverse image of any quasi-compact open $u \subset \spec(r)$ is quasi-compact. by lemma \ref{lemma-qc-open} we may write $u$ as a finite open of standard opens. thus by lemma \ref{lemma-spec-functorial} we see that $f^{-1}(u)$ is a finite union of standard opens. hence $f^{-1}(u)$ is quasi-compact by lemma \ref{lemma-qc-open} again. the second assertion now follows from topology, lemma \ref{topology-lemma-inverse-images-constructibles}. \end{proof} \begin{lemma} \label{lemma-constructible} let $r$ be a ring. a subset of $\spec(r)$ is constructible if and only if it can be written as a finite union of subsets of the form $d(f) \cap v(g_1, \ldots, g_m)$ for $f, g_1, \ldots, g_m \in r$. \end{lemma} \begin{proof} by lemma \ref{lemma-qc-open} the subset $d(f)$ and the complement of $v(g_1, \ldots, g_m)$ are retro-compact open. hence $d(f) \cap v(g_1, \ldots, g_m)$ is a constructible subset and so is any finite union of such. conversely, let $t \subset \spec(r)$ be constructible. by topology, definition \ref{topology-definition-constructible}, we may assume that $t = u \cap v^c$, where $u, v \subset \spec(r)$ are retrocompact open. by lemma \ref{lemma-qc-open} we may write $u = \bigcup_{i = 1, \ldots, n} d(f_i)$ and $v = \bigcup_{j = 1, \ldots, m} d(g_j)$. then $t = \bigcup_{i = 1, \ldots, n} \big(d(f_i) \cap v(g_1, \ldots, g_m)\big)$. \end{proof} \begin{lemma} \label{lemma-constructible-is-image} let $r$ be a ring and let $t \subset \spec(r)$ be constructible. then there exists a ring map $r \to s$ of finite presentation such that $t$ is the image of $\spec(s)$ in $\spec(r)$. \end{lemma} \begin{proof} the spectrum of a finite product of rings is the disjoint union of the spectra, see lemma \ref{lemma-spec-product}. hence if $t = t_1 \cup t_2$ and the result holds for $t_1$ and $t_2$, then the result holds for $t$. by lemma \ref{lemma-constructible} we may assume that $t = d(f) \cap v(g_1, \ldots, g_m)$. in this case $t$ is the image of the map $\spec((r/(g_1, \ldots, g_m))_f) \to \spec(r)$, see lemmas \ref{lemma-standard-open} and \ref{lemma-spec-closed}. \end{proof} \begin{lemma} \label{lemma-open-fp} let $r$ be a ring. let $f$ be an element of $r$. let $s = r_f$. then the image of a constructible subset of $\spec(s)$ is constructible in $\spec(r)$. \end{lemma} \begin{proof} we repeatedly use lemma \ref{lemma-qc-open} without mention. let $u, v$ be quasi-compact open in $\spec(s)$. we will show that the image of $u \cap v^c$ is constructible. under the identification $\spec(s) = d(f)$ of lemma \ref{lemma-standard-open} the sets $u, v$ correspond to quasi-compact opens $u', v'$ of $\spec(r)$. hence it suffices to show that $u' \cap (v')^c$ is constructible in $\spec(r)$ which is clear. \end{proof} \begin{lemma} \label{lemma-closed-fp} let $r$ be a ring. let $i$ be a finitely generated ideal of $r$. let $s = r/i$. then the image of a constructible subset of $\spec(s)$ is constructible in $\spec(r)$. \end{lemma} \begin{proof} if $i = (f_1, \ldots, f_m)$, then we see that $v(i)$ is the complement of $\bigcup d(f_i)$, see lemma \ref{lemma-zariski-topology}. hence it is constructible, by lemma \ref{lemma-qc-open}. denote the map $r \to s$ by $f \mapsto \overline{f}$. we have to show that if $\overline{u}, \overline{v}$ are retrocompact opens of $\spec(s)$, then the image of $\overline{u} \cap \overline{v}^c$ in $\spec(r)$ is constructible. by lemma \ref{lemma-qc-open} we may write $\overline{u} = \bigcup d(\overline{g_i})$. setting $u = \bigcup d({g_i})$ we see $\overline{u}$ has image $u \cap v(i)$ which is constructible in $\spec(r)$. similarly the image of $\overline{v}$ equals $v \cap v(i)$ for some retrocompact open $v$ of $\spec(r)$. hence the image of $\overline{u} \cap \overline{v}^c$ equals $u \cap v(i) \cap v^c$ as desired. \end{proof} \begin{lemma} \label{lemma-affineline-open} let $r$ be a ring. the map $\spec(r[x]) \to \spec(r)$ is open, and the image of any standard open is a quasi-compact open. \end{lemma} \begin{proof} it suffices to show that the image of a standard open $d(f)$, $f\in r[x]$ is quasi-compact open. the image of $d(f)$ is the image of $\spec(r[x]_f) \to \spec(r)$. let $\mathfrak p \subset r$ be a prime ideal. let $\overline{f}$ be the image of $f$ in $\kappa(\mathfrak p)[x]$. recall, see lemma \ref{lemma-in-image}, that $\mathfrak p$ is in the image if and only if $r[x]_f \otimes_r \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]_{\overline{f}}$ is not the zero ring. this is exactly the condition that $f$ does not map to zero in $\kappa(\mathfrak p)[x]$, in other words, that some coefficient of $f$ is not in $\mathfrak p$. hence we see: if $f = a_d x^d + \ldots + a_0$, then the image of $d(f)$ is $d(a_d) \cup \ldots \cup d(a_0)$. \end{proof} \noindent we prove a property of characteristic polynomials which will be used below. \begin{lemma} \label{lemma-characteristic-polynomial-prime} let $r \to a$ be a ring homomorphism. assume $a \cong r^{\oplus n}$ as an $r$-module. let $f \in a$. the multiplication map $m_f: a \to a$ is $r$-linear and hence has a characteristic polynomial $p(t) = t^n + r_{n-1}t^{n-1} + \ldots + r_0 \in r[t]$. for any prime $\mathfrak{p} \in \spec(r)$, $f$ acts nilpotently on $a \otimes_r \kappa(\mathfrak{p})$ if and only if $\mathfrak p \in v(r_0, \ldots, r_{n-1})$. \end{lemma} \begin{proof} this follows quite easily once we prove that the characteristic polynomial $\bar p(t) \in \kappa(\mathfrak p)[t]$ of the multiplication map $m_{\bar f}: a \otimes_r \kappa(\mathfrak p) \to a \otimes_r \kappa(\mathfrak p)$ which multiplies elements of $a \otimes_r \kappa(\mathfrak p)$ by $\bar f$, the image of $f$ viewed in $\kappa(\mathfrak p)$, is just the image of $p(t)$ in $\kappa(\mathfrak p)[t]$. let $(a_{ij})$ be the matrix of the map $m_f$ with entries in $r$, using a basis $e_1, \ldots, e_n$ of $a$ as an $r$-module. then, $a \otimes_r \kappa(\mathfrak p) \cong (r \otimes_r \kappa(\mathfrak p))^{\oplus n} = \kappa(\mathfrak p)^n$, which is an $n$-dimensional vector space over $\kappa(\mathfrak p)$ with basis $e_1 \otimes 1, \ldots, e_n \otimes 1$. the image $\bar f = f \otimes 1$, and so the multiplication map $m_{\bar f}$ has matrix $(a_{ij} \otimes 1)$. thus, the characteristic polynomial is precisely the image of $p(t)$. \medskip\noindent from linear algebra, we know that a linear transformation acts nilpotently on an $n$-dimensional vector space if and only if the characteristic polynomial is $t^n$ (since the characteristic polynomial divides some power of the minimal polynomial). hence, $f$ acts nilpotently on $a \otimes_r \kappa(\mathfrak p)$ if and only if $\bar p(t) = t^n$. this occurs if and only if $r_i \in \mathfrak p$ for all $0 \leq i \leq n - 1$, that is when $\mathfrak p \in v(r_0, \ldots, r_{n - 1}).$ \end{proof} \begin{lemma} \label{lemma-affineline-special} let $r$ be a ring. let $f, g \in r[x]$ be polynomials. assume the leading coefficient of $g$ is a unit of $r$. there exists elements $r_i\in r$, $i = 1\ldots, n$ such that the image of $d(f) \cap v(g)$ in $\spec(r)$ is $\bigcup_{i = 1, \ldots, n} d(r_i)$. \end{lemma} \begin{proof} write $g = ux^d + a_{d-1}x^{d-1} + \ldots + a_0$, where $d$ is the degree of $g$, and hence $u \in r^*$. consider the ring $a = r[x]/(g)$. it is, as an $r$-module, finite free with basis the images of $1, x, \ldots, x^{d-1}$. consider multiplication by (the image of) $f$ on $a$. this is an $r$-module map. hence we can let $p(t) \in r[t]$ be the characteristic polynomial of this map. write $p(t) = t^d + r_{d-1} t^{d-1} + \ldots + r_0$. we claim that $r_0, \ldots, r_{d-1}$ have the desired property. we will use below the property of characteristic polynomials that $$ \mathfrak p \in v(r_0, \ldots, r_{d-1}) \leftrightarrow \text{multiplication by }f\text{ is nilpotent on } a \otimes_r \kappa(\mathfrak p). $$ this was proved in lemma \ref{lemma-characteristic-polynomial-prime}. \medskip\noindent suppose $\mathfrak q\in d(f) \cap v(g)$, and let $\mathfrak p = \mathfrak q \cap r$. then there is a nonzero map $a \otimes_r \kappa(\mathfrak p) \to \kappa(\mathfrak q)$ which is compatible with multiplication by $f$. and $f$ acts as a unit on $\kappa(\mathfrak q)$. thus we conclude $\mathfrak p \not \in v(r_0, \ldots, r_{d-1})$. \medskip\noindent on the other hand, suppose that $r_i \not\in \mathfrak p$ for some prime $\mathfrak p$ of $r$ and some $0 \leq i \leq d - 1$. then multiplication by $f$ is not nilpotent on the algebra $a \otimes_r \kappa(\mathfrak p)$. hence there exists a prime ideal $\overline{\mathfrak q} \subset a \otimes_r \kappa(\mathfrak p)$ not containing the image of $f$. the inverse image of $\overline{\mathfrak q}$ in $r[x]$ is an element of $d(f) \cap v(g)$ mapping to $\mathfrak p$. \end{proof} \begin{theorem}[chevalley's theorem] \label{theorem-chevalley} suppose that $r \to s$ is of finite presentation. the image of a constructible subset of $\spec(s)$ in $\spec(r)$ is constructible. \end{theorem} \begin{proof} write $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$. we may factor $r \to s$ as $r \to r[x_1] \to r[x_1, x_2] \to \ldots \to r[x_1, \ldots, x_{n-1}] \to s$. hence we may assume that $s = r[x]/(f_1, \ldots, f_m)$. in this case we factor the map as $r \to r[x] \to s$, and by lemma \ref{lemma-closed-fp} we reduce to the case $s = r[x]$. by lemma \ref{lemma-qc-open} suffices to show that if $t = (\bigcup_{i = 1\ldots n} d(f_i)) \cap v(g_1, \ldots, g_m)$ for $f_i , g_j \in r[x]$ then the image in $\spec(r)$ is constructible. since finite unions of constructible sets are constructible, it suffices to deal with the case $n = 1$, i.e., when $t = d(f) \cap v(g_1, \ldots, g_m)$. \medskip\noindent note that if $c \in r$, then we have $$ \spec(r) = v(c) \amalg d(c) = \spec(r/(c)) \amalg \spec(r_c), $$ and correspondingly $\spec(r[x]) = v(c) \amalg d(c) = \spec(r/(c)[x]) \amalg \spec(r_c[x])$. the intersection of $t = d(f) \cap v(g_1, \ldots, g_m)$ with each part still has the same shape, with $f$, $g_i$ replaced by their images in $r/(c)[x]$, respectively $r_c[x]$. note that the image of $t$ in $\spec(r)$ is the union of the image of $t \cap v(c)$ and $t \cap d(c)$. using lemmas \ref{lemma-open-fp} and \ref{lemma-closed-fp} it suffices to prove the images of both parts are constructible in $\spec(r/(c))$, respectively $\spec(r_c)$. \medskip\noindent let us assume we have $t = d(f) \cap v(g_1, \ldots, g_m)$ as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$. we are going to use induction on $m$, and on the degrees of the $g_i$. let $d_1 = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$ with $c \in r$ not zero. cutting $r$ up into the pieces $r/(c)$ and $r_c$ we either lower the degree of $g_1$ (and this is covered by induction) or we reduce to the case where $c$ is invertible. if $c$ is invertible, and $m > 1$, then write $g_2 = c' x^{d_2} + l.o.t$. in this case consider $g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. since the ideals $(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$ are equal we see that $t = d(f) \cap v(g_1, g_2', g_3\ldots, g_m)$. but here the degree of $g_2'$ is strictly less than the degree of $g_2$ and hence this case is covered by induction. \medskip\noindent the bases case for the induction above are the cases (a) $t = d(f) \cap v(g)$ where the leading coefficient of $g$ is invertible, and (b) $t = d(f)$. these two cases are dealt with in lemmas \ref{lemma-affineline-special} and \ref{lemma-affineline-open}. \end{proof} \section{more on images} \label{section-more-images} \noindent in this section we collect a few additional lemmas concerning the image on $\spec$ for ring maps. see also section \ref{section-going-up} for example. \begin{lemma} \label{lemma-generic-finite-presentation} let $r \subset s$ be an inclusion of domains. assume that $r \to s$ is of finite type. there exists a nonzero $f \in r$, and a nonzero $g \in s$ such that $r_f \to s_{fg}$ is of finite presentation. \end{lemma} \begin{proof} by induction on the number of generators of $s$ over $r$. during the proof we may replace $r$ by $r_f$ and $s$ by $s_f$ for some nonzero $f \in r$. \medskip\noindent suppose that $s$ is generated by a single element over $r$. then $s = r[x]/\mathfrak q$ for some prime ideal $\mathfrak q \subset r[x]$. if $\mathfrak q = (0)$ there is nothing to prove. if $\mathfrak q \not = (0)$, then let $h \in \mathfrak q$ be a nonzero element with minimal degree in $x$. write $h = f x^d + a_{d - 1} x^{d - 1} + \ldots + a_0$ with $a_i \in r$ and $f \not = 0$. after inverting $f$ in $r$ and $s$ we may assume that $h$ is monic. we obtain a surjective $r$-algebra map $r[x]/(h) \to s$. we have $r[x]/(h) = r \oplus rx \oplus \ldots \oplus rx^{d - 1}$ as an $r$-module and by minimality of $d$ we see that $r[x]/(h)$ maps injectively into $s$. thus $r[x]/(h) \cong s$ is finitely presented over $r$. \medskip\noindent suppose that $s$ is generated by $n > 1$ elements over $r$. say $x_1, \ldots, x_n \in s$ generate $s$. denote $s' \subset s$ the $r$-subalgebra generated by $x_1, \ldots, x_{n-1}$. by induction hypothesis we see that there exist $f\in r$ and $g \in s'$ nonzero such that $r_f \to s'_{fg}$ is of finite presentation. next we apply the induction hypothesis to $s'_{fg} \to s_{fg}$ to see that there exist $f' \in s'_{fg}$ and $g' \in s_{fg}$ such that $s'_{fgf'} \to s_{fgf'g'}$ is of finite presentation. we leave it to the reader to conclude. \end{proof} \begin{lemma} \label{lemma-characterize-image-finite-type} let $r \to s$ be a finite type ring map. denote $x = \spec(r)$ and $y = \spec(s)$. write $f : y \to x$ the induced map of spectra. let $e \subset y = \spec(s)$ be a constructible set. if a point $\xi \in x$ is in $f(e)$, then $\overline{\{\xi\}} \cap f(e)$ contains an open dense subset of $\overline{\{\xi\}}$. \end{lemma} \begin{proof} let $\xi \in x$ be a point of $f(e)$. choose a point $\eta \in e$ mapping to $\xi$. let $\mathfrak p \subset r$ be the prime corresponding to $\xi$ and let $\mathfrak q \subset s$ be the prime corresponding to $\eta$. consider the diagram $$ \xymatrix{ \eta \ar[r] \ar@{|->}[d] & e \cap y' \ar[r] \ar[d] & y' = \spec(s/\mathfrak q) \ar[r] \ar[d] & y \ar[d] \\ \xi \ar[r] & f(e) \cap x' \ar[r] & x' = \spec(r/\mathfrak p) \ar[r] & x } $$ by lemma \ref{lemma-affine-map-quasi-compact} the set $e \cap y'$ is constructible in $y'$. it follows that we may replace $x$ by $x'$ and $y$ by $y'$. hence we may assume that $r \subset s$ is an inclusion of domains, $\xi$ is the generic point of $x$, and $\eta$ is the generic point of $y$. by lemma \ref{lemma-generic-finite-presentation} combined with chevalley's theorem (theorem \ref{theorem-chevalley}) we see that there exist dense opens $u \subset x$, $v \subset y$ such that $f(v) \subset u$ and such that $f : v \to u$ maps constructible sets to constructible sets. note that $e \cap v$ is constructible in $v$, see topology, lemma \ref{topology-lemma-open-immersion-constructible-inverse-image}. hence $f(e \cap v)$ is constructible in $u$ and contains $\xi$. by topology, lemma \ref{topology-lemma-generic-point-in-constructible} we see that $f(e \cap v)$ contains a dense open $u' \subset u$. \end{proof} \noindent at the end of this section we present a few more results on images of maps on spectra that have nothing to do with constructible sets. \begin{lemma} \label{lemma-surjective-spec-radical-ideal} let $\varphi : r \to s$ be a ring map. the following are equivalent: \begin{enumerate} \item the map $\spec(s) \to \spec(r)$ is surjective. \item for any ideal $i \subset r$ the inverse image of $\sqrt{is}$ in $r$ is equal to $\sqrt{i}$. \item for any radical ideal $i \subset r$ the inverse image of $is$ in $r$ is equal to $i$. \item for every prime $\mathfrak p$ of $r$ the inverse image of $\mathfrak p s$ in $r$ is $\mathfrak p$. \end{enumerate} in this case the same is true after any base change: given a ring map $r \to r'$ the ring map $r' \to r' \otimes_r s$ has the equivalent properties (1), (2), (3) as well. \end{lemma} \begin{proof} if $j \subset s$ is an ideal, then $\sqrt{\varphi^{-1}(j)} = \varphi^{-1}(\sqrt{j})$. this shows that (2) and (3) are equivalent. the implication (3) $\rightarrow$ (4) is immediate. if $i \subset r$ is a radical ideal, then lemma \ref{lemma-zariski-topology} guarantees that $i = \bigcap_{i \subset \mathfrak p} \mathfrak p$. hence (4) $\rightarrow$ (2). by lemma \ref{lemma-in-image} we have $\mathfrak p = \varphi^{-1}(\mathfrak p s)$ if and only if $\mathfrak p$ is in the image. hence (1) $\leftrightarrow$ (4). thus (1), (2), (3), and (4) are equivalent. \medskip\noindent assume (1) holds. let $r \to r'$ be a ring map. let $\mathfrak p' \subset r'$ be a prime ideal lying over the prime $\mathfrak p$ of $r$. to see that $\mathfrak p'$ is in the image of $\spec(r' \otimes_r s) \to \spec(r')$ we have to show that $(r' \otimes_r s) \otimes_{r'} \kappa(\mathfrak p')$ is not zero, see lemma \ref{lemma-in-image}. but we have $$ (r' \otimes_r s) \otimes_{r'} \kappa(\mathfrak p') = s \otimes_r \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p') $$ which is not zero as $s \otimes_r \kappa(\mathfrak p)$ is not zero by assumption and $\kappa(\mathfrak p) \to \kappa(\mathfrak p')$ is an extension of fields. \end{proof} \begin{lemma} \label{lemma-domain-image-dense-set-points-generic-point} let $r$ be a domain. let $\varphi : r \to s$ be a ring map. the following are equivalent: \begin{enumerate} \item the ring map $r \to s$ is injective. \item the image $\spec(s) \to \spec(r)$ contains a dense set of points. \item there exists a prime ideal $\mathfrak q \subset s$ whose inverse image in $r$ is $(0)$. \end{enumerate} \end{lemma} \begin{proof} let $k$ be the field of fractions of the domain $r$. assume that $r \to s$ is injective. since localization is exact we see that $k \to s \otimes_r k$ is injective. hence there is a prime mapping to $(0)$ by lemma \ref{lemma-in-image}. \medskip\noindent note that $(0)$ is dense in $\spec(r)$, so that the last condition implies the second. \medskip\noindent suppose the second condition holds. let $f \in r$, $f \not = 0$. as $r$ is a domain we see that $v(f)$ is a proper closed subset of $r$. by assumption there exists a prime $\mathfrak q$ of $s$ such that $\varphi(f) \not \in \mathfrak q$. hence $\varphi(f) \not = 0$. hence $r \to s$ is injective. \end{proof} \begin{lemma} \label{lemma-injective-minimal-primes-in-image} let $r \subset s$ be an injective ring map. then $\spec(s) \to \spec(r)$ hits all the minimal primes. \end{lemma} \begin{proof} let $\mathfrak p \subset r$ be a minimal prime. in this case $r_{\mathfrak p}$ has a unique prime ideal. hence it suffices to show that $s_{\mathfrak p}$ is not zero. and this follows from the fact that localization is exact, see proposition \ref{proposition-localization-exact}. \end{proof} \begin{lemma} \label{lemma-image-dense-generic-points} let $r \to s$ be a ring map. the following are equivalent: \begin{enumerate} \item the kernel of $r \to s$ consists of nilpotent elements. \item the minimal primes of $r$ are in the image of $\spec(s) \to \spec(r)$. \item the image of $\spec(s) \to \spec(r)$ is dense in $\spec(r)$. \end{enumerate} \end{lemma} \begin{proof} let $i = \ker(r \to s)$. note that $\sqrt{(0)} = \bigcap_{\mathfrak q \subset s} \mathfrak q$, see lemma \ref{lemma-zariski-topology}. hence $\sqrt{i} = \bigcap_{\mathfrak q \subset s} r \cap \mathfrak q$. thus $v(i) = v(\sqrt{i})$ is the closure of the image of $\spec(s) \to \spec(r)$. this shows that (1) is equivalent to (3). it is clear that (2) implies (3). finally, assume (1). we may replace $r$ by $r/i$ and $s$ by $s/is$ without affecting the topology of the spectra and the map. hence the implication (1) $\rightarrow$ (2) follows from lemma \ref{lemma-injective-minimal-primes-in-image}. \end{proof} \begin{lemma} \label{lemma-minimal-prime-image-minimal-prime} let $r \to s$ be a ring map. if a minimal prime $\mathfrak p \subset r$ is in the image of $\spec(s) \to \spec(r)$, then it is the image of a minimal prime. \end{lemma} \begin{proof} say $\mathfrak p = \mathfrak q \cap r$. then choose a minimal prime $\mathfrak r \subset s$ with $\mathfrak r \subset \mathfrak q$, see lemma \ref{lemma-zariski-topology}. by minimality of $\mathfrak p$ we see that $\mathfrak p = \mathfrak r \cap r$. \end{proof} \begin{lemma} \label{lemma-intersection-not-zero} let $a \subset b$ be an inclusion of domains induces an algebraic extension of fraction fields. if $j \subset b$ is a nonzero ideal, then $a \cap j$ is nonzero too. thus the image of a proper closed subset of $\spec(b)$ is not dense in $\spec(a)$. \end{lemma} \begin{proof} let $x \in j$ be a nonzero element. since $x$ is algebraic over the fraction field of $a$, there exists a $d \geq 1$ and $a_0, \ldots, a_d \in a$ with $a_0, a_d \not = 0$ such that $a_d x^d + a_{d - 1} x^{d - 1} + \ldots + a_0 = 0$ in $b$. then $a_0 \in i$. \end{proof} \section{noetherian rings} \label{section-noetherian} \noindent a ring $r$ is {\it noetherian} if any ideal of $r$ is finitely generated. this is clearly equivalent to the ascending chain condition for ideals of $r$. by lemma \ref{lemma-cohen} it suffices to check that every prime ideal of $r$ is finitely generated. \begin{lemma} \label{lemma-noetherian-permanence} \begin{slogan} noetherian property is stable by passage to finite type extension and localization. \end{slogan} any finitely generated ring over a noetherian ring is noetherian. any localization of a noetherian ring is noetherian. \end{lemma} \begin{proof} the statement on localizations follows from the fact that any ideal $j \subset s^{-1}r$ is of the form $i \cdot s^{-1}r$. any quotient $r/i$ of a noetherian ring $r$ is noetherian because any ideal $\overline{j} \subset r/i$ is of the form $j/i$ for some ideal $i \subset j \subset r$. thus it suffices to show that if $r$ is noetherian so is $r[x]$. suppose $j_1 \subset j_2 \subset \ldots$ is an ascending chain of ideals in $r[x]$. consider the ideals $i_{i, d}$ defined as the ideal of elements of $r$ which occur as leading coefficients of degree $d$ polynomials in $j_i$. clearly $i_{i, d} \subset i_{i', d'}$ whenever $i \leq i'$ and $d \leq d'$. by the ascending chain condition in $r$ there are at most finitely many distinct ideals among all of the $i_{i, d}$. (hint: any infinite set of elements of $\mathbf{n} \times \mathbf{n}$ contains an increasing infinite sequence.) take $i_0$ so large that $i_{i, d} = i_{i_0, d}$ for all $i \geq i_0$ and all $d$. suppose $f \in j_i$ for some $i \geq i_0$. by induction on the degree $d = \deg(f)$ we show that $f \in j_{i_0}$. namely, there exists a $g\in j_{i_0}$ whose degree is $d$ and which has the same leading coefficient as $f$. by induction $f - g \in j_{i_0}$ and we win. \end{proof} \begin{lemma} \label{lemma-noetherian-power-series} if $r$ is a noetherian ring, then so is the formal power series ring $r[[x_1, \ldots, x_n]]$. \end{lemma} \begin{proof} since $r[[x_1, \ldots, x_{n + 1}]] \cong r[[x_1, \ldots, x_n]][[x_{n + 1}]]$ it suffices to prove the statement that $r[[x]]$ is noetherian if $r$ is noetherian. let $i \subset r[[x]]$ be an ideal. we have to show that $i$ is a finitely generated ideal. for each integer $d$ denote $i_d = \{a \in r \mid ax^d + \text{h.o.t.} \in i\}$. then we see that $i_0 \subset i_1 \subset \ldots$ stabilizes as $r$ is noetherian. choose $d_0$ such that $i_{d_0} = i_{d_0 + 1} = \ldots$. for each $d \leq d_0$ choose elements $f_{d, j} \in i \cap (x^d)$, $j = 1, \ldots, n_d$ such that if we write $f_{d, j} = a_{d, j}x^d + \text{h.o.t}$ then $i_d = (a_{d, j})$. denote $i' = (\{f_{d, j}\}_{d = 0, \ldots, d_0, j = 1, \ldots, n_d})$. then it is clear that $i' \subset i$. pick $f \in i$. first we may choose $c_{d, i} \in r$ such that $$ f - \sum c_{d, i} f_{d, i} \in (x^{d_0 + 1}) \cap i. $$ next, we can choose $c_{i, 1} \in r$, $i = 1, \ldots, n_{d_0}$ such that $$ f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i} \in (x^{d_0 + 2}) \cap i. $$ next, we can choose $c_{i, 2} \in r$, $i = 1, \ldots, n_{d_0}$ such that $$ f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i} - \sum c_{i, 2}x^2f_{d_0, i} \in (x^{d_0 + 3}) \cap i. $$ and so on. in the end we see that $$ f = \sum c_{d, i} f_{d, i} + \sum\nolimits_i (\sum\nolimits_e c_{i, e} x^e)f_{d_0, i} $$ is contained in $i'$ as desired. \end{proof} \noindent the following lemma, although easy, is useful because finite type $\mathbf{z}$-algebras come up quite often in a technique called ``absolute noetherian reduction''. \begin{lemma} \label{lemma-obvious-noetherian} any finite type algebra over a field is noetherian. any finite type algebra over $\mathbf{z}$ is noetherian. \end{lemma} \begin{proof} this is immediate from lemma \ref{lemma-noetherian-permanence} and the fact that fields are noetherian rings and that $\mathbf{z}$ is noetherian ring (because it is a principal ideal domain). \end{proof} \begin{lemma} \label{lemma-noetherian-finite-type-is-finite-presentation} let $r$ be a noetherian ring. \begin{enumerate} \item any finite $r$-module is of finite presentation. \item any submodule of a finite $r$-module is finite. \item any finite type $r$-algebra is of finite presentation over $r$. \end{enumerate} \end{lemma} \begin{proof} let $m$ be a finite $r$-module. by lemma \ref{lemma-trivial-filter-finite-module} we can find a finite filtration of $m$ whose successive quotients are of the form $r/i$. since any ideal is finitely generated, each of the quotients $r/i$ is finitely presented. hence $m$ is finitely presented by lemma \ref{lemma-extension}. this proves (1). \medskip\noindent let $n \subset m$ be a submodule. as $m$ is finite, the quotient $m/n$ is finite. thus $m/n$ is of finite presentation by part (1). thus we see that $n$ is finite by lemma \ref{lemma-extension} part (5). this proves part (2). \medskip\noindent to see (3) note that any ideal of $r[x_1, \ldots, x_n]$ is finitely generated by lemma \ref{lemma-noetherian-permanence}. \end{proof} \begin{lemma} \label{lemma-noetherian-topology} if $r$ is a noetherian ring then $\spec(r)$ is a noetherian topological space, see topology, definition \ref{topology-definition-noetherian}. \end{lemma} \begin{proof} this is because any closed subset of $\spec(r)$ is uniquely of the form $v(i)$ with $i$ a radical ideal, see lemma \ref{lemma-zariski-topology}. and this correspondence is inclusion reversing. thus the result follows from the definitions. \end{proof} \begin{lemma} \label{lemma-noetherian-irreducible-components} \begin{slogan} a noetherian affine scheme has finitely many generic points. \end{slogan} if $r$ is a noetherian ring then $\spec(r)$ has finitely many irreducible components. in other words $r$ has finitely many minimal primes. \end{lemma} \begin{proof} by lemma \ref{lemma-noetherian-topology} and topology, lemma \ref{topology-lemma-noetherian} we see there are finitely many irreducible components. by lemma \ref{lemma-irreducible} these correspond to minimal primes of $r$. \end{proof} \begin{lemma} \label{lemma-noetherian-base-change-finite-type} let $r \to s$ be a ring map. let $r \to r'$ be of finite type. if $s$ is noetherian, then the base change $s' = r' \otimes_r s$ is noetherian. \end{lemma} \begin{proof} by lemma \ref{lemma-base-change-finiteness} finite type is stable under base change. thus $s \to s'$ is of finite type. since $s$ is noetherian we can apply lemma \ref{lemma-noetherian-permanence}. \end{proof} \begin{lemma} \label{lemma-noetherian-field-extension} let $k$ be a field and let $r$ be a noetherian $k$-algebra. if $k/k$ is a finitely generated field extension then $k \otimes_k r$ is noetherian. \end{lemma} \begin{proof} since $k/k$ is a finitely generated field extension, there exists a finitely generated $k$-algebra $b \subset k$ such that $k$ is the fraction field of $b$. in other words, $k = s^{-1}b$ with $s = b \setminus \{0\}$. then $k \otimes_k r = s^{-1}(b \otimes_k r)$. then $b \otimes_k r$ is noetherian by lemma \ref{lemma-noetherian-base-change-finite-type}. finally, $k \otimes_k r = s^{-1}(b \otimes_k r)$ is noetherian by lemma \ref{lemma-noetherian-permanence}. \end{proof} \noindent here are some fun lemmas that are sometimes useful. \begin{lemma} \label{lemma-subring-of-local-ring} let $r$ be a ring and $\mathfrak p \subset r$ be a prime. there exists an $f \in r$, $f \not \in \mathfrak p$ such that $r_f \to r_\mathfrak p$ is injective in each of the following cases \begin{enumerate} \item $r$ is a domain, \item $r$ is noetherian, or \item $r$ is reduced and has finitely many minimal primes. \end{enumerate} \end{lemma} \begin{proof} if $r$ is a domain, then $r \subset r_\mathfrak p$, hence $f = 1$ works. if $r$ is noetherian, then the kernel $i$ of $r \to r_\mathfrak p$ is a finitely generated ideal and we can find $f \in r$, $f \not \in \mathfrak p$ such that $ir_f = 0$. for this $f$ the map $r_f \to r_\mathfrak p$ is injective and $f$ works. if $r$ is reduced with finitely many minimal primes $\mathfrak p_1, \ldots, \mathfrak p_n$, then we can choose $f \in \bigcap_{\mathfrak p_i \not \subset \mathfrak p} \mathfrak p_i$, $f \not \in \mathfrak p$. indeed, if $\mathfrak{p}_i\not\subset \mathfrak{p}$ then there exist $f_i \in \mathfrak{p}_i$, $f_i \not\in \mathfrak{p}$ and $f = \prod f_i$ works. for this $f$ we have $r_f \subset r_\mathfrak p$ because the minimal primes of $r_f$ correspond to minimal primes of $r_\mathfrak p$ and we can apply lemma \ref{lemma-reduced-ring-sub-product-fields} (some details omitted). \end{proof} \begin{lemma} \label{lemma-surjective-endo-noetherian-ring-is-iso} any surjective endomorphism of a noetherian ring is an isomorphism. \end{lemma} \begin{proof} if $f : r \to r$ were such an endomorphism but not injective, then $$ \ker(f) \subset \ker(f \circ f) \subset \ker(f \circ f \circ f) \subset \ldots $$ would be a strictly increasing chain of ideals. \end{proof} \section{locally nilpotent ideals} \label{section-locally-nilpotent} \noindent here is the definition. \begin{definition} \label{definition-locally-nilpotent-ideal} let $r$ be a ring. let $i \subset r$ be an ideal. we say $i$ is {\it locally nilpotent} if for every $x \in i$ there exists an $n \in \mathbf{n}$ such that $x^n = 0$. we say $i$ is {\it nilpotent} if there exists an $n \in \mathbf{n}$ such that $i^n = 0$. \end{definition} \begin{example} \label{example-locally-nilpotent-not-nilpotent} let $r = k[x_n | n \in \mathbf{n}]$ be the polynomial ring in infinitely many variables over a field $k$. let $i$ be the ideal generated by the elements $x_n^n$ for $n \in \mathbf{n}$ and $s = r/i$. then the ideal $j \subset s$ generated by the images of $x_n$, $n \in \mathbf{n}$ is locally nilpotent, but not nilpotent. indeed, since $s$-linear combinations of nilpotents are nilpotent, to prove that $j$ is locally nilpotent it is enough to observe that all its generators are nilpotent (which they obviously are). on the other hand, for each $n \in \mathbf{n}$ it holds that $x_{n + 1}^n \not \in i$, so that $j^n \not = 0$. it follows that $j$ is not nilpotent. \end{example} \begin{lemma} \label{lemma-locally-nilpotent} let $r \to r'$ be a ring map and let $i \subset r$ be a locally nilpotent ideal. then $ir'$ is a locally nilpotent ideal of $r'$. \end{lemma} \begin{proof} this follows from the fact that if $x, y \in r'$ are nilpotent, then $x + y$ is nilpotent too. namely, if $x^n = 0$ and $y^m = 0$, then $(x + y)^{n + m - 1} = 0$. \end{proof} \begin{lemma} \label{lemma-locally-nilpotent-unit} let $r$ be a ring and let $i \subset r$ be a locally nilpotent ideal. an element $x$ of $r$ is a unit if and only if the image of $x$ in $r/i$ is a unit. \end{lemma} \begin{proof} if $x$ is a unit in $r$, then its image is clearly a unit in $r/i$. it remains to prove the converse. assume the image of $y \in r$ in $r/i$ is the inverse of the image of $x$. then $xy = 1 - z$ for some $z \in i$. this means that $1\equiv z$ modulo $xr$. since $z$ lies in the locally nilpotent ideal $i$, we have $z^n = 0$ for some sufficiently large $n$. it follows that $1 = 1^n \equiv z^n = 0$ modulo $xr$. in other words, $x$ divides $1$ and is hence a unit. \end{proof} \begin{lemma} \label{lemma-noetherian-power} \begin{slogan} an ideal in a noetherian ring is nilpotent if each element of the ideal is nilpotent. \end{slogan} let $r$ be a noetherian ring. let $i, j$ be ideals of $r$. suppose $j \subset \sqrt{i}$. then $j^n \subset i$ for some $n$. in particular, in a noetherian ring the notions of ``locally nilpotent ideal'' and ``nilpotent ideal'' coincide. \end{lemma} \begin{proof} say $j = (f_1, \ldots, f_s)$. by assumption $f_i^{d_i} \in i$. take $n = d_1 + d_2 + \ldots + d_s + 1$. \end{proof} \begin{lemma} \label{lemma-lift-idempotents} let $r$ be a ring. let $i \subset r$ be a locally nilpotent ideal. then $r \to r/i$ induces a bijection on idempotents. \end{lemma} \begin{proof}[first proof of lemma \ref{lemma-lift-idempotents}] as $i$ is locally nilpotent it is contained in every prime ideal. hence $\spec(r/i) = v(i) = \spec(r)$. hence the lemma follows from lemma \ref{lemma-disjoint-decomposition}. \end{proof} \begin{proof}[second proof of lemma \ref{lemma-lift-idempotents}] suppose $\overline{e} \in r/i$ is an idempotent. we have to lift $\overline{e}$ to an idempotent of $r$. \medskip\noindent first, choose any lift $f \in r$ of $\overline{e}$, and set $x = f^2 - f$. then, $x \in i$, so $x$ is nilpotent (since $i$ is locally nilpotent). let now $j$ be the ideal of $r$ generated by $x$. then, $j$ is nilpotent (not just locally nilpotent), since it is generated by the nilpotent $x$. \medskip\noindent now, assume that we have found a lift $e \in r$ of $\overline{e}$ such that $e^2 - e \in j^k$ for some $k \geq 1$. let $e' = e - (2e - 1)(e^2 - e) = 3e^2 - 2e^3$, which is another lift of $\overline{e}$ (since the idempotency of $\overline{e}$ yields $e^2 - e \in i$). then $$ (e')^2 - e' = (4e^2 - 4e - 3)(e^2 - e)^2 \in j^{2k} $$ by a simple computation. \medskip\noindent we thus have started with a lift $e$ of $\overline{e}$ such that $e^2 - e \in j^k$, and obtained a lift $e'$ of $\overline{e}$ such that $(e')^2 - e' \in j^{2k}$. this way we can successively improve the approximation (starting with $e = f$, which fits the bill for $k = 1$). eventually, we reach a stage where $j^k = 0$, and at that stage we have a lift $e$ of $\overline{e}$ such that $e^2 - e \in j^k = 0$, that is, this $e$ is idempotent. \medskip\noindent we thus have seen that if $\overline{e} \in r/i$ is any idempotent, then there exists a lift of $\overline{e}$ which is an idempotent of $r$. it remains to prove that this lift is unique. indeed, let $e_1$ and $e_2$ be two such lifts. we need to show that $e_1 = e_2$. \medskip\noindent by definition of $e_1$ and $e_2$, we have $e_1 \equiv e_2 \mod i$, and both $e_1$ and $e_2$ are idempotent. from $e_1 \equiv e_2 \mod i$, we see that $e_1 - e_2 \in i$, so that $e_1 - e_2$ is nilpotent (since $i$ is locally nilpotent). a straightforward computation (using the idempotency of $e_1$ and $e_2$) reveals that $(e_1 - e_2)^3 = e_1 - e_2$. using this and induction, we obtain $(e_1 - e_2)^k = e_1 - e_2$ for any positive odd integer $k$. since all high enough $k$ satisfy $(e_1 - e_2)^k = 0$ (since $e_1 - e_2$ is nilpotent), this shows $e_1 - e_2 = 0$, so that $e_1 = e_2$, which completes our proof. \end{proof} \begin{lemma} \label{lemma-lift-idempotents-noncommutative} let $a$ be a possibly noncommutative algebra. let $e \in a$ be an element such that $x = e^2 - e$ is nilpotent. then there exists an idempotent of the form $e' = e + x(\sum a_{i, j}e^ix^j) \in a$ with $a_{i, j} \in \mathbf{z}$. \end{lemma} \begin{proof} consider the ring $r_n = \mathbf{z}[e]/((e^2 - e)^n)$. it is clear that if we can prove the result for each $r_n$ then the lemma follows. in $r_n$ consider the ideal $i = (e^2 - e)$ and apply lemma \ref{lemma-lift-idempotents}. \end{proof} \begin{lemma} \label{lemma-lift-nth-roots} let $r$ be a ring. let $i \subset r$ be a locally nilpotent ideal. let $n \geq 1$ be an integer which is invertible in $r/i$. then \begin{enumerate} \item the $n$th power map $1 + i \to 1 + i$, $1 + x \mapsto (1 + x)^n$ is a bijection, \item a unit of $r$ is a $n$th power if and only if its image in $r/i$ is an $n$th power. \end{enumerate} \end{lemma} \begin{proof} let $a \in r$ be a unit whose image in $r/i$ is the same as the image of $b^n$ with $b \in r$. then $b$ is a unit (lemma \ref{lemma-locally-nilpotent-unit}) and $ab^{-n} = 1 + x$ for some $x \in i$. hence $ab^{-n} = c^n$ by part (1). thus (2) follows from (1). \medskip\noindent proof of (1). this is true because there is an inverse to the map $1 + x \mapsto (1 + x)^n$. namely, we can consider the map which sends $1 + x$ to \begin{align*} (1 + x)^{1/n} & = 1 + {1/n \choose 1}x + {1/n \choose 2}x^2 + {1/n \choose 3}x^3 + \ldots \\ & = 1 + \frac{1}{n} x + \frac{1 - n}{2n^2}x^2 + \frac{(1 - n)(1 - 2n)}{6n^3}x^3 + \ldots \end{align*} as in elementary calculus. this makes sense because the series is finite as $x^k = 0$ for all $k \gg 0$ and each coefficient ${1/n \choose k} \in \mathbf{z}[1/n]$ (details omitted; observe that $n$ is invertible in $r$ by lemma \ref{lemma-locally-nilpotent-unit}). \end{proof} \section{curiosity} \label{section-curiosity} \noindent lemma \ref{lemma-disjoint-implies-product} explains what happens if $v(i)$ is open for some ideal $i \subset r$. but what if $\spec(s^{-1}r)$ is closed in $\spec(r)$? the next two lemmas give a partial answer. for more information see section \ref{section-pure-ideals}. \begin{lemma} \label{lemma-invert-closed-quotient} let $r$ be a ring. let $s \subset r$ be a multiplicative subset. assume the image of the map $\spec(s^{-1}r) \to \spec(r)$ is closed. then $s^{-1}r \cong r/i$ for some ideal $i \subset r$. \end{lemma} \begin{proof} let $i = \ker(r \to s^{-1}r)$ so that $v(i)$ contains the image. say the image is the closed subset $v(i') \subset \spec(r)$ for some ideal $i' \subset r$. so $v(i') \subset v(i)$. for $f \in i'$ we see that $f/1 \in s^{-1}r$ is contained in every prime ideal. hence $f^n$ maps to zero in $s^{-1}r$ for some $n \geq 1$ (lemma \ref{lemma-zariski-topology}). hence $v(i') = v(i)$. then this implies every $g \in s$ is invertible mod $i$. hence we get ring maps $r/i \to s^{-1}r$ and $s^{-1}r \to r/i$. the first map is injective by choice of $i$. the second is the map $s^{-1}r \to s^{-1}(r/i) = r/i$ which has kernel $s^{-1}i$ because localization is exact. since $s^{-1}i = 0$ we see also the second map is injective. hence $s^{-1}r \cong r/i$. \end{proof} \begin{lemma} \label{lemma-invert-closed-split} let $r$ be a ring. let $s \subset r$ be a multiplicative subset. assume the image of the map $\spec(s^{-1}r) \to \spec(r)$ is closed. if $r$ is noetherian, or $\spec(r)$ is a noetherian topological space, or $s$ is finitely generated as a monoid, then $r \cong s^{-1}r \times r'$ for some ring $r'$. \end{lemma} \begin{proof} by lemma \ref{lemma-invert-closed-quotient} we have $s^{-1}r \cong r/i$ for some ideal $i \subset r$. by lemma \ref{lemma-disjoint-implies-product} it suffices to show that $v(i)$ is open. if $r$ is noetherian then $\spec(r)$ is a noetherian topological space, see lemma \ref{lemma-noetherian-topology}. if $\spec(r)$ is a noetherian topological space, then the complement $\spec(r) \setminus v(i)$ is quasi-compact, see topology, lemma \ref{topology-lemma-noetherian-quasi-compact}. hence there exist finitely many $f_1, \ldots, f_n \in i$ such that $v(i) = v(f_1, \ldots, f_n)$. since each $f_i$ maps to zero in $s^{-1}r$ there exists a $g \in s$ such that $gf_i = 0$ for $i = 1, \ldots, n$. hence $d(g) = v(i)$ as desired. in case $s$ is finitely generated as a monoid, say $s$ is generated by $g_1, \ldots, g_m$, then $s^{-1}r \cong r_{g_1 \ldots g_m}$ and we conclude that $v(i) = d(g_1 \ldots g_m)$. \end{proof} \section{hilbert nullstellensatz} \label{section-nullstellensatz} \begin{theorem}[hilbert nullstellensatz] \label{theorem-nullstellensatz} let $k$ be a field. \begin{enumerate} \item \label{item-finite-kappa} for any maximal ideal $\mathfrak m \subset k[x_1, \ldots, x_n]$ the field extension $\kappa(\mathfrak m)/k$ is finite. \item \label{item-polynomial-ring-jacobson} any radical ideal $i \subset k[x_1, \ldots, x_n]$ is the intersection of maximal ideals containing it. \end{enumerate} the same is true in any finite type $k$-algebra. \end{theorem} \begin{proof} it is enough to prove part (\ref{item-finite-kappa}) of the theorem for the case of a polynomial algebra $k[x_1, \ldots, x_n]$, because any finitely generated $k$-algebra is a quotient of such a polynomial algebra. we prove this by induction on $n$. the case $n = 0$ is clear. suppose that $\mathfrak m$ is a maximal ideal in $k[x_1, \ldots, x_n]$. let $\mathfrak p \subset k[x_n]$ be the intersection of $\mathfrak m$ with $k[x_n]$. \medskip\noindent if $\mathfrak p \not = (0)$, then $\mathfrak p$ is maximal and generated by an irreducible monic polynomial $p$ (because of the euclidean algorithm in $k[x_n]$). then $k' = k[x_n]/\mathfrak p$ is a finite field extension of $k$ and contained in $\kappa(\mathfrak m)$. in this case we get a surjection $$ k'[x_1, \ldots, x_{n-1}] \to k'[x_1, \ldots, x_n] = k' \otimes_k k[x_1, \ldots, x_n] \longrightarrow \kappa(\mathfrak m) $$ and hence we see that $\kappa(\mathfrak m)$ is a finite extension of $k'$ by induction hypothesis. thus $\kappa(\mathfrak m)$ is finite over $k$ as well. \medskip\noindent if $\mathfrak p = (0)$ we consider the ring extension $k[x_n] \subset k[x_1, \ldots, x_n]/\mathfrak m$. this is a finitely generated ring extension, hence of finite presentation by lemmas \ref{lemma-obvious-noetherian} and \ref{lemma-noetherian-finite-type-is-finite-presentation}. thus the image of $\spec(k[x_1, \ldots, x_n]/\mathfrak m)$ in $\spec(k[x_n])$ is constructible by theorem \ref{theorem-chevalley}. since the image contains $(0)$ we conclude that it contains a standard open $d(f)$ for some $f\in k[x_n]$ nonzero. since clearly $d(f)$ is infinite we get a contradiction with the assumption that $k[x_1, \ldots, x_n]/\mathfrak m$ is a field (and hence has a spectrum consisting of one point). \medskip\noindent proof of (\ref{item-polynomial-ring-jacobson}). let $i \subset r$ be a radical ideal, with $r$ of finite type over $k$. let $f \in r$, $f \not \in i$. we have to find a maximal ideal $\mathfrak m \subset r$ with $i \subset \mathfrak m$ and $f \not \in \mathfrak m$. the ring $(r/i)_f$ is nonzero, since $1 = 0$ in this ring would mean $f^n \in i$ and since $i$ is radical this would mean $f \in i$ contrary to our assumption on $f$. thus we may choose a maximal ideal $\mathfrak m'$ in $(r/i)_f$, see lemma \ref{lemma-zariski-topology}. let $\mathfrak m \subset r$ be the inverse image of $\mathfrak m'$ in $r$. we see that $i \subset \mathfrak m$ and $f \not \in \mathfrak m$. if we show that $\mathfrak m$ is a maximal ideal of $r$, then we are done. we clearly have $$ k \subset r/\mathfrak m \subset \kappa(\mathfrak m'). $$ by part (\ref{item-finite-kappa}) the field extension $\kappa(\mathfrak m')/k$ is finite. hence $r/\mathfrak m$ is a field by fields, lemma \ref{fields-lemma-subalgebra-algebraic-extension-field}. thus $\mathfrak m$ is maximal and the proof is complete. \end{proof} \begin{lemma} \label{lemma-field-finite-type-over-domain} let $r$ be a ring. let $k$ be a field. if $r \subset k$ and $k$ is of finite type over $r$, then there exists an $f \in r$ such that $r_f$ is a field, and $k/r_f$ is a finite field extension. \end{lemma} \begin{proof} by lemma \ref{lemma-characterize-image-finite-type} there exist a nonempty open $u \subset \spec(r)$ contained in the image $\{(0)\}$ of $\spec(k) \to \spec(r)$. choose $f \in r$, $f \not = 0$ such that $d(f) \subset u$, i.e., $d(f) = \{(0)\}$. then $r_f$ is a domain whose spectrum has exactly one point and $r_f$ is a field. then $k$ is a finitely generated algebra over the field $r_f$ and hence a finite field extension of $r_f$ by the hilbert nullstellensatz (theorem \ref{theorem-nullstellensatz}). \end{proof} \section{jacobson rings} \label{section-ring-jacobson} \noindent let $r$ be a ring. the closed points of $\spec(r)$ are the maximal ideals of $r$. often rings which occur naturally in algebraic geometry have lots of maximal ideals. for example finite type algebras over a field or over $\mathbf{z}$. we will show that these are examples of jacobson rings. \begin{definition} \label{definition-ring-jacobson} let $r$ be a ring. we say that $r$ is a {\it jacobson ring} if every radical ideal $i$ is the intersection of the maximal ideals containing it. \end{definition} \begin{lemma} \label{lemma-finite-type-field-jacobson} any algebra of finite type over a field is jacobson. \end{lemma} \begin{proof} this follows from theorem \ref{theorem-nullstellensatz} and definition \ref{definition-ring-jacobson}. \end{proof} \begin{lemma} \label{lemma-jacobson-prime} let $r$ be a ring. if every prime ideal of $r$ is the intersection of the maximal ideals containing it, then $r$ is jacobson. \end{lemma} \begin{proof} this is immediately clear from the fact that every radical ideal $i \subset r$ is the intersection of the primes containing it. see lemma \ref{lemma-zariski-topology}. \end{proof} \begin{lemma} \label{lemma-jacobson} a ring $r$ is jacobson if and only if $\spec(r)$ is jacobson, see topology, definition \ref{topology-definition-space-jacobson}. \end{lemma} \begin{proof} suppose $r$ is jacobson. let $z \subset \spec(r)$ be a closed subset. we have to show that the set of closed points in $z$ is dense in $z$. let $u \subset \spec(r)$ be an open such that $u \cap z$ is nonempty. we have to show $z \cap u$ contains a closed point of $\spec(r)$. we may assume $u = d(f)$ as standard opens form a basis for the topology on $\spec(r)$. according to lemma \ref{lemma-zariski-topology} we may assume that $z = v(i)$, where $i$ is a radical ideal. we see also that $f \not \in i$. by assumption, there exists a maximal ideal $\mathfrak m \subset r$ such that $i \subset \mathfrak m$ but $f \not\in \mathfrak m$. hence $\mathfrak m \in d(f) \cap v(i) = u \cap z$ as desired. \medskip\noindent conversely, suppose that $\spec(r)$ is jacobson. let $i \subset r$ be a radical ideal. let $j = \cap_{i \subset \mathfrak m} \mathfrak m$ be the intersection of the maximal ideals containing $i$. clearly $j$ is a radical ideal, $v(j) \subset v(i)$, and $v(j)$ is the smallest closed subset of $v(i)$ containing all the closed points of $v(i)$. by assumption we see that $v(j) = v(i)$. but lemma \ref{lemma-zariski-topology} shows there is a bijection between zariski closed sets and radical ideals, hence $i = j$ as desired. \end{proof} \begin{lemma} \label{lemma-characterize-jacobson} let $r$ be a ring. if $r$ is not jacobson there exist a prime $\mathfrak p \subset r$, an element $f \in r$ such that the following hold \begin{enumerate} \item $\mathfrak p$ is not a maximal ideal, \item $f \not \in \mathfrak p$, \item $v(\mathfrak p) \cap d(f) = \{\mathfrak p\}$, and \item $(r/\mathfrak p)_f$ is a field. \end{enumerate} on the other hand, if $r$ is jacobson, then for any pair $(\mathfrak p, f)$ such that (1) and (2) hold the set $v(\mathfrak p) \cap d(f)$ is infinite. \end{lemma} \begin{proof} assume $r$ is not jacobson. by lemma \ref{lemma-jacobson} this means there exists an closed subset $t \subset \spec(r)$ whose set $t_0 \subset t$ of closed points is not dense in $t$. choose an $f \in r$ such that $t_0 \subset v(f)$ but $t \not \subset v(f)$. note that $t \cap d(f)$ is homeomorphic to $\spec((r/i)_f)$ if $t = v(i)$, see lemmas \ref{lemma-spec-closed} and \ref{lemma-standard-open}. as any ring has a maximal ideal (lemma \ref{lemma-zariski-topology}) we can choose a closed point $t$ of space $t \cap d(f)$. then $t$ corresponds to a prime ideal $\mathfrak p \subset r$ which is not maximal (as $t \not \in t_0$). thus (1) holds. by construction $f \not \in \mathfrak p$, hence (2). as $t$ is a closed point of $t \cap d(f)$ we see that $v(\mathfrak p) \cap d(f) = \{\mathfrak p\}$, i.e., (3) holds. hence we conclude that $(r/\mathfrak p)_f$ is a domain whose spectrum has one point, hence (4) holds (for example combine lemmas \ref{lemma-characterize-local-ring} and \ref{lemma-minimal-prime-reduced-ring}). \medskip\noindent conversely, suppose that $r$ is jacobson and $(\mathfrak p, f)$ satisfy (1) and (2). if $v(\mathfrak p) \cap d(f) = \{\mathfrak p, \mathfrak q_1, \ldots, \mathfrak q_t\}$ then $\mathfrak p \not = \mathfrak q_i$ implies there exists an element $g \in r$ such that $g \not \in \mathfrak p$ but $g \in \mathfrak q_i$ for all $i$. hence $v(\mathfrak p) \cap d(fg) = \{\mathfrak p\}$ which is impossible since each locally closed subset of $\spec(r)$ contains at least one closed point as $\spec(r)$ is a jacobson topological space. \end{proof} \begin{lemma} \label{lemma-pid-jacobson} the ring $\mathbf{z}$ is a jacobson ring. more generally, let $r$ be a ring such that \begin{enumerate} \item $r$ is a domain, \item $r$ is noetherian, \item any nonzero prime ideal is a maximal ideal, and \item $r$ has infinitely many maximal ideals. \end{enumerate} then $r$ is a jacobson ring. \end{lemma} \begin{proof} let $r$ satisfy (1), (2), (3) and (4). the statement means that $(0) = \bigcap_{\mathfrak m \subset r} \mathfrak m$. since $r$ has infinitely many maximal ideals it suffices to show that any nonzero $x \in r$ is contained in at most finitely many maximal ideals, in other words that $v(x)$ is finite. by lemma \ref{lemma-spec-closed} we see that $v(x)$ is homeomorphic to $\spec(r/xr)$. by assumption (3) every prime of $r/xr$ is minimal and hence corresponds to an irreducible component of $\spec(r/xr)$ (lemma \ref{lemma-irreducible}). as $r/xr$ is noetherian, the topological space $\spec(r/xr)$ is noetherian (lemma \ref{lemma-noetherian-topology}) and has finitely many irreducible components (topology, lemma \ref{topology-lemma-noetherian}). thus $v(x)$ is finite as desired. \end{proof} \begin{example} \label{example-infinite-product-fields-jacobson} let $a$ be an infinite set. for each $\alpha \in a$, let $k_\alpha$ be a field. we claim that $r = \prod_{\alpha\in a} k_\alpha$ is jacobson. first, note that any element $f \in r$ has the form $f = ue$, with $u \in r$ a unit and $e\in r$ an idempotent (left to the reader). hence $d(f) = d(e)$, and $r_f = r_e = r/(1-e)$ is a quotient of $r$. actually, any ring with this property is jacobson. namely, say $\mathfrak p \subset r$ is a prime ideal and $f \in r$, $f \not \in \mathfrak p$. we have to find a maximal ideal $\mathfrak m$ of $r$ such that $\mathfrak p \subset \mathfrak m$ and $f \not\in \mathfrak m$. because $r_f$ is a quotient of $r$ we see that any maximal ideal of $r_f$ corresponds to a maximal ideal of $r$ not containing $f$. hence the result follows by choosing a maximal ideal of $r_f$ containing $\mathfrak p r_f$. \end{example} \begin{example} \label{example-not-jacobson} a domain $r$ with finitely many maximal ideals $\mathfrak m_i$, $i = 1, \ldots, n$ is not a jacobson ring, except when it is a field. namely, in this case $(0)$ is not the intersection of the maximal ideals $(0) \not = \mathfrak m_1 \cap \mathfrak m_2 \cap \ldots \cap \mathfrak m_n \supset \mathfrak m_1 \cdot \mathfrak m_2 \cdot \ldots \cdot \mathfrak m_n \not = 0$. in particular a discrete valuation ring, or any local ring with at least two prime ideals is not a jacobson ring. \end{example} \begin{lemma} \label{lemma-finite-residue-extension-closed} let $r \to s$ be a ring map. let $\mathfrak m \subset r$ be a maximal ideal. let $\mathfrak q \subset s$ be a prime ideal lying over $\mathfrak m$ such that $\kappa(\mathfrak q)/\kappa(\mathfrak m)$ is an algebraic field extension. then $\mathfrak q$ is a maximal ideal of $s$. \end{lemma} \begin{proof} consider the diagram $$ \xymatrix{ s \ar[r] & s/\mathfrak q \ar[r] & \kappa(\mathfrak q) \\ r \ar[r] \ar[u] & r/\mathfrak m \ar[u] } $$ we see that $\kappa(\mathfrak m) \subset s/\mathfrak q \subset \kappa(\mathfrak q)$. because the field extension $\kappa(\mathfrak m) \subset \kappa(\mathfrak q)$ is algebraic, any ring between $\kappa(\mathfrak m)$ and $\kappa(\mathfrak q)$ is a field (fields, lemma \ref{fields-lemma-subalgebra-algebraic-extension-field}). thus $s/\mathfrak q$ is a field, and a posteriori equal to $\kappa(\mathfrak q)$. \end{proof} \begin{lemma} \label{lemma-dimension} suppose that $k$ is a field and suppose that $v$ is a nonzero vector space over $k$. assume the dimension of $v$ (which is a cardinal number) is smaller than the cardinality of $k$. then for any linear operator $t : v \to v$ there exists some monic polynomial $p(t) \in k[t]$ such that $p(t)$ is not invertible. \end{lemma} \begin{proof} if not then $v$ inherits the structure of a vector space over the field $k(t)$. but the dimension of $k(t)$ over $k$ is at least the cardinality of $k$ for example due to the fact that the elements $\frac{1}{t - \lambda}$ are $k$-linearly independent. \end{proof} \noindent here is another version of hilbert's nullstellensatz. \begin{theorem} \label{theorem-uncountable-nullstellensatz} let $k$ be a field. let $s$ be a $k$-algebra generated over $k$ by the elements $\{x_i\}_{i \in i}$. assume the cardinality of $i$ is smaller than the cardinality of $k$. then \begin{enumerate} \item for all maximal ideals $\mathfrak m \subset s$ the field extension $\kappa(\mathfrak m)/k$ is algebraic, and \item $s$ is a jacobson ring. \end{enumerate} \end{theorem} \begin{proof} if $i$ is finite then the result follows from the hilbert nullstellensatz, theorem \ref{theorem-nullstellensatz}. in the rest of the proof we assume $i$ is infinite. it suffices to prove the result for $\mathfrak m \subset k[\{x_i\}_{i \in i}]$ maximal in the polynomial ring on variables $x_i$, since $s$ is a quotient of this. as $i$ is infinite the set of monomials $x_{i_1}^{e_1} \ldots x_{i_r}^{e_r}$, $i_1, \ldots, i_r \in i$ and $e_1, \ldots, e_r \geq 0$ has cardinality at most equal to the cardinality of $i$. because the cardinality of $i \times \ldots \times i$ is the cardinality of $i$, and also the cardinality of $\bigcup_{n \geq 0} i^n$ has the same cardinality. (if $i$ is finite, then this is not true and in that case this proof only works if $k$ is uncountable.) \medskip\noindent to arrive at a contradiction pick $t \in \kappa(\mathfrak m)$ transcendental over $k$. note that the $k$-linear map $t : \kappa(\mathfrak m) \to \kappa(\mathfrak m)$ given by multiplication by $t$ has the property that $p(t)$ is invertible for all monic polynomials $p(t) \in k[t]$. also, $\kappa(\mathfrak m)$ has dimension at most the cardinality of $i$ over $k$ since it is a quotient of the vector space $k[\{x_i\}_{i \in i}]$ over $k$ (whose dimension is $\# i$ as we saw above). this is impossible by lemma \ref{lemma-dimension}. \medskip\noindent to show that $s$ is jacobson we argue as follows. if not then there exists a prime $\mathfrak q \subset s$ and an element $f \in s$, $f \not \in \mathfrak q$ such that $\mathfrak q$ is not maximal and $(s/\mathfrak q)_f$ is a field, see lemma \ref{lemma-characterize-jacobson}. but note that $(s/\mathfrak q)_f$ is generated by at most $\# i + 1$ elements. hence the field extension $(s/\mathfrak q)_f/k$ is algebraic (by the first part of the proof). this implies that $\kappa(\mathfrak q)$ is an algebraic extension of $k$ hence $\mathfrak q$ is maximal by lemma \ref{lemma-finite-residue-extension-closed}. this contradiction finishes the proof. \end{proof} \begin{lemma} \label{lemma-base-change-jacobson} let $k$ be a field. let $s$ be a $k$-algebra. for any field extension $k/k$ whose cardinality is larger than the cardinality of $s$ we have \begin{enumerate} \item for every maximal ideal $\mathfrak m$ of $s_k$ the field $\kappa(\mathfrak m)$ is algebraic over $k$, and \item $s_k$ is a jacobson ring. \end{enumerate} \end{lemma} \begin{proof} choose $k \subset k$ such that the cardinality of $k$ is greater than the cardinality of $s$. since the elements of $s$ generate the $k$-algebra $s_k$ we see that theorem \ref{theorem-uncountable-nullstellensatz} applies. \end{proof} \begin{example} \label{example-countable-trick-does-not-work} the trick in the proof of theorem \ref{theorem-uncountable-nullstellensatz} really does not work if $k$ is a countable field and $i$ is countable too. let $k$ be a countable field. let $x$ be a variable, and let $k(x)$ be the field of rational functions in $x$. consider the polynomial algebra $r = k[x, \{x_f\}_{f \in k[x]-\{0\}}]$. let $i = (\{fx_f - 1\}_{f\in k[x] - \{0\}})$. note that $i$ is a proper ideal in $r$. choose a maximal ideal $i \subset \mathfrak m$. then $k \subset r/\mathfrak m$ is isomorphic to $k(x)$, and is not algebraic over $k$. \end{example} \begin{lemma} \label{lemma-jacobson-invert-element} let $r$ be a jacobson ring. let $f \in r$. the ring $r_f$ is jacobson and maximal ideals of $r_f$ correspond to maximal ideals of $r$ not containing $f$. \end{lemma} \begin{proof} by topology, lemma \ref{topology-lemma-jacobson-inherited} we see that $d(f) = \spec(r_f)$ is jacobson and that closed points of $d(f)$ correspond to closed points in $\spec(r)$ which happen to lie in $d(f)$. thus $r_f$ is jacobson by lemma \ref{lemma-jacobson}. \end{proof} \begin{example} \label{example-localize-not-preserve-closed-points} here is a simple example that shows lemma \ref{lemma-jacobson-invert-element} to be false if $r$ is not jacobson. consider the ring $r = \mathbf{z}_{(2)}$, i.e., the localization of $\mathbf{z}$ at the prime $(2)$. the localization of $r$ at the element $2$ is isomorphic to $\mathbf{q}$, in a formula: $r_2 \cong \mathbf{q}$. clearly the map $r \to r_2$ maps the closed point of $\spec(\mathbf{q})$ to the generic point of $\spec(r)$. \end{example} \begin{example} \label{example-infinite-localize-not-preserve-closed-points} here is a simple example that shows lemma \ref{lemma-jacobson-invert-element} is false if $r$ is jacobson but we localize at infinitely many elements. namely, let $r = \mathbf{z}$ and consider the localization $(r \setminus \{0\})^{-1}r \cong \mathbf{q}$ of $r$ at the set of all nonzero elements. clearly the map $\mathbf{z} \to \mathbf{q}$ maps the closed point of $\spec(\mathbf{q})$ to the generic point of $\spec(\mathbf{z})$. \end{example} \begin{lemma} \label{lemma-jacobson-mod-ideal} let $r$ be a jacobson ring. let $i \subset r$ be an ideal. the ring $r/i$ is jacobson and maximal ideals of $r/i$ correspond to maximal ideals of $r$ containing $i$. \end{lemma} \begin{proof} the proof is the same as the proof of lemma \ref{lemma-jacobson-invert-element}. \end{proof} \begin{lemma} \label{lemma-silly-jacobson} let $r$ be a jacobson ring. let $k$ be a field. let $r \subset k$ and $k$ is of finite type over $r$. then $r$ is a field and $k/r$ is a finite field extension. \end{lemma} \begin{proof} first note that $r$ is a domain. by lemma \ref{lemma-field-finite-type-over-domain} we see that $r_f$ is a field and $k/r_f$ is a finite field extension for some nonzero $f \in r$. hence $(0)$ is a maximal ideal of $r_f$ and by lemma \ref{lemma-jacobson-invert-element} we conclude $(0)$ is a maximal ideal of $r$. \end{proof} \begin{proposition} \label{proposition-jacobson-permanence} let $r$ be a jacobson ring. let $r \to s$ be a ring map of finite type. then \begin{enumerate} \item the ring $s$ is jacobson. \item the map $\spec(s) \to \spec(r)$ transforms closed points to closed points. \item for $\mathfrak m' \subset s$ maximal lying over $\mathfrak m \subset r$ the field extension $\kappa(\mathfrak m')/\kappa(\mathfrak m)$ is finite. \end{enumerate} \end{proposition} \begin{proof} let $\mathfrak m' \subset s$ be a maximal ideal and $r \cap \mathfrak m' = \mathfrak m$. then $r/\mathfrak m \to s/\mathfrak m'$ satisfies the conditions of lemma \ref{lemma-silly-jacobson} by lemma \ref{lemma-jacobson-mod-ideal}. hence $r/\mathfrak m$ is a field and $\mathfrak m$ a maximal ideal and the induced residue field extension is finite. this proves (2) and (3). \medskip\noindent if $s$ is not jacobson, then by lemma \ref{lemma-characterize-jacobson} there exists a non-maximal prime ideal $\mathfrak q$ of $s$ and an $g \in s$, $g \not\in \mathfrak q$ such that $(s/\mathfrak q)_g$ is a field. to arrive at a contradiction we show that $\mathfrak q$ is a maximal ideal. let $\mathfrak p = \mathfrak q \cap r$. then $r/\mathfrak p \to (s/\mathfrak q)_g$ satisfies the conditions of lemma \ref{lemma-silly-jacobson} by lemma \ref{lemma-jacobson-mod-ideal}. hence $r/\mathfrak p$ is a field and the field extension $\kappa(\mathfrak p) \to (s/\mathfrak q)_g = \kappa(\mathfrak q)$ is finite, thus algebraic. then $\mathfrak q$ is a maximal ideal of $s$ by lemma \ref{lemma-finite-residue-extension-closed}. contradiction. \end{proof} \begin{lemma} \label{lemma-corollary-jacobson} any finite type algebra over $\mathbf{z}$ is jacobson. \end{lemma} \begin{proof} combine lemma \ref{lemma-pid-jacobson} and proposition \ref{proposition-jacobson-permanence}. \end{proof} \begin{lemma} \label{lemma-image-finite-type-map-jacobson-rings} let $r \to s$ be a finite type ring map of jacobson rings. denote $x = \spec(r)$ and $y = \spec(s)$. write $f : y \to x$ the induced map of spectra. let $e \subset y = \spec(s)$ be a constructible set. denote with a subscript ${}_0$ the set of closed points of a topological space. \begin{enumerate} \item we have $f(e)_0 = f(e_0) = x_0 \cap f(e)$. \item a point $\xi \in x$ is in $f(e)$ if and only if $\overline{\{\xi\}} \cap f(e_0)$ is dense in $\overline{\{\xi\}}$. \end{enumerate} \end{lemma} \begin{proof} we have a commutative diagram of continuous maps $$ \xymatrix{ e \ar[r] \ar[d] & y \ar[d] \\ f(e) \ar[r] & x } $$ suppose $x \in f(e)$ is closed in $f(e)$. then $f^{-1}(\{x\})\cap e$ is nonempty and closed in $e$. applying topology, lemma \ref{topology-lemma-jacobson-inherited} to both inclusions $$ f^{-1}(\{x\}) \cap e \subset e \subset y $$ we find there exists a point $y \in f^{-1}(\{x\}) \cap e$ which is closed in $y$. in other words, there exists $y \in y_0$ and $y \in e_0$ mapping to $x$. hence $x \in f(e_0)$. this proves that $f(e)_0 \subset f(e_0)$. proposition \ref{proposition-jacobson-permanence} implies that $f(e_0) \subset x_0 \cap f(e)$. the inclusion $x_0 \cap f(e) \subset f(e)_0$ is trivial. this proves the first assertion. \medskip\noindent suppose that $\xi \in f(e)$. according to lemma \ref{lemma-characterize-image-finite-type} the set $f(e) \cap \overline{\{\xi\}}$ contains a dense open subset of $\overline{\{\xi\}}$. since $x$ is jacobson we conclude that $f(e) \cap \overline{\{\xi\}}$ contains a dense set of closed points, see topology, lemma \ref{topology-lemma-jacobson-inherited}. we conclude by part (1) of the lemma. \medskip\noindent on the other hand, suppose that $\overline{\{\xi\}} \cap f(e_0)$ is dense in $\overline{\{\xi\}}$. by lemma \ref{lemma-constructible-is-image} there exists a ring map $s \to s'$ of finite presentation such that $e$ is the image of $y' := \spec(s') \to y$. then $e_0$ is the image of $y'_0$ by the first part of the lemma applied to the ring map $s \to s'$. thus we may assume that $e = y$ by replacing $s$ by $s'$. suppose $\xi$ corresponds to $\mathfrak p \subset r$. consider the diagram $$ \xymatrix{ s \ar[r] & s/\mathfrak p s \\ r \ar[r] \ar[u] & r/\mathfrak p \ar[u] } $$ this diagram and the density of $f(y_0) \cap v(\mathfrak p)$ in $v(\mathfrak p)$ shows that the morphism $r/\mathfrak p \to s/\mathfrak p s$ satisfies condition (2) of lemma \ref{lemma-domain-image-dense-set-points-generic-point}. hence we conclude there exists a prime $\overline{\mathfrak q} \subset s/\mathfrak ps$ mapping to $(0)$. in other words the inverse image $\mathfrak q$ of $\overline{\mathfrak q}$ in $s$ maps to $\mathfrak p$ as desired. \end{proof} \noindent the conclusion of the lemma above is that we can read off the image of $f$ from the set of closed points of the image. this is a little nicer in case the map is of finite presentation because then we know that images of a constructible is constructible. before we state it we introduce some notation. denote $\text{constr}(x)$ the set of constructible sets. let $r \to s$ be a ring map. denote $x = \spec(r)$ and $y = \spec(s)$. write $f : y \to x$ the induced map of spectra. denote with a subscript ${}_0$ the set of closed points of a topological space. \begin{lemma} \label{lemma-conclude-jacobson-noetherian} with notation as above. assume that $r$ is a noetherian jacobson ring. further assume $r \to s$ is of finite type. there is a commutative diagram $$ \xymatrix{ \text{constr}(y) \ar[r]^{e \mapsto e_0} \ar[d]^{e \mapsto f(e)} & \text{constr}(y_0) \ar[d]^{e \mapsto f(e)} \\ \text{constr}(x) \ar[r]^{e \mapsto e_0} & \text{constr}(x_0) } $$ where the horizontal arrows are the bijections from topology, lemma \ref{topology-lemma-jacobson-equivalent-constructible}. \end{lemma} \begin{proof} since $r \to s$ is of finite type, it is of finite presentation, see lemma \ref{lemma-noetherian-finite-type-is-finite-presentation}. thus the image of a constructible set in $x$ is constructible in $y$ by chevalley's theorem (theorem \ref{theorem-chevalley}). combined with lemma \ref{lemma-image-finite-type-map-jacobson-rings} the lemma follows. \end{proof} \noindent to illustrate the use of jacobson rings, we give the following two examples. \begin{example} \label{example-product-matrices-zero} let $k$ be a field. the space $\spec(k[x, y]/(xy))$ has two irreducible components: namely the $x$-axis and the $y$-axis. as a generalization, let $$ r = k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]/ \mathfrak a, $$ where $\mathfrak a$ is the ideal in $k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]$ generated by the entries of the $2 \times 2$ product matrix $$ \left( \begin{matrix} x_{11} & x_{12}\\ x_{21} & x_{22} \end{matrix} \right) \left( \begin{matrix} y_{11} & y_{12}\\ y_{21} & y_{22} \end{matrix} \right). $$ in this example we will describe $\spec(r)$. \medskip\noindent to prove the statement about $\spec(k[x, y]/(xy))$ we argue as follows. if $\mathfrak p \subset k[x, y]$ is any ideal containing $xy$, then either $x$ or $y$ would be contained in $\mathfrak p$. hence the minimal such prime ideals are just $(x)$ and $(y)$. in case $k$ is algebraically closed, the $\text{max-spec}$ of these components can then be visualized as the point sets of $y$- and $x$-axis. \medskip\noindent for the generalization, note that we may identify the closed points of the spectrum of $k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}])$ with the space of matrices $$ \left\{ (x, y) \in \text{mat}(2, k)\times \text{mat}(2, k) \mid x = \left( \begin{matrix} x_{11} & x_{12}\\ x_{21} & x_{22} \end{matrix} \right), y= \left( \begin{matrix} y_{11} & y_{12}\\ y_{21} & y_{22} \end{matrix} \right) \right\} $$ at least if $k$ is algebraically closed. now define a group action of $\text{gl}(2, k)\times \text{gl}(2, k)\times \text{gl}(2, k)$ on the space of matrices $\{(x, y)\}$ by $$ (g_1, g_2, g_3) \times (x, y) \mapsto ((g_1xg_2^{-1}, g_2yg_3^{-1})). $$ here, also observe that the algebraic set $$ \text{gl}(2, k)\times \text{gl}(2, k)\times \text{gl}(2, k) \subset \text{mat}(2, k)\times \text{mat}(2, k) \times \text{mat}(2, k) $$ is irreducible since it is the max spectrum of the domain $$ k[x_{11}, x_{12}, \ldots, z_{21}, z_{22}, (x_{11}x_{22}-x_{12}x_{21})^{-1} , (y_{11}y_{22}-y_{12}y_{21})^{-1}, (z_{11}z_{22}-z_{12}z_{21})^{-1}]. $$ since the image of irreducible an algebraic set is still irreducible, it suffices to classify the orbits of the set $\{(x, y)\in \text{mat}(2, k)\times \text{mat}(2, k)|xy = 0\}$ and take their closures. from standard linear algebra, we are reduced to the following three cases: \begin{enumerate} \item $\exists (g_1, g_2)$ such that $g_1xg_2^{-1} = i_{2\times 2}$. then $y$ is necessarily $0$, which as an algebraic set is invariant under the group action. it follows that this orbit is contained in the irreducible algebraic set defined by the prime ideal $(y_{11}, y_{12}, y_{21}, y_{22})$. taking the closure, we see that $(y_{11}, y_{12}, y_{21}, y_{22})$ is actually a component. \item $\exists (g_1, g_2)$ such that $$ g_1xg_2^{-1} = \left( \begin{matrix} 1 & 0 \\ 0 & 0 \end{matrix} \right). $$ this case occurs if and only if $x$ is a rank 1 matrix, and furthermore, $y$ is killed by such an $x$ if and only if $$ x_{11}y_{11}+x_{12}y_{21} = 0; \quad x_{11}y_{12}+x_{12}y_{22} = 0; $$ $$ x_{21}y_{11}+x_{22}y_{21} = 0; \quad x_{21}y_{12}+x_{22}y_{22} = 0. $$ fix a rank 1 $x$, such non zero $y$'s satisfying the above equations form an irreducible algebraic set for the following reason($y = 0$ is contained the previous case): $0 = g_1xg_2^{-1}g_2y$ implies that $$ g_2y = \left( \begin{matrix} 0 & 0 \\ y_{21}' & y_{22}' \end{matrix} \right). $$ with a further $\text{gl}(2, k)$-action on the right by $g_3$, $g_2y$ can be brought into $$ g_2yg_3^{-1} = \left( \begin{matrix} 0 & 0 \\ 0 & 1 \end{matrix} \right), $$ and thus such $y$'s form an irreducible algebraic set isomorphic to the image of $\text{gl}(2, k)$ under this action. finally, notice that the ``rank 1" condition for $x$'s forms an open dense subset of the irreducible algebraic set $\det x = x_{11}x_{22} - x_{12}x_{21} = 0$. it now follows that all the five equations define an irreducible component $(x_{11}y_{11}+x_{12}y_{21}, x_{11}y_{12}+x_{12}y_{22}, x_{21}y_{11} +x_{22}y_{21}, x_{21}y_{12}+x_{22}y_{22}, x_{11}x_{22}-x_{12}x_{21})$ in the open subset of the space of pairs of nonzero matrices. it can be shown that the pair of equations $\det x = 0$, $\det y = 0$ cuts $\spec(r)$ in an irreducible component with the above locus an open dense subset. \item $\exists (g_1, g_2)$ such that $g_1xg_2^{-1} = 0$, or equivalently, $x = 0$. then $y$ can be arbitrary and this component is thus defined by $(x_{11}, x_{12}, x_{21}, x_{22})$. \end{enumerate} \end{example} \begin{example} \label{example-idempotent-matrices} for another example, consider $r = k[\{t_{ij}\}_{i, j = 1}^{n}]/\mathfrak a$, where $\mathfrak a$ is the ideal generated by the entries of the product matrix $t^2-t$, $t = (t_{ij})$. from linear algebra, we know that under the $gl(n, k)$-action defined by $g, t \mapsto gtg^{-1}$, $t$ is classified by the its rank and each $t$ is conjugate to some $\text{diag}(1, \ldots, 1, 0, \ldots, 0)$, which has $r$ 1's and $n-r$ 0's. thus each orbit of such a $\text{diag}(1, \ldots, 1, 0, \ldots, 0)$ under the group action forms an irreducible component and every idempotent matrix is contained in one such orbit. next we will show that any two different orbits are necessarily disjoint. for this purpose we only need to cook up polynomial functions that take different values on different orbits. in characteristic 0 cases, such a function can be taken to be $f(t_{ij}) = trace(t) = \sum_{i = 1}^nt_{ii}$. in positive characteristic cases, things are slightly more tricky since we might have $trace(t) = 0$ even if $t \neq 0$. for instance, $char = 3$ $$ trace\left( \begin{matrix} 1 & & \\ & 1 & \\ & & 1 \end{matrix} \right) = 3 = 0 $$ anyway, these components can be separated using other functions. for instance, in the characteristic 3 case, $tr(\wedge^3t)$ takes value 1 on the components corresponding to $diag(1, 1, 1)$ and 0 on other components. \end{example} \section{finite and integral ring extensions} \label{section-finite-ring-extensions} \noindent trivial lemmas concerning finite and integral ring maps. we recall the definition. \begin{definition} \label{definition-integral-ring-map} let $\varphi : r \to s$ be a ring map. \begin{enumerate} \item an element $s \in s$ is {\it integral over $r$} if there exists a monic polynomial $p(x) \in r[x]$ such that $p^\varphi(s) = 0$, where $p^\varphi(x) \in s[x]$ is the image of $p$ under $\varphi : r[x] \to s[x]$. \item the ring map $\varphi$ is {\it integral} if every $s \in s$ is integral over $r$. \end{enumerate} \end{definition} \begin{lemma} \label{lemma-characterize-integral-element} let $\varphi : r \to s$ be a ring map. let $y \in s$. if there exists a finite $r$-submodule $m$ of $s$ such that $1 \in m$ and $ym \subset m$, then $y$ is integral over $r$. \end{lemma} \begin{proof} consider the map $\varphi : m \to m$, $x \mapsto y \cdot x$. by lemma \ref{lemma-charpoly-module} there exists a monic polynomial $p \in r[t]$ with $p(\varphi) = 0$. in the ring $s$ we get $p(y) = p(y) \cdot 1 = p(\varphi)(1) = 0$. \end{proof} \begin{lemma} \label{lemma-finite-is-integral} a finite ring map is integral. \end{lemma} \begin{proof} let $r \to s$ be finite. let $y \in s$. apply lemma \ref{lemma-characterize-integral-element} to $m = s$ to see that $y$ is integral over $r$. \end{proof} \begin{lemma} \label{lemma-characterize-integral} let $\varphi : r \to s$ be a ring map. let $s_1, \ldots, s_n$ be a finite set of elements of $s$. in this case $s_i$ is integral over $r$ for all $i = 1, \ldots, n$ if and only if there exists an $r$-subalgebra $s' \subset s$ finite over $r$ containing all of the $s_i$. \end{lemma} \begin{proof} if each $s_i$ is integral, then the subalgebra generated by $\varphi(r)$ and the $s_i$ is finite over $r$. namely, if $s_i$ satisfies a monic equation of degree $d_i$ over $r$, then this subalgebra is generated as an $r$-module by the elements $s_1^{e_1} \ldots s_n^{e_n}$ with $0 \leq e_i \leq d_i - 1$. conversely, suppose given a finite $r$-subalgebra $s'$ containing all the $s_i$. then all of the $s_i$ are integral by lemma \ref{lemma-finite-is-integral}. \end{proof} \begin{lemma} \label{lemma-characterize-finite-in-terms-of-integral} let $r \to s$ be a ring map. the following are equivalent \begin{enumerate} \item $r \to s$ is finite, \item $r \to s$ is integral and of finite type, and \item there exist $x_1, \ldots, x_n \in s$ which generate $s$ as an algebra over $r$ such that each $x_i$ is integral over $r$. \end{enumerate} \end{lemma} \begin{proof} clear from lemma \ref{lemma-characterize-integral}. \end{proof} \begin{lemma} \label{lemma-integral-transitive} \begin{slogan} a composition of integral ring maps is integral \end{slogan} suppose that $r \to s$ and $s \to t$ are integral ring maps. then $r \to t$ is integral. \end{lemma} \begin{proof} let $t \in t$. let $p(x) \in s[x]$ be a monic polynomial such that $p(t) = 0$. apply lemma \ref{lemma-characterize-integral} to the finite set of coefficients of $p$. hence $t$ is integral over some subalgebra $s' \subset s$ finite over $r$. apply lemma \ref{lemma-characterize-integral} again to find a subalgebra $t' \subset t$ finite over $s'$ and containing $t$. lemma \ref{lemma-finite-transitive} applied to $r \to s' \to t'$ shows that $t'$ is finite over $r$. the integrality of $t$ over $r$ now follows from lemma \ref{lemma-finite-is-integral}. \end{proof} \begin{lemma} \label{lemma-integral-closure-is-ring} let $r \to s$ be a ring homomorphism. the set $$ s' = \{s \in s \mid s\text{ is integral over }r\} $$ is an $r$-subalgebra of $s$. \end{lemma} \begin{proof} this is clear from lemmas \ref{lemma-characterize-integral} and \ref{lemma-finite-is-integral}. \end{proof} \begin{lemma} \label{lemma-finite-product-integral} let $r_i\to s_i$ be ring maps $i = 1, \ldots, n$. let $r$ and $s$ denote the product of the $r_i$ and $s_i$ respectively. then an element $s = (s_1, \ldots, s_n) \in s$ is integral over $r$ if and only if each $s_i$ is integral over $r_i$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{definition} \label{definition-integral-closure} let $r \to s$ be a ring map. the ring $s' \subset s$ of elements integral over $r$, see lemma \ref{lemma-integral-closure-is-ring}, is called the {\it integral closure} of $r$ in $s$. if $r \subset s$ we say that $r$ is {\it integrally closed} in $s$ if $r = s'$. \end{definition} \noindent in particular, we see that $r \to s$ is integral if and only if the integral closure of $r$ in $s$ is all of $s$. \begin{lemma} \label{lemma-finite-product-integral-closure} let $r_i\to s_i$ be ring maps $i = 1, \ldots, n$. denote the integral closure of $r_i$ in $s_i$ by $s'_i$. further let $r$ and $s$ denote the product of the $r_i$ and $s_i$ respectively. then the integral closure of $r$ in $s$ is the product of the $s'_i$. in particular $r \to s$ is integrally closed if and only if each $r_i \to s_i$ is integrally closed. \end{lemma} \begin{proof} this follows immediately from lemma \ref{lemma-finite-product-integral}. \end{proof} \begin{lemma} \label{lemma-integral-closure-localize} integral closure commutes with localization: if $a \to b$ is a ring map, and $s \subset a$ is a multiplicative subset, then the integral closure of $s^{-1}a$ in $s^{-1}b$ is $s^{-1}b'$, where $b' \subset b$ is the integral closure of $a$ in $b$. \end{lemma} \begin{proof} since localization is exact we see that $s^{-1}b' \subset s^{-1}b$. suppose $x \in b'$ and $f \in s$. then $x^d + \sum_{i = 1, \ldots, d} a_i x^{d - i} = 0$ in $b$ for some $a_i \in a$. hence also $$ (x/f)^d + \sum\nolimits_{i = 1, \ldots, d} a_i/f^i (x/f)^{d - i} = 0 $$ in $s^{-1}b$. in this way we see that $s^{-1}b'$ is contained in the integral closure of $s^{-1}a$ in $s^{-1}b$. conversely, suppose that $x/f \in s^{-1}b$ is integral over $s^{-1}a$. then we have $$ (x/f)^d + \sum\nolimits_{i = 1, \ldots, d} (a_i/f_i) (x/f)^{d - i} = 0 $$ in $s^{-1}b$ for some $a_i \in a$ and $f_i \in s$. this means that $$ (f'f_1 \ldots f_d x)^d + \sum\nolimits_{i = 1, \ldots, d} f^i(f')^if_1^i \ldots f_i^{i - 1} \ldots f_d^i a_i (f'f_1 \ldots f_dx)^{d - i} = 0 $$ for a suitable $f' \in s$. hence $f'f_1\ldots f_dx \in b'$ and thus $x/f \in s^{-1}b'$ as desired. \end{proof} \begin{lemma} \label{lemma-integral-closure-stalks} \begin{slogan} an element of an algebra over a ring is integral over the ring if and only if it is locally integral at every prime ideal of the ring. \end{slogan} let $\varphi : r \to s$ be a ring map. let $x \in s$. the following are equivalent: \begin{enumerate} \item $x$ is integral over $r$, and \item for every prime ideal $\mathfrak p \subset r$ the element $x \in s_{\mathfrak p}$ is integral over $r_{\mathfrak p}$. \end{enumerate} \end{lemma} \begin{proof} it is clear that (1) implies (2). assume (2). consider the $r$-algebra $s' \subset s$ generated by $\varphi(r)$ and $x$. let $\mathfrak p$ be a prime ideal of $r$. then we know that $x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$ in $s_{\mathfrak p}$ for some $a_i \in r_{\mathfrak p}$. hence we see, by looking at which denominators occur, that for some $f \in r$, $f \not \in \mathfrak p$ we have $a_i \in r_f$ and $x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$ in $s_f$. this implies that $s'_f$ is finite over $r_f$. since $\mathfrak p$ was arbitrary and $\spec(r)$ is quasi-compact (lemma \ref{lemma-quasi-compact}) we can find finitely many elements $f_1, \ldots, f_n \in r$ which generate the unit ideal of $r$ such that $s'_{f_i}$ is finite over $r_{f_i}$. hence we conclude from lemma \ref{lemma-cover} that $s'$ is finite over $r$. hence $x$ is integral over $r$ by lemma \ref{lemma-characterize-integral}. \end{proof} \begin{lemma} \label{lemma-base-change-integral} \begin{slogan} integrality and finiteness are preserved under base change. \end{slogan} let $r \to s$ and $r \to r'$ be ring maps. set $s' = r' \otimes_r s$. \begin{enumerate} \item if $r \to s$ is integral so is $r' \to s'$. \item if $r \to s$ is finite so is $r' \to s'$. \end{enumerate} \end{lemma} \begin{proof} we prove (1). let $s_i \in s$ be generators for $s$ over $r$. each of these satisfies a monic polynomial equation $p_i$ over $r$. hence the elements $1 \otimes s_i \in s'$ generate $s'$ over $r'$ and satisfy the corresponding polynomial $p_i'$ over $r'$. since these elements generate $s'$ over $r'$ we see that $s'$ is integral over $r'$. proof of (2) omitted. \end{proof} \begin{lemma} \label{lemma-integral-local} let $r \to s$ be a ring map. let $f_1, \ldots, f_n \in r$ generate the unit ideal. \begin{enumerate} \item if each $r_{f_i} \to s_{f_i}$ is integral, so is $r \to s$. \item if each $r_{f_i} \to s_{f_i}$ is finite, so is $r \to s$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). let $s \in s$. consider the ideal $i \subset r[x]$ of polynomials $p$ such that $p(s) = 0$. let $j \subset r$ denote the ideal (!) of leading coefficients of elements of $i$. by assumption and clearing denominators we see that $f_i^{n_i} \in j$ for all $i$ and certain $n_i \geq 0$. hence $j$ contains $1$ and we see $s$ is integral over $r$. proof of (2) omitted. \end{proof} \begin{lemma} \label{lemma-integral-permanence} let $a \to b \to c$ be ring maps. \begin{enumerate} \item if $a \to c$ is integral so is $b \to c$. \item if $a \to c$ is finite so is $b \to c$. \end{enumerate} \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-integral-closure-transitive} let $a \to b \to c$ be ring maps. let $b'$ be the integral closure of $a$ in $b$, let $c'$ be the integral closure of $b'$ in $c$. then $c'$ is the integral closure of $a$ in $c$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-integral-overring-surjective} suppose that $r \to s$ is an integral ring extension with $r \subset s$. then $\varphi : \spec(s) \to \spec(r)$ is surjective. \end{lemma} \begin{proof} let $\mathfrak p \subset r$ be a prime ideal. we have to show $\mathfrak ps_{\mathfrak p} \not = s_{\mathfrak p}$, see lemma \ref{lemma-in-image}. the localization $r_{\mathfrak p} \to s_{\mathfrak p}$ is injective (as localization is exact) and integral by lemma \ref{lemma-integral-closure-localize} or \ref{lemma-base-change-integral}. hence we may replace $r$, $s$ by $r_{\mathfrak p}$, $s_{\mathfrak p}$ and we may assume $r$ is local with maximal ideal $\mathfrak m$ and it suffices to show that $\mathfrak ms \not = s$. suppose $1 = \sum f_i s_i$ with $f_i \in \mathfrak m$ and $s_i \in s$ in order to get a contradiction. let $r \subset s' \subset s$ be such that $r \to s'$ is finite and $s_i \in s'$, see lemma \ref{lemma-characterize-integral}. the equation $1 = \sum f_i s_i$ implies that the finite $r$-module $s'$ satisfies $s' = \mathfrak m s'$. hence by nakayama's lemma \ref{lemma-nak} we see $s' = 0$. contradiction. \end{proof} \begin{lemma} \label{lemma-integral-under-field} let $r$ be a ring. let $k$ be a field. if $r \subset k$ and $k$ is integral over $r$, then $r$ is a field and $k$ is an algebraic extension. if $r \subset k$ and $k$ is finite over $r$, then $r$ is a field and $k$ is a finite algebraic extension. \end{lemma} \begin{proof} assume that $r \subset k$ is integral. by lemma \ref{lemma-integral-overring-surjective} we see that $\spec(r)$ has $1$ point. since clearly $r$ is a domain we see that $r = r_{(0)}$ is a field (lemma \ref{lemma-minimal-prime-reduced-ring}). the other assertions are immediate from this. \end{proof} \begin{lemma} \label{lemma-integral-over-field} let $k$ be a field. let $s$ be a $k$-algebra over $k$. \begin{enumerate} \item if $s$ is a domain and finite dimensional over $k$, then $s$ is a field. \item if $s$ is integral over $k$ and a domain, then $s$ is a field. \item if $s$ is integral over $k$ then every prime of $s$ is a maximal ideal (see lemma \ref{lemma-ring-with-only-minimal-primes} for more consequences). \end{enumerate} \end{lemma} \begin{proof} the statement on primes follows from the statement ``integral $+$ domain $\rightarrow$ field''. let $s$ integral over $k$ and assume $s$ is a domain, take $s \in s$. by lemma \ref{lemma-characterize-integral} we may find a finite dimensional $k$-subalgebra $k \subset s' \subset s$ containing $s$. hence $s$ is a field if we can prove the first statement. assume $s$ finite dimensional over $k$ and a domain. pick $s\in s$. since $s$ is a domain the multiplication map $s : s \to s$ is surjective by dimension reasons. hence there exists an element $s_1 \in s$ such that $ss_1 = 1$. so $s$ is a field. \end{proof} \begin{lemma} \label{lemma-integral-no-inclusion} suppose $r \to s$ is integral. let $\mathfrak q, \mathfrak q' \in \spec(s)$ be distinct primes having the same image in $\spec(r)$. then neither $\mathfrak q \subset \mathfrak q'$ nor $\mathfrak q' \subset \mathfrak q$. \end{lemma} \begin{proof} let $\mathfrak p \subset r$ be the image. by remark \ref{remark-fundamental-diagram} the primes $\mathfrak q, \mathfrak q'$ correspond to ideals in $s \otimes_r \kappa(\mathfrak p)$. thus the lemma follows from lemma \ref{lemma-integral-over-field}. \end{proof} \begin{lemma} \label{lemma-finite-finite-fibres} suppose $r \to s$ is finite. then the fibres of $\spec(s) \to \spec(r)$ are finite. \end{lemma} \begin{proof} by the discussion in remark \ref{remark-fundamental-diagram} the fibres are the spectra of the rings $s \otimes_r \kappa(\mathfrak p)$. as $r \to s$ is finite, these fibre rings are finite over $\kappa(\mathfrak p)$ hence noetherian by lemma \ref{lemma-noetherian-permanence}. by lemma \ref{lemma-integral-no-inclusion} every prime of $s \otimes_r \kappa(\mathfrak p)$ is a minimal prime. hence by lemma \ref{lemma-noetherian-irreducible-components} there are at most finitely many. \end{proof} \begin{lemma} \label{lemma-integral-going-up} let $r \to s$ be a ring map such that $s$ is integral over $r$. let $\mathfrak p \subset \mathfrak p' \subset r$ be primes. let $\mathfrak q$ be a prime of $s$ mapping to $\mathfrak p$. then there exists a prime $\mathfrak q'$ with $\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p'$. \end{lemma} \begin{proof} we may replace $r$ by $r/\mathfrak p$ and $s$ by $s/\mathfrak q$. this reduces us to the situation of having an integral extension of domains $r \subset s$ and a prime $\mathfrak p' \subset r$. by lemma \ref{lemma-integral-overring-surjective} we win. \end{proof} \noindent the property expressed in the lemma above is called the ``going up property'' for the ring map $r \to s$, see definition \ref{definition-going-up-down}. \begin{lemma} \label{lemma-finite-finitely-presented-extension} let $r \to s$ be a finite and finitely presented ring map. let $m$ be an $s$-module. then $m$ is finitely presented as an $r$-module if and only if $m$ is finitely presented as an $s$-module. \end{lemma} \begin{proof} one of the implications follows from lemma \ref{lemma-finitely-presented-over-subring}. to see the other assume that $m$ is finitely presented as an $s$-module. pick a presentation $$ s^{\oplus m} \longrightarrow s^{\oplus n} \longrightarrow m \longrightarrow 0 $$ as $s$ is finite as an $r$-module, the kernel of $s^{\oplus n} \to m$ is a finite $r$-module. thus from lemma \ref{lemma-extension} we see that it suffices to prove that $s$ is finitely presented as an $r$-module. \medskip\noindent pick $y_1, \ldots, y_n \in s$ such that $y_1, \ldots, y_n$ generate $s$ as an $r$-module. by lemma \ref{lemma-characterize-integral-element} each $y_i$ is integral over $r$. choose monic polynomials $p_i(x) \in r[x]$ with $p_i(y_i) = 0$. consider the ring $$ s' = r[x_1, \ldots, x_n]/(p_1(x_1), \ldots, p_n(x_n)) $$ then we see that $s$ is of finite presentation as an $s'$-algebra by lemma \ref{lemma-compose-finite-type}. since $s' \to s$ is surjective, the kernel $j = \ker(s' \to s)$ is finitely generated as an ideal by lemma \ref{lemma-finite-presentation-independent}. hence $j$ is a finite $s'$-module (immediate from the definitions). thus $s = \coker(j \to s')$ is of finite presentation as an $s'$-module by lemma \ref{lemma-extension}. hence, arguing as in the first paragraph, it suffices to show that $s'$ is of finite presentation as an $r$-module. actually, $s'$ is free as an $r$-module with basis the monomials $x_1^{e_1} \ldots x_n^{e_n}$ for $0 \leq e_i < \deg(p_i)$. namely, write $r \to s'$ as the composition $$ r \to r[x_1]/(p_1(x_1)) \to r[x_1, x_2]/(p_1(x_1), p_2(x_2)) \to \ldots \to s' $$ this shows that the $i$th ring in this sequence is free as a module over the $(i - 1)$st one with basis $1, x_i, \ldots, x_i^{\deg(p_i) - 1}$. the result follows easily from this by induction. some details omitted. \end{proof} \begin{lemma} \label{lemma-silly-normal} let $r$ be a ring. let $x, y \in r$ be nonzerodivisors. let $r[x/y] \subset r_{xy}$ be the $r$-subalgebra generated by $x/y$, and similarly for the subalgebras $r[y/x]$ and $r[x/y, y/x]$. if $r$ is integrally closed in $r_x$ or $r_y$, then the sequence $$ 0 \to r \xrightarrow{(-1, 1)} r[x/y] \oplus r[y/x] \xrightarrow{(1, 1)} r[x/y, y/x] \to 0 $$ is a short exact sequence of $r$-modules. \end{lemma} \begin{proof} since $x/y \cdot y/x = 1$ it is clear that the map $r[x/y] \oplus r[y/x] \to r[x/y, y/x]$ is surjective. let $\alpha \in r[x/y] \cap r[y/x]$. to show exactness in the middle we have to prove that $\alpha \in r$. by assumption we may write $$ \alpha = a_0 + a_1 x/y + \ldots + a_n (x/y)^n = b_0 + b_1 y/x + \ldots + b_m(y/x)^m $$ for some $n, m \geq 0$ and $a_i, b_j \in r$. pick some $n > \max(n, m)$. consider the finite $r$-submodule $m$ of $r_{xy}$ generated by the elements $$ (x/y)^n, (x/y)^{n - 1}, \ldots, x/y, 1, y/x, \ldots, (y/x)^{n - 1}, (y/x)^n $$ we claim that $\alpha m \subset m$. namely, it is clear that $(x/y)^i (b_0 + b_1 y/x + \ldots + b_m(y/x)^m) \in m$ for $0 \leq i \leq n$ and that $(y/x)^i (a_0 + a_1 x/y + \ldots + a_n(x/y)^n) \in m$ for $0 \leq i \leq n$. hence $\alpha$ is integral over $r$ by lemma \ref{lemma-characterize-integral-element}. note that $\alpha \in r_x$, so if $r$ is integrally closed in $r_x$ then $\alpha \in r$ as desired. \end{proof} \section{normal rings} \label{section-normal-rings} \noindent we first introduce the notion of a normal domain, and then we introduce the (very general) notion of a normal ring. \begin{definition} \label{definition-domain-normal} a domain $r$ is called {\it normal} if it is integrally closed in its field of fractions. \end{definition} \begin{lemma} \label{lemma-integral-closure-in-normal} let $r \to s$ be a ring map. if $s$ is a normal domain, then the integral closure of $r$ in $s$ is a normal domain. \end{lemma} \begin{proof} omitted. \end{proof} \noindent the following notion is occasionally useful when studying normality. \begin{definition} \label{definition-almost-integral} let $r$ be a domain. \begin{enumerate} \item an element $g$ of the fraction field of $r$ is called {\it almost integral over $r$} if there exists an element $r \in r$, $r\not = 0$ such that $rg^n \in r$ for all $n \geq 0$. \item the domain $r$ is called {\it completely normal} if every almost integral element of the fraction field of $r$ is contained in $r$. \end{enumerate} \end{definition} \noindent the following lemma shows that a noetherian domain is normal if and only if it is completely normal. \begin{lemma} \label{lemma-almost-integral} let $r$ be a domain with fraction field $k$. if $u, v \in k$ are almost integral over $r$, then so are $u + v$ and $uv$. any element $g \in k$ which is integral over $r$ is almost integral over $r$. if $r$ is noetherian then the converse holds as well. \end{lemma} \begin{proof} if $ru^n \in r$ for all $n \geq 0$ and $v^nr' \in r$ for all $n \geq 0$, then $(uv)^nrr'$ and $(u + v)^nrr'$ are in $r$ for all $n \geq 0$. hence the first assertion. suppose $g \in k$ is integral over $r$. in this case there exists an $d > 0$ such that the ring $r[g]$ is generated by $1, g, \ldots, g^d$ as an $r$-module. let $r \in r$ be a common denominator of the elements $1, g, \ldots, g^d \in k$. it follows that $rr[g] \subset r$, and hence $g$ is almost integral over $r$. \medskip\noindent suppose $r$ is noetherian and $g \in k$ is almost integral over $r$. let $r \in r$, $r\not = 0$ be as in the definition. then $r[g] \subset \frac{1}{r}r$ as an $r$-module. since $r$ is noetherian this implies that $r[g]$ is finite over $r$. hence $g$ is integral over $r$, see lemma \ref{lemma-finite-is-integral}. \end{proof} \begin{lemma} \label{lemma-localize-normal-domain} any localization of a normal domain is normal. \end{lemma} \begin{proof} let $r$ be a normal domain, and let $s \subset r$ be a multiplicative subset. suppose $g$ is an element of the fraction field of $r$ which is integral over $s^{-1}r$. let $p = x^d + \sum_{j < d} a_j x^j$ be a polynomial with $a_i \in s^{-1}r$ such that $p(g) = 0$. choose $s \in s$ such that $sa_i \in r$ for all $i$. then $sg$ satisfies the monic polynomial $x^d + \sum_{j < d} s^{d-j}a_j x^j$ which has coefficients $s^{d-j}a_j$ in $r$. hence $sg \in r$ because $r$ is normal. hence $g \in s^{-1}r$. \end{proof} \begin{lemma} \label{lemma-pid-normal} a principal ideal domain is normal. \end{lemma} \begin{proof} let $r$ be a principal ideal domain. let $g = a/b$ be an element of the fraction field of $r$ integral over $r$. because $r$ is a principal ideal domain we may divide out a common factor of $a$ and $b$ and assume $(a, b) = r$. in this case, any equation $(a/b)^n + r_{n-1} (a/b)^{n-1} + \ldots + r_0 = 0$ with $r_i \in r$ would imply $a^n \in (b)$. this contradicts $(a, b) = r$ unless $b$ is a unit in $r$. \end{proof} \begin{lemma} \label{lemma-prepare-polynomial-ring-normal} let $r$ be a domain with fraction field $k$. suppose $f = \sum \alpha_i x^i$ is an element of $k[x]$. \begin{enumerate} \item if $f$ is integral over $r[x]$ then all $\alpha_i$ are integral over $r$, and \item if $f$ is almost integral over $r[x]$ then all $\alpha_i$ are almost integral over $r$. \end{enumerate} \end{lemma} \begin{proof} we first prove the second statement. write $f = \alpha_0 + \alpha_1 x + \ldots + \alpha_r x^r$ with $\alpha_r \not = 0$. by assumption there exists $h = b_0 + b_1 x + \ldots + b_s x^s \in r[x]$, $b_s \not = 0$ such that $f^n h \in r[x]$ for all $n \geq 0$. this implies that $b_s \alpha_r^n \in r$ for all $n \geq 0$. hence $\alpha_r$ is almost integral over $r$. since the set of almost integral elements form a subring (lemma \ref{lemma-almost-integral}) we deduce that $f - \alpha_r x^r = \alpha_0 + \alpha_1 x + \ldots + \alpha_{r - 1} x^{r - 1}$ is almost integral over $r[x]$. by induction on $r$ we win. \medskip\noindent in order to prove the first statement we will use absolute noetherian reduction. namely, write $\alpha_i = a_i / b_i$ and let $p(t) = t^d + \sum_{j < d} f_j t^j$ be a polynomial with coefficients $f_j \in r[x]$ such that $p(f) = 0$. let $f_j = \sum f_{ji}x^i$. consider the subring $r_0 \subset r$ generated by the finite list of elements $a_i, b_i, f_{ji}$ of $r$. it is a domain; let $k_0$ be its field of fractions. since $r_0$ is a finite type $\mathbf{z}$-algebra it is noetherian, see lemma \ref{lemma-obvious-noetherian}. it is still the case that $f \in k_0[x]$ is integral over $r_0[x]$, because all the identities in $r$ among the elements $a_i, b_i, f_{ji}$ also hold in $r_0$. by lemma \ref{lemma-almost-integral} the element $f$ is almost integral over $r_0[x]$. by the second statement of the lemma, the elements $\alpha_i$ are almost integral over $r_0$. and since $r_0$ is noetherian, they are integral over $r_0$, see lemma \ref{lemma-almost-integral}. of course, then they are integral over $r$. \end{proof} \begin{lemma} \label{lemma-polynomial-domain-normal} let $r$ be a normal domain. then $r[x]$ is a normal domain. \end{lemma} \begin{proof} the result is true if $r$ is a field $k$ because $k[x]$ is a euclidean domain and hence a principal ideal domain and hence normal by lemma \ref{lemma-pid-normal}. let $g$ be an element of the fraction field of $r[x]$ which is integral over $r[x]$. because $g$ is integral over $k[x]$ where $k$ is the fraction field of $r$ we may write $g = \alpha_d x^d + \alpha_{d-1}x^{d-1} + \ldots + \alpha_0$ with $\alpha_i \in k$. by lemma \ref{lemma-prepare-polynomial-ring-normal} the elements $\alpha_i$ are integral over $r$ and hence are in $r$. \end{proof} \begin{lemma} \label{lemma-power-series-over-noetherian-normal-domain} let $r$ be a noetherian normal domain. then $r[[x]]$ is a noetherian normal domain. \end{lemma} \begin{proof} the power series ring is noetherian by lemma \ref{lemma-noetherian-power-series}. let $f, g \in r[[x]]$ be nonzero elements such that $w = f/g$ is integral over $r[[x]]$. let $k$ be the fraction field of $r$. since the ring of laurent series $k((x)) = k[[x]][1/x]$ is a field, we can write $w = a_n x^n + a_{n + 1} x^{n + 1} + \ldots$ for some $n \in \mathbf{z}$, $a_i \in k$, and $a_n \not = 0$. by lemma \ref{lemma-almost-integral} we see there exists a nonzero element $h = b_m x^m + b_{m + 1} x^{m + 1} + \ldots$ in $r[[x]]$ with $b_m \not = 0$ such that $w^e h \in r[[x]]$ for all $e \geq 1$. we conclude that $n \geq 0$ and that $b_m a_n^e \in r$ for all $e \geq 1$. since $r$ is noetherian this implies that $a_n \in r$ by the same lemma. now, if $a_n, a_{n + 1}, \ldots, a_{n - 1} \in r$, then we can apply the same argument to $w - a_n x^n - \ldots - a_{n - 1} x^{n - 1} = a_n x^n + \ldots$. in this way we see that all $a_i \in r$ and the lemma is proved. \end{proof} \begin{lemma} \label{lemma-normality-is-local} let $r$ be a domain. the following are equivalent: \begin{enumerate} \item the domain $r$ is a normal domain, \item for every prime $\mathfrak p \subset r$ the local ring $r_{\mathfrak p}$ is a normal domain, and \item for every maximal ideal $\mathfrak m$ the ring $r_{\mathfrak m}$ is a normal domain. \end{enumerate} \end{lemma} \begin{proof} we deduce (1) $\rightarrow$ (2) from lemma \ref{lemma-localize-normal-domain}. the implication (2) $\rightarrow$ (3) is immediate. the implication (3) $\rightarrow$ (1) follows from the fact that for any domain $r$ we have $$ r = \bigcap\nolimits_{\mathfrak m} r_{\mathfrak m} $$ inside the fraction field of $r$. namely, if $g$ is an element of the right hand side then the ideal $i = \{x \in r \mid xg \in r\}$ is not contained in any maximal ideal $\mathfrak m$, whence $i = r$. \end{proof} \noindent lemma \ref{lemma-normality-is-local} shows that the following definition is compatible with definition \ref{definition-domain-normal}. (it is the definition from ega -- see \cite[iv, 5.13.5 and 0, 4.1.4]{ega}.) \begin{definition} \label{definition-ring-normal} a ring $r$ is called {\it normal} if for every prime $\mathfrak p \subset r$ the localization $r_{\mathfrak p}$ is a normal domain (see definition \ref{definition-domain-normal}). \end{definition} \noindent note that a normal ring is a reduced ring, as $r$ is a subring of the product of its localizations at all primes (see for example lemma \ref{lemma-characterize-zero-local}). \begin{lemma} \label{lemma-normal-ring-integrally-closed} a normal ring is integrally closed in its total ring of fractions. \end{lemma} \begin{proof} let $r$ be a normal ring. let $x \in q(r)$ be an element of the total ring of fractions of $r$ integral over $r$. set $i = \{f \in r, fx \in r\}$. let $\mathfrak p \subset r$ be a prime. as $r \to r_{\mathfrak p}$ is flat we see that $r_{\mathfrak p} \subset q(r) \otimes_r r_{\mathfrak p}$. as $r_{\mathfrak p}$ is a normal domain we see that $x \otimes 1$ is an element of $r_{\mathfrak p}$. hence we can find $a, f \in r$, $f \not \in \mathfrak p$ such that $x \otimes 1 = a \otimes 1/f$. this means that $fx - a$ maps to zero in $q(r) \otimes_r r_{\mathfrak p} = q(r)_{\mathfrak p}$, which in turn means that there exists an $f' \in r$, $f' \not \in \mathfrak p$ such that $f'fx = f'a$ in $r$. in other words, $ff' \in i$. thus $i$ is an ideal which isn't contained in any of the prime ideals of $r$, i.e., $i = r$ and $x \in r$. \end{proof} \begin{lemma} \label{lemma-localization-normal-ring} a localization of a normal ring is a normal ring. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-polynomial-ring-normal} let $r$ be a normal ring. then $r[x]$ is a normal ring. \end{lemma} \begin{proof} let $\mathfrak q$ be a prime of $r[x]$. set $\mathfrak p = r \cap \mathfrak q$. then we see that $r_{\mathfrak p}[x]$ is a normal domain by lemma \ref{lemma-polynomial-domain-normal}. hence $(r[x])_{\mathfrak q}$ is a normal domain by lemma \ref{lemma-localize-normal-domain}. \end{proof} \begin{lemma} \label{lemma-finite-product-normal} a finite product of normal rings is normal. \end{lemma} \begin{proof} it suffices to show that the product of two normal rings, say $r$ and $s$, is normal. by lemma \ref{lemma-disjoint-decomposition} the prime ideals of $r\times s$ are of the form $\mathfrak{p}\times s$ and $r\times \mathfrak{q}$, where $\mathfrak{p}$ and $\mathfrak{q}$ are primes of $r$ and $s$ respectively. localization yields $(r\times s)_{\mathfrak{p}\times s}=r_{\mathfrak{p}}$ which is a normal domain by assumption. similarly for $s$. \end{proof} \begin{lemma} \label{lemma-characterize-reduced-ring-normal} let $r$ be a ring. assume $r$ is reduced and has finitely many minimal primes. then the following are equivalent: \begin{enumerate} \item $r$ is a normal ring, \item $r$ is integrally closed in its total ring of fractions, and \item $r$ is a finite product of normal domains. \end{enumerate} \end{lemma} \begin{proof} the implications (1) $\rightarrow$ (2) and (3) $\rightarrow$ (1) hold in general, see lemmas \ref{lemma-normal-ring-integrally-closed} and \ref{lemma-finite-product-normal}. \medskip\noindent let $\mathfrak p_1, \ldots, \mathfrak p_n$ be the minimal primes of $r$. by lemmas \ref{lemma-reduced-ring-sub-product-fields} and \ref{lemma-total-ring-fractions-no-embedded-points} we have $q(r) = r_{\mathfrak p_1} \times \ldots \times r_{\mathfrak p_n}$, and by lemma \ref{lemma-minimal-prime-reduced-ring} each factor is a field. denote $e_i = (0, \ldots, 0, 1, 0, \ldots, 0)$ the $i$th idempotent of $q(r)$. \medskip\noindent if $r$ is integrally closed in $q(r)$, then it contains in particular the idempotents $e_i$, and we see that $r$ is a product of $n$ domains (see sections \ref{section-connected-components} and \ref{section-tilde-module-sheaf}). each factor is of the form $r/\mathfrak p_i$ with field of fractions $r_{\mathfrak p_i}$. by lemma \ref{lemma-finite-product-integral-closure} each map $r/\mathfrak p_i \to r_{\mathfrak p_i}$ is integrally closed. hence $r$ is a finite product of normal domains. \end{proof} \begin{lemma} \label{lemma-colimit-normal-ring} let $(r_i, \varphi_{ii'})$ be a directed system (categories, definition \ref{definition-directed-system}) of rings. if each $r_i$ is a normal ring so is $r = \colim_i r_i$. \end{lemma} \begin{proof} let $\mathfrak p \subset r$ be a prime ideal. set $\mathfrak p_i = r_i \cap \mathfrak p$ (usual abuse of notation). then we see that $r_{\mathfrak p} = \colim_i (r_i)_{\mathfrak p_i}$. since each $(r_i)_{\mathfrak p_i}$ is a normal domain we reduce to proving the statement of the lemma for normal domains. if $a, b \in r$ and $a/b$ satisfies a monic polynomial $p(t) \in r[t]$, then we can find a (sufficiently large) $i \in i$ such that $a, b$ come from objects $a_i, b_i$ over $r_i$, $p$ comes from a monic polynomial $p_i\in r_i[t]$ and $p_i(a_i/b_i)=0$. since $r_i$ is normal we see $a_i/b_i \in r_i$ and hence also $a/b \in r$. \end{proof} \section{going down for integral over normal} \label{section-going-down-integral-over-normal} \noindent we first play around a little bit with the notion of elements integral over an ideal, and then we prove the theorem referred to in the section title. \begin{definition} \label{definition-integral-over-ideal} let $\varphi : r \to s$ be a ring map. let $i \subset r$ be an ideal. we say an element $g \in s$ is {\it integral over $i$} if there exists a monic polynomial $p = x^d + \sum_{j < d} a_j x^j$ with coefficients $a_j \in i^{d-j}$ such that $p^\varphi(g) = 0$ in $s$. \end{definition} \noindent this is mostly used when $\varphi = \text{id}_r : r \to r$. in this case the set $i'$ of elements integral over $i$ is called the {\it integral closure of $i$}. we will see that $i'$ is an ideal of $r$ (and of course $i \subset i'$). \begin{lemma} \label{lemma-characterize-integral-ideal} let $\varphi : r \to s$ be a ring map. let $i \subset r$ be an ideal. let $a = \sum i^nt^n \subset r[t]$ be the subring of the polynomial ring generated by $r \oplus it \subset r[t]$. an element $s \in s$ is integral over $i$ if and only if the element $st \in s[t]$ is integral over $a$. \end{lemma} \begin{proof} suppose $st$ is integral over $a$. let $p = x^d + \sum_{j < d} a_j x^j$ be a monic polynomial with coefficients in $a$ such that $p^\varphi(st) = 0$. let $a_j' \in a$ be the degree $d-j$ part of $a_j$, in other words $a_j' = a_j'' t^{d-j}$ with $a_j'' \in i^{d-j}$. for degree reasons we still have $(st)^d + \sum_{j < d} \varphi(a_j'') t^{d-j} (st)^j = 0$. hence $s^d + \sum_{j < d} \varphi(a_j'') s^j = 0$ and we see that $s$ is integral over $i$. \medskip\noindent suppose that $s$ is integral over $i$. say $p = x^d + \sum_{j < d} a_j x^j$ with $a_j \in i^{d-j}$. then we immediately find a polynomial $q = x^d + \sum_{j < d} (a_j t^{d-j}) x^j$ with coefficients in $a$ which proves that $st$ is integral over $a$. \end{proof} \begin{lemma} \label{lemma-integral-over-ideal-is-submodule} let $\varphi : r \to s$ be a ring map. let $i \subset r$ be an ideal. the set of elements of $s$ which are integral over $i$ form a $r$-submodule of $s$. furthermore, if $s \in s$ is integral over $r$, and $s'$ is integral over $i$, then $ss'$ is integral over $i$. \end{lemma} \begin{proof} we will use lemma \ref{lemma-integral-closure-is-ring} without further mention. closure under addition is clear from the characterization of lemma \ref{lemma-characterize-integral-ideal} whose notation we adopt. any element $s \in s$ which is integral over $r$ corresponds to the degree $0$ element $s$ of $s[t]$ which is integral over $a$ (because $r \subset a$). hence we see that multiplication by $s$ on $s[t]$ preserves the property of being integral over $a$, \end{proof} \begin{lemma} \label{lemma-integral-integral-over-ideal} suppose $\varphi : r \to s$ is integral. suppose $i \subset r$ is an ideal. then every element of $is$ is integral over $i$. \end{lemma} \begin{proof} immediate from lemma \ref{lemma-integral-over-ideal-is-submodule}. \end{proof} \begin{lemma} \label{lemma-polynomials-divide} let $k$ be a field. let $n, m \in \mathbf{n}$ and $a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1} \in k$. if the polynomial $x^n + a_{n - 1}x^{n - 1} + \ldots + a_0$ divides the polynomial $x^m + b_{m - 1} x^{m - 1} + \ldots + b_0$ in $k[x]$ then \begin{enumerate} \item $a_0, \ldots, a_{n - 1}$ are integral over any subring $r_0$ of $k$ containing the elements $b_0, \ldots, b_{m - 1}$, and \item each $a_i$ lies in $\sqrt{(b_0, \ldots, b_{m-1})r}$ for any subring $r \subset k$ containing the elements $a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1}$. \end{enumerate} \end{lemma} \begin{proof} let $l/k$ be a field extension such that we can write $x^m + b_{m - 1} x^{m - 1} + \ldots + b_0 = \prod_{i = 1}^m (x - \beta_i)$ with $\beta_i \in l$. see fields, section \ref{fields-section-splitting-fieds}. each $\beta_i$ is integral over $r_0$. since each $a_i$ is a homogeneous polynomial in $\beta_1, \ldots, \beta_m$ we deduce the same for the $a_i$ (use lemma \ref{lemma-integral-closure-is-ring}). \medskip\noindent choose $c_0, \ldots, c_{m - n - 1} \in k$ such that $$ \begin{matrix} x^m + b_{m - 1} x^{m - 1} + \ldots + b_0 = \\ (x^n + a_{n - 1}x^{n - 1} + \ldots + a_0) (x^{m - n} + c_{m - n - 1}x^{m - n - 1}+ \ldots + c_0). \end{matrix} $$ by part (1) the elements $c_i$ are integral over $r$. consider the integral extension $$ r \subset r' = r[c_0, \ldots, c_{m - n - 1}] \subset k $$ by lemmas \ref{lemma-integral-overring-surjective} and \ref{lemma-surjective-spec-radical-ideal} we see that $r \cap \sqrt{(b_0, \ldots, b_{m - 1})r'} = \sqrt{(b_0, \ldots, b_{m - 1})r}$. thus we may replace $r$ by $r'$ and assume $c_i \in r$. dividing out the radical $\sqrt{(b_0, \ldots, b_{m - 1})}$ we get a reduced ring $\overline{r}$. we have to show that the images $\overline{a}_i \in \overline{r}$ are zero. and in $\overline{r}[x]$ we have the relation $$ \begin{matrix} x^m = x^m + \overline{b}_{m - 1} x^{m - 1} + \ldots + \overline{b}_0 = \\ (x^n + \overline{a}_{n - 1}x^{n - 1} + \ldots + \overline{a}_0) (x^{m - n} + \overline{c}_{m - n - 1}x^{m - n - 1}+ \ldots + \overline{c}_0). \end{matrix} $$ it is easy to see that this implies $\overline{a}_i = 0$ for all $i$. indeed by lemma \ref{lemma-minimal-prime-reduced-ring} the localization of $\overline{r}$ at a minimal prime $\mathfrak{p}$ is a field and $\overline{r}_{\mathfrak p}[x]$ a ufd. thus $f = x^n + \sum \overline{a}_i x^i$ is associated to $x^n$ and since $f$ is monic $f = x^n$ in $\overline{r}_{\mathfrak p}[x]$. then there exists an $s \in \overline{r}$, $s \not\in \mathfrak p$ such that $s(f - x^n) = 0$. therefore all $\overline{a}_i$ lie in $\mathfrak p$ and we conclude by lemma \ref{lemma-reduced-ring-sub-product-fields}. \end{proof} \begin{lemma} \label{lemma-minimal-polynomial-normal-domain} let $r \subset s$ be an inclusion of domains. assume $r$ is normal. let $g \in s$ be integral over $r$. then the minimal polynomial of $g$ has coefficients in $r$. \end{lemma} \begin{proof} let $p = x^m + b_{m-1} x^{m-1} + \ldots + b_0$ be a polynomial with coefficients in $r$ such that $p(g) = 0$. let $q = x^n + a_{n-1}x^{n-1} + \ldots + a_0$ be the minimal polynomial for $g$ over the fraction field $k$ of $r$. then $q$ divides $p$ in $k[x]$. by lemma \ref{lemma-polynomials-divide} we see the $a_i$ are integral over $r$. since $r$ is normal this means they are in $r$. \end{proof} \begin{proposition} \label{proposition-going-down-normal-integral} let $r \subset s$ be an inclusion of domains. assume $r$ is normal and $s$ integral over $r$. let $\mathfrak p \subset \mathfrak p' \subset r$ be primes. let $\mathfrak q'$ be a prime of $s$ with $\mathfrak p' = r \cap \mathfrak q'$. then there exists a prime $\mathfrak q$ with $\mathfrak q \subset \mathfrak q'$ such that $\mathfrak p = r \cap \mathfrak q$. in other words: the going down property holds for $r \to s$, see definition \ref{definition-going-up-down}. \end{proposition} \begin{proof} let $\mathfrak p$, $\mathfrak p'$ and $\mathfrak q'$ be as in the statement. we have to show there is a prime $\mathfrak q$, with $\mathfrak q \subset \mathfrak q'$ and $r \cap \mathfrak q = \mathfrak p$. this is the same as finding a prime of $s_{\mathfrak q'}$ mapping to $\mathfrak p$. according to lemma \ref{lemma-in-image} we have to show that $\mathfrak p s_{\mathfrak q'} \cap r = \mathfrak p$. pick $z \in \mathfrak p s_{\mathfrak q'} \cap r$. we may write $z = y/g$ with $y \in \mathfrak ps$ and $g \in s$, $g \not\in \mathfrak q'$. written differently we have $zg = y$. \medskip\noindent by lemma \ref{lemma-integral-integral-over-ideal} there exists a monic polynomial $p = x^m + b_{m-1} x^{m-1} + \ldots + b_0$ with $b_i \in \mathfrak p$ such that $p(y) = 0$. \medskip\noindent by lemma \ref{lemma-minimal-polynomial-normal-domain} the minimal polynomial of $g$ over $k$ has coefficients in $r$. write it as $q = x^n + a_{n-1} x^{n-1} + \ldots + a_0$. note that not all $a_i$, $i = n-1, \ldots, 0$ are in $\mathfrak p$ since that would imply $g^n = \sum_{j < n} a_j g^j \in \mathfrak ps \subset \mathfrak p's \subset \mathfrak q'$ which is a contradiction. \medskip\noindent since $y = zg$ we see immediately from the above that $q' = x^n + za_{n-1} x^{n-1} + \ldots + z^{n}a_0$ is the minimal polynomial for $y$. hence $q'$ divides $p$ and by lemma \ref{lemma-polynomials-divide} we see that $z^ja_{n - j} \in \sqrt{(b_0, \ldots, b_{m-1})} \subset \mathfrak p$, $j = 1, \ldots, n$. because not all $a_i$, $i = n-1, \ldots, 0$ are in $\mathfrak p$ we conclude $z \in \mathfrak p$ as desired. \end{proof} \section{flat modules and flat ring maps} \label{section-flat} \noindent one often used result is that if $m = \colim_{i\in \mathcal{i}} m_i$ is a colimit of $r$-modules and if $n$ is an $r$-module then $$ m \otimes n = \colim_{i\in \mathcal{i}} m_i \otimes_r n, $$ see lemma \ref{lemma-tensor-products-commute-with-limits}. this property is usually expressed by saying that {\it $\otimes$ commutes with colimits}. another often used result is that if $0 \to n_1 \to n_2 \to n_3 \to 0$ is an exact sequence and if $m$ is any $r$-module, then $$ m \otimes_r n_1 \to m \otimes_r n_2 \to m \otimes_r n_3 \to 0 $$ is still exact, see lemma \ref{lemma-tensor-product-exact}. both of these properties tell us that the functor $n \mapsto m \otimes_r n$ {\it is right exact}. see categories, section \ref{categories-section-exact-functor} and homology, section \ref{homology-section-functors}. an $r$-module $m$ is flat if $n \mapsto n \otimes_r m$ is also left exact, i.e., if it is exact. here is the precise definition. \begin{definition} \label{definition-flat} let $r$ be a ring. \begin{enumerate} \item an $r$-module $m$ is called {\it flat} if whenever $n_1 \to n_2 \to n_3$ is an exact sequence of $r$-modules the sequence $m \otimes_r n_1 \to m \otimes_r n_2 \to m \otimes_r n_3$ is exact as well. \item an $r$-module $m$ is called {\it faithfully flat} if the complex of $r$-modules $n_1 \to n_2 \to n_3$ is exact if and only if the sequence $m \otimes_r n_1 \to m \otimes_r n_2 \to m \otimes_r n_3$ is exact. \item a ring map $r \to s$ is called {\it flat} if $s$ is flat as an $r$-module. \item a ring map $r \to s$ is called {\it faithfully flat} if $s$ is faithfully flat as an $r$-module. \end{enumerate} \end{definition} \noindent here is an example of how you can use the flatness condition. \begin{lemma} \label{lemma-flat-intersect-ideals} let $r$ be a ring. let $i, j \subset r$ be ideals. let $m$ be a flat $r$-module. then $im \cap jm = (i \cap j)m$. \end{lemma} \begin{proof} consider the exact sequence $0 \to i \cap j \to r \to r/i \oplus r/j$. tensoring with the flat module $m$ we obtain an exact sequence $$ 0 \to (i \cap j) \otimes_r m \to m \to m/im \oplus m/jm $$ since the kernel of $m \to m/im \oplus m/jm$ is equal to $im \cap jm$ we conclude. \end{proof} \begin{lemma} \label{lemma-colimit-flat} let $r$ be a ring. let $\{m_i, \varphi_{ii'}\}$ be a directed system of flat $r$-modules. then $\colim_i m_i$ is a flat $r$-module. \end{lemma} \begin{proof} this follows as $\otimes$ commutes with colimits and because directed colimits are exact, see lemma \ref{lemma-directed-colimit-exact}. \end{proof} \begin{lemma} \label{lemma-composition-flat} a composition of (faithfully) flat ring maps is (faithfully) flat. if $r \to r'$ is (faithfully) flat, and $m'$ is a (faithfully) flat $r'$-module, then $m'$ is a (faithfully) flat $r$-module. \end{lemma} \begin{proof} the first statement of the lemma is a particular case of the second, so it is clearly enough to prove the latter. let $r \to r'$ be a flat ring map, and $m'$ a flat $r'$-module. we need to prove that $m'$ is a flat $r$-module. let $n_1 \to n_2 \to n_3$ be an exact complex of $r$-modules. then, the complex $r' \otimes_r n_1 \to r' \otimes_r n_2 \to r' \otimes_r n_3$ is exact (since $r'$ is flat as an $r$-module), and so the complex $m' \otimes_{r'} \left(r' \otimes_r n_1\right) \to m' \otimes_{r'} \left(r' \otimes_r n_2\right) \to m' \otimes_{r'} \left(r' \otimes_r n_3\right)$ is exact (since $m'$ is a flat $r'$-module). since $m' \otimes_{r'} \left(r' \otimes_r n\right) \cong \left(m' \otimes_{r'} r'\right) \otimes_r n \cong m' \otimes_r n$ for any $r$-module $n$ functorially (by lemmas \ref{lemma-tensor-with-bimodule} and \ref{lemma-flip-tensor-product}), this complex is isomorphic to the complex $m' \otimes_r n_1 \to m' \otimes_r n_2 \to m' \otimes_r n_3$, which is therefore also exact. this shows that $m'$ is a flat $r$-module. tracing this argument backwards, we can show that if $r \to r'$ is faithfully flat, and if $m'$ is faithfully flat as an $r'$-module, then $m'$ is faithfully flat as an $r$-module. \end{proof} \begin{lemma} \label{lemma-flat} let $m$ be an $r$-module. the following are equivalent: \begin{enumerate} \item \label{item-flat} $m$ is flat over $r$. \item \label{item-injective} for every injection of $r$-modules $n \subset n'$ the map $n \otimes_r m \to n'\otimes_r m$ is injective. \item \label{item-f-ideal} for every ideal $i \subset r$ the map $i \otimes_r m \to r \otimes_r m = m$ is injective. \item \label{item-ffg-ideal} for every finitely generated ideal $i \subset r$ the map $i \otimes_r m \to r \otimes_r m = m$ is injective. \end{enumerate} \end{lemma} \begin{proof} the implications (\ref{item-flat}) implies (\ref{item-injective}) implies (\ref{item-f-ideal}) implies (\ref{item-ffg-ideal}) are all trivial. thus we prove (\ref{item-ffg-ideal}) implies (\ref{item-flat}). suppose that $n_1 \to n_2 \to n_3$ is exact. let $k = \ker(n_2 \to n_3)$ and $q = \im(n_2 \to n_3)$. then we get maps $$ n_1 \otimes_r m \to k \otimes_r m \to n_2 \otimes_r m \to q \otimes_r m \to n_3 \otimes_r m $$ observe that the first and third arrows are surjective. thus if we show that the second and fourth arrows are injective, then we are done\footnote{here is the argument in more detail: assume that we know that the second and fourth arrows are injective. lemma \ref{lemma-tensor-product-exact} (applied to the exact sequence $k \to n_2 \to q \to 0$) yields that the sequence $k \otimes_r m \to n_2 \otimes_r m \to q \otimes_r m \to 0$ is exact. hence, $\ker \left(n_2 \otimes_r m \to q \otimes_r m\right) = \im \left(k \otimes_r m \to n_2 \otimes_r m\right)$. since $\im \left(k \otimes_r m \to n_2 \otimes_r m\right) = \im \left(n_1 \otimes_r m \to n_2 \otimes_r m\right)$ (due to the surjectivity of $n_1 \otimes_r m \to k \otimes_r m$) and $\ker \left(n_2 \otimes_r m \to q \otimes_r m\right) = \ker \left(n_2 \otimes_r m \to n_3 \otimes_r m\right)$ (due to the injectivity of $q \otimes_r m \to n_3 \otimes_r m$), this becomes $\ker \left(n_2 \otimes_r m \to n_3 \otimes_r m\right) = \im \left(n_1 \otimes_r m \to n_2 \otimes_r m\right)$, which shows that the functor $- \otimes_r m$ is exact, whence $m$ is flat.}. hence it suffices to show that $- \otimes_r m$ transforms injective $r$-module maps into injective $r$-module maps. \medskip\noindent assume $k \to n$ is an injective $r$-module map and let $x \in \ker(k \otimes_r m \to n \otimes_r m)$. we have to show that $x$ is zero. the $r$-module $k$ is the union of its finite $r$-submodules; hence, $k \otimes_r m$ is the colimit of $r$-modules of the form $k_i \otimes_r m$ where $k_i$ runs over all finite $r$-submodules of $k$ (because tensor product commutes with colimits). thus, for some $i$ our $x$ comes from an element $x_i \in k_i \otimes_r m$. thus we may assume that $k$ is a finite $r$-module. assume this. we regard the injection $k \to n$ as an inclusion, so that $k \subset n$. \medskip\noindent the $r$-module $n$ is the union of its finite $r$-submodules that contain $k$. hence, $n \otimes_r m$ is the colimit of $r$-modules of the form $n_i \otimes_r m$ where $n_i$ runs over all finite $r$-submodules of $n$ that contain $k$ (again since tensor product commutes with colimits). notice that this is a colimit over a directed system (since the sum of two finite submodules of $n$ is again finite). hence, (by lemma \ref{lemma-zero-directed-limit}) the element $x \in k \otimes_r m$ maps to zero in at least one of these $r$-modules $n_i \otimes_r m$ (since $x$ maps to zero in $n \otimes_r m$). thus we may assume $n$ is a finite $r$-module. \medskip\noindent assume $n$ is a finite $r$-module. write $n = r^{\oplus n}/l$ and $k = l'/l$ for some $l \subset l' \subset r^{\oplus n}$. for any $r$-submodule $g \subset r^{\oplus n}$, we have a canonical map $g \otimes_r m \to m^{\oplus n}$ obtained by composing $g \otimes_r m \to r^n \otimes_r m = m^{\oplus n}$. it suffices to prove that $l \otimes_r m \to m^{\oplus n}$ and $l' \otimes_r m \to m^{\oplus n}$ are injective. namely, if so, then we see that $k \otimes_r m = l' \otimes_r m/l \otimes_r m \to m^{\oplus n}/l \otimes_r m$ is injective too\footnote{this becomes obvious if we identify $l' \otimes_r m$ and $l \otimes_r m$ with submodules of $m^{\oplus n}$ (which is legitimate since the maps $l \otimes_r m \to m^{\oplus n}$ and $l' \otimes_r m \to m^{\oplus n}$ are injective and commute with the obvious map $l' \otimes_r m \to l \otimes_r m$).}. \medskip\noindent thus it suffices to show that $l \otimes_r m \to m^{\oplus n}$ is injective when $l \subset r^{\oplus n}$ is an $r$-submodule. we do this by induction on $n$. the base case $n = 1$ we handle below. for the induction step assume $n > 1$ and set $l' = l \cap r \oplus 0^{\oplus n - 1}$. then $l'' = l/l'$ is a submodule of $r^{\oplus n - 1}$. we obtain a diagram $$ \xymatrix{ & l' \otimes_r m \ar[r] \ar[d] & l \otimes_r m \ar[r] \ar[d] & l'' \otimes_r m \ar[r] \ar[d] & 0 \\ 0 \ar[r] & m \ar[r] & m^{\oplus n} \ar[r] & m^{\oplus n - 1} \ar[r] & 0 } $$ by induction hypothesis and the base case the left and right vertical arrows are injective. the rows are exact. it follows that the middle vertical arrow is injective too. \medskip\noindent the base case of the induction above is when $l \subset r$ is an ideal. in other words, we have to show that $i \otimes_r m \to m$ is injective for any ideal $i$ of $r$. we know this is true when $i$ is finitely generated. however, $i = \bigcup i_\alpha$ is the union of the finitely generated ideals $i_\alpha$ contained in it. in other words, $i = \colim i_\alpha$. since $\otimes$ commutes with colimits we see that $i \otimes_r m = \colim i_\alpha \otimes_r m$ and since all the morphisms $i_\alpha \otimes_r m \to m$ are injective by assumption, the same is true for $i \otimes_r m \to m$. \end{proof} \begin{lemma} \label{lemma-colimit-rings-flat} let $\{r_i, \varphi_{ii'}\}$ be a system of rings over the directed set $i$. let $r = \colim_i r_i$. \begin{enumerate} \item if $m$ is an $r$-module such that $m$ is flat as an $r_i$-module for all $i$, then $m$ is flat as an $r$-module. \item for $i \in i$ let $m_i$ be a flat $r_i$-module and for $i' \geq i$ let $f_{ii'} : m_i \to m_{i'}$ be a $\varphi_{ii'}$-linear map such that $f_{i' i''} \circ f_{i i'} = f_{i i''}$. then $m = \colim_{i \in i} m_i$ is a flat $r$-module. \end{enumerate} \end{lemma} \begin{proof} part (1) is a special case of part (2) with $m_i = m$ for all $i$ and $f_{i i'} = \text{id}_m$. proof of (2). let $\mathfrak a \subset r$ be a finitely generated ideal. by lemma \ref{lemma-flat} it suffices to show that $\mathfrak a \otimes_r m \to m$ is injective. we can find an $i \in i$ and a finitely generated ideal $\mathfrak a' \subset r_i$ such that $\mathfrak a = \mathfrak a'r$. then $\mathfrak a = \colim_{i' \geq i} \mathfrak a'r_{i'}$. since $\otimes$ commutes with colimits the map $\mathfrak a \otimes_r m \to m$ is the colimit of the maps $$ \mathfrak a'r_{i'} \otimes_{r_{i'}} m_{i'} \longrightarrow m_{i'} $$ these maps are all injective by assumption. since colimits over $i$ are exact by lemma \ref{lemma-directed-colimit-exact} we win. \end{proof} \begin{lemma} \label{lemma-flat-base-change} suppose that $m$ is (faithfully) flat over $r$, and that $r \to r'$ is a ring map. then $m \otimes_r r'$ is (faithfully) flat over $r'$. \end{lemma} \begin{proof} for any $r'$-module $n$ we have a canonical isomorphism $n \otimes_{r'} (r'\otimes_r m) = n \otimes_r m$. hence the desired exactness properties of the functor $-\otimes_{r'}(r'\otimes_r m)$ follow from the corresponding exactness properties of the functor $-\otimes_r m$. \end{proof} \begin{lemma} \label{lemma-flatness-descends} let $r \to r'$ be a faithfully flat ring map. let $m$ be a module over $r$, and set $m' = r' \otimes_r m$. then $m$ is flat over $r$ if and only if $m'$ is flat over $r'$. \end{lemma} \begin{proof} by lemma \ref{lemma-flat-base-change} we see that if $m$ is flat then $m'$ is flat. for the converse, suppose that $m'$ is flat. let $n_1 \to n_2 \to n_3$ be an exact sequence of $r$-modules. we want to show that $n_1 \otimes_r m \to n_2 \otimes_r m \to n_3 \otimes_r m$ is exact. we know that $n_1 \otimes_r r' \to n_2 \otimes_r r' \to n_3 \otimes_r r'$ is exact, because $r \to r'$ is flat. flatness of $m'$ implies that $n_1 \otimes_r r' \otimes_{r'} m' \to n_2 \otimes_r r' \otimes_{r'} m' \to n_3 \otimes_r r' \otimes_{r'} m'$ is exact. we may write this as $n_1 \otimes_r m \otimes_r r' \to n_2 \otimes_r m \otimes_r r' \to n_3 \otimes_r m \otimes_r r'$. finally, faithful flatness implies that $n_1 \otimes_r m \to n_2 \otimes_r m \to n_3 \otimes_r m$ is exact. \end{proof} \begin{lemma} \label{lemma-flatness-descends-more-general} let $r$ be a ring. let $s \to s'$ be a flat map of $r$-algebras. let $m$ be a module over $s$, and set $m' = s' \otimes_s m$. \begin{enumerate} \item if $m$ is flat over $r$, then $m'$ is flat over $r$. \item if $s \to s'$ is faithfully flat, then $m$ is flat over $r$ if and only if $m'$ is flat over $r$. \end{enumerate} \end{lemma} \begin{proof} let $n \to n'$ be an injection of $r$-modules. by the flatness of $s \to s'$ we have $$ \ker(n \otimes_r m \to n' \otimes_r m) \otimes_s s' = \ker(n \otimes_r m' \to n' \otimes_r m') $$ if $m$ is flat over $r$, then the left hand side is zero and we find that $m'$ is flat over $r$ by the second characterization of flatness in lemma \ref{lemma-flat}. if $m'$ is flat over $r$ then we have the vanishing of the right hand side and if in addition $s \to s'$ is faithfully flat, this implies that $\ker(n \otimes_r m \to n' \otimes_r m)$ is zero which in turn shows that $m$ is flat over $r$. \end{proof} \begin{lemma} \label{lemma-flat-permanence} let $r \to s$ be a ring map. let $m$ be an $s$-module. if $m$ is flat as an $r$-module and faithfully flat as an $s$-module, then $r \to s$ is flat. \end{lemma} \begin{proof} let $n_1 \to n_2 \to n_3$ be an exact sequence of $r$-modules. by assumption $n_1 \otimes_r m \to n_2 \otimes_r m \to n_3 \otimes_r m$ is exact. we may write this as $$ n_1 \otimes_r s \otimes_s m \to n_2 \otimes_r s \otimes_s m \to n_3 \otimes_r s \otimes_s m. $$ by faithful flatness of $m$ over $s$ we conclude that $n_1 \otimes_r s \to n_2 \otimes_r s \to n_3 \otimes_r s$ is exact. hence $r \to s$ is flat. \end{proof} \noindent let $r$ be a ring. let $m$ be an $r$-module. let $\sum f_i x_i = 0$ be a relation in $m$. we say the relation $\sum f_i x_i$ is {\it trivial} if there exist an integer $m \geq 0$, elements $y_j \in m$, $j = 1, \ldots, m$, and elements $a_{ij} \in r$, $i = 1, \ldots, n$, $j = 1, \ldots, m$ such that $$ x_i = \sum\nolimits_j a_{ij} y_j, \forall i, \quad\text{and}\quad 0 = \sum\nolimits_i f_ia_{ij}, \forall j. $$ \begin{lemma}[equational criterion of flatness] \label{lemma-flat-eq} a module $m$ over $r$ is flat if and only if every relation in $m$ is trivial. \end{lemma} \begin{proof} assume $m$ is flat and let $\sum f_i x_i = 0$ be a relation in $m$. let $i = (f_1, \ldots, f_n)$, and let $k = \ker(r^n \to i, (a_1, \ldots, a_n) \mapsto \sum_i a_i f_i)$. so we have the short exact sequence $0 \to k \to r^n \to i \to 0$. then $\sum f_i \otimes x_i$ is an element of $i \otimes_r m$ which maps to zero in $r \otimes_r m = m$. by flatness $\sum f_i \otimes x_i$ is zero in $i \otimes_r m$. thus there exists an element of $k \otimes_r m$ mapping to $\sum e_i \otimes x_i \in r^n \otimes_r m$ where $e_i$ is the $i$th basis element of $r^n$. write this element as $\sum k_j \otimes y_j$ and then write the image of $k_j$ in $r^n$ as $\sum a_{ij} e_i$ to get the result. \medskip\noindent assume every relation is trivial, let $i$ be a finitely generated ideal, and let $x = \sum f_i \otimes x_i$ be an element of $i \otimes_r m$ mapping to zero in $r \otimes_r m = m$. this just means exactly that $\sum f_i x_i$ is a relation in $m$. and the fact that it is trivial implies easily that $x$ is zero, because $$ x = \sum f_i \otimes x_i = \sum f_i \otimes \left(\sum a_{ij}y_j\right) = \sum \left(\sum f_i a_{ij}\right) \otimes y_j = 0 $$ \end{proof} \begin{lemma} \label{lemma-flat-tor-zero} suppose that $r$ is a ring, $0 \to m'' \to m' \to m \to 0$ a short exact sequence, and $n$ an $r$-module. if $m$ is flat then $n \otimes_r m'' \to n \otimes_r m'$ is injective, i.e., the sequence $$ 0 \to n \otimes_r m'' \to n \otimes_r m' \to n \otimes_r m \to 0 $$ is a short exact sequence. \end{lemma} \begin{proof} let $r^{(i)} \to n$ be a surjection from a free module onto $n$ with kernel $k$. the result follows from the snake lemma applied to the following diagram $$ \begin{matrix} & & 0 & & 0 & & 0 & & \\ & & \uparrow & & \uparrow & & \uparrow & & \\ & & m''\otimes_r n & \to & m' \otimes_r n & \to & m \otimes_r n & \to & 0 \\ & & \uparrow & & \uparrow & & \uparrow & & \\ 0 & \to & (m'')^{(i)} & \to & (m')^{(i)} & \to & m^{(i)} & \to & 0 \\ & & \uparrow & & \uparrow & & \uparrow & & \\ & & m''\otimes_r k & \to & m' \otimes_r k & \to & m \otimes_r k & \to & 0 \\ & & & & & & \uparrow & & \\ & & & & & & 0 & & \end{matrix} $$ with exact rows and columns. the middle row is exact because tensoring with the free module $r^{(i)}$ is exact. \end{proof} \begin{lemma} \label{lemma-flat-ses} suppose that $0 \to m' \to m \to m'' \to 0$ is a short exact sequence of $r$-modules. if $m'$ and $m''$ are flat so is $m$. if $m$ and $m''$ are flat so is $m'$. \end{lemma} \begin{proof} we will use the criterion that a module $n$ is flat if for every ideal $i \subset r$ the map $n \otimes_r i \to n$ is injective, see lemma \ref{lemma-flat}. consider an ideal $i \subset r$. consider the diagram $$ \begin{matrix} 0 & \to & m' & \to & m & \to & m'' & \to & 0 \\ & & \uparrow & & \uparrow & & \uparrow & & \\ & & m'\otimes_r i & \to & m \otimes_r i & \to & m''\otimes_r i & \to & 0 \end{matrix} $$ with exact rows. this immediately proves the first assertion. the second follows because if $m''$ is flat then the lower left horizontal arrow is injective by lemma \ref{lemma-flat-tor-zero}. \end{proof} \begin{lemma} \label{lemma-easy-ff} let $r$ be a ring. let $m$ be an $r$-module. the following are equivalent \begin{enumerate} \item $m$ is faithfully flat, and \item $m$ is flat and for all $r$-module homomorphisms $\alpha : n \to n'$ we have $\alpha = 0$ if and only if $\alpha \otimes \text{id}_m = 0$. \end{enumerate} \end{lemma} \begin{proof} if $m$ is faithfully flat, then $0 \to \ker(\alpha) \to n \to n'$ is exact if and only if the same holds after tensoring with $m$. this proves (1) implies (2). for the other, assume (2). let $n_1 \to n_2 \to n_3$ be a complex, and assume the complex $n_1 \otimes_r m \to n_2 \otimes_r m \to n_3\otimes_r m$ is exact. take $x \in \ker(n_2 \to n_3)$, and consider the map $\alpha : r \to n_2/\im(n_1)$, $r \mapsto rx + \im(n_1)$. by the exactness of the complex $-\otimes_r m$ we see that $\alpha \otimes \text{id}_m$ is zero. by assumption we get that $\alpha$ is zero. hence $x $ is in the image of $n_1 \to n_2$. \end{proof} \begin{lemma} \label{lemma-ff} \begin{slogan} a flat module is faithfully flat if and only if it has nonzero fibers. \end{slogan} let $m$ be a flat $r$-module. the following are equivalent: \begin{enumerate} \item $m$ is faithfully flat, \item for every nonzero $r$-module $n$, then tensor product $m \otimes_r n$ is nonzero, \item for all $\mathfrak p \in \spec(r)$ the tensor product $m \otimes_r \kappa(\mathfrak p)$ is nonzero, and \item for all maximal ideals $\mathfrak m$ of $r$ the tensor product $m \otimes_r \kappa(\mathfrak m) = m/{\mathfrak m}m$ is nonzero. \end{enumerate} \end{lemma} \begin{proof} assume $m$ faithfully flat and $n \not = 0$. by lemma \ref{lemma-easy-ff} the nonzero map $1 : n \to n$ induces a nonzero map $m \otimes_r n \to m \otimes_r n$, so $m \otimes_r n \not = 0$. thus (1) implies (2). the implications (2) $\rightarrow$ (3) $\rightarrow$ (4) are immediate. \medskip\noindent assume (4). suppose that $n_1 \to n_2 \to n_3$ is a complex and suppose that $n_1 \otimes_r m \to n_2\otimes_r m \to n_3\otimes_r m$ is exact. let $h$ be the cohomology of the complex, so $h = \ker(n_2 \to n_3)/\im(n_1 \to n_2)$. to finish the proof we will show $h = 0$. by flatness we see that $h \otimes_r m = 0$. take $x \in h$ and let $i = \{f \in r \mid fx = 0 \}$ be its annihilator. since $r/i \subset h$ we get $m/im \subset h \otimes_r m = 0$ by flatness of $m$. if $i \not = r$ we may choose a maximal ideal $i \subset \mathfrak m \subset r$. this immediately gives a contradiction. \end{proof} \begin{lemma} \label{lemma-ff-rings} let $r \to s$ be a flat ring map. the following are equivalent: \begin{enumerate} \item $r \to s$ is faithfully flat, \item the induced map on $\spec$ is surjective, and \item any closed point $x \in \spec(r)$ is in the image of the map $\spec(s) \to \spec(r)$. \end{enumerate} \end{lemma} \begin{proof} this follows quickly from lemma \ref{lemma-ff}, because we saw in remark \ref{remark-fundamental-diagram} that $\mathfrak p$ is in the image if and only if the ring $s \otimes_r \kappa(\mathfrak p)$ is nonzero. \end{proof} \begin{lemma} \label{lemma-local-flat-ff} a flat local ring homomorphism of local rings is faithfully flat. \end{lemma} \begin{proof} immediate from lemma \ref{lemma-ff-rings}. \end{proof} \noindent flatness meshes well with localization. \begin{lemma} \label{lemma-flat-localization} let $r$ be a ring. let $s \subset r$ be a multiplicative subset. \begin{enumerate} \item the localization $s^{-1}r$ is a flat $r$-algebra. \item if $m$ is an $s^{-1}r$-module, then $m$ is a flat $r$-module if and only if $m$ is a flat $s^{-1}r$-module. \item suppose $m$ is an $r$-module. then $m$ is a flat $r$-module if and only if $m_{\mathfrak p}$ is a flat $r_{\mathfrak p}$-module for all primes $\mathfrak p$ of $r$. \item suppose $m$ is an $r$-module. then $m$ is a flat $r$-module if and only if $m_{\mathfrak m}$ is a flat $r_{\mathfrak m}$-module for all maximal ideals $\mathfrak m$ of $r$. \item suppose $r \to a$ is a ring map, $m$ is an $a$-module, and $g_1, \ldots, g_m \in a$ are elements generating the unit ideal of $a$. then $m$ is flat over $r$ if and only if each localization $m_{g_i}$ is flat over $r$. \item suppose $r \to a$ is a ring map, and $m$ is an $a$-module. then $m$ is a flat $r$-module if and only if the localization $m_{\mathfrak q}$ is a flat $r_{\mathfrak p}$-module (with $\mathfrak p$ the prime of $r$ lying under $\mathfrak q$) for all primes $\mathfrak q$ of $a$. \item suppose $r \to a$ is a ring map, and $m$ is an $a$-module. then $m$ is a flat $r$-module if and only if the localization $m_{\mathfrak m}$ is a flat $r_{\mathfrak p}$-module (with $\mathfrak p = r \cap \mathfrak m$) for all maximal ideals $\mathfrak m$ of $a$. \end{enumerate} \end{lemma} \begin{proof} let us prove the last statement of the lemma. in the proof we will use repeatedly that localization is exact and commutes with tensor product, see sections \ref{section-localization} and \ref{section-tensor-product}. \medskip\noindent suppose $r \to a$ is a ring map, and $m$ is an $a$-module. assume that $m_{\mathfrak m}$ is a flat $r_{\mathfrak p}$-module for all maximal ideals $\mathfrak m$ of $a$ (with $\mathfrak p = r \cap \mathfrak m$). let $i \subset r$ be an ideal. we have to show the map $i \otimes_r m \to m$ is injective. we can think of this as a map of $a$-modules. by assumption the localization $(i \otimes_r m)_{\mathfrak m} \to m_{\mathfrak m}$ is injective because $(i \otimes_r m)_{\mathfrak m} = i_{\mathfrak p} \otimes_{r_{\mathfrak p}} m_{\mathfrak m}$. hence the kernel of $i \otimes_r m \to m$ is zero by lemma \ref{lemma-characterize-zero-local}. hence $m$ is flat over $r$. \medskip\noindent conversely, assume $m$ is flat over $r$. pick a prime $\mathfrak q$ of $a$ lying over the prime $\mathfrak p$ of $r$. suppose that $i \subset r_{\mathfrak p}$ is an ideal. we have to show that $i \otimes_{r_{\mathfrak p}} m_{\mathfrak q} \to m_{\mathfrak q}$ is injective. we can write $i = j_{\mathfrak p}$ for some ideal $j \subset r$. then the map $i \otimes_{r_{\mathfrak p}} m_{\mathfrak q} \to m_{\mathfrak q}$ is just the localization (at $\mathfrak q$) of the map $j \otimes_r m \to m$ which is injective. since localization is exact we see that $m_{\mathfrak q}$ is a flat $r_{\mathfrak p}$-module. \medskip\noindent this proves (7) and (6). the other statements follow in a straightforward way from the last statement (proofs omitted). \end{proof} \begin{lemma} \label{lemma-flat-going-down} let $r \to s$ be flat. let $\mathfrak p \subset \mathfrak p'$ be primes of $r$. let $\mathfrak q' \subset s$ be a prime of $s$ mapping to $\mathfrak p'$. then there exists a prime $\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p$. \end{lemma} \begin{proof} by lemma \ref{lemma-flat-localization} the local ring map $r_{\mathfrak p'} \to s_{\mathfrak q'}$ is flat. by lemma \ref{lemma-local-flat-ff} this local ring map is faithfully flat. by lemma \ref{lemma-ff-rings} there is a prime mapping to $\mathfrak p r_{\mathfrak p'}$. the inverse image of this prime in $s$ does the job. \end{proof} \noindent the property of $r \to s$ described in the lemma is called the ``going down property''. see definition \ref{definition-going-up-down}. \begin{lemma} \label{lemma-colimit-faithfully-flat} let $r$ be a ring. let $\{s_i, \varphi_{ii'}\}$ be a directed system of faithfully flat $r$-algebras. then $s = \colim_i s_i$ is a faithfully flat $r$-algebra. \end{lemma} \begin{proof} by lemma \ref{lemma-colimit-flat} we see that $s$ is flat. let $\mathfrak m \subset r$ be a maximal ideal. by lemma \ref{lemma-ff-rings} none of the rings $s_i/\mathfrak m s_i$ is zero. hence $s/\mathfrak ms = \colim s_i/\mathfrak ms_i$ is nonzero as well because $1$ is not equal to zero. thus the image of $\spec(s) \to \spec(r)$ contains $\mathfrak m$ and we see that $r \to s$ is faithfully flat by lemma \ref{lemma-ff-rings}. \end{proof} \section{supports and annihilators} \label{section-supp-and-ann} \noindent some very basic definitions and lemmas. \begin{definition} \label{definition-support-module} let $r$ be a ring and let $m$ be an $r$-module. the {\it support of $m$} is the set $$ \text{supp}(m) = \{ \mathfrak p \in \spec(r) \mid m_{\mathfrak p} \not = 0 \} $$ \end{definition} \begin{lemma} \label{lemma-support-zero} \begin{slogan} a module over a ring has empty support if and only if it is the trivial module. \end{slogan} let $r$ be a ring. let $m$ be an $r$-module. then $$ m = (0) \leftrightarrow \text{supp}(m) = \emptyset. $$ \end{lemma} \begin{proof} actually, lemma \ref{lemma-characterize-zero-local} even shows that $\text{supp}(m)$ always contains a maximal ideal if $m$ is not zero. \end{proof} \begin{definition} \label{definition-annihilator} let $r$ be a ring. let $m$ be an $r$-module. \begin{enumerate} \item given an element $m \in m$ the {\it annihilator of $m$} is the ideal $$ \text{ann}_r(m) = \text{ann}(m) = \{f \in r \mid fm = 0\}. $$ \item the {\it annihilator of $m$} is the ideal $$ \text{ann}_r(m) = \text{ann}(m) = \{f \in r \mid fm = 0\ \forall m \in m\}. $$ \end{enumerate} \end{definition} \begin{lemma} \label{lemma-annihilator-flat-base-change} let $r \to s$ be a flat ring map. let $m$ be an $r$-module and $m \in m$. then $\text{ann}_r(m) s = \text{ann}_s(m \otimes 1)$. if $m$ is a finite $r$-module, then $\text{ann}_r(m) s = \text{ann}_s(m \otimes_r s)$. \end{lemma} \begin{proof} set $i = \text{ann}_r(m)$. by definition there is an exact sequence $0 \to i \to r \to m$ where the map $r \to m$ sends $f$ to $fm$. using flatness we obtain an exact sequence $0 \to i \otimes_r s \to s \to m \otimes_r s$ which proves the first assertion. if $m_1, \ldots, m_n$ is a set of generators of $m$ then $\text{ann}_r(m) = \bigcap \text{ann}_r(m_i)$. similarly $\text{ann}_s(m \otimes_r s) = \bigcap \text{ann}_s(m_i \otimes 1)$. set $i_i = \text{ann}_r(m_i)$. then it suffices to show that $\bigcap_{i = 1, \ldots, n} (i_i s) = (\bigcap_{i = 1, \ldots, n} i_i)s$. this is lemma \ref{lemma-flat-intersect-ideals}. \end{proof} \begin{lemma} \label{lemma-support-closed} let $r$ be a ring and let $m$ be an $r$-module. if $m$ is finite, then $\text{supp}(m)$ is closed. more precisely, if $i = \text{ann}(m)$ is the annihilator of $m$, then $v(i) = \text{supp}(m)$. \end{lemma} \begin{proof} we will show that $v(i) = \text{supp}(m)$. \medskip\noindent suppose $\mathfrak p \in \text{supp}(m)$. then $m_{\mathfrak p} \not = 0$. choose an element $m \in m$ whose image in $m_\mathfrak p$ is nonzero. then the annihilator of $m$ is contained in $\mathfrak p$ by construction of the localization $m_\mathfrak p$. hence a fortiori $i = \text{ann}(m)$ must be contained in $\mathfrak p$. \medskip\noindent conversely, suppose that $\mathfrak p \not \in \text{supp}(m)$. then $m_{\mathfrak p} = 0$. let $x_1, \ldots, x_r \in m$ be generators. by lemma \ref{lemma-localization-colimit} there exists an $f \in r$, $f\not\in \mathfrak p$ such that $x_i/1 = 0$ in $m_f$. hence $f^{n_i} x_i = 0$ for some $n_i \geq 1$. hence $f^nm = 0$ for $n = \max\{n_i\}$ as desired. \end{proof} \begin{lemma} \label{lemma-support-base-change} let $r \to r'$ be a ring map and let $m$ be a finite $r$-module. then $\text{supp}(m \otimes_r r')$ is the inverse image of $\text{supp}(m)$. \end{lemma} \begin{proof} let $\mathfrak p \in \text{supp}(m)$. by nakayama's lemma (lemma \ref{lemma-nak}) we see that $$ m \otimes_r \kappa(\mathfrak p) = m_\mathfrak p/\mathfrak p m_\mathfrak p $$ is a nonzero $\kappa(\mathfrak p)$ vector space. hence for every prime $\mathfrak p' \subset r'$ lying over $\mathfrak p$ we see that $$ (m \otimes_r r')_{\mathfrak p'}/\mathfrak p' (m \otimes_r r')_{\mathfrak p'} = (m \otimes_r r') \otimes_{r'} \kappa(\mathfrak p') = m \otimes_r \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p') $$ is nonzero. this implies $\mathfrak p' \in \text{supp}(m \otimes_r r')$. for the converse, if $\mathfrak p' \subset r'$ is a prime lying over an arbitrary prime $\mathfrak p \subset r$, then $$ (m \otimes_r r')_{\mathfrak p'} = m_\mathfrak p \otimes_{r_\mathfrak p} r'_{\mathfrak p'}. $$ hence if $\mathfrak p' \in \text{supp}(m \otimes_r r')$ lies over the prime $\mathfrak p \subset r$, then $\mathfrak p \in \text{supp}(m)$. \end{proof} \begin{lemma} \label{lemma-support-element} let $r$ be a ring, let $m$ be an $r$-module, and let $m \in m$. then $\mathfrak p \in v(\text{ann}(m))$ if and only if $m$ does not map to zero in $m_\mathfrak p$. \end{lemma} \begin{proof} we may replace $m$ by $rm \subset m$. then (1) $\text{ann}(m) = \text{ann}(m)$ and (2) $m$ does not map to zero in $m_\mathfrak p$ if and only if $\mathfrak p \in \text{supp}(m)$. the result now follows from lemma \ref{lemma-support-closed}. \end{proof} \begin{lemma} \label{lemma-support-finite-presentation-constructible} let $r$ be a ring and let $m$ be an $r$-module. if $m$ is a finitely presented $r$-module, then $\text{supp}(m)$ is a closed subset of $\spec(r)$ whose complement is quasi-compact. \end{lemma} \begin{proof} choose a presentation $$ r^{\oplus m} \longrightarrow r^{\oplus n} \longrightarrow m \to 0 $$ let $a \in \text{mat}(n \times m, r)$ be the matrix of the first map. by nakayama's lemma \ref{lemma-nak} we see that $$ m_{\mathfrak p} \not = 0 \leftrightarrow m \otimes \kappa(\mathfrak p) \not = 0 \leftrightarrow \text{rank}(a \bmod \mathfrak p) < n. $$ hence, if $i$ is the ideal of $r$ generated by the $n \times n$ minors of $a$, then $\text{supp}(m) = v(i)$. since $i$ is finitely generated, say $i = (f_1, \ldots, f_t)$, we see that $\spec(r) \setminus v(i)$ is a finite union of the standard opens $d(f_i)$, hence quasi-compact. \end{proof} \begin{lemma} \label{lemma-support-quotient} let $r$ be a ring and let $m$ be an $r$-module. \begin{enumerate} \item if $m$ is finite then the support of $m/im$ is $\text{supp}(m) \cap v(i)$. \item if $n \subset m$, then $\text{supp}(n) \subset \text{supp}(m)$. \item if $q$ is a quotient module of $m$ then $\text{supp}(q) \subset \text{supp}(m)$. \item if $0 \to n \to m \to q \to 0$ is a short exact sequence then $\text{supp}(m) = \text{supp}(q) \cup \text{supp}(n)$. \end{enumerate} \end{lemma} \begin{proof} the functors $m \mapsto m_{\mathfrak p}$ are exact. this immediately implies all but the first assertion. for the first assertion we need to show that $m_\mathfrak p \not = 0$ and $i \subset \mathfrak p$ implies $(m/im)_{\mathfrak p} = m_\mathfrak p/im_\mathfrak p \not = 0$. this follows from nakayama's lemma \ref{lemma-nak}. \end{proof} \section{going up and going down} \label{section-going-up} \noindent suppose $\mathfrak p$, $\mathfrak p'$ are primes of the ring $r$. let $x = \spec(r)$ with the zariski topology. denote $x \in x$ the point corresponding to $\mathfrak p$ and $x' \in x$ the point corresponding to $\mathfrak p'$. then we have: $$ x' \leadsto x \leftrightarrow \mathfrak p' \subset \mathfrak p. $$ in words: $x$ is a specialization of $x'$ if and only if $\mathfrak p' \subset \mathfrak p$. see topology, section \ref{topology-section-specialization} for terminology and notation. \begin{definition} \label{definition-going-up-down} let $\varphi : r \to s$ be a ring map. \begin{enumerate} \item we say a $\varphi : r \to s$ satisfies {\it going up} if given primes $\mathfrak p \subset \mathfrak p'$ in $r$ and a prime $\mathfrak q$ in $s$ lying over $\mathfrak p$ there exists a prime $\mathfrak q'$ of $s$ such that (a) $\mathfrak q \subset \mathfrak q'$, and (b) $\mathfrak q'$ lies over $\mathfrak p'$. \item we say a $\varphi : r \to s$ satisfies {\it going down} if given primes $\mathfrak p \subset \mathfrak p'$ in $r$ and a prime $\mathfrak q'$ in $s$ lying over $\mathfrak p'$ there exists a prime $\mathfrak q$ of $s$ such that (a) $\mathfrak q \subset \mathfrak q'$, and (b) $\mathfrak q$ lies over $\mathfrak p$. \end{enumerate} \end{definition} \noindent so far we have see the following cases of this: \begin{enumerate} \item an integral ring map satisfies going up, see lemma \ref{lemma-integral-going-up}. \item as a special case finite ring maps satisfy going up. \item as a special case quotient maps $r \to r/i$ satisfy going up. \item a flat ring map satisfies going down, see lemma \ref{lemma-flat-going-down} \item as a special case any localization satisfies going down. \item an extension $r \subset s$ of domains, with $r$ normal and $s$ integral over $r$ satisfies going down, see proposition \ref{proposition-going-down-normal-integral}. \end{enumerate} here is another case where going down holds. \begin{lemma} \label{lemma-open-going-down} let $r \to s$ be a ring map. if the induced map $\varphi : \spec(s) \to \spec(r)$ is open, then $r \to s$ satisfies going down. \end{lemma} \begin{proof} suppose that $\mathfrak p \subset \mathfrak p' \subset r$ and $\mathfrak q' \subset s$ lies over $\mathfrak p'$. as $\varphi$ is open, for every $g \in s$, $g \not \in \mathfrak q'$ we see that $\mathfrak p$ is in the image of $d(g) \subset \spec(s)$. in other words $s_g \otimes_r \kappa(\mathfrak p)$ is not zero. since $s_{\mathfrak q'}$ is the directed colimit of these $s_g$ this implies that $s_{\mathfrak q'} \otimes_r \kappa(\mathfrak p)$ is not zero, see lemmas \ref{lemma-localization-colimit} and \ref{lemma-tensor-products-commute-with-limits}. hence $\mathfrak p$ is in the image of $\spec(s_{\mathfrak q'}) \to \spec(r)$ as desired. \end{proof} \begin{lemma} \label{lemma-going-up-down-specialization} let $r \to s$ be a ring map. \begin{enumerate} \item $r \to s$ satisfies going down if and only if generalizations lift along the map $\spec(s) \to \spec(r)$, see topology, definition \ref{topology-definition-lift-specializations}. \item $r \to s$ satisfies going up if and only if specializations lift along the map $\spec(s) \to \spec(r)$, see topology, definition \ref{topology-definition-lift-specializations}. \end{enumerate} \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-going-up-down-composition} suppose $r \to s$ and $s \to t$ are ring maps satisfying going down. then so does $r \to t$. similarly for going up. \end{lemma} \begin{proof} according to lemma \ref{lemma-going-up-down-specialization} this follows from topology, lemma \ref{topology-lemma-lift-specialization-composition} \end{proof} \begin{lemma} \label{lemma-image-stable-specialization-closed} let $r \to s$ be a ring map. let $t \subset \spec(r)$ be the image of $\spec(s)$. if $t$ is stable under specialization, then $t$ is closed. \end{lemma} \begin{proof} we give two proofs. \medskip\noindent first proof. let $\mathfrak p \subset r$ be a prime ideal such that the corresponding point of $\spec(r)$ is in the closure of $t$. this means that for every $f \in r$, $f \not \in \mathfrak p$ we have $d(f) \cap t \not = \emptyset$. note that $d(f) \cap t$ is the image of $\spec(s_f)$ in $\spec(r)$. hence we conclude that $s_f \not = 0$. in other words, $1 \not = 0$ in the ring $s_f$. since $s_{\mathfrak p}$ is the directed colimit of the rings $s_f$ we conclude that $1 \not = 0$ in $s_{\mathfrak p}$. in other words, $s_{\mathfrak p} \not = 0$ and considering the image of $\spec(s_{\mathfrak p}) \to \spec(s) \to \spec(r)$ we see there exists a $\mathfrak p' \in t$ with $\mathfrak p' \subset \mathfrak p$. as we assumed $t$ closed under specialization we conclude $\mathfrak p$ is a point of $t$ as desired. \medskip\noindent second proof. let $i = \ker(r \to s)$. we may replace $r$ by $r/i$. in this case the ring map $r \to s$ is injective. by lemma \ref{lemma-injective-minimal-primes-in-image} all the minimal primes of $r$ are contained in the image $t$. hence if $t$ is stable under specialization then it contains all primes. \end{proof} \begin{lemma} \label{lemma-going-up-closed} let $r \to s$ be a ring map. the following are equivalent: \begin{enumerate} \item going up holds for $r \to s$, and \item the map $\spec(s) \to \spec(r)$ is closed. \end{enumerate} \end{lemma} \begin{proof} it is a general fact that specializations lift along a closed map of topological spaces, see topology, lemma \ref{topology-lemma-closed-open-map-specialization}. hence the second condition implies the first. \medskip\noindent assume that going up holds for $r \to s$. let $v(i) \subset \spec(s)$ be a closed set. we want to show that the image of $v(i)$ in $\spec(r)$ is closed. the ring map $s \to s/i$ obviously satisfies going up. hence $r \to s \to s/i$ satisfies going up, by lemma \ref{lemma-going-up-down-composition}. replacing $s$ by $s/i$ it suffices to show the image $t$ of $\spec(s)$ in $\spec(r)$ is closed. by topology, lemmas \ref{topology-lemma-open-closed-specialization} and \ref{topology-lemma-lift-specializations-images} this image is stable under specialization. thus the result follows from lemma \ref{lemma-image-stable-specialization-closed}. \end{proof} \begin{lemma} \label{lemma-constructible-stable-specialization-closed} let $r$ be a ring. let $e \subset \spec(r)$ be a constructible subset. \begin{enumerate} \item if $e$ is stable under specialization, then $e$ is closed. \item if $e$ is stable under generalization, then $e$ is open. \end{enumerate} \end{lemma} \begin{proof} first proof. the first assertion follows from lemma \ref{lemma-image-stable-specialization-closed} combined with lemma \ref{lemma-constructible-is-image}. the second follows because the complement of a constructible set is constructible (see topology, lemma \ref{topology-lemma-constructible}), the first part of the lemma and topology, lemma \ref{topology-lemma-open-closed-specialization}. \medskip\noindent second proof. since $\spec(r)$ is a spectral space by lemma \ref{lemma-spec-spectral} this is a special case of topology, lemma \ref{topology-lemma-constructible-stable-specialization-closed}. \end{proof} \begin{proposition} \label{proposition-fppf-open} let $r \to s$ be flat and of finite presentation. then $\spec(s) \to \spec(r)$ is open. more generally this holds for any ring map $r \to s$ of finite presentation which satisfies going down. \end{proposition} \begin{proof} if $r \to s$ is flat, then $r \to s$ satisfies going down by lemma \ref{lemma-flat-going-down}. thus to prove the lemma we may assume that $r \to s$ has finite presentation and satisfies going down. \medskip\noindent since the standard opens $d(g) \subset \spec(s)$, $g \in s$ form a basis for the topology, it suffices to prove that the image of $d(g)$ is open. recall that $\spec(s_g) \to \spec(s)$ is a homeomorphism of $\spec(s_g)$ onto $d(g)$ (lemma \ref{lemma-standard-open}). since $s \to s_g$ satisfies going down (see above), we see that $r \to s_g$ satisfies going down by lemma \ref{lemma-going-up-down-composition}. thus after replacing $s$ by $s_g$ we see it suffices to prove the image is open. by chevalley's theorem (theorem \ref{theorem-chevalley}) the image is a constructible set $e$. and $e$ is stable under generalization because $r \to s$ satisfies going down, see topology, lemmas \ref{topology-lemma-open-closed-specialization} and \ref{topology-lemma-lift-specializations-images}. hence $e$ is open by lemma \ref{lemma-constructible-stable-specialization-closed}. \end{proof} \begin{lemma} \label{lemma-same-image} let $k$ be a field, and let $r$, $s$ be $k$-algebras. let $s' \subset s$ be a sub $k$-algebra, and let $f \in s' \otimes_k r$. in the commutative diagram $$ \xymatrix{ \spec((s \otimes_k r)_f) \ar[rd] \ar[rr] & & \spec((s' \otimes_k r)_f) \ar[ld] \\ & \spec(r) & } $$ the images of the diagonal arrows are the same. \end{lemma} \begin{proof} let $\mathfrak p \subset r$ be in the image of the south-west arrow. this means (lemma \ref{lemma-in-image}) that $$ (s' \otimes_k r)_f \otimes_r \kappa(\mathfrak p) = (s' \otimes_k \kappa(\mathfrak p))_f $$ is not the zero ring, i.e., $s' \otimes_k \kappa(\mathfrak p)$ is not the zero ring and the image of $f$ in it is not nilpotent. the ring map $s' \otimes_k \kappa(\mathfrak p) \to s \otimes_k \kappa(\mathfrak p)$ is injective. hence also $s \otimes_k \kappa(\mathfrak p)$ is not the zero ring and the image of $f$ in it is not nilpotent. hence $(s \otimes_k r)_f \otimes_r \kappa(\mathfrak p)$ is not the zero ring. thus (lemma \ref{lemma-in-image}) we see that $\mathfrak p$ is in the image of the south-east arrow as desired. \end{proof} \begin{lemma} \label{lemma-map-into-tensor-algebra-open} let $k$ be a field. let $r$ and $s$ be $k$-algebras. the map $\spec(s \otimes_k r) \to \spec(r)$ is open. \end{lemma} \begin{proof} let $f \in s \otimes_k r$. it suffices to prove that the image of the standard open $d(f)$ is open. let $s' \subset s$ be a finite type $k$-subalgebra such that $f \in s' \otimes_k r$. the map $r \to s' \otimes_k r$ is flat and of finite presentation, hence the image $u$ of $\spec((s' \otimes_k r)_f) \to \spec(r)$ is open by proposition \ref{proposition-fppf-open}. by lemma \ref{lemma-same-image} this is also the image of $d(f)$ and we win. \end{proof} \noindent here is a tricky lemma that is sometimes useful. \begin{lemma} \label{lemma-unique-prime-over-localize-below} let $r \to s$ be a ring map. let $\mathfrak p \subset r$ be a prime. assume that \begin{enumerate} \item there exists a unique prime $\mathfrak q \subset s$ lying over $\mathfrak p$, and \item either \begin{enumerate} \item going up holds for $r \to s$, or \item going down holds for $r \to s$ and there is at most one prime of $s$ above every prime of $r$. \end{enumerate} \end{enumerate} then $s_{\mathfrak p} = s_{\mathfrak q}$. \end{lemma} \begin{proof} consider any prime $\mathfrak q' \subset s$ which corresponds to a point of $\spec(s_{\mathfrak p})$. this means that $\mathfrak p' = r \cap \mathfrak q'$ is contained in $\mathfrak p$. here is a picture $$ \xymatrix{ \mathfrak q' \ar@{-}[d] \ar@{-}[r] & ? \ar@{-}[r] \ar@{-}[d] & s \ar@{-}[d] \\ \mathfrak p' \ar@{-}[r] & \mathfrak p \ar@{-}[r] & r } $$ assume (1) and (2)(a). by going up there exists a prime $\mathfrak q'' \subset s$ with $\mathfrak q' \subset \mathfrak q''$ and $\mathfrak q''$ lying over $\mathfrak p$. by the uniqueness of $\mathfrak q$ we conclude that $\mathfrak q'' = \mathfrak q$. in other words $\mathfrak q'$ defines a point of $\spec(s_{\mathfrak q})$. \medskip\noindent assume (1) and (2)(b). by going down there exists a prime $\mathfrak q'' \subset \mathfrak q$ lying over $\mathfrak p'$. by the uniqueness of primes lying over $\mathfrak p'$ we see that $\mathfrak q' = \mathfrak q''$. in other words $\mathfrak q'$ defines a point of $\spec(s_{\mathfrak q})$. \medskip\noindent in both cases we conclude that the map $\spec(s_{\mathfrak q}) \to \spec(s_{\mathfrak p})$ is bijective. clearly this means all the elements of $s - \mathfrak q$ are all invertible in $s_{\mathfrak p}$, in other words $s_{\mathfrak p} = s_{\mathfrak q}$. \end{proof} \noindent the following lemma is a generalization of going down for flat ring maps. \begin{lemma} \label{lemma-going-down-flat-module} let $r \to s$ be a ring map. let $n$ be a finite $s$-module flat over $r$. endow $\text{supp}(n) \subset \spec(s)$ with the induced topology. then generalizations lift along $\text{supp}(n) \to \spec(r)$. \end{lemma} \begin{proof} the meaning of the statement is as follows. let $\mathfrak p \subset \mathfrak p' \subset r$ be primes. let $\mathfrak q' \subset s$ be a prime $\mathfrak q' \in \text{supp}(n)$ then there exists a prime $\mathfrak q \subset \mathfrak q'$, $\mathfrak q \in \text{supp}(n)$ lying over $\mathfrak p$. as $n$ is flat over $r$ we see that $n_{\mathfrak q'}$ is flat over $r_{\mathfrak p'}$, see lemma \ref{lemma-flat-localization}. as $n_{\mathfrak q'}$ is finite over $s_{\mathfrak q'}$ and not zero since $\mathfrak q' \in \text{supp}(n)$ we see that $n_{\mathfrak q'} \otimes_{s_{\mathfrak q'}} \kappa(\mathfrak q')$ is nonzero by nakayama's lemma \ref{lemma-nak}. thus $n_{\mathfrak q'} \otimes_{r_{\mathfrak p'}} \kappa(\mathfrak p')$ is also not zero. we conclude from lemma \ref{lemma-ff} that $n_{\mathfrak q'} \otimes_{r_{\mathfrak p'}} \kappa(\mathfrak p)$ is nonzero. let $j \subset s_{\mathfrak q'} \otimes_{r_{\mathfrak p'}} \kappa(\mathfrak p)$ be the annihilator of the finite nonzero module $n_{\mathfrak q'} \otimes_{r_{\mathfrak p'}} \kappa(\mathfrak p)$. since $j$ is a proper ideal we can choose a prime $\mathfrak q \subset s$ which corresponds to a prime of $s_{\mathfrak q'} \otimes_{r_{\mathfrak p'}} \kappa(\mathfrak p)/j$. this prime is in the support of $n$, lies over $\mathfrak p$, and is contained in $\mathfrak q'$ as desired. \end{proof} \section{separable extensions} \label{section-separability} \noindent in this section we talk about separability for nonalgebraic field extensions. this is closely related to the concept of geometrically reduced algebras, see definition \ref{definition-geometrically-reduced}. \begin{definition} \label{definition-separable-field-extension} let $k/k$ be a field extension. \begin{enumerate} \item we say $k$ is {\it separably generated over $k$} if there exists a transcendence basis $\{x_i; i \in i\}$ of $k/k$ such that the extension $k/k(x_i; i \in i)$ is a separable algebraic extension. \item we say $k$ is {\it separable over $k$} if for every subextension $k \subset k' \subset k$ with $k'$ finitely generated over $k$, the extension $k'/k$ is separably generated. \end{enumerate} \end{definition} \noindent with this awkward definition it is not clear that a separably generated field extension is itself separable. it will turn out that this is the case, see lemma \ref{lemma-separably-generated-separable}. \begin{lemma} \label{lemma-subextensions-are-separable} let $k/k$ be a separable field extension. for any subextension $k/k'/k$ the field extension $k'/k$ is separable. \end{lemma} \begin{proof} this is direct from the definition. \end{proof} \begin{lemma} \label{lemma-generating-finitely-generated-separable-field-extensions} let $k/k$ be a separably generated, and finitely generated field extension. set $r = \text{trdeg}_k(k)$. then there exist elements $x_1, \ldots, x_{r + 1}$ of $k$ such that \begin{enumerate} \item $x_1, \ldots, x_r$ is a transcendence basis of $k$ over $k$, \item $k = k(x_1, \ldots, x_{r + 1})$, and \item $x_{r + 1}$ is separable over $k(x_1, \ldots, x_r)$. \end{enumerate} \end{lemma} \begin{proof} combine the definition with fields, lemma \ref{fields-lemma-primitive-element}. \end{proof} \begin{lemma} \label{lemma-make-separably-generated} let $k/k$ be a finitely generated field extension. there exists a diagram $$ \xymatrix{ k \ar[r] & k' \\ k \ar[u] \ar[r] & k' \ar[u] } $$ where $k'/k$, $k'/k$ are finite purely inseparable field extensions such that $k'/k'$ is a separably generated field extension. \end{lemma} \begin{proof} this lemma is only interesting when the characteristic of $k$ is $p > 0$. choose $x_1, \ldots, x_r$ a transcendence basis of $k$ over $k$. as $k$ is finitely generated over $k$ the extension $k(x_1, \ldots, x_r) \subset k$ is finite. let $k/k_{sep}/k(x_1, \ldots, x_r)$ be the subextension found in fields, lemma \ref{fields-lemma-separable-first}. if $k = k_{sep}$ then we are done. we will use induction on $d = [k : k_{sep}]$. \medskip\noindent assume that $d > 1$. choose a $\beta \in k$ with $\alpha = \beta^p \in k_{sep}$ and $\beta \not \in k_{sep}$. let $p = t^n + a_1t^{n - 1} + \ldots + a_n$ be the minimal polynomial of $\alpha$ over $k(x_1, \ldots, x_r)$. let $k'/k$ be a finite purely inseparable extension obtained by adjoining $p$th roots such that each $a_i$ is a $p$th power in $k'(x_1^{1/p}, \ldots, x_r^{1/p})$. such an extension exists; details omitted. let $l$ be a field fitting into the diagram $$ \xymatrix{ k \ar[r] & l \\ k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u] } $$ we may and do assume $l$ is the compositum of $k$ and $k'(x_1^{1/p}, \ldots, x_r^{1/p})$. let $l/l_{sep}/k'(x_1^{1/p}, \ldots, x_r^{1/p})$ be the subextension found in fields, lemma \ref{fields-lemma-separable-first}. then $l_{sep}$ is the compositum of $k_{sep}$ and $k'(x_1^{1/p}, \ldots, x_r^{1/p})$. the element $\alpha \in l_{sep}$ is a zero of the polynomial $p$ all of whose coefficients are $p$th powers in $k'(x_1^{1/p}, \ldots, x_r^{1/p})$ and whose roots are pairwise distinct. by fields, lemma \ref{fields-lemma-pth-root} we see that $\alpha = (\alpha')^p$ for some $\alpha' \in l_{sep}$. clearly, this means that $\beta$ maps to $\alpha' \in l_{sep}$. in other words, we get the tower of fields $$ \xymatrix{ k \ar[r] & l \\ k_{sep}(\beta) \ar[r] \ar[u] & l_{sep} \ar[u] \\ k_{sep} \ar[r] \ar[u] & l_{sep} \ar@{=}[u] \\ k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u] \\ k \ar[r] \ar[u] & k' \ar[u] } $$ thus this construction leads to a new situation with $[l : l_{sep}] < [k : k_{sep}]$. by induction we can find $k' \subset k''$ and $l \subset l'$ as in the lemma for the extension $l/k'$. then the extensions $k''/k$ and $l'/k$ work for the extension $k/k$. this proves the lemma. \end{proof} \section{geometrically reduced algebras} \label{section-geometrically-reduced} \noindent the main result on geometrically reduced algebras is lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}. we suggest the reader skip to the lemma after reading the definition. \begin{definition} \label{definition-geometrically-reduced} let $k$ be a field. let $s$ be a $k$-algebra. we say $s$ is {\it geometrically reduced over $k$} if for every field extension $k/k$ the $k$-algebra $k \otimes_k s$ is reduced. \end{definition} \noindent let $k$ be a field and let $s$ be a reduced $k$-algebra. to check that $s$ is geometrically reduced it will suffice to check that $\overline{k} \otimes_k s$ is reduced (where $\overline{k}$ denotes the algebraic closure of $k$). in fact it is enough to check this for finite purely inseparable field extensions $k'/k$. see lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}. \begin{lemma} \label{lemma-subalgebra-separable} elementary properties of geometrically reduced algebras. let $k$ be a field. let $s$ be a $k$-algebra. \begin{enumerate} \item if $s$ is geometrically reduced over $k$ so is every $k$-subalgebra. \item if all finitely generated $k$-subalgebras of $s$ are geometrically reduced, then $s$ is geometrically reduced. \item a directed colimit of geometrically reduced $k$-algebras is geometrically reduced. \item if $s$ is geometrically reduced over $k$, then any localization of $s$ is geometrically reduced over $k$. \end{enumerate} \end{lemma} \begin{proof} omitted. the second and third property follow from the fact that tensor product commutes with colimits. \end{proof} \begin{lemma} \label{lemma-geometrically-reduced-permanence} let $k$ be a field. if $r$ is geometrically reduced over $k$, and $s \subset r$ is a multiplicative subset, then the localization $s^{-1}r$ is geometrically reduced over $k$. if $r$ is geometrically reduced over $k$, then $r[x]$ is geometrically reduced over $k$. \end{lemma} \begin{proof} omitted. hints: a localization of a reduced ring is reduced, and localization commutes with tensor products. \end{proof} \noindent in the proofs of the following lemmas we will repeatedly use the following observation: suppose that $r' \subset r$ and $s' \subset s$ are inclusions of $k$-algebras. then the map $r' \otimes_k s' \to r \otimes_k s$ is injective. \begin{lemma} \label{lemma-limit-argument} let $k$ be a field. let $r$, $s$ be $k$-algebras. \begin{enumerate} \item if $r \otimes_k s$ is nonreduced, then there exist finitely generated subalgebras $r' \subset r$, $s' \subset s$ such that $r' \otimes_k s'$ is not reduced. \item if $r \otimes_k s$ contains a nonzero zerodivisor, then there exist finitely generated subalgebras $r' \subset r$, $s' \subset s$ such that $r' \otimes_k s'$ contains a nonzero zerodivisor. \item if $r \otimes_k s$ contains a nontrivial idempotent, then there exist finitely generated subalgebras $r' \subset r$, $s' \subset s$ such that $r' \otimes_k s'$ contains a nontrivial idempotent. \end{enumerate} \end{lemma} \begin{proof} suppose $z \in r \otimes_k s$ is nilpotent. we may write $z = \sum_{i = 1, \ldots, n} x_i \otimes y_i$. thus we may take $r'$ the $k$-subalgebra generated by the $x_i$ and $s'$ the $k$-subalgebra generated by the $y_i$. the second and third statements are proved in the same way. \end{proof} \begin{lemma} \label{lemma-geometrically-reduced-any-reduced-base-change} let $k$ be a field. let $s$ be a geometrically reduced $k$-algebra. let $r$ be any reduced $k$-algebra. then $r \otimes_k s$ is reduced. \end{lemma} \begin{proof} by lemma \ref{lemma-limit-argument} we may assume that $r$ is of finite type over $k$. then $r$, as a reduced noetherian ring, embeds into a finite product of fields (see lemmas \ref{lemma-total-ring-fractions-no-embedded-points}, \ref{lemma-noetherian-irreducible-components}, and \ref{lemma-minimal-prime-reduced-ring}). hence we may assume $r$ is a finite product of fields. in this case it follows from definition \ref{definition-geometrically-reduced} that $r \otimes_k s$ is reduced. \end{proof} \begin{lemma} \label{lemma-separable-extension-preserves-reducedness} let $k$ be a field. let $s$ be a reduced $k$-algebra. let $k/k$ be either a separable field extension, or a separably generated field extension. then $k \otimes_k s$ is reduced. \end{lemma} \begin{proof} assume $k \subset k$ is separable. by lemma \ref{lemma-limit-argument} we may assume that $s$ is of finite type over $k$ and $k$ is finitely generated over $k$. then $s$ embeds into a finite product of fields, namely its total ring of fractions (see lemmas \ref{lemma-minimal-prime-reduced-ring} and \ref{lemma-total-ring-fractions-no-embedded-points}). hence we may actually assume that $s$ is a domain. we choose $x_1, \ldots, x_{r + 1} \in k$ as in lemma \ref{lemma-generating-finitely-generated-separable-field-extensions}. let $p \in k(x_1, \ldots, x_r)[t]$ be the minimal polynomial of $x_{r + 1}$. it is a separable polynomial. it is easy to see that $k[x_1, \ldots, x_r] \otimes_k s = s[x_1, \ldots, x_r]$ is a domain. this implies $k(x_1, \ldots, x_r) \otimes_k s$ is a domain as it is a localization of $s[x_1, \ldots, x_r]$. the ring extension $k(x_1, \ldots, x_r) \otimes_k s \subset k \otimes_k s$ is generated by a single element $x_{r + 1}$ with a single equation, namely $p$. hence $k \otimes_k s$ embeds into $f[t]/(p)$ where $f$ is the fraction field of $k(x_1, \ldots, x_r) \otimes_k s$. since $p$ is separable this is a finite product of fields and we win. \medskip\noindent at this point we do not yet know that a separably generated field extension is separable, so we have to prove the lemma in this case also. to do this suppose that $\{x_i\}_{i \in i}$ is a separating transcendence basis for $k$ over $k$. for any finite set of elements $\lambda_j \in k$ there exists a finite subset $t \subset i$ such that $k(\{x_i\}_{i\in t}) \subset k(\{x_i\}_{i \in t} \cup \{\lambda_j\})$ is finite separable. hence we see that $k$ is a directed colimit of finitely generated and separably generated extensions of $k$. thus the argument of the preceding paragraph applies to this case as well. \end{proof} \begin{lemma} \label{lemma-generic-points-geometrically-reduced} let $k$ be a field and let $s$ be a $k$-algebra. assume that $s$ is reduced and that $s_{\mathfrak p}$ is geometrically reduced for every minimal prime $\mathfrak p$ of $s$. then $s$ is geometrically reduced. \end{lemma} \begin{proof} since $s$ is reduced the map $s \to \prod_{\mathfrak p\text{ minimal}} s_{\mathfrak p}$ is injective, see lemma \ref{lemma-reduced-ring-sub-product-fields}. if $k/k$ is a field extension, then the maps $$ s \otimes_k k \to (\prod s_\mathfrak p) \otimes_k k \to \prod s_\mathfrak p \otimes_k k $$ are injective: the first as $k \to k$ is flat and the second by inspection because $k$ is a free $k$-module. as $s_\mathfrak p$ is geometrically reduced the ring on the right is reduced. thus we see that $s \otimes_k k$ is reduced as a subring of a reduced ring. \end{proof} \begin{lemma} \label{lemma-separable-algebraic-diagonal} let $k'/k$ be a separable algebraic extension. then there exists a multiplicative subset $s \subset k' \otimes_k k'$ such that the multiplication map $k' \otimes_k k' \to k'$ is identified with $k' \otimes_k k' \to s^{-1}(k' \otimes_k k')$. \end{lemma} \begin{proof} first assume $k'/k$ is finite separable. then $k' = k(\alpha)$, see fields, lemma \ref{fields-lemma-primitive-element}. let $p \in k[x]$ be the minimal polynomial of $\alpha$ over $k$. then $p$ is an irreducible, separable, monic polynomial, see fields, section \ref{fields-section-separable-extensions}. then $k'[x]/(p) \to k' \otimes_k k'$, $\sum \alpha_i x^i \mapsto \alpha_i \otimes \alpha^i$ is an isomorphism. we can factor $p = (x - \alpha) q$ in $k'[x]$ and since $p$ is separable we see that $q(\alpha) \not = 0$. then it is clear that the multiplicative set $s'$ generated by $q$ in $k'[x]/(p)$ works, i.e., that $k' = (s')^{-1}(k'[x]/(p))$. by transport of structure the image $s$ of $s'$ in $k' \otimes_k k'$ works. \medskip\noindent in the general case we write $k' = \bigcup k_i$ as the union of its finite subfield extensions over $k$. for each $i$ there is a multiplicative subset $s_i \subset k_i \otimes_k k_i$ such that $k_i = s_i^{-1}(k_i \otimes_k k_i)$. then $s = \bigcup s_i \subset k' \otimes_k k'$ works. \end{proof} \begin{lemma} \label{lemma-geometrically-reduced-over-separable-algebraic} let $k'/k$ be a separable algebraic field extension. let $a$ be an algebra over $k'$. then $a$ is geometrically reduced over $k$ if and only if it is geometrically reduced over $k'$. \end{lemma} \begin{proof} assume $a$ is geometrically reduced over $k'$. let $k/k$ be a field extension. then $k \otimes_k k'$ is a reduced ring by lemma \ref{lemma-separable-extension-preserves-reducedness}. hence by lemma \ref{lemma-geometrically-reduced-any-reduced-base-change} we find that $k \otimes_k a = (k \otimes_k k') \otimes_{k'} a$ is reduced. \medskip\noindent assume $a$ is geometrically reduced over $k$. let $k/k'$ be a field extension. then $$ k \otimes_{k'} a = (k \otimes_k a) \otimes_{(k' \otimes_k k')} k' $$ since $k' \otimes_k k' \to k'$ is a localization by lemma \ref{lemma-separable-algebraic-diagonal}, we see that $k \otimes_{k'} a$ is a localization of a reduced algebra, hence reduced. \end{proof} \section{separable extensions, continued} \label{section-separability-continued} \noindent in this section we continue the discussion started in section \ref{section-separability}. \begin{lemma} \label{lemma-mini-separability} let $k$ be a field of characteristic $p > 1$. let $k/k$ be a field extension generated by $x_1, \ldots, x_{n + 1} \in k$ such that \begin{enumerate} \item $\{x_1, \ldots, x_n\}$ is a transcendence base of $k/k$, \item for every $k$-linearly independent subset $\{a_1, \ldots, a_m\}$ of $k$ the set $\{a^p_1, \ldots, a_m^p\}$ is $k$-linearly independent. \end{enumerate} then there is $1 \leq j \leq n+1$ such that $\{ x_1, \ldots, \widehat{x}_j, \ldots, x_{n+1}\}$ is a separating transcendence base for $k / k$. \end{lemma} \begin{proof} by assumption $x_{n + 1}$ is algebraic over $k(x_1, \ldots, x_n)$ so there exists a non-zero polynomial $f \in k[x_1, \ldots, x_{n + 1}]$ such that $f(x_1, \ldots, x_{n+1}) = 0$. choose $f$ of minimal total degree. then $f$ is irreducible, because at least one irreducible factor must also have the same property. \medskip\noindent we claim that, for some $i$, not all powers of $x_i$ appearing in $f$ are multiples of $p$. suppose for a contradiction that all the exponents appearing in $f$ were multiples of $p$, then the set $$ \{x_1^{\alpha_1} \ldots x^{\alpha_{n+1}}_{n+1} \mid \lambda_\alpha \neq 0\} \subset k $$ is $k$-linearly dependent where $\lambda_\alpha$ are the coefficients of $f$. by assumption (2) we conclude the set $$ \{x_1^{\alpha_1 / p} \ldots x^{\alpha_{n+1} / p}_{n+1} \mid \lambda_\alpha \neq 0 \} $$ is also $k$-linearly dependent, contradicting minimality of $\deg(f)$. \medskip\noindent choose $i$ for which a non-$p$th power of $x_i$ appears in $f$. then we see that $x_i$ is algebraic over $l = k(x_1, \ldots, x_{i - 1}, x_{i + 1}, \ldots, x_{n+1})$. by fields, lemma \ref{fields-lemma-transcendence-degree} we see that $x_1, \ldots, x_{i - 1}, x_{i + 1}, \ldots, x_{n+1}$ is a transcendence base of $k/k$. thus $l$ is the fraction field of the polynomial ring over $k$ in $x_1, \ldots, x_{i - 1}, x_{i + 1}, \ldots, x_{n + 1}$. by gauss' lemma we conclude that $$ p(t) = f(x_1, \ldots, x_{i - 1}, t, x_{i + 1}, \ldots, x_{n + 1}) \in l[t] $$ is irreducible. by construction $p(t)$ is not contained in $l[t^p]$. hence $k/l$ is separable as required. \end{proof} \noindent let $p$ be a prime number and let $k$ be a field of characteristic $p$. in this case we write $k^{1/p}$ for the extension of $k$ gotten by adjoining $p$th roots of all the elements of $k$ to $k$. (in other words it is the subfield of an algebraic closure of $k$ generated by the $p$th roots of elements of $k$.) \begin{lemma} \label{lemma-characterize-separable-field-extensions} let $k$ be a field of characteristic $p > 0$. let $k/k$ be a field extension. the following are equivalent: \begin{enumerate} \item $k$ is separable over $k$, \item for every $k$-linearly independent subset $\{a_1, \ldots, a_m\}$ of $k$ the set $\{a^p_1, \ldots, a_m^p\}$ is $k$-linearly independent, \item the ring $k \otimes_k k^{1/p}$ is reduced, and \item $k$ is geometrically reduced over $k$. \end{enumerate} \end{lemma} \begin{proof} the implication (1) $\rightarrow$ (4) follows from lemma \ref{lemma-separable-extension-preserves-reducedness}. the implication (4) $\rightarrow$ (3) is immediate. \medskip\noindent assume (3). consider the ring homomorphism $m : k \otimes_k k^{1/p} \rightarrow k$ given by $$ \lambda \otimes \mu \rightarrow \lambda^p \mu^p $$ note that $x^p = m(x) \otimes 1$ for all $x \in k \otimes_k k^{1/p}$. since $k \otimes_k k^{1/p}$ is reduced we see $m$ is injective. if $\{a_1, \ldots, a_m\} \subset k$ is $k$-linearly independent, then $\{a_1 \otimes 1, \ldots, a_m \otimes 1\}$ is $k^{1/p}$-linearly independent. by injectivity of $m$ we deduce that no nontrivial $k$-linear combination of $a_1^p, \ldots, a_m^p$ is is zero. hence (3) implies (2). \medskip\noindent assume (2). to prove (1) we may assume that $k$ is finitely generated over $k$ and we have to prove that $k$ is separably generated over $k$. let $\{x_1, \ldots, x_d\}$ be a transcendence base of $k/k$. by fields, lemma \ref{fields-lemma-algebraic-finitely-generated} we have $[k : k'] < \infty$ where $k' = k(x_1, \ldots, x_d)$. choose the transcendence base such that the degree of inseparability $[k : k']_i$ is minimal. if $k / k'$ is separable then we win. assume this is not the case to get a contradiction. then there exists $x_{d + 1} \in k$ which is not separable over $k'$, and in particular $[k'(x_{d+1}) : k']_i > 1$. then by lemma \ref{lemma-mini-separability} there is $1 \leq j \leq n + 1$ such that $k'' = k(x_1, \ldots, \widehat{x}_j, \ldots, x_{d+1})$ satisfies $[k'(x_{d+1}) : k'']_i = 1$. by multiplicativity $[k : k'']_i < [k : k']_i$ and we obtain the contradiction. \end{proof} \begin{lemma} \label{lemma-separably-generated-separable} a separably generated field extension is separable. \end{lemma} \begin{proof} combine lemma \ref{lemma-separable-extension-preserves-reducedness} with lemma \ref{lemma-characterize-separable-field-extensions}. \end{proof} \noindent in the following lemma we will use the notion of the perfect closure which is defined in definition \ref{definition-perfection}. \begin{lemma} \label{lemma-geometrically-reduced-finite-purely-inseparable-extension} let $k$ be a field. let $s$ be a $k$-algebra. the following are equivalent: \begin{enumerate} \item $k' \otimes_k s$ is reduced for every finite purely inseparable extension $k'$ of $k$, \item $k^{1/p} \otimes_k s$ is reduced, \item $k^{perf} \otimes_k s$ is reduced, where $k^{perf}$ is the perfect closure of $k$, \item $\overline{k} \otimes_k s$ is reduced, where $\overline{k}$ is the algebraic closure of $k$, and \item $s$ is geometrically reduced over $k$. \end{enumerate} \end{lemma} \begin{proof} note that any finite purely inseparable extension $k'/k$ embeds in $k^{perf}$. moreover, $k^{1/p}$ embeds into $k^{perf}$ which embeds into $\overline{k}$. thus it is clear that (5) $\rightarrow$ (4) $\rightarrow$ (3) $\rightarrow$ (2) and that (3) $\rightarrow$ (1). \medskip\noindent we prove that (1) $\rightarrow$ (5). assume $k' \otimes_k s$ is reduced for every finite purely inseparable extension $k'$ of $k$. let $k/k$ be an extension of fields. we have to show that $k \otimes_k s$ is reduced. by lemma \ref{lemma-limit-argument} we reduce to the case where $k/k$ is a finitely generated field extension. choose a diagram $$ \xymatrix{ k \ar[r] & k' \\ k \ar[u] \ar[r] & k' \ar[u] } $$ as in lemma \ref{lemma-make-separably-generated}. by assumption $k' \otimes_k s$ is reduced. by lemma \ref{lemma-separable-extension-preserves-reducedness} it follows that $k' \otimes_k s$ is reduced. hence we conclude that $k \otimes_k s$ is reduced as desired. \medskip\noindent finally we prove that (2) $\rightarrow$ (5). assume $k^{1/p} \otimes_k s$ is reduced. then $s$ is reduced. moreover, for each localization $s_{\mathfrak p}$ at a minimal prime $\mathfrak p$, the ring $k^{1/p}\otimes_k s_{\mathfrak p}$ is a localization of $k^{1/p} \otimes_k s$ hence is reduced. but $s_{\mathfrak p}$ is a field by lemma \ref{lemma-minimal-prime-reduced-ring}, hence $s_{\mathfrak p}$ is geometrically reduced by lemma \ref{lemma-characterize-separable-field-extensions}. it follows from lemma \ref{lemma-generic-points-geometrically-reduced} that $s$ is geometrically reduced. \end{proof} \section{perfect fields} \label{section-perfect-fields} \noindent here is the definition. \begin{definition} \label{definition-perfect} let $k$ be a field. we say $k$ is {\it perfect} if every field extension of $k$ is separable over $k$. \end{definition} \begin{lemma} \label{lemma-perfect} a field $k$ is perfect if and only if it is a field of characteristic $0$ or a field of characteristic $p > 0$ such that every element has a $p$th root. \end{lemma} \begin{proof} the characteristic zero case is clear. assume the characteristic of $k$ is $p > 0$. if $k$ is perfect, then all the field extensions where we adjoin a $p$th root of an element of $k$ have to be trivial, hence every element of $k$ has a $p$th root. conversely if every element has a $p$th root, then $k = k^{1/p}$ and every field extension of $k$ is separable by lemma \ref{lemma-characterize-separable-field-extensions}. \end{proof} \begin{lemma} \label{lemma-make-separable} let $k/k$ be a finitely generated field extension. there exists a diagram $$ \xymatrix{ k \ar[r] & k' \\ k \ar[u] \ar[r] & k' \ar[u] } $$ where $k'/k$, $k'/k$ are finite purely inseparable field extensions such that $k'/k'$ is a separable field extension. in this situation we can assume that $k' = k'k$ is the compositum, and also that $k' = (k' \otimes_k k)_{red}$. \end{lemma} \begin{proof} by lemma \ref{lemma-make-separably-generated} we can find such a diagram with $k'/k'$ separably generated. by lemma \ref{lemma-separably-generated-separable} this implies that $k'$ is separable over $k'$. the compositum $k'k$ is a subextension of $k'/k'$ and hence $k' \subset k'k$ is separable by lemma \ref{lemma-subextensions-are-separable}. the ring $(k' \otimes_k k)_{red}$ is a domain as for some $n \gg 0$ the map $x \mapsto x^{p^n}$ maps it into $k$. hence it is a field by lemma \ref{lemma-integral-over-field}. thus $(k' \otimes_k k)_{red} \to k'$ maps it isomorphically onto $k'k$. \end{proof} \begin{lemma} \label{lemma-perfection} \begin{slogan} every field has a unique perfect closure. \end{slogan} for every field $k$ there exists a purely inseparable extension $k'/k$ such that $k'$ is perfect. the field extension $k'/k$ is unique up to unique isomorphism. \end{lemma} \begin{proof} if the characteristic of $k$ is zero, then $k' = k$ is the unique choice. assume the characteristic of $k$ is $p > 0$. for every $n > 0$ there exists a unique algebraic extension $k \subset k^{1/p^n}$ such that (a) every element $\lambda \in k$ has a $p^n$th root in $k^{1/p^n}$ and (b) for every element $\mu \in k^{1/p^n}$ we have $\mu^{p^n} \in k$. namely, consider the ring map $k \to k^{1/p^n} = k$, $x \mapsto x^{p^n}$. this is injective and satisfies (a) and (b). it is clear that $k^{1/p^n} \subset k^{1/p^{n + 1}}$ as extensions of $k$ via the map $y \mapsto y^p$. then we can take $k' = \bigcup k^{1/p^n}$. some details omitted. \end{proof} \begin{definition} \label{definition-perfection} let $k$ be a field. the field extension $k'/k$ of lemma \ref{lemma-perfection} is called the {\it perfect closure} of $k$. notation $k^{perf}/k$. \end{definition} \noindent note that if $k'/k$ is any algebraic purely inseparable extension, then $k'$ is a subextension of $k^{perf}$, i.e., $k^{perf}/k'/k$. namely, $(k')^{perf}$ is isomorphic to $k^{perf}$ by the uniqueness of lemma \ref{lemma-perfection}. \begin{lemma} \label{lemma-perfect-reduced} let $k$ be a perfect field. any reduced $k$ algebra is geometrically reduced over $k$. let $r$, $s$ be $k$-algebras. assume both $r$ and $s$ are reduced. then the $k$-algebra $r \otimes_k s$ is reduced. \end{lemma} \begin{proof} the first statement follows from lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}. for the second statement use the first statement and lemma \ref{lemma-geometrically-reduced-any-reduced-base-change}. \end{proof} \section{universal homeomorphisms} \label{section-universal-homeomorphism} \noindent let $k'/k$ be an algebraic purely inseparable field extension. then for any $k$-algebra $r$ the ring map $r \to k' \otimes_k r$ induces a homeomorphism of spectra. the reason for this is the slightly more general lemma \ref{lemma-p-ring-map} below. \begin{lemma} \label{lemma-surjective-locally-nilpotent-kernel} let $\varphi : r \to s$ be a surjective map with locally nilpotent kernel. then $\varphi$ induces a homeomorphism of spectra and isomorphisms on residue fields. for any ring map $r \to r'$ the ring map $r' \to r' \otimes_r s$ is surjective with locally nilpotent kernel. \end{lemma} \begin{proof} by lemma \ref{lemma-spec-closed} the map $\spec(s) \to \spec(r)$ is a homeomorphism onto the closed subset $v(\ker(\varphi))$. of course $v(\ker(\varphi)) = \spec(r)$ because every prime ideal of $r$ contains every nilpotent element of $r$. this also implies the statement on residue fields. by right exactness of tensor product we see that $\ker(\varphi)r'$ is the kernel of the surjective map $r' \to r' \otimes_r s$. hence the final statement by lemma \ref{lemma-locally-nilpotent}. \end{proof} \begin{lemma} \label{lemma-powers-field} \begin{reference} \cite[lemma 3.1.6]{alper-adequate} \end{reference} let $k'/k$ be a field extension. the following are equivalent \begin{enumerate} \item for each $x \in k'$ there exists an $n > 0$ such that $x^n \in k$, and \item $k' = k$ or $k$ and $k'$ have characteristic $p > 0$ and either $k'/k$ is a purely inseparable extension or $k$ and $k'$ are algebraic extensions of $\mathbf{f}_p$. \end{enumerate} \end{lemma} \begin{proof} observe that each of the possibilities listed in (2) satisfies (1). thus we assume $k'/k$ satisfies (1) and we prove that we are in one of the cases of (2). discarding the case $k = k'$ we may assume $k' \not = k$. it is clear that $k'/k$ is algebraic. hence we may assume that $k'/k$ is a nontrivial finite extension. let $k'/k'_{sep}/k$ be the separable subextension found in fields, lemma \ref{fields-lemma-separable-first}. we have to show that $k = k'_{sep}$ or that $k$ is an algebraic over $\mathbf{f}_p$. thus we may assume that $k'/k$ is a nontrivial finite separable extension and we have to show $k$ is algebraic over $\mathbf{f}_p$. \medskip\noindent pick $x \in k'$, $x \not \in k$. pick $n, m > 0$ such that $x^n \in k$ and $(x + 1)^m \in k$. let $\overline{k}$ be an algebraic closure of $k$. we can choose embeddings $\sigma, \tau : k' \to \overline{k}$ with $\sigma(x) \not = \tau(x)$. this follows from the discussion in fields, section \ref{fields-section-separable-extensions} (more precisely, after replacing $k'$ by the $k$-extension generated by $x$ it follows from fields, lemma \ref{fields-lemma-count-embeddings}). then we see that $\sigma(x) = \zeta \tau(x)$ for some $n$th root of unity $\zeta$ in $\overline{k}$. similarly, we see that $\sigma(x + 1) = \zeta' \tau(x + 1)$ for some $m$th root of unity $\zeta' \in \overline{k}$. since $\sigma(x + 1) \not = \tau(x + 1)$ we see $\zeta' \not = 1$. then $$ \zeta' (\tau(x) + 1) = \zeta' \tau(x + 1) = \sigma(x + 1) = \sigma(x) + 1 = \zeta \tau(x) + 1 $$ implies that $$ \tau(x) (\zeta' - \zeta) = 1 - \zeta' $$ hence $\zeta' \not = \zeta$ and $$ \tau(x) = (1 - \zeta')/(\zeta' - \zeta) $$ hence every element of $k'$ which is not in $k$ is algebraic over the prime subfield. since $k'$ is generated over the prime subfield by the elements of $k'$ which are not in $k$, we conclude that $k'$ (and hence $k$) is algebraic over the prime subfield. \medskip\noindent finally, if the characteristic of $k$ is $0$, the above leads to a contradiction as follows (we encourage the reader to find their own proof). for every rational number $y$ we similarly get a root of unity $\zeta_y$ such that $\sigma(x + y) = \zeta_y\tau(x + y)$. then we find $$ \zeta \tau(x) + y = \zeta_y(\tau(x) + y) $$ and by our formula for $\tau(x)$ above we conclude $\zeta_y \in \mathbf{q}(\zeta, \zeta')$. since the number field $\mathbf{q}(\zeta, \zeta')$ contains only a finite number of roots of unity we find two distinct rational numbers $y, y'$ with $\zeta_y = \zeta_{y'}$. then we conclude that $$ y - y' = \sigma(x + y) - \sigma(x + y') = \zeta_y(\tau(x + y)) - \zeta_{y'}\tau(x + y') = \zeta_y(y - y') $$ which implies $\zeta_y = 1$ a contradiction. \end{proof} \begin{lemma} \label{lemma-powers} let $\varphi : r \to s$ be a ring map. if \begin{enumerate} \item for any $x \in s$ there exists $n > 0$ such that $x^n$ is in the image of $\varphi$, and \item $\ker(\varphi)$ is locally nilpotent, \end{enumerate} then $\varphi$ induces a homeomorphism on spectra and induces residue field extensions satisfying the equivalent conditions of lemma \ref{lemma-powers-field}. \end{lemma} \begin{proof} assume (1) and (2). let $\mathfrak q, \mathfrak q'$ be primes of $s$ lying over the same prime ideal $\mathfrak p$ of $r$. suppose $x \in s$ with $x \in \mathfrak q$, $x \not \in \mathfrak q'$. then $x^n \in \mathfrak q$ and $x^n \not \in \mathfrak q'$ for all $n > 0$. if $x^n = \varphi(y)$ with $y \in r$ for some $n > 0$ then $$ x^n \in \mathfrak q \rightarrow y \in \mathfrak p \rightarrow x^n \in \mathfrak q' $$ which is a contradiction. hence there does not exist an $x$ as above and we conclude that $\mathfrak q = \mathfrak q'$, i.e., the map on spectra is injective. by assumption (2) the kernel $i = \ker(\varphi)$ is contained in every prime, hence $\spec(r) = \spec(r/i)$ as topological spaces. as the induced map $r/i \to s$ is integral by assumption (1) lemma \ref{lemma-integral-overring-surjective} shows that $\spec(s) \to \spec(r/i)$ is surjective. combining the above we see that $\spec(s) \to \spec(r)$ is bijective. if $x \in s$ is arbitrary, and we pick $y \in r$ such that $\varphi(y) = x^n$ for some $n > 0$, then we see that the open $d(x) \subset \spec(s)$ corresponds to the open $d(y) \subset \spec(r)$ via the bijection above. hence we see that the map $\spec(s) \to \spec(r)$ is a homeomorphism. \medskip\noindent to see the statement on residue fields, let $\mathfrak q \subset s$ be a prime lying over a prime ideal $\mathfrak p \subset r$. let $x \in \kappa(\mathfrak q)$. if we think of $\kappa(\mathfrak q)$ as the residue field of the local ring $s_\mathfrak q$, then we see that $x$ is the image of some $y/z \in s_\mathfrak q$ with $y \in s$, $z \in s$, $z \not \in \mathfrak q$. choose $n, m > 0$ such that $y^n, z^m$ are in the image of $\varphi$. then $x^{nm}$ is the residue of $(y/z)^{nm} = (y^n)^m/(z^m)^n$ which is in the image of $r_\mathfrak p \to s_\mathfrak q$. hence $x^{nm}$ is in the image of $\kappa(\mathfrak p) \to \kappa(\mathfrak q)$. \end{proof} \begin{lemma} \label{lemma-2-3-ring-map} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item[(a)] $s$ is generated as an $r$-algebra by elements $x$ such that $x^2, x^3 \in \varphi(r)$, and \item[(b)] $\ker(\varphi)$ is locally nilpotent, \end{enumerate} then $\varphi$ induces isomorphisms on residue fields and a homeomorphism of spectra. for any ring map $r \to r'$ the ring map $r' \to r' \otimes_r s$ also satisfies (a) and (b). \end{lemma} \begin{proof} assume (a) and (b). the map on spectra is closed as $s$ is integral over $r$, see lemmas \ref{lemma-going-up-closed} and \ref{lemma-integral-going-up}. the image is dense by lemma \ref{lemma-image-dense-generic-points}. thus $\spec(s) \to \spec(r)$ is surjective. if $\mathfrak q \subset s$ is a prime lying over $\mathfrak p \subset r$ then the field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is generated by elements $\alpha \in \kappa(\mathfrak q)$ whose square and cube are in $\kappa(\mathfrak p)$. thus clearly $\alpha \in \kappa(\mathfrak p)$ and we find that $\kappa(\mathfrak q) = \kappa(\mathfrak p)$. if $\mathfrak q, \mathfrak q'$ were two distinct primes lying over $\mathfrak p$, then at least one of the generators $x$ of $s$ as in (a) would have distinct images in $\kappa(\mathfrak q) = \kappa(\mathfrak p)$ and $\kappa(\mathfrak q') = \kappa(\mathfrak p)$. this would contradict the fact that both $x^2$ and $x^3$ do have the same image. this proves that $\spec(s) \to \spec(r)$ is injective hence a homeomorphism (by what was already shown). \medskip\noindent since $\varphi$ induces a homeomorphism on spectra, it is in particular surjective on spectra which is a property preserved under any base change, see lemma \ref{lemma-surjective-spec-radical-ideal}. therefore for any $r \to r'$ the kernel of the ring map $r' \to r' \otimes_r s$ consists of nilpotent elements, see lemma \ref{lemma-image-dense-generic-points}, in other words (b) holds for $r' \to r' \otimes_r s$. it is clear that (a) is preserved under base change. \end{proof} \begin{lemma} \label{lemma-help-with-powers} let $p$ be a prime number. let $n, m > 0$ be two integers. there exists an integer $a$ such that $(x + y)^{p^a}, p^a(x + y) \in \mathbf{z}[x^{p^n}, p^nx, y^{p^m}, p^my]$. \end{lemma} \begin{proof} this is clear for $p^a(x + y)$ as soon as $a \geq n, m$. in fact, pick $a \gg n, m$. write $$ (x + y)^{p^a} = \sum\nolimits_{i, j \geq 0, i + j = p^a} {p^a \choose i, j} x^iy^j $$ for every $i, j \geq 0$ with $i + j = p^a$ write $i = q p^n + r$ with $r \in \{0, \ldots, p^n - 1\}$ and $j = q' p^m + r'$ with $r' \in \{0, \ldots, p^m - 1\}$. the condition $(x + y)^{p^a} \in \mathbf{z}[x^{p^n}, p^nx, y^{p^m}, p^my]$ holds if $$ p^{nr + mr'} \text{ divides } {p^a \choose i, j} $$ if $r = r' = 0$ then the divisibility holds. if $r \not = 0$, then we write $$ {p^a \choose i, j} = \frac{p^a}{i} {p^a - 1 \choose i - 1, j} $$ since $r \not = 0$ the rational number $p^a/i$ has $p$-adic valuation at least $a - (n - 1)$ (because $i$ is not divisible by $p^n$). thus ${p^a \choose i, j}$ is divisible by $p^{a - n + 1}$ in this case. similarly, we see that if $r' \not = 0$, then ${p^a \choose i, j}$ is divisible by $p^{a - m + 1}$. picking $a = np^n + mp^m + n + m$ will work. \end{proof} \begin{lemma} \label{lemma-p-ring-map-field} let $k'/k$ be a field extension. let $p$ be a prime number. the following are equivalent \begin{enumerate} \item $k'$ is generated as a field extension of $k$ by elements $x$ such that there exists an $n > 0$ with $x^{p^n} \in k$ and $p^nx \in k$, and \item $k = k'$ or the characteristic of $k$ and $k'$ is $p$ and $k'/k$ is purely inseparable. \end{enumerate} \end{lemma} \begin{proof} let $x \in k'$. if there exists an $n > 0$ with $x^{p^n} \in k$ and $p^nx \in k$ and if the characteristic is not $p$, then $x \in k$. if the characteristic is $p$, then we find $x^{p^n} \in k$ and hence $x$ is purely inseparable over $k$. \end{proof} \begin{lemma} \label{lemma-p-ring-map} let $\varphi : r \to s$ be a ring map. let $p$ be a prime number. assume \begin{enumerate} \item[(a)] $s$ is generated as an $r$-algebra by elements $x$ such that there exists an $n > 0$ with $x^{p^n} \in \varphi(r)$ and $p^nx \in \varphi(r)$, and \item[(b)] $\ker(\varphi)$ is locally nilpotent, \end{enumerate} then $\varphi$ induces a homeomorphism of spectra and induces residue field extensions satisfying the equivalent conditions of lemma \ref{lemma-p-ring-map-field}. for any ring map $r \to r'$ the ring map $r' \to r' \otimes_r s$ also satisfies (a) and (b). \end{lemma} \begin{proof} assume (a) and (b). note that (b) is equivalent to condition (2) of lemma \ref{lemma-powers}. let $t \subset s$ be the set of elements $x \in s$ such that there exists an integer $n > 0$ such that $x^{p^n} , p^n x \in \varphi(r)$. we claim that $t = s$. this will prove that condition (1) of lemma \ref{lemma-powers} holds and hence $\varphi$ induces a homeomorphism on spectra. by assumption (a) it suffices to show that $t \subset s$ is an $r$-sub algebra. if $x \in t$ and $y \in r$, then it is clear that $yx \in t$. suppose $x, y \in t$ and $n, m > 0$ such that $x^{p^n}, y^{p^m}, p^n x, p^m y \in \varphi(r)$. then $(xy)^{p^{n + m}}, p^{n + m}xy \in \varphi(r)$ hence $xy \in t$. we have $x + y \in t$ by lemma \ref{lemma-help-with-powers} and the claim is proved. \medskip\noindent since $\varphi$ induces a homeomorphism on spectra, it is in particular surjective on spectra which is a property preserved under any base change, see lemma \ref{lemma-surjective-spec-radical-ideal}. therefore for any $r \to r'$ the kernel of the ring map $r' \to r' \otimes_r s$ consists of nilpotent elements, see lemma \ref{lemma-image-dense-generic-points}, in other words (b) holds for $r' \to r' \otimes_r s$. it is clear that (a) is preserved under base change. finally, the condition on residue fields follows from (a) as generators for $s$ as an $r$-algebra map to generators for the residue field extensions. \end{proof} \begin{lemma} \label{lemma-radicial} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $\varphi$ induces an injective map of spectra, \item $\varphi$ induces purely inseparable residue field extensions. \end{enumerate} then for any ring map $r \to r'$ properties (1) and (2) are true for $r' \to r' \otimes_r s$. \end{lemma} \begin{proof} set $s' = r' \otimes_r s$ so that we have a commutative diagram of continuous maps of spectra of rings $$ \xymatrix{ \spec(s') \ar[r] \ar[d] & \spec(s) \ar[d] \\ \spec(r') \ar[r] & \spec(r) } $$ let $\mathfrak p' \subset r'$ be a prime ideal lying over $\mathfrak p \subset r$. if there is no prime ideal of $s$ lying over $\mathfrak p$, then there is no prime ideal of $s'$ lying over $\mathfrak p'$. otherwise, by remark \ref{remark-fundamental-diagram} there is a unique prime ideal $\mathfrak r$ of $f = s \otimes_r \kappa(\mathfrak p)$ whose residue field is purely inseparable over $\kappa(\mathfrak p)$. consider the ring maps $$ \kappa(\mathfrak p) \to f \to \kappa(\mathfrak r) $$ by lemma \ref{lemma-minimal-prime-reduced-ring} the ideal $\mathfrak r \subset f$ is locally nilpotent, hence we may apply lemma \ref{lemma-surjective-locally-nilpotent-kernel} to the ring map $f \to \kappa(\mathfrak r)$. we may apply lemma \ref{lemma-p-ring-map} to the ring map $\kappa(\mathfrak p) \to \kappa(\mathfrak r)$. hence the composition and the second arrow in the maps $$ \kappa(\mathfrak p') \to \kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)} f \to \kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak r) $$ induces bijections on spectra and purely inseparable residue field extensions. this implies the same thing for the first map. since $$ \kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)} f = \kappa(\mathfrak p') \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p) \otimes_r s = \kappa(\mathfrak p') \otimes_r s = \kappa(\mathfrak p') \otimes_{r'} r' \otimes_r s $$ we conclude by the discussion in remark \ref{remark-fundamental-diagram}. \end{proof} \begin{lemma} \label{lemma-radicial-integral} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $\varphi$ is integral, \item $\varphi$ induces an injective map of spectra, \item $\varphi$ induces purely inseparable residue field extensions. \end{enumerate} then $\varphi$ induces a homeomorphism from $\spec(s)$ onto a closed subset of $\spec(r)$ and for any ring map $r \to r'$ properties (1), (2), (3) are true for $r' \to r' \otimes_r s$. \end{lemma} \begin{proof} the map on spectra is closed by lemmas \ref{lemma-going-up-closed} and \ref{lemma-integral-going-up}. the properties are preserved under base change by lemmas \ref{lemma-radicial} and \ref{lemma-base-change-integral}. \end{proof} \begin{lemma} \label{lemma-radicial-integral-bijective} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $\varphi$ is integral, \item $\varphi$ induces an bijective map of spectra, \item $\varphi$ induces purely inseparable residue field extensions. \end{enumerate} then $\varphi$ induces a homeomorphism on spectra and for any ring map $r \to r'$ properties (1), (2), (3) are true for $r' \to r' \otimes_r s$. \end{lemma} \begin{proof} follows from lemmas \ref{lemma-radicial-integral} and \ref{lemma-surjective-spec-radical-ideal}. \end{proof} \begin{lemma} \label{lemma-universally-bijective} let $\varphi : r \to s$ be a ring map such that \begin{enumerate} \item the kernel of $\varphi$ is locally nilpotent, and \item $s$ is generated as an $r$-algebra by elements $x$ such that there exist $n > 0$ and a polynomial $p(t) \in r[t]$ whose image in $s[t]$ is $(t - x)^n$. \end{enumerate} then $\spec(s) \to \spec(r)$ is a homeomorphism and $r \to s$ induces purely inseparable extensions of residue fields. moreover, conditions (1) and (2) remain true on arbitrary base change. \end{lemma} \begin{proof} we may replace $r$ by $r/\ker(\varphi)$, see lemma \ref{lemma-surjective-locally-nilpotent-kernel}. assumption (2) implies $s$ is generated over $r$ by elements which are integral over $r$. hence $r \subset s$ is integral (lemma \ref{lemma-integral-closure-is-ring}). in particular $\spec(s) \to \spec(r)$ is surjective and closed (lemmas \ref{lemma-integral-overring-surjective}, \ref{lemma-going-up-closed}, and \ref{lemma-integral-going-up}). \medskip\noindent let $x \in s$ be one of the generators in (2), i.e., there exists an $n > 0$ be such that $(t - x)^n \in r[t]$. let $\mathfrak p \subset r$ be a prime. the $\kappa(\mathfrak p) \otimes_r s$ ring is nonzero by the above and lemma \ref{lemma-in-image}. if the characteristic of $\kappa(\mathfrak p)$ is zero then we see that $nx \in r$ implies $1 \otimes x$ is in the image of $\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_r s$. hence $\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_r s$ is an isomorphism. if the characteristic of $\kappa(\mathfrak p)$ is $p > 0$, then write $n = p^k m$ with $m$ prime to $p$. in $\kappa(\mathfrak p) \otimes_r s[t]$ we have $$ (t - 1 \otimes x)^n = ((t - 1 \otimes x)^{p^k})^m = (t^{p^k} - 1 \otimes x^{p^k})^m $$ and we see that $mx^{p^k} \in r$. this implies that $1 \otimes x^{p^k}$ is in the image of $\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_r s$. hence lemma \ref{lemma-p-ring-map} applies to $\kappa(\mathfrak p) \to \kappa(\mathfrak p) \otimes_r s$. in both cases we conclude that $\kappa(\mathfrak p) \otimes_r s$ has a unique prime ideal with residue field purely inseparable over $\kappa(\mathfrak p)$. by remark \ref{remark-fundamental-diagram} we conclude that $\varphi$ is bijective on spectra. \medskip\noindent the statement on base change is immediate. \end{proof} \section{geometrically irreducible algebras} \label{section-algebras-over-fields} \noindent an algebra $s$ over a field $k$ is geometrically irreducible if the algebra $s \otimes_k k'$ has a unique minimal prime for every field extension $k'/k$. in this section we develop a bit of theory relevant to this notion. \begin{lemma} \label{lemma-flat-fibres-irreducible} let $r \to s$ be a ring map. assume \begin{enumerate} \item[(a)] $\spec(r)$ is irreducible, \item[(b)] $r \to s$ is flat, \item[(c)] $r \to s$ is of finite presentation, \item[(d)] the fibre rings $s \otimes_r \kappa(\mathfrak p)$ have irreducible spectra for a dense collection of primes $\mathfrak p$ of $r$. \end{enumerate} then $\spec(s)$ is irreducible. this is true more generally with (b) $+$ (c) replaced by ``the map $\spec(s) \to \spec(r)$ is open''. \end{lemma} \begin{proof} the assumptions (b) and (c) imply that the map on spectra is open, see proposition \ref{proposition-fppf-open}. hence the lemma follows from topology, lemma \ref{topology-lemma-irreducible-on-top}. \end{proof} \begin{lemma} \label{lemma-separably-closed-irreducible} let $k$ be a separably closed field. let $r$, $s$ be $k$-algebras. if $r$, $s$ have a unique minimal prime, so does $r \otimes_k s$. \end{lemma} \begin{proof} let $k \subset \overline{k}$ be a perfect closure, see definition \ref{definition-perfection}. by assumption $\overline{k}$ is algebraically closed. the ring maps $r \to r \otimes_k \overline{k}$ and $s \to s \otimes_k \overline{k}$ and $r \otimes_k s \to (r \otimes_k s) \otimes_k \overline{k} = (r \otimes_k \overline{k}) \otimes_{\overline{k}} (s \otimes_k \overline{k})$ satisfy the assumptions of lemma \ref{lemma-p-ring-map}. hence we may assume $k$ is algebraically closed. \medskip\noindent we may replace $r$ and $s$ by their reductions. hence we may assume that $r$ and $s$ are domains. by lemma \ref{lemma-perfect-reduced} we see that $r \otimes_k s$ is reduced. hence its spectrum is reducible if and only if it contains a nonzero zerodivisor. by lemma \ref{lemma-limit-argument} we reduce to the case where $r$ and $s$ are domains of finite type over $k$ algebraically closed. \medskip\noindent note that the ring map $r \to r \otimes_k s$ is of finite presentation and flat. moreover, for every maximal ideal $\mathfrak m$ of $r$ we have $(r \otimes_k s) \otimes_r r/\mathfrak m \cong s$ because $k \cong r/\mathfrak m$ by the hilbert nullstellensatz theorem \ref{theorem-nullstellensatz}. moreover, the set of maximal ideals is dense in the spectrum of $r$ since $\spec(r)$ is jacobson, see lemma \ref{lemma-finite-type-field-jacobson}. hence we see that lemma \ref{lemma-flat-fibres-irreducible} applies to the ring map $r \to r \otimes_k s$ and we conclude that the spectrum of $r \otimes_k s$ is irreducible as desired. \end{proof} \begin{lemma} \label{lemma-geometrically-irreducible} let $k$ be a field. let $r$ be a $k$-algebra. the following are equivalent \begin{enumerate} \item for every field extension $k'/k$ the spectrum of $r \otimes_k k'$ is irreducible, \item for every finite separable field extension $k'/k$ the spectrum of $r \otimes_k k'$ is irreducible, \item the spectrum of $r \otimes_k \overline{k}$ is irreducible where $\overline{k}$ is the separable algebraic closure of $k$, and \item the spectrum of $r \otimes_k \overline{k}$ is irreducible where $\overline{k}$ is the algebraic closure of $k$. \end{enumerate} \end{lemma} \begin{proof} it is clear that (1) implies (2). \medskip\noindent assume (2) and let $\overline{k}$ is the separable algebraic closure of $k$. suppose $\mathfrak q_i \subset r \otimes_k \overline{k}$, $i = 1, 2$ are two minimal prime ideals. for every finite subextension $\overline{k}/k'/k$ the extension $k'/k$ is separable and the ring map $r \otimes_k k' \to r \otimes_k \overline{k}$ is flat. hence $\mathfrak p_i = (r \otimes_k k') \cap \mathfrak q_i$ are minimal prime ideals (as we have going down for flat ring maps by lemma \ref{lemma-flat-going-down}). thus we see that $\mathfrak p_1 = \mathfrak p_2$ by assumption (2). since $\overline{k} = \bigcup k'$ we conclude $\mathfrak q_1 = \mathfrak q_2$. hence $\spec(r \otimes_k \overline{k})$ is irreducible. \medskip\noindent assume (3) and let $\overline{k}$ be the algebraic closure of $k$. let $\overline{k}/\overline{k}'/k$ be the corresponding separable algebraic closure of $k$. then $\overline{k}/\overline{k}'$ is purely inseparable (in positive characteristic) or trivial. hence $r \otimes_k \overline{k}' \to r \otimes_k \overline{k}$ induces a homeomorphism on spectra, for example by lemma \ref{lemma-p-ring-map}. thus we have (4). \medskip\noindent assume (4). let $k'/k$ be an arbitrary field extension and let $\overline{k}$ be the algebraic closure of $k$. we may choose a field $f$ such that both $k'$ and $\overline{k}$ are isomorphic to subfields of $f$. then $$ r \otimes_k f = (r \otimes_k \overline{k}) \otimes_{\overline{k}} f $$ and hence we see from lemma \ref{lemma-separably-closed-irreducible} that $r \otimes_k f$ has a unique minimal prime. finally, the ring map $r \otimes_k k' \to r \otimes_k f$ is flat and injective and hence any minimal prime of $r \otimes_k k'$ is the image of a minimal prime of $r \otimes_k f$ (by lemma \ref{lemma-injective-minimal-primes-in-image} and going down). we conclude that there is only one such minimal prime and the proof is complete. \end{proof} \begin{definition} \label{definition-geometrically-irreducible} let $k$ be a field. let $s$ be a $k$-algebra. we say $s$ is {\it geometrically irreducible over $k$} if for every field extension $k'/k$ the spectrum of $s \otimes_k k'$ is irreducible\footnote{an irreducible space is nonempty.}. \end{definition} \noindent by lemma \ref{lemma-geometrically-irreducible} it suffices to check this for finite separable field extensions $k'/k$ or for $k'$ equal to the separable algebraic closure of $k$. \begin{lemma} \label{lemma-separably-closed-irreducible-implies-geometric} let $k$ be a field. let $r$ be a $k$-algebra. if $k$ is separably algebraically closed then $r$ is geometrically irreducible over $k$ if and only if the spectrum of $r$ is irreducible. \end{lemma} \begin{proof} immediate from the remark following definition \ref{definition-geometrically-irreducible}. \end{proof} \begin{lemma} \label{lemma-subalgebra-geometrically-irreducible} let $k$ be a field. let $s$ be a $k$-algebra. \begin{enumerate} \item if $s$ is geometrically irreducible over $k$ so is every $k$-subalgebra. \item if all finitely generated $k$-subalgebras of $s$ are geometrically irreducible, then $s$ is geometrically irreducible. \item a directed colimit of geometrically irreducible $k$-algebras is geometrically irreducible. \end{enumerate} \end{lemma} \begin{proof} let $s' \subset s$ be a subalgebra. then for any extension $k'/k$ the ring map $s' \otimes_k k' \to s \otimes_k k'$ is injective also. hence (1) follows from lemma \ref{lemma-injective-minimal-primes-in-image} (and the fact that the image of an irreducible space under a continuous map is irreducible). the second and third property follow from the fact that tensor product commutes with colimits. \end{proof} \begin{lemma} \label{lemma-geometrically-irreducible-any-base-change} let $k$ be a field. let $s$ be a geometrically irreducible $k$-algebra. let $r$ be any $k$-algebra. the map $$ \spec(r \otimes_k s) \longrightarrow \spec(r) $$ induces a bijection on irreducible components. \end{lemma} \begin{proof} recall that irreducible components correspond to minimal primes (lemma \ref{lemma-irreducible}). as $r \to r \otimes_k s$ is flat we see by going down (lemma \ref{lemma-flat-going-down}) that any minimal prime of $r \otimes_k s$ lies over a minimal prime of $r$. conversely, if $\mathfrak p \subset r$ is a (minimal) prime then $$ r \otimes_k s/\mathfrak p(r \otimes_k s) = (r/\mathfrak p) \otimes_k s \subset \kappa(\mathfrak p) \otimes_k s $$ by flatness of $r \to r \otimes_k s$. the ring $\kappa(\mathfrak p) \otimes_k s$ has irreducible spectrum by assumption. it follows that $r \otimes_k s/\mathfrak p(r \otimes_k s)$ has a single minimal prime (lemma \ref{lemma-injective-minimal-primes-in-image}). in other words, the inverse image of the irreducible set $v(\mathfrak p)$ is irreducible. hence the lemma follows. \end{proof} \noindent let us make some remarks on the notion of geometrically irreducible field extensions. \begin{lemma} \label{lemma-field-extension-geometrically-irreducible} let $k/k$ be a field extension. if $k$ is algebraically closed in $k$, then $k$ is geometrically irreducible over $k$. \end{lemma} \begin{proof} assume $k$ is algebraically closed in $k$. by definition \ref{definition-geometrically-irreducible} and lemma \ref{lemma-geometrically-irreducible} it suffices to show that the spectrum of $k \otimes_k k'$ is irreducible for every finite separable extension $k'/k$. say $k'$ is generated by $\alpha \in k'$ over $k$, see fields, lemma \ref{fields-lemma-primitive-element}. let $p = t^d + a_1 t^{d - 1} + \ldots + a_d \in k[t]$ be the minimal polynomial of $\alpha$. then $k \otimes_k k' \cong k[t]/(p)$. the only way the spectrum of $k[t]/(p)$ can be reducible is if $p$ is reducible in $k[t]$. assume $p = p_1 p_2$ is a nontrivial factorization in $k[t]$ to get a contradiction. by lemma \ref{lemma-polynomials-divide} we see that the coefficients of $p_1$ and $p_2$ are algebraic over $k$. our assumption implies the coefficients of $p_1$ and $p_2$ are in $k$ which contradicts the fact that $p$ is irreducible over $k$. \end{proof} \begin{lemma} \label{lemma-geometrically-irreducible-transitive} let $k/k$ be a geometrically irreducible field extension. let $s$ be a geometrically irreducible $k$-algebra. then $s$ is geometrically irreducible over $k$. \end{lemma} \begin{proof} by definition \ref{definition-geometrically-irreducible} and lemma \ref{lemma-geometrically-irreducible} it suffices to show that the spectrum of $s \otimes_k k'$ is irreducible for every finite separable extension $k'/k$. since $k$ is geometrically irreducible over $k$ we see that $k' = k \otimes_k k'$ is a finite, separable field extension of $k$. hence the spectrum of $s \otimes_k k' = s \otimes_k k'$ is irreducible as $s$ is assumed geometrically irreducible over $k$. \end{proof} \begin{lemma} \label{lemma-geometrically-irreducible-base-change-transcendental} let $k/k$ be a field extension. the following are equivalent \begin{enumerate} \item $k$ is geometrically irreducible over $k$, and \item the induced extension $k(t)/k(t)$ of purely transcendental extensions is geometrically irreducible. \end{enumerate} \end{lemma} \begin{proof} assume (1). denote $\omega$ an algebraic closure of $k(t)$. by definition \ref{definition-geometrically-irreducible} we find that the spectrum of $$ k \otimes_k \omega = k \otimes_k k(t) \otimes_{k(t)} \omega $$ is irreducible. since $k(t)$ is a localization of $k \otimes_k k(t)$ we conclude that the spectrum of $k(t) \otimes_{k(t)} \omega$ is irreducible. thus by lemma \ref{lemma-geometrically-irreducible} we find that $k(t)/k(t)$ is geometrically irreducible. \medskip\noindent assume (2). let $k'/k$ be a field extension. we have to show that $k \otimes_k k'$ has a unique minimal prime. we know that the spectrum of $$ k(t) \otimes_{k(t)} k'(t) $$ is irreducible, i.e., has a unique minimal prime. since there is an injective map $k \otimes_k k' \to k(t) \otimes_{k(t)} k'(t)$ (details omitted) we conclude by lemmas \ref{lemma-injective-minimal-primes-in-image} and \ref{lemma-minimal-prime-image-minimal-prime}. \end{proof} \begin{lemma} \label{lemma-geometrically-irreducible-add-transcendental} let $k/l/m$ be a tower of fields with $l/m$ geometrically irreducible. let $x \in k$ be transcendental over $l$. then $l(x)/m(x)$ is geometrically irreducible. \end{lemma} \begin{proof} this follows from lemma \ref{lemma-geometrically-irreducible-base-change-transcendental} because the fields $l(x)$ and $m(x)$ are purely transcendental extensions of $l$ and $m$. \end{proof} \begin{lemma} \label{lemma-geometrically-irreducible-separable-elements} let $k/k$ be a field extension. the following are equivalent \begin{enumerate} \item $k/k$ is geometrically irreducible, and \item every element $\alpha \in k$ separably algebraic over $k$ is in $k$. \end{enumerate} \end{lemma} \begin{proof} assume (1) and let $\alpha \in k$ be separably algebraic over $k$. then $k' = k(\alpha)$ is a finite separable extension of $k$ contained in $k$. by lemma \ref{lemma-subalgebra-geometrically-irreducible} the extension $k'/k$ is geometrically irreducible. in particular, we see that the spectrum of $k' \otimes_k \overline{k}$ is irreducible (and hence if it is a product of fields, then there is exactly one factor). by fields, lemma \ref{fields-lemma-finite-separable-tensor-alg-closed} it follows that $\hom_k(k', \overline{k})$ has one element which in turn implies that $k' = k$ by fields, lemma \ref{fields-lemma-separable-equality}. thus (2) holds. \medskip\noindent assume (2). let $k' \subset k$ be the subfield consisting of elements algebraic over $k$. by lemma \ref{lemma-field-extension-geometrically-irreducible} the extension $k/k'$ is geometrically irreducible. by assumption $k'/k$ is a purely inseparable extension. by lemma \ref{lemma-p-ring-map} the extension $k'/k$ is geometrically irreducible. hence by lemma \ref{lemma-geometrically-irreducible-transitive} we see that $k/k$ is geometrically irreducible. \end{proof} \begin{lemma} \label{lemma-make-geometrically-irreducible} let $k/k$ be a field extension. consider the subextension $k/k'/k$ consisting of elements separably algebraic over $k$. then $k$ is geometrically irreducible over $k'$. if $k/k$ is a finitely generated field extension, then $[k' : k] < \infty$. \end{lemma} \begin{proof} the first statement is immediate from lemma \ref{lemma-geometrically-irreducible-separable-elements} and the fact that elements separably algebraic over $k'$ are in $k'$ by the transitivity of separable algebraic extensions, see fields, lemma \ref{fields-lemma-separable-permanence}. if $k/k$ is finitely generated, then $k'$ is finite over $k$ by fields, lemma \ref{fields-lemma-algebraic-closure-in-finitely-generated}. \end{proof} \begin{lemma} \label{lemma-galois-orbit} let $k/k$ be an extension of fields. let $\overline{k}/k$ be a separable algebraic closure. then $\text{gal}(\overline{k}/k)$ acts transitively on the primes of $\overline{k} \otimes_k k$. \end{lemma} \begin{proof} let $k/k'/k$ be the subextension found in lemma \ref{lemma-make-geometrically-irreducible}. note that as $k \subset \overline{k}$ is integral all the prime ideals of $\overline{k} \otimes_k k$ and $\overline{k} \otimes_k k'$ are maximal, see lemma \ref{lemma-integral-no-inclusion}. by lemma \ref{lemma-geometrically-irreducible-any-base-change} the map $$ \spec(\overline{k} \otimes_k k) \to \spec(\overline{k} \otimes_k k') $$ is bijective because (1) all primes are minimal primes, (2) $\overline{k} \otimes_k k = (\overline{k} \otimes_k k') \otimes_{k'} k$, and (3) $k$ is geometrically irreducible over $k'$. hence it suffices to prove the lemma for the action of $\text{gal}(\overline{k}/k)$ on the primes of $\overline{k} \otimes_k k'$. \medskip\noindent as every prime of $\overline{k} \otimes_k k'$ is maximal, the residue fields are isomorphic to $\overline{k}$. hence the prime ideals of $\overline{k} \otimes_k k'$ correspond one to one to elements of $\hom_k(k', \overline{k})$ with $\sigma \in \hom_k(k', \overline{k})$ corresponding to the kernel $\mathfrak p_\sigma$ of $1 \otimes \sigma : \overline{k} \otimes_k k' \to \overline{k}$. in particular $\text{gal}(\overline{k}/k)$ acts transitively on this set as desired. \end{proof} \section{geometrically connected algebras} \label{section-geometrically-connected} \begin{lemma} \label{lemma-separably-closed-connected} let $k$ be a separably algebraically closed field. let $r$, $s$ be $k$-algebras. if $\spec(r)$, and $\spec(s)$ are connected, then so is $\spec(r \otimes_k s)$. \end{lemma} \begin{proof} recall that $\spec(r)$ is connected if and only if $r$ has no nontrivial idempotents, see lemma \ref{lemma-characterize-spec-connected}. hence, by lemma \ref{lemma-limit-argument} we may assume $r$ and $s$ are of finite type over $k$. in this case $r$ and $s$ are noetherian, and have finitely many minimal primes, see lemma \ref{lemma-noetherian-irreducible-components}. thus we may argue by induction on $n + m$ where $n$, resp.\ $m$ is the number of irreducible components of $\spec(r)$, resp.\ $\spec(s)$. of course the case where either $n$ or $m$ is zero is trivial. if $n = m = 1$, i.e., $\spec(r)$ and $\spec(s)$ both have one irreducible component, then the result holds by lemma \ref{lemma-separably-closed-irreducible}. suppose that $n > 1$. let $\mathfrak p \subset r$ be a minimal prime corresponding to the irreducible closed subset $t \subset \spec(r)$. let $t' \subset \spec(r)$ be the union of the other $n - 1$ irreducible components. choose an ideal $i \subset r$ such that $t' = v(i) = \spec(r/i)$ (lemma \ref{lemma-spec-closed}). by choosing our minimal prime carefully we may in addition arrange it so that $t'$ is connected, see topology, lemma \ref{topology-lemma-remove-irreducible-connected}. then $t \cup t' = \spec(r)$ and $t \cap t' = v(\mathfrak p + i) = \spec(r/(\mathfrak p + i))$ is not empty as $\spec(r)$ is assumed connected. the inverse image of $t$ in $\spec(r \otimes_k s)$ is $\spec(r/\mathfrak p \otimes_k s)$, and the inverse of $t'$ in $\spec(r \otimes_k s)$ is $\spec(r/i \otimes_k s)$. by induction these are both connected. the inverse image of $t \cap t'$ is $\spec(r/(\mathfrak p + i) \otimes_k s)$ which is nonempty. hence $\spec(r \otimes_k s)$ is connected. \end{proof} \begin{lemma} \label{lemma-geometrically-connected} let $k$ be a field. let $r$ be a $k$-algebra. the following are equivalent \begin{enumerate} \item for every field extension $k'/k$ the spectrum of $r \otimes_k k'$ is connected, and \item for every finite separable field extension $k'/k$ the spectrum of $r \otimes_k k'$ is connected. \end{enumerate} \end{lemma} \begin{proof} for any extension of fields $k'/k$ the connectivity of the spectrum of $r \otimes_k k'$ is equivalent to $r \otimes_k k'$ having no nontrivial idempotents, see lemma \ref{lemma-characterize-spec-connected}. assume (2). let $k \subset \overline{k}$ be a separable algebraic closure of $k$. using lemma \ref{lemma-limit-argument} we see that (2) is equivalent to $r \otimes_k \overline{k}$ having no nontrivial idempotents. for any field extension $k'/k$, there exists a field extension $\overline{k}'/\overline{k}$ with $k' \subset \overline{k}'$. by lemma \ref{lemma-separably-closed-connected} we see that $r \otimes_k \overline{k}'$ has no nontrivial idempotents. if $r \otimes_k k'$ has a nontrivial idempotent, then also $r \otimes_k \overline{k}'$, contradiction. \end{proof} \begin{definition} \label{definition-geometrically-connected} let $k$ be a field. let $s$ be a $k$-algebra. we say $s$ is {\it geometrically connected over $k$} if for every field extension $k'/k$ the spectrum of $s \otimes_k k'$ is connected. \end{definition} \noindent by lemma \ref{lemma-geometrically-connected} it suffices to check this for finite separable field extensions $k'/k$. \begin{lemma} \label{lemma-separably-closed-connected-implies-geometric} let $k$ be a field. let $r$ be a $k$-algebra. if $k$ is separably algebraically closed then $r$ is geometrically connected over $k$ if and only if the spectrum of $r$ is connected. \end{lemma} \begin{proof} immediate from the remark following definition \ref{definition-geometrically-connected}. \end{proof} \begin{lemma} \label{lemma-subalgebra-geometrically-connected} let $k$ be a field. let $s$ be a $k$-algebra. \begin{enumerate} \item if $s$ is geometrically connected over $k$ so is every $k$-subalgebra. \item if all finitely generated $k$-subalgebras of $s$ are geometrically connected, then $s$ is geometrically connected. \item a directed colimit of geometrically connected $k$-algebras is geometrically connected. \end{enumerate} \end{lemma} \begin{proof} this follows from the characterization of connectedness in terms of the nonexistence of nontrivial idempotents. the second and third property follow from the fact that tensor product commutes with colimits. \end{proof} \noindent the following lemma will be superseded by the more general varieties, lemma \ref{varieties-lemma-bijection-connected-components}. \begin{lemma} \label{lemma-geometrically-connected-any-base-change} let $k$ be a field. let $s$ be a geometrically connected $k$-algebra. let $r$ be any $k$-algebra. the map $$ r \longrightarrow r \otimes_k s $$ induces a bijection on idempotents, and the map $$ \spec(r \otimes_k s) \longrightarrow \spec(r) $$ induces a bijection on connected components. \end{lemma} \begin{proof} the second assertion follows from the first combined with lemma \ref{lemma-connected-component}. by lemmas \ref{lemma-subalgebra-geometrically-connected} and \ref{lemma-limit-argument} we may assume that $r$ and $s$ are of finite type over $k$. then we see that also $r \otimes_k s$ is of finite type over $k$. note that in this case all the rings are noetherian and hence their spectra have finitely many connected components (since they have finitely many irreducible components, see lemma \ref{lemma-noetherian-irreducible-components}). in particular, all connected components in question are open! hence via lemma \ref{lemma-disjoint-implies-product} we see that the first statement of the lemma in this case is equivalent to the second. let's prove this. as the algebra $s$ is geometrically connected and nonzero we see that all fibres of $x = \spec(r \otimes_k s) \to \spec(r) = y$ are connected and nonempty. also, as $r \to r \otimes_k s$ is flat of finite presentation the map $x \to y$ is open (proposition \ref{proposition-fppf-open}). topology, lemma \ref{topology-lemma-connected-fibres-connected-components} shows that $x \to y$ induces bijection on connected components. \end{proof} \section{geometrically integral algebras} \label{section-geometrically-integral} \noindent here is the definition. \begin{definition} \label{definition-geometrically-integral} let $k$ be a field. let $s$ be a $k$-algebra. we say $s$ is {\it geometrically integral over $k$} if for every field extension $k'/k$ the ring of $s \otimes_k k'$ is a domain. \end{definition} \noindent any question about geometrically integral algebras can be translated in a question about geometrically reduced and irreducible algebras. \begin{lemma} \label{lemma-geometrically-integral} let $k$ be a field. let $s$ be a $k$-algebra. in this case $s$ is geometrically integral over $k$ if and only if $s$ is geometrically irreducible as well as geometrically reduced over $k$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-characterize-geometrically-integral} let $k$ be a field. let $s$ be a $k$-algebra. the following are equivalent \begin{enumerate} \item $s$ is geometrically integral over $k$, \item for every finite extension $k'/k$ of fields the ring $s \otimes_k k'$ is a domain, \item $s \otimes_k \overline{k}$ is a domain where $\overline{k}$ is the algebraic closure of $k$. \end{enumerate} \end{lemma} \begin{proof} follows from lemmas \ref{lemma-geometrically-integral}, \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}, and \ref{lemma-geometrically-irreducible}. \end{proof} \begin{lemma} \label{lemma-geometrically-integral-any-integral-base-change} let $k$ be a field. let $s$ be a geometrically integral $k$-algebra. let $r$ be a $k$-algebra and an integral domain. then $r \otimes_k s$ is an integral domain. \end{lemma} \begin{proof} by lemma \ref{lemma-geometrically-reduced-any-reduced-base-change} the ring $r \otimes_k s$ is reduced and by lemma \ref{lemma-geometrically-irreducible-any-base-change} the ring $r \otimes_k s$ is irreducible (the spectrum has just one irreducible component), so $r \otimes_k s$ is an integral domain. \end{proof} \section{valuation rings} \label{section-valuation-rings} \noindent here are some definitions. \begin{definition} \label{definition-valuation-ring} valuation rings. \begin{enumerate} \item let $k$ be a field. let $a$, $b$ be local rings contained in $k$. we say that $b$ {\it dominates} $a$ if $a \subset b$ and $\mathfrak m_a = a \cap \mathfrak m_b$. \item let $a$ be a ring. we say $a$ is a {\it valuation ring} if $a$ is a local domain and if $a$ is maximal for the relation of domination among local rings contained in the fraction field of $a$. \item let $a$ be a valuation ring with fraction field $k$. if $r \subset k$ is a subring of $k$, then we say $a$ is {\it centered} on $r$ if $r \subset a$. \end{enumerate} \end{definition} \noindent with this definition a field is a valuation ring. \begin{lemma} \label{lemma-dominate} let $k$ be a field. let $a \subset k$ be a local subring. then there exists a valuation ring with fraction field $k$ dominating $a$. \end{lemma} \begin{proof} we consider the collection of local subrings of $k$ as a partially ordered set using the relation of domination. suppose that $\{a_i\}_{i \in i}$ is a totally ordered collection of local subrings of $k$. then $b = \bigcup a_i$ is a local subring which dominates all of the $a_i$. hence by zorn's lemma, it suffices to show that if $a \subset k$ is a local ring whose fraction field is not $k$, then there exists a local ring $b \subset k$, $b \not = a$ dominating $a$. \medskip\noindent pick $t \in k$ which is not in the fraction field of $a$. if $t$ is transcendental over $a$, then $a[t] \subset k$ and hence $a[t]_{(t, \mathfrak m)} \subset k$ is a local ring distinct from $a$ dominating $a$. suppose $t$ is algebraic over $a$. then for some nonzero $a \in a$ the element $at$ is integral over $a$. in this case the subring $a' \subset k$ generated by $a$ and $ta$ is finite over $a$. by lemma \ref{lemma-integral-overring-surjective} there exists a prime ideal $\mathfrak m' \subset a'$ lying over $\mathfrak m$. then $a'_{\mathfrak m'}$ dominates $a$. if $a = a'_{\mathfrak m'}$, then $t$ is in the fraction field of $a$ which we assumed not to be the case. thus $a \not = a'_{\mathfrak m'}$ as desired. \end{proof} \begin{lemma} \label{lemma-valuation-ring-normal} let $a$ be a valuation ring. then $a$ is a normal domain. \end{lemma} \begin{proof} suppose $x$ is in the field of fractions of $a$ and integral over $a$. let $a'$ denote the subring of $k$ generated by $a$ and $x$. since $a\subset a'$ is an integral extension, we see by lemma \ref{lemma-integral-overring-surjective} that there is a prime ideal $\mathfrak m' \subset a'$ lying over $\mathfrak m$. then $a'_{\mathfrak m'}$ dominates $a$. since $a$ is a valuation ring we conclude that $a=a'_{\mathfrak m'}$ and therefore that $x\in a$. \end{proof} \begin{lemma} \label{lemma-valuation-ring-x-or-x-inverse} let $a$ be a valuation ring with maximal ideal $\mathfrak m$ and fraction field $k$. let $x \in k$. then either $x \in a$ or $x^{-1} \in a$ or both. \end{lemma} \begin{proof} assume that $x$ is not in $a$. let $a'$ denote the subring of $k$ generated by $a$ and $x$. since $a$ is a valuation ring we see that there is no prime of $a'$ lying over $\mathfrak m$. since $\mathfrak m$ is maximal we see that $v(\mathfrak m a') = \emptyset$. then $\mathfrak m a' = a'$ by lemma \ref{lemma-zariski-topology}. hence we can write $1 = \sum_{i = 0}^d t_i x^i$ with $t_i \in \mathfrak m$. this implies that $(1 - t_0) (x^{-1})^d - \sum t_i (x^{-1})^{d - i} = 0$. in particular we see that $x^{-1}$ is integral over $a$, and hence $x^{-1} \in a$ by lemma \ref{lemma-valuation-ring-normal}. \end{proof} \begin{lemma} \label{lemma-x-or-x-inverse-valuation-ring} let $a \subset k$ be a subring of a field $k$ such that for all $x \in k$ either $x \in a$ or $x^{-1} \in a$ or both. then $a$ is a valuation ring with fraction field $k$. \end{lemma} \begin{proof} if $a$ is not $k$, then $a$ is not a field and there is a nonzero maximal ideal $\mathfrak m$. if $\mathfrak m'$ is a second maximal ideal, then choose $x, y \in a$ with $x \in \mathfrak m$, $y \not \in \mathfrak m$, $x \not \in \mathfrak m'$, and $y \in \mathfrak m'$. then neither $x/y \in a$ nor $y/x \in a$ contradicting the assumption of the lemma. thus we see that $a$ is a local ring. suppose that $a'$ is a local ring contained in $k$ which dominates $a$. let $x \in a'$. we have to show that $x \in a$. if not, then $x^{-1} \in a$, and of course $x^{-1} \in \mathfrak m_a$. but then $x^{-1} \in \mathfrak m_{a'}$ which contradicts $x \in a'$. \end{proof} \begin{lemma} \label{lemma-colimit-valuation-rings} \begin{slogan} valuation rings are stable under filtered direct limits \end{slogan} let $i$ be a directed set. let $(a_i, \varphi_{ij})$ be a system of valuation rings over $i$. then $a = \colim a_i$ is a valuation ring. \end{lemma} \begin{proof} it is clear that $a$ is a domain. let $a, b \in a$. lemma \ref{lemma-x-or-x-inverse-valuation-ring} tells us we have to show that either $a | b$ or $b | a$ in $a$. choose $i$ so large that there exist $a_i, b_i \in a_i$ mapping to $a, b$. then lemma \ref{lemma-valuation-ring-x-or-x-inverse} applied to $a_i, b_i$ in $a_i$ implies the result for $a, b$ in $a$. \end{proof} \begin{lemma} \label{lemma-valuation-ring-cap-field} let $l/k$ be an extension of fields. if $b \subset l$ is a valuation ring, then $a = k \cap b$ is a valuation ring. \end{lemma} \begin{proof} we can replace $l$ by the fraction field $f$ of $b$ and $k$ by $k \cap f$. then the lemma follows from a combination of lemmas \ref{lemma-valuation-ring-x-or-x-inverse} and \ref{lemma-x-or-x-inverse-valuation-ring}. \end{proof} \begin{lemma} \label{lemma-valuation-ring-cap-field-finite} let $l/k$ be an algebraic extension of fields. if $b \subset l$ is a valuation ring with fraction field $l$ and not a field, then $a = k \cap b$ is a valuation ring and not a field. \end{lemma} \begin{proof} by lemma \ref{lemma-valuation-ring-cap-field} the ring $a$ is a valuation ring. if $a$ is a field, then $a = k$. then $a = k \subset b$ is an integral extension, hence there are no proper inclusions among the primes of $b$ (lemma \ref{lemma-integral-no-inclusion}). this contradicts the assumption that $b$ is a local domain and not a field. \end{proof} \begin{lemma} \label{lemma-make-valuation-rings} let $a$ be a valuation ring. for any prime ideal $\mathfrak p \subset a$ the quotient $a/\mathfrak p$ is a valuation ring. the same is true for the localization $a_\mathfrak p$ and in fact any localization of $a$. \end{lemma} \begin{proof} use the characterization of valuation rings given in lemma \ref{lemma-x-or-x-inverse-valuation-ring}. \end{proof} \begin{lemma} \label{lemma-stack-valuation-rings} let $a'$ be a valuation ring with residue field $k$. let $a$ be a valuation ring with fraction field $k$. then $c = \{\lambda \in a' \mid \lambda \bmod \mathfrak m_{a'} \in a\}$ is a valuation ring. \end{lemma} \begin{proof} note that $\mathfrak m_{a'} \subset c$ and $c/\mathfrak m_{a'} = a$. in particular, the fraction field of $c$ is equal to the fraction field of $a'$. we will use the criterion of lemma \ref{lemma-x-or-x-inverse-valuation-ring} to prove the lemma. let $x$ be an element of the fraction field of $c$. by the lemma we may assume $x \in a'$. if $x \in \mathfrak m_{a'}$, then we see $x \in c$. if not, then $x$ is a unit of $a'$ and we also have $x^{-1} \in a'$. hence either $x$ or $x^{-1}$ maps to an element of $a$ by the lemma again. \end{proof} \begin{lemma} \label{lemma-find-valuation-rings} let $a$ be a normal domain with fraction field $k$. \begin{enumerate} \item for every $x \in k$, $x \not \in a$ there exists a valuation ring $a \subset v \subset k$ with fraction field $k$ such that $x \not \in v$. \item if $a$ is local, we can moreover choose $v$ which dominates $a$. \end{enumerate} in other words, $a$ is the intersection of all valuation rings in $k$ containing $a$ and if $a$ is local, then $a$ is the intersection of all valuation rings in $k$ dominating $a$. \end{lemma} \begin{proof} suppose $x \in k$, $x \not \in a$. consider $b = a[x^{-1}]$. then $x \not \in b$. namely, if $x = a_0 + a_1x^{-1} + \ldots + a_d x^{-d}$ then $x^{d + 1} - a_0x^d - \ldots - a_d = 0$ and $x$ is integral over $a$ in contradiction with the fact that $a$ is normal. thus $x^{-1}$ is not a unit in $b$. thus $v(x^{-1}) \subset \spec(b)$ is not empty (lemma \ref{lemma-zariski-topology}), and we can choose a prime $\mathfrak p \subset b$ with $x^{-1} \in \mathfrak p$. choose a valuation ring $v \subset k$ dominating $b_\mathfrak p$ (lemma \ref{lemma-dominate}). then $x \not \in v$ as $x^{-1} \in \mathfrak m_v$. \medskip\noindent if $a$ is local, then we claim that $x^{-1} b + \mathfrak m_a b \not = b$. namely, if $1 = (a_0 + a_1x^{-1} + \ldots + a_d x^{-d})x^{-1} + a'_0 + \ldots + a'_d x^{-d}$ with $a_i \in a$ and $a'_i \in \mathfrak m_a$, then we'd get $$ (1 - a'_0) x^{d + 1} - (a_0 + a'_1) x^d - \ldots - a_d = 0 $$ since $a'_0 \in \mathfrak m_a$ we see that $1 - a'_0$ is a unit in $a$ and we conclude that $x$ would be integral over $a$, a contradiction as before. then choose the prime $\mathfrak p \supset x^{-1} b + \mathfrak m_a b$ we find $v$ dominating $a$. \end{proof} \noindent an {\it totally ordered abelian group} is a pair $(\gamma, \geq)$ consisting of an abelian group $\gamma$ endowed with a total ordering $\geq$ such that $\gamma \geq \gamma' \rightarrow \gamma + \gamma'' \geq \gamma' + \gamma''$ for all $\gamma, \gamma', \gamma'' \in \gamma$. \begin{lemma} \label{lemma-valuation-group} let $a$ be a valuation ring with field of fractions $k$. set $\gamma = k^*/a^*$ (with group law written additively). for $\gamma, \gamma' \in \gamma$ define $\gamma \geq \gamma'$ if and only if $\gamma - \gamma'$ is in the image of $a - \{0\} \to \gamma$. then $(\gamma, \geq)$ is a totally ordered abelian group. \end{lemma} \begin{proof} omitted, but follows easily from lemma \ref{lemma-valuation-ring-x-or-x-inverse}. note that in case $a = k$ we obtain the zero group $\gamma = \{0\}$ endowed with its unique total ordering. \end{proof} \begin{definition} \label{definition-value-group} let $a$ be a valuation ring. \begin{enumerate} \item the totally ordered abelian group $(\gamma, \geq)$ of lemma \ref{lemma-valuation-group} is called the {\it value group} of the valuation ring $a$. \item the map $v : a - \{0\} \to \gamma$ and also $v : k^* \to \gamma$ is called the {\it valuation} associated to $a$. \item the valuation ring $a$ is called a {\it discrete valuation ring} if $\gamma \cong \mathbf{z}$. \end{enumerate} \end{definition} \noindent note that if $\gamma \cong \mathbf{z}$ then there is a unique such isomorphism such that $1 \geq 0$. if the isomorphism is chosen in this way, then the ordering becomes the usual ordering of the integers. \begin{lemma} \label{lemma-properties-valuation} let $a$ be a valuation ring. the valuation $v : a -\{0\} \to \gamma_{\geq 0}$ has the following properties: \begin{enumerate} \item $v(a) = 0 \leftrightarrow a \in a^*$, \item $v(ab) = v(a) + v(b)$, \item $v(a + b) \geq \min(v(a), v(b))$ provided $a + b \not = 0$. \end{enumerate} \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-characterize-valuation-ring} let $a$ be a ring. the following are equivalent \begin{enumerate} \item $a$ is a valuation ring, \item $a$ is a local domain and every finitely generated ideal of $a$ is principal. \end{enumerate} \end{lemma} \begin{proof} assume $a$ is a valuation ring and let $f_1, \ldots, f_n \in a$. choose $i$ such that $v(f_i)$ is minimal among $v(f_j)$. then $(f_i) = (f_1, \ldots, f_n)$. conversely, assume $a$ is a local domain and every finitely generated ideal of $a$ is principal. pick $f, g \in a$ and write $(f, g) = (h)$. then $f = ah$ and $g = bh$ and $h = cf + dg$ for some $a, b, c, d \in a$. thus $ac + bd = 1$ and we see that either $a$ or $b$ is a unit, i.e., either $g/f$ or $f/g$ is an element of $a$. this shows $a$ is a valuation ring by lemma \ref{lemma-x-or-x-inverse-valuation-ring}. \end{proof} \begin{lemma} \label{lemma-valuation-valuation-ring} let $(\gamma, \geq)$ be a totally ordered abelian group. let $k$ be a field. let $v : k^* \to \gamma$ be a homomorphism of abelian groups such that $v(a + b) \geq \min(v(a), v(b))$ for $a, b \in k$ with $a, b, a + b$ not zero. then $$ a = \{ x \in k \mid x = 0 \text{ or } v(x) \geq 0 \} $$ is a valuation ring with value group $\im(v) \subset \gamma$, with maximal ideal $$ \mathfrak m = \{ x \in k \mid x = 0 \text{ or } v(x) > 0 \} $$ and with group of units $$ a^* = \{ x \in k^* \mid v(x) = 0 \}. $$ \end{lemma} \begin{proof} omitted. \end{proof} \noindent let $(\gamma, \geq)$ be a totally ordered abelian group. an {\it ideal of $\gamma$} is a subset $i \subset \gamma$ such that all elements of $i$ are $\geq 0$ and $\gamma \in i$, $\gamma' \geq \gamma$ implies $\gamma' \in i$. we say that such an ideal is {\it prime} if $0 \not \in i$ and if $\gamma + \gamma' \in i, \gamma, \gamma' \geq 0 \rightarrow \gamma \in i \text{ or } \gamma' \in i$. \begin{lemma} \label{lemma-ideals-valuation-ring} let $a$ be a valuation ring. ideals in $a$ correspond $1 - 1$ with ideals of $\gamma$. this bijection is inclusion preserving, and maps prime ideals to prime ideals. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-valuation-ring-noetherian-discrete} a valuation ring is noetherian if and only if it is a discrete valuation ring or a field. \end{lemma} \begin{proof} suppose $a$ is a discrete valuation ring with valuation $v : a \setminus \{0\} \to \mathbf{z}$ normalized so that $\im(v) = \mathbf{z}_{\geq 0}$. by lemma \ref{lemma-ideals-valuation-ring} the ideals of $a$ are the subsets $i_n = \{0\} \cup v^{-1}(\mathbf{z}_{\geq n})$. it is clear that any element $x \in a$ with $v(x) = n$ generates $i_n$. hence $a$ is a pid so certainly noetherian. \medskip\noindent suppose $a$ is a noetherian valuation ring with value group $\gamma$. by lemma \ref{lemma-ideals-valuation-ring} we see the ascending chain condition holds for ideals in $\gamma$. we may assume $a$ is not a field, i.e., there is a $\gamma \in \gamma$ with $\gamma > 0$. applying the ascending chain condition to the subsets $\gamma + \gamma_{\geq 0}$ with $\gamma > 0$ we see there exists a smallest element $\gamma_0$ which is bigger than $0$. let $\gamma \in \gamma$ be an element $\gamma > 0$. consider the sequence of elements $\gamma$, $\gamma - \gamma_0$, $\gamma - 2\gamma_0$, etc. by the ascending chain condition these cannot all be $> 0$. let $\gamma - n \gamma_0$ be the last one $\geq 0$. by minimality of $\gamma_0$ we see that $0 = \gamma - n \gamma_0$. hence $\gamma$ is a cyclic group as desired. \end{proof} \section{more noetherian rings} \label{section-noetherian-again} \begin{lemma} \label{lemma-noetherian-basic} let $r$ be a noetherian ring. any finite $r$-module is of finite presentation. any submodule of a finite $r$-module is finite. the ascending chain condition holds for $r$-submodules of a finite $r$-module. \end{lemma} \begin{proof} we first show that any submodule $n$ of a finite $r$-module $m$ is finite. we do this by induction on the number of generators of $m$. if this number is $1$, then $n = j/i \subset m = r/i$ for some ideals $i \subset j \subset r$. thus the definition of noetherian implies the result. if the number of generators of $m$ is greater than $1$, then we can find a short exact sequence $0 \to m' \to m \to m'' \to 0$ where $m'$ and $m''$ have fewer generators. note that setting $n' = m' \cap n$ and $n'' = \im(n \to m'')$ gives a similar short exact sequence for $n$. hence the result follows from the induction hypothesis since the number of generators of $n$ is at most the number of generators of $n'$ plus the number of generators of $n''$. \medskip\noindent to show that $m$ is finitely presented just apply the previous result to the kernel of a presentation $r^n \to m$. \medskip\noindent it is well known and easy to prove that the ascending chain condition for $r$-submodules of $m$ is equivalent to the condition that every submodule of $m$ is a finite $r$-module. we omit the proof. \end{proof} \begin{lemma}[artin-rees] \label{lemma-artin-rees} suppose that $r$ is noetherian, $i \subset r$ an ideal. let $n \subset m$ be finite $r$-modules. there exists a constant $c > 0$ such that $i^n m \cap n = i^{n-c}(i^cm \cap n)$ for all $n \geq c$. \end{lemma} \begin{proof} consider the ring $s = r \oplus i \oplus i^2 \oplus \ldots = \bigoplus_{n \geq 0} i^n$. convention: $i^0 = r$. multiplication maps $i^n \times i^m$ into $i^{n + m}$ by multiplication in $r$. note that if $i = (f_1, \ldots, f_t)$ then $s$ is a quotient of the noetherian ring $r[x_1, \ldots, x_t]$. the map just sends the monomial $x_1^{e_1}\ldots x_t^{e_t}$ to $f_1^{e_1}\ldots f_t^{e_t}$. thus $s$ is noetherian. similarly, consider the module $m \oplus im \oplus i^2m \oplus \ldots = \bigoplus_{n \geq 0} i^nm$. this is a finitely generated $s$-module. namely, if $x_1, \ldots, x_r$ generate $m$ over $r$, then they also generate $\bigoplus_{n \geq 0} i^nm$ over $s$. next, consider the submodule $\bigoplus_{n \geq 0} i^nm \cap n$. this is an $s$-submodule, as is easily verified. by lemma \ref{lemma-noetherian-basic} it is finitely generated as an $s$-module, say by $\xi_j \in \bigoplus_{n \geq 0} i^nm \cap n$, $j = 1, \ldots, s$. we may assume by decomposing each $\xi_j$ into its homogeneous pieces that each $\xi_j \in i^{d_j}m \cap n$ for some $d_j$. set $c = \max\{d_j\}$. then for all $n \geq c$ every element in $i^nm \cap n$ is of the form $\sum h_j \xi_j$ with $h_j \in i^{n - d_j}$. the lemma now follows from this and the trivial observation that $i^{n-d_j}(i^{d_j}m \cap n) \subset i^{n-c}(i^cm \cap n)$. \end{proof} \begin{lemma} \label{lemma-map-ar} suppose that $0 \to k \to m \xrightarrow{f} n$ is an exact sequence of finitely generated modules over a noetherian ring $r$. let $i \subset r$ be an ideal. then there exists a $c$ such that $$ f^{-1}(i^nn) = k + i^{n-c}f^{-1}(i^cn) \quad\text{and}\quad f(m) \cap i^nn \subset f(i^{n - c}m) $$ for all $n \geq c$. \end{lemma} \begin{proof} apply lemma \ref{lemma-artin-rees} to $\im(f) \subset n$ and note that $f : i^{n-c}m \to i^{n-c}f(m)$ is surjective. \end{proof} \begin{lemma}[krull's intersection theorem] \label{lemma-intersect-powers-ideal-module-zero} let $r$ be a noetherian local ring. let $i \subset r$ be a proper ideal. let $m$ be a finite $r$-module. then $\bigcap_{n \geq 0} i^nm = 0$. \end{lemma} \begin{proof} let $n = \bigcap_{n \geq 0} i^nm$. then $n = i^nm \cap n$ for all $n \geq 0$. by the artin-rees lemma \ref{lemma-artin-rees} we see that $n = i^nm \cap n \subset in$ for some suitably large $n$. by nakayama's lemma \ref{lemma-nak} we see that $n = 0$. \end{proof} \begin{lemma} \label{lemma-intersection-powers-ideal-module} let $r$ be a noetherian ring. let $i \subset r$ be an ideal. let $m$ be a finite $r$-module. let $n = \bigcap_n i^n m$. \begin{enumerate} \item for every prime $\mathfrak p$, $i \subset \mathfrak p$ there exists a $f \in r$, $f \not \in \mathfrak p$ such that $n_f = 0$. \item if $i$ is contained in the jacobson radical of $r$, then $n = 0$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). let $x_1, \ldots, x_n$ be generators for the module $n$, see lemma \ref{lemma-noetherian-basic}. for every prime $\mathfrak p$, $i \subset \mathfrak p$ we see that the image of $n$ in the localization $m_{\mathfrak p}$ is zero, by lemma \ref{lemma-intersect-powers-ideal-module-zero}. hence we can find $g_i \in r$, $g_i \not \in \mathfrak p$ such that $x_i$ maps to zero in $n_{g_i}$. thus $n_{g_1g_2\ldots g_n} = 0$. \medskip\noindent part (2) follows from (1) and lemma \ref{lemma-characterize-zero-local}. \end{proof} \begin{remark} \label{remark-intersection-powers-ideal} lemma \ref{lemma-intersect-powers-ideal-module-zero} in particular implies that $\bigcap_n i^n = (0)$ when $i \subset r$ is a non-unit ideal in a noetherian local ring $r$. more generally, let $r$ be a noetherian ring and $i \subset r$ an ideal. suppose that $f \in \bigcap_{n \in \mathbf{n}} i^n$. then lemma \ref{lemma-intersection-powers-ideal-module} says that for every prime ideal $i \subset \mathfrak p$ there exists a $g \in r$, $g \not \in \mathfrak p$ such that $f$ maps to zero in $r_g$. in algebraic geometry we express this by saying that ``$f$ is zero in an open neighbourhood of the closed set $v(i)$ of $\spec(r)$''. \end{remark} \begin{lemma}[artin-tate] \label{lemma-artin-tate} let $r$ be a noetherian ring. let $s$ be a finitely generated $r$-algebra. if $t \subset s$ is an $r$-subalgebra such that $s$ is finitely generated as a $t$-module, then $t$ is of finite type over $r$. \end{lemma} \begin{proof} choose elements $x_1, \ldots, x_n \in s$ which generate $s$ as an $r$-algebra. choose $y_1, \ldots, y_m$ in $s$ which generate $s$ as a $t$-module. thus there exist $a_{ij} \in t$ such that $x_i = \sum a_{ij} y_j$. there also exist $b_{ijk} \in t$ such that $y_i y_j = \sum b_{ijk} y_k$. let $t' \subset t$ be the sub $r$-algebra generated by $a_{ij}$ and $b_{ijk}$. this is a finitely generated $r$-algebra, hence noetherian. consider the algebra $$ s' = t'[y_1, \ldots, y_m]/(y_i y_j - \sum b_{ijk} y_k). $$ note that $s'$ is finite over $t'$, namely as a $t'$-module it is generated by the classes of $1, y_1, \ldots, y_m$. consider the $t'$-algebra homomorphism $s' \to s$ which maps $y_i$ to $y_i$. because $a_{ij} \in t'$ we see that $x_j$ is in the image of this map. thus $s' \to s$ is surjective. therefore $s$ is finite over $t'$ as well. since $t'$ is noetherian we conclude that $t \subset s$ is finite over $t'$ and we win. \end{proof} \section{length} \label{section-length} \begin{definition} \label{definition-length} let $r$ be a ring. for any $r$-module $m$ we define the {\it length} of $m$ over $r$ by the formula $$ \text{length}_r(m) = \sup \{ n \mid \exists\ 0 = m_0 \subset m_1 \subset \ldots \subset m_n = m, \text{ }m_i \not = m_{i + 1} \}. $$ \end{definition} \noindent in other words it is the supremum of the lengths of chains of submodules. there is an obvious notion of when a chain of submodules is a refinement of another. this gives a partial ordering on the collection of all chains of submodules, with the smallest chain having the shape $0 = m_0 \subset m_1 = m$ if $m$ is not zero. we note the obvious fact that if the length of $m$ is finite, then every chain can be refined to a maximal chain. but it is not as obvious that all maximal chains have the same length (as we will see later). \begin{lemma} \label{lemma-finite-length-finite} \begin{slogan} modules of finite length are finite. \end{slogan} let $r$ be a ring. let $m$ be an $r$-module. if $\text{length}_r(m) < \infty$ then $m$ is a finite $r$-module. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-length-additive} \begin{slogan} length is additive in short exact sequences. \end{slogan} if $0 \to m' \to m \to m'' \to 0$ is a short exact sequence of modules over $r$ then the length of $m$ is the sum of the lengths of $m'$ and $m''$. \end{lemma} \begin{proof} given filtrations of $m'$ and $m''$ of lengths $n', n''$ it is easy to make a corresponding filtration of $m$ of length $n' + n''$. thus we see that $\text{length}_r m \geq \text{length}_r m' + \text{length}_r m''$. conversely, given a filtration $m_0 \subset m_1 \subset \ldots \subset m_n$ of $m$ consider the induced filtrations $m_i' = m_i \cap m'$ and $m_i'' = \im(m_i \to m'')$. let $n'$ (resp.\ $n''$) be the number of steps in the filtration $\{m'_i\}$ (resp.\ $\{m''_i\}$). if $m_i' = m_{i + 1}'$ and $m_i'' = m_{i + 1}''$ then $m_i = m_{i + 1}$. hence we conclude that $n' + n'' \geq n$. combined with the earlier result we win. \end{proof} \begin{lemma} \label{lemma-length-infinite} let $r$ be a local ring with maximal ideal $\mathfrak m$. if $m$ is an $r$-module and $\mathfrak m^n m \not = 0$ for all $n \geq 0$, then $\text{length}_r(m) = \infty$. in other words, if $m$ has finite length then $\mathfrak m^nm = 0$ for some $n$. \end{lemma} \begin{proof} assume $\mathfrak m^n m \not = 0$ for all $n\geq 0$. choose $x \in m$ and $f_1, \ldots, f_n \in \mathfrak m$ such that $f_1f_2 \ldots f_n x \not = 0$. the first $n$ steps in the filtration $$ 0 \subset r f_1 \ldots f_n x \subset r f_1 \ldots f_{n - 1} x \subset \ldots \subset r x \subset m $$ are distinct. for example, if $r f_1 x = r f_1 f_2 x$ , then $f_1 x = g f_1 f_2 x$ for some $g$, hence $(1 - gf_2) f_1 x = 0$ hence $f_1 x = 0$ as $1 - gf_2$ is a unit which is a contradiction with the choice of $x$ and $f_1, \ldots, f_n$. hence the length is infinite. \end{proof} \begin{lemma} \label{lemma-length-independent} let $r \to s$ be a ring map. let $m$ be an $s$-module. we always have $\text{length}_r(m) \geq \text{length}_s(m)$. if $r \to s$ is surjective then equality holds. \end{lemma} \begin{proof} a filtration of $m$ by $s$-submodules gives rise a filtration of $m$ by $r$-submodules. this proves the inequality. and if $r \to s$ is surjective, then any $r$-submodule of $m$ is automatically an $s$-submodule. hence equality in this case. \end{proof} \begin{lemma} \label{lemma-dimension-is-length} let $r$ be a ring with maximal ideal $\mathfrak m$. suppose that $m$ is an $r$-module with $\mathfrak m m = 0$. then the length of $m$ as an $r$-module agrees with the dimension of $m$ as a $r/\mathfrak m$ vector space. the length is finite if and only if $m$ is a finite $r$-module. \end{lemma} \begin{proof} the first part is a special case of lemma \ref{lemma-length-independent}. thus the length is finite if and only if $m$ has a finite basis as a $r/\mathfrak m$-vector space if and only if $m$ has a finite set of generators as an $r$-module. \end{proof} \begin{lemma} \label{lemma-length-localize} let $r$ be a ring. let $m$ be an $r$-module. let $s \subset r$ be a multiplicative subset. then $\text{length}_r(m) \geq \text{length}_{s^{-1}r}(s^{-1}m)$. \end{lemma} \begin{proof} any submodule $n' \subset s^{-1}m$ is of the form $s^{-1}n$ for some $r$-submodule $n \subset m$, by lemma \ref{lemma-submodule-localization}. the lemma follows. \end{proof} \begin{lemma} \label{lemma-length-finite} let $r$ be a ring with finitely generated maximal ideal $\mathfrak m$. (for example $r$ noetherian.) suppose that $m$ is a finite $r$-module with $\mathfrak m^n m = 0$ for some $n$. then $\text{length}_r(m) < \infty$. \end{lemma} \begin{proof} consider the filtration $0 = \mathfrak m^n m \subset \mathfrak m^{n-1} m \subset \ldots \subset \mathfrak m m \subset m$. all of the subquotients are finitely generated $r$-modules to which lemma \ref{lemma-dimension-is-length} applies. we conclude by additivity, see lemma \ref{lemma-length-additive}. \end{proof} \begin{definition} \label{definition-simple-module} let $r$ be a ring. let $m$ be an $r$-module. we say $m$ is {\it simple} if $m \not = 0$ and every submodule of $m$ is either equal to $m$ or to $0$. \end{definition} \begin{lemma} \label{lemma-characterize-length-1} let $r$ be a ring. let $m$ be an $r$-module. the following are equivalent: \begin{enumerate} \item $m$ is simple, \item $\text{length}_r(m) = 1$, and \item $m \cong r/\mathfrak m$ for some maximal ideal $\mathfrak m \subset r$. \end{enumerate} \end{lemma} \begin{proof} let $\mathfrak m$ be a maximal ideal of $r$. by lemma \ref{lemma-dimension-is-length} the module $r/\mathfrak m$ has length $1$. the equivalence of the first two assertions is tautological. suppose that $m$ is simple. choose $x \in m$, $x \not = 0$. as $m$ is simple we have $m = r \cdot x$. let $i \subset r$ be the annihilator of $x$, i.e., $i = \{f \in r \mid fx = 0\}$. the map $r/i \to m$, $f \bmod i \mapsto fx$ is an isomorphism, hence $r/i$ is a simple $r$-module. since $r/i \not = 0$ we see $i \not = r$. let $i \subset \mathfrak m$ be a maximal ideal containing $i$. if $i \not = \mathfrak m$, then $\mathfrak m /i \subset r/i$ is a nontrivial submodule contradicting the simplicity of $r/i$. hence we see $i = \mathfrak m$ as desired. \end{proof} \begin{lemma} \label{lemma-simple-pieces} let $r$ be a ring. let $m$ be a finite length $r$-module. choose any maximal chain of submodules $$ 0 = m_0 \subset m_1 \subset m_2 \subset \ldots \subset m_n = m $$ with $m_i \not = m_{i-1}$, $i = 1, \ldots, n$. then \begin{enumerate} \item $n = \text{length}_r(m)$, \item each $m_i/m_{i-1}$ is simple, \item each $m_i/m_{i-1}$ is of the form $r/\mathfrak m_i$ for some maximal ideal $\mathfrak m_i$, \item given a maximal ideal $\mathfrak m \subset r$ we have $$ \# \{i \mid \mathfrak m_i = \mathfrak m\} = \text{length}_{r_{\mathfrak m}} (m_{\mathfrak m}). $$ \end{enumerate} \end{lemma} \begin{proof} if $m_i/m_{i-1}$ is not simple then we can refine the filtration and the filtration is not maximal. thus we see that $m_i/m_{i-1}$ is simple. by lemma \ref{lemma-characterize-length-1} the modules $m_i/m_{i-1}$ have length $1$ and are of the form $r/\mathfrak m_i$ for some maximal ideals $\mathfrak m_i$. by additivity of length, lemma \ref{lemma-length-additive}, we see $n = \text{length}_r(m)$. since localization is exact, we see that $$ 0 = (m_0)_{\mathfrak m} \subset (m_1)_{\mathfrak m} \subset (m_2)_{\mathfrak m} \subset \ldots \subset (m_n)_{\mathfrak m} = m_{\mathfrak m} $$ is a filtration of $m_{\mathfrak m}$ with successive quotients $(m_i/m_{i-1})_{\mathfrak m}$. thus the last statement follows directly from the fact that given maximal ideals $\mathfrak m$, $\mathfrak m'$ of $r$ we have $$ (r/\mathfrak m')_{\mathfrak m} \cong \left\{ \begin{matrix} 0 & \text{if } \mathfrak m \not = \mathfrak m', \\ r_{\mathfrak m}/\mathfrak m r_{\mathfrak m} & \text{if } \mathfrak m = \mathfrak m' \end{matrix} \right. $$ this we leave to the reader. \end{proof} \begin{lemma} \label{lemma-pushdown-module} let $a$ be a local ring with maximal ideal $\mathfrak m$. let $b$ be a semi-local ring with maximal ideals $\mathfrak m_i$, $i = 1, \ldots, n$. suppose that $a \to b$ is a homomorphism such that each $\mathfrak m_i$ lies over $\mathfrak m$ and such that $$ [\kappa(\mathfrak m_i) : \kappa(\mathfrak m)] < \infty. $$ let $m$ be a $b$-module of finite length. then $$ \text{length}_a(m) = \sum\nolimits_{i = 1, \ldots, n} [\kappa(\mathfrak m_i) : \kappa(\mathfrak m)] \text{length}_{b_{\mathfrak m_i}}(m_{\mathfrak m_i}), $$ in particular $\text{length}_a(m) < \infty$. \end{lemma} \begin{proof} choose a maximal chain $$ 0 = m_0 \subset m_1 \subset m_2 \subset \ldots \subset m_m = m $$ by $b$-submodules as in lemma \ref{lemma-simple-pieces}. then each quotient $m_j/m_{j - 1}$ is isomorphic to $\kappa(\mathfrak m_{i(j)})$ for some $i(j) \in \{1, \ldots, n\}$. moreover $\text{length}_a(\kappa(\mathfrak m_i)) = [\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]$ by lemma \ref{lemma-dimension-is-length}. the lemma follows by additivity of lengths (lemma \ref{lemma-length-additive}). \end{proof} \begin{lemma} \label{lemma-pullback-module} let $a \to b$ be a flat local homomorphism of local rings. then for any $a$-module $m$ we have $$ \text{length}_a(m) \text{length}_b(b/\mathfrak m_ab) = \text{length}_b(m \otimes_a b). $$ in particular, if $\text{length}_b(b/\mathfrak m_ab) < \infty$ then $m$ has finite length if and only if $m \otimes_a b$ has finite length. \end{lemma} \begin{proof} the ring map $a \to b$ is faithfully flat by lemma \ref{lemma-local-flat-ff}. hence if $0 = m_0 \subset m_1 \subset \ldots \subset m_n = m$ is a chain of length $n$ in $m$, then the corresponding chain $0 = m_0 \otimes_a b \subset m_1 \otimes_a b \subset \ldots \subset m_n \otimes_a b = m \otimes_a b$ has length $n$ also. this proves $\text{length}_a(m) = \infty \rightarrow \text{length}_b(m \otimes_a b) = \infty$. next, assume $\text{length}_a(m) < \infty$. in this case we see that $m$ has a filtration of length $\ell = \text{length}_a(m)$ whose quotients are $a/\mathfrak m_a$. arguing as above we see that $m \otimes_a b$ has a filtration of length $\ell$ whose quotients are isomorphic to $b \otimes_a a/\mathfrak m_a = b/\mathfrak m_ab$. thus the lemma follows. \end{proof} \begin{lemma} \label{lemma-pullback-transitive} let $a \to b \to c$ be flat local homomorphisms of local rings. then $$ \text{length}_b(b/\mathfrak m_a b) \text{length}_c(c/\mathfrak m_b c) = \text{length}_c(c/\mathfrak m_a c) $$ \end{lemma} \begin{proof} follows from lemma \ref{lemma-pullback-module} applied to the ring map $b \to c$ and the $b$-module $m = b/\mathfrak m_a b$ \end{proof} \section{artinian rings} \label{section-artinian} \noindent artinian rings, and especially local artinian rings, play an important role in algebraic geometry, for example in deformation theory. \begin{definition} \label{definition-artinian} a ring $r$ is {\it artinian} if it satisfies the descending chain condition for ideals. \end{definition} \begin{lemma} \label{lemma-finite-dimensional-algebra} suppose $r$ is a finite dimensional algebra over a field. then $r$ is artinian. \end{lemma} \begin{proof} the descending chain condition for ideals obviously holds. \end{proof} \begin{lemma} \label{lemma-artinian-finite-nr-max} if $r$ is artinian then $r$ has only finitely many maximal ideals. \end{lemma} \begin{proof} suppose that $\mathfrak m_i$, $i = 1, 2, 3, \ldots$ are pairwise distinct maximal ideals. then $\mathfrak m_1 \supset \mathfrak m_1\cap \mathfrak m_2 \supset \mathfrak m_1 \cap \mathfrak m_2 \cap \mathfrak m_3 \supset \ldots$ is an infinite descending sequence (because by the chinese remainder theorem all the maps $r \to \oplus_{i = 1}^n r/\mathfrak m_i$ are surjective). \end{proof} \begin{lemma} \label{lemma-artinian-radical-nilpotent} let $r$ be artinian. the jacobson radical of $r$ is a nilpotent ideal. \end{lemma} \begin{proof} let $i \subset r$ be the jacobson radical. note that $i \supset i^2 \supset i^3 \supset \ldots$ is a descending sequence. thus $i^n = i^{n + 1}$ for some $n$. set $j = \{ x\in r \mid xi^n = 0\}$. we have to show $j = r$. if not, choose an ideal $j' \not = j$, $j \subset j'$ minimal (possible by the artinian property). then $j' = j + rx$ for some $x \in r$. by minimality we have $j + ij' = j$ or $j + ij' = j'$. in the latter case we get $j' = j + ix$ and by lemma \ref{lemma-nak} we obtain $j = j'$ a contradiction. hence $xi^{n + 1} \subset xi \cdot i^n \subset j \cdot i^n = 0$. since $i^{n + 1} = i^n$ we conclude $x \in j$. contradiction. \end{proof} \begin{lemma} \label{lemma-product-local} any ring with finitely many maximal ideals and locally nilpotent jacobson radical is the product of its localizations at its maximal ideals. also, all primes are maximal. \end{lemma} \begin{proof} let $r$ be a ring with finitely many maximal ideals $\mathfrak m_1, \ldots, \mathfrak m_n$. let $i = \bigcap_{i = 1}^n \mathfrak m_i$ be the jacobson radical of $r$. assume $i$ is locally nilpotent. let $\mathfrak p$ be a prime ideal of $r$. since every prime contains every nilpotent element of $r$ we see $ \mathfrak p \supset \mathfrak m_1 \cap \ldots \cap \mathfrak m_n$. since $\mathfrak m_1 \cap \ldots \cap \mathfrak m_n \supset \mathfrak m_1 \ldots \mathfrak m_n$ we conclude $\mathfrak p \supset \mathfrak m_1 \ldots \mathfrak m_n$. hence $\mathfrak p \supset \mathfrak m_i$ for some $i$, and so $\mathfrak p = \mathfrak m_i$. thus the spectrum of $r$ is the discrete topological space $\{\mathfrak m_1, \ldots, \mathfrak m_n\}$. by lemma \ref{lemma-disjoint-implies-product} applied $n - 1$ times we find that $r = r_1 \times \ldots \times r_n$ where the spectrum of $r_i$ is a singleton for each $i$. thus $r_i$ is a local ring and since it is a localization of $r$ (by the lemma), it is one of the local rings of $r$ as desired. \end{proof} \begin{lemma} \label{lemma-artinian-finite-length} a ring $r$ is artinian if and only if it has finite length as a module over itself. any such ring $r$ is both artinian and noetherian, any prime ideal of $r$ is a maximal ideal, and $r$ is equal to the (finite) product of its localizations at its maximal ideals. \end{lemma} \begin{proof} if $r$ has finite length over itself then it satisfies both the ascending chain condition and the descending chain condition for ideals. hence it is both noetherian and artinian. any artinian ring is equal to product of its localizations at maximal ideals by lemmas \ref{lemma-artinian-finite-nr-max}, \ref{lemma-artinian-radical-nilpotent}, and \ref{lemma-product-local}. \medskip\noindent suppose that $r$ is artinian. we will show $r$ has finite length over itself. it suffices to exhibit a chain of submodules whose successive quotients have finite length. by what we said above we may assume that $r$ is local, with maximal ideal $\mathfrak m$. by lemma \ref{lemma-artinian-radical-nilpotent} we have $\mathfrak m^n =0$ for some $n$. consider the sequence $0 = \mathfrak m^n \subset \mathfrak m^{n-1} \subset \ldots \subset \mathfrak m \subset r$. by lemma \ref{lemma-dimension-is-length} the length of each subquotient $\mathfrak m^j/\mathfrak m^{j + 1}$ is the dimension of this as a vector space over $\kappa(\mathfrak m)$. this has to be finite since otherwise we would have an infinite descending chain of sub vector spaces which would correspond to an infinite descending chain of ideals in $r$. \end{proof} \section{homomorphisms essentially of finite type} \label{section-essentially-of-finite-type} \noindent some simple remarks on localizations of finite type ring maps. \begin{definition} \label{definition-essentially-finite-p-t} let $r \to s$ be a ring map. \begin{enumerate} \item we say that $r \to s$ is {\it essentially of finite type} if $s$ is the localization of an $r$-algebra of finite type. \item we say that $r \to s$ is {\it essentially of finite presentation} if $s$ is the localization of an $r$-algebra of finite presentation. \end{enumerate} \end{definition} \begin{lemma} \label{lemma-composition-essentially-of-finite-type} the class of ring maps which are essentially of finite type is preserved under composition. similarly for essentially of finite presentation. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-base-change-essentially-of-finite-type} the class of ring maps which are essentially of finite type is preserved by base change. similarly for essentially of finite presentation. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-essentially-of-finite-type-into-artinian-local} let $r \to s$ be a ring map. assume $s$ is an artinian local ring with maximal ideal $\mathfrak m$. then \begin{enumerate} \item $r \to s$ is finite if and only if $r \to s/\mathfrak m$ is finite, \item $r \to s$ is of finite type if and only if $r \to s/\mathfrak m$ is of finite type. \item $r \to s$ is essentially of finite type if and only if the composition $r \to s/\mathfrak m$ is essentially of finite type. \end{enumerate} \end{lemma} \begin{proof} if $r \to s$ is finite, then $r \to s/\mathfrak m$ is finite by lemma \ref{lemma-finite-transitive}. conversely, assume $r \to s/\mathfrak m$ is finite. as $s$ has finite length over itself (lemma \ref{lemma-artinian-finite-length}) we can choose a filtration $$ 0 \subset i_1 \subset \ldots \subset i_n = s $$ by ideals such that $i_i/i_{i - 1} \cong s/\mathfrak m$ as $s$-modules. thus $s$ has a filtration by $r$-submodules $i_i$ such that each successive quotient is a finite $r$-module. thus $s$ is a finite $r$-module by lemma \ref{lemma-extension}. \medskip\noindent if $r \to s$ is of finite type, then $r \to s/\mathfrak m$ is of finite type by lemma \ref{lemma-compose-finite-type}. conversely, assume that $r \to s/\mathfrak m$ is of finite type. choose $f_1, \ldots, f_n \in s$ which map to generators of $s/\mathfrak m$. then $a = r[x_1, \ldots, x_n] \to s$, $x_i \mapsto f_i$ is a ring map such that $a \to s/\mathfrak m$ is surjective (in particular finite). hence $a \to s$ is finite by part (1) and we see that $r \to s$ is of finite type by lemma \ref{lemma-compose-finite-type}. \medskip\noindent if $r \to s$ is essentially of finite type, then $r \to s/\mathfrak m$ is essentially of finite type by lemma \ref{lemma-composition-essentially-of-finite-type}. conversely, assume that $r \to s/\mathfrak m$ is essentially of finite type. suppose $s/\mathfrak m$ is the localization of $r[x_1, \ldots, x_n]/i$. choose $f_1, \ldots, f_n \in s$ whose congruence classes modulo $\mathfrak m$ correspond to the congruence classes of $x_1, \ldots, x_n$ modulo $i$. consider the map $r[x_1, \ldots, x_n] \to s$, $x_i \mapsto f_i$ with kernel $j$. set $a = r[x_1, \ldots, x_n]/j \subset s$ and $\mathfrak p = a \cap \mathfrak m$. note that $a/\mathfrak p \subset s/\mathfrak m$ is equal to the image of $r[x_1, \ldots, x_n]/i$ in $s/\mathfrak m$. hence $\kappa(\mathfrak p) = s/\mathfrak m$. thus $a_\mathfrak p \to s$ is finite by part (1). we conclude that $s$ is essentially of finite type by lemma \ref{lemma-composition-essentially-of-finite-type}. \end{proof} \noindent the following lemma can be proven using properness of projective space instead of the algebraic argument we give here. \begin{lemma} \label{lemma-localization-at-closed-point-special-fibre} let $\varphi : r \to s$ be essentially of finite type with $r$ and $s$ local (but not necessarily $\varphi$ local). then there exists an $n$ and a maximal ideal $\mathfrak m \subset r[x_1, \ldots, x_n]$ lying over $\mathfrak m_r$ such that $s$ is a localization of a quotient of $r[x_1, \ldots, x_n]_\mathfrak m$. \end{lemma} \begin{proof} we can write $s$ as a localization of a quotient of $r[x_1, \ldots, x_n]$. hence it suffices to prove the lemma in case $s = r[x_1, \ldots, x_n]_\mathfrak q$ for some prime $\mathfrak q \subset r[x_1, \ldots, x_n]$. if $\mathfrak q + \mathfrak m_r r[x_1, \ldots, x_n] \not = r[x_1, \ldots, x_n]$ then we can find a maximal ideal $\mathfrak m$ as in the statement of the lemma with $\mathfrak q \subset \mathfrak m$ and the result is clear. \medskip\noindent choose a valuation ring $a \subset \kappa(\mathfrak q)$ which dominates the image of $r \to \kappa(\mathfrak q)$ (lemma \ref{lemma-dominate}). if the image $\lambda_i \in \kappa(\mathfrak q)$ of $x_i$ is contained in $a$, then $\mathfrak q$ is contained in the inverse image of $\mathfrak m_a$ via $r[x_1, \ldots, x_n] \to a$ which means we are back in the preceding case. hence there exists an $i$ such that $\lambda_i^{-1} \in a$ and such that $\lambda_j/\lambda_i \in a$ for all $j = 1, \ldots, n$ (because the value group of $a$ is totally ordered, see lemma \ref{lemma-valuation-group}). then we consider the map $$ r[y_0, y_1, \ldots, \hat{y_i}, \ldots, y_n] \to r[x_1, \ldots, x_n]_\mathfrak q,\quad y_0 \mapsto 1/x_i,\quad y_j \mapsto x_j/x_i $$ let $\mathfrak q' \subset r[y_0, \ldots, \hat{y_i}, \ldots, y_n]$ be the inverse image of $\mathfrak q$. since $y_0 \not \in \mathfrak q'$ it is easy to see that the displayed arrow defines an isomorphism on localizations. on the other hand, the result of the first paragraph applies to $r[y_0, \ldots, \hat{y_i}, \ldots, y_n]$ because $y_j$ maps to an element of $a$. this finishes the proof. \end{proof} \section{k-groups} \label{section-k-groups} \noindent let $r$ be a ring. we will introduce two abelian groups associated to $r$. the first of the two is denoted $k'_0(r)$ and has the following properties\footnote{the definition makes sense for any ring but is rarely used unless $r$ is noetherian.}: \begin{enumerate} \item for every finite $r$-module $m$ there is given an element $[m]$ in $k'_0(r)$, \item for every short exact sequence $0 \to m' \to m \to m'' \to 0$ of finite $r$-modules we have the relation $[m] = [m'] + [m'']$, \item the group $k'_0(r)$ is generated by the elements $[m]$, and \item all relations in $k'_0(r)$ among the generators $[m]$ are $\mathbf{z}$-linear combinations of the relations coming from exact sequences as above. \end{enumerate} the actual construction is a bit more annoying since one has to take care that the collection of all finitely generated $r$-modules is a proper class. however, this problem can be overcome by taking as set of generators of the group $k'_0(r)$ the elements $[r^n/k]$ where $n$ ranges over all integers and $k$ ranges over all submodules $k \subset r^n$. the generators for the subgroup of relations imposed on these elements will be the relations coming from short exact sequences whose terms are of the form $r^n/k$. the element $[m]$ is defined by choosing $n$ and $k$ such that $m \cong r^n/k$ and putting $[m] = [r^n/k]$. details left to the reader. \begin{lemma} \label{lemma-length-k0} if $r$ is an artinian local ring then the length function defines a natural abelian group homomorphism $\text{length}_r : k'_0(r) \to \mathbf{z}$. \end{lemma} \begin{proof} the length of any finite $r$-module is finite, because it is the quotient of $r^n$ which has finite length by lemma \ref{lemma-artinian-finite-length}. and the length function is additive, see lemma \ref{lemma-length-additive}. \end{proof} \noindent the second of the two is denoted $k_0(r)$ and has the following properties: \begin{enumerate} \item for every finite projective $r$-module $m$ there is given an element $[m]$ in $k_0(r)$, \item for every short exact sequence $0 \to m' \to m \to m'' \to 0$ of finite projective $r$-modules we have the relation $[m] = [m'] + [m'']$, \item the group $k_0(r)$ is generated by the elements $[m]$, and \item all relations in $k_0(r)$ are $\mathbf{z}$-linear combinations of the relations coming from exact sequences as above. \end{enumerate} the construction of this group is done as above. \medskip\noindent we note that there is an obvious map $k_0(r) \to k'_0(r)$ which is not an isomorphism in general. \begin{example} \label{example-k0-field} note that if $r = k$ is a field then we clearly have $k_0(k) = k'_0(k) \cong \mathbf{z}$ with the isomorphism given by the dimension function (which is also the length function). \end{example} \begin{example} \label{example-k0-pid} let $r$ be a pid. we claim $k_0(r) = k'_0(r) = \mathbf{z}$. namely, any finite projective $r$-module is finite free. a finite free module has a well defined rank by lemma \ref{lemma-rank}. given a short exact sequence of finite free modules $$ 0 \to m' \to m \to m'' \to 0 $$ we have $\text{rank}(m) = \text{rank}(m') + \text{rank}(m'')$ because we have $m \cong m' \oplus m'$ in this case (for example we have a splitting by lemma \ref{lemma-lift-map}). we conclude $k_0(r) = \mathbf{z}$. \medskip\noindent the structure theorem for modules of a pid says that any finitely generated $r$-module is of the form $m = r^{\oplus r} \oplus r/(d_1) \oplus \ldots \oplus r/(d_k)$. consider the short exact sequence $$ 0 \to (d_i) \to r \to r/(d_i) \to 0 $$ since the ideal $(d_i)$ is isomorphic to $r$ as a module (it is free with generator $d_i$), in $k'_0(r)$ we have $[(d_i)] = [r]$. then $[r/(d_i)] = [(d_i)]-[r] = 0$. from this it follows that a torsion module has zero class in $k'_0(r)$. using the rank of the free part gives an identification $k'_0(r) = \mathbf{z}$ and the canonical homomorphism from $k_0(r) \to k'_0(r)$ is an isomorphism. \end{example} \begin{example} \label{example-k0-polynomial-ring} let $k$ be a field. then $k_0(k[x]) = k'_0(k[x]) = \mathbf{z}$. this follows from example \ref{example-k0-pid} as $r = k[x]$ is a pid. \end{example} \begin{example} \label{example-k0-node} let $k$ be a field. let $r = \{f \in k[x] \mid f(0) = f(1)\}$, compare example \ref{example-affine-open-not-standard}. in this case $k_0(r) \cong k^* \oplus \mathbf{z}$, but $k'_0(r) = \mathbf{z}$. \end{example} \begin{lemma} \label{lemma-k0-product} let $r = r_1 \times r_2$. then $k_0(r) = k_0(r_1) \times k_0(r_2)$ and $k'_0(r) = k'_0(r_1) \times k'_0(r_2)$ \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-k0prime-artinian} let $r$ be an artinian local ring. the map $\text{length}_r : k'_0(r) \to \mathbf{z}$ of lemma \ref{lemma-length-k0} is an isomorphism. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-k0-local} let $(r, \mathfrak m)$ be a local ring. every finite projective $r$-module is finite free. the map $\text{rank}_r : k_0(r) \to \mathbf{z}$ defined by $[m] \to \text{rank}_r(m)$ is well defined and an isomorphism. \end{lemma} \begin{proof} let $p$ be a finite projective $r$-module. choose elements $x_1, \ldots, x_n \in p$ which map to a basis of $p/\mathfrak m p$. by nakayama's lemma \ref{lemma-nak} these elements generate $p$. the corresponding surjection $u : r^{\oplus n} \to p$ has a splitting as $p$ is projective. hence $r^{\oplus n} = p \oplus q$ with $q = \ker(u)$. it follows that $q/\mathfrak m q = 0$, hence $q$ is zero by nakayama's lemma. in this way we see that every finite projective $r$-module is finite free. a finite free module has a well defined rank by lemma \ref{lemma-rank}. given a short exact sequence of finite free $r$-modules $$ 0 \to m' \to m \to m'' \to 0 $$ we have $\text{rank}(m) = \text{rank}(m') + \text{rank}(m'')$ because we have $m \cong m' \oplus m'$ in this case (for example we have a splitting by lemma \ref{lemma-lift-map}). we conclude $k_0(r) = \mathbf{z}$. \end{proof} \begin{lemma} \label{lemma-k0-and-k0prime-artinian-local} let $r$ be a local artinian ring. there is a commutative diagram $$ \xymatrix{ k_0(r) \ar[rr] \ar[d]_{\text{rank}_r} & & k'_0(r) \ar[d]^{\text{length}_r} \\ \mathbf{z} \ar[rr]^{\text{length}_r(r)} & & \mathbf{z} } $$ where the vertical maps are isomorphisms by lemmas \ref{lemma-k0prime-artinian} and \ref{lemma-k0-local}. \end{lemma} \begin{proof} let $p$ be a finite projective $r$-module. we have to show that $\text{length}_r(p) = \text{rank}_r(p) \text{length}_r(r)$. by lemma \ref{lemma-k0-local} the module $p$ is finite free. so $p \cong r^{\oplus n}$ for some $n \geq 0$. then $\text{rank}_r(p) = n$ and $\text{length}_r(r^{\oplus n}) = n \text{length}_r(r)$ by additivity of lengths (lemma \ref{lemma-length-additive}). thus the result holds. \end{proof} \section{graded rings} \label{section-graded} \noindent a {\it graded ring} will be for us a ring $s$ endowed with a direct sum decomposition $s = \bigoplus_{d \geq 0} s_d$ of the underlying abelian group such that $s_d \cdot s_e \subset s_{d + e}$. note that we do not allow nonzero elements in negative degrees. the {\it irrelevant ideal} is the ideal $s_{+} = \bigoplus_{d > 0} s_d$. a {\it graded module} will be an $s$-module $m$ endowed with a direct sum decomposition $m = \bigoplus_{n\in \mathbf{z}} m_n$ of the underlying abelian group such that $s_d \cdot m_e \subset m_{d + e}$. note that for modules we do allow nonzero elements in negative degrees. we think of $s$ as a graded $s$-module by setting $s_{-k} = (0)$ for $k > 0$. an element $x$ (resp.\ $f$) of $m$ (resp.\ $s$) is called {\it homogeneous} if $x \in m_d$ (resp.\ $f \in s_d$) for some $d$. a {\it map of graded $s$-modules} is a map of $s$-modules $\varphi : m \to m'$ such that $\varphi(m_d) \subset m'_d$. we do not allow maps to shift degrees. let us denote $\text{grhom}_0(m, n)$ the $s_0$-module of homomorphisms of graded modules from $m$ to $n$. \medskip\noindent at this point there are the notions of graded ideal, graded quotient ring, graded submodule, graded quotient module, graded tensor product, etc. we leave it to the reader to find the relevant definitions, and lemmas. for example: a short exact sequence of graded modules is short exact in every degree. \medskip\noindent given a graded ring $s$, a graded $s$-module $m$ and $n \in \mathbf{z}$ we denote $m(n)$ the graded $s$-module with $m(n)_d = m_{n + d}$. this is called the {\it twist of $m$ by $n$}. in particular we get modules $s(n)$, $n \in \mathbf{z}$ which will play an important role in the study of projective schemes. there are some obvious functorial isomorphisms such as $(m \oplus n)(n) = m(n) \oplus n(n)$, $(m \otimes_s n)(n) = m \otimes_s n(n) = m(n) \otimes_s n$. in addition we can define a graded $s$-module structure on the $s_0$-module $$ \text{grhom}(m, n) = \bigoplus\nolimits_{n \in \mathbf{z}} \text{grhom}_n(m, n), \quad \text{grhom}_n(m, n) = \text{grhom}_0(m, n(n)). $$ we omit the definition of the multiplication. \begin{lemma} \label{lemma-graded-nak} let $s$ be a graded ring. let $m$ be a graded $s$-module. \begin{enumerate} \item if $s_+m = m$ and $m$ is finite, then $m = 0$. \item if $n, n' \subset m$ are graded submodules, $m = n + s_+n'$, and $n'$ is finite, then $m = n$. \item if $n \to m$ is a map of graded modules, $n/s_+n \to m/s_+m$ is surjective, and $m$ is finite, then $n \to m$ is surjective. \item if $x_1, \ldots, x_n \in m$ are homogeneous and generate $m/s_+m$ and $m$ is finite, then $x_1, \ldots, x_n$ generate $m$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). choose generators $y_1, \ldots, y_r$ of $m$ over $s$. we may assume that $y_i$ is homogeneous of degree $d_i$. after renumbering we may assume $d_r = \min(d_i)$. then the condition that $s_+m = m$ implies $y_r = 0$. hence $m = 0$ by induction on $r$. part (2) follows by applying (1) to $m/n$. part (3) follows by applying (2) to the submodules $\im(n \to m)$ and $m$. part (4) follows by applying (3) to the module map $\bigoplus s(-d_i) \to m$, $(s_1, \ldots, s_n) \mapsto \sum s_i x_i$. \end{proof} \noindent let $s$ be a graded ring. let $d \geq 1$ be an integer. we set $s^{(d)} = \bigoplus_{n \geq 0} s_{nd}$. we think of $s^{(d)}$ as a graded ring with degree $n$ summand $(s^{(d)})_n = s_{nd}$. given a graded $s$-module $m$ we can similarly consider $m^{(d)} = \bigoplus_{n \in \mathbf{z}} m_{nd}$ which is a graded $s^{(d)}$-module. \begin{lemma} \label{lemma-uple-generated-degree-1} let $s$ be a graded ring, which is finitely generated over $s_0$. then for all sufficiently divisible $d$ the algebra $s^{(d)}$ is generated in degree $1$ over $s_0$. \end{lemma} \begin{proof} say $s$ is generated by $f_1, \ldots, f_r \in s$ over $s_0$. after replacing $f_i$ by their homogeneous parts, we may assume $f_i$ is homogeneous of degree $d_i > 0$. then any element of $s_n$ is a linear combination with coefficients in $s_0$ of monomials $f_1^{e_1} \ldots f_r^{e_r}$ with $\sum e_i d_i = n$. let $m$ be a multiple of $\text{lcm}(d_i)$. for any $n \geq r$ if $$ \sum e_i d_i = n m $$ then for some $i$ we have $e_i \geq m/d_i$ by an elementary argument. hence every monomial of degree $n m$ is a product of a monomial of degree $m$, namely $f_i^{m/d_i}$, and a monomial of degree $(n - 1)m$. it follows that any monomial of degree $nrm$ with $n \geq 2$ is a product of monomials of degree $rm$. thus $s^{(rm)}$ is generated in degree $1$ over $s_0$. \end{proof} \begin{lemma} \label{lemma-integral-closure-graded} let $r \to s$ be a homomorphism of graded rings. let $s' \subset s$ be the integral closure of $r$ in $s$. then $$ s' = \bigoplus\nolimits_{d \geq 0} s' \cap s_d, $$ i.e., $s'$ is a graded $r$-subalgebra of $s$. \end{lemma} \begin{proof} we have to show the following: if $s = s_n + s_{n + 1} + \ldots + s_m \in s'$, then each homogeneous part $s_j \in s'$. we will prove this by induction on $m - n$ over all homomorphisms $r \to s$ of graded rings. first note that it is immediate that $s_0$ is integral over $r_0$ (hence over $r$) as there is a ring map $s \to s_0$ compatible with the ring map $r \to r_0$. thus, after replacing $s$ by $s - s_0$, we may assume $n > 0$. consider the extension of graded rings $r[t, t^{-1}] \to s[t, t^{-1}]$ where $t$ has degree $0$. there is a commutative diagram $$ \xymatrix{ s[t, t^{-1}] \ar[rr]_{s \mapsto t^{\deg(s)}s} & & s[t, t^{-1}] \\ r[t, t^{-1}] \ar[u] \ar[rr]^{r \mapsto t^{\deg(r)}r} & & r[t, t^{-1}] \ar[u] } $$ where the horizontal maps are ring automorphisms. hence the integral closure $c$ of $s[t, t^{-1}]$ over $r[t, t^{-1}]$ maps into itself. thus we see that $$ t^m(s_n + s_{n + 1} + \ldots + s_m) - (t^ns_n + t^{n + 1}s_{n + 1} + \ldots + t^ms_m) \in c $$ which implies by induction hypothesis that each $(t^m - t^i)s_i \in c$ for $i = n, \ldots, m - 1$. note that for any ring $a$ and $m > i \geq n > 0$ we have $a[t, t^{-1}]/(t^m - t^i - 1) \cong a[t]/(t^m - t^i - 1) \supset a$ because $t(t^{m - 1} - t^{i - 1}) = 1$ in $a[t]/(t^m - t^i - 1)$. since $t^m - t^i$ maps to $1$ we see the image of $s_i$ in the ring $s[t]/(t^m - t^i - 1)$ is integral over $r[t]/(t^m - t^i - 1)$ for $i = n, \ldots, m - 1$. since $r \to r[t]/(t^m - t^i - 1)$ is finite we see that $s_i$ is integral over $r$ by transitivity, see lemma \ref{lemma-integral-transitive}. finally, we also conclude that $s_m = s - \sum_{i = n, \ldots, m - 1} s_i$ is integral over $r$. \end{proof} \section{proj of a graded ring} \label{section-proj} \noindent let $s$ be a graded ring. a {\it homogeneous ideal} is simply an ideal $i \subset s$ which is also a graded submodule of $s$. equivalently, it is an ideal generated by homogeneous elements. equivalently, if $f \in i$ and $$ f = f_0 + f_1 + \ldots + f_n $$ is the decomposition of $f$ into homogeneous parts in $s$ then $f_i \in i$ for each $i$. to check that a homogeneous ideal $\mathfrak p$ is prime it suffices to check that if $ab \in \mathfrak p$ with $a, b$ homogeneous then either $a \in \mathfrak p$ or $b \in \mathfrak p$. \begin{definition} \label{definition-proj} let $s$ be a graded ring. we define $\text{proj}(s)$ to be the set of homogeneous prime ideals $\mathfrak p$ of $s$ such that $s_{+} \not \subset \mathfrak p$. the set $\text{proj}(s)$ is a subset of $\spec(s)$ and we endow it with the induced topology. the topological space $\text{proj}(s)$ is called the {\it homogeneous spectrum} of the graded ring $s$. \end{definition} \noindent note that by construction there is a continuous map $$ \text{proj}(s) \longrightarrow \spec(s_0). $$ \medskip\noindent let $s = \oplus_{d \geq 0} s_d$ be a graded ring. let $f\in s_d$ and assume that $d \geq 1$. we define $s_{(f)}$ to be the subring of $s_f$ consisting of elements of the form $r/f^n$ with $r$ homogeneous and $\deg(r) = nd$. if $m$ is a graded $s$-module, then we define the $s_{(f)}$-module $m_{(f)}$ as the sub module of $m_f$ consisting of elements of the form $x/f^n$ with $x$ homogeneous of degree $nd$. \begin{lemma} \label{lemma-z-graded} let $s$ be a $\mathbf{z}$-graded ring containing a homogeneous invertible element of positive degree. then the set $g \subset \spec(s)$ of $\mathbf{z}$-graded primes of $s$ (with induced topology) maps homeomorphically to $\spec(s_0)$. \end{lemma} \begin{proof} first we show that the map is a bijection by constructing an inverse. let $f \in s_d$, $d > 0$ be invertible in $s$. if $\mathfrak p_0$ is a prime of $s_0$, then $\mathfrak p_0s$ is a $\mathbf{z}$-graded ideal of $s$ such that $\mathfrak p_0s \cap s_0 = \mathfrak p_0$. and if $ab \in \mathfrak p_0s$ with $a$, $b$ homogeneous, then $a^db^d/f^{\deg(a) + \deg(b)} \in \mathfrak p_0$. thus either $a^d/f^{\deg(a)} \in \mathfrak p_0$ or $b^d/f^{\deg(b)} \in \mathfrak p_0$, in other words either $a^d \in \mathfrak p_0s$ or $b^d \in \mathfrak p_0s$. it follows that $\sqrt{\mathfrak p_0s}$ is a $\mathbf{z}$-graded prime ideal of $s$ whose intersection with $s_0$ is $\mathfrak p_0$. \medskip\noindent to show that the map is a homeomorphism we show that the image of $g \cap d(g)$ is open. if $g = \sum g_i$ with $g_i \in s_i$, then by the above $g \cap d(g)$ maps onto the set $\bigcup d(g_i^d/f^i)$ which is open. \end{proof} \noindent for $f \in s$ homogeneous of degree $> 0$ we define $$ d_{+}(f) = \{ \mathfrak p \in \text{proj}(s) \mid f \not\in \mathfrak p \}. $$ finally, for a homogeneous ideal $i \subset s$ we define $$ v_{+}(i) = \{ \mathfrak p \in \text{proj}(s) \mid i \subset \mathfrak p \}. $$ we will use more generally the notation $v_{+}(e)$ for any set $e$ of homogeneous elements $e \subset s$. \begin{lemma}[topology on proj] \label{lemma-topology-proj} let $s = \oplus_{d \geq 0} s_d$ be a graded ring. \begin{enumerate} \item the sets $d_{+}(f)$ are open in $\text{proj}(s)$. \item we have $d_{+}(ff') = d_{+}(f) \cap d_{+}(f')$. \item let $g = g_0 + \ldots + g_m$ be an element of $s$ with $g_i \in s_i$. then $$ d(g) \cap \text{proj}(s) = (d(g_0) \cap \text{proj}(s)) \cup \bigcup\nolimits_{i \geq 1} d_{+}(g_i). $$ \item let $g_0\in s_0$ be a homogeneous element of degree $0$. then $$ d(g_0) \cap \text{proj}(s) = \bigcup\nolimits_{f \in s_d, \ d\geq 1} d_{+}(g_0 f). $$ \item the open sets $d_{+}(f)$ form a basis for the topology of $\text{proj}(s)$. \item let $f \in s$ be homogeneous of positive degree. the ring $s_f$ has a natural $\mathbf{z}$-grading. the ring maps $s \to s_f \leftarrow s_{(f)}$ induce homeomorphisms $$ d_{+}(f) \leftarrow \{\mathbf{z}\text{-graded primes of }s_f\} \to \spec(s_{(f)}). $$ \item there exists an $s$ such that $\text{proj}(s)$ is not quasi-compact. \item the sets $v_{+}(i)$ are closed. \item any closed subset $t \subset \text{proj}(s)$ is of the form $v_{+}(i)$ for some homogeneous ideal $i \subset s$. \item for any graded ideal $i \subset s$ we have $v_{+}(i) = \emptyset$ if and only if $s_{+} \subset \sqrt{i}$. \end{enumerate} \end{lemma} \begin{proof} since $d_{+}(f) = \text{proj}(s) \cap d(f)$, these sets are open. this proves (1). also (2) follows as $d(ff') = d(f) \cap d(f')$. similarly the sets $v_{+}(i) = \text{proj}(s) \cap v(i)$ are closed. this proves (8). \medskip\noindent suppose that $t \subset \text{proj}(s)$ is closed. then we can write $t = \text{proj}(s) \cap v(j)$ for some ideal $j \subset s$. by definition of a homogeneous ideal if $g \in j$, $g = g_0 + \ldots + g_m$ with $g_d \in s_d$ then $g_d \in \mathfrak p$ for all $\mathfrak p \in t$. thus, letting $i \subset s$ be the ideal generated by the homogeneous parts of the elements of $j$ we have $t = v_{+}(i)$. this proves (9). \medskip\noindent the formula for $\text{proj}(s) \cap d(g)$, with $g \in s$ is direct from the definitions. this proves (3). consider the formula for $\text{proj}(s) \cap d(g_0)$. the inclusion of the right hand side in the left hand side is obvious. for the other inclusion, suppose $g_0 \not \in \mathfrak p$ with $\mathfrak p \in \text{proj}(s)$. if all $g_0f \in \mathfrak p$ for all homogeneous $f$ of positive degree, then we see that $s_{+} \subset \mathfrak p$ which is a contradiction. this gives the other inclusion. this proves (4). \medskip\noindent the collection of opens $d(g) \cap \text{proj}(s)$ forms a basis for the topology since the standard opens $d(g) \subset \spec(s)$ form a basis for the topology on $\spec(s)$. by the formulas above we can express $d(g) \cap \text{proj}(s)$ as a union of opens $d_{+}(f)$. hence the collection of opens $d_{+}(f)$ forms a basis for the topology also. this proves (5). \medskip\noindent proof of (6). first we note that $d_{+}(f)$ may be identified with a subset (with induced topology) of $d(f) = \spec(s_f)$ via lemma \ref{lemma-standard-open}. note that the ring $s_f$ has a $\mathbf{z}$-grading. the homogeneous elements are of the form $r/f^n$ with $r \in s$ homogeneous and have degree $\deg(r/f^n) = \deg(r) - n\deg(f)$. the subset $d_{+}(f)$ corresponds exactly to those prime ideals $\mathfrak p \subset s_f$ which are $\mathbf{z}$-graded ideals (i.e., generated by homogeneous elements). hence we have to show that the set of $\mathbf{z}$-graded prime ideals of $s_f$ maps homeomorphically to $\spec(s_{(f)})$. this follows from lemma \ref{lemma-z-graded}. \medskip\noindent let $s = \mathbf{z}[x_1, x_2, x_3, \ldots]$ with grading such that each $x_i$ has degree $1$. then it is easy to see that $$ \text{proj}(s) = \bigcup\nolimits_{i = 1}^\infty d_{+}(x_i) $$ does not have a finite refinement. this proves (7). \medskip\noindent let $i \subset s$ be a graded ideal. if $\sqrt{i} \supset s_{+}$ then $v_{+}(i) = \emptyset$ since every prime $\mathfrak p \in \text{proj}(s)$ does not contain $s_{+}$ by definition. conversely, suppose that $s_{+} \not \subset \sqrt{i}$. then we can find an element $f \in s_{+}$ such that $f$ is not nilpotent modulo $i$. clearly this means that one of the homogeneous parts of $f$ is not nilpotent modulo $i$, in other words we may (and do) assume that $f$ is homogeneous. this implies that $i s_f \not = s_f$, in other words that $(s/i)_f$ is not zero. hence $(s/i)_{(f)} \not = 0$ since it is a ring which maps into $(s/i)_f$. pick a prime $\mathfrak q \subset (s/i)_{(f)}$. this corresponds to a graded prime of $s/i$, not containing the irrelevant ideal $(s/i)_{+}$. and this in turn corresponds to a graded prime ideal $\mathfrak p$ of $s$, containing $i$ but not containing $s_{+}$ as desired. this proves (10) and finishes the proof. \end{proof} \begin{example} \label{example-proj-polynomial-ring-1-variable} let $r$ be a ring. if $s = r[x]$ with $\deg(x) = 1$, then the natural map $\text{proj}(s) \to \spec(r)$ is a bijection and in fact a homeomorphism. namely, suppose $\mathfrak p \in \text{proj}(s)$. since $s_{+} \not \subset \mathfrak p$ we see that $x \not \in \mathfrak p$. thus if $ax^n \in \mathfrak p$ with $a \in r$ and $n > 0$, then $a \in \mathfrak p$. it follows that $\mathfrak p = \mathfrak p_0s$ with $\mathfrak p_0 = \mathfrak p \cap r$. \end{example} \noindent if $\mathfrak p \in \text{proj}(s)$, then we define $s_{(\mathfrak p)}$ to be the ring whose elements are fractions $r/f$ where $r, f \in s$ are homogeneous elements of the same degree such that $f \not\in \mathfrak p$. as usual we say $r/f = r'/f'$ if and only if there exists some $f'' \in s$ homogeneous, $f'' \not \in \mathfrak p$ such that $f''(rf' - r'f) = 0$. given a graded $s$-module $m$ we let $m_{(\mathfrak p)}$ be the $s_{(\mathfrak p)}$-module whose elements are fractions $x/f$ with $x \in m$ and $f \in s$ homogeneous of the same degree such that $f \not \in \mathfrak p$. we say $x/f = x'/f'$ if and only if there exists some $f'' \in s$ homogeneous, $f'' \not \in \mathfrak p$ such that $f''(xf' - x'f) = 0$. \begin{lemma} \label{lemma-proj-prime} let $s$ be a graded ring. let $m$ be a graded $s$-module. let $\mathfrak p$ be an element of $\text{proj}(s)$. let $f \in s$ be a homogeneous element of positive degree such that $f \not \in \mathfrak p$, i.e., $\mathfrak p \in d_{+}(f)$. let $\mathfrak p' \subset s_{(f)}$ be the element of $\spec(s_{(f)})$ corresponding to $\mathfrak p$ as in lemma \ref{lemma-topology-proj}. then $s_{(\mathfrak p)} = (s_{(f)})_{\mathfrak p'}$ and compatibly $m_{(\mathfrak p)} = (m_{(f)})_{\mathfrak p'}$. \end{lemma} \begin{proof} we define a map $\psi : m_{(\mathfrak p)} \to (m_{(f)})_{\mathfrak p'}$. let $x/g \in m_{(\mathfrak p)}$. we set $$ \psi(x/g) = (x g^{\deg(f) - 1}/f^{\deg(x)})/(g^{\deg(f)}/f^{\deg(g)}). $$ this makes sense since $\deg(x) = \deg(g)$ and since $g^{\deg(f)}/f^{\deg(g)} \not \in \mathfrak p'$. we omit the verification that $\psi$ is well defined, a module map and an isomorphism. hint: the inverse sends $(x/f^n)/(g/f^m)$ to $(xf^m)/(g f^n)$. \end{proof} \noindent here is a graded variant of lemma \ref{lemma-silly}. \begin{lemma} \label{lemma-graded-silly} suppose $s$ is a graded ring, $\mathfrak p_i$, $i = 1, \ldots, r$ homogeneous prime ideals and $i \subset s_{+}$ a graded ideal. assume $i \not\subset \mathfrak p_i$ for all $i$. then there exists a homogeneous element $x\in i$ of positive degree such that $x\not\in \mathfrak p_i$ for all $i$. \end{lemma} \begin{proof} we may assume there are no inclusions among the $\mathfrak p_i$. the result is true for $r = 1$. suppose the result holds for $r - 1$. pick $x \in i$ homogeneous of positive degree such that $x \not \in \mathfrak p_i$ for all $i = 1, \ldots, r - 1$. if $x \not\in \mathfrak p_r$ we are done. so assume $x \in \mathfrak p_r$. if $i \mathfrak p_1 \ldots \mathfrak p_{r-1} \subset \mathfrak p_r$ then $i \subset \mathfrak p_r$ a contradiction. pick $y \in i\mathfrak p_1 \ldots \mathfrak p_{r-1}$ homogeneous and $y \not \in \mathfrak p_r$. then $x^{\deg(y)} + y^{\deg(x)}$ works. \end{proof} \begin{lemma} \label{lemma-smear-out} let $s$ be a graded ring. let $\mathfrak p \subset s$ be a prime. let $\mathfrak q$ be the homogeneous ideal of $s$ generated by the homogeneous elements of $\mathfrak p$. then $\mathfrak q$ is a prime ideal of $s$. \end{lemma} \begin{proof} to prove that $\mathfrak q$ is prime, it suffices to check that if $f, g \in s$ are homogeneous and $fg \in \mathfrak q$, then either $f$ or $g$ in $\mathfrak q$. then $fg \in \mathfrak p$ because $\mathfrak p \subset \mathfrak q$. since $\mathfrak p$ is prime we see that either $f \in \mathfrak p$ or $g \in \mathfrak p$. since $f$ and $g$ are homogeneous, it then is clear that either $f \in \mathfrak q$ or $g \in \mathfrak q$. \end{proof} \begin{lemma} \label{lemma-graded-ring-minimal-prime} let $s$ be a graded ring. \begin{enumerate} \item any minimal prime of $s$ is a homogeneous ideal of $s$. \item given a homogeneous ideal $i \subset s$ any minimal prime over $i$ is homogeneous. \end{enumerate} \end{lemma} \begin{proof} the first assertion holds because the prime $\mathfrak q$ constructed in lemma \ref{lemma-smear-out} satisfies $\mathfrak q \subset \mathfrak p$. the second because we may consider $s/i$ and apply the first part. \end{proof} \begin{lemma} \label{lemma-dehomogenize-finite-type} let $r$ be a ring. let $s$ be a graded $r$-algebra. let $f \in s_{+}$ be homogeneous. assume that $s$ is of finite type over $r$. then \begin{enumerate} \item the ring $s_{(f)}$ is of finite type over $r$, and \item for any finite graded $s$-module $m$ the module $m_{(f)}$ is a finite $s_{(f)}$-module. \end{enumerate} \end{lemma} \begin{proof} choose $f_1, \ldots, f_n \in s$ which generate $s$ as an $r$-algebra. we may assume that each $f_i$ is homogeneous (by decomposing each $f_i$ into its homogeneous components). an element of $s_{(f)}$ is a sum of the form $$ \sum\nolimits_{e\deg(f) = \sum e_i\deg(f_i)} \lambda_{e_1 \ldots e_n} f_1^{e_1} \ldots f_n^{e_n}/f^e $$ with $\lambda_{e_1 \ldots e_n} \in r$. thus $s_{(f)}$ is generated as an $r$-algebra by the $f_1^{e_1} \ldots f_n^{e_n} /f^e$ with the property that $e\deg(f) = \sum e_i\deg(f_i)$. if $e_i \geq \deg(f)$ then we can write this as $$ f_1^{e_1} \ldots f_n^{e_n}/f^e = f_i^{\deg(f)}/f^{\deg(f_i)} \cdot f_1^{e_1} \ldots f_i^{e_i - \deg(f)} \ldots f_n^{e_n}/f^{e - \deg(f_i)} $$ thus we only need the elements $f_i^{\deg(f)}/f^{\deg(f_i)}$ as well as the elements $f_1^{e_1} \ldots f_n^{e_n} /f^e$ with $e \deg(f) = \sum e_i \deg(f_i)$ and $e_i < \deg(f)$. this is a finite list and we see that (1) is true. \medskip\noindent to see (2) suppose that $m$ is generated by homogeneous elements $x_1, \ldots, x_m$. then arguing as above we find that $m_{(f)}$ is generated as an $s_{(f)}$-module by the finite list of elements of the form $f_1^{e_1} \ldots f_n^{e_n} x_j /f^e$ with $e \deg(f) = \sum e_i \deg(f_i) + \deg(x_j)$ and $e_i < \deg(f)$. \end{proof} \begin{lemma} \label{lemma-homogenize} let $r$ be a ring. let $r'$ be a finite type $r$-algebra, and let $m$ be a finite $r'$-module. there exists a graded $r$-algebra $s$, a graded $s$-module $n$ and an element $f \in s$ homogeneous of degree $1$ such that \begin{enumerate} \item $r' \cong s_{(f)}$ and $m \cong n_{(f)}$ (as modules), \item $s_0 = r$ and $s$ is generated by finitely many elements of degree $1$ over $r$, and \item $n$ is a finite $s$-module. \end{enumerate} \end{lemma} \begin{proof} we may write $r' = r[x_1, \ldots, x_n]/i$ for some ideal $i$. for an element $g \in r[x_1, \ldots, x_n]$ denote $\tilde g \in r[x_0, \ldots, x_n]$ the element homogeneous of minimal degree such that $g = \tilde g(1, x_1, \ldots, x_n)$. let $\tilde i \subset r[x_0, \ldots, x_n]$ generated by all elements $\tilde g$, $g \in i$. set $s = r[x_0, \ldots, x_n]/\tilde i$ and denote $f$ the image of $x_0$ in $s$. by construction we have an isomorphism $$ s_{(f)} \longrightarrow r', \quad x_i/x_0 \longmapsto x_i. $$ to do the same thing with the module $m$ we choose a presentation $$ m = (r')^{\oplus r}/\sum\nolimits_{j \in j} r'k_j $$ with $k_j = (k_{1j}, \ldots, k_{rj})$. let $d_{ij} = \deg(\tilde k_{ij})$. set $d_j = \max\{d_{ij}\}$. set $k_{ij} = x_0^{d_j - d_{ij}}\tilde k_{ij}$ which is homogeneous of degree $d_j$. with this notation we set $$ n = \coker\big( \bigoplus\nolimits_{j \in j} s(-d_j) \xrightarrow{(k_{ij})} s^{\oplus r} \big) $$ which works. some details omitted. \end{proof} \section{noetherian graded rings} \label{section-noetherian-graded} \noindent a bit of theory on noetherian graded rings including some material on hilbert polynomials. \begin{lemma} \label{lemma-s-plus-generated} let $s$ be a graded ring. a set of homogeneous elements $f_i \in s_{+}$ generates $s$ as an algebra over $s_0$ if and only if they generate $s_{+}$ as an ideal of $s$. \end{lemma} \begin{proof} if the $f_i$ generate $s$ as an algebra over $s_0$ then every element in $s_{+}$ is a polynomial without constant term in the $f_i$ and hence $s_{+}$ is generated by the $f_i$ as an ideal. conversely, suppose that $s_{+} = \sum sf_i$. we will prove that any element $f$ of $s$ can be written as a polynomial in the $f_i$ with coefficients in $s_0$. it suffices to do this for homogeneous elements. say $f$ has degree $d$. then we may perform induction on $d$. the case $d = 0$ is immediate. if $d > 0$ then $f \in s_{+}$ hence we can write $f = \sum g_i f_i$ for some $g_i \in s$. as $s$ is graded we can replace $g_i$ by its homogeneous component of degree $d - \deg(f_i)$. by induction we see that each $g_i$ is a polynomial in the $f_i$ and we win. \end{proof} \begin{lemma} \label{lemma-graded-noetherian} a graded ring $s$ is noetherian if and only if $s_0$ is noetherian and $s_{+}$ is finitely generated as an ideal of $s$. \end{lemma} \begin{proof} it is clear that if $s$ is noetherian then $s_0 = s/s_{+}$ is noetherian and $s_{+}$ is finitely generated. conversely, assume $s_0$ is noetherian and $s_{+}$ finitely generated as an ideal of $s$. pick generators $s_{+} = (f_1, \ldots, f_n)$. by decomposing the $f_i$ into homogeneous pieces we may assume each $f_i$ is homogeneous. by lemma \ref{lemma-s-plus-generated} we see that $s_0[x_1, \ldots x_n] \to s$ sending $x_i$ to $f_i$ is surjective. thus $s$ is noetherian by lemma \ref{lemma-noetherian-permanence}. \end{proof} \begin{definition} \label{definition-numerical-polynomial} let $a$ be an abelian group. we say that a function $f : n \mapsto f(n) \in a$ defined for all sufficient large integers $n$ is a {\it numerical polynomial} if there exists $r \geq 0$, elements $a_0, \ldots, a_r\in a$ such that $$ f(n) = \sum\nolimits_{i = 0}^r \binom{n}{i} a_i $$ for all $n \gg 0$. \end{definition} \noindent the reason for using the binomial coefficients is the elementary fact that any polynomial $p \in \mathbf{q}[t]$ all of whose values at integer points are integers, is equal to a sum $p(t) = \sum a_i \binom{t}{i}$ with $a_i \in \mathbf{z}$. note that in particular the expressions $\binom{t + 1}{i + 1}$ are of this form. \begin{lemma} \label{lemma-numerical-polynomial-functorial} if $a \to a'$ is a homomorphism of abelian groups and if $f : n \mapsto f(n) \in a$ is a numerical polynomial, then so is the composition. \end{lemma} \begin{proof} this is immediate from the definitions. \end{proof} \begin{lemma} \label{lemma-numerical-polynomial} suppose that $f: n \mapsto f(n) \in a$ is defined for all $n$ sufficiently large and suppose that $n \mapsto f(n) - f(n-1)$ is a numerical polynomial. then $f$ is a numerical polynomial. \end{lemma} \begin{proof} let $f(n) - f(n-1) = \sum\nolimits_{i = 0}^r \binom{n}{i} a_i$ for all $n \gg 0$. set $g(n) = f(n) - \sum\nolimits_{i = 0}^r \binom{n + 1}{i + 1} a_i$. then $g(n) - g(n-1) = 0$ for all $n \gg 0$. hence $g$ is eventually constant, say equal to $a_{-1}$. we leave it to the reader to show that $a_{-1} + \sum\nolimits_{i = 0}^r \binom{n + 1}{i + 1} a_i$ has the required shape (see remark above the lemma). \end{proof} \begin{lemma} \label{lemma-graded-module-fg} if $m$ is a finitely generated graded $s$-module, and if $s$ is finitely generated over $s_0$, then each $m_n$ is a finite $s_0$-module. \end{lemma} \begin{proof} suppose the generators of $m$ are $m_i$ and the generators of $s$ are $f_i$. by taking homogeneous components we may assume that the $m_i$ and the $f_i$ are homogeneous and we may assume $f_i \in s_{+}$. in this case it is clear that each $m_n$ is generated over $s_0$ by the ``monomials'' $\prod f_i^{e_i} m_j$ whose degree is $n$. \end{proof} \begin{proposition} \label{proposition-graded-hilbert-polynomial} suppose that $s$ is a noetherian graded ring and $m$ a finite graded $s$-module. consider the function $$ \mathbf{z} \longrightarrow k'_0(s_0), \quad n \longmapsto [m_n] $$ see lemma \ref{lemma-graded-module-fg}. if $s_{+}$ is generated by elements of degree $1$, then this function is a numerical polynomial. \end{proposition} \begin{proof} we prove this by induction on the minimal number of generators of $s_1$. if this number is $0$, then $m_n = 0$ for all $n \gg 0$ and the result holds. to prove the induction step, let $x\in s_1$ be one of a minimal set of generators, such that the induction hypothesis applies to the graded ring $s/(x)$. \medskip\noindent first we show the result holds if $x$ is nilpotent on $m$. this we do by induction on the minimal integer $r$ such that $x^r m = 0$. if $r = 1$, then $m$ is a module over $s/xs$ and the result holds (by the other induction hypothesis). if $r > 1$, then we can find a short exact sequence $0 \to m' \to m \to m'' \to 0$ such that the integers $r', r''$ are strictly smaller than $r$. thus we know the result for $m''$ and $m'$. hence we get the result for $m$ because of the relation $ [m_d] = [m'_d] + [m''_d] $ in $k'_0(s_0)$. \medskip\noindent if $x$ is not nilpotent on $m$, let $m' \subset m$ be the largest submodule on which $x$ is nilpotent. consider the exact sequence $0 \to m' \to m \to m/m' \to 0$ we see again it suffices to prove the result for $m/m'$. in other words we may assume that multiplication by $x$ is injective. \medskip\noindent let $\overline{m} = m/xm$. note that the map $x : m \to m$ is {\it not} a map of graded $s$-modules, since it does not map $m_d$ into $m_d$. namely, for each $d$ we have the following short exact sequence $$ 0 \to m_d \xrightarrow{x} m_{d + 1} \to \overline{m}_{d + 1} \to 0 $$ this proves that $[m_{d + 1}] - [m_d] = [\overline{m}_{d + 1}]$. hence we win by lemma \ref{lemma-numerical-polynomial}. \end{proof} \begin{remark} \label{remark-period-polynomial} if $s$ is still noetherian but $s$ is not generated in degree $1$, then the function associated to a graded $s$-module is a periodic polynomial (i.e., it is a numerical polynomial on the congruence classes of integers modulo $n$ for some $n$). \end{remark} \begin{example} \label{example-hilbert-function} suppose that $s = k[x_1, \ldots, x_d]$. by example \ref{example-k0-field} we may identify $k_0(k) = k'_0(k) = \mathbf{z}$. hence any finitely generated graded $k[x_1, \ldots, x_d]$-module gives rise to a numerical polynomial $n \mapsto \dim_k(m_n)$. \end{example} \begin{lemma} \label{lemma-quotient-smaller-d} let $k$ be a field. suppose that $i \subset k[x_1, \ldots, x_d]$ is a nonzero graded ideal. let $m = k[x_1, \ldots, x_d]/i$. then the numerical polynomial $n \mapsto \dim_k(m_n)$ (see example \ref{example-hilbert-function}) has degree $ < d - 1$ (or is zero if $d = 1$). \end{lemma} \begin{proof} the numerical polynomial associated to the graded module $k[x_1, \ldots, x_d]$ is $n \mapsto \binom{n - 1 + d}{d - 1}$. for any nonzero homogeneous $f \in i$ of degree $e$ and any degree $n >> e$ we have $i_n \supset f \cdot k[x_1, \ldots, x_d]_{n-e}$ and hence $\dim_k(i_n) \geq \binom{n - e - 1 + d}{d - 1}$. hence $\dim_k(m_n) \leq \binom{n - 1 + d}{d - 1} - \binom{n - e - 1 + d}{d - 1}$. we win because the last expression has degree $ < d - 1$ (or is zero if $d = 1$). \end{proof} \section{noetherian local rings} \label{section-noetherian-local} \noindent in all of this section $(r, \mathfrak m, \kappa)$ is a noetherian local ring. we develop some theory on hilbert functions of modules in this section. let $m$ be a finite $r$-module. we define the {\it hilbert function} of $m$ to be the function $$ \varphi_m : n \longmapsto \text{length}_r(\mathfrak m^nm/{\mathfrak m}^{n + 1}m) $$ defined for all integers $n \geq 0$. another important invariant is the function $$ \chi_m : n \longmapsto \text{length}_r(m/{\mathfrak m}^{n + 1}m) $$ defined for all integers $n \geq 0$. note that we have by lemma \ref{lemma-length-additive} that $$ \chi_m(n) = \sum\nolimits_{i = 0}^n \varphi_m(i). $$ there is a variant of this construction which uses an ideal of definition. \begin{definition} \label{definition-ideal-definition} let $(r, \mathfrak m)$ be a local noetherian ring. an ideal $i \subset r$ such that $\sqrt{i} = \mathfrak m$ is called {\it an ideal of definition of $r$}. \end{definition} \noindent let $i \subset r$ be an ideal of definition. because $r$ is noetherian this means that $\mathfrak m^r \subset i$ for some $r$, see lemma \ref{lemma-noetherian-power}. hence any finite $r$-module annihilated by a power of $i$ has a finite length, see lemma \ref{lemma-length-finite}. thus it makes sense to define $$ \varphi_{i, m}(n) = \text{length}_r(i^nm/i^{n + 1}m) \quad\text{and}\quad \chi_{i, m}(n) = \text{length}_r(m/i^{n + 1}m) $$ for all $n \geq 0$. again we have that $$ \chi_{i, m}(n) = \sum\nolimits_{i = 0}^n \varphi_{i, m}(i). $$ \begin{lemma} \label{lemma-differ-finite} suppose that $m' \subset m$ are finite $r$-modules with finite length quotient. then there exists a constants $c_1, c_2$ such that for all $n \geq c_2$ we have $$ c_1 + \chi_{i, m'}(n - c_2) \leq \chi_{i, m}(n) \leq c_1 + \chi_{i, m'}(n) $$ \end{lemma} \begin{proof} since $m/m'$ has finite length there is a $c_2 \geq 0$ such that $i^{c_2}m \subset m'$. let $c_1 = \text{length}_r(m/m')$. for $n \geq c_2$ we have \begin{eqnarray*} \chi_{i, m}(n) & = & \text{length}_r(m/i^{n + 1}m) \\ & = & c_1 + \text{length}_r(m'/i^{n + 1}m) \\ & \leq & c_1 + \text{length}_r(m'/i^{n + 1}m') \\ & = & c_1 + \chi_{i, m'}(n) \end{eqnarray*} on the other hand, since $i^{c_2}m \subset m'$, we have $i^nm \subset i^{n - c_2}m'$ for $n \geq c_2$. thus for $n \geq c_2$ we get \begin{eqnarray*} \chi_{i, m}(n) & = & \text{length}_r(m/i^{n + 1}m) \\ & = & c_1 + \text{length}_r(m'/i^{n + 1}m) \\ & \geq & c_1 + \text{length}_r(m'/i^{n + 1 - c_2}m') \\ & = & c_1 + \chi_{i, m'}(n - c_2) \end{eqnarray*} which finishes the proof. \end{proof} \begin{lemma} \label{lemma-hilbert-ses} suppose that $0 \to m' \to m \to m'' \to 0$ is a short exact sequence of finite $r$-modules. then there exists a submodule $n \subset m'$ with finite colength $l$ and $c \geq 0$ such that $$ \chi_{i, m}(n) = \chi_{i, m''}(n) + \chi_{i, n}(n - c) + l $$ and $$ \varphi_{i, m}(n) = \varphi_{i, m''}(n) + \varphi_{i, n}(n - c) $$ for all $n \geq c$. \end{lemma} \begin{proof} note that $m/i^nm \to m''/i^nm''$ is surjective with kernel $m' / m' \cap i^nm$. by the artin-rees lemma \ref{lemma-artin-rees} there exists a constant $c$ such that $m' \cap i^nm = i^{n - c}(m' \cap i^cm)$. denote $n = m' \cap i^cm$. note that $i^c m' \subset n \subset m'$. hence $\text{length}_r(m' / m' \cap i^nm) = \text{length}_r(m'/n) + \text{length}_r(n/i^{n - c}n)$ for $n \geq c$. from the short exact sequence $$ 0 \to m' / m' \cap i^nm \to m/i^nm \to m''/i^nm'' \to 0 $$ and additivity of lengths (lemma \ref{lemma-length-additive}) we obtain the equality $$ \chi_{i, m}(n - 1) = \chi_{i, m''}(n - 1) + \chi_{i, n}(n - c - 1) + \text{length}_r(m'/n) $$ for $n \geq c$. we have $\varphi_{i, m}(n) = \chi_{i, m}(n) - \chi_{i, m}(n - 1)$ and similarly for the modules $m''$ and $n$. hence we get $\varphi_{i, m}(n) = \varphi_{i, m''}(n) + \varphi_{i, n}(n-c)$ for $n \geq c$. \end{proof} \begin{lemma} \label{lemma-hilbert-change-i} suppose that $i$, $i'$ are two ideals of definition for the noetherian local ring $r$. let $m$ be a finite $r$-module. there exists a constant $a$ such that $\chi_{i, m}(n) \leq \chi_{i', m}(an)$ for $n \geq 1$. \end{lemma} \begin{proof} there exists an integer $c \geq 1$ such that $(i')^c \subset i$. hence we get a surjection $m/(i')^{c(n + 1)}m \to m/i^{n + 1}m$. whence the result with $a = 2c - 1$. \end{proof} \begin{proposition} \label{proposition-hilbert-function-polynomial} let $r$ be a noetherian local ring. let $m$ be a finite $r$-module. let $i \subset r$ be an ideal of definition. the hilbert function $\varphi_{i, m}$ and the function $\chi_{i, m}$ are numerical polynomials. \end{proposition} \begin{proof} consider the graded ring $s = r/i \oplus i/i^2 \oplus i^2/i^3 \oplus \ldots = \bigoplus_{d \geq 0} i^d/i^{d + 1}$. consider the graded $s$-module $n = m/im \oplus im/i^2m \oplus \ldots = \bigoplus_{d \geq 0} i^dm/i^{d + 1}m$. this pair $(s, n)$ satisfies the hypotheses of proposition \ref{proposition-graded-hilbert-polynomial}. hence the result for $\varphi_{i, m}$ follows from that proposition and lemma \ref{lemma-length-k0}. the result for $\chi_{i, m}$ follows from this and lemma \ref{lemma-numerical-polynomial}. \end{proof} \begin{definition} \label{definition-hilbert-polynomial} let $r$ be a noetherian local ring. let $m$ be a finite $r$-module. the {\it hilbert polynomial} of $m$ over $r$ is the element $p(t) \in \mathbf{q}[t]$ such that $p(n) = \varphi_m(n)$ for $n \gg 0$. \end{definition} \noindent by proposition \ref{proposition-hilbert-function-polynomial} we see that the hilbert polynomial exists. \begin{lemma} \label{lemma-d-independent} let $r$ be a noetherian local ring. let $m$ be a finite $r$-module. \begin{enumerate} \item the degree of the numerical polynomial $\varphi_{i, m}$ is independent of the ideal of definition $i$. \item the degree of the numerical polynomial $\chi_{i, m}$ is independent of the ideal of definition $i$. \end{enumerate} \end{lemma} \begin{proof} part (2) follows immediately from lemma \ref{lemma-hilbert-change-i}. part (1) follows from (2) because $\varphi_{i, m}(n) = \chi_{i, m}(n) - \chi_{i, m}(n - 1)$ for $n \geq 1$. \end{proof} \begin{definition} \label{definition-d} let $r$ be a local noetherian ring and $m$ a finite $r$-module. we denote {\it $d(m)$} the element of $\{-\infty, 0, 1, 2, \ldots \}$ defined as follows: \begin{enumerate} \item if $m = 0$ we set $d(m) = -\infty$, \item if $m \not = 0$ then $d(m)$ is the degree of the numerical polynomial $\chi_m$. \end{enumerate} \end{definition} \noindent if $\mathfrak m^nm \not = 0$ for all $n$, then we see that $d(m)$ is the degree $+1$ of the hilbert polynomial of $m$. \begin{lemma} \label{lemma-differ-finite-chi} let $r$ be a noetherian local ring. let $i \subset r$ be an ideal of definition. let $m$ be a finite $r$-module which does not have finite length. if $m' \subset m$ is a submodule with finite colength, then $\chi_{i, m} - \chi_{i, m'}$ is a polynomial of degree $<$ degree of either polynomial. \end{lemma} \begin{proof} follows from lemma \ref{lemma-differ-finite} by elementary calculus. \end{proof} \begin{lemma} \label{lemma-hilbert-ses-chi} let $r$ be a noetherian local ring. let $i \subset r$ be an ideal of definition. let $0 \to m' \to m \to m'' \to 0$ be a short exact sequence of finite $r$-modules. then \begin{enumerate} \item if $m'$ does not have finite length, then $\chi_{i, m} - \chi_{i, m''} - \chi_{i, m'}$ is a numerical polynomial of degree $<$ the degree of $\chi_{i, m'}$, \item $\max\{ \deg(\chi_{i, m'}), \deg(\chi_{i, m''}) \} = \deg(\chi_{i, m})$, and \item $\max\{d(m'), d(m'')\} = d(m)$, \end{enumerate} \end{lemma} \begin{proof} we first prove (1). let $n \subset m'$ be as in lemma \ref{lemma-hilbert-ses}. by lemma \ref{lemma-differ-finite-chi} the numerical polynomial $\chi_{i, m'} - \chi_{i, n}$ has degree $<$ the common degree of $\chi_{i, m'}$ and $\chi_{i, n}$. by lemma \ref{lemma-hilbert-ses} the difference $$ \chi_{i, m}(n) - \chi_{i, m''}(n) - \chi_{i, n}(n - c) $$ is constant for $n \gg 0$. by elementary calculus the difference $\chi_{i, n}(n) - \chi_{i, n}(n - c)$ has degree $<$ the degree of $\chi_{i, n}$ which is bigger than zero (see above). putting everything together we obtain (1). \medskip\noindent note that the leading coefficients of $\chi_{i, m'}$ and $\chi_{i, m''}$ are nonnegative. thus the degree of $\chi_{i, m'} + \chi_{i, m''}$ is equal to the maximum of the degrees. thus if $m'$ does not have finite length, then (2) follows from (1). if $m'$ does have finite length, then $i^nm \to i^nm''$ is an isomorphism for all $n \gg 0$ by artin-rees (lemma \ref{lemma-artin-rees}). thus $m/i^nm \to m''/i^nm''$ is a surjection with kernel $m'$ for $n \gg 0$ and we see that $\chi_{i, m}(n) - \chi_{i, m''}(n) = \text{length}(m')$ for all $n \gg 0$. thus (2) holds in this case also. \medskip\noindent proof of (3). this follows from (2) except if one of $m$, $m'$, or $m''$ is zero. we omit the proof in these special cases. \end{proof} \section{dimension} \label{section-dimension} \noindent please compare with topology, section \ref{topology-section-krull-dimension}. \begin{definition} \label{definition-chain-primes} let $r$ be a ring. a {\it chain of prime ideals} is a sequence $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n$ of prime ideals of $r$ such that $\mathfrak p_i \not = \mathfrak p_{i + 1}$ for $i = 0, \ldots, n - 1$. the {\it length} of this chain of prime ideals is $n$. \end{definition} \noindent recall that we have an inclusion reversing bijection between prime ideals of a ring $r$ and irreducible closed subsets of $\spec(r)$, see lemma \ref{lemma-irreducible}. \begin{definition} \label{definition-krull} the {\it krull dimension} of the ring $r$ is the krull dimension of the topological space $\spec(r)$, see topology, definition \ref{topology-definition-krull}. in other words it is the supremum of the integers $n\geq 0$ such that $r$ has a chain of prime ideals $$ \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n, \quad \mathfrak p_i \not = \mathfrak p_{i + 1}. $$ of length $n$. \end{definition} \begin{definition} \label{definition-height} the {\it height} of a prime ideal $\mathfrak p$ of a ring $r$ is the dimension of the local ring $r_{\mathfrak p}$. \end{definition} \begin{lemma} \label{lemma-dimension-height} the krull dimension of $r$ is the supremum of the heights of its (maximal) primes. \end{lemma} \begin{proof} this is so because we can always add a maximal ideal at the end of a chain of prime ideals. \end{proof} \begin{lemma} \label{lemma-noetherian-dimension-0} a noetherian ring of dimension $0$ is artinian. conversely, any artinian ring is noetherian of dimension zero. \end{lemma} \begin{proof} assume $r$ is a noetherian ring of dimension $0$. by lemma \ref{lemma-noetherian-topology} the space $\spec(r)$ is noetherian. by topology, lemma \ref{topology-lemma-noetherian} we see that $\spec(r)$ has finitely many irreducible components, say $\spec(r) = z_1 \cup \ldots \cup z_r$. according to lemma \ref{lemma-irreducible} each $z_i = v(\mathfrak p_i)$ with $\mathfrak p_i$ a minimal ideal. since the dimension is $0$ these $\mathfrak p_i$ are also maximal. thus $\spec(r)$ is the discrete topological space with elements $\mathfrak p_i$. all elements $f$ of the jacobson radical $\bigcap \mathfrak p_i$ are nilpotent since otherwise $r_f$ would not be the zero ring and we would have another prime. by lemma \ref{lemma-product-local} $r$ is equal to $\prod r_{\mathfrak p_i}$. since $r_{\mathfrak p_i}$ is also noetherian and dimension $0$, the previous arguments show that its radical $\mathfrak p_ir_{\mathfrak p_i}$ is locally nilpotent. lemma \ref{lemma-noetherian-power} gives $\mathfrak p_i^nr_{\mathfrak p_i} = 0$ for some $n \geq 1$. by lemma \ref{lemma-length-finite} we conclude that $r_{\mathfrak p_i}$ has finite length over $r$. hence we conclude that $r$ is artinian by lemma \ref{lemma-artinian-finite-length}. \medskip\noindent if $r$ is an artinian ring then by lemma \ref{lemma-artinian-finite-length} it is noetherian. all of its primes are maximal by a combination of lemmas \ref{lemma-artinian-finite-nr-max}, \ref{lemma-artinian-radical-nilpotent} and \ref{lemma-product-local}. \end{proof} \noindent in the following we will use the invariant $d(-)$ defined in definition \ref{definition-d}. here is a warm up lemma. \begin{lemma} \label{lemma-dimension-0-d-0} let $r$ be a noetherian local ring. then $\dim(r) = 0 \leftrightarrow d(r) = 0$. \end{lemma} \begin{proof} this is because $d(r) = 0$ if and only if $r$ has finite length as an $r$-module. see lemma \ref{lemma-artinian-finite-length}. \end{proof} \begin{proposition} \label{proposition-dimension-zero-ring} let $r$ be a ring. the following are equivalent: \begin{enumerate} \item $r$ is artinian, \item $r$ is noetherian and $\dim(r) = 0$, \item $r$ has finite length as a module over itself, \item $r$ is a finite product of artinian local rings, \item $r$ is noetherian and $\spec(r)$ is a finite discrete topological space, \item $r$ is a finite product of noetherian local rings of dimension $0$, \item $r$ is a finite product of noetherian local rings $r_i$ with $d(r_i) = 0$, \item $r$ is a finite product of noetherian local rings $r_i$ whose maximal ideals are nilpotent, \item $r$ is noetherian, has finitely many maximal ideals and its jacobson radical ideal is nilpotent, and \item $r$ is noetherian and there are no strict inclusions among its primes. \end{enumerate} \end{proposition} \begin{proof} this is a combination of lemmas \ref{lemma-product-local}, \ref{lemma-artinian-finite-length}, \ref{lemma-noetherian-dimension-0}, and \ref{lemma-dimension-0-d-0}. \end{proof} \begin{lemma} \label{lemma-height-1} let $r$ be a local noetherian ring. the following are equivalent: \begin{enumerate} \item \label{item-dim-1} $\dim(r) = 1$, \item \label{item-d-1} $d(r) = 1$, \item \label{item-vx} there exists an $x \in \mathfrak m$, $x$ not nilpotent such that $v(x) = \{\mathfrak m\}$, \item \label{item-x} there exists an $x \in \mathfrak m$, $x$ not nilpotent such that $\mathfrak m = \sqrt{(x)}$, and \item \label{item-ideal-1} there exists an ideal of definition generated by $1$ element, and no ideal of definition is generated by $0$ elements. \end{enumerate} \end{lemma} \begin{proof} first, assume that $\dim(r) = 1$. let $\mathfrak p_i$ be the minimal primes of $r$. because the dimension is $1$ the only other prime of $r$ is $\mathfrak m$. according to lemma \ref{lemma-noetherian-irreducible-components} there are finitely many. hence we can find $x \in \mathfrak m$, $x \not \in \mathfrak p_i$, see lemma \ref{lemma-silly}. thus the only prime containing $x$ is $\mathfrak m$ and hence (\ref{item-vx}). \medskip\noindent if (\ref{item-vx}) then $\mathfrak m = \sqrt{(x)}$ by lemma \ref{lemma-zariski-topology}, and hence (\ref{item-x}). the converse is clear as well. the equivalence of (\ref{item-x}) and (\ref{item-ideal-1}) follows from directly the definitions. \medskip\noindent assume (\ref{item-ideal-1}). let $i = (x)$ be an ideal of definition. note that $i^n/i^{n + 1}$ is a quotient of $r/i$ via multiplication by $x^n$ and hence $\text{length}_r(i^n/i^{n + 1})$ is bounded. thus $d(r) = 0$ or $d(r) = 1$, but $d(r) = 0$ is excluded by the assumption that $0$ is not an ideal of definition. \medskip\noindent assume (\ref{item-d-1}). to get a contradiction, assume there exist primes $\mathfrak p \subset \mathfrak q \subset \mathfrak m$, with both inclusions strict. pick some ideal of definition $i \subset r$. we will repeatedly use lemma \ref{lemma-hilbert-ses-chi}. first of all it implies, via the exact sequence $0 \to \mathfrak p \to r \to r/\mathfrak p \to 0$, that $d(r/\mathfrak p) \leq 1$. but it clearly cannot be zero. pick $x\in \mathfrak q$, $x\not \in \mathfrak p$. consider the short exact sequence $$ 0 \to r/\mathfrak p \to r/\mathfrak p \to r/(xr + \mathfrak p) \to 0. $$ this implies that $\chi_{i, r/\mathfrak p} - \chi_{i, r/\mathfrak p} - \chi_{i, r/(xr + \mathfrak p)} = - \chi_{i, r/(xr + \mathfrak p)}$ has degree $ < 1$. in other words, $d(r/(xr + \mathfrak p)) = 0$, and hence $\dim(r/(xr + \mathfrak p)) = 0$, by lemma \ref{lemma-dimension-0-d-0}. but $r/(xr + \mathfrak p)$ has the distinct primes $\mathfrak q/(xr + \mathfrak p)$ and $\mathfrak m/(xr + \mathfrak p)$ which gives the desired contradiction. \end{proof} \begin{proposition} \label{proposition-dimension} let $r$ be a local noetherian ring. let $d \geq 0$ be an integer. the following are equivalent: \begin{enumerate} \item \label{item-dim-d} $\dim(r) = d$, \item \label{item-d-d} $d(r) = d$, \item \label{item-ideal-d} there exists an ideal of definition generated by $d$ elements, and no ideal of definition is generated by fewer than $d$ elements. \end{enumerate} \end{proposition} \begin{proof} this proof is really just the same as the proof of lemma \ref{lemma-height-1}. we will prove the proposition by induction on $d$. by lemmas \ref{lemma-dimension-0-d-0} and \ref{lemma-height-1} we may assume that $d > 1$. denote the minimal number of generators for an ideal of definition of $r$ by $d'(r)$. we will prove the inequalities $\dim(r) \geq d'(r) \geq d(r) \geq \dim(r)$, and hence they are all equal. \medskip\noindent first, assume that $\dim(r) = d$. let $\mathfrak p_i$ be the minimal primes of $r$. according to lemma \ref{lemma-noetherian-irreducible-components} there are finitely many. hence we can find $x \in \mathfrak m$, $x \not \in \mathfrak p_i$, see lemma \ref{lemma-silly}. note that every maximal chain of primes starts with some $\mathfrak p_i$, hence the dimension of $r/xr$ is at most $d-1$. by induction there are $x_2, \ldots, x_d$ which generate an ideal of definition in $r/xr$. hence $r$ has an ideal of definition generated by (at most) $d$ elements. \medskip\noindent assume $d'(r) = d$. let $i = (x_1, \ldots, x_d)$ be an ideal of definition. note that $i^n/i^{n + 1}$ is a quotient of a direct sum of $\binom{d + n - 1}{d - 1}$ copies $r/i$ via multiplication by all degree $n$ monomials in $x_1, \ldots, x_d$. hence $\text{length}_r(i^n/i^{n + 1})$ is bounded by a polynomial of degree $d-1$. thus $d(r) \leq d$. \medskip\noindent assume $d(r) = d$. consider a chain of primes $\mathfrak p \subset \mathfrak q \subset \mathfrak q_2 \subset \ldots \subset \mathfrak q_e = \mathfrak m$, with all inclusions strict, and $e \geq 2$. pick some ideal of definition $i \subset r$. we will repeatedly use lemma \ref{lemma-hilbert-ses-chi}. first of all it implies, via the exact sequence $0 \to \mathfrak p \to r \to r/\mathfrak p \to 0$, that $d(r/\mathfrak p) \leq d$. but it clearly cannot be zero. pick $x\in \mathfrak q$, $x\not \in \mathfrak p$. consider the short exact sequence $$ 0 \to r/\mathfrak p \to r/\mathfrak p \to r/(xr + \mathfrak p) \to 0. $$ this implies that $\chi_{i, r/\mathfrak p} - \chi_{i, r/\mathfrak p} - \chi_{i, r/(xr + \mathfrak p)} = - \chi_{i, r/(xr + \mathfrak p)}$ has degree $ < d$. in other words, $d(r/(xr + \mathfrak p)) \leq d - 1$, and hence $\dim(r/(xr + \mathfrak p)) \leq d - 1$, by induction. now $r/(xr + \mathfrak p)$ has the chain of prime ideals $\mathfrak q/(xr + \mathfrak p) \subset \mathfrak q_2/(xr + \mathfrak p) \subset \ldots \subset \mathfrak q_e/(xr + \mathfrak p)$ which gives $e - 1 \leq d - 1$. since we started with an arbitrary chain of primes this proves that $\dim(r) \leq d(r)$. \medskip\noindent reading back the reader will see we proved the circular inequalities as desired. \end{proof} \noindent let $(r, \mathfrak m)$ be a noetherian local ring. from the above it is clear that $\mathfrak m$ cannot be generated by fewer than $\dim(r)$ variables. by nakayama's lemma \ref{lemma-nak} the minimal number of generators of $\mathfrak m$ equals $\dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2$. hence we have the following fundamental inequality $$ \dim(r) \leq \dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2. $$ it turns out that the rings where equality holds have a lot of good properties. they are called regular local rings. \begin{definition} \label{definition-regular-local} let $(r, \mathfrak m)$ be a noetherian local ring of dimension $d$. \begin{enumerate} \item a {\it system of parameters of $r$} is a sequence of elements $x_1, \ldots, x_d \in \mathfrak m$ which generates an ideal of definition of $r$, \item if there exist $x_1, \ldots, x_d \in \mathfrak m$ such that $\mathfrak m = (x_1, \ldots, x_d)$ then we call $r$ a {\it regular local ring} and $x_1, \ldots, x_d$ a {\it regular system of parameters}. \end{enumerate} \end{definition} \noindent the following lemmas are clear from the proofs of the lemmas and proposition above, but we spell them out so we have convenient references. \begin{lemma} \label{lemma-minimal-over-1} let $r$ be a noetherian ring. let $x \in r$. \begin{enumerate} \item if $\mathfrak p$ is minimal over $(x)$ then the height of $\mathfrak p$ is $0$ or $1$. \item if $\mathfrak p, \mathfrak q \in \spec(r)$ and $\mathfrak q$ is minimal over $(\mathfrak p, x)$, then there is no prime strictly between $\mathfrak p$ and $\mathfrak q$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). if $\mathfrak p$ is minimal over $x$, then the only prime ideal of $r_\mathfrak p$ containing $x$ is the maximal ideal $\mathfrak p r_\mathfrak p$. this is true because the primes of $r_\mathfrak p$ correspond $1$-to-$1$ with the primes of $r$ contained in $\mathfrak p$, see lemma \ref{lemma-spec-localization}. hence lemma \ref{lemma-height-1} shows $\dim(r_\mathfrak p) = 1$ if $x$ is not nilpotent in $r_\mathfrak p$. of course, if $x$ is nilpotent in $r_\mathfrak p$ the argument gives that $\mathfrak pr_\mathfrak p$ is the only prime ideal and we see that the height is $0$. \medskip\noindent proof of (2). by part (1) we see that $\mathfrak q/\mathfrak p$ is a prime of height $1$ or $0$ in $r/\mathfrak p$. this immediately implies there cannot be a prime strictly between $\mathfrak p$ and $\mathfrak q$. \end{proof} \begin{lemma} \label{lemma-minimal-over-r} let $r$ be a noetherian ring. let $f_1, \ldots, f_r \in r$. \begin{enumerate} \item if $\mathfrak p$ is minimal over $(f_1, \ldots, f_r)$ then the height of $\mathfrak p$ is $\leq r$. \item if $\mathfrak p, \mathfrak q \in \spec(r)$ and $\mathfrak q$ is minimal over $(\mathfrak p, f_1, \ldots, f_r)$, then every chain of primes between $\mathfrak p$ and $\mathfrak q$ has length at most $r$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). if $\mathfrak p$ is minimal over $f_1, \ldots, f_r$, then the only prime ideal of $r_\mathfrak p$ containing $f_1, \ldots, f_r$ is the maximal ideal $\mathfrak p r_\mathfrak p$. this is true because the primes of $r_\mathfrak p$ correspond $1$-to-$1$ with the primes of $r$ contained in $\mathfrak p$, see lemma \ref{lemma-spec-localization}. hence proposition \ref{proposition-dimension} shows $\dim(r_\mathfrak p) \leq r$. \medskip\noindent proof of (2). by part (1) we see that $\mathfrak q/\mathfrak p$ is a prime of height $\leq r$. this immediately implies the statement about chains of primes between $\mathfrak p$ and $\mathfrak q$. \end{proof} \begin{lemma} \label{lemma-one-equation} suppose that $r$ is a noetherian local ring and $x\in \mathfrak m$ an element of its maximal ideal. then $\dim r \leq \dim r/xr + 1$. if $x$ is not contained in any of the minimal primes of $r$ then equality holds. (for example if $x$ is a nonzerodivisor.) \end{lemma} \begin{proof} if $x_1, \ldots, x_{\dim r/xr} \in r$ map to elements of $r/xr$ which generate an ideal of definition for $r/xr$, then $x, x_1, \ldots, x_{\dim r/xr}$ generate an ideal of definition for $r$. hence the inequality by proposition \ref{proposition-dimension}. on the other hand, if $x$ is not contained in any minimal prime of $r$, then the chains of primes in $r/xr$ all give rise to chains in $r$ which are at least one step away from being maximal. \end{proof} \begin{lemma} \label{lemma-elements-generate-ideal-definition} let $(r, \mathfrak m)$ be a noetherian local ring. suppose $x_1, \ldots, x_d \in \mathfrak m$ generate an ideal of definition and $d = \dim(r)$. then $\dim(r/(x_1, \ldots, x_i)) = d - i$ for all $i = 1, \ldots, d$. \end{lemma} \begin{proof} follows either from the proof of proposition \ref{proposition-dimension}, or by using induction on $d$ and lemma \ref{lemma-one-equation}. \end{proof} \section{applications of dimension theory} \label{section-applications-dimension-theory} \noindent we can use the results on dimension to prove certain rings have infinite spectra and to produce more jacobson rings. \begin{lemma} \label{lemma-noetherian-local-domain-dim-2-infinite-opens} let $r$ be a noetherian local domain of dimension $\geq 2$. a nonempty open subset $u \subset \spec(r)$ is infinite. \end{lemma} \begin{proof} to get a contradiction, assume that $u \subset \spec(r)$ is finite. in this case $(0) \in u$ and $\{(0)\}$ is an open subset of $u$ (because the complement of $\{(0)\}$ is the union of the closures of the other points). thus we may assume $u = \{(0)\}$. let $\mathfrak m \subset r$ be the maximal ideal. we can find an $x \in \mathfrak m$, $x \not = 0$ such that $v(x) \cup u = \spec(r)$. in other words we see that $d(x) = \{(0)\}$. in particular we see that $\dim(r/xr) = \dim(r) - 1 \geq 1$, see lemma \ref{lemma-one-equation}. let $\overline{y}_2, \ldots, \overline{y}_{\dim(r)} \in r/xr$ generate an ideal of definition of $r/xr$, see proposition \ref{proposition-dimension}. choose lifts $y_2, \ldots, y_{\dim(r)} \in r$, so that $x, y_2, \ldots, y_{\dim(r)}$ generate an ideal of definition in $r$. this implies that $\dim(r/(y_2)) = \dim(r) - 1$ and $\dim(r/(y_2, x)) = \dim(r) - 2$, see lemma \ref{lemma-elements-generate-ideal-definition}. hence there exists a prime $\mathfrak p$ containing $y_2$ but not $x$. this contradicts the fact that $d(x) = \{(0)\}$. \end{proof} \noindent the rings $k[[t]]$ where $k$ is a field, or the ring of $p$-adic numbers are noetherian rings of dimension $1$ with finitely many primes. this is the maximum dimension for which this can happen. \begin{lemma} \label{lemma-noetherian-finite-nr-primes} a noetherian ring with finitely many primes has dimension $\leq 1$. \end{lemma} \begin{proof} let $r$ be a noetherian ring with finitely many primes. if $r$ is a local domain, then the lemma follows from lemma \ref{lemma-noetherian-local-domain-dim-2-infinite-opens}. if $r$ is a domain, then $r_\mathfrak m$ has dimension $\leq 1$ for all maximal ideals $\mathfrak m$ by the local case. hence $\dim(r) \leq 1$ by lemma \ref{lemma-dimension-height}. if $r$ is general, then $\dim(r/\mathfrak q) \leq 1$ for every minimal prime $\mathfrak q$ of $r$. since every prime contains a minimal prime (lemma \ref{lemma-zariski-topology}), this implies $\dim(r) \leq 1$. \end{proof} \begin{lemma} \label{lemma-finite-type-algebra-finite-nr-primes} let $s$ be a nonzero finite type algebra over a field $k$. the following are equivalent \begin{enumerate} \item $\dim(s) = 0$, \item $s$ has finitely many primes, \item $s$ has finitely many maximal ideals, \item $\spec(s)$ satisfies one of the equivalent conditions of lemma \ref{lemma-ring-with-only-minimal-primes}, \item $\dim_k(s) < \infty$, \item $s$ is artinian, \item $\spec(s)$ is a discrete topological space, \item add more here. \end{enumerate} \end{lemma} \begin{proof} it is immediate from the definitions that (1) is equivalent to (4) by looking at part (5) of lemma \ref{lemma-ring-with-only-minimal-primes}. recall that $\spec(s)$ is sober, noetherian, and jacobson, see lemmas \ref{lemma-spec-spectral}, \ref{lemma-noetherian-topology}, \ref{lemma-finite-type-field-jacobson}, and \ref{lemma-jacobson}. if $s$ has dimension $0$, then every point defines an irreducible component and there are only a finite number of irreducible components (topology, lemma \ref{topology-lemma-noetherian}). thus (1) implies (2). trivially (2) implies (3). if (3) holds, then $\spec(s)$ is discrete by topology, lemma \ref{topology-lemma-finite-jacobson} and hence the dimension of $s$ is $0$. \medskip\noindent at this point we know that (1) -- (4) are equivalent. the implication (5) $\rightarrow$ (6) is lemma \ref{lemma-finite-dimensional-algebra}. the implication (6) $\rightarrow$ (7) follows from proposition \ref{proposition-dimension-zero-ring}. the implication (7) $\rightarrow$ (4) is immediate. conversely, if $s$ satisfies (1) -- (4), then $s$ has finitely many primes $\mathfrak m_1, \ldots, \mathfrak m_r$ all maximal. note that $\kappa(\mathfrak m_i)$ is a finite extension of $k$ by the hilbert nullstellensatz (theorem \ref{theorem-nullstellensatz}). by proposition \ref{proposition-dimension-zero-ring} we also see that $s$ is artinian. next, lemma \ref{lemma-artinian-finite-length} tells us that $\text{length}_s(s) < \infty$. thus $\dim_k(s) < \infty$ by lemma \ref{lemma-pushdown-module}. we conclude that (1) -- (7) are equivalent. (note: another and more standard way to prove $\dim(s) = 0 \rightarrow \dim_k(s) < \infty$ is to use noether normalization, but we don't have this available to us yet.) \end{proof} \begin{lemma} \label{lemma-noetherian-dim-1-jacobson} noetherian jacobson rings. \begin{enumerate} \item any noetherian domain $r$ of dimension $1$ with infinitely many primes is jacobson. \item any noetherian ring such that every prime $\mathfrak p$ is either maximal or contained in infinitely many prime ideals is jacobson. \end{enumerate} \end{lemma} \begin{proof} part (1) is a reformulation of lemma \ref{lemma-pid-jacobson}. \medskip\noindent let $r$ be a noetherian ring such that every non-maximal prime $\mathfrak p$ is contained in infinitely many prime ideals. assume $\spec(r)$ is not jacobson to get a contradiction. by lemmas \ref{lemma-irreducible} and \ref{lemma-noetherian-topology} we see that $\spec(r)$ is a sober, noetherian topological space. by topology, lemma \ref{topology-lemma-non-jacobson-noetherian-characterize} we see that there exists a non-maximal ideal $\mathfrak p \subset r$ such that $\{\mathfrak p\}$ is a locally closed subset of $\spec(r)$. in other words, $\mathfrak p$ is not maximal and $\{\mathfrak p\}$ is an open subset of $v(\mathfrak p)$. consider a prime $\mathfrak q \subset r$ with $\mathfrak p \subset \mathfrak q$. recall that the topology on the spectrum of $(r/\mathfrak p)_{\mathfrak q} = r_{\mathfrak q}/\mathfrak pr_{\mathfrak q}$ is induced from that of $\spec(r)$, see lemmas \ref{lemma-spec-localization} and \ref{lemma-spec-closed}. hence we see that $\{(0)\}$ is a locally closed subset of $\spec((r/\mathfrak p)_{\mathfrak q})$. by lemma \ref{lemma-noetherian-local-domain-dim-2-infinite-opens} we conclude that $\dim((r/\mathfrak p)_{\mathfrak q}) = 1$. since this holds for every $\mathfrak q \supset \mathfrak p$ we conclude that $\dim(r/\mathfrak p) = 1$. at this point we use the assumption that $\mathfrak p$ is contained in infinitely many primes to see that $\spec(r/\mathfrak p)$ is infinite. hence by part (1) of the lemma we see that $v(\mathfrak p) \cong \spec(r/\mathfrak p)$ is the closure of its closed points. this is the desired contradiction since it means that $\{\mathfrak p\} \subset v(\mathfrak p)$ cannot be open. \end{proof} \section{support and dimension of modules} \label{section-support} \noindent some basic results on the support and dimension of modules. \begin{lemma} \label{lemma-filter-noetherian-module} let $r$ be a noetherian ring, and let $m$ be a finite $r$-module. there exists a filtration by $r$-submodules $$ 0 = m_0 \subset m_1 \subset \ldots \subset m_n = m $$ such that each quotient $m_i/m_{i-1}$ is isomorphic to $r/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$ of $r$. \end{lemma} \begin{proof}[first proof] by lemma \ref{lemma-trivial-filter-finite-module} it suffices to do the case $m = r/i$ for some ideal $i$. consider the set $s$ of ideals $j$ such that the lemma does not hold for the module $r/j$, and order it by inclusion. to arrive at a contradiction, assume that $s$ is not empty. because $r$ is noetherian, $s$ has a maximal element $j$. by definition of $s$, the ideal $j$ cannot be prime. pick $a, b\in r$ such that $ab \in j$, but neither $a \in j$ nor $b\in j$. consider the filtration $0 \subset ar/(j \cap ar) \subset r/j$. note that both the submodule $ar/(j \cap ar)$ and the quotient module $(r/j)/(ar/(j \cap ar))$ are cyclic modules; write them as $r/j'$ and $r/j''$ so we have a short exact sequence $0 \to r/j' \to r/j \to r/j'' \to 0$. the inclusion $j \subset j'$ is strict as $b \in j'$ and the inclusion $j \subset j''$ is strict as $a \in j''$. hence by maximality of $j$, both $r/j'$ and $r/j''$ have a filtration as above and hence so does $r/j$. contradiction. \end{proof} \begin{proof}[second proof] for an $r$-module $m$ we say $p(m)$ holds if there exists a filtration as in the statement of the lemma. observe that $p$ is stable under extensions and holds for $0$. by lemma \ref{lemma-trivial-filter-finite-module} it suffices to prove $p(r/i)$ holds for every ideal $i$. if not then because $r$ is noetherian, there is a maximal counter example $j$. by example \ref{example-oka-family-property-modules} and proposition \ref{proposition-oka} the ideal $j$ is prime which is a contradiction. \end{proof} \begin{lemma} \label{lemma-filter-primes-in-support} let $r$, $m$, $m_i$, $\mathfrak p_i$ as in lemma \ref{lemma-filter-noetherian-module}. then $\text{supp}(m) = \bigcup v(\mathfrak p_i)$ and in particular $\mathfrak p_i \in \text{supp}(m)$. \end{lemma} \begin{proof} this follows from lemmas \ref{lemma-support-closed} and \ref{lemma-support-quotient}. \end{proof} \begin{lemma} \label{lemma-support-point} suppose that $r$ is a noetherian local ring with maximal ideal $\mathfrak m$. let $m$ be a nonzero finite $r$-module. then $\text{supp}(m) = \{ \mathfrak m\}$ if and only if $m$ has finite length over $r$. \end{lemma} \begin{proof} assume that $\text{supp}(m) = \{ \mathfrak m\}$. it suffices to show that all the primes $\mathfrak p_i$ in the filtration of lemma \ref{lemma-filter-noetherian-module} are the maximal ideal. this is clear by lemma \ref{lemma-filter-primes-in-support}. \medskip\noindent suppose that $m$ has finite length over $r$. then $\mathfrak m^n m = 0$ by lemma \ref{lemma-length-infinite}. since some element of $\mathfrak m$ maps to a unit in $r_{\mathfrak p}$ for any prime $\mathfrak p \not = \mathfrak m$ in $r$ we see $m_{\mathfrak p} = 0$. \end{proof} \begin{lemma} \label{lemma-noetherian-power-ideal-kills-module} let $r$ be a noetherian ring. let $i \subset r$ be an ideal. let $m$ be a finite $r$-module. then $i^nm = 0$ for some $n \geq 0$ if and only if $\text{supp}(m) \subset v(i)$. \end{lemma} \begin{proof} indeed, $i^nm = 0$ is equivalent to $i^n \subset \text{ann}(m)$. since $r$ is noetherian, this is equivalent to $i \subset \sqrt{\text{ann}(m)}$, see lemma \ref{lemma-noetherian-power}. this in turn is equivalent to $v(i) \supset v(\text{ann}(m))$, see lemma \ref{lemma-zariski-topology}. by lemma \ref{lemma-support-closed} this is equivalent to $v(i) \supset \text{supp}(m)$. \end{proof} \begin{lemma} \label{lemma-filter-minimal-primes-in-support} let $r$, $m$, $m_i$, $\mathfrak p_i$ as in lemma \ref{lemma-filter-noetherian-module}. the minimal elements of the set $\{\mathfrak p_i\}$ are the minimal elements of $\text{supp}(m)$. the number of times a minimal prime $\mathfrak p$ occurs is $$ \#\{i \mid \mathfrak p_i = \mathfrak p\} = \text{length}_{r_\mathfrak p} m_{\mathfrak p}. $$ \end{lemma} \begin{proof} the first statement follows because $\text{supp}(m) = \bigcup v(\mathfrak p_i)$, see lemma \ref{lemma-filter-primes-in-support}. let $\mathfrak p \in \text{supp}(m)$ be minimal. the support of $m_{\mathfrak p}$ is the set consisting of the maximal ideal $\mathfrak p r_{\mathfrak p}$. hence by lemma \ref{lemma-support-point} the length of $m_{\mathfrak p}$ is finite and $> 0$. next we note that $m_{\mathfrak p}$ has a filtration with subquotients $ (r/\mathfrak p_i)_{\mathfrak p} = r_{\mathfrak p}/{\mathfrak p_i}r_{\mathfrak p} $. these are zero if $\mathfrak p_i \not \subset \mathfrak p$ and equal to $\kappa(\mathfrak p)$ if $\mathfrak p_i \subset \mathfrak p$ because by minimality of $\mathfrak p$ we have $\mathfrak p_i = \mathfrak p$ in this case. the result follows since $\kappa(\mathfrak p)$ has length $1$. \end{proof} \begin{lemma} \label{lemma-support-dimension-d} let $r$ be a noetherian local ring. let $m$ be a finite $r$-module. then $d(m) = \dim(\text{supp}(m))$ where $d(m)$ is as in definition \ref{definition-d}. \end{lemma} \begin{proof} let $m_i, \mathfrak p_i$ be as in lemma \ref{lemma-filter-noetherian-module}. by lemma \ref{lemma-hilbert-ses-chi} we obtain the equality $d(m) = \max \{ d(r/\mathfrak p_i) \}$. by proposition \ref{proposition-dimension} we have $d(r/\mathfrak p_i) = \dim(r/\mathfrak p_i)$. trivially $\dim(r/\mathfrak p_i) = \dim v(\mathfrak p_i)$. since all minimal primes of $\text{supp}(m)$ occur among the $\mathfrak p_i$ (lemma \ref{lemma-filter-minimal-primes-in-support}) we win. \end{proof} \begin{lemma} \label{lemma-ses-dimension} let $r$ be a noetherian ring. let $0 \to m' \to m \to m'' \to 0$ be a short exact sequence of finite $r$-modules. then $\max\{\dim(\text{supp}(m')), \dim(\text{supp}(m''))\} = \dim(\text{supp}(m))$. \end{lemma} \begin{proof} if $r$ is local, this follows immediately from lemmas \ref{lemma-support-dimension-d} and \ref{lemma-hilbert-ses-chi}. a more elementary argument, which works also if $r$ is not local, is to use that $\text{supp}(m')$, $\text{supp}(m'')$, and $\text{supp}(m)$ are closed (lemma \ref{lemma-support-closed}) and that $\text{supp}(m) = \text{supp}(m') \cup \text{supp}(m'')$ (lemma \ref{lemma-support-quotient}). \end{proof} \section{associated primes} \label{section-ass} \noindent here is the standard definition. for non-noetherian rings and non-finite modules it may be more appropriate to use the definition in section \ref{section-weakly-ass}. \begin{definition} \label{definition-associated} let $r$ be a ring. let $m$ be an $r$-module. a prime $\mathfrak p$ of $r$ is {\it associated} to $m$ if there exists an element $m \in m$ whose annihilator is $\mathfrak p$. the set of all such primes is denoted $\text{ass}_r(m)$ or $\text{ass}(m)$. \end{definition} \begin{lemma} \label{lemma-ass-support} let $r$ be a ring. let $m$ be an $r$-module. then $\text{ass}(m) \subset \text{supp}(m)$. \end{lemma} \begin{proof} if $m \in m$ has annihilator $\mathfrak p$, then in particular no element of $r \setminus \mathfrak p$ annihilates $m$. hence $m$ is a nonzero element of $m_{\mathfrak p}$, i.e., $\mathfrak p \in \text{supp}(m)$. \end{proof} \begin{lemma} \label{lemma-ass} let $r$ be a ring. let $0 \to m' \to m \to m'' \to 0$ be a short exact sequence of $r$-modules. then $\text{ass}(m') \subset \text{ass}(m)$ and $\text{ass}(m) \subset \text{ass}(m') \cup \text{ass}(m'')$. also $\text{ass}(m' \oplus m'') = \text{ass}(m') \cup \text{ass}(m'')$. \end{lemma} \begin{proof} if $m' \in m'$, then the annihilator of $m'$ viewed as an element of $m'$ is the same as the annihilator of $m'$ viewed as an element of $m$. hence the inclusion $\text{ass}(m') \subset \text{ass}(m)$. let $m \in m$ be an element whose annihilator is a prime ideal $\mathfrak p$. if there exists a $g \in r$, $g \not \in \mathfrak p$ such that $m' = gm \in m'$ then the annihilator of $m'$ is $\mathfrak p$. if there does not exist a $g \in r$, $g \not \in \mathfrak p$ such that $gm \in m'$, then the annilator of the image $m'' \in m''$ of $m$ is $\mathfrak p$. this proves the inclusion $\text{ass}(m) \subset \text{ass}(m') \cup \text{ass}(m'')$. we omit the proof of the final statement. \end{proof} \begin{lemma} \label{lemma-ass-filter} let $r$ be a ring, and $m$ an $r$-module. suppose there exists a filtration by $r$-submodules $$ 0 = m_0 \subset m_1 \subset \ldots \subset m_n = m $$ such that each quotient $m_i/m_{i-1}$ is isomorphic to $r/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$ of $r$. then $\text{ass}(m) \subset \{\mathfrak p_1, \ldots, \mathfrak p_n\}$. \end{lemma} \begin{proof} by induction on the length $n$ of the filtration $\{ m_i \}$. pick $m \in m$ whose annihilator is a prime $\mathfrak p$. if $m \in m_{n-1}$ we are done by induction. if not, then $m$ maps to a nonzero element of $m/m_{n-1} \cong r/\mathfrak p_n$. hence we have $\mathfrak p \subset \mathfrak p_n$. if equality does not hold, then we can find $f \in \mathfrak p_n$, $f \not\in \mathfrak p$. in this case the annihilator of $fm$ is still $\mathfrak p$ and $fm \in m_{n-1}$. thus we win by induction. \end{proof} \begin{lemma} \label{lemma-finite-ass} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. then $\text{ass}(m)$ is finite. \end{lemma} \begin{proof} immediate from lemma \ref{lemma-ass-filter} and lemma \ref{lemma-filter-noetherian-module}. \end{proof} \begin{proposition} \label{proposition-minimal-primes-associated-primes} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. the following sets of primes are the same: \begin{enumerate} \item the minimal primes in the support of $m$. \item the minimal primes in $\text{ass}(m)$. \item for any filtration $0 = m_0 \subset m_1 \subset \ldots \subset m_{n-1} \subset m_n = m$ with $m_i/m_{i-1} \cong r/\mathfrak p_i$ the minimal primes of the set $\{\mathfrak p_i\}$. \end{enumerate} \end{proposition} \begin{proof} choose a filtration as in (3). in lemma \ref{lemma-filter-minimal-primes-in-support} we have seen that the sets in (1) and (3) are equal. \medskip\noindent let $\mathfrak p$ be a minimal element of the set $\{\mathfrak p_i\}$. let $i$ be minimal such that $\mathfrak p = \mathfrak p_i$. pick $m \in m_i$, $m \not \in m_{i-1}$. the annihilator of $m$ is contained in $\mathfrak p_i = \mathfrak p$ and contains $\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_i$. by our choice of $i$ and $\mathfrak p$ we have $\mathfrak p_j \not \subset \mathfrak p$ for $j < i$ and hence we have $\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i - 1} \not \subset \mathfrak p_i$. pick $f \in \mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i - 1}$, $f \not \in \mathfrak p$. then $fm$ has annihilator $\mathfrak p$. in this way we see that $\mathfrak p$ is an associated prime of $m$. by lemma \ref{lemma-ass-support} we have $\text{ass}(m) \subset \text{supp}(m)$ and hence $\mathfrak p$ is minimal in $\text{ass}(m)$. thus the set of primes in (1) is contained in the set of primes of (2). \medskip\noindent let $\mathfrak p$ be a minimal element of $\text{ass}(m)$. since $\text{ass}(m) \subset \text{supp}(m)$ there is a minimal element $\mathfrak q$ of $\text{supp}(m)$ with $\mathfrak q \subset \mathfrak p$. we have just shown that $\mathfrak q \in \text{ass}(m)$. hence $\mathfrak q = \mathfrak p$ by minimality of $\mathfrak p$. thus the set of primes in (2) is contained in the set of primes of (1). \end{proof} \begin{lemma} \label{lemma-ass-zero} \begin{slogan} over a noetherian ring each nonzero module has an associated prime. \end{slogan} let $r$ be a noetherian ring. let $m$ be an $r$-module. then $$ m = (0) \leftrightarrow \text{ass}(m) = \emptyset. $$ \end{lemma} \begin{proof} if $m = (0)$, then $\text{ass}(m) = \emptyset$ by definition. if $m \not = 0$, pick any nonzero finitely generated submodule $m' \subset m$, for example a submodule generated by a single nonzero element. by lemma \ref{lemma-support-zero} we see that $\text{supp}(m')$ is nonempty. by proposition \ref{proposition-minimal-primes-associated-primes} this implies that $\text{ass}(m')$ is nonempty. by lemma \ref{lemma-ass} this implies $\text{ass}(m) \not = \emptyset$. \end{proof} \begin{lemma} \label{lemma-ass-minimal-prime-support} let $r$ be a noetherian ring. let $m$ be an $r$-module. any $\mathfrak p \in \text{supp}(m)$ which is minimal among the elements of $\text{supp}(m)$ is an element of $\text{ass}(m)$. \end{lemma} \begin{proof} if $m$ is a finite $r$-module, then this is a consequence of proposition \ref{proposition-minimal-primes-associated-primes}. in general write $m = \bigcup m_\lambda$ as the union of its finite submodules, and use that $\text{supp}(m) = \bigcup \text{supp}(m_\lambda)$ and $\text{ass}(m) = \bigcup \text{ass}(m_\lambda)$. \end{proof} \begin{lemma} \label{lemma-ass-zero-divisors} let $r$ be a noetherian ring. let $m$ be an $r$-module. the union $\bigcup_{\mathfrak q \in \text{ass}(m)} \mathfrak q$ is the set of elements of $r$ which are zerodivisors on $m$. \end{lemma} \begin{proof} any element in any associated prime clearly is a zerodivisor on $m$. conversely, suppose $x \in r$ is a zerodivisor on $m$. consider the submodule $n = \{m \in m \mid xm = 0\}$. since $n$ is not zero it has an associated prime $\mathfrak q$ by lemma \ref{lemma-ass-zero}. then $x \in \mathfrak q$ and $\mathfrak q$ is an associated prime of $m$ by lemma \ref{lemma-ass}. \end{proof} \begin{lemma} \label{lemma-one-equation-module} let $r$ is a noetherian local ring, $m$ a finite $r$-module, and $f \in \mathfrak m$ an element of the maximal ideal of $r$. then $$ \dim(\text{supp}(m/fm)) \leq \dim(\text{supp}(m)) \leq \dim(\text{supp}(m/fm)) + 1 $$ if $f$ is not in any of the minimal primes of the support of $m$ (for example if $f$ is a nonzerodivisor on $m$), then equality holds for the right inequality. \end{lemma} \begin{proof} (the parenthetical statement follows from lemma \ref{lemma-ass-zero-divisors}.) the first inequality follows from $\text{supp}(m/fm) \subset \text{supp}(m)$, see lemma \ref{lemma-support-quotient}. for the second inequality, note that $\text{supp}(m/fm) = \text{supp}(m) \cap v(f)$, see lemma \ref{lemma-support-quotient}. it follows, for example by lemma \ref{lemma-filter-primes-in-support} and elementary properties of dimension, that it suffices to show $\dim v(\mathfrak p) \leq \dim (v(\mathfrak p) \cap v(f)) + 1$ for primes $\mathfrak p$ of $r$. this is a consequence of lemma \ref{lemma-one-equation}. finally, if $f$ is not contained in any minimal prime of the support of $m$, then the chains of primes in $\text{supp}(m/fm)$ all give rise to chains in $\text{supp}(m)$ which are at least one step away from being maximal. \end{proof} \begin{lemma} \label{lemma-ass-functorial} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. then $\spec(\varphi)(\text{ass}_s(m)) \subset \text{ass}_r(m)$. \end{lemma} \begin{proof} if $\mathfrak q \in \text{ass}_s(m)$, then there exists an $m$ in $m$ such that the annihilator of $m$ in $s$ is $\mathfrak q$. then the annihilator of $m$ in $r$ is $\mathfrak q \cap r$. \end{proof} \begin{remark} \label{remark-ass-reverse-functorial} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. then it is not always the case that $\spec(\varphi)(\text{ass}_s(m)) \supset \text{ass}_r(m)$. for example, consider the ring map $r = k \to s = k[x_1, x_2, x_3, \ldots]/(x_i^2)$ and $m = s$. then $\text{ass}_r(m)$ is not empty, but $\text{ass}_s(s)$ is empty. \end{remark} \begin{lemma} \label{lemma-ass-functorial-noetherian} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. if $s$ is noetherian, then $\spec(\varphi)(\text{ass}_s(m)) = \text{ass}_r(m)$. \end{lemma} \begin{proof} we have already seen in lemma \ref{lemma-ass-functorial} that $\spec(\varphi)(\text{ass}_s(m)) \subset \text{ass}_r(m)$. for the converse, choose a prime $\mathfrak p \in \text{ass}_r(m)$. let $m \in m$ be an element such that the annihilator of $m$ in $r$ is $\mathfrak p$. let $i = \{g \in s \mid gm = 0\}$ be the annihilator of $m$ in $s$. then $r/\mathfrak p \subset s/i$ is injective. combining lemmas \ref{lemma-injective-minimal-primes-in-image} and \ref{lemma-minimal-prime-image-minimal-prime} we see that there is a prime $\mathfrak q \subset s$ minimal over $i$ mapping to $\mathfrak p$. by proposition \ref{proposition-minimal-primes-associated-primes} we see that $\mathfrak q$ is an associated prime of $s/i$, hence $\mathfrak q$ is an associated prime of $m$ by lemma \ref{lemma-ass} and we win. \end{proof} \begin{lemma} \label{lemma-ass-quotient-ring} let $r$ be a ring. let $i$ be an ideal. let $m$ be an $r/i$-module. via the canonical injection $\spec(r/i) \to \spec(r)$ we have $\text{ass}_{r/i}(m) = \text{ass}_r(m)$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-associated-primes-localize} let $r$ be a ring. let $m$ be an $r$-module. let $\mathfrak p \subset r$ be a prime. \begin{enumerate} \item if $\mathfrak p \in \text{ass}(m)$ then $\mathfrak pr_{\mathfrak p} \in \text{ass}(m_{\mathfrak p})$. \item if $\mathfrak p$ is finitely generated then the converse holds as well. \end{enumerate} \end{lemma} \begin{proof} if $\mathfrak p \in \text{ass}(m)$ there exists an element $m \in m$ whose annihilator is $\mathfrak p$. as localization is exact (proposition \ref{proposition-localization-exact}) we see that the annihilator of $m/1$ in $m_{\mathfrak p}$ is $\mathfrak pr_{\mathfrak p}$ hence (1) holds. assume $\mathfrak pr_{\mathfrak p} \in \text{ass}(m_{\mathfrak p})$ and $\mathfrak p = (f_1, \ldots, f_n)$. let $m/g$ be an element of $m_{\mathfrak p}$ whose annihilator is $\mathfrak pr_{\mathfrak p}$. this implies that the annihilator of $m$ is contained in $\mathfrak p$. as $f_i m/g = 0$ in $m_{\mathfrak p}$ we see there exists a $g_i \in r$, $g_i \not \in \mathfrak p$ such that $g_i f_i m = 0$ in $m$. combined we see the annihilator of $g_1\ldots g_nm$ is $\mathfrak p$. hence $\mathfrak p \in \text{ass}(m)$. \end{proof} \begin{lemma} \label{lemma-localize-ass} let $r$ be a ring. let $m$ be an $r$-module. let $s \subset r$ be a multiplicative subset. via the canonical injection $\spec(s^{-1}r) \to \spec(r)$ we have \begin{enumerate} \item $\text{ass}_r(s^{-1}m) = \text{ass}_{s^{-1}r}(s^{-1}m)$, \item $\text{ass}_r(m) \cap \spec(s^{-1}r) \subset \text{ass}_r(s^{-1}m)$, and \item if $r$ is noetherian this inclusion is an equality. \end{enumerate} \end{lemma} \begin{proof} for $m \in s^{-1}m$, let $i \subset r$ and $j \subset s^{-1}r$ be the annihilators of $m$. then $i$ is the inverse image of $j$ by the map $r \to s^{-1}r$ and $j = s^{-1}i$. the equality in (1) follows by the description of the map $\spec(s^{-1}r) \to \spec(r)$ in lemma \ref{lemma-spec-localization}. for $m \in m$, let $i \subset r$ be the annihilator of $m$ in $r$ and let $j \subset s^{-1}r$ be the annihilator of $m/1 \in s^{-1}m$. we have $j = s^{-1}i$ which implies (2). the equality in the noetherian case follows from lemma \ref{lemma-associated-primes-localize} since for $\mathfrak p \in r$, $s \cap \mathfrak p = \emptyset$ we have $m_{\mathfrak p} = (s^{-1}m)_{s^{-1}\mathfrak p}$. \end{proof} \begin{lemma} \label{lemma-localize-ass-nonzero-divisors} let $r$ be a ring. let $m$ be an $r$-module. let $s \subset r$ be a multiplicative subset. assume that every $s \in s$ is a nonzerodivisor on $m$. then $$ \text{ass}_r(m) = \text{ass}_r(s^{-1}m). $$ \end{lemma} \begin{proof} as $m \subset s^{-1}m$ by assumption we get the inclusion $\text{ass}(m) \subset \text{ass}(s^{-1}m)$ from lemma \ref{lemma-ass}. conversely, suppose that $n/s \in s^{-1}m$ is an element whose annihilator is a prime ideal $\mathfrak p$. then the annihilator of $n \in m$ is also $\mathfrak p$. \end{proof} \begin{lemma} \label{lemma-ideal-nonzerodivisor} let $r$ be a noetherian local ring with maximal ideal $\mathfrak m$. let $i \subset \mathfrak m$ be an ideal. let $m$ be a finite $r$-module. the following are equivalent: \begin{enumerate} \item there exists an $x \in i$ which is not a zerodivisor on $m$. \item we have $i \not \subset \mathfrak q$ for all $\mathfrak q \in \text{ass}(m)$. \end{enumerate} \end{lemma} \begin{proof} if there exists a nonzerodivisor $x$ in $i$, then $x$ clearly cannot be in any associated prime of $m$. conversely, suppose $i \not \subset \mathfrak q$ for all $\mathfrak q \in \text{ass}(m)$. in this case we can choose $x \in i$, $x \not \in \mathfrak q$ for all $\mathfrak q \in \text{ass}(m)$ by lemmas \ref{lemma-finite-ass} and \ref{lemma-silly}. by lemma \ref{lemma-ass-zero-divisors} the element $x$ is not a zerodivisor on $m$. \end{proof} \begin{lemma} \label{lemma-zero-at-ass-zero} let $r$ be a ring. let $m$ be an $r$-module. if $r$ is noetherian the map $$ m \longrightarrow \prod\nolimits_{\mathfrak p \in \text{ass}(m)} m_{\mathfrak p} $$ is injective. \end{lemma} \begin{proof} let $x \in m$ be an element of the kernel of the map. then if $\mathfrak p$ is an associated prime of $rx \subset m$ we see on the one hand that $\mathfrak p \in \text{ass}(m)$ (lemma \ref{lemma-ass}) and on the other hand that $(rx)_{\mathfrak p} \subset m_{\mathfrak p}$ is not zero. this contradiction shows that $\text{ass}(rx) = \emptyset$. hence $rx = 0$ by lemma \ref{lemma-ass-zero}. \end{proof} \noindent this lemma should probably be put somewhere else. \begin{lemma} \label{lemma-dim-not-zero-exists-nonzerodivisor-nonunit} let $k$ be a field. let $s$ be a finite type $k$ algebra. if $\dim(s) > 0$, then there exists an element $f \in s$ which is a nonzerodivisor and a nonunit. \end{lemma} \begin{proof} by lemma \ref{lemma-finite-ass} the ring $s$ has finitely many associated prime ideals. by lemma \ref{lemma-finite-type-algebra-finite-nr-primes} the ring $s$ has infinitely many maximal ideals. hence we can choose a maximal ideal $\mathfrak m \subset s$ which is not an associated prime of $s$. by prime avoidance (lemma \ref{lemma-silly}), we can choose a nonzero $f \in \mathfrak m$ which is not contained in any of the associated primes of $s$. by lemma \ref{lemma-ass-zero-divisors} the element $f$ is a nonzerodivisor and as $f \in \mathfrak m$ we see that $f$ is not a unit. \end{proof} \section{symbolic powers} \label{section-symbolic-power} \noindent here is the definition. \begin{definition} \label{definition-symbolic-power} let $r$ be a ring. let $\mathfrak p$ be a prime ideal. for $n \geq 0$ the $n$th {\it symbolic power} of $\mathfrak p$ is the ideal $\mathfrak p^{(n)} = \ker(r \to r_\mathfrak p/\mathfrak p^nr_\mathfrak p)$. \end{definition} \noindent note that $\mathfrak p^n \subset \mathfrak p^{(n)}$ but equality does not always hold. \begin{lemma} \label{lemma-symbolic-power-associated} let $r$ be a noetherian ring. let $\mathfrak p$ be a prime ideal. let $n > 0$. then $\text{ass}(r/\mathfrak p^{(n)}) = \{\mathfrak p\}$. \end{lemma} \begin{proof} if $\mathfrak q$ is an associated prime of $r/\mathfrak p^{(n)}$ then clearly $\mathfrak p \subset \mathfrak q$. on the other hand, any element $x \in r$, $x \not \in \mathfrak p$ is a nonzerodivisor on $r/\mathfrak p^{(n)}$. namely, if $y \in r$ and $xy \in \mathfrak p^{(n)} = r \cap \mathfrak p^nr_{\mathfrak p}$ then $y \in \mathfrak p^nr_{\mathfrak p}$, hence $y \in \mathfrak p^{(n)}$. hence the lemma follows. \end{proof} \begin{lemma} \label{lemma-symbolic-power-flat-extension} let $r \to s$ be flat ring map. let $\mathfrak p \subset r$ be a prime such that $\mathfrak q = \mathfrak p s$ is a prime of $s$. then $\mathfrak p^{(n)} s = \mathfrak q^{(n)}$. \end{lemma} \begin{proof} since $\mathfrak p^{(n)} = \ker(r \to r_\mathfrak p/\mathfrak p^nr_\mathfrak p)$ we see using flatness that $\mathfrak p^{(n)} s$ is the kernel of the map $s \to s_\mathfrak p/\mathfrak p^ns_\mathfrak p$. on the other hand $\mathfrak q^{(n)}$ is the kernel of the map $s \to s_\mathfrak q/\mathfrak q^ns_\mathfrak q = s_\mathfrak q/\mathfrak p^ns_\mathfrak q$. hence it suffices to show that $$ s_\mathfrak p/\mathfrak p^ns_\mathfrak p \longrightarrow s_\mathfrak q/\mathfrak p^ns_\mathfrak q $$ is injective. observe that the right hand module is the localization of the left hand module by elements $f \in s$, $f \not \in \mathfrak q$. thus it suffices to show these elements are nonzerodivisors on $s_\mathfrak p/\mathfrak p^ns_\mathfrak p$. by flatness, the module $s_\mathfrak p/\mathfrak p^ns_\mathfrak p$ has a finite filtration whose subquotients are $$ \mathfrak p^is_\mathfrak p/\mathfrak p^{i + 1}s_\mathfrak p \cong \mathfrak p^ir_\mathfrak p/\mathfrak p^{i + 1}r_\mathfrak p \otimes_{r_\mathfrak p} s_\mathfrak p \cong v \otimes_{\kappa(\mathfrak p)} (s/\mathfrak q)_\mathfrak p $$ where $v$ is a $\kappa(\mathfrak p)$ vector space. thus $f$ acts invertibly as desired. \end{proof} \section{relative assassin} \label{section-relative-assassin} \noindent discussion of relative assassins. let $r \to s$ be a ring map. let $n$ be an $s$-module. in this situation we can introduce the following sets of primes $\mathfrak q$ of $s$: \begin{enumerate} \item $a$: with $\mathfrak p = r \cap \mathfrak q$ we have that $\mathfrak q \in \text{ass}_s(n \otimes_r \kappa(\mathfrak p))$, \item $a'$: with $\mathfrak p = r \cap \mathfrak q$ we have that $\mathfrak q$ is in the image of $\text{ass}_{s \otimes \kappa(\mathfrak p)}(n \otimes_r \kappa(\mathfrak p))$ under the canonical map $\spec(s \otimes_r \kappa(\mathfrak p)) \to \spec(s)$, \item $a_{fin}$: with $\mathfrak p = r \cap \mathfrak q$ we have that $\mathfrak q \in \text{ass}_s(n/\mathfrak pn)$, \item $a'_{fin}$: for some prime $\mathfrak p' \subset r$ we have $\mathfrak q \in \text{ass}_s(n/\mathfrak p'n)$, \item $b$: for some $r$-module $m$ we have $\mathfrak q \in \text{ass}_s(n \otimes_r m)$, and \item $b_{fin}$: for some finite $r$-module $m$ we have $\mathfrak q \in \text{ass}_s(n \otimes_r m)$. \end{enumerate} let us determine some of the relations between these sets. \begin{lemma} \label{lemma-compare-relative-assassins} let $r \to s$ be a ring map. let $n$ be an $s$-module. let $a$, $a'$, $a_{fin}$, $b$, and $b_{fin}$ be the subsets of $\spec(s)$ introduced above. \begin{enumerate} \item we always have $a = a'$. \item we always have $a_{fin} \subset a$, $b_{fin} \subset b$, $a_{fin} \subset a'_{fin} \subset b_{fin}$ and $a \subset b$. \item if $s$ is noetherian, then $a = a_{fin}$ and $b = b_{fin}$. \item if $n$ is flat over $r$, then $a = a_{fin} = a'_{fin}$ and $b = b_{fin}$. \item if $r$ is noetherian and $n$ is flat over $r$, then all of the sets are equal, i.e., $a = a' = a_{fin} = a'_{fin} = b = b_{fin}$. \end{enumerate} \end{lemma} \begin{proof} some of the arguments in the proof will be repeated in the proofs of later lemmas which are more precise than this one (because they deal with a given module $m$ or a given prime $\mathfrak p$ and not with the collection of all of them). \medskip\noindent proof of (1). let $\mathfrak p$ be a prime of $r$. then we have $$ \text{ass}_s(n \otimes_r \kappa(\mathfrak p)) = \text{ass}_{s/\mathfrak ps}(n \otimes_r \kappa(\mathfrak p)) = \text{ass}_{s \otimes_r \kappa(\mathfrak p)}(n \otimes_r \kappa(\mathfrak p)) $$ the first equality by lemma \ref{lemma-ass-quotient-ring} and the second by lemma \ref{lemma-localize-ass} part (1). this prove that $a = a'$. the inclusion $a_{fin} \subset a'_{fin}$ is clear. \medskip\noindent proof of (2). each of the inclusions is immediate from the definitions except perhaps $a_{fin} \subset a$ which follows from lemma \ref{lemma-localize-ass} and the fact that we require $\mathfrak p = r \cap \mathfrak q$ in the formulation of $a_{fin}$. \medskip\noindent proof of (3). the equality $a = a_{fin}$ follows from lemma \ref{lemma-localize-ass} part (3) if $s$ is noetherian. let $\mathfrak q = (g_1, \ldots, g_m)$ be a finitely generated prime ideal of $s$. say $z \in n \otimes_r m$ is an element whose annihilator is $\mathfrak q$. we may pick a finite submodule $m' \subset m$ such that $z$ is the image of $z' \in n \otimes_r m'$. then $\text{ann}_s(z') \subset \mathfrak q = \text{ann}_s(z)$. since $n \otimes_r -$ commutes with colimits and since $m$ is the directed colimit of finite $r$-modules we can find $m' \subset m'' \subset m$ such that the image $z'' \in n \otimes_r m''$ is annihilated by $g_1, \ldots, g_m$. hence $\text{ann}_s(z'') = \mathfrak q$. this proves that $b = b_{fin}$ if $s$ is noetherian. \medskip\noindent proof of (4). if $n$ is flat, then the functor $n \otimes_r -$ is exact. in particular, if $m' \subset m$, then $n \otimes_r m' \subset n \otimes_r m$. hence if $z \in n \otimes_r m$ is an element whose annihilator $\mathfrak q = \text{ann}_s(z)$ is a prime, then we can pick any finite $r$-submodule $m' \subset m$ such that $z \in n \otimes_r m'$ and we see that the annihilator of $z$ as an element of $n \otimes_r m'$ is equal to $\mathfrak q$. hence $b = b_{fin}$. let $\mathfrak p'$ be a prime of $r$ and let $\mathfrak q$ be a prime of $s$ which is an associated prime of $n/\mathfrak p'n$. this implies that $\mathfrak p's \subset \mathfrak q$. as $n$ is flat over $r$ we see that $n/\mathfrak p'n$ is flat over the integral domain $r/\mathfrak p'$. hence every nonzero element of $r/\mathfrak p'$ is a nonzerodivisor on $n/\mathfrak p'$. hence none of these elements can map to an element of $\mathfrak q$ and we conclude that $\mathfrak p' = r \cap \mathfrak q$. hence $a_{fin} = a'_{fin}$. finally, by lemma \ref{lemma-localize-ass-nonzero-divisors} we see that $\text{ass}_s(n/\mathfrak p'n) = \text{ass}_s(n \otimes_r \kappa(\mathfrak p'))$, i.e., $a'_{fin} = a$. \medskip\noindent proof of (5). we only need to prove $a'_{fin} = b_{fin}$ as the other equalities have been proved in (4). to see this let $m$ be a finite $r$-module. by lemma \ref{lemma-filter-noetherian-module} there exists a filtration by $r$-submodules $$ 0 = m_0 \subset m_1 \subset \ldots \subset m_n = m $$ such that each quotient $m_i/m_{i-1}$ is isomorphic to $r/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$ of $r$. since $n$ is flat we obtain a filtration by $s$-submodules $$ 0 = n \otimes_r m_0 \subset n \otimes_r m_1 \subset \ldots \subset n \otimes_r m_n = n \otimes_r m $$ such that each subquotient is isomorphic to $n/\mathfrak p_in$. by lemma \ref{lemma-ass} we conclude that $\text{ass}_s(n \otimes_r m) \subset \bigcup \text{ass}_s(n/\mathfrak p_in)$. hence we see that $b_{fin} \subset a'_{fin}$. since the other inclusion is part of (2) we win. \end{proof} \noindent we define the relative assassin of $n$ over $s/r$ to be the set $a = a'$ above. as a motivation we point out that it depends only on the fibre modules $n \otimes_r \kappa(\mathfrak p)$ over the fibre rings. as in the case of the assassin of a module we warn the reader that this notion makes most sense when the fibre rings $s \otimes_r \kappa(\mathfrak p)$ are noetherian, for example if $r \to s$ is of finite type. \begin{definition} \label{definition-relative-assassin} let $r \to s$ be a ring map. let $n$ be an $s$-module. the {\it relative assassin of $n$ over $s/r$} is the set $$ \text{ass}_{s/r}(n) = \{ \mathfrak q \subset s \mid \mathfrak q \in \text{ass}_s(n \otimes_r \kappa(\mathfrak p)) \text{ with }\mathfrak p = r \cap \mathfrak q\}. $$ this is the set named $a$ in lemma \ref{lemma-compare-relative-assassins}. \end{definition} \noindent the spirit of the next few results is that they are about the relative assassin, even though this may not be apparent. \begin{lemma} \label{lemma-bourbaki} let $r \to s$ be a ring map. let $m$ be an $r$-module, and let $n$ be an $s$-module. if $n$ is flat as $r$-module, then $$ \text{ass}_s(m \otimes_r n) \supset \bigcup\nolimits_{\mathfrak p \in \text{ass}_r(m)} \text{ass}_s(n/\mathfrak pn) $$ and if $r$ is noetherian then we have equality. \end{lemma} \begin{proof} if $\mathfrak p \in \text{ass}_r(m)$ then there exists an injection $r/\mathfrak p \to m$. as $n$ is flat over $r$ we obtain an injection $r/\mathfrak p \otimes_r n \to m \otimes_r n$. since $r/\mathfrak p \otimes_r n = n/\mathfrak pn$ we conclude that $\text{ass}_s(n/\mathfrak pn) \subset \text{ass}_s(m \otimes_r n)$, see lemma \ref{lemma-ass}. hence the right hand side is contained in the left hand side. \medskip\noindent write $m = \bigcup m_\lambda$ as the union of its finitely generated $r$-submodules. then also $n \otimes_r m = \bigcup n \otimes_r m_\lambda$ (as $n$ is $r$-flat). by definition of associated primes we see that $\text{ass}_s(n \otimes_r m) = \bigcup \text{ass}_s(n \otimes_r m_\lambda)$ and $\text{ass}_r(m) = \bigcup \text{ass}(m_\lambda)$. hence we may assume $m$ is finitely generated. \medskip\noindent let $\mathfrak q \in \text{ass}_s(m \otimes_r n)$, and assume $r$ is noetherian and $m$ is a finite $r$-module. to finish the proof we have to show that $\mathfrak q$ is an element of the right hand side. first we observe that $\mathfrak qs_{\mathfrak q} \in \text{ass}_{s_{\mathfrak q}}((m \otimes_r n)_{\mathfrak q})$, see lemma \ref{lemma-associated-primes-localize}. let $\mathfrak p$ be the corresponding prime of $r$. note that $$ (m \otimes_r n)_{\mathfrak q} = m \otimes_r n_{\mathfrak q} = m_{\mathfrak p} \otimes_{r_{\mathfrak p}} n_{\mathfrak q} $$ if $\mathfrak pr_{\mathfrak p} \not \in \text{ass}_{r_{\mathfrak p}}(m_{\mathfrak p})$ then there exists an element $x \in \mathfrak pr_{\mathfrak p}$ which is a nonzerodivisor in $m_{\mathfrak p}$ (see lemma \ref{lemma-ideal-nonzerodivisor}). since $n_{\mathfrak q}$ is flat over $r_{\mathfrak p}$ we see that the image of $x$ in $\mathfrak qs_{\mathfrak q}$ is a nonzerodivisor on $(m \otimes_r n)_{\mathfrak q}$. this is a contradiction with the assumption that $\mathfrak qs_{\mathfrak q} \in \text{ass}_s((m \otimes_r n)_{\mathfrak q})$. hence we conclude that $\mathfrak p$ is one of the associated primes of $m$. \medskip\noindent continuing the argument we choose a filtration $$ 0 = m_0 \subset m_1 \subset \ldots \subset m_n = m $$ such that each quotient $m_i/m_{i-1}$ is isomorphic to $r/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$ of $r$, see lemma \ref{lemma-filter-noetherian-module}. (by lemma \ref{lemma-ass-filter} we have $\mathfrak p_i = \mathfrak p$ for at least one $i$.) this gives a filtration $$ 0 = m_0 \otimes_r n \subset m_1 \otimes_r n \subset \ldots \subset m_n \otimes_r n = m \otimes_r n $$ with subquotients isomorphic to $n/\mathfrak p_in$. if $\mathfrak p_i \not = \mathfrak p$ then $\mathfrak q$ cannot be associated to the module $n/\mathfrak p_in$ by the result of the preceding paragraph (as $\text{ass}_r(r/\mathfrak p_i) = \{\mathfrak p_i\}$). hence we conclude that $\mathfrak q$ is associated to $n/\mathfrak pn$ as desired. \end{proof} \begin{lemma} \label{lemma-post-bourbaki} let $r \to s$ be a ring map. let $n$ be an $s$-module. assume $n$ is flat as an $r$-module and $r$ is a domain with fraction field $k$. then $$ \text{ass}_s(n) = \text{ass}_s(n \otimes_r k) = \text{ass}_{s \otimes_r k}(n \otimes_r k) $$ via the canonical inclusion $\spec(s \otimes_r k) \subset \spec(s)$. \end{lemma} \begin{proof} note that $s \otimes_r k = (r \setminus \{0\})^{-1}s$ and $n \otimes_r k = (r \setminus \{0\})^{-1}n$. for any nonzero $x \in r$ multiplication by $x$ on $n$ is injective as $n$ is flat over $r$. hence the lemma follows from lemma \ref{lemma-localize-ass-nonzero-divisors} combined with lemma \ref{lemma-localize-ass} part (1). \end{proof} \begin{lemma} \label{lemma-bourbaki-fibres} let $r \to s$ be a ring map. let $m$ be an $r$-module, and let $n$ be an $s$-module. assume $n$ is flat as $r$-module. then $$ \text{ass}_s(m \otimes_r n) \supset \bigcup\nolimits_{\mathfrak p \in \text{ass}_r(m)} \text{ass}_{s \otimes_r \kappa(\mathfrak p)}(n \otimes_r \kappa(\mathfrak p)) $$ where we use remark \ref{remark-fundamental-diagram} to think of the spectra of fibre rings as subsets of $\spec(s)$. if $r$ is noetherian then this inclusion is an equality. \end{lemma} \begin{proof} this is equivalent to lemma \ref{lemma-bourbaki} by lemmas \ref{lemma-ass-quotient-ring}, \ref{lemma-flat-base-change}, and \ref{lemma-post-bourbaki}. \end{proof} \begin{remark} \label{remark-bourbaki} let $r \to s$ be a ring map. let $n$ be an $s$-module. let $\mathfrak p$ be a prime of $r$. then $$ \text{ass}_s(n \otimes_r \kappa(\mathfrak p)) = \text{ass}_{s/\mathfrak ps}(n \otimes_r \kappa(\mathfrak p)) = \text{ass}_{s \otimes_r \kappa(\mathfrak p)}(n \otimes_r \kappa(\mathfrak p)). $$ the first equality by lemma \ref{lemma-ass-quotient-ring} and the second by lemma \ref{lemma-localize-ass} part (1). \end{remark} \section{weakly associated primes} \label{section-weakly-ass} \noindent this is a variant on the notion of an associated prime that is useful for non-noetherian ring and non-finite modules. \begin{definition} \label{definition-weakly-associated} let $r$ be a ring. let $m$ be an $r$-module. a prime $\mathfrak p$ of $r$ is {\it weakly associated} to $m$ if there exists an element $m \in m$ such that $\mathfrak p$ is minimal among the prime ideals containing the annihilator $\text{ann}(m) = \{f \in r \mid fm = 0\}$. the set of all such primes is denoted $\text{weakass}_r(m)$ or $\text{weakass}(m)$. \end{definition} \noindent thus an associated prime is a weakly associated prime. here is a characterization in terms of the localization at the prime. \begin{lemma} \label{lemma-weakly-ass-local} let $r$ be a ring. let $m$ be an $r$-module. let $\mathfrak p$ be a prime of $r$. the following are equivalent: \begin{enumerate} \item $\mathfrak p$ is weakly associated to $m$, \item $\mathfrak pr_{\mathfrak p}$ is weakly associated to $m_{\mathfrak p}$, and \item $m_{\mathfrak p}$ contains an element whose annihilator has radical equal to $\mathfrak pr_{\mathfrak p}$. \end{enumerate} \end{lemma} \begin{proof} assume (1). then there exists an element $m \in m$ such that $\mathfrak p$ is minimal among the primes containing the annihilator $i = \{x \in r \mid xm = 0\}$ of $m$. as localization is exact, the annihilator of $m$ in $m_{\mathfrak p}$ is $i_{\mathfrak p}$. hence $\mathfrak pr_{\mathfrak p}$ is a minimal prime of $r_{\mathfrak p}$ containing the annihilator $i_{\mathfrak p}$ of $m$ in $m_{\mathfrak p}$. this implies (2) holds, and also (3) as it implies that $\sqrt{i_{\mathfrak p}} = \mathfrak pr_{\mathfrak p}$. \medskip\noindent applying the implication (1) $\rightarrow$ (3) to $m_{\mathfrak p}$ over $r_{\mathfrak p}$ we see that (2) $\rightarrow$ (3). \medskip\noindent finally, assume (3). this means there exists an element $m/f \in m_{\mathfrak p}$ whose annihilator has radical equal to $\mathfrak pr_{\mathfrak p}$. then the annihilator $i = \{x \in r \mid xm = 0\}$ of $m$ in $m$ is such that $\sqrt{i_{\mathfrak p}} = \mathfrak pr_{\mathfrak p}$. clearly this means that $\mathfrak p$ contains $i$ and is minimal among the primes containing $i$, i.e., (1) holds. \end{proof} \begin{lemma} \label{lemma-reduced-weakly-ass-minimal} for a reduced ring the weakly associated primes of the ring are the minimal primes. \end{lemma} \begin{proof} let $(r, \mathfrak m)$ be a reduced local ring. suppose $x \in r$ is an element whose annihilator has radical $\mathfrak m$. if $\mathfrak m \not = 0$, then $x$ cannot be a unit, so $x \in \mathfrak m$. then in particular $x^{1 + n} = 0$ for some $n \geq 0$. hence $x = 0$. which contradicts the assumption that the annihilator of $x$ is contained in $\mathfrak m$. thus we see that $\mathfrak m = 0$, i.e., $r$ is a field. by lemma \ref{lemma-weakly-ass-local} this implies the statement of the lemma. \end{proof} \begin{lemma} \label{lemma-weakly-ass} let $r$ be a ring. let $0 \to m' \to m \to m'' \to 0$ be a short exact sequence of $r$-modules. then $\text{weakass}(m') \subset \text{weakass}(m)$ and $\text{weakass}(m) \subset \text{weakass}(m') \cup \text{weakass}(m'')$. \end{lemma} \begin{proof} we will use the characterization of weakly associated primes of lemma \ref{lemma-weakly-ass-local}. let $\mathfrak p$ be a prime of $r$. as localization is exact we obtain the short exact sequence $0 \to m'_{\mathfrak p} \to m_{\mathfrak p} \to m''_{\mathfrak p} \to 0$. suppose that $m \in m_{\mathfrak p}$ is an element whose annihilator has radical $\mathfrak pr_{\mathfrak p}$. then either the image $\overline{m}$ of $m$ in $m''_{\mathfrak p}$ is zero and $m \in m'_{\mathfrak p}$, or the radical of the annihilator of $\overline{m}$ is $\mathfrak pr_{\mathfrak p}$. this proves that $\text{weakass}(m) \subset \text{weakass}(m') \cup \text{weakass}(m'')$. the inclusion $\text{weakass}(m') \subset \text{weakass}(m)$ is immediate from the definitions. \end{proof} \begin{lemma} \label{lemma-weakly-ass-zero} \begin{slogan} every nonzero module has a weakly associated prime. \end{slogan} let $r$ be a ring. let $m$ be an $r$-module. then $$ m = (0) \leftrightarrow \text{weakass}(m) = \emptyset $$ \end{lemma} \begin{proof} if $m = (0)$ then $\text{weakass}(m) = \emptyset$ by definition. conversely, suppose that $m \not = 0$. pick a nonzero element $m \in m$. write $i = \{x \in r \mid xm = 0\}$ the annihilator of $m$. then $r/i \subset m$. hence $\text{weakass}(r/i) \subset \text{weakass}(m)$ by lemma \ref{lemma-weakly-ass}. but as $i \not = r$ we have $v(i) = \spec(r/i)$ contains a minimal prime, see lemmas \ref{lemma-zariski-topology} and \ref{lemma-spec-closed}, and we win. \end{proof} \begin{lemma} \label{lemma-weakly-ass-support} let $r$ be a ring. let $m$ be an $r$-module. then $$ \text{ass}(m) \subset \text{weakass}(m) \subset \text{supp}(m). $$ \end{lemma} \begin{proof} the first inclusion is immediate from the definitions. if $\mathfrak p \in \text{weakass}(m)$, then by lemma \ref{lemma-weakly-ass-local} we have $m_{\mathfrak p} \not = 0$, hence $\mathfrak p \in \text{supp}(m)$. \end{proof} \begin{lemma} \label{lemma-weakly-ass-zero-divisors} let $r$ be a ring. let $m$ be an $r$-module. the union $\bigcup_{\mathfrak q \in \text{weakass}(m)} \mathfrak q$ is the set of elements of $r$ which are zerodivisors on $m$. \end{lemma} \begin{proof} suppose $f \in \mathfrak q \in \text{weakass}(m)$. then there exists an element $m \in m$ such that $\mathfrak q$ is minimal over $i = \{x \in r \mid xm = 0\}$. hence there exists a $g \in r$, $g \not \in \mathfrak q$ and $n > 0$ such that $f^ngm = 0$. note that $gm \not = 0$ as $g \not \in i$. if we take $n$ minimal as above, then $f (f^{n - 1}gm) = 0$ and $f^{n - 1}gm \not = 0$, so $f$ is a zerodivisor on $m$. conversely, suppose $f \in r$ is a zerodivisor on $m$. consider the submodule $n = \{m \in m \mid fm = 0\}$. since $n$ is not zero it has a weakly associated prime $\mathfrak q$ by lemma \ref{lemma-weakly-ass-zero}. clearly $f \in \mathfrak q$ and by lemma \ref{lemma-weakly-ass} $\mathfrak q$ is a weakly associated prime of $m$. \end{proof} \begin{lemma} \label{lemma-weakly-ass-minimal-prime-support} let $r$ be a ring. let $m$ be an $r$-module. any $\mathfrak p \in \text{supp}(m)$ which is minimal among the elements of $\text{supp}(m)$ is an element of $\text{weakass}(m)$. \end{lemma} \begin{proof} note that $\text{supp}(m_{\mathfrak p}) = \{\mathfrak pr_{\mathfrak p}\}$ in $\spec(r_{\mathfrak p})$. in particular $m_{\mathfrak p}$ is nonzero, and hence $\text{weakass}(m_{\mathfrak p}) \not = \emptyset$ by lemma \ref{lemma-weakly-ass-zero}. since $\text{weakass}(m_{\mathfrak p}) \subset \text{supp}(m_{\mathfrak p})$ by lemma \ref{lemma-weakly-ass-support} we conclude that $\text{weakass}(m_{\mathfrak p}) = \{\mathfrak pr_{\mathfrak p}\}$, whence $\mathfrak p \in \text{weakass}(m)$ by lemma \ref{lemma-weakly-ass-local}. \end{proof} \begin{lemma} \label{lemma-ass-weakly-ass} let $r$ be a ring. let $m$ be an $r$-module. let $\mathfrak p$ be a prime ideal of $r$ which is finitely generated. then $$ \mathfrak p \in \text{ass}(m) \leftrightarrow \mathfrak p \in \text{weakass}(m). $$ in particular, if $r$ is noetherian, then $\text{ass}(m) = \text{weakass}(m)$. \end{lemma} \begin{proof} write $\mathfrak p = (g_1, \ldots, g_n)$ for some $g_i \in r$. it is enough the prove the implication ``$\leftarrow$'' as the other implication holds in general, see lemma \ref{lemma-weakly-ass-support}. assume $\mathfrak p \in \text{weakass}(m)$. by lemma \ref{lemma-weakly-ass-local} there exists an element $m \in m_{\mathfrak p}$ such that $i = \{x \in r_{\mathfrak p} \mid xm = 0\}$ has radical $\mathfrak pr_{\mathfrak p}$. hence for each $i$ there exists a smallest $e_i > 0$ such that $g_i^{e_i}m = 0$ in $m_{\mathfrak p}$. if $e_i > 1$ for some $i$, then we can replace $m$ by $g_i^{e_i - 1} m \not = 0$ and decrease $\sum e_i$. hence we may assume that the annihilator of $m \in m_{\mathfrak p}$ is $(g_1, \ldots, g_n)r_{\mathfrak p} = \mathfrak p r_{\mathfrak p}$. by lemma \ref{lemma-associated-primes-localize} we see that $\mathfrak p \in \text{ass}(m)$. \end{proof} \begin{remark} \label{remark-weakly-ass-not-functorial} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. then it is not always the case that $\spec(\varphi)(\text{weakass}_s(m)) \subset \text{weakass}_r(m)$ contrary to the case of associated primes (see lemma \ref{lemma-ass-functorial}). an example is to consider the ring map $$ r = k[x_1, x_2, x_3, \ldots] \to s = k[x_1, x_2, x_3, \ldots, y_1, y_2, y_3, \ldots]/ (x_1y_1, x_2y_2, x_3y_3, \ldots) $$ and $m = s$. in this case $\mathfrak q = \sum x_is$ is a minimal prime of $s$, hence a weakly associated prime of $m = s$ (see lemma \ref{lemma-weakly-ass-minimal-prime-support}). but on the other hand, for any nonzero element of $s$ the annihilator in $r$ is finitely generated, and hence does not have radical equal to $r \cap \mathfrak q = (x_1, x_2, x_3, \ldots)$ (details omitted). \end{remark} \begin{lemma} \label{lemma-weakly-ass-reverse-functorial} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. then we have $\spec(\varphi)(\text{weakass}_s(m)) \supset \text{weakass}_r(m)$. \end{lemma} \begin{proof} let $\mathfrak p$ be an element of $\text{weakass}_r(m)$. then there exists an $m \in m_{\mathfrak p}$ whose annihilator $i = \{x \in r_{\mathfrak p} \mid xm = 0\}$ has radical $\mathfrak pr_{\mathfrak p}$. consider the annihilator $j = \{x \in s_{\mathfrak p} \mid xm = 0 \}$ of $m$ in $s_{\mathfrak p}$. as $is_{\mathfrak p} \subset j$ we see that any minimal prime $\mathfrak q \subset s_{\mathfrak p}$ over $j$ lies over $\mathfrak p$. moreover such a $\mathfrak q$ corresponds to a weakly associated prime of $m$ for example by lemma \ref{lemma-weakly-ass-local}. \end{proof} \begin{remark} \label{remark-ass-functorial} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. denote $f : \spec(s) \to \spec(r)$ the associated map on spectra. then we have $$ f(\text{ass}_s(m)) \subset \text{ass}_r(m) \subset \text{weakass}_r(m) \subset f(\text{weakass}_s(m)) $$ see lemmas \ref{lemma-ass-functorial}, \ref{lemma-weakly-ass-reverse-functorial}, and \ref{lemma-weakly-ass-support}. in general all of the inclusions may be strict, see remarks \ref{remark-ass-reverse-functorial} and \ref{remark-weakly-ass-not-functorial}. if $s$ is noetherian, then all the inclusions are equalities as the outer two are equal by lemma \ref{lemma-ass-weakly-ass}. \end{remark} \begin{lemma} \label{lemma-weakly-ass-finite-ring-map} let $\varphi : r \to s$ be a ring map. let $m$ be an $s$-module. denote $f : \spec(s) \to \spec(r)$ the associated map on spectra. if $\varphi$ is a finite ring map, then $$ \text{weakass}_r(m) = f(\text{weakass}_s(m)). $$ \end{lemma} \begin{proof} one of the inclusions has already been proved, see remark \ref{remark-ass-functorial}. to prove the other assume $\mathfrak q \in \text{weakass}_s(m)$ and let $\mathfrak p$ be the corresponding prime of $r$. let $m \in m$ be an element such that $\mathfrak q$ is a minimal prime over $j = \{g \in s \mid gm = 0\}$. thus the radical of $js_{\mathfrak q}$ is $\mathfrak qs_{\mathfrak q}$. as $r \to s$ is finite there are finitely many primes $\mathfrak q = \mathfrak q_1, \mathfrak q_2, \ldots, \mathfrak q_l$ over $\mathfrak p$, see lemma \ref{lemma-finite-finite-fibres}. pick $x \in \mathfrak q$ with $x \not \in \mathfrak q_i$ for $i > 1$, see lemma \ref{lemma-silly}. by the above there exists an element $y \in s$, $y \not \in \mathfrak q$ and an integer $t > 0$ such that $y x^t m = 0$. thus the element $ym \in m$ is annihilated by $x^t$, hence $ym$ maps to zero in $m_{\mathfrak q_i}$, $i = 2, \ldots, l$. to be sure, $ym$ does not map to zero in $s_{\mathfrak q}$. \medskip\noindent the ring $s_{\mathfrak p}$ is semi-local with maximal ideals $\mathfrak q_i s_{\mathfrak p}$ by going up for finite ring maps, see lemma \ref{lemma-integral-going-up}. if $f \in \mathfrak pr_{\mathfrak p}$ then some power of $f$ ends up in $js_{\mathfrak q}$ hence for some $t > 0$ we see that $f^t ym$ maps to zero in $m_{\mathfrak q}$. as $ym$ vanishes at the other maximal ideals of $s_{\mathfrak p}$ we conclude that $f^t ym$ is zero in $m_{\mathfrak p}$, see lemma \ref{lemma-characterize-zero-local}. in this way we see that $\mathfrak p$ is a minimal prime over the annihilator of $ym$ in $r$ and we win. \end{proof} \begin{lemma} \label{lemma-weakly-ass-quotient-ring} let $r$ be a ring. let $i$ be an ideal. let $m$ be an $r/i$-module. via the canonical injection $\spec(r/i) \to \spec(r)$ we have $\text{weakass}_{r/i}(m) = \text{weakass}_r(m)$. \end{lemma} \begin{proof} special case of lemma \ref{lemma-weakly-ass-finite-ring-map}. \end{proof} \begin{lemma} \label{lemma-localize-weakly-ass} let $r$ be a ring. let $m$ be an $r$-module. let $s \subset r$ be a multiplicative subset. via the canonical injection $\spec(s^{-1}r) \to \spec(r)$ we have $\text{weakass}_r(s^{-1}m) = \text{weakass}_{s^{-1}r}(s^{-1}m)$ and $$ \text{weakass}(m) \cap \spec(s^{-1}r) = \text{weakass}(s^{-1}m). $$ \end{lemma} \begin{proof} suppose that $m \in s^{-1}m$. let $i = \{x \in r \mid xm = 0\}$ and $i' = \{x' \in s^{-1}r \mid x'm = 0\}$. then $i' = s^{-1}i$ and $i \cap s = \emptyset$ unless $i = r$ (verifications omitted). thus primes in $s^{-1}r$ minimal over $i'$ correspond bijectively to primes in $r$ minimal over $i$ and avoiding $s$. this proves the equality $\text{weakass}_r(s^{-1}m) = \text{weakass}_{s^{-1}r}(s^{-1}m)$. the second equality follows from lemma \ref{lemma-weakly-ass-local} since for $\mathfrak p \in r$, $s \cap \mathfrak p = \emptyset$ we have $m_{\mathfrak p} = (s^{-1}m)_{s^{-1}\mathfrak p}$. \end{proof} \begin{lemma} \label{lemma-localize-weakly-ass-nonzero-divisors} let $r$ be a ring. let $m$ be an $r$-module. let $s \subset r$ be a multiplicative subset. assume that every $s \in s$ is a nonzerodivisor on $m$. then $$ \text{weakass}(m) = \text{weakass}(s^{-1}m). $$ \end{lemma} \begin{proof} as $m \subset s^{-1}m$ by assumption we obtain $\text{weakass}(m) \subset \text{weakass}(s^{-1}m)$ from lemma \ref{lemma-weakly-ass}. conversely, suppose that $n/s \in s^{-1}m$ is an element with annihilator $i$ and $\mathfrak p$ a prime which is minimal over $i$. then the annihilator of $n \in m$ is $i$ and $\mathfrak p$ is a prime minimal over $i$. \end{proof} \begin{lemma} \label{lemma-zero-at-weakly-ass-zero} let $r$ be a ring. let $m$ be an $r$-module. the map $$ m \longrightarrow \prod\nolimits_{\mathfrak p \in \text{weakass}(m)} m_{\mathfrak p} $$ is injective. \end{lemma} \begin{proof} let $x \in m$ be an element of the kernel of the map. set $n = rx \subset m$. if $\mathfrak p$ is a weakly associated prime of $n$ we see on the one hand that $\mathfrak p \in \text{weakass}(m)$ (lemma \ref{lemma-weakly-ass}) and on the other hand that $n_{\mathfrak p} \subset m_{\mathfrak p}$ is not zero. this contradiction shows that $\text{weakass}(n) = \emptyset$. hence $n = 0$, i.e., $x = 0$ by lemma \ref{lemma-weakly-ass-zero}. \end{proof} \begin{lemma} \label{lemma-weak-post-bourbaki} let $r \to s$ be a ring map. let $n$ be an $s$-module. assume $n$ is flat as an $r$-module and $r$ is a domain with fraction field $k$. then $$ \text{weakass}_s(n) = \text{weakass}_{s \otimes_r k}(n \otimes_r k) $$ via the canonical inclusion $\spec(s \otimes_r k) \subset \spec(s)$. \end{lemma} \begin{proof} note that $s \otimes_r k = (r \setminus \{0\})^{-1}s$ and $n \otimes_r k = (r \setminus \{0\})^{-1}n$. for any nonzero $x \in r$ multiplication by $x$ on $n$ is injective as $n$ is flat over $r$. hence the lemma follows from lemma \ref{lemma-localize-weakly-ass-nonzero-divisors}. \end{proof} \begin{lemma} \label{lemma-weakly-ass-change-fields} let $k/k$ be a field extension. let $r$ be a $k$-algebra. let $m$ be an $r$-module. let $\mathfrak q \subset r \otimes_k k$ be a prime lying over $\mathfrak p \subset r$. if $\mathfrak q$ is weakly associated to $m \otimes_k k$, then $\mathfrak p$ is weakly associated to $m$. \end{lemma} \begin{proof} let $z \in m \otimes_k k$ be an element such that $\mathfrak q$ is minimal over the annihilator $j \subset r \otimes_k k$ of $z$. choose a finitely generated subextension $k/l/k$ such that $z \in m \otimes_k l$. since $r \otimes_k l \to r \otimes_k k$ is flat we see that $j = i(r \otimes_k k)$ where $i \subset r \otimes_k l$ is the annihilator of $z$ in the smaller ring (lemma \ref{lemma-annihilator-flat-base-change}). thus $\mathfrak q \cap (r \otimes_k l)$ is minimal over $i$ by going down (lemma \ref{lemma-flat-going-down}). in this way we reduce to the case described in the next paragraph. \medskip\noindent assume $k/k$ is a finitely generated field extension. let $x_1, \ldots, x_r \in k$ be a transcendence basis of $k$ over $k$, see fields, section \ref{fields-section-transcendence}. set $l = k(x_1, \ldots, x_r)$. say $[k : l] = n$. then $r \otimes_k l \to r \otimes_k k$ is a finite ring map. hence $\mathfrak q \cap (r \otimes_k l)$ is a weakly associated prime of $m \otimes_k k$ viewed as a $r \otimes_k l$-module by lemma \ref{lemma-weakly-ass-finite-ring-map}. since $m \otimes_k k \cong (m \otimes_k l)^{\oplus n}$ as a $r \otimes_k l$-module, we see that $\mathfrak q \cap (r \otimes_k l)$ is a weakly associated prime of $m \otimes_k l$ (for example by using lemma \ref{lemma-weakly-ass} and induction). in this way we reduce to the case discussed in the next paragraph. \medskip\noindent assume $k = k(x_1, \ldots, x_r)$ is a purely transcendental field extension. we may replace $r$ by $r_\mathfrak p$, $m$ by $m_\mathfrak p$ and $\mathfrak q$ by $\mathfrak q(r_\mathfrak p \otimes_k k)$. see lemma \ref{lemma-localize-weakly-ass}. in this way we reduce to the case discussed in the next paragraph. \medskip\noindent assume $k = k(x_1, \ldots, x_r)$ is a purely transcendental field extension and $r$ is local with maximal ideal $\mathfrak p$. we claim that any $f \in r \otimes_k k$, $f \not \in \mathfrak p(r \otimes_k k)$ is a nonzerodivisor on $m \otimes_k k$. namely, let $z \in m \otimes_k k$ be an element. there is a finite $r$-submodule $m' \subset m$ such that $z \in m' \otimes_k k$ and such that $m'$ is minimal with this property: choose a basis $\{t_\alpha\}$ of $k$ as a $k$-vector space, write $z = \sum m_\alpha \otimes t_\alpha$ and let $m'$ be the $r$-submodule generated by the $m_\alpha$. if $z \in \mathfrak p(m' \otimes_k k) = \mathfrak p m' \otimes_k k$, then $\mathfrak pm' = m'$ and $m' = 0$ by lemma \ref{lemma-nak} a contradiction. thus $z$ has nonzero image $\overline{z}$ in $m'/\mathfrak p m' \otimes_k k$ but $r/\mathfrak p \otimes_k k$ is a domain as a localization of $\kappa(\mathfrak p)[x_1, \ldots, x_n]$ and $m'/\mathfrak p m' \otimes_k k$ is a free module, hence $f\overline{z} \not = 0$. this proves the claim. \medskip\noindent finally, pick $z \in m \otimes_k k$ such that $\mathfrak q$ is minimal over the annihilator $j \subset r \otimes_k k$ of $z$. for $f \in \mathfrak p$ there exists an $n \geq 1$ and a $g \in r \otimes_k k$, $g \not \in \mathfrak q$ such that $g f^n z \in j$, i.e., $g f^n z = 0$. (this holds because $\mathfrak q$ lies over $\mathfrak p$ and $\mathfrak q$ is minimal over $j$.) above we have seen that $g$ is a nonzerodivisor hence $f^n z = 0$. this means that $\mathfrak p$ is a weakly associated prime of $m \otimes_k k$ viewed as an $r$-module. since $m \otimes_k k$ is a direct sum of copies of $m$ we conclude that $\mathfrak p$ is a weakly associated prime of $m$ as before. \end{proof} \section{embedded primes} \label{section-embedded-primes} \noindent here is the definition. \begin{definition} \label{definition-embedded-primes} let $r$ be a ring. let $m$ be an $r$-module. \begin{enumerate} \item the associated primes of $m$ which are not minimal among the associated primes of $m$ are called the {\it embedded associated primes} of $m$. \item the {\it embedded primes of $r$} are the embedded associated primes of $r$ as an $r$-module. \end{enumerate} \end{definition} \noindent here is a way to get rid of these. \begin{lemma} \label{lemma-remove-embedded-primes} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. consider the set of $r$-submodules $$ \{ k \subset m \mid \text{supp}(k) \text{ nowhere dense in } \text{supp}(m) \}. $$ this set has a maximal element $k$ and the quotient $m' = m/k$ has the following properties \begin{enumerate} \item $\text{supp}(m) = \text{supp}(m')$, \item $m'$ has no embedded associated primes, \item for any $f \in r$ which is contained in all embedded associated primes of $m$ we have $m_f \cong m'_f$. \end{enumerate} \end{lemma} \begin{proof} we will use lemma \ref{lemma-finite-ass} and proposition \ref{proposition-minimal-primes-associated-primes} without further mention. let $\mathfrak q_1, \ldots, \mathfrak q_t$ denote the minimal primes in the support of $m$. let $\mathfrak p_1, \ldots, \mathfrak p_s$ denote the embedded associated primes of $m$. then $\text{ass}(m) = \{\mathfrak q_j, \mathfrak p_i\}$. let $$ k = \{m \in m \mid \text{supp}(rm) \subset \bigcup v(\mathfrak p_i)\} $$ it is immediately seen to be a submodule. since $m$ is finite over a noetherian ring, we know $k$ is finite too. hence $\text{supp}(k)$ is nowhere dense in $\text{supp}(m)$. let $k' \subset m$ be another submodule with support nowhere dense in $\text{supp}(m)$. this means that $k_{\mathfrak q_j} = 0$. hence if $m \in k'$, then $m$ maps to zero in $m_{\mathfrak q_j}$ which in turn implies $(rm)_{\mathfrak q_j} = 0$. on the other hand we have $\text{ass}(rm) \subset \text{ass}(m)$. hence the support of $rm$ is contained in $\bigcup v(\mathfrak p_i)$. therefore $m \in k$ and thus $k' \subset k$ as $m$ was arbitrary in $k'$. \medskip\noindent let $m' = m/k$. since $k_{\mathfrak q_j}=0$ we know $m'_{\mathfrak q_j} = m_{\mathfrak q_j}$ for all $j$. hence $m$ and $m'$ have the same support. \medskip\noindent suppose $\mathfrak q = \text{ann}(\overline{m}) \in \text{ass}(m')$ where $\overline{m} \in m'$ is the image of $m \in m$. then $m \not \in k$ and hence the support of $rm$ must contain one of the $\mathfrak q_j$. since $m_{\mathfrak q_j} = m'_{\mathfrak q_j}$, we know $\overline{m}$ does not map to zero in $m'_{\mathfrak q_j}$. hence $\mathfrak q \subset \mathfrak q_j$ (actually we have equality), which means that all the associated primes of $m'$ are not embedded. \medskip\noindent let $f$ be an element contained in all $\mathfrak p_i$. then $d(f) \cap \text{supp}(k) = 0$. hence $m_f = m'_f$ because $k_f = 0$. \end{proof} \begin{lemma} \label{lemma-remove-embedded-primes-localize} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. for any $f \in r$ we have $(m')_f = (m_f)'$ where $m \to m'$ and $m_f \to (m_f)'$ are the quotients constructed in lemma \ref{lemma-remove-embedded-primes}. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-no-embedded-primes-endos} let $r$ be a noetherian ring. let $m$ be a finite $r$-module without embedded associated primes. let $i = \{x \in r \mid xm = 0\}$. then the ring $r/i$ has no embedded primes. \end{lemma} \begin{proof} we may replace $r$ by $r/i$. hence we may assume every nonzero element of $r$ acts nontrivially on $m$. by lemma \ref{lemma-support-closed} this implies that $\spec(r)$ equals the support of $m$. suppose that $\mathfrak p$ is an embedded prime of $r$. let $x \in r$ be an element whose annihilator is $\mathfrak p$. consider the nonzero module $n = xm \subset m$. it is annihilated by $\mathfrak p$. hence any associated prime $\mathfrak q$ of $n$ contains $\mathfrak p$ and is also an associated prime of $m$. then $\mathfrak q$ would be an embedded associated prime of $m$ which contradicts the assumption of the lemma. \end{proof} \section{regular sequences} \label{section-regular-sequences} \noindent in this section we develop some basic properties of regular sequences. \begin{definition} \label{definition-regular-sequence} let $r$ be a ring. let $m$ be an $r$-module. a sequence of elements $f_1, \ldots, f_r$ of $r$ is called an {\it $m$-regular sequence} if the following conditions hold: \begin{enumerate} \item $f_i$ is a nonzerodivisor on $m/(f_1, \ldots, f_{i - 1})m$ for each $i = 1, \ldots, r$, and \item the module $m/(f_1, \ldots, f_r)m$ is not zero. \end{enumerate} if $i$ is an ideal of $r$ and $f_1, \ldots, f_r \in i$ then we call $f_1, \ldots, f_r$ an {\it $m$-regular sequence in $i$}. if $m = r$, we call $f_1, \ldots, f_r$ simply a {\it regular sequence} (in $i$). \end{definition} \noindent please pay attention to the fact that the definition depends on the order of the elements $f_1, \ldots, f_r$ (see examples below). some papers/books drop the requirement that the module $m/(f_1, \ldots, f_r)m$ is nonzero. this has the advantage that being a regular sequence is preserved under localization. however, we will use this definition mainly to define the depth of a module in case $r$ is local; in that case the $f_i$ are required to be in the maximal ideal -- a condition which is not preserved under going from $r$ to a localization $r_\mathfrak p$. \begin{example} \label{example-global-regular} let $k$ be a field. in the ring $k[x, y, z]$ the sequence $x, y(1-x), z(1-x)$ is regular but the sequence $y(1-x), z(1-x), x$ is not. \end{example} \begin{example} \label{example-local-regular} let $k$ be a field. consider the ring $k[x, y, w_0, w_1, w_2, \ldots]/i$ where $i$ is generated by $yw_i$, $i = 0, 1, 2, \ldots$ and $w_i - xw_{i + 1}$, $i = 0, 1, 2, \ldots$. the sequence $x, y$ is regular, but $y$ is a zerodivisor. moreover you can localize at the maximal ideal $(x, y, w_i)$ and still get an example. \end{example} \begin{lemma} \label{lemma-permute-xi} let $r$ be a local noetherian ring. let $m$ be a finite $r$-module. let $x_1, \ldots, x_c$ be an $m$-regular sequence. then any permutation of the $x_i$ is a regular sequence as well. \end{lemma} \begin{proof} first we do the case $c = 2$. consider $k \subset m$ the kernel of $x_2 : m \to m$. for any $z \in k$ we know that $z = x_1 z'$ for some $z' \in m$ because $x_2$ is a nonzerodivisor on $m/x_1m$. because $x_1$ is a nonzerodivisor on $m$ we see that $x_2 z' = 0$ as well. hence $x_1 : k \to k$ is surjective. thus $k = 0$ by nakayama's lemma \ref{lemma-nak}. next, consider multiplication by $x_1$ on $m/x_2m$. if $z \in m$ maps to an element $\overline{z} \in m/x_2m$ in the kernel of this map, then $x_1 z = x_2 y$ for some $y \in m$. but then since $x_1, x_2$ is a regular sequence we see that $y = x_1 y'$ for some $y' \in m$. hence $x_1 ( z - x_2 y' ) =0$ and hence $z = x_2 y'$ and hence $\overline{z} = 0$ as desired. \medskip\noindent for the general case, observe that any permutation is a composition of transpositions of adjacent indices. hence it suffices to prove that $$ x_1, \ldots, x_{i-2}, x_i, x_{i-1}, x_{i + 1}, \ldots, x_c $$ is an $m$-regular sequence. this follows from the case we just did applied to the module $m/(x_1, \ldots, x_{i-2})$ and the length $2$ regular sequence $x_{i-1}, x_i$. \end{proof} \begin{lemma} \label{lemma-flat-increases-depth} \begin{slogan} flat local ring homomorphisms preserve and reflect regular sequences. \end{slogan} let $r, s$ be local rings. let $r \to s$ be a flat local ring homomorphism. let $x_1, \ldots, x_r$ be a sequence in $r$. let $m$ be an $r$-module. the following are equivalent \begin{enumerate} \item $x_1, \ldots, x_r$ is an $m$-regular sequence in $r$, and \item the images of $x_1, \ldots, x_r$ in $s$ form a $m \otimes_r s$-regular sequence. \end{enumerate} \end{lemma} \begin{proof} this is so because $r \to s$ is faithfully flat by lemma \ref{lemma-local-flat-ff}. \end{proof} \begin{lemma} \label{lemma-regular-sequence-in-neighbourhood} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. let $\mathfrak p$ be a prime. let $x_1, \ldots, x_r$ be a sequence in $r$ whose image in $r_{\mathfrak p}$ forms an $m_{\mathfrak p}$-regular sequence. then there exists a $g \in r$, $g \not \in \mathfrak p$ such that the image of $x_1, \ldots, x_r$ in $r_g$ forms an $m_g$-regular sequence. \end{lemma} \begin{proof} set $$ k_i = \ker\left(x_i : m/(x_1, \ldots, x_{i - 1})m \to m/(x_1, \ldots, x_{i - 1})m\right). $$ this is a finite $r$-module whose localization at $\mathfrak p$ is zero by assumption. hence there exists a $g \in r$, $g \not \in \mathfrak p$ such that $(k_i)_g = 0$ for all $i = 1, \ldots, r$. this $g$ works. \end{proof} \begin{lemma} \label{lemma-join-regular-sequences} let $a$ be a ring. let $i$ be an ideal generated by a regular sequence $f_1, \ldots, f_n$ in $a$. let $g_1, \ldots, g_m \in a$ be elements whose images $\overline{g}_1, \ldots, \overline{g}_m$ form a regular sequence in $a/i$. then $f_1, \ldots, f_n, g_1, \ldots, g_m$ is a regular sequence in $a$. \end{lemma} \begin{proof} this follows immediately from the definitions. \end{proof} \begin{lemma} \label{lemma-regular-sequence-short-exact-sequence} let $r$ be a ring. let $0 \to m_1 \to m_2 \to m_3 \to 0$ be a short exact sequence of $r$-modules. let $f_1, \ldots, f_r \in r$. if $f_1, \ldots, f_r$ is $m_1$-regular and $m_3$-regular, then $f_1, \ldots, f_r$ is $m_2$-regular. \end{lemma} \begin{proof} by lemma \ref{lemma-snake}, if $f_1 : m_1 \to m_1$ and $f_1 : m_3 \to m_3$ are injective, then so is $f_1 : m_2 \to m_2$ and we obtain a short exact sequence $$ 0 \to m_1/f_1m_1 \to m_2/f_1m_2 \to m_3/f_1m_3 \to 0 $$ the lemma follows from this and induction on $r$. some details omitted. \end{proof} \begin{lemma} \label{lemma-regular-sequence-powers} let $r$ be a ring. let $m$ be an $r$-module. let $f_1, \ldots, f_r \in r$ and $e_1, \ldots, e_r > 0$ integers. then $f_1, \ldots, f_r$ is an $m$-regular sequence if and only if $f_1^{e_1}, \ldots, f_r^{e_r}$ is an $m$-regular sequence. \end{lemma} \begin{proof} we will prove this by induction on $r$. if $r = 1$ this follows from the following two easy facts: (a) a power of a nonzerodivisor on $m$ is a nonzerodivisor on $m$ and (b) a divisor of a nonzerodivisor on $m$ is a nonzerodivisor on $m$. if $r > 1$, then by induction applied to $m/f_1m$ we have that $f_1, f_2, \ldots, f_r$ is an $m$-regular sequence if and only if $f_1, f_2^{e_2}, \ldots, f_r^{e_r}$ is an $m$-regular sequence. thus it suffices to show, given $e > 0$, that $f_1^e, f_2, \ldots, f_r$ is an $m$-regular sequence if and only if $f_1, \ldots, f_r$ is an $m$-regular sequence. we will prove this by induction on $e$. the case $e = 1$ is trivial. since $f_1$ is a nonzerodivisor under both assumptions (by the case $r = 1$) we have a short exact sequence $$ 0 \to m/f_1m \xrightarrow{f_1^{e - 1}} m/f_1^em \to m/f_1^{e - 1}m \to 0 $$ suppose that $f_1, f_2, \ldots, f_r$ is an $m$-regular sequence. then by induction the elements $f_2, \ldots, f_r$ are $m/f_1m$ and $m/f_1^{e - 1}m$-regular sequences. by lemma \ref{lemma-regular-sequence-short-exact-sequence} $f_2, \ldots, f_r$ is $m/f_1^em$-regular. hence $f_1^e, f_2, \ldots, f_r$ is $m$-regular. conversely, suppose that $f_1^e, f_2, \ldots, f_r$ is an $m$-regular sequence. then $f_2 : m/f_1^em \to m/f_1^em$ is injective, hence $f_2 : m/f_1m \to m/f_1m$ is injective, hence by induction(!) $f_2 : m/f_1^{e - 1}m \to m/f_1^{e - 1}m$ is injective, hence $$ 0 \to m/(f_1, f_2)m \xrightarrow{f_1^{e - 1}} m/(f_1^e, f_2)m \to m/(f_1^{e - 1}, f_2)m \to 0 $$ is a short exact sequence by lemma \ref{lemma-snake}. this proves the converse for $r = 2$. if $r > 2$, then we have $f_3 : m/(f_1^e, f_2)m \to m/(f_1^e, f_2)m$ is injective, hence $f_3 : m/(f_1, f_2)m \to m/(f_1, f_2)m$ is injective, and so on. some details omitted. \end{proof} \begin{lemma} \label{lemma-regular-sequence-in-polynomial-ring} let $r$ be a ring. let $f_1, \ldots, f_r \in r$ which do not generate the unit ideal. the following are equivalent: \begin{enumerate} \item any permutation of $f_1, \ldots, f_r$ is a regular sequence, \item any subsequence of $f_1, \ldots, f_r$ (in the given order) is a regular sequence, and \item $f_1x_1, \ldots, f_rx_r$ is a regular sequence in the polynomial ring $r[x_1, \ldots, x_r]$. \end{enumerate} \end{lemma} \begin{proof} it is clear that (1) implies (2). we prove (2) implies (1) by induction on $r$. the case $r = 1$ is trivial. the case $r = 2$ says that if $a, b \in r$ are a regular sequence and $b$ is a nonzerodivisor, then $b, a$ is a regular sequence. this is clear because the kernel of $a : r/(b) \to r/(b)$ is isomorphic to the kernel of $b : r/(a) \to r/(a)$ if both $a$ and $b$ are nonzerodivisors. the case $r > 2$. assume (2) holds and say we want to prove $f_{\sigma(1)}, \ldots, f_{\sigma(r)}$ is a regular sequence for some permutation $\sigma$. we already know that $f_{\sigma(1)}, \ldots, f_{\sigma(r - 1)}$ is a regular sequence by induction. hence it suffices to show that $f_s$ where $s = \sigma(r)$ is a nonzerodivisor modulo $f_1, \ldots, \hat f_s, \ldots, f_r$. if $s = r$ we are done. if $s < r$, then note that $f_s$ and $f_r$ are both nonzerodivisors in the ring $r/(f_1, \ldots, \hat f_s, \ldots, f_{r - 1})$ (by induction hypothesis again). since we know $f_s, f_r$ is a regular sequence in that ring we conclude by the case of sequence of length $2$ that $f_r, f_s$ is too. \medskip\noindent note that $r[x_1, \ldots, x_r]/(f_1x_1, \ldots, f_ix_i)$ as an $r$-module is a direct sum of the modules $$ r/i_e \cdot x_1^{e_1} \ldots x_r^{e_r} $$ indexed by multi-indices $e = (e_1, \ldots, e_r)$ where $i_e$ is the ideal generated by $f_j$ for $1 \leq j \leq i$ with $e_j > 0$. hence $f_{i + 1}x_i$ is a nonzerodivisor on this if and only if $f_{i + 1}$ is a nonzerodivisor on $r/i_e$ for all $e$. taking $e$ with all positive entries, we see that $f_{i + 1}$ is a nonzerodivisor on $r/(f_1, \ldots, f_i)$. thus (3) implies (2). conversely, if (2) holds, then any subsequence of $f_1, \ldots, f_i, f_{i + 1}$ is a regular sequence in particular $f_{i + 1}$ is a nonzerodivisor on all $r/i_e$. in this way we see that (2) implies (3). \end{proof} \section{quasi-regular sequences} \label{section-quasi-regular} \noindent we introduce the notion of quasi-regular sequence which is slightly weaker than that of a regular sequence and easier to use. let $r$ be a ring and let $f_1, \ldots, f_c \in r$. set $j = (f_1, \ldots, f_c)$. let $m$ be an $r$-module. then there is a canonical map \begin{equation} \label{equation-quasi-regular} m/jm \otimes_{r/j} r/j[x_1, \ldots, x_c] \longrightarrow \bigoplus\nolimits_{n \geq 0} j^nm/j^{n + 1}m \end{equation} of graded $r/j[x_1, \ldots, x_c]$-modules defined by the rule $$ \overline{m} \otimes x_1^{e_1} \ldots x_c^{e_c} \longmapsto f_1^{e_1} \ldots f_c^{e_c} m \bmod j^{e_1 + \ldots + e_c + 1}m. $$ note that (\ref{equation-quasi-regular}) is always surjective. \begin{definition} \label{definition-quasi-regular-sequence} let $r$ be a ring. let $m$ be an $r$-module. a sequence of elements $f_1, \ldots, f_c$ of $r$ is called {\it $m$-quasi-regular} if (\ref{equation-quasi-regular}) is an isomorphism. if $m = r$, we call $f_1, \ldots, f_c$ simply a {\it quasi-regular sequence}. \end{definition} \noindent so if $f_1, \ldots, f_c$ is a quasi-regular sequence, then $$ r/j[x_1, \ldots, x_c] = \bigoplus\nolimits_{n \geq 0} j^n/j^{n + 1} $$ where $j = (f_1, \ldots, f_c)$. it is clear that being a quasi-regular sequence is independent of the order of $f_1, \ldots, f_c$. \begin{lemma} \label{lemma-regular-quasi-regular} let $r$ be a ring. \begin{enumerate} \item a regular sequence $f_1, \ldots, f_c$ of $r$ is a quasi-regular sequence. \item suppose that $m$ is an $r$-module and that $f_1, \ldots, f_c$ is an $m$-regular sequence. then $f_1, \ldots, f_c$ is an $m$-quasi-regular sequence. \end{enumerate} \end{lemma} \begin{proof} set $j = (f_1, \ldots, f_c)$. we prove the first assertion by induction on $c$. we have to show that given any relation $\sum_{|i| = n} a_i f^i \in j^{n + 1}$ with $a_i \in r$ we actually have $a_i \in j$ for all multi-indices $i$. since any element of $j^{n + 1}$ is of the form $\sum_{|i| = n} b_i f^i$ with $b_i \in j$ we may assume, after replacing $a_i$ by $a_i - b_i$, the relation reads $\sum_{|i| = n} a_i f^i = 0$. we can rewrite this as $$ \sum\nolimits_{e = 0}^n \left( \sum\nolimits_{|i'| = n - e} a_{i', e} f^{i'} \right) f_c^e = 0 $$ here and below the ``primed'' multi-indices $i'$ are required to be of the form $i' = (i_1, \ldots, i_{c - 1}, 0)$. we will show by induction on $l \in \{0, \ldots, n\}$ that if we have a relation $$ \sum\nolimits_{e = 0}^l \left( \sum\nolimits_{|i'| = n - e} a_{i', e} f^{i'} \right) f_c^e = 0 $$ then $a_{i', e} \in j$ for all $i', e$. namely, set $j' = (f_1, \ldots, f_{c-1})$. observe that $\sum\nolimits_{|i'| = n - l} a_{i', l} f^{i'}$ is mapped into $(j')^{n - l + 1}$ by $f_c^{l}$. by induction hypothesis (for the induction on $c$) we see that $f_c^l a_{i', l} \in j'$. because $f_c$ is not a zerodivisor on $r/j'$ (as $f_1, \ldots, f_c$ is a regular sequence) we conclude that $a_{i', l} \in j'$. this allows us to rewrite the term $(\sum\nolimits_{|i'| = n - l} a_{i', l} f^{i'})f_c^l$ in the form $(\sum\nolimits_{|i'| = n - l + 1} f_c b_{i', l - 1} f^{i'})f_c^{l-1}$. this gives a new relation of the form $$ \left(\sum\nolimits_{|i'| = n - l + 1} (a_{i', l-1} + f_c b_{i', l - 1}) f^{i'}\right)f_c^{l-1} + \sum\nolimits_{e = 0}^{l - 2} \left( \sum\nolimits_{|i'| = n - e} a_{i', e} f^{i'} \right) f_c^e = 0 $$ now by the induction hypothesis (on $l$ this time) we see that all $a_{i', l-1} + f_c b_{i', l - 1} \in j$ and all $a_{i', e} \in j$ for $e \leq l - 2$. this, combined with $a_{i', l} \in j' \subset j$ seen above, finishes the proof of the induction step. \medskip\noindent the second assertion means that given any formal expression $f = \sum_{|i| = n} m_i x^i$, $m_i \in m$ with $\sum m_i f^i \in j^{n + 1}m$, then all the coefficients $m_i$ are in $j$. this is proved in exactly the same way as we prove the corresponding result for the first assertion above. \end{proof} \begin{lemma} \label{lemma-flat-base-change-quasi-regular} let $r \to r'$ be a flat ring map. let $m$ be an $r$-module. suppose that $f_1, \ldots, f_r \in r$ form an $m$-quasi-regular sequence. then the images of $f_1, \ldots, f_r$ in $r'$ form a $m \otimes_r r'$-quasi-regular sequence. \end{lemma} \begin{proof} set $j = (f_1, \ldots, f_r)$, $j' = jr'$ and $m' = m \otimes_r r'$. we have to show the canonical map $\mu : r'/j'[x_1, \ldots x_r] \otimes_{r'/j'} m'/j'm' \to \bigoplus (j')^nm'/(j')^{n + 1}m'$ is an isomorphism. because $r \to r'$ is flat the sequences $0 \to j^nm \to m$ and $0 \to j^{n + 1}m \to j^nm \to j^nm/j^{n + 1}m \to 0$ remain exact on tensoring with $r'$. this first implies that $j^nm \otimes_r r' = (j')^nm'$ and then that $(j')^nm'/(j')^{n + 1}m' = j^nm/j^{n + 1}m \otimes_r r'$. thus $\mu$ is the tensor product of (\ref{equation-quasi-regular}), which is an isomorphism by assumption, with $\text{id}_{r'}$ and we conclude. \end{proof} \begin{lemma} \label{lemma-quasi-regular-sequence-in-neighbourhood} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. let $\mathfrak p$ be a prime. let $x_1, \ldots, x_c$ be a sequence in $r$ whose image in $r_{\mathfrak p}$ forms an $m_{\mathfrak p}$-quasi-regular sequence. then there exists a $g \in r$, $g \not \in \mathfrak p$ such that the image of $x_1, \ldots, x_c$ in $r_g$ forms an $m_g$-quasi-regular sequence. \end{lemma} \begin{proof} consider the kernel $k$ of the map (\ref{equation-quasi-regular}). as $m/jm \otimes_{r/j} r/j[x_1, \ldots, x_c]$ is a finite $r/j[x_1, \ldots, x_c]$-module and as $r/j[x_1, \ldots, x_c]$ is noetherian, we see that $k$ is also a finite $r/j[x_1, \ldots, x_c]$-module. pick homogeneous generators $k_1, \ldots, k_t \in k$. by assumption for each $i = 1, \ldots, t$ there exists a $g_i \in r$, $g_i \not \in \mathfrak p$ such that $g_i k_i = 0$. hence $g = g_1 \ldots g_t$ works. \end{proof} \begin{lemma} \label{lemma-truncate-quasi-regular} let $r$ be a ring. let $m$ be an $r$-module. let $f_1, \ldots, f_c \in r$ be an $m$-quasi-regular sequence. for any $i$ the sequence $\overline{f}_{i + 1}, \ldots, \overline{f}_c$ of $\overline{r} = r/(f_1, \ldots, f_i)$ is an $\overline{m} = m/(f_1, \ldots, f_i)m$-quasi-regular sequence. \end{lemma} \begin{proof} it suffices to prove this for $i = 1$. set $\overline{j} = (\overline{f}_2, \ldots, \overline{f}_c) \subset \overline{r}$. then \begin{align*} \overline{j}^n\overline{m}/\overline{j}^{n + 1}\overline{m} & = (j^nm + f_1m)/(j^{n + 1}m + f_1m) \\ & = j^nm / (j^{n + 1}m + j^nm \cap f_1m). \end{align*} thus, in order to prove the lemma it suffices to show that $j^{n + 1}m + j^nm \cap f_1m = j^{n + 1}m + f_1j^{n - 1}m$ because that will show that $\bigoplus_{n \geq 0} \overline{j}^n\overline{m}/\overline{j}^{n + 1}\overline{m}$ is the quotient of $\bigoplus_{n \geq 0} j^nm/j^{n + 1}m \cong m/jm[x_1, \ldots, x_c]$ by $x_1$. actually, we have $j^nm \cap f_1m = f_1j^{n - 1}m$. namely, if $m \not \in j^{n - 1}m$, then $f_1m \not \in j^nm$ because $\bigoplus j^nm/j^{n + 1}m$ is the polynomial algebra $m/j[x_1, \ldots, x_c]$ by assumption. \end{proof} \begin{lemma} \label{lemma-quasi-regular-regular} let $(r, \mathfrak m)$ be a local noetherian ring. let $m$ be a nonzero finite $r$-module. let $f_1, \ldots, f_c \in \mathfrak m$ be an $m$-quasi-regular sequence. then $f_1, \ldots, f_c$ is an $m$-regular sequence. \end{lemma} \begin{proof} set $j = (f_1, \ldots, f_c)$. let us show that $f_1$ is a nonzerodivisor on $m$. suppose $x \in m$ is not zero. by krull's intersection theorem there exists an integer $r$ such that $x \in j^rm$ but $x \not \in j^{r + 1}m$, see lemma \ref{lemma-intersect-powers-ideal-module-zero}. then $f_1 x \in j^{r + 1}m$ is an element whose class in $j^{r + 1}m/j^{r + 2}m$ is nonzero by the assumed structure of $\bigoplus j^nm/j^{n + 1}m$. whence $f_1x \not = 0$. \medskip\noindent now we can finish the proof by induction on $c$ using lemma \ref{lemma-truncate-quasi-regular}. \end{proof} \begin{remark}[other types of regular sequences] \label{remark-koszul-regular} in the paper \cite{kabele} the author discusses two more regularity conditions for sequences $x_1, \ldots, x_r$ of elements of a ring $r$. namely, we say the sequence is {\it koszul-regular} if $h_i(k_{\bullet}(r, x_{\bullet})) = 0$ for $i \geq 1$ where $k_{\bullet}(r, x_{\bullet})$ is the koszul complex. the sequence is called {\it $h_1$-regular} if $h_1(k_{\bullet}(r, x_{\bullet})) = 0$. one has the implications regular $\rightarrow$ koszul-regular $\rightarrow$ $h_1$-regular $\rightarrow$ quasi-regular. by examples the author shows that these implications cannot be reversed in general even if $r$ is a (non-noetherian) local ring and the sequence generates the maximal ideal of $r$. we introduce these notions in more detail in more on algebra, section \ref{more-algebra-section-koszul-regular}. \end{remark} \begin{remark} \label{remark-join-quasi-regular-sequences} let $k$ be a field. consider the ring $$ a = k[x, y, w, z_0, z_1, z_2, \ldots]/ (y^2z_0 - wx, z_0 - yz_1, z_1 - yz_2, \ldots) $$ in this ring $x$ is a nonzerodivisor and the image of $y$ in $a/xa$ gives a quasi-regular sequence. but it is not true that $x, y$ is a quasi-regular sequence in $a$ because $(x, y)/(x, y)^2$ isn't free of rank two over $a/(x, y)$ due to the fact that $wx = 0$ in $(x, y)/(x, y)^2$ but $w$ isn't zero in $a/(x, y)$. hence the analogue of lemma \ref{lemma-join-regular-sequences} does not hold for quasi-regular sequences. \end{remark} \begin{lemma} \label{lemma-quasi-regular-on-quotient} let $r$ be a ring. let $j = (f_1, \ldots, f_r)$ be an ideal of $r$. let $m$ be an $r$-module. set $\overline{r} = r/\bigcap_{n \geq 0} j^n$, $\overline{m} = m/\bigcap_{n \geq 0} j^nm$, and denote $\overline{f}_i$ the image of $f_i$ in $\overline{r}$. then $f_1, \ldots, f_r$ is $m$-quasi-regular if and only if $\overline{f}_1, \ldots, \overline{f}_r$ is $\overline{m}$-quasi-regular. \end{lemma} \begin{proof} this is true because $j^nm/j^{n + 1}m \cong \overline{j}^n\overline{m}/\overline{j}^{n + 1}\overline{m}$. \end{proof} \section{blow up algebras} \label{section-blow-up} \noindent in this section we make some elementary observations about blowing up. \begin{definition} \label{definition-blow-up} let $r$ be a ring. let $i \subset r$ be an ideal. \begin{enumerate} \item the {\it blowup algebra}, or the {\it rees algebra}, associated to the pair $(r, i)$ is the graded $r$-algebra $$ \text{bl}_i(r) = \bigoplus\nolimits_{n \geq 0} i^n = r \oplus i \oplus i^2 \oplus \ldots $$ where the summand $i^n$ is placed in degree $n$. \item let $a \in i$ be an element. denote $a^{(1)}$ the element $a$ seen as an element of degree $1$ in the rees algebra. then the {\it affine blowup algebra} $r[\frac{i}{a}]$ is the algebra $(\text{bl}_i(r))_{(a^{(1)})}$ constructed in section \ref{section-proj}. \end{enumerate} \end{definition} \noindent in other words, an element of $r[\frac{i}{a}]$ is represented by an expression of the form $x/a^n$ with $x \in i^n$. two representatives $x/a^n$ and $y/a^m$ define the same element if and only if $a^k(a^mx - a^ny) = 0$ for some $k \geq 0$. \begin{lemma} \label{lemma-affine-blowup} let $r$ be a ring, $i \subset r$ an ideal, and $a \in i$. let $r' = r[\frac{i}{a}]$ be the affine blowup algebra. then \begin{enumerate} \item the image of $a$ in $r'$ is a nonzerodivisor, \item $ir' = ar'$, and \item $(r')_a = r_a$. \end{enumerate} \end{lemma} \begin{proof} immediate from the description of $r[\frac{i}{a}]$ above. \end{proof} \begin{lemma} \label{lemma-blowup-base-change} let $r \to s$ be a ring map. let $i \subset r$ be an ideal and $a \in i$. set $j = is$ and let $b \in j$ be the image of $a$. then $s[\frac{j}{b}]$ is the quotient of $s \otimes_r r[\frac{i}{a}]$ by the ideal of elements annihilated by some power of $b$. \end{lemma} \begin{proof} let $s'$ be the quotient of $s \otimes_r r[\frac{i}{a}]$ by its $b$-power torsion elements. the ring map $$ s \otimes_r r[\textstyle{\frac{i}{a}}] \longrightarrow s[\textstyle{\frac{j}{b}}] $$ is surjective and annihilates $a$-power torsion as $b$ is a nonzerodivisor in $s[\frac{j}{b}]$. hence we obtain a surjective map $s' \to s[\frac{j}{b}]$. to see that the kernel is trivial, we construct an inverse map. namely, let $z = y/b^n$ be an element of $s[\frac{j}{b}]$, i.e., $y \in j^n$. write $y = \sum x_is_i$ with $x_i \in i^n$ and $s_i \in s$. we map $z$ to the class of $\sum s_i \otimes x_i/a^n$ in $s'$. this is well defined because an element of the kernel of the map $s \otimes_r i^n \to j^n$ is annihilated by $a^n$, hence maps to zero in $s'$. \end{proof} \begin{example} \label{example-rees-algebra-polynomial} let $r$ be a ring. let $p = r[t_1, \ldots, t_n]$ be the polynomial algebra. let $i = (t_1, \ldots, t_n) \subset p$. with notation as in definition \ref{definition-blow-up} there is an isomorphism $$ p[t_1, \ldots, t_n]/(t_it_j - t_jt_i) \longrightarrow \text{bl}_i(p) $$ sending $t_i$ to $t_i^{(1)}$. we leave it to the reader to show that this map is well defined. since $i$ is generated by $t_1, \ldots, t_n$ we see that our map is surjective. to see that our map is injective one has to show: for each $e \geq 1$ the $p$-module $i^e$ is generated by the monomials $t^e = t_1^{e_1} \ldots x_n^{e_n}$ for multiindices $e = (e_1, \ldots, e_n)$ of degree $|e| = e$ subject only to the relations $t_i t^e = t_j t^{e'}$ when $|e| = |e'| = e$ and $e_a + \delta_{a i} = e'_a + \delta_{a j},\ a = 1, \ldots, n$ (kronecker delta). we omit the details. \end{example} \begin{example} \label{example-affine-blowup-algebra-polynomial} let $r$ be a ring. let $p = r[t_1, \ldots, t_n]$ be the polynomial algebra. let $i = (t_1, \ldots, t_n) \subset p$. let $a = t_1$. with notation as in definition \ref{definition-blow-up} there is an isomorphism $$ p[x_2, \ldots, x_n]/(t_1x_2 - t_2, \ldots, t_1x_n - t_n) \longrightarrow \textstyle{p[\frac{i}{a}] = p[\frac{i}{t_1}]} $$ sending $x_i$ to $t_i/t_1$. we leave it to the reader to show that this map is well defined. since $i$ is generated by $t_1, \ldots, t_n$ we see that our map is surjective. to see that our map is injective, the reader can argue that the source and target of our map are $t_1$-torsion free and that the map is an isomorphism after inverting $t_1$, see lemma \ref{lemma-affine-blowup}. alternatively, the reader can use the description of the rees algebra in example \ref{example-rees-algebra-polynomial}. we omit the details. \end{example} \begin{lemma} \label{lemma-affine-blowup-quotient-description} let $r$ be a ring. let $i = (a_1, \ldots, a_n)$ be an ideal of $r$. let $a = a_1$. then there is a surjection $$ r[x_2, \ldots, x_n]/(a x_2 - a_2, \ldots, a x_n - a_n) \longrightarrow \textstyle{r[\frac{i}{a}]} $$ whose kernel is the $a$-power torsion in the source. \end{lemma} \begin{proof} consider the ring map $p = \mathbf{z}[t_1, \ldots, t_n] \to r$ sending $t_i$ to $a_i$. set $j = (t_1, \ldots, t_n)$. by example \ref{example-affine-blowup-algebra-polynomial} we have $p[\frac{j}{t_1}] = p[x_2, \ldots, x_n]/(t_1 x_2 - t_2, \ldots, t_1 x_n - t_n)$. apply lemma \ref{lemma-blowup-base-change} to the map $p \to a$ to conclude. \end{proof} \begin{lemma} \label{lemma-blowup-in-principal} let $r$ be a ring, $i \subset r$ an ideal, and $a \in i$. set $r' = r[\frac{i}{a}]$. if $f \in r$ is such that $v(f) = v(i)$, then $f$ maps to a nonzerodivisor in $r'$ and $r'_f = r'_a = r_a$. \end{lemma} \begin{proof} we will use the results of lemma \ref{lemma-affine-blowup} without further mention. the assumption $v(f) = v(i)$ implies $v(fr') = v(ir') = v(ar')$. hence $a^n = fb$ and $f^m = ac$ for some $b, c \in r'$. the lemma follows. \end{proof} \begin{lemma} \label{lemma-blowup-add-principal} let $r$ be a ring, $i \subset r$ an ideal, $a \in i$, and $f \in r$. set $r' = r[\frac{i}{a}]$ and $r'' = r[\frac{fi}{fa}]$. then there is a surjective $r$-algebra map $r' \to r''$ whose kernel is the set of $f$-power torsion elements of $r'$. \end{lemma} \begin{proof} the map is given by sending $x/a^n$ for $x \in i^n$ to $f^nx/(fa)^n$. it is straightforward to check this map is well defined and surjective. since $af$ is a nonzero divisor in $r''$ (lemma \ref{lemma-affine-blowup}) we see that the set of $f$-power torsion elements are mapped to zero. conversely, if $x \in r'$ and $f^n x \not = 0$ for all $n > 0$, then $(af)^n x \not = 0$ for all $n$ as $a$ is a nonzero divisor in $r'$. it follows that the image of $x$ in $r''$ is not zero by the description of $r''$ following definition \ref{definition-blow-up}. \end{proof} \begin{lemma} \label{lemma-blowup-reduced} \begin{slogan} being reduced is invariant under blowup \end{slogan} if $r$ is reduced then every (affine) blowup algebra of $r$ is reduced. \end{lemma} \begin{proof} let $i \subset r$ be an ideal and $a \in i$. suppose $x/a^n$ with $x \in i^n$ is a nilpotent element of $r[\frac{i}{a}]$. then $(x/a^n)^m = 0$. hence $a^n x^m = 0$ in $r$ for some $n \geq 0$. after increasing $n$ if necessary we may assume $n = me$ for some $e \geq 0$. then $(a^e x)^m = 0$ and since $r$ is reduced we find $a^e x = 0$. this means that $x/a^n = 0$ in $r[\frac{i}{a}]$. \end{proof} \begin{lemma} \label{lemma-blowup-domain} let $r$ be a domain, $i \subset r$ an ideal, and $a \in i$ a nonzero element. then the affine blowup algebra $r[\frac{i}{a}]$ is a domain. \end{lemma} \begin{proof} suppose $x/a^n$, $y/a^m$ with $x \in i^n$, $y \in i^m$ are elements of $r[\frac{i}{a}]$ whose product is zero. then $a^n x y = 0$ in $r$. since $r$ is a domain we conclude that either $x = 0$ or $y = 0$. \end{proof} \begin{lemma} \label{lemma-blowup-dominant} let $r$ be a ring. let $i \subset r$ be an ideal. let $a \in i$. if $a$ is not contained in any minimal prime of $r$, then $\spec(r[\frac{i}{a}]) \to \spec(r)$ has dense image. \end{lemma} \begin{proof} if $a^k x = 0$ for $x \in r$, then $x$ is contained in all the minimal primes of $r$ and hence nilpotent, see lemma \ref{lemma-zariski-topology}. thus the kernel of $r \to r[\frac{i}{a}]$ consists of nilpotent elements. hence the result follows from lemma \ref{lemma-image-dense-generic-points}. \end{proof} \begin{lemma} \label{lemma-valuation-ring-colimit-affine-blowups} let $(r, \mathfrak m)$ be a local domain with fraction field $k$. let $r \subset a \subset k$ be a valuation ring which dominates $r$. then $$ a = \colim r[\textstyle{\frac{i}{a}}] $$ is a directed colimit of affine blowups $r \to r[\frac{i}{a}]$ with the following properties \begin{enumerate} \item $a \in i \subset \mathfrak m$, \item $i$ is finitely generated, and \item the fibre ring of $r \to r[\frac{i}{a}]$ at $\mathfrak m$ is not zero. \end{enumerate} \end{lemma} \begin{proof} any blowup algebra $r[\frac{i}{a}]$ is a domain contained in $k$ see lemma \ref{lemma-blowup-domain}. the lemma simply says that $a$ is the directed union of the ones where $a \in i$ have properties (1), (2), (3). if $r[\frac{i}{a}] \subset a$ and $r[\frac{j}{b}] \subset a$, then we have $$ r[\textstyle{\frac{i}{a}}] \cup r[\textstyle{\frac{j}{b}}] \subset r[\textstyle{\frac{ij}{ab}}] \subset a $$ the first inclusion because $x/a^n = b^nx/(ab)^n$ and the second one because if $z \in (ij)^n$, then $z = \sum x_iy_i$ with $x_i \in i^n$ and $y_i \in j^n$ and hence $z/(ab)^n = \sum (x_i/a^n)(y_i/b^n)$ is contained in $a$. \medskip\noindent consider a finite subset $e \subset a$. say $e = \{e_1, \ldots, e_n\}$. choose a nonzero $a \in r$ such that we can write $e_i = f_i/a$ for all $i = 1, \ldots, n$. set $i = (f_1, \ldots, f_n, a)$. we claim that $r[\frac{i}{a}] \subset a$. this is clear as an element of $r[\frac{i}{a}]$ can be represented as a polynomial in the elements $e_i$. the lemma follows immediately from this observation. \end{proof} \section{ext groups} \label{section-ext} \noindent in this section we do a tiny bit of homological algebra, in order to establish some fundamental properties of depth over noetherian local rings. \begin{lemma} \label{lemma-resolution-by-finite-free} let $r$ be a ring. let $m$ be an $r$-module. \begin{enumerate} \item there exists an exact complex $$ \ldots \to f_2 \to f_1 \to f_0 \to m \to 0. $$ with $f_i$ free $r$-modules. \item if $r$ is noetherian and $m$ finite over $r$, then we can choose the complex such that $f_i$ is finite free. in other words, we can find an exact complex $$ \ldots \to r^{\oplus n_2} \to r^{\oplus n_1} \to r^{\oplus n_0} \to m \to 0. $$ \end{enumerate} \end{lemma} \begin{proof} let us explain only the noetherian case. as a first step choose a surjection $r^{n_0} \to m$. then having constructed an exact complex of length $e$ we simply choose a surjection $r^{n_{e + 1}} \to \ker(r^{n_e} \to r^{n_{e-1}})$ which is possible because $r$ is noetherian. \end{proof} \begin{definition} \label{definition-finite-free-resolution} let $r$ be a ring. let $m$ be an $r$-module. \begin{enumerate} \item a (left) {\it resolution} $f_\bullet \to m$ of $m$ is an exact complex $$ \ldots \to f_2 \to f_1 \to f_0 \to m \to 0 $$ of $r$-modules. \item a {\it resolution of $m$ by free $r$-modules} is a resolution $f_\bullet \to m$ where each $f_i$ is a free $r$-module. \item a {\it resolution of $m$ by finite free $r$-modules} is a resolution $f_\bullet \to m$ where each $f_i$ is a finite free $r$-module. \end{enumerate} \end{definition} \noindent we often use the notation $f_{\bullet}$ to denote a complex of $r$-modules $$ \ldots \to f_i \to f_{i-1} \to \ldots $$ in this case we often use $d_i$ or $d_{f, i}$ to denote the map $f_i \to f_{i-1}$. in this section we are always going to assume that $f_0$ is the last nonzero term in the complex. the {\it $i$th homology group of the complex} $f_{\bullet}$ is the group $h_i = \ker(d_{f, i})/\im(d_{f, i + 1})$. a {\it map of complexes $\alpha : f_{\bullet} \to g_{\bullet}$} is given by maps $\alpha_i : f_i \to g_i$ such that $\alpha_{i-1} \circ d_{f, i} = d_{g, i-1} \circ \alpha_i$. such a map induces a map on homology $h_i(\alpha) : h_i(f_{\bullet}) \to h_i(g_{\bullet})$. if $\alpha, \beta : f_{\bullet} \to g_{\bullet}$ are maps of complexes, then a {\it homotopy} between $\alpha$ and $\beta$ is given by a collection of maps $h_i : f_i \to g_{i + 1}$ such that $\alpha_i - \beta_i = d_{g, i + 1} \circ h_i + h_{i-1} \circ d_{f, i}$. two maps $\alpha, \beta : f_{\bullet} \to g_{\bullet}$ are said to be {\it homotopic} if a homotopy between $\alpha$ and $\beta$ exists. \medskip\noindent we will use a very similar notation regarding complexes of the form $f^{\bullet}$ which look like $$ \ldots \to f^i \xrightarrow{d^i} f^{i + 1} \to \ldots $$ there are maps of complexes, homotopies, etc. in this case we set $h^i(f^{\bullet}) = \ker(d^i)/\im(d^{i - 1})$ and we call it the {\it $i$th cohomology group}. \begin{lemma} \label{lemma-homotopic-equal-homology} any two homotopic maps of complexes induce the same maps on (co)homology groups. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-compare-resolutions} let $r$ be a ring. let $m \to n$ be a map of $r$-modules. let $n_\bullet \to n$ be an arbitrary resolution. let $$ \ldots \to f_2 \to f_1 \to f_0 \to m $$ be a complex of $r$-modules where each $f_i$ is a free $r$-module. then \begin{enumerate} \item there exists a map of complexes $f_\bullet \to n_\bullet$ such that $$ \xymatrix{ f_0 \ar[r] \ar[d] & m \ar[d] \\ n_0 \ar[r] & n } $$ is commutative, and \item any two maps $\alpha, \beta : f_\bullet \to n_\bullet$ as in (1) are homotopic. \end{enumerate} \end{lemma} \begin{proof} proof of (1). because $f_0$ is free we can find a map $f_0 \to n_0$ lifting the map $f_0 \to m \to n$. we obtain an induced map $f_1 \to f_0 \to n_0$ which ends up in the image of $n_1 \to n_0$. since $f_1$ is free we may lift this to a map $f_1 \to n_1$. this in turn induces a map $f_2 \to f_1 \to n_1$ which maps to zero into $n_0$. since $n_\bullet$ is exact we see that the image of this map is contained in the image of $n_2 \to n_1$. hence we may lift to get a map $f_2 \to n_2$. repeat. \medskip\noindent proof of (2). to show that $\alpha, \beta$ are homotopic it suffices to show the difference $\gamma = \alpha - \beta$ is homotopic to zero. note that the image of $\gamma_0 : f_0 \to n_0$ is contained in the image of $n_1 \to n_0$. hence we may lift $\gamma_0$ to a map $h_0 : f_0 \to n_1$. consider the map $\gamma_1' = \gamma_1 - h_0 \circ d_{f, 1}$. by our choice of $h_0$ we see that the image of $\gamma_1'$ is contained in the kernel of $n_1 \to n_0$. since $n_\bullet$ is exact we may lift $\gamma_1'$ to a map $h_1 : f_1 \to n_2$. at this point we have $\gamma_1 = h_0 \circ d_{f, 1} + d_{n, 2} \circ h_1$. repeat. \end{proof} \noindent at this point we are ready to define the groups $\ext^i_r(m, n)$. namely, choose a resolution $f_{\bullet}$ of $m$ by free $r$-modules, see lemma \ref{lemma-resolution-by-finite-free}. consider the (cohomological) complex $$ \hom_r(f_\bullet, n) : \hom_r(f_0, n) \to \hom_r(f_1, n) \to \hom_r(f_2, n) \to \ldots $$ we define $\ext^i_r(m, n)$ for $i \geq 0$ to be the $i$th cohomology group of this complex\footnote{at this point it would perhaps be more appropriate to say ``an'' in stead of ``the'' ext-group.}. for $i < 0$ we set $\ext^i_r(m, n) = 0$. before we continue we point out that $$ \ext^0_r(m, n) = \ker(\hom_r(f_0, n) \to \hom_r(f_1, n)) = \hom_r(m, n) $$ because we can apply part (1) of lemma \ref{lemma-hom-exact} to the exact sequence $f_1 \to f_0 \to m \to 0$. the following lemma explains in what sense this is well defined. \begin{lemma} \label{lemma-ext-welldefined} let $r$ be a ring. let $m_1, m_2, n$ be $r$-modules. suppose that $f_{\bullet}$ is a free resolution of the module $m_1$, and $g_{\bullet}$ is a free resolution of the module $m_2$. let $\varphi : m_1 \to m_2$ be a module map. let $\alpha : f_{\bullet} \to g_{\bullet}$ be a map of complexes inducing $\varphi$ on $m_1 = \coker(d_{f, 1}) \to m_2 = \coker(d_{g, 1})$, see lemma \ref{lemma-compare-resolutions}. then the induced maps $$ h^i(\alpha) : h^i(\hom_r(f_{\bullet}, n)) \longrightarrow h^i(\hom_r(g_{\bullet}, n)) $$ are independent of the choice of $\alpha$. if $\varphi$ is an isomorphism, so are all the maps $h^i(\alpha)$. if $m_1 = m_2$, $f_\bullet = g_\bullet$, and $\varphi$ is the identity, so are all the maps $h_i(\alpha)$. \end{lemma} \begin{proof} another map $\beta : f_{\bullet} \to g_{\bullet}$ inducing $\varphi$ is homotopic to $\alpha$ by lemma \ref{lemma-compare-resolutions}. hence the maps $\hom_r(f_\bullet, n) \to \hom_r(g_\bullet, n)$ are homotopic. hence the independence result follows from lemma \ref{lemma-homotopic-equal-homology}. \medskip\noindent suppose that $\varphi$ is an isomorphism. let $\psi : m_2 \to m_1$ be an inverse. choose $\beta : g_{\bullet} \to f_{\bullet}$ be a map inducing $\psi : m_2 = \coker(d_{g, 1}) \to m_1 = \coker(d_{f, 1})$, see lemma \ref{lemma-compare-resolutions}. ok, and now consider the map $h^i(\alpha) \circ h^i(\beta) = h^i(\alpha \circ \beta)$. by the above the map $h^i(\alpha \circ \beta)$ is the {\it same} as the map $h^i(\text{id}_{g_{\bullet}}) = \text{id}$. similarly for the composition $h^i(\beta) \circ h^i(\alpha)$. hence $h^i(\alpha)$ and $h^i(\beta)$ are inverses of each other. \end{proof} \begin{lemma} \label{lemma-long-exact-seq-ext} let $r$ be a ring. let $m$ be an $r$-module. let $0 \to n' \to n \to n'' \to 0$ be a short exact sequence. then we get a long exact sequence $$ \begin{matrix} 0 \to \hom_r(m, n') \to \hom_r(m, n) \to \hom_r(m, n'') \\ \phantom{0\ } \to \ext^1_r(m, n') \to \ext^1_r(m, n) \to \ext^1_r(m, n'') \to \ldots \end{matrix} $$ \end{lemma} \begin{proof} pick a free resolution $f_{\bullet} \to m$. since each of the $f_i$ are free we see that we get a short exact sequence of complexes $$ 0 \to \hom_r(f_{\bullet}, n') \to \hom_r(f_{\bullet}, n) \to \hom_r(f_{\bullet}, n'') \to 0 $$ thus we get the long exact sequence from the snake lemma applied to this. \end{proof} \begin{lemma} \label{lemma-reverse-long-exact-seq-ext} let $r$ be a ring. let $n$ be an $r$-module. let $0 \to m' \to m \to m'' \to 0$ be a short exact sequence. then we get a long exact sequence $$ \begin{matrix} 0 \to \hom_r(m'', n) \to \hom_r(m, n) \to \hom_r(m', n) \\ \phantom{0\ } \to \ext^1_r(m'', n) \to \ext^1_r(m, n) \to \ext^1_r(m', n) \to \ldots \end{matrix} $$ \end{lemma} \begin{proof} pick sets of generators $\{m'_{i'}\}_{i' \in i'}$ and $\{m''_{i''}\}_{i'' \in i''}$ of $m'$ and $m''$. for each $i'' \in i''$ choose a lift $\tilde m''_{i''} \in m$ of the element $m''_{i''} \in m''$. set $f' = \bigoplus_{i' \in i'} r$, $f'' = \bigoplus_{i'' \in i''} r$ and $f = f' \oplus f''$. mapping the generators of these free modules to the corresponding chosen generators gives surjective $r$-module maps $f' \to m'$, $f'' \to m''$, and $f \to m$. we obtain a map of short exact sequences $$ \begin{matrix} 0 & \to & m' & \to & m & \to & m'' & \to & 0 \\ & & \uparrow & & \uparrow & & \uparrow \\ 0 & \to & f' & \to & f & \to & f'' & \to & 0 \\ \end{matrix} $$ by the snake lemma we see that the sequence of kernels $0 \to k' \to k \to k'' \to 0$ is short exact sequence of $r$-modules. hence we can continue this process indefinitely. in other words we obtain a short exact sequence of resolutions fitting into the diagram $$ \begin{matrix} 0 & \to & m' & \to & m & \to & m'' & \to & 0 \\ & & \uparrow & & \uparrow & & \uparrow \\ 0 & \to & f_\bullet' & \to & f_\bullet & \to & f_\bullet'' & \to & 0 \\ \end{matrix} $$ because each of the sequences $0 \to f'_n \to f_n \to f''_n \to 0$ is split exact (by construction) we obtain a short exact sequence of complexes $$ 0 \to \hom_r(f''_{\bullet}, n) \to \hom_r(f_{\bullet}, n) \to \hom_r(f'_{\bullet}, n) \to 0 $$ by applying the $\hom_r(-, n)$ functor. thus we get the long exact sequence from the snake lemma applied to this. \end{proof} \begin{lemma} \label{lemma-annihilate-ext} let $r$ be a ring. let $m$, $n$ be $r$-modules. any $x\in r$ such that either $xn = 0$, or $xm = 0$ annihilates each of the modules $\ext^i_r(m, n)$. \end{lemma} \begin{proof} pick a free resolution $f_{\bullet}$ of $m$. since $\ext^i_r(m, n)$ is defined as the cohomology of the complex $\hom_r(f_{\bullet}, n)$ the lemma is clear when $xn = 0$. if $xm = 0$, then we see that multiplication by $x$ on $f_{\bullet}$ lifts the zero map on $m$. hence by lemma \ref{lemma-ext-welldefined} we see that it induces the same map on ext groups as the zero map. \end{proof} \begin{lemma} \label{lemma-ext-noetherian} let $r$ be a noetherian ring. let $m$, $n$ be finite $r$-modules. then $\ext^i_r(m, n)$ is a finite $r$-module for all $i$. \end{lemma} \begin{proof} this holds because $\ext^i_r(m, n)$ is computed as the cohomology groups of a complex $\hom_r(f_\bullet, n)$ with each $f_n$ a finite free $r$-module, see lemma \ref{lemma-resolution-by-finite-free}. \end{proof} \section{depth} \label{section-depth} \noindent here is our definition. \begin{definition} \label{definition-depth} let $r$ be a ring, and $i \subset r$ an ideal. let $m$ be a finite $r$-module. the {\it $i$-depth} of $m$, denoted $\text{depth}_i(m)$, is defined as follows: \begin{enumerate} \item if $im \not = m$, then $\text{depth}_i(m)$ is the supremum in $\{0, 1, 2, \ldots, \infty\}$ of the lengths of $m$-regular sequences in $i$, \item if $im = m$ we set $\text{depth}_i(m) = \infty$. \end{enumerate} if $(r, \mathfrak m)$ is local we call $\text{depth}_{\mathfrak m}(m)$ simply the {\it depth} of $m$. \end{definition} \noindent explanation. by definition \ref{definition-regular-sequence} the empty sequence is not a regular sequence on the zero module, but for practical purposes it turns out to be convenient to set the depth of the $0$ module equal to $+\infty$. note that if $i = r$, then $\text{depth}_i(m) = \infty$ for all finite $r$-modules $m$. if $i$ is contained in the jacobson radical of $r$ (e.g., if $r$ is local and $i \subset \mathfrak m_r$), then $m \not = 0 \rightarrow im \not = m$ by nakayama's lemma. a module $m$ has $i$-depth $0$ if and only if $m$ is nonzero and $i$ does not contain a nonzerodivisor on $m$. \medskip\noindent example \ref{example-global-regular} shows depth does not behave well even if the ring is noetherian, and example \ref{example-local-regular} shows that it does not behave well if the ring is local but non-noetherian. we will see depth behaves well if the ring is local noetherian. \begin{lemma} \label{lemma-depth-weak-sequence} let $r$ be a ring, $i \subset r$ an ideal, and $m$ a finite $r$-module. then $\text{depth}_i(m)$ is equal to the supremum of the lengths of sequences $f_1, \ldots, f_r \in i$ such that $f_i$ is a nonzerodivisor on $m/(f_1, \ldots, f_{i - 1})m$. \end{lemma} \begin{proof} suppose that $im = m$. then lemma \ref{lemma-nak} shows there exists an $f \in i$ such that $f : m \to m$ is $\text{id}_m$. hence $f, 0, 0, 0, \ldots$ is an infinite sequence of successive nonzerodivisors and we see agreement holds in this case. if $im \not = m$, then we see that a sequence as in the lemma is an $m$-regular sequence and we conclude that agreement holds as well. \end{proof} \begin{lemma} \label{lemma-bound-depth} let $(r, \mathfrak m)$ be a noetherian local ring. let $m$ be a nonzero finite $r$-module. then $\dim(\text{supp}(m)) \geq \text{depth}(m)$. \end{lemma} \begin{proof} the proof is by induction on $\dim(\text{supp}(m))$. if $\dim(\text{supp}(m)) = 0$, then $\text{supp}(m) = \{\mathfrak m\}$, whence $\text{ass}(m) = \{\mathfrak m\}$ (by lemmas \ref{lemma-ass-support} and \ref{lemma-ass-zero}), and hence the depth of $m$ is zero for example by lemma \ref{lemma-ideal-nonzerodivisor}. for the induction step we assume $\dim(\text{supp}(m)) > 0$. let $f_1, \ldots, f_d$ be a sequence of elements of $\mathfrak m$ such that $f_i$ is a nonzerodivisor on $m/(f_1, \ldots, f_{i - 1})m$. according to lemma \ref{lemma-depth-weak-sequence} it suffices to prove $\dim(\text{supp}(m)) \geq d$. we may assume $d > 0$ otherwise the lemma holds. by lemma \ref{lemma-one-equation-module} we have $\dim(\text{supp}(m/f_1m)) = \dim(\text{supp}(m)) - 1$. by induction we conclude $\dim(\text{supp}(m/f_1m)) \geq d - 1$ as desired. \end{proof} \begin{lemma} \label{lemma-depth-finite-noetherian} let $r$ be a noetherian ring, $i \subset r$ an ideal, and $m$ a finite nonzero $r$-module such that $im \not = m$. then $\text{depth}_i(m) < \infty$. \end{lemma} \begin{proof} since $m/im$ is nonzero we can choose $\mathfrak p \in \text{supp}(m/im)$ by lemma \ref{lemma-support-zero}. then $(m/im)_\mathfrak p \not = 0$ which implies $i \subset \mathfrak p$ and moreover implies $m_\mathfrak p \not = im_\mathfrak p$ as localization is exact. let $f_1, \ldots, f_r \in i$ be an $m$-regular sequence. then $m_\mathfrak p/(f_1, \ldots, f_r)m_\mathfrak p$ is nonzero as $(f_1, \ldots, f_r) \subset i$. as localization is flat we see that the images of $f_1, \ldots, f_r$ form a $m_\mathfrak p$-regular sequence in $i_\mathfrak p$. since this works for every $m$-regular sequence in $i$ we conclude that $\text{depth}_i(m) \leq \text{depth}_{i_\mathfrak p}(m_\mathfrak p)$. the latter is $\leq \text{depth}(m_\mathfrak p)$ which is $< \infty$ by lemma \ref{lemma-bound-depth}. \end{proof} \begin{lemma} \label{lemma-depth-ext} let $r$ be a noetherian local ring with maximal ideal $\mathfrak m$. let $m$ be a nonzero finite $r$-module. then $\text{depth}(m)$ is equal to the smallest integer $i$ such that $\ext^i_r(r/\mathfrak m, m)$ is nonzero. \end{lemma} \begin{proof} let $\delta(m)$ denote the depth of $m$ and let $i(m)$ denote the smallest integer $i$ such that $\ext^i_r(r/\mathfrak m, m)$ is nonzero. we will see in a moment that $i(m) < \infty$. by lemma \ref{lemma-ideal-nonzerodivisor} we have $\delta(m) = 0$ if and only if $i(m) = 0$, because $\mathfrak m \in \text{ass}(m)$ exactly means that $i(m) = 0$. hence if $\delta(m)$ or $i(m)$ is $> 0$, then we may choose $x \in \mathfrak m$ such that (a) $x$ is a nonzerodivisor on $m$, and (b) $\text{depth}(m/xm) = \delta(m) - 1$. consider the long exact sequence of ext-groups associated to the short exact sequence $0 \to m \to m \to m/xm \to 0$ by lemma \ref{lemma-long-exact-seq-ext}: $$ \begin{matrix} 0 \to \hom_r(\kappa, m) \to \hom_r(\kappa, m) \to \hom_r(\kappa, m/xm) \\ \phantom{0\ } \to \ext^1_r(\kappa, m) \to \ext^1_r(\kappa, m) \to \ext^1_r(\kappa, m/xm) \to \ldots \end{matrix} $$ since $x \in \mathfrak m$ all the maps $\ext^i_r(\kappa, m) \to \ext^i_r(\kappa, m)$ are zero, see lemma \ref{lemma-annihilate-ext}. thus it is clear that $i(m/xm) = i(m) - 1$. induction on $\delta(m)$ finishes the proof. \end{proof} \begin{lemma} \label{lemma-depth-in-ses} let $r$ be a local noetherian ring. let $0 \to n' \to n \to n'' \to 0$ be a short exact sequence of nonzero finite $r$-modules. \begin{enumerate} \item $\text{depth}(n) \geq \min\{\text{depth}(n'), \text{depth}(n'')\}$ \item $\text{depth}(n'') \geq \min\{\text{depth}(n), \text{depth}(n') - 1\}$ \item $\text{depth}(n') \geq \min\{\text{depth}(n), \text{depth}(n'') + 1\}$ \end{enumerate} \end{lemma} \begin{proof} use the characterization of depth using the ext groups $\ext^i(\kappa, n)$, see lemma \ref{lemma-depth-ext}, and use the long exact cohomology sequence $$ \begin{matrix} 0 \to \hom_r(\kappa, n') \to \hom_r(\kappa, n) \to \hom_r(\kappa, n'') \\ \phantom{0\ } \to \ext^1_r(\kappa, n') \to \ext^1_r(\kappa, n) \to \ext^1_r(\kappa, n'') \to \ldots \end{matrix} $$ from lemma \ref{lemma-long-exact-seq-ext}. \end{proof} \begin{lemma} \label{lemma-depth-drops-by-one} let $r$ be a local noetherian ring and $m$ a nonzero finite $r$-module. \begin{enumerate} \item if $x \in \mathfrak m$ is a nonzerodivisor on $m$, then $\text{depth}(m/xm) = \text{depth}(m) - 1$. \item any $m$-regular sequence $x_1, \ldots, x_r$ can be extended to an $m$-regular sequence of length $\text{depth}(m)$. \end{enumerate} \end{lemma} \begin{proof} part (2) is a formal consequence of part (1). let $x \in r$ be as in (1). by the short exact sequence $0 \to m \to m \to m/xm \to 0$ and lemma \ref{lemma-depth-in-ses} we see that the depth drops by at most 1. on the other hand, if $x_1, \ldots, x_r \in \mathfrak m$ is a regular sequence for $m/xm$, then $x, x_1, \ldots, x_r$ is a regular sequence for $m$. hence we see that the depth drops by at least 1. \end{proof} \begin{lemma} \label{lemma-inherit-minimal-primes} let $(r, \mathfrak m)$ be a local noetherian ring and $m$ a finite $r$-module. let $x \in \mathfrak m$, $\mathfrak p \in \text{ass}(m)$, and $\mathfrak q$ minimal over $\mathfrak p + (x)$. then $\mathfrak q \in \text{ass}(m/x^nm)$ for some $n \geq 1$. \end{lemma} \begin{proof} pick a submodule $n \subset m$ with $n \cong r/\mathfrak p$. by the artin-rees lemma (lemma \ref{lemma-artin-rees}) we can pick $n > 0$ such that $n \cap x^nm \subset xn$. let $\overline{n} \subset m/x^nm$ be the image of $n \to m \to m/x^nm$. by lemma \ref{lemma-ass} it suffices to show $\mathfrak q \in \text{ass}(\overline{n})$. by our choice of $n$ there is a surjection $\overline{n} \to n/xn = r/\mathfrak p + (x)$ and hence $\mathfrak q$ is in the support of $\overline{n}$. since $\overline{n}$ is annihilated by $x^n$ and $\mathfrak p$ we see that $\mathfrak q$ is minimal among the primes in the support of $\overline{n}$. thus $\mathfrak q$ is an associated prime of $\overline{n}$ by lemma \ref{lemma-ass-minimal-prime-support}. \end{proof} \begin{lemma} \label{lemma-depth-dim-associated-primes} let $(r, \mathfrak m)$ be a local noetherian ring and $m$ a finite $r$-module. for $\mathfrak p \in \text{ass}(m)$ we have $\dim(r/\mathfrak p) \geq \text{depth}(m)$. \end{lemma} \begin{proof} if $\mathfrak m \in \text{ass}(m)$ then there is a nonzero element $x \in m$ which is annihilated by all elements of $\mathfrak m$. thus $\text{depth}(m) = 0$. in particular the lemma holds in this case. \medskip\noindent if $\text{depth}(m) = 1$, then by the first paragraph we find that $\mathfrak m \not \in \text{ass}(m)$. hence $\dim(r/\mathfrak p) \geq 1$ for all $\mathfrak p \in \text{ass}(m)$ and the lemma is true in this case as well. \medskip\noindent we will prove the lemma in general by induction on $\text{depth}(m)$ which we may and do assume to be $> 1$. pick $x \in \mathfrak m$ which is a nonzerodivisor on $m$. note $x \not \in \mathfrak p$ (lemma \ref{lemma-ass-zero-divisors}). by lemma \ref{lemma-one-equation} we have $\dim(r/\mathfrak p + (x)) = \dim(r/\mathfrak p) - 1$. thus there exists a prime $\mathfrak q$ minimal over $\mathfrak p + (x)$ with $\dim(r/\mathfrak q) = \dim(r/\mathfrak p) - 1$ (small argument omitted; hint: the dimension of a noetherian local ring $a$ is the maximum of the dimensions of $a/\mathfrak r$ taken over the minimal primes $\mathfrak r$ of $a$). pick $n$ as in lemma \ref{lemma-inherit-minimal-primes} so that $\mathfrak q$ is an associated prime of $m/x^nm$. we may apply induction hypothesis to $m/x^nm$ and $\mathfrak q$ because $\text{depth}(m/x^nm) = \text{depth}(m) - 1$ by lemma \ref{lemma-depth-drops-by-one}. we find $\dim(r/\mathfrak q) \geq \text{depth}(m/x^nm)$ and we win. \end{proof} \begin{lemma} \label{lemma-depth-localization} let $r$ be a local noetherian ring and $m$ a finite $r$-module. for a prime ideal $\mathfrak p \subset r$ we have $\text{depth}(m_\mathfrak p) + \dim(r/\mathfrak p) \geq \text{depth}(m)$. \end{lemma} \begin{proof} if $m_\mathfrak p = 0$, then $\text{depth}(m_\mathfrak p) = \infty$ and the lemma holds. if $\text{depth}(m) \leq \dim(r/\mathfrak p)$, then the lemma is true. if $\text{depth}(m) > \dim(r/\mathfrak p)$, then $\mathfrak p$ is not contained in any associated prime $\mathfrak q$ of $m$ by lemma \ref{lemma-depth-dim-associated-primes}. hence we can find an $x \in \mathfrak p$ not contained in any associated prime of $m$ by lemma \ref{lemma-silly} and lemma \ref{lemma-finite-ass}. then $x$ is a nonzerodivisor on $m$, see lemma \ref{lemma-ass-zero-divisors}. hence $\text{depth}(m/xm) = \text{depth}(m) - 1$ and $\text{depth}(m_\mathfrak p / x m_\mathfrak p) = \text{depth}(m_\mathfrak p) - 1$ provided $m_\mathfrak p$ is nonzero, see lemma \ref{lemma-depth-drops-by-one}. thus we conclude by induction on $\text{depth}(m)$. \end{proof} \begin{lemma} \label{lemma-depth-goes-down-finite} let $(r, \mathfrak m)$ be a noetherian local ring. let $r \to s$ be a finite ring map. let $\mathfrak m_1, \ldots, \mathfrak m_n$ be the maximal ideals of $s$. let $n$ be a finite $s$-module. then $$ \min\nolimits_{i = 1, \ldots, n} \text{depth}(n_{\mathfrak m_i}) = \text{depth}_\mathfrak m(n) $$ \end{lemma} \begin{proof} by lemmas \ref{lemma-integral-no-inclusion}, \ref{lemma-integral-going-up}, and lemma \ref{lemma-finite-finite-fibres} the maximal ideals of $s$ are exactly the primes of $s$ lying over $\mathfrak m$ and there are finitely many of them. hence the statement of the lemma makes sense. we will prove the lemma by induction on $k = \min\nolimits_{i = 1, \ldots, n} \text{depth}(n_{\mathfrak m_i})$. if $k = 0$, then $\text{depth}(n_{\mathfrak m_i}) = 0$ for some $i$. by lemma \ref{lemma-depth-ext} this means $\mathfrak m_i s_{\mathfrak m_i}$ is an associated prime of $n_{\mathfrak m_i}$ and hence $\mathfrak m_i$ is an associated prime of $n$ (lemma \ref{lemma-localize-ass}). by lemma \ref{lemma-ass-functorial-noetherian} we see that $\mathfrak m$ is an associated prime of $n$ as an $r$-module. whence $\text{depth}_\mathfrak m(n) = 0$. this proves the base case. if $k > 0$, then we see that $\mathfrak m_i \not \in \text{ass}_s(n)$. hence $\mathfrak m \not \in \text{ass}_r(n)$, again by lemma \ref{lemma-ass-functorial-noetherian}. thus we can find $f \in \mathfrak m$ which is not a zerodivisor on $n$, see lemma \ref{lemma-ideal-nonzerodivisor}. by lemma \ref{lemma-depth-drops-by-one} all the depths drop exactly by $1$ when passing from $n$ to $n/fn$ and the induction hypothesis does the rest. \end{proof} \section{functorialities for ext} \label{section-functoriality-ext} \noindent in this section we briefly discuss the functoriality of $\ext$ with respect to change of ring, etc. here is a list of items to work out. \begin{enumerate} \item given $r \to r'$, an $r$-module $m$ and an $r'$-module $n'$ the $r$-module $\ext^i_r(m, n')$ has a natural $r'$-module structure. moreover, there is a canonical $r'$-linear map $\ext^i_{r'}(m \otimes_r r', n') \to \ext^i_r(m, n')$. \item given $r \to r'$ and $r$-modules $m$, $n$ there is a natural $r$-module map $\ext^i_r(m, n) \to \text{ext}^i_r(m, n \otimes_r r')$. \end{enumerate} \begin{lemma} \label{lemma-flat-base-change-ext} given a flat ring map $r \to r'$, an $r$-module $m$, and an $r'$-module $n'$ the natural map $$ \ext^i_{r'}(m \otimes_r r', n') \to \text{ext}^i_r(m, n') $$ is an isomorphism for $i \geq 0$. \end{lemma} \begin{proof} choose a free resolution $f_\bullet$ of $m$. since $r \to r'$ is flat we see that $f_\bullet \otimes_r r'$ is a free resolution of $m \otimes_r r'$ over $r'$. the statement is that the map $$ \hom_{r'}(f_\bullet \otimes_r r', n') \to \hom_r(f_\bullet, n') $$ induces an isomorphism on homology groups, which is true because it is an isomorphism of complexes by lemma \ref{lemma-adjoint-tensor-restrict}. \end{proof} \section{an application of ext groups} \label{section-ext-application} \noindent here it is. \begin{lemma} \label{lemma-split-injection-after-completion} let $r$ be a noetherian ring. let $i \subset r$ be an ideal contained in the jacobson radical of $r$. let $n \to m$ be a homomorphism of finite $r$-modules. suppose that there exists arbitrarily large $n$ such that $n/i^nn \to m/i^nm$ is a split injection. then $n \to m$ is a split injection. \end{lemma} \begin{proof} assume $\varphi : n \to m$ satisfies the assumptions of the lemma. note that this implies that $\ker(\varphi) \subset i^nn$ for arbitrarily large $n$. hence by lemma \ref{lemma-intersection-powers-ideal-module} we see that $\varphi$ is injection. let $q = m/n$ so that we have a short exact sequence $$ 0 \to n \to m \to q \to 0. $$ let $$ f_2 \xrightarrow{d_2} f_1 \xrightarrow{d_1} f_0 \to q \to 0 $$ be a finite free resolution of $q$. we can choose a map $\alpha : f_0 \to m$ lifting the map $f_0 \to q$. this induces a map $\beta : f_1 \to n$ such that $\beta \circ d_2 = 0$. the extension above is split if and only if there exists a map $\gamma : f_0 \to n$ such that $\beta = \gamma \circ d_1$. in other words, the class of $\beta$ in $\ext^1_r(q, n)$ is the obstruction to splitting the short exact sequence above. \medskip\noindent suppose $n$ is a large integer such that $n/i^nn \to m/i^nm$ is a split injection. this implies $$ 0 \to n/i^nn \to m/i^nm \to q/i^nq \to 0. $$ is still short exact. also, the sequence $$ f_1/i^nf_1 \xrightarrow{d_1} f_0/i^nf_0 \to q/i^nq \to 0 $$ is still exact. arguing as above we see that the map $\overline{\beta} : f_1/i^nf_1 \to n/i^nn$ induced by $\beta$ is equal to $\overline{\gamma_n} \circ d_1$ for some map $\overline{\gamma_n} : f_0/i^nf_0 \to n/i^nn$. since $f_0$ is free we can lift $\overline{\gamma_n}$ to a map $\gamma_n : f_0 \to n$ and then we see that $\beta - \gamma_n \circ d_1$ is a map from $f_1$ into $i^nn$. in other words we conclude that $$ \beta \in \im\big(\hom_r(f_0, n) \to \hom_r(f_1, n)\big) + i^n\hom_r(f_1, n). $$ for this $n$. \medskip\noindent since we have this property for arbitrarily large $n$ by assumption we conclude that the image of $\beta$ in the cokernel of $\hom_r(f_0, n) \to \hom_r(f_1, n)$ is zero by lemma \ref{lemma-intersection-powers-ideal-module}. hence $\beta$ is in the image of the map $\hom_r(f_0, n) \to \hom_r(f_1, n)$ as desired. \end{proof} \section{tor groups and flatness} \label{section-tor} \noindent in this section we use some of the homological algebra developed in the previous section to explain what tor groups are. namely, suppose that $r$ is a ring and that $m$, $n$ are two $r$-modules. choose a resolution $f_\bullet$ of $m$ by free $r$-modules. see lemma \ref{lemma-resolution-by-finite-free}. consider the homological complex $$ f_\bullet \otimes_r n : \ldots \to f_2 \otimes_r n \to f_1 \otimes_r n \to f_0 \otimes_r n $$ we define $\text{tor}^r_i(m, n)$ to be the $i$th homology group of this complex. the following lemma explains in what sense this is well defined. \begin{lemma} \label{lemma-tor-welldefined} let $r$ be a ring. let $m_1, m_2, n$ be $r$-modules. suppose that $f_\bullet$ is a free resolution of the module $m_1$ and that $g_\bullet$ is a free resolution of the module $m_2$. let $\varphi : m_1 \to m_2$ be a module map. let $\alpha : f_\bullet \to g_\bullet$ be a map of complexes inducing $\varphi$ on $m_1 = \coker(d_{f, 1}) \to m_2 = \coker(d_{g, 1})$, see lemma \ref{lemma-compare-resolutions}. then the induced maps $$ h_i(\alpha) : h_i(f_\bullet \otimes_r n) \longrightarrow h_i(g_\bullet \otimes_r n) $$ are independent of the choice of $\alpha$. if $\varphi$ is an isomorphism, so are all the maps $h_i(\alpha)$. if $m_1 = m_2$, $f_\bullet = g_\bullet$, and $\varphi$ is the identity, so are all the maps $h_i(\alpha)$. \end{lemma} \begin{proof} the proof of this lemma is identical to the proof of lemma \ref{lemma-ext-welldefined}. \end{proof} \noindent not only does this lemma imply that the tor modules are well defined, but it also provides for the functoriality of the constructions $(m, n) \mapsto \text{tor}_i^r(m, n)$ in the first variable. of course the functoriality in the second variable is evident. we leave it to the reader to see that each of the $\text{tor}_i^r$ is in fact a functor $$ \text{mod}_r \times \text{mod}_r \to \text{mod}_r. $$ here $\text{mod}_r$ denotes the category of $r$-modules, and for the definition of the product category see categories, definition \ref{categories-definition-product-category}. namely, given morphisms of $r$-modules $m_1 \to m_2$ and $n_1 \to n_2$ we get a commutative diagram $$ \xymatrix{ \text{tor}_i^r(m_1, n_1) \ar[r] \ar[d] & \text{tor}_i^r(m_1, n_2) \ar[d] \\ \text{tor}_i^r(m_2, n_1) \ar[r] & \text{tor}_i^r(m_2, n_2) \\ } $$ \begin{lemma} \label{lemma-long-exact-sequence-tor} let $r$ be a ring and let $m$ be an $r$-module. suppose that $0 \to n' \to n \to n'' \to 0$ is a short exact sequence of $r$-modules. there exists a long exact sequence $$ \text{tor}_1^r(m, n') \to \text{tor}_1^r(m, n) \to \text{tor}_1^r(m, n'') \to m \otimes_r n' \to m \otimes_r n \to m \otimes_r n'' \to 0 $$ \end{lemma} \begin{proof} the proof of this is the same as the proof of lemma \ref{lemma-long-exact-seq-ext}. \end{proof} \noindent consider a homological double complex of $r$-modules $$ \xymatrix{ \ldots \ar[r]^d & a_{2, 0} \ar[r]^d & a_{1, 0} \ar[r]^d & a_{0, 0} \\ \ldots \ar[r]^d & a_{2, 1} \ar[r]^d \ar[u]^\delta & a_{1, 1} \ar[r]^d \ar[u]^\delta & a_{0, 1} \ar[u]^\delta \\ \ldots \ar[r]^d & a_{2, 2} \ar[r]^d \ar[u]^\delta & a_{1, 2} \ar[r]^d \ar[u]^\delta & a_{0, 2} \ar[u]^\delta \\ & \ldots \ar[u]^\delta & \ldots \ar[u]^\delta & \ldots \ar[u]^\delta \\ } $$ this means that $d_{i, j} : a_{i, j} \to a_{i-1, j}$ and $\delta_{i, j} : a_{i, j} \to a_{i, j-1}$ have the following properties \begin{enumerate} \item any composition of two $d_{i, j}$ is zero. in other words the rows of the double complex are complexes. \item any composition of two $\delta_{i, j}$ is zero. in other words the columns of the double complex are complexes. \item for any pair $(i, j)$ we have $\delta_{i-1, j} \circ d_{i, j} = d_{i, j-1} \circ \delta_{i, j}$. in other words, all the squares commute. \end{enumerate} the correct thing to do is to associate a spectral sequence to any such double complex. however, for the moment we can get away with doing something slightly easier. \medskip\noindent namely, for the purposes of this section only, given a double complex $(a_{\bullet, \bullet}, d, \delta)$ set $r(a)_j = \coker(a_{1, j} \to a_{0, j})$ and $u(a)_i = \coker(a_{i, 1} \to a_{i, 0})$. (the letters $r$ and $u$ are meant to suggest right and up.) we endow $r(a)_\bullet$ with the structure of a complex using the maps $\delta$. similarly we endow $u(a)_\bullet$ with the structure of a complex using the maps $d$. in other words we obtain the following huge commutative diagram $$ \xymatrix{ \ldots \ar[r]^d & u(a)_2 \ar[r]^d & u(a)_1 \ar[r]^d & u(a)_0 & \\ \ldots \ar[r]^d & a_{2, 0} \ar[r]^d \ar[u] & a_{1, 0} \ar[r]^d \ar[u] & a_{0, 0} \ar[r] \ar[u] & r(a)_0 \\ \ldots \ar[r]^d & a_{2, 1} \ar[r]^d \ar[u]^\delta & a_{1, 1} \ar[r]^d \ar[u]^\delta & a_{0, 1} \ar[r] \ar[u]^\delta & r(a)_1 \ar[u]^\delta \\ \ldots \ar[r]^d & a_{2, 2} \ar[r]^d \ar[u]^\delta & a_{1, 2} \ar[r]^d \ar[u]^\delta & a_{0, 2} \ar[r] \ar[u]^\delta & r(a)_2 \ar[u]^\delta \\ & \ldots \ar[u]^\delta & \ldots \ar[u]^\delta & \ldots \ar[u]^\delta & \ldots \ar[u]^\delta \\ } $$ (this is no longer a double complex of course.) it is clear what a morphism $\phi : (a_{\bullet, \bullet}, d, \delta) \to (b_{\bullet, \bullet}, d, \delta)$ of double complexes is, and it is clear that this induces morphisms of complexes $r(\phi) : r(a)_\bullet \to r(b)_\bullet$ and $u(\phi) : u(a)_\bullet \to u(b)_\bullet$. \begin{lemma} \label{lemma-no-spectral-sequence} let $(a_{\bullet, \bullet}, d, \delta)$ be a double complex such that \begin{enumerate} \item each row $a_{\bullet, j}$ is a resolution of $r(a)_j$. \item each column $a_{i, \bullet}$ is a resolution of $u(a)_i$. \end{enumerate} then there are canonical isomorphisms $$ h_i(r(a)_\bullet) \cong h_i(u(a)_\bullet). $$ the isomorphisms are functorial with respect to morphisms of double complexes with the properties above. \end{lemma} \begin{proof} we will show that $h_i(r(a)_\bullet))$ and $h_i(u(a)_\bullet)$ are canonically isomorphic to a third group. namely $$ \mathbf{h}_i(a) := \frac{ \{ (a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i}) \mid d(a_{i, 0}) = \delta(a_{i-1, 1}), \ldots, d(a_{1, i-1}) = \delta(a_{0, i}) \}} { \{ d(a_{i + 1, 0}) + \delta(a_{i, 1}), d(a_{i, 1}) + \delta(a_{i-1, 2}), \ldots, d(a_{1, i}) + \delta(a_{0, i + 1}) \} } $$ here we use the notational convention that $a_{i, j}$ denotes an element of $a_{i, j}$. in other words, an element of $\mathbf{h}_i$ is represented by a zig-zag, represented as follows for $i = 2$ $$ \xymatrix{ a_{2, 0} \ar@{|->}[r] & d(a_{2, 0}) = \delta(a_{1, 1}) & \\ & a_{1, 1} \ar@{|->}[u] \ar@{|->}[r] & d(a_{1, 1}) = \delta(a_{0, 2}) \\ & & a_{0, 2} \ar@{|->}[u] \\ } $$ naturally, we divide out by ``trivial'' zig-zags, namely the submodule generated by elements of the form $(0, \ldots, 0, -\delta(a_{t + 1, t-i}), d(a_{t + 1, t-i}), 0, \ldots, 0)$. note that there are canonical homomorphisms $$ \mathbf{h}_i(a) \to h_i(r(a)_\bullet), \quad (a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i}) \mapsto \text{class of image of }a_{0, i} $$ and $$ \mathbf{h}_i(a) \to h_i(u(a)_\bullet), \quad (a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i}) \mapsto \text{class of image of }a_{i, 0} $$ \medskip\noindent first we show that these maps are surjective. suppose that $\overline{r} \in h_i(r(a)_\bullet)$. let $r \in r(a)_i$ be a cocycle representing the class of $\overline{r}$. let $a_{0, i} \in a_{0, i}$ be an element which maps to $r$. because $\delta(r) = 0$, we see that $\delta(a_{0, i})$ is in the image of $d$. hence there exists an element $a_{1, i-1} \in a_{1, i-1}$ such that $d(a_{1, i-1}) = \delta(a_{0, i})$. this in turn implies that $\delta(a_{1, i-1})$ is in the kernel of $d$ (because $d(\delta(a_{1, i-1})) = \delta(d(a_{1, i-1})) = \delta(\delta(a_{0, i})) = 0$. by exactness of the rows we find an element $a_{2, i-2}$ such that $d(a_{2, i-2}) = \delta(a_{1, i-1})$. and so on until a full zig-zag is found. of course surjectivity of $\mathbf{h}_i \to h_i(u(a))$ is shown similarly. \medskip\noindent to prove injectivity we argue in exactly the same way. namely, suppose we are given a zig-zag $(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i})$ which maps to zero in $h_i(r(a)_\bullet)$. this means that $a_{0, i}$ maps to an element of $\coker(a_{i, 1} \to a_{i, 0})$ which is in the image of $\delta : \coker(a_{i + 1, 1} \to a_{i + 1, 0}) \to \coker(a_{i, 1} \to a_{i, 0})$. in other words, $a_{0, i}$ is in the image of $\delta \oplus d : a_{0, i + 1} \oplus a_{1, i} \to a_{0, i}$. from the definition of trivial zig-zags we see that we may modify our zig-zag by a trivial one and assume that $a_{0, i} = 0$. this immediately implies that $d(a_{1, i-1}) = 0$. as the rows are exact this implies that $a_{1, i-1}$ is in the image of $d : a_{2, i-1} \to a_{1, i-1}$. thus we may modify our zig-zag once again by a trivial zig-zag and assume that our zig-zag looks like $(a_{i, 0}, a_{i-1, 1}, \ldots, a_{2, i-2}, 0, 0)$. continuing like this we obtain the desired injectivity. \medskip\noindent if $\phi : (a_{\bullet, \bullet}, d, \delta) \to (b_{\bullet, \bullet}, d, \delta)$ is a morphism of double complexes both of which satisfy the conditions of the lemma, then we clearly obtain a commutative diagram $$ \xymatrix{ h_i(u(a)_\bullet) \ar[d] & \mathbf{h}_i(a) \ar[r] \ar[l] \ar[d] & h_i(r(a)_\bullet) \ar[d] \\ h_i(u(b)_\bullet) & \mathbf{h}_i(b) \ar[r] \ar[l] & h_i(r(b)_\bullet) \\ } $$ this proves the functoriality. \end{proof} \begin{remark} \label{remark-signs-double-complex} the isomorphism constructed above is the ``correct'' one only up to signs. a good part of homological algebra is concerned with choosing signs for various maps and showing commutativity of diagrams with intervention of suitable signs. for the moment we will simply use the isomorphism as given in the proof above, and worry about signs later. \end{remark} \begin{lemma} \label{lemma-tor-left-right} let $r$ be a ring. for any $i \geq 0$ the functors $\text{mod}_r \times \text{mod}_r \to \text{mod}_r$, $(m, n) \mapsto \text{tor}_i^r(m, n)$ and $(m, n) \mapsto \text{tor}_i^r(n, m)$ are canonically isomorphic. \end{lemma} \begin{proof} let $f_\bullet$ be a free resolution of the module $m$ and let $g_\bullet$ be a free resolution of the module $n$. consider the double complex $(a_{i, j}, d, \delta)$ defined as follows: \begin{enumerate} \item set $a_{i, j} = f_i \otimes_r g_j$, \item set $d_{i, j} : f_i \otimes_r g_j \to f_{i-1} \otimes g_j$ equal to $d_{f, i} \otimes \text{id}$, and \item set $\delta_{i, j} : f_i \otimes_r g_j \to f_i \otimes g_{j-1}$ equal to $\text{id} \otimes d_{g, j}$. \end{enumerate} this double complex is usually simply denoted $f_\bullet \otimes_r g_\bullet$. \medskip\noindent since each $g_j$ is free, and hence flat we see that each row of the double complex is exact except in homological degree $0$. since each $f_i$ is free and hence flat we see that each column of the double complex is exact except in homological degree $0$. hence the double complex satisfies the conditions of lemma \ref{lemma-no-spectral-sequence}. \medskip\noindent to see what the lemma says we compute $r(a)_\bullet$ and $u(a)_\bullet$. namely, \begin{eqnarray*} r(a)_i & = & \coker(a_{1, i} \to a_{0, i}) \\ & = & \coker(f_1 \otimes_r g_i \to f_0 \otimes_r g_i) \\ & = & \coker(f_1 \to f_0) \otimes_r g_i \\ & = & m \otimes_r g_i \end{eqnarray*} in fact these isomorphisms are compatible with the differentials $\delta$ and we see that $r(a)_\bullet = m \otimes_r g_\bullet$ as homological complexes. in exactly the same way we see that $u(a)_\bullet = f_\bullet \otimes_r n$. we get \begin{eqnarray*} \text{tor}_i^r(m, n) & = & h_i(f_\bullet \otimes_r n) \\ & = & h_i(u(a)_\bullet) \\ & = & h_i(r(a)_\bullet) \\ & = & h_i(m \otimes_r g_\bullet) \\ & = & h_i(g_\bullet \otimes_r m) \\ & = & \text{tor}_i^r(n, m) \end{eqnarray*} here the third equality is lemma \ref{lemma-no-spectral-sequence}, and the fifth equality uses the isomorphism $v \otimes w = w \otimes v$ of the tensor product. \medskip\noindent functoriality. suppose that we have $r$-modules $m_\nu$, $n_\nu$, $\nu = 1, 2$. let $\varphi : m_1 \to m_2$ and $\psi : n_1 \to n_2$ be morphisms of $r$-modules. suppose that we have free resolutions $f_{\nu, \bullet}$ for $m_\nu$ and free resolutions $g_{\nu, \bullet}$ for $n_\nu$. by lemma \ref{lemma-compare-resolutions} we may choose maps of complexes $\alpha : f_{1, \bullet} \to f_{2, \bullet}$ and $\beta : g_{1, \bullet} \to g_{2, \bullet}$ compatible with $\varphi$ and $\psi$. we claim that the pair $(\alpha, \beta)$ induces a morphism of double complexes $$ \alpha \otimes \beta : f_{1, \bullet} \otimes_r g_{1, \bullet} \longrightarrow f_{2, \bullet} \otimes_r g_{2, \bullet} $$ this is really a very straightforward check using the rule that $f_{1, i} \otimes_r g_{1, j} \to f_{2, i} \otimes_r g_{2, j}$ is given by $\alpha_i \otimes \beta_j$ where $\alpha_i$, resp.\ $\beta_j$ is the degree $i$, resp.\ $j$ component of $\alpha$, resp.\ $\beta$. the reader also readily verifies that the induced maps $r(f_{1, \bullet} \otimes_r g_{1, \bullet})_\bullet \to r(f_{2, \bullet} \otimes_r g_{2, \bullet})_\bullet$ agrees with the map $m_1 \otimes_r g_{1, \bullet} \to m_2 \otimes_r g_{2, \bullet}$ induced by $\varphi \otimes \beta$. similarly for the map induced on the $u(-)_\bullet$ complexes. thus the statement on functoriality follows from the statement on functoriality in lemma \ref{lemma-no-spectral-sequence}. \end{proof} \begin{remark} \label{remark-curiosity-signs-swap} an interesting case occurs when $m = n$ in the above. in this case we get a canonical map $\text{tor}_i^r(m, m) \to \text{tor}_i^r(m, m)$. note that this map is not the identity, because even when $i = 0$ this map is not the identity! for example, if $v$ is a vector space of dimension $n$ over a field, then the switch map $v \otimes_k v \to v \otimes_k v$ has $(n^2 + n)/2$ eigenvalues $+1$ and $(n^2-n)/2$ eigenvalues $-1$. in characteristic $2$ it is not even diagonalizable. note that even changing the sign of the map will not get rid of this. \end{remark} \begin{lemma} \label{lemma-tor-noetherian} let $r$ be a noetherian ring. let $m$, $n$ be finite $r$-modules. then $\text{tor}_p^r(m, n)$ is a finite $r$-module for all $p$. \end{lemma} \begin{proof} this holds because $\text{tor}_p^r(m, n)$ is computed as the cohomology groups of a complex $f_\bullet \otimes_r n$ with each $f_n$ a finite free $r$-module, see lemma \ref{lemma-resolution-by-finite-free}. \end{proof} \begin{lemma} \label{lemma-characterize-flat} let $r$ be a ring. let $m$ be an $r$-module. the following are equivalent: \begin{enumerate} \item the module $m$ is flat over $r$. \item for all $i > 0$ the functor $\text{tor}_i^r(m, -)$ is zero. \item the functor $\text{tor}_1^r(m, -)$ is zero. \item for all ideals $i \subset r$ we have $\text{tor}_1^r(m, r/i) = 0$. \item for all finitely generated ideals $i \subset r$ we have $\text{tor}_1^r(m, r/i) = 0$. \end{enumerate} \end{lemma} \begin{proof} suppose $m$ is flat. let $n$ be an $r$-module. let $f_\bullet$ be a free resolution of $n$. then $f_\bullet \otimes_r m$ is a resolution of $n \otimes_r m$, by flatness of $m$. hence all higher tor groups vanish. \medskip\noindent it now suffices to show that the last condition implies that $m$ is flat. let $i \subset r$ be an ideal. consider the short exact sequence $0 \to i \to r \to r/i \to 0$. apply lemma \ref{lemma-long-exact-sequence-tor}. we get an exact sequence $$ \text{tor}_1^r(m, r/i) \to m \otimes_r i \to m \otimes_r r \to m \otimes_r r/i \to 0 $$ since obviously $m \otimes_r r = m$ we conclude that the last hypothesis implies that $m \otimes_r i \to m$ is injective for every finitely generated ideal $i$. thus $m$ is flat by lemma \ref{lemma-flat}. \end{proof} \begin{remark} \label{remark-tor-ring-mod-ideal} the proof of lemma \ref{lemma-characterize-flat} actually shows that $$ \text{tor}_1^r(m, r/i) = \ker(i \otimes_r m \to m). $$ \end{remark} \section{functorialities for tor} \label{section-functoriality-tor} \noindent in this section we briefly discuss the functoriality of $\text{tor}$ with respect to change of ring, etc. here is a list of items to work out. \begin{enumerate} \item given a ring map $r \to r'$, an $r$-module $m$ and an $r'$-module $n'$ the $r$-modules $\text{tor}_i^r(m, n')$ have a natural $r'$-module structure. \item given a ring map $r \to r'$ and $r$-modules $m$, $n$ there is a natural $r$-module map $\text{tor}_i^r(m, n) \to \text{tor}_i^{r'}(m \otimes_r r', n \otimes_r r')$. \item given a ring map $r \to r'$ an $r$-module $m$ and an $r'$-module $n'$ there exists a natural $r'$-module map $\text{tor}_i^r(m, n') \to \text{tor}_i^{r'}(m \otimes_r r', n')$. \end{enumerate} \begin{lemma} \label{lemma-flat-base-change-tor} given a flat ring map $r \to r'$ and $r$-modules $m$, $n$ the natural $r$-module map $\text{tor}_i^r(m, n)\otimes_r r' \to \text{tor}_i^{r'}(m \otimes_r r', n \otimes_r r')$ is an isomorphism for all $i$. \end{lemma} \begin{proof} omitted. this is true because a free resolution $f_\bullet$ of $m$ over $r$ stays exact when tensoring with $r'$ over $r$ and hence $(f_\bullet \otimes_r n)\otimes_r r'$ computes the tor groups over $r'$. \end{proof} \noindent the following lemma does not seem to fit anywhere else. \begin{lemma} \label{lemma-tor-commutes-filtered-colimits} let $r$ be a ring. let $m = \colim m_i$ be a filtered colimit of $r$-modules. let $n$ be an $r$-module. then $\text{tor}_n^r(m, n) = \colim \text{tor}_n^r(m_i, n)$ for all $n$. \end{lemma} \begin{proof} choose a free resolution $f_\bullet$ of $n$. then $f_\bullet \otimes_r m = \colim f_\bullet \otimes_r m_i$ as complexes by lemma \ref{lemma-tensor-products-commute-with-limits}. thus the result by lemma \ref{lemma-directed-colimit-exact}. \end{proof} \section{projective modules} \label{section-projective} \noindent some lemmas on projective modules. \begin{definition} \label{definition-projective} let $r$ be a ring. an $r$-module $p$ is {\it projective} if and only if the functor $\hom_r(p, -) : \text{mod}_r \to \text{mod}_r$ is an exact functor. \end{definition} \noindent the functor $\hom_r(m, - )$ is left exact for any $r$-module $m$, see lemma \ref{lemma-hom-exact}. hence the condition for $p$ to be projective really signifies that given a surjection of $r$-modules $n \to n'$ the map $\hom_r(p, n) \to \hom_r(p, n')$ is surjective. \begin{lemma} \label{lemma-characterize-projective} let $r$ be a ring. let $p$ be an $r$-module. the following are equivalent \begin{enumerate} \item $p$ is projective, \item $p$ is a direct summand of a free $r$-module, and \item $\ext^1_r(p, m) = 0$ for every $r$-module $m$. \end{enumerate} \end{lemma} \begin{proof} assume $p$ is projective. choose a surjection $\pi : f \to p$ where $f$ is a free $r$-module. as $p$ is projective there exists a $i \in \hom_r(p, f)$ such that $\pi \circ i = \text{id}_p$. in other words $f \cong \ker(\pi) \oplus i(p)$ and we see that $p$ is a direct summand of $f$. \medskip\noindent conversely, assume that $p \oplus q = f$ is a free $r$-module. note that the free module $f = \bigoplus_{i \in i} r$ is projective as $\hom_r(f, m) = \prod_{i \in i} m$ and the functor $m \mapsto \prod_{i \in i} m$ is exact. then $\hom_r(f, -) = \hom_r(p, -) \times \hom_r(q, -)$ as functors, hence both $p$ and $q$ are projective. \medskip\noindent assume $p \oplus q = f$ is a free $r$-module. then we have a free resolution $f_\bullet$ of the form $$ \ldots f \xrightarrow{a} f \xrightarrow{b} f \to p \to 0 $$ where the maps $a, b$ alternate and are equal to the projector onto $p$ and $q$. hence the complex $\hom_r(f_\bullet, m)$ is split exact in degrees $\geq 1$, whence we see the vanishing in (3). \medskip\noindent assume $\ext^1_r(p, m) = 0$ for every $r$-module $m$. pick a free resolution $f_\bullet \to p$. set $m = \im(f_1 \to f_0) = \ker(f_0 \to p)$. consider the element $\xi \in \ext^1_r(p, m)$ given by the class of the quotient map $\pi : f_1 \to m$. since $\xi$ is zero there exists a map $s : f_0 \to m$ such that $\pi = s \circ (f_1 \to f_0)$. clearly, this means that $$ f_0 = \ker(s) \oplus \ker(f_0 \to p) = p \oplus \ker(f_0 \to p) $$ and we win. \end{proof} \begin{lemma} \label{lemma-characterize-finite-projective-noetherian} let $r$ be a noetherian ring. let $p$ be a finite $r$-module. if $\ext^1_r(p, m) = 0$ for every finite $r$-module $m$, then $p$ is projective. \end{lemma} \noindent this lemma can be strengthened: there is a version for finitely presented $r$-modules if $r$ is not assumed noetherian. there is a version with $m$ running through all finite length modules in the noetherian case. \begin{proof} choose a surjection $r^{\oplus n} \to p$ with kernel $m$. since $\ext^1_r(p, m) = 0$ this surjection is split and we conclude by lemma \ref{lemma-characterize-projective}. \end{proof} \begin{lemma} \label{lemma-direct-sum-projective} a direct sum of projective modules is projective. \end{lemma} \begin{proof} this is true by the characterization of projectives as direct summands of free modules in lemma \ref{lemma-characterize-projective}. \end{proof} \begin{lemma} \label{lemma-lift-projective-module} let $r$ be a ring. let $i \subset r$ be a nilpotent ideal. let $\overline{p}$ be a projective $r/i$-module. then there exists a projective $r$-module $p$ such that $p/ip \cong \overline{p}$. \end{lemma} \begin{proof} by lemma \ref{lemma-characterize-projective} we can choose a set $a$ and a direct sum decomposition $\bigoplus_{\alpha \in a} r/i = \overline{p} \oplus \overline{k}$ for some $r/i$-module $\overline{k}$. write $f = \bigoplus_{\alpha \in a} r$ for the free $r$-module on $a$. choose a lift $p : f \to f$ of the projector $\overline{p}$ associated to the direct summand $\overline{p}$ of $\bigoplus_{\alpha \in a} r/i$. note that $p^2 - p \in \text{end}_r(f)$ is a nilpotent endomorphism of $f$ (as $i$ is nilpotent and the matrix entries of $p^2 - p$ are in $i$; more precisely, if $i^n = 0$, then $(p^2 - p)^n = 0$). hence by lemma \ref{lemma-lift-idempotents-noncommutative} we can modify our choice of $p$ and assume that $p$ is a projector. set $p = \im(p)$. \end{proof} \begin{lemma} \label{lemma-lift-finite-projective-module} let $r$ be a ring. let $i \subset r$ be a locally nilpotent ideal. let $\overline{p}$ be a finite projective $r/i$-module. then there exists a finite projective $r$-module $p$ such that $p/ip \cong \overline{p}$. \end{lemma} \begin{proof} recall that $\overline{p}$ is a direct summand of a free $r/i$-module $\bigoplus_{\alpha \in a} r/i$ by lemma \ref{lemma-characterize-projective}. as $\overline{p}$ is finite, it follows that $\overline{p}$ is contained in $\bigoplus_{\alpha \in a'} r/i$ for some $a' \subset a$ finite. hence we may assume we have a direct sum decomposition $(r/i)^{\oplus n} = \overline{p} \oplus \overline{k}$ for some $n$ and some $r/i$-module $\overline{k}$. choose a lift $p \in \text{mat}(n \times n, r)$ of the projector $\overline{p}$ associated to the direct summand $\overline{p}$ of $(r/i)^{\oplus n}$. note that $p^2 - p \in \text{mat}(n \times n, r)$ is nilpotent: as $i$ is locally nilpotent and the matrix entries $c_{ij}$ of $p^2 - p$ are in $i$ we have $c_{ij}^t = 0$ for some $t > 0$ and then $(p^2 - p)^{tn^2} = 0$ (by looking at the matrix coefficients). hence by lemma \ref{lemma-lift-idempotents-noncommutative} we can modify our choice of $p$ and assume that $p$ is a projector. set $p = \im(p)$. \end{proof} \begin{lemma} \label{lemma-lift-projective} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be an $r$-module. assume \begin{enumerate} \item $i$ is nilpotent, \item $m/im$ is a projective $r/i$-module, \item $m$ is a flat $r$-module. \end{enumerate} then $m$ is a projective $r$-module. \end{lemma} \begin{proof} by lemma \ref{lemma-lift-projective-module} we can find a projective $r$-module $p$ and an isomorphism $p/ip \to m/im$. we are going to show that $m$ is isomorphic to $p$ which will finish the proof. because $p$ is projective we can lift the map $p \to p/ip \to m/im$ to an $r$-module map $p \to m$ which is an isomorphism modulo $i$. since $i^n = 0$ for some $n$, we can use the filtrations \begin{align*} 0 = i^nm \subset i^{n - 1}m \subset \ldots \subset im \subset m \\ 0 = i^np \subset i^{n - 1}p \subset \ldots \subset ip \subset p \end{align*} to see that it suffices to show that the induced maps $i^ap/i^{a + 1}p \to i^am/i^{a + 1}m$ are bijective. since both $p$ and $m$ are flat $r$-modules we can identify this with the map $$ i^a/i^{a + 1} \otimes_{r/i} p/ip \longrightarrow i^a/i^{a + 1} \otimes_{r/i} m/im $$ induced by $p \to m$. since we chose $p \to m$ such that the induced map $p/ip \to m/im$ is an isomorphism, we win. \end{proof} \begin{lemma} \label{lemma-projective-modulo-two-ideals} let $r$ be a ring. let $i, j \subset r$ be ideals such that $i \cap j = 0$. let $p$ be an $r$-module such that $p/ip$ is a projective $r/i$-module and $p/jp$ is a projective $r/j$-module. then $p$ is a projective $r$-module. \end{lemma} \begin{proof} choose a surjection $p : f \to p$ where $f$ is a free $r$-module. since $p/ip$ is a projective $r/i$-module, we can choose a map $f : p/ip \to f/if$ which is a right inverse to $p \bmod i$. consider the map $q : f/jf \to f/(i + j)f \times_{p/(i + j)p} p/jp$ induced by the quotient map $f/jf \to f/(i + j)f$ and $p$. note that $q$ is a surjective map of $r/j$-modules (small detail omitted). consider the map $f' : p/jp \to f/(i + j)f \times_{p/(i + j)p} p/jp$ induced by $f$ and the identity map. since $p/jp$ is a projective $r/j$-module and $q$ surjective, we can choose a map $g : p/jp \to f/jf$ such that $q \circ g = f'$. then $f \bmod i + j = g \bmod i + j$. since $f = f/jf \times_{f/(i + j)f} f/if$ because $i \cap j = 0$, we conclude that we obtain a well defined homomorphism $h = (f, g) : p \to f$ of $r$-modules. the map $a = p \circ h : p \to p$ reduces to the identity modulo $i$ and modulo $j$. then $a$ also induces the identity map on the submodule $ip$: if $x = \sum i_\alpha x_\alpha$ with $i_\alpha \in i$ and $x_\alpha \in p$, then $a(x) = \sum i_\alpha a(x_\alpha) = \sum i_\alpha x_\alpha = x$ because $a(x_\alpha) = x_\alpha + j_\alpha$ with $j_\alpha \in j$ and $i_\alpha j_\alpha = 0$. thus $a : p \to p$ acts as the identity on $ip$ and on $p/ip$ and we conclude that $a$ is an automorphism of $p$ (small detail omitted). thus $p$ is a summand of $f$, whence projective. \end{proof} \section{finite projective modules} \label{section-finite-projective-modules} \begin{definition} \label{definition-locally-free} let $r$ be a ring and $m$ an $r$-module. \begin{enumerate} \item we say that $m$ is {\it locally free} if we can cover $\spec(r)$ by standard opens $d(f_i)$, $i \in i$ such that $m_{f_i}$ is a free $r_{f_i}$-module for all $i \in i$. \item we say that $m$ is {\it finite locally free} if we can choose the covering such that each $m_{f_i}$ is finite free. \item we say that $m$ is {\it finite locally free of rank $r$} if we can choose the covering such that each $m_{f_i}$ is isomorphic to $r_{f_i}^{\oplus r}$. \end{enumerate} \end{definition} \noindent note that a finite locally free $r$-module is automatically finitely presented by lemma \ref{lemma-cover}. moreover, if $m$ is a finite locally free module of rank $r$ over a ring $r$ and if $r$ is nonzero, then $r$ is uniquely determined by lemma \ref{lemma-rank} (because at least one of the localizations $ r_{f_i}$ is a nonzero ring). \begin{lemma} \label{lemma-finite-projective} let $r$ be a ring and let $m$ be an $r$-module. the following are equivalent \begin{enumerate} \item $m$ is finitely presented and $r$-flat, \item $m$ is finite projective, \item $m$ is a direct summand of a finite free $r$-module, \item $m$ is finitely presented and for all $\mathfrak p \in \spec(r)$ the localization $m_{\mathfrak p}$ is free, \item $m$ is finitely presented and for all maximal ideals $\mathfrak m \subset r$ the localization $m_{\mathfrak m}$ is free, \item $m$ is finite and locally free, \item $m$ is finite locally free, and \item $m$ is finite, for every prime $\mathfrak p$ the module $m_{\mathfrak p}$ is free, and the function $$ \rho_m : \spec(r) \to \mathbf{z}, \quad \mathfrak p \longmapsto \dim_{\kappa(\mathfrak p)} m \otimes_r \kappa(\mathfrak p) $$ is locally constant in the zariski topology. \end{enumerate} \end{lemma} \begin{proof} first suppose $m$ is finite projective, i.e., (2) holds. take a surjection $r^n \to m$ and let $k$ be the kernel. since $m$ is projective, $0 \to k \to r^n \to m \to 0$ splits. hence (2) $\rightarrow$ (3). the implication (3) $\rightarrow$ (2) follows from the fact that a direct summand of a projective is projective, see lemma \ref{lemma-characterize-projective}. \medskip\noindent assume (3), so we can write $k \oplus m \cong r^{\oplus n}$. so $k$ is a direct summand of $r^n$ and thus finitely generated. this shows $m = r^{\oplus n}/k$ is finitely presented. in other words, (3) $\rightarrow$ (1). \medskip\noindent assume $m$ is finitely presented and flat, i.e., (1) holds. we will prove that (7) holds. pick any prime $\mathfrak p$ and $x_1, \ldots, x_r \in m$ which map to a basis of $m \otimes_r \kappa(\mathfrak p)$. by nakayama's lemma (in the form of lemma \ref{lemma-nak-localization}) these elements generate $m_g$ for some $g \in r$, $g \not \in \mathfrak p$. the corresponding surjection $\varphi : r_g^{\oplus r} \to m_g$ has the following two properties: (a) $\ker(\varphi)$ is a finite $r_g$-module (see lemma \ref{lemma-extension}) and (b) $\ker(\varphi) \otimes \kappa(\mathfrak p) = 0$ by flatness of $m_g$ over $r_g$ (see lemma \ref{lemma-flat-tor-zero}). hence by nakayama's lemma again there exists a $g' \in r_g$ such that $\ker(\varphi)_{g'} = 0$. in other words, $m_{gg'}$ is free. \medskip\noindent a finite locally free module is a finite module, see lemma \ref{lemma-cover}, hence (7) $\rightarrow$ (6). it is clear that (6) $\rightarrow$ (7) and that (7) $\rightarrow$ (8). \medskip\noindent a finite locally free module is a finitely presented module, see lemma \ref{lemma-cover}, hence (7) $\rightarrow$ (4). of course (4) implies (5). since we may check flatness locally (see lemma \ref{lemma-flat-localization}) we conclude that (5) implies (1). at this point we have $$ \xymatrix{ (2) \ar@{<=>}[r] & (3) \ar@{=>}[r] & (1) \ar@{=>}[r] & (7) \ar@{<=>}[r] \ar@{=>}[rd] \ar@{=>}[d] & (6) \\ & & (5) \ar@{=>}[u] & (4) \ar@{=>}[l] & (8) } $$ \medskip\noindent suppose that $m$ satisfies (1), (4), (5), (6), and (7). we will prove that (3) holds. it suffices to show that $m$ is projective. we have to show that $\hom_r(m, -)$ is exact. let $0 \to n'' \to n \to n'\to 0$ be a short exact sequence of $r$-module. we have to show that $0 \to \hom_r(m, n'') \to \hom_r(m, n) \to \hom_r(m, n') \to 0$ is exact. as $m$ is finite locally free there exist a covering $\spec(r) = \bigcup d(f_i)$ such that $m_{f_i}$ is finite free. by lemma \ref{lemma-hom-from-finitely-presented} we see that $$ 0 \to \hom_r(m, n'')_{f_i} \to \hom_r(m, n)_{f_i} \to \hom_r(m, n')_{f_i} \to 0 $$ is equal to $0 \to \hom_{r_{f_i}}(m_{f_i}, n''_{f_i}) \to \hom_{r_{f_i}}(m_{f_i}, n_{f_i}) \to \hom_{r_{f_i}}(m_{f_i}, n'_{f_i}) \to 0$ which is exact as $m_{f_i}$ is free and as the localization $0 \to n''_{f_i} \to n_{f_i} \to n'_{f_i} \to 0$ is exact (as localization is exact). whence we see that $0 \to \hom_r(m, n'') \to \hom_r(m, n) \to \hom_r(m, n') \to 0$ is exact by lemma \ref{lemma-cover}. \medskip\noindent finally, assume that (8) holds. pick a maximal ideal $\mathfrak m \subset r$. pick $x_1, \ldots, x_r \in m$ which map to a $\kappa(\mathfrak m)$-basis of $m \otimes_r \kappa(\mathfrak m) = m/\mathfrak mm$. in particular $\rho_m(\mathfrak m) = r$. by nakayama's lemma \ref{lemma-nak} there exists an $f \in r$, $f \not \in \mathfrak m$ such that $x_1, \ldots, x_r$ generate $m_f$ over $r_f$. by the assumption that $\rho_m$ is locally constant there exists a $g \in r$, $g \not \in \mathfrak m$ such that $\rho_m$ is constant equal to $r$ on $d(g)$. we claim that $$ \psi : r_{fg}^{\oplus r} \longrightarrow m_{fg}, \quad (a_1, \ldots, a_r) \longmapsto \sum a_i x_i $$ is an isomorphism. this claim will show that $m$ is finite locally free, i.e., that (7) holds. to see the claim it suffices to show that the induced map on localizations $\psi_{\mathfrak p} : r_{\mathfrak p}^{\oplus r} \to m_{\mathfrak p}$ is an isomorphism for all $\mathfrak p \in d(fg)$, see lemma \ref{lemma-characterize-zero-local}. by our choice of $f$ the map $\psi_{\mathfrak p}$ is surjective. by assumption (8) we have $m_{\mathfrak p} \cong r_{\mathfrak p}^{\oplus \rho_m(\mathfrak p)}$ and by our choice of $g$ we have $\rho_m(\mathfrak p) = r$. hence $\psi_{\mathfrak p}$ determines a surjection $r_{\mathfrak p}^{\oplus r} \to m_{\mathfrak p} \cong r_{\mathfrak p}^{\oplus r}$ whence is an isomorphism by lemma \ref{lemma-fun}. (of course this last fact follows from a simple matrix argument also.) \end{proof} \begin{lemma} \label{lemma-finite-projective-reduced} let $r$ be a reduced ring and let $m$ be an $r$-module. then the equivalent conditions of lemma \ref{lemma-finite-projective} are also equivalent to \begin{enumerate} \item[(9)] $m$ is finite and the function $\rho_m : \spec(r) \to \mathbf{z}$, $\mathfrak p \mapsto \dim_{\kappa(\mathfrak p)} m \otimes_r \kappa(\mathfrak p)$ is locally constant in the zariski topology. \end{enumerate} \end{lemma} \begin{proof} pick a maximal ideal $\mathfrak m \subset r$. pick $x_1, \ldots, x_r \in m$ which map to a $\kappa(\mathfrak m)$-basis of $m \otimes_r \kappa(\mathfrak m) = m/\mathfrak mm$. in particular $\rho_m(\mathfrak m) = r$. by nakayama's lemma \ref{lemma-nak} there exists an $f \in r$, $f \not \in \mathfrak m$ such that $x_1, \ldots, x_r$ generate $m_f$ over $r_f$. by the assumption that $\rho_m$ is locally constant there exists a $g \in r$, $g \not \in \mathfrak m$ such that $\rho_m$ is constant equal to $r$ on $d(g)$. we claim that $$ \psi : r_{fg}^{\oplus r} \longrightarrow m_{fg}, \quad (a_1, \ldots, a_r) \longmapsto \sum a_i x_i $$ is an isomorphism. this claim will show that $m$ is finite locally free, i.e., that (7) holds. since $\psi$ is surjective, it suffices to show that $\psi$ is injective. since $r_{fg}$ is reduced, it suffices to show that $\psi$ is injective after localization at all minimal primes $\mathfrak p$ of $r_{fg}$, see lemma \ref{lemma-reduced-ring-sub-product-fields}. however, we know that $r_\mathfrak p = \kappa(\mathfrak p)$ by lemma \ref{lemma-minimal-prime-reduced-ring} and $\rho_m(\mathfrak p) = r$ hence $\psi_\mathfrak p : r_\mathfrak p^{\oplus r} \to m \otimes_r \kappa(\mathfrak p)$ is an isomorphism as a surjective map of finite dimensional vector spaces of the same dimension. \end{proof} \begin{remark} \label{remark-warning} it is not true that a finite $r$-module which is $r$-flat is automatically projective. a counter example is where $r = \mathcal{c}^\infty(\mathbf{r})$ is the ring of infinitely differentiable functions on $\mathbf{r}$, and $m = r_{\mathfrak m} = r/i$ where $\mathfrak m = \{f \in r \mid f(0) = 0\}$ and $i = \{f \in r \mid \exists \epsilon, \epsilon > 0 : f(x) = 0\ \forall x, |x| < \epsilon\}$. \end{remark} \begin{lemma} \label{lemma-finite-flat-local} (warning: see remark \ref{remark-warning}.) suppose $r$ is a local ring, and $m$ is a finite flat $r$-module. then $m$ is finite free. \end{lemma} \begin{proof} follows from the equational criterion of flatness, see lemma \ref{lemma-flat-eq}. namely, suppose that $x_1, \ldots, x_r \in m$ map to a basis of $m/\mathfrak mm$. by nakayama's lemma \ref{lemma-nak} these elements generate $m$. we want to show there is no relation among the $x_i$. instead, we will show by induction on $n$ that if $x_1, \ldots, x_n \in m$ are linearly independent in the vector space $m/\mathfrak mm$ then they are independent over $r$. \medskip\noindent the base case of the induction is where we have $x \in m$, $x \not\in \mathfrak mm$ and a relation $fx = 0$. by the equational criterion there exist $y_j \in m$ and $a_j \in r$ such that $x = \sum a_j y_j$ and $fa_j = 0$ for all $j$. since $x \not\in \mathfrak mm$ we see that at least one $a_j$ is a unit and hence $f = 0 $. \medskip\noindent suppose that $\sum f_i x_i$ is a relation among $x_1, \ldots, x_n$. by our choice of $x_i$ we have $f_i \in \mathfrak m$. according to the equational criterion of flatness there exist $a_{ij} \in r$ and $y_j \in m$ such that $x_i = \sum a_{ij} y_j$ and $\sum f_i a_{ij} = 0$. since $x_n \not \in \mathfrak mm$ we see that $a_{nj}\not\in \mathfrak m$ for at least one $j$. since $\sum f_i a_{ij} = 0$ we get $f_n = \sum_{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_i$. the relation $\sum f_i x_i = 0$ now can be rewritten as $\sum_{i = 1}^{n-1} f_i( x_i + (-a_{ij}/a_{nj}) x_n) = 0$. note that the elements $x_i + (-a_{ij}/a_{nj}) x_n$ map to $n-1$ linearly independent elements of $m/\mathfrak mm$. by induction assumption we get that all the $f_i$, $i \leq n-1$ have to be zero, and also $f_n = \sum_{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_i$. this proves the induction step. \end{proof} \begin{lemma} \label{lemma-finite-projective-descends} let $r \to s$ be a flat local homomorphism of local rings. let $m$ be a finite $r$-module. then $m$ is finite projective over $r$ if and only if $m \otimes_r s$ is finite projective over $s$. \end{lemma} \begin{proof} by lemma \ref{lemma-finite-projective} being finite projective over a local ring is the same thing as being finite free. suppose that $m \otimes_r s$ is a finite free $s$-module. pick $x_1, \ldots, x_r \in m$ whose images in $m/\mathfrak m_rm$ form a basis over $\kappa(\mathfrak m)$. then we see that $x_1 \otimes 1, \ldots, x_r \otimes 1$ are a basis for $m \otimes_r s$. this implies that the map $r^{\oplus r} \to m, (a_i) \mapsto \sum a_i x_i$ becomes an isomorphism after tensoring with $s$. by faithful flatness of $r \to s$, see lemma \ref{lemma-local-flat-ff} we see that it is an isomorphism. \end{proof} \begin{lemma} \label{lemma-locally-free-semi-local-free} let $r$ be a semi-local ring. let $m$ be a finite locally free module. if $m$ has constant rank, then $m$ is free. in particular, if $r$ has connected spectrum, then $m$ is free. \end{lemma} \begin{proof} omitted. hints: first show that $m/\mathfrak m_im$ has the same dimension $d$ for all maximal ideal $\mathfrak m_1, \ldots, \mathfrak m_n$ of $r$ using the rank is constant. next, show that there exist elements $x_1, \ldots, x_d \in m$ which form a basis for each $m/\mathfrak m_im$ by the chinese remainder theorem. finally show that $x_1, \ldots, x_d$ is a basis for $m$. \end{proof} \noindent here is a technical lemma that is used in the chapter on groupoids. \begin{lemma} \label{lemma-semi-local-module-basis-in-submodule} let $r$ be a local ring with maximal ideal $\mathfrak m$ and infinite residue field. let $r \to s$ be a ring map. let $m$ be an $s$-module and let $n \subset m$ be an $r$-submodule. assume \begin{enumerate} \item $s$ is semi-local and $\mathfrak ms$ is contained in the jacobson radical of $s$, \item $m$ is a finite free $s$-module, and \item $n$ generates $m$ as an $s$-module. \end{enumerate} then $n$ contains an $s$-basis of $m$. \end{lemma} \begin{proof} assume $m$ is free of rank $n$. let $i \subset s$ be the jacobson radical. by nakayama's lemma \ref{lemma-nak} a sequence of elements $m_1, \ldots, m_n$ is a basis for $m$ if and only if $\overline{m}_i \in m/im$ generate $m/im$. hence we may replace $m$ by $m/im$, $n$ by $n/(n \cap im)$, $r$ by $r/\mathfrak m$, and $s$ by $s/is$. in this case we see that $s$ is a finite product of fields $s = k_1 \times \ldots \times k_r$ and $m = k_1^{\oplus n} \times \ldots \times k_r^{\oplus n}$. the fact that $n \subset m$ generates $m$ as an $s$-module means that there exist $x_j \in n$ such that a linear combination $\sum a_j x_j$ with $a_j \in s$ has a nonzero component in each factor $k_i^{\oplus n}$. because $r = k$ is an infinite field, this means that also some linear combination $y = \sum c_j x_j$ with $c_j \in k$ has a nonzero component in each factor. hence $y \in n$ generates a free direct summand $sy \subset m$. by induction on $n$ the result holds for $m/sy$ and the submodule $\overline{n} = n/(n \cap sy)$. in other words there exist $\overline{y}_2, \ldots, \overline{y}_n$ in $\overline{n}$ which (freely) generate $m/sy$. then $y, y_2, \ldots, y_n$ (freely) generate $m$ and we win. \end{proof} \begin{lemma} \label{lemma-evaluation-map-iso-finite-projective} let $r$ be ring. let $l$, $m$, $n$ be $r$-modules. the canonical map $$ \hom_r(m, n) \otimes_r l \to \hom_r(m, n \otimes_r l) $$ is an isomorphism if $m$ is finite projective. \end{lemma} \begin{proof} by lemma \ref{lemma-finite-projective} we see that $m$ is finitely presented as well as finite locally free. by lemmas \ref{lemma-hom-from-finitely-presented} and \ref{lemma-tensor-product-localization} formation of the left and right hand side of the arrow commutes with localization. we may check that our map is an isomorphism after localization, see lemma \ref{lemma-cover}. thus we may assume $m$ is finite free. in this case the lemma is immediate. \end{proof} \section{open loci defined by module maps} \label{section-loci-maps} \noindent the set of primes where a given module map is surjective, or an isomorphism is sometimes open. in the case of finite projective modules we can look at the rank of the map. \begin{lemma} \label{lemma-map-between-finite} let $r$ be a ring. let $\varphi : m \to n$ be a map of $r$-modules with $n$ a finite $r$-module. then we have the equality \begin{align*} u & = \{\mathfrak p \subset r \mid \varphi_{\mathfrak p} : m_{\mathfrak p} \to n_{\mathfrak p} \text{ is surjective}\} \\ & = \{\mathfrak p \subset r \mid \varphi \otimes \kappa(\mathfrak p) : m \otimes \kappa(\mathfrak p) \to n \otimes \kappa(\mathfrak p) \text{ is surjective}\} \end{align*} and $u$ is an open subset of $\spec(r)$. moreover, for any $f \in r$ such that $d(f) \subset u$ the map $m_f \to n_f$ is surjective. \end{lemma} \begin{proof} the equality in the displayed formula follows from nakayama's lemma. nakayama's lemma also implies that $u$ is open. see lemma \ref{lemma-nak} especially part (3). if $d(f) \subset u$, then $m_f \to n_f$ is surjective on all localizations at primes of $r_f$, and hence it is surjective by lemma \ref{lemma-characterize-zero-local}. \end{proof} \begin{lemma} \label{lemma-map-between-finitely-presented} let $r$ be a ring. let $\varphi : m \to n$ be a map of $r$-modules with $m$ finite and $n$ finitely presented. then $$ u = \{\mathfrak p \subset r \mid \varphi_{\mathfrak p} : m_{\mathfrak p} \to n_{\mathfrak p} \text{ is an isomorphism}\} $$ is an open subset of $\spec(r)$. \end{lemma} \begin{proof} let $\mathfrak p \in u$. pick a presentation $n = r^{\oplus n}/\sum_{j = 1, \ldots, m} r k_j$. denote $e_i$ the image in $n$ of the $i$th basis vector of $r^{\oplus n}$. for each $i \in \{1, \ldots, n\}$ choose an element $m_i \in m_{\mathfrak p}$ such that $\varphi(m_i) = f_i e_i$ for some $f_i \in r$, $f_i \not \in \mathfrak p$. this is possible as $\varphi_{\mathfrak p}$ is an isomorphism. set $f = f_1 \ldots f_n$ and let $\psi : r_f^{\oplus n} \to m_f$ be the map which maps the $i$th basis vector to $m_i/f_i$. note that $\varphi_f \circ \psi$ is the localization at $f$ of the given map $r^{\oplus n} \to n$. as $\varphi_{\mathfrak p}$ is an isomorphism we see that $\psi(k_j)$ is an element of $m$ which maps to zero in $m_{\mathfrak p}$. hence we see that there exist $g_j \in r$, $g_j \not \in \mathfrak p$ such that $g_j \psi(k_j) = 0$. setting $g = g_1 \ldots g_m$, we see that $\psi_g$ factors through $n_{fg}$ to give a map $\chi : n_{fg} \to m_{fg}$. by construction $\chi$ is a right inverse to $\varphi_{fg}$. it follows that $\chi_\mathfrak p$ is an isomorphism. by lemma \ref{lemma-map-between-finite} there is an $h \in r$, $h \not \in \mathfrak p$ such that $\chi_h : n_{fgh} \to m_{fgh}$ is surjective. hence $\varphi_{fgh}$ and $\chi_h$ are mutually inverse maps, which implies that $d(fgh) \subset u$ as desired. \end{proof} \begin{lemma} \label{lemma-finitely-presented-localization-free} let $r$ be a ring. let $\mathfrak p \subset r$ be a prime. let $m$ be a finitely presented $r$-module. if $m_\mathfrak p$ is free, then there is an $f \in r$, $f \not \in \mathfrak p$ such that $m_f$ is a free $r_f$-module. \end{lemma} \begin{proof} choose a basis $x_1, \ldots, x_n \in m_\mathfrak p$. we can choose an $f \in r$, $f \not \in \mathfrak p$ such that $x_i$ is the image of some $y_i \in m_f$. after replacing $y_i$ by $f^m y_i$ for $m \gg 0$ we may assume $y_i \in m$. namely, this replaces $x_1, \ldots, x_n$ by $f^mx_1, \ldots, f^mx_n$ which is still a basis as $f$ maps to a unit in $r_\mathfrak p$. hence we obtain a homomorphism $\varphi = (y_1, \ldots, y_n) : r^{\oplus n} \to m$ of $r$-modules whose localization at $\mathfrak p$ is an isomorphism. by lemma \ref{lemma-map-between-finitely-presented} we can find an $f \in r$, $f \not \in \mathfrak p$ such that $\varphi_\mathfrak q$ is an isomorphism for all primes $\mathfrak q \subset r$ with $f \not \in \mathfrak q$. then it follows from lemma \ref{lemma-characterize-zero-local} that $\varphi_f$ is an isomorphism and the proof is complete. \end{proof} \begin{lemma} \label{lemma-cokernel-flat} let $r$ be a ring. let $\varphi : p_1 \to p_2$ be a map of finite projective modules. then \begin{enumerate} \item the set $u$ of primes $\mathfrak p \in \spec(r)$ such that $\varphi \otimes \kappa(\mathfrak p)$ is injective is open and for any $f\in r$ such that $d(f) \subset u$ we have \begin{enumerate} \item $p_{1, f} \to p_{2, f}$ is injective, and \item the module $\coker(\varphi)_f$ is finite projective over $r_f$. \end{enumerate} \item the set $w$ of primes $\mathfrak p \in \spec(r)$ such that $\varphi \otimes \kappa(\mathfrak p)$ is surjective is open and for any $f\in r$ such that $d(f) \subset w$ we have \begin{enumerate} \item $p_{1, f} \to p_{2, f}$ is surjective, and \item the module $\ker(\varphi)_f$ is finite projective over $r_f$. \end{enumerate} \item the set $v$ of primes $\mathfrak p \in \spec(r)$ such that $\varphi \otimes \kappa(\mathfrak p)$ is an isomorphism is open and for any $f\in r$ such that $d(f) \subset v$ the map $\varphi : p_{1, f} \to p_{2, f}$ is an isomorphism of modules over $r_f$. \end{enumerate} \end{lemma} \begin{proof} to prove the set $u$ is open we may work locally on $\spec(r)$. thus we may replace $r$ by a suitable localization and assume that $p_1 = r^{n_1}$ and $p_2 = r^{n_2}$, see lemma \ref{lemma-finite-projective}. in this case injectivity of $\varphi \otimes \kappa(\mathfrak p)$ is equivalent to $n_1 \leq n_2$ and some $n_1 \times n_1$ minor $f$ of the matrix of $\varphi$ being invertible in $\kappa(\mathfrak p)$. thus $d(f) \subset u$. this argument also shows that $p_{1, \mathfrak p} \to p_{2, \mathfrak p}$ is injective for $\mathfrak p \in u$. \medskip\noindent now suppose $d(f) \subset u$. by the remark in the previous paragraph and lemma \ref{lemma-characterize-zero-local} we see that $p_{1, f} \to p_{2, f}$ is injective, i.e., (1)(a) holds. by lemma \ref{lemma-finite-projective} to prove (1)(b) it suffices to prove that $\coker(\varphi)$ is finite projective locally on $d(f)$. thus, as we saw above, we may assume that $p_1 = r^{n_1}$ and $p_2 = r^{n_2}$ and that some minor of the matrix of $\varphi$ is invertible in $r$. if the minor in question corresponds to the first $n_1$ basis vectors of $r^{n_2}$, then using the last $n_2 - n_1$ basis vectors we get a map $r^{n_2 - n_1} \to r^{n_2} \to \coker(\varphi)$ which is easily seen to be an isomorphism. \medskip\noindent openness of $w$ and (2)(a) for $d(f) \subset w$ follow from lemma \ref{lemma-map-between-finite}. since $p_{2, f}$ is projective over $r_f$ we see that $\varphi_f : p_{1, f} \to p_{2, f}$ has a section and it follows that $\ker(\varphi)_f$ is a direct summand of $p_{2, f}$. therefore $\ker(\varphi)_f$ is finite projective. thus (2)(b) holds as well. \medskip\noindent it is clear that $v = u \cap w$ is open and the other statement in (3) follows from (1)(a) and (2)(a). \end{proof} \section{faithfully flat descent for projectivity of modules} \label{section-ffdescent-projectivity-introduction} \medskip\noindent in the next few sections we prove, following raynaud and gruson \cite{gruray}, that the projectivity of modules descends along faithfully flat ring maps. the idea of the proof is to use d\'evissage \`a la kaplansky \cite{kaplansky} to reduce to the case of countably generated modules. given a well-behaved filtration of a module $m$, d\'evissage allows us to express $m$ as a direct sum of successive quotients of the filtering submodules (see section \ref{section-transfinite-devissage}). using this technique, we prove that a projective module is a direct sum of countably generated modules (theorem \ref{theorem-projective-direct-sum}). to prove descent of projectivity for countably generated modules, we introduce a ``mittag-leffler'' condition on modules, prove that a countably generated module is projective if and only if it is flat and mittag-leffler (theorem \ref{theorem-projectivity-characterization}), and then show that the property of being a mittag-leffler module descends (lemma \ref{lemma-ffdescent-ml}). finally, given an arbitrary module $m$ whose base change by a faithfully flat ring map is projective, we filter $m$ by submodules whose successive quotients are countably generated projective modules, and then by d\'evissage conclude $m$ is a direct sum of projectives, hence projective itself (theorem \ref{theorem-ffdescent-projectivity}). \medskip\noindent we note that there is an error in the proof of faithfully flat descent of projectivity in \cite{gruray}. there, descent of projectivity along faithfully flat ring maps is deduced from descent of projectivity along a more general type of ring map (\cite[example 3.1.4(1) of part ii]{gruray}). however, the proof of descent along this more general type of map is incorrect. in \cite{g}, gruson explains what went wrong, although he does not provide a fix for the case of interest. patching this hole in the proof of faithfully flat descent of projectivity comes down to proving that the property of being a mittag-leffler module descends along faithfully flat ring maps. we do this in lemma \ref{lemma-ffdescent-ml}. \section{characterizing flatness} \label{section-characterize-flatness} \noindent in this section we discuss criteria for flatness. the main result in this section is lazard's theorem (theorem \ref{theorem-lazard} below), which says that a flat module is the colimit of a directed system of free finite modules. we remind the reader of the ``equational criterion for flatness'', see lemma \ref{lemma-flat-eq}. it turns out that this can be massaged into a seemingly much stronger property. \begin{lemma} \label{lemma-flat-factors-free} let $m$ be an $r$-module. the following are equivalent: \begin{enumerate} \item $m$ is flat. \item if $f: r^n \to m$ is a module map and $x \in \ker(f)$, then there are module maps $h: r^n \to r^m$ and $g: r^m \to m$ such that $f = g \circ h$ and $x \in \ker(h)$. \item suppose $f: r^n \to m$ is a module map, $n \subset \ker(f)$ any submodule, and $h: r^n \to r^{m}$ a map such that $n \subset \ker(h)$ and $f$ factors through $h$. then given any $x \in \ker(f)$ we can find a map $h': r^n \to r^{m'}$ such that $n + rx \subset \ker(h')$ and $f$ factors through $h'$. \item if $f: r^n \to m$ is a module map and $n \subset \ker(f)$ is a finitely generated submodule, then there are module maps $h: r^n \to r^m$ and $g: r^m \to m$ such that $f = g \circ h$ and $n \subset \ker(h)$. \end{enumerate} \end{lemma} \begin{proof} that (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness\footnote{in fact, a module map $f : r^n \to m$ corresponds to a choice of elements $x_1, x_2, \ldots, x_n$ of $m$ (namely, the images of the standard basis elements $e_1, e_2, \ldots, e_n$); furthermore, an element $x \in \ker(f)$ corresponds to a relation between these $x_1, x_2, \ldots, x_n$ (namely, the relation $\sum_i f_i x_i = 0$, where the $f_i$ are the coordinates of $x$). the module map $h$ (represented as an $m \times n$-matrix) corresponds to the matrix $(a_{ij})$ from lemma \ref{lemma-flat-eq}, and the $y_j$ of lemma \ref{lemma-flat-eq} are the images of the standard basis vectors of $r^m$ under $g$.}. to show (2) implies (3), let $g: r^m \to m$ be the map such that $f$ factors as $f = g \circ h$. by (2) find $h'': r^m \to r^{m'}$ such that $h''$ kills $h(x)$ and $g: r^m \to m$ factors through $h''$. then taking $h' = h'' \circ h$ works. (3) implies (4) by induction on the number of generators of $n \subset \ker(f)$ in (4). clearly (4) implies (2). \end{proof} \begin{lemma} \label{lemma-flat-factors-fp} let $m$ be an $r$-module. then $m$ is flat if and only if the following condition holds: if $p$ is a finitely presented $r$-module and $f: p \to m$ a module map, then there is a free finite $r$-module $f$ and module maps $h: p \to f$ and $g: f \to m$ such that $f = g \circ h$. \end{lemma} \begin{proof} this is just a reformulation of condition (4) from lemma \ref{lemma-flat-factors-free}. \end{proof} \begin{lemma} \label{lemma-flat-surjective-hom} let $m$ be an $r$-module. then $m$ is flat if and only if the following condition holds: for every finitely presented $r$-module $p$, if $n \to m$ is a surjective $r$-module map, then the induced map $\hom_r(p, n) \to \hom_r(p, m)$ is surjective. \end{lemma} \begin{proof} first suppose $m$ is flat. we must show that if $p$ is finitely presented, then given a map $f: p \to m$, it factors through the map $n \to m$. by lemma \ref{lemma-flat-factors-fp} the map $f$ factors through a map $f \to m$ where $f$ is free and finite. since $f$ is free, this map factors through $n \to m$. thus $f$ factors through $n \to m$. \medskip\noindent conversely, suppose the condition of the lemma holds. let $f: p \to m$ be a map from a finitely presented module $p$. choose a free module $n$ with a surjection $n \to m$ onto $m$. then $f$ factors through $n \to m$, and since $p$ is finitely generated, $f$ factors through a free finite submodule of $n$. thus $m$ satisfies the condition of lemma \ref{lemma-flat-factors-fp}, hence is flat. \end{proof} \begin{theorem}[lazard's theorem] \label{theorem-lazard} let $m$ be an $r$-module. then $m$ is flat if and only if it is the colimit of a directed system of free finite $r$-modules. \end{theorem} \begin{proof} a colimit of a directed system of flat modules is flat, as taking directed colimits is exact and commutes with tensor product. hence if $m$ is the colimit of a directed system of free finite modules then $m$ is flat. \medskip\noindent for the converse, first recall that any module $m$ can be written as the colimit of a directed system of finitely presented modules, in the following way. choose a surjection $f: r^i \to m$ for some set $i$, and let $k$ be the kernel. let $e$ be the set of ordered pairs $(j, n)$ where $j$ is a finite subset of $i$ and $n$ is a finitely generated submodule of $r^j \cap k$. then $e$ is made into a directed partially ordered set by defining $(j, n) \leq (j', n')$ if and only if $j \subset j'$ and $n \subset n'$. define $m_e = r^j/n$ for $e = (j, n)$, and define $f_{ee'}: m_e \to m_{e'}$ to be the natural map for $e \leq e'$. then $(m_e, f_{ee'})$ is a directed system and the natural maps $f_e: m_e \to m$ induce an isomorphism $\colim_{e \in e} m_e \xrightarrow{\cong} m$. \medskip\noindent now suppose $m$ is flat. let $i = m \times \mathbf{z}$, write $(x_i)$ for the canonical basis of $r^{i}$, and take in the above discussion $f: r^i \to m$ to be the map sending $x_i$ to the projection of $i$ onto $m$. to prove the theorem it suffices to show that the $e \in e$ such that $m_e$ is free form a cofinal subset of $e$. so let $e = (j, n) \in e$ be arbitrary. by lemma \ref{lemma-flat-factors-fp} there is a free finite module $f$ and maps $h: r^j/n \to f$ and $g: f \to m$ such that the natural map $f_e: r^j/n \to m$ factors as $r^j/n \xrightarrow{h} f \xrightarrow{g} m$. we are going to realize $f$ as $m_{e'}$ for some $e' \geq e$. \medskip\noindent let $\{ b_1, \ldots, b_n \}$ be a finite basis of $f$. choose $n$ distinct elements $i_1, \ldots, i_n \in i$ such that $i_{\ell} \notin j$ for all $\ell$, and such that the image of $x_{i_{\ell}}$ under $f: r^i \to m$ equals the image of $b_{\ell}$ under $g: f \to m$. this is possible since every element of $m$ can be written as $f(x_i)$ for infinitely many distinct $i \in i$ (by our choice of $i$). now let $j' = j \cup \{i_1, \ldots , i_n \}$, and define $r^{j'} \to f$ by $x_i \mapsto h(x_i)$ for $i \in j$ and $x_{i_{\ell}} \mapsto b_{\ell}$ for $\ell = 1, \ldots, n$. let $n' = \ker(r^{j'} \to f)$. observe: \begin{enumerate} \item the square $$ \xymatrix{ r^{j'} \ar[r] \ar@{^{(}->}[d] & f \ar[d]^{g} \\ r^{i} \ar[r]_{f} & m } $$ is commutative, %$r^{j'} \to f$ factors $f: r^i \to m$, hence $n' \subset k = \ker(f)$; \item $r^{j'} \to f$ is a surjection onto a free finite module, hence it splits and so $n'$ is finitely generated; \item $j \subset j'$ and $n \subset n'$. \end{enumerate} by (1) and (2) $e' = (j', n')$ is in $e$, by (3) $e' \geq e$, and by construction $m_{e'} = r^{j'}/n' \cong f$ is free. \end{proof} \section{universally injective module maps} \label{section-universally-injective} \noindent next we discuss universally injective module maps, which are in a sense complementary to flat modules (see lemma \ref{lemma-flat-universally-injective}). we follow lazard's thesis \cite{autour}; also see \cite{lam}. \begin{definition} \label{definition-universally-injective} let $f: m \to n$ be a map of $r$-modules. then $f$ is called {\it universally injective} if for every $r$-module $q$, the map $f \otimes_r \text{id}_q: m \otimes_r q \to n \otimes_r q$ is injective. a sequence $0 \to m_1 \to m_2 \to m_3 \to 0$ of $r$-modules is called {\it universally exact} if it is exact and $m_1 \to m_2$ is universally injective. \end{definition} \begin{example} \label{example-universally-exact} examples of universally exact sequences. \begin{enumerate} \item a split short exact sequence is universally exact since tensoring commutes with taking direct sums. \item the colimit of a directed system of universally exact sequences is universally exact. this follows from the fact that taking directed colimits is exact and that tensoring commutes with taking colimits. in particular the colimit of a directed system of split exact sequences is universally exact. we will see below that, conversely, any universally exact sequence arises in this way. \end{enumerate} \end{example} \noindent next we give a list of criteria for a short exact sequence to be universally exact. they are analogues of criteria for flatness given above. parts (3)-(6) below correspond, respectively, to the criteria for flatness given in lemmas \ref{lemma-flat-eq}, \ref{lemma-flat-factors-free}, \ref{lemma-flat-surjective-hom}, and theorem \ref{theorem-lazard}. \begin{theorem} \label{theorem-universally-exact-criteria} let $$ 0 \to m_1 \xrightarrow{f_1} m_2 \xrightarrow{f_2} m_3 \to 0 $$ be an exact sequence of $r$-modules. the following are equivalent: \begin{enumerate} \item the sequence $0 \to m_1 \to m_2 \to m_3 \to 0$ is universally exact. \item for every finitely presented $r$-module $q$, the sequence $$ 0 \to m_1 \otimes_r q \to m_2 \otimes_r q \to m_3 \otimes_r q \to 0 $$ is exact. \item given elements $x_i \in m_1$ $(i = 1, \ldots, n)$, $y_j \in m_2$ $(j = 1, \ldots, m)$, and $a_{ij} \in r$ $(i = 1, \ldots, n, j = 1, \ldots, m)$ such that for all $i$ $$ f_1(x_i) = \sum\nolimits_j a_{ij} y_j, $$ there exists $z_j \in m_1$ $(j =1, \ldots, m)$ such that for all $i$, $$ x_i = \sum\nolimits_j a_{ij} z_j . $$ \item given a commutative diagram of $r$-module maps $$ \xymatrix{ r^n \ar[r] \ar[d] & r^m \ar[d] \\ m_1 \ar[r]^{f_1} & m_2 } $$ where $m$ and $n$ are integers, there exists a map $r^m \to m_1$ making the top triangle commute. \item for every finitely presented $r$-module $p$, the $r$-module map $\hom_r(p, m_2) \to \hom_r(p, m_3)$ is surjective. \item the sequence $0 \to m_1 \to m_2 \to m_3 \to 0$ is the colimit of a directed system of split exact sequences of the form $$ 0 \to m_{1} \to m_{2, i} \to m_{3, i} \to 0 $$ where the $m_{3, i}$ are finitely presented. \end{enumerate} \end{theorem} \begin{proof} obviously (1) implies (2). \medskip\noindent next we show (2) implies (3). let $f_1(x_i) = \sum_j a_{ij} y_j$ be relations as in (3). let $(d_j)$ be a basis for $r^m$, $(e_i)$ a basis for $r^n$, and $r^m \to r^n$ the map given by $d_j \mapsto \sum_i a_{ij} e_i$. let $q$ be the cokernel of $r^m \to r^n$. then tensoring $r^m \to r^n \to q \to 0$ by the map $f_1: m_1 \to m_2$, we get a commutative diagram $$ \xymatrix{ m_1^{\oplus m} \ar[r] \ar[d] & m_1^{\oplus n} \ar[r] \ar[d] & m_1 \otimes_r q \ar[r] \ar[d] & 0 \\ m_2^{\oplus m} \ar[r] & m_2^{\oplus n} \ar[r] & m_2 \otimes_r q \ar[r] & 0 } $$ where $m_1^{\oplus m} \to m_1^{\oplus n}$ is given by $$ (z_1, \ldots, z_m) \mapsto (\sum\nolimits_j a_{1j} z_j, \ldots, \sum\nolimits_j a_{nj} z_j), $$ and $m_2^{\oplus m} \to m_2^{\oplus n}$ is given similarly. we want to show $x = (x_1, \ldots, x_n) \in m_1^{\oplus n}$ is in the image of $m_1^{\oplus m} \to m_1^{\oplus n}$. by (2) the map $m_1 \otimes q \to m_2 \otimes q$ is injective, hence by exactness of the top row it is enough to show $x$ maps to $0$ in $m_2 \otimes q$, and so by exactness of the bottom row it is enough to show the image of $x$ in $m_2^{\oplus n}$ is in the image of $m_2^{\oplus m} \to m_2^{\oplus n}$. this is true by assumption. \medskip\noindent condition (4) is just a translation of (3) into diagram form. \medskip\noindent next we show (4) implies (5). let $\varphi : p \to m_3$ be a map from a finitely presented $r$-module $p$. we must show that $\varphi$ lifts to a map $p \to m_2$. choose a presentation of $p$, $$ r^n \xrightarrow{g_1} r^m \xrightarrow{g_2} p \to 0. $$ using freeness of $r^n$ and $r^m$, we can construct $h_2: r^m \to m_2$ and then $h_1: r^n \to m_1$ such that the following diagram commutes $$ \xymatrix{ & r^n \ar[r]^{g_1} \ar[d]^{h_1} & r^m \ar[r]^{g_2} \ar[d]^{h_2} & p \ar[r] \ar[d]^{\varphi} & 0 \\ 0 \ar[r] & m_1 \ar[r]^{f_1} & m_2 \ar[r]^{f_2} & m_3 \ar[r] & 0 . } $$ by (4) there is a map $k_1: r^m \to m_1$ such that $k_1 \circ g_1 = h_1$. now define $h'_2: r^m \to m_2$ by $h_2' = h_2 - f_1 \circ k_1$. then $$ h'_2 \circ g_1 = h_2 \circ g_1 - f_1 \circ k_1 \circ g_1 = h_2 \circ g_1 - f_1 \circ h_1 = 0 . $$ hence by passing to the quotient $h'_2$ defines a map $\varphi': p \to m_2$ such that $\varphi' \circ g_2 = h_2'$. in a diagram, we have $$ \xymatrix{ r^m \ar[r]^{g_2} \ar[d]_{h'_2} & p \ar[d]^{\varphi} \ar[dl]_{\varphi'} \\ m_2 \ar[r]^{f_2} & m_3. } $$ where the top triangle commutes. we claim that $\varphi'$ is the desired lift, i.e.\ that $f_2 \circ \varphi' = \varphi$. from the definitions we have $$ f_2 \circ \varphi' \circ g_2 = f_2 \circ h'_2 = f_2 \circ h_2 - f_2 \circ f_1 \circ k_1 = f_2 \circ h_2 = \varphi \circ g_2. $$ since $g_2$ is surjective, this finishes the proof. \medskip\noindent now we show (5) implies (6). write $m_{3}$ as the colimit of a directed system of finitely presented modules $m_{3, i}$, see lemma \ref{lemma-module-colimit-fp}. let $m_{2, i}$ be the fiber product of $m_{3, i}$ and $m_{2}$ over $m_{3}$---by definition this is the submodule of $m_2 \times m_{3, i}$ consisting of elements whose two projections onto $m_3$ are equal. let $m_{1, i}$ be the kernel of the projection $m_{2, i} \to m_{3, i}$. then we have a directed system of exact sequences $$ 0 \to m_{1, i} \to m_{2, i} \to m_{3, i} \to 0, $$ and for each $i$ a map of exact sequences $$ \xymatrix{ 0 \ar[r] & m_{1, i} \ar[d] \ar[r] & m_{2, i} \ar[r] \ar[d] & m_{3, i} \ar[d] \ar[r] & 0 \\ 0 \ar[r] & m_{1} \ar[r] & m_{2} \ar[r] & m_{3} \ar[r] & 0 } $$ compatible with the directed system. from the definition of the fiber product $m_{2, i}$, it follows that the map $m_{1, i} \to m_1$ is an isomorphism. by (5) there is a map $m_{3, i} \to m_{2}$ lifting $m_{3, i} \to m_3$, and by the universal property of the fiber product this gives rise to a section of $m_{2, i} \to m_{3, i}$. hence the sequences $$ 0 \to m_{1, i} \to m_{2, i} \to m_{3, i} \to 0 $$ split. passing to the colimit, we have a commutative diagram $$ \xymatrix{ 0 \ar[r] & \colim m_{1, i} \ar[d]^{\cong} \ar[r] & \colim m_{2, i} \ar[r] \ar[d] & \colim m_{3, i} \ar[d]^{\cong} \ar[r] & 0 \\ 0 \ar[r] & m_{1} \ar[r] & m_{2} \ar[r] & m_{3} \ar[r] & 0 } $$ with exact rows and outer vertical maps isomorphisms. hence $\colim m_{2, i} \to m_2$ is also an isomorphism and (6) holds. \medskip\noindent condition (6) implies (1) by example \ref{example-universally-exact} (2). \end{proof} \noindent the previous theorem shows that a universally exact sequence is always a colimit of split short exact sequences. if the cokernel of a universally injective map is finitely presented, then in fact the map itself splits: \begin{lemma} \label{lemma-universally-exact-split} let $$ 0 \to m_1 \to m_2 \to m_3 \to 0 $$ be an exact sequence of $r$-modules. suppose $m_3$ is of finite presentation. then $$ 0 \to m_1 \to m_2 \to m_3 \to 0 $$ is universally exact if and only if it is split. \end{lemma} \begin{proof} a split short exact sequence is always universally exact, see example \ref{example-universally-exact}. conversely, if the sequence is universally exact, then by theorem \ref{theorem-universally-exact-criteria} (5) applied to $p = m_3$, the map $m_2 \to m_3$ admits a section. \end{proof} \noindent the following lemma shows how universally injective maps are complementary to flat modules. \begin{lemma} \label{lemma-flat-universally-injective} let $m$ be an $r$-module. then $m$ is flat if and only if any exact sequence of $r$-modules $$ 0 \to m_1 \to m_2 \to m \to 0 $$ is universally exact. \end{lemma} \begin{proof} this follows from lemma \ref{lemma-flat-surjective-hom} and theorem \ref{theorem-universally-exact-criteria} (5). \end{proof} \begin{example} \label{example-universally-exact-non-split-non-flat} non-split and non-flat universally exact sequences. \begin{enumerate} \item in spite of lemma \ref{lemma-universally-exact-split}, it is possible to have a short exact sequence of $r$-modules $$ 0 \to m_1 \to m_2 \to m_3 \to 0 $$ that is universally exact but non-split. for instance, take $r = \mathbf{z}$, let $m_1 = \bigoplus_{n=1}^{\infty} \mathbf{z}$, let $m_{2} = \prod_{n = 1}^{\infty} \mathbf{z}$, and let $m_{3}$ be the cokernel of the inclusion $m_1 \to m_2$. then $m_1, m_2, m_3$ are all flat since they are torsion-free (more on algebra, lemma \ref{more-algebra-lemma-dedekind-torsion-free-flat}), so by lemma \ref{lemma-flat-universally-injective}, $$ 0 \to m_1 \to m_2 \to m_3 \to 0 $$ is universally exact. however there can be no section $s: m_3 \to m_2$. in fact, if $x$ is the image of $(2, 2^2, 2^3, \ldots) \in m_2$ in $m_3$, then any module map $s: m_3 \to m_2$ must kill $x$. this is because $x \in 2^n m_3$ for any $n \geq 1$, hence $s(x)$ is divisible by $2^n$ for all $n \geq 1$ and so must be $0$. \item in spite of lemma \ref{lemma-flat-universally-injective}, it is possible to have a short exact sequence of $r$-modules $$ 0 \to m_1 \to m_2 \to m_3 \to 0 $$ that is universally exact but with $m_1, m_2, m_3$ all non-flat. in fact if $m$ is any non-flat module, just take the split exact sequence $$ 0 \to m \to m \oplus m \to m \to 0. $$ for instance over $r = \mathbf{z}$, take $m$ to be any torsion module. \item taking the direct sum of an exact sequence as in (1) with one as in (2), we get a short exact sequence of $r$-modules $$ 0 \to m_1 \to m_2 \to m_3 \to 0 $$ that is universally exact, non-split, and such that $m_1, m_2, m_3$ are all non-flat. \end{enumerate} \end{example} \begin{lemma} \label{lemma-ui-flat-domain} let $0 \to m_1 \to m_2 \to m_3 \to 0$ be a universally exact sequence of $r$-modules, and suppose $m_2$ is flat. then $m_1$ and $m_3$ are flat. \end{lemma} \begin{proof} let $0 \to n \to n' \to n'' \to 0$ be a short exact sequence of $r$-modules. consider the commutative diagram $$ \xymatrix{ m_1 \otimes_r n \ar[r] \ar[d] & m_2 \otimes_r n \ar[r] \ar[d] & m_3 \otimes_r n \ar[d] \\ m_1 \otimes_r n' \ar[r] \ar[d] & m_2 \otimes_r n' \ar[r] \ar[d] & m_3 \otimes_r n' \ar[d] \\ m_1 \otimes_r n'' \ar[r] & m_2 \otimes_r n'' \ar[r] & m_3 \otimes_r n'' } $$ (we have dropped the $0$'s on the boundary). by assumption the rows give short exact sequences and the arrow $m_2 \otimes n \to m_2 \otimes n'$ is injective. clearly this implies that $m_1 \otimes n \to m_1 \otimes n'$ is injective and we see that $m_1$ is flat. in particular the left and middle columns give rise to short exact sequences. it follows from a diagram chase that the arrow $m_3 \otimes n \to m_3 \otimes n'$ is injective. hence $m_3$ is flat. \end{proof} \begin{lemma} \label{lemma-universally-injective-tensor} let $r$ be a ring. let $m \to m'$ be a universally injective $r$-module map. then for any $r$-module $n$ the map $m \otimes_r n \to m' \otimes_r n$ is universally injective. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-composition-universally-injective} let $r$ be a ring. a composition of universally injective $r$-module maps is universally injective. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-universally-injective-permanence} let $r$ be a ring. let $m \to m'$ and $m' \to m''$ be $r$-module maps. if their composition $m \to m''$ is universally injective, then $m \to m'$ is universally injective. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-faithfully-flat-universally-injective} let $r \to s$ be a faithfully flat ring map. then $r \to s$ is universally injective as a map of $r$-modules. in particular $r \cap is = i$ for any ideal $i \subset r$. \end{lemma} \begin{proof} let $n$ be an $r$-module. we have to show that $n \to n \otimes_r s$ is injective. as $s$ is faithfully flat as an $r$-module, it suffices to prove this after tensoring with $s$. hence it suffices to show that $n \otimes_r s \to n \otimes_r s \otimes_r s$, $n \otimes s \mapsto n \otimes 1 \otimes s$ is injective. this is true because there is a retraction, namely, $n \otimes s \otimes s' \mapsto n \otimes ss'$. \end{proof} \begin{lemma} \label{lemma-universally-injective-check-stalks} let $r \to s$ be a ring map. let $m \to m'$ be a map of $s$-modules. the following are equivalent \begin{enumerate} \item $m \to m'$ is universally injective as a map of $r$-modules, \item for each prime $\mathfrak q$ of $s$ the map $m_{\mathfrak q} \to m'_{\mathfrak q}$ is universally injective as a map of $r$-modules, \item for each maximal ideal $\mathfrak m$ of $s$ the map $m_{\mathfrak m} \to m'_{\mathfrak m}$ is universally injective as a map of $r$-modules, \item for each prime $\mathfrak q$ of $s$ the map $m_{\mathfrak q} \to m'_{\mathfrak q}$ is universally injective as a map of $r_{\mathfrak p}$-modules, where $\mathfrak p$ is the inverse image of $\mathfrak q$ in $r$, and \item for each maximal ideal $\mathfrak m$ of $s$ the map $m_{\mathfrak m} \to m'_{\mathfrak m}$ is universally injective as a map of $r_{\mathfrak p}$-modules, where $\mathfrak p$ is the inverse image of $\mathfrak m$ in $r$. \end{enumerate} \end{lemma} \begin{proof} let $n$ be an $r$-module. let $\mathfrak q$ be a prime of $s$ lying over the prime $\mathfrak p$ of $r$. then we have $$ (m \otimes_r n)_{\mathfrak q} = m_{\mathfrak q} \otimes_r n = m_{\mathfrak q} \otimes_{r_{\mathfrak p}} n_{\mathfrak p}. $$ moreover, the same thing holds for $m'$ and localization is exact. also, if $n$ is an $r_{\mathfrak p}$-module, then $n_{\mathfrak p} = n$. using this the equivalences can be proved in a straightforward manner. \medskip\noindent for example, suppose that (5) holds. let $k = \ker(m \otimes_r n \to m' \otimes_r n)$. by the remarks above we see that $k_{\mathfrak m} = 0$ for each maximal ideal $\mathfrak m$ of $s$. hence $k = 0$ by lemma \ref{lemma-characterize-zero-local}. thus (1) holds. conversely, suppose that (1) holds. take any $\mathfrak q \subset s$ lying over $\mathfrak p \subset r$. take any module $n$ over $r_{\mathfrak p}$. then by assumption $\ker(m \otimes_r n \to m' \otimes_r n) = 0$. hence by the formulae above and the fact that $n = n_{\mathfrak p}$ we see that $\ker(m_{\mathfrak q} \otimes_{r_{\mathfrak p}} n \to m'_{\mathfrak q} \otimes_{r_{\mathfrak p}} n) = 0$. in other words (4) holds. of course (4) $\rightarrow$ (5) is immediate. hence (1), (4) and (5) are all equivalent. we omit the proof of the other equivalences. \end{proof} \begin{lemma} \label{lemma-universally-injective-localize} let $\varphi : a \to b$ be a ring map. let $s \subset a$ and $s' \subset b$ be multiplicative subsets such that $\varphi(s) \subset s'$. let $m \to m'$ be a map of $b$-modules. \begin{enumerate} \item if $m \to m'$ is universally injective as a map of $a$-modules, then $(s')^{-1}m \to (s')^{-1}m'$ is universally injective as a map of $a$-modules and as a map of $s^{-1}a$-modules. \item if $m$ and $m'$ are $(s')^{-1}b$-modules, then $m \to m'$ is universally injective as a map of $a$-modules if and only if it is universally injective as a map of $s^{-1}a$-modules. \end{enumerate} \end{lemma} \begin{proof} you can prove this using lemma \ref{lemma-universally-injective-check-stalks} but you can also prove it directly as follows. assume $m \to m'$ is $a$-universally injective. let $q$ be an $a$-module. then $q \otimes_a m \to q \otimes_a m'$ is injective. since localization is exact we see that $(s')^{-1}(q \otimes_a m) \to (s')^{-1}(q \otimes_a m')$ is injective. as $(s')^{-1}(q \otimes_a m) = q \otimes_a (s')^{-1}m$ and similarly for $m'$ we see that $q \otimes_a (s')^{-1}m \to q \otimes_a (s')^{-1}m'$ is injective, hence $(s')^{-1}m \to (s')^{-1}m'$ is universally injective as a map of $a$-modules. this proves the first part of (1). to see (2) we can use the following two facts: (a) if $q$ is an $s^{-1}a$-module, then $q \otimes_a s^{-1}a = q$, i.e., tensoring with $q$ over $a$ is the same thing as tensoring with $q$ over $s^{-1}a$, (b) if $m$ is any $a$-module on which the elements of $s$ are invertible, then $m \otimes_a q = m \otimes_{s^{-1}a} s^{-1}q$. part (2) follows from this immediately. \end{proof} \begin{lemma} \label{lemma-check-universally-injective-into-flat} let $r$ be a ring and let $m \to m'$ be a map of $r$-modules. if $m'$ is flat, then $m \to m'$ is universally injective if and only if $m/im \to m'/im'$ is injective for every finitely generated ideal $i$ of $r$. \end{lemma} \begin{proof} it suffices to show that $m \otimes_r q \to m' \otimes_r q$ is injective for every finite $r$-module $q$, see theorem \ref{theorem-universally-exact-criteria}. then $q$ has a finite filtration $0 = q_0 \subset q_1 \subset \ldots \subset q_n = q$ by submodules whose subquotients are isomorphic to cyclic modules $r/i_i$, see lemma \ref{lemma-trivial-filter-finite-module}. since $m'$ is flat, we obtain a filtration $$ \xymatrix{ m \otimes q_1 \ar[r] \ar[d] & m \otimes q_2 \ar[r] \ar[d] & \ldots \ar[r] & m \otimes q \ar[d] \\ m' \otimes q_1 \ar@{^{(}->}[r] & m' \otimes q_2 \ar@{^{(}->}[r] & \ldots \ar@{^{(}->}[r] & m' \otimes q } $$ of $m' \otimes_r q$ by submodules $m' \otimes_r q_i$ whose successive quotients are $m' \otimes_r r/i_i = m'/i_im'$. a simple induction argument shows that it suffices to check $m/i_i m \to m'/i_i m'$ is injective. note that the collection of finitely generated ideals $i'_i \subset i_i$ is a directed set. thus $m/i_im = \colim m/i'_im$ is a filtered colimit, similarly for $m'$, the maps $m/i'_im \to m'/i'_i m'$ are injective by assumption, and since filtered colimits are exact (lemma \ref{lemma-directed-colimit-exact}) we conclude. \end{proof} \section{descent for finite projective modules} \label{section-finite-projective} \noindent in this section we give an elementary proof of the fact that the property of being a {\it finite} projective module descends along faithfully flat ring maps. the proof does not apply when we drop the finiteness condition. however, the method is indicative of the one we shall use to prove descent for the property of being a {\it countably generated} projective module---see the comments at the end of this section. \begin{lemma} \label{lemma-finite-projective-again} let $m$ be an $r$-module. then $m$ is finite projective if and only if $m$ is finitely presented and flat. \end{lemma} \begin{proof} this is part of lemma \ref{lemma-finite-projective}. however, at this point we can give a more elegant proof of the implication (1) $\rightarrow$ (2) of that lemma as follows. if $m$ is finitely presented and flat, then take a surjection $r^n \to m$. by lemma \ref{lemma-flat-surjective-hom} applied to $p = m$, the map $r^n \to m$ admits a section. so $m$ is a direct summand of a free module and hence projective. \end{proof} \noindent here are some properties of modules that descend. \begin{lemma} \label{lemma-descend-properties-modules} let $r \to s$ be a faithfully flat ring map. let $m$ be an $r$-module. then \begin{enumerate} \item if the $s$-module $m \otimes_r s$ is of finite type, then $m$ is of finite type, \item if the $s$-module $m \otimes_r s$ is of finite presentation, then $m$ is of finite presentation, \item if the $s$-module $m \otimes_r s$ is flat, then $m$ is flat, and \item add more here as needed. \end{enumerate} \end{lemma} \begin{proof} assume $m \otimes_r s$ is of finite type. let $y_1, \ldots, y_m$ be generators of $m \otimes_r s$ over $s$. write $y_j = \sum x_i \otimes f_i$ for some $x_1, \ldots, x_n \in m$. then we see that the map $\varphi : r^{\oplus n} \to m$ has the property that $\varphi \otimes \text{id}_s : s^{\oplus n} \to m \otimes_r s$ is surjective. since $r \to s$ is faithfully flat we see that $\varphi$ is surjective, and $m$ is finitely generated. \medskip\noindent assume $m \otimes_r s$ is of finite presentation. by (1) we see that $m$ is of finite type. choose a surjection $r^{\oplus n} \to m$ and denote $k$ the kernel. as $r \to s$ is flat we see that $k \otimes_r s$ is the kernel of the base change $s^{\oplus n} \to m \otimes_r s$. as $m \otimes_r s$ is of finite presentation we conclude that $k \otimes_r s$ is of finite type. hence by (1) we see that $k$ is of finite type and hence $m$ is of finite presentation. \medskip\noindent part (3) is lemma \ref{lemma-flatness-descends}. \end{proof} \begin{proposition} \label{proposition-ffdescent-finite-projectivity} let $r \to s$ be a faithfully flat ring map. let $m$ be an $r$-module. if the $s$-module $m \otimes_r s$ is finite projective, then $m$ is finite projective. \end{proposition} \begin{proof} follows from lemmas \ref{lemma-finite-projective-again} and \ref{lemma-descend-properties-modules}. \end{proof} \noindent the next few sections are about removing the finiteness assumption by using d\'evissage to reduce to the countably generated case. in the countably generated case, the strategy is to find a characterization of countably generated projective modules analogous to lemma \ref{lemma-finite-projective-again}, and then to prove directly that this characterization descends. we do this by introducing the notion of a mittag-leffler module and proving that if a module $m$ is countably generated, then it is projective if and only if it is flat and mittag-leffler (theorem \ref{theorem-projectivity-characterization}). when $m$ is finitely generated, this statement reduces to lemma \ref{lemma-finite-projective-again} (since, according to example \ref{example-ml} (1), a finitely generated module is mittag-leffler if and only if it is finitely presented). \section{transfinite d\'evissage of modules} \label{section-transfinite-devissage} \noindent in this section we introduce a d\'evissage technique for decomposing a module into a direct sum. the main result is that a projective module is a direct sum of countably generated modules (theorem \ref{theorem-projective-direct-sum} below). we follow \cite{kaplansky}. \begin{definition} \label{definition-devissage} let $m$ be an $r$-module. a {\it direct sum d\'evissage} of $m$ is a family of submodules $(m_{\alpha})_{\alpha \in s}$, indexed by an ordinal $s$ and increasing (with respect to inclusion), such that: \begin{enumerate} \item[(0)] $m_0 = 0$; \item[(1)] $m = \bigcup_{\alpha} m_{\alpha}$; \item[(2)] if $\alpha \in s$ is a limit ordinal, then $m_{\alpha} = \bigcup_{\beta < \alpha} m_{\beta}$; \item[(3)] if $\alpha + 1 \in s$, then $m_{\alpha}$ is a direct summand of $m_{\alpha + 1}$. \end{enumerate} if moreover \begin{enumerate} \item[(4)] $m_{\alpha + 1}/m_{\alpha}$ is countably generated for $\alpha + 1 \in s$, \end{enumerate} then $(m_{\alpha})_{\alpha \in s}$ is called a {\it kaplansky d\'evissage} of $m$. \end{definition} \noindent the terminology is justified by the following lemma. \begin{lemma} \label{lemma-direct-sum-devissage} let $m$ be an $r$-module. if $(m_{\alpha})_{\alpha \in s}$ is a direct sum d\'evissage of $m$, then $m \cong \bigoplus_{\alpha + 1 \in s} m_{\alpha + 1}/m_{\alpha}$. \end{lemma} \begin{proof} by property (3) of a direct sum d\'evissage, there is an inclusion $m_{\alpha + 1}/m_{\alpha} \to m$ for each $\alpha \in s$. consider the map $$ f : \bigoplus\nolimits_{\alpha + 1\in s} m_{\alpha + 1}/m_{\alpha} \to m $$ given by the sum of these inclusions. further consider the restrictions $$ f_{\beta} : \bigoplus\nolimits_{\alpha + 1 \leq \beta} m_{\alpha + 1}/m_{\alpha} \longrightarrow m $$ for $\beta\in s$. transfinite induction on $s$ shows that the image of $f_{\beta}$ is $m_{\beta}$. for $\beta=0$ this is true by $(0)$. if $\beta+1$ is a successor ordinal and it is true for $\beta$, then it is true for $\beta + 1$ by (3). and if $\beta$ is a limit ordinal and it is true for $\alpha < \beta$, then it is true for $\beta$ by (2). hence $f$ is surjective by (1). \medskip\noindent transfinite induction on $s$ also shows that the restrictions $f_{\beta}$ are injective. for $\beta = 0$ it is true. if $\beta+1$ is a successor ordinal and $f_{\beta}$ is injective, then let $x$ be in the kernel and write $x = (x_{\alpha + 1})_{\alpha + 1 \leq \beta + 1}$ in terms of its components $x_{\alpha + 1} \in m_{\alpha + 1}/m_{\alpha}$. by property (3) and the fact that the image of $f_{\beta}$ is $m_{\beta}$ both $(x_{\alpha + 1})_{\alpha + 1 \leq \beta}$ and $x_{\beta + 1}$ map to $0$. hence $x_{\beta+1} = 0$ and, by the assumption that the restriction $f_{\beta}$ is injective also $x_{\alpha + 1} = 0$ for every $\alpha + 1 \leq \beta$. so $x = 0$ and $f_{\beta+1}$ is injective. if $\beta$ is a limit ordinal consider an element $x$ of the kernel. then $x$ is already contained in the domain of $f_{\alpha}$ for some $\alpha < \beta$. thus $x = 0$ which finishes the induction. we conclude that $f$ is injective since $f_{\beta}$ is for each $\beta \in s$. \end{proof} \begin{lemma} \label{lemma-kaplansky-devissage} let $m$ be an $r$-module. then $m$ is a direct sum of countably generated $r$-modules if and only if it admits a kaplansky d\'evissage. \end{lemma} \begin{proof} the lemma takes care of the ``if'' direction. conversely, suppose $m = \bigoplus_{i \in i} n_i$ where each $n_i$ is a countably generated $r$-module. well-order $i$ so that we can think of it as an ordinal. then setting $m_i = \bigoplus_{j < i} n_j$ gives a kaplansky d\'evissage $(m_i)_{i \in i}$ of $m$. \end{proof} \begin{theorem} \label{theorem-kaplansky-direct-sum} suppose $m$ is a direct sum of countably generated $r$-modules. if $p$ is a direct summand of $m$, then $p$ is also a direct sum of countably generated $r$-modules. \end{theorem} \begin{proof} write $m = p \oplus q$. we are going to construct a kaplansky d\'evissage $(m_{\alpha})_{\alpha \in s}$ of $m$ which, in addition to the defining properties (0)-(4), satisfies: \begin{enumerate} \item[(5)] each $m_{\alpha}$ is a direct summand of $m$; \item[(6)] $m_{\alpha} = p_{\alpha} \oplus q_{\alpha}$, where $p_{\alpha} =p \cap m_{\alpha}$ and $q_\alpha = q \cap m_{\alpha}$. \end{enumerate} (note: if properties (0)-(2) hold, then in fact property (3) is equivalent to property (5).) \medskip\noindent to see how this implies the theorem, it is enough to show that $(p_{\alpha})_{\alpha \in s}$ forms a kaplansky d\'evissage of $p$. properties (0), (1), and (2) are clear. by (5) and (6) for $(m_{\alpha})$, each $p_{\alpha}$ is a direct summand of $m$. since $p_{\alpha} \subset p_{\alpha + 1}$, this implies $p_{\alpha}$ is a direct summand of $p_{\alpha + 1}$; hence (3) holds for $(p_{\alpha})$. for (4), note that $$ m_{\alpha + 1}/m_{\alpha} \cong p_{\alpha + 1}/p_{\alpha} \oplus q_{\alpha + 1}/q_{\alpha}, $$ so $p_{\alpha + 1}/p_{\alpha}$ is countably generated because this is true of $m_{\alpha + 1}/m_{\alpha}$. \medskip\noindent it remains to construct the $m_{\alpha}$. write $m = \bigoplus_{i \in i} n_i$ where each $n_i$ is a countably generated $r$-module. choose a well-ordering of $i$. by transfinite recursion we are going to define an increasing family of submodules $m_{\alpha}$ of $m$, one for each ordinal $\alpha$, such that $m_{\alpha}$ is a direct sum of some subset of the $n_i$. \medskip\noindent for $\alpha = 0$ let $m_{0} = 0$. if $\alpha$ is a limit ordinal and $m_{\beta}$ has been defined for all $\beta < \alpha$, then define $m_{\alpha} = \bigcup_{\beta < \alpha} m_{\beta}$. since each $m_{\beta}$ for $\beta < \alpha$ is a direct sum of a subset of the $n_i$, the same will be true of $m_{\alpha}$. if $\alpha + 1$ is a successor ordinal and $m_{\alpha}$ has been defined, then define $m_{\alpha + 1}$ as follows. if $m_{\alpha} = m$, then let $m_{\alpha + 1} = m$. if not, choose the smallest $j \in i$ such that $n_j$ is not contained in $m_{\alpha}$. we will construct an infinite matrix $(x_{mn}), m, n = 1, 2, 3, \ldots$ such that: \begin{enumerate} \item $n_j$ is contained in the submodule of $m$ generated by the entries $x_{mn}$; \item if we write any entry $x_{k\ell}$ in terms of its $p$- and $q$-components, $x_{k\ell} = y_{k\ell} + z_{k\ell}$, then the matrix $(x_{mn})$ contains a set of generators for each $n_i$ for which $y_{k\ell}$ or $z_{k\ell}$ has nonzero component. \end{enumerate} then we define $m_{\alpha + 1}$ to be the submodule of $m$ generated by $m_{\alpha}$ and all $x_{mn}$; by property (2) of the matrix $(x_{mn})$, $m_{\alpha + 1}$ will be a direct sum of some subset of the $n_i$. to construct the matrix $(x_{mn})$, let $x_{11}, x_{12}, x_{13}, \ldots$ be a countable set of generators for $n_j$. then if $x_{11} = y_{11} + z_{11}$ is the decomposition into $p$- and $q$-components, let $x_{21}, x_{22}, x_{23}, \ldots$ be a countable set of generators for the sum of the $n_i$ for which $y_{11}$ or $z_{11}$ have nonzero component. repeat this process on $x_{12}$ to get elements $x_{31}, x_{32}, \ldots$, the third row of our matrix. repeat on $x_{21}$ to get the fourth row, on $x_{13}$ to get the fifth, and so on, going down along successive anti-diagonals as indicated below: $$ \left( \vcenter{ \xymatrix@r=2mm@c=2mm{ x_{11} & x_{12} \ar[dl] & x_{13} \ar[dl] & x_{14} \ar[dl] & \ldots \\ x_{21} & x_{22} \ar[dl] & x_{23} \ar[dl] & \ldots \\ x_{31} & x_{32} \ar[dl] & \ldots \\ x_{41} & \ldots \\ \ldots } } \right). $$ \medskip\noindent transfinite induction on $i$ (using the fact that we constructed $m_{\alpha + 1}$ to contain $n_j$ for the smallest $j$ such that $n_j$ is not contained in $m_{\alpha}$) shows that for each $i \in i$, $n_i$ is contained in some $m_{\alpha}$. thus, there is some large enough ordinal $s$ satisfying: for each $i \in i$ there is $\alpha \in s$ such that $n_i$ is contained in $m_{\alpha}$. this means $(m_{\alpha})_{\alpha \in s}$ satisfies property (1) of a kaplansky d\'evissage of $m$. the family $(m_{\alpha})_{\alpha \in s}$ moreover satisfies the other defining properties, and also (5) and (6) above: properties (0), (2), (4), and (6) are clear by construction; property (5) is true because each $m_{\alpha}$ is by construction a direct sum of some $n_i$; and (3) is implied by (5) and the fact that $m_{\alpha} \subset m_{\alpha + 1}$. \end{proof} \noindent as a corollary we get the result for projective modules stated at the beginning of the section. \begin{theorem} \label{theorem-projective-direct-sum} \begin{slogan} any projective module is a direct sum of countably generated projective modules. \end{slogan} if $p$ is a projective $r$-module, then $p$ is a direct sum of countably generated projective $r$-modules. \end{theorem} \begin{proof} a module is projective if and only if it is a direct summand of a free module, so this follows from theorem \ref{theorem-kaplansky-direct-sum}. \end{proof} \section{projective modules over a local ring} \label{section-projective-local-ring} \noindent in this section we prove a very cute result: a projective module $m$ over a local ring is free (theorem \ref{theorem-projective-free-over-local-ring} below). note that with the additional assumption that $m$ is finite, this result is lemma \ref{lemma-finite-flat-local}. in general we have: \begin{lemma} \label{lemma-projective-free} let $r$ be a ring. then every projective $r$-module is free if and only if every countably generated projective $r$-module is free. \end{lemma} \begin{proof} follows immediately from theorem \ref{theorem-projective-direct-sum}. \end{proof} \noindent here is a criterion for a countably generated module to be free. \begin{lemma} \label{lemma-freeness-criteria} let $m$ be a countably generated $r$-module with the following property: if $m = n \oplus n'$ with $n'$ a finite free $r$-module, then any element of $n$ is contained in a free direct summand of $n$. then $m$ is free. \end{lemma} \begin{proof} let $x_1, x_2, \ldots$ be a countable set of generators for $m$. we inductively construct finite free direct summands $f_1, f_2, \ldots$ of $m$ such that for all $n$ we have that $f_1 \oplus \ldots \oplus f_n$ is a direct summand of $m$ which contains $x_1, \ldots, x_n$. namely, given $f_1, \ldots, f_n$ with the desired properties, write $$ m = f_1 \oplus \ldots \oplus f_n \oplus n $$ and let $x \in n$ be the image of $x_{n + 1}$. then we can find a free direct summand $f_{n + 1} \subset n$ containing $x$ by the assumption in the statement of the lemma. of course we can replace $f_{n + 1}$ by a finite free direct summand of $f_{n + 1}$ and the induction step is complete. then $m = \bigoplus_{i = 1}^{\infty} f_i$ is free. \end{proof} \begin{lemma} \label{lemma-projective-freeness-criteria} let $p$ be a projective module over a local ring $r$. then any element of $p$ is contained in a free direct summand of $p$. \end{lemma} \begin{proof} since $p$ is projective it is a direct summand of some free $r$-module $f$, say $f = p \oplus q$. let $x \in p$ be the element that we wish to show is contained in a free direct summand of $p$. let $b$ be a basis of $f$ such that the number of basis elements needed in the expression of $x$ is minimal, say $x = \sum_{i=1}^n a_i e_i$ for some $e_i \in b$ and $a_i \in r$. then no $a_j$ can be expressed as a linear combination of the other $a_i$; for if $a_j = \sum_{i \neq j} a_i b_i$ for some $b_i \in r$, then replacing $e_i$ by $e_i + b_ie_j$ for $i \neq j$ and leaving unchanged the other elements of $b$, we get a new basis for $f$ in terms of which $x$ has a shorter expression. \medskip\noindent let $e_i = y_i + z_i, y_i \in p, z_i \in q$ be the decomposition of $e_i$ into its $p$- and $q$-components. write $y_i = \sum_{j=1}^{n} b_{ij} e_j + t_i$, where $t_i$ is a linear combination of elements in $b$ other than $e_1, \ldots, e_n$. to finish the proof it suffices to show that the matrix $(b_{ij})$ is invertible. for then the map $f \to f$ sending $e_i \mapsto y_i$ for $i=1, \ldots, n$ and fixing $b \setminus \{e_1, \ldots, e_n\}$ is an isomorphism, so that $y_1, \ldots, y_n$ together with $b \setminus \{e_1, \ldots, e_n\}$ form a basis for $f$. then the submodule $n$ spanned by $y_1, \ldots, y_n$ is a free submodule of $p$; $n$ is a direct summand of $p$ since $n \subset p$ and both $n$ and $p$ are direct summands of $f$; and $x \in n$ since $x \in p$ implies $x = \sum_{i=1}^n a_i e_i = \sum_{i=1}^n a_i y_i$. \medskip\noindent now we prove that $(b_{ij})$ is invertible. plugging $y_i = \sum_{j=1}^{n} b_{ij} e_j + t_i$ into $\sum_{i=1}^n a_i e_i = \sum_{i=1}^n a_i y_i$ and equating the coefficients of $e_j$ gives $a_j = \sum_{i=1}^n a_i b_{ij}$. but as noted above, our choice of $b$ guarantees that no $a_j$ can be written as a linear combination of the other $a_i$. thus $b_{ij}$ is a non-unit for $i \neq j$, and $1-b_{ii}$ is a non-unit---so in particular $b_{ii}$ is a unit---for all $i$. but a matrix over a local ring having units along the diagonal and non-units elsewhere is invertible, as its determinant is a unit. \end{proof} \begin{theorem} \label{theorem-projective-free-over-local-ring} \begin{slogan} projective modules over local rings are free. \end{slogan} if $p$ is a projective module over a local ring $r$, then $p$ is free. \end{theorem} \begin{proof} follows from lemmas \ref{lemma-projective-free}, \ref{lemma-freeness-criteria}, and \ref{lemma-projective-freeness-criteria}. \end{proof} \section{mittag-leffler systems} \label{section-mittag-leffler} \noindent the purpose of this section is to define mittag-leffler systems and why this is a useful notion. \medskip\noindent in the following, $i$ will be a directed set, see categories, definition \ref{categories-definition-directed-set}. let $(a_i, \varphi_{ji}: a_j \to a_i)$ be an inverse system of sets or of modules indexed by $i$, see categories, definition \ref{categories-definition-directed-system}. this is a directed inverse system as we assumed $i$ directed (categories, definition \ref{categories-definition-directed-system}). for each $i \in i$, the images $\varphi_{ji}(a_j) \subset a_i$ for $j \geq i$ form a decreasing directed family of subsets (or submodules) of $a_i$. let $a'_i = \bigcap_{j \geq i} \varphi_{ji}(a_j)$. then $\varphi_{ji}(a'_j) \subset a'_i$ for $j \geq i$, hence by restricting we get a directed inverse system $(a'_i, \varphi_{ji}|_{a'_j})$. from the construction of the limit of an inverse system in the category of sets or modules, we have $\lim a_i = \lim a'_i$. the mittag-leffler condition on $(a_i, \varphi_{ji})$ is that $a'_i$ equals $\varphi_{ji}(a_j)$ for some $j \geq i$ (and hence equals $\varphi_{ki}(a_k)$ for all $k \geq j$): \begin{definition} \label{definition-ml-system} let $(a_i, \varphi_{ji})$ be a directed inverse system of sets over $i$. then we say $(a_i, \varphi_{ji})$ is {\it mittag-leffler} if for each $i \in i$, the family $\varphi_{ji}(a_j) \subset a_i$ for $j \geq i$ stabilizes. explicitly, this means that for each $i \in i$, there exists $j \geq i$ such that for $k \geq j$ we have $\varphi_{ki}(a_k) = \varphi_{ji}( a_j)$. if $(a_i, \varphi_{ji})$ is a directed inverse system of modules over a ring $r$, we say that it is mittag-leffler if the underlying inverse system of sets is mittag-leffler. \end{definition} \begin{example} \label{example-ml-surjective-maps} if $(a_i, \varphi_{ji})$ is a directed inverse system of sets or of modules and the maps $\varphi_{ji}$ are surjective, then clearly the system is mittag-leffler. conversely, suppose $(a_i, \varphi_{ji})$ is mittag-leffler. let $a'_i \subset a_i$ be the stable image of $\varphi_{ji}(a_j)$ for $j \geq i$. then $\varphi_{ji}|_{a'_j}: a'_j \to a'_i$ is surjective for $j \geq i$ and $\lim a_i = \lim a'_i$. hence the limit of the mittag-leffler system $(a_i, \varphi_{ji})$ can also be written as the limit of a directed inverse system over $i$ with surjective maps. \end{example} \begin{lemma} \label{lemma-ml-limit-nonempty} let $(a_i, \varphi_{ji})$ be a directed inverse system over $i$. suppose $i$ is countable. if $(a_i, \varphi_{ji})$ is mittag-leffler and the $a_i$ are nonempty, then $\lim a_i$ is nonempty. \end{lemma} \begin{proof} let $i_1, i_2, i_3, \ldots$ be an enumeration of the elements of $i$. define inductively a sequence of elements $j_n \in i$ for $n = 1, 2, 3, \ldots$ by the conditions: $j_1 = i_1$, and $j_n \geq i_n$ and $j_n \geq j_m$ for $m < n$. then the sequence $j_n$ is increasing and forms a cofinal subset of $i$. hence we may assume $i =\{1, 2, 3, \ldots \}$. so by example \ref{example-ml-surjective-maps} we are reduced to showing that the limit of an inverse system of nonempty sets with surjective maps indexed by the positive integers is nonempty. this follows from the axiom of choice. \end{proof} \noindent the mittag-leffler condition will be important for us because of the following exactness property. \begin{lemma} \label{lemma-ml-exact-sequence} let $$ 0 \to a_i \xrightarrow{f_i} b_i \xrightarrow{g_i} c_i \to 0 $$ be an exact sequence of directed inverse systems of abelian groups over $i$. suppose $i$ is countable. if $(a_i)$ is mittag-leffler, then $$ 0 \to \lim a_i \to \lim b_i \to \lim c_i\to 0 $$ is exact. \end{lemma} \begin{proof} taking limits of directed inverse systems is left exact, hence we only need to prove surjectivity of $\lim b_i \to \lim c_i$. so let $(c_i) \in \lim c_i$. for each $i \in i$, let $e_i = g_i^{-1}(c_i)$, which is nonempty since $g_i: b_i \to c_i$ is surjective. the system of maps $\varphi_{ji}: b_j \to b_i$ for $(b_i)$ restrict to maps $e_j \to e_i$ which make $(e_i)$ into an inverse system of nonempty sets. it is enough to show that $(e_i)$ is mittag-leffler. for then lemma \ref{lemma-ml-limit-nonempty} would show $\lim e_i$ is nonempty, and taking any element of $\lim e_i$ would give an element of $\lim b_i$ mapping to $(c_i)$. \medskip\noindent by the injection $f_i: a_i \to b_i$ we will regard $a_i$ as a subset of $b_i$. since $(a_i)$ is mittag-leffler, if $i \in i$ then there exists $j \geq i$ such that $\varphi_{ki}(a_k) = \varphi_{ji}(a_j)$ for $k \geq j$. we claim that also $\varphi_{ki}(e_k) = \varphi_{ji}(e_j)$ for $k \geq j$. always $\varphi_{ki}(e_k) \subset \varphi_{ji}(e_j)$ for $k \geq j$. for the reverse inclusion let $e_j \in e_j$, and we need to find $x_k \in e_k$ such that $\varphi_{ki}(x_k) = \varphi_{ji}(e_j)$. let $e'_k \in e_k$ be any element, and set $e'_j = \varphi_{kj}(e'_k)$. then $g_j(e_j - e'_j) = c_j - c_j = 0$, hence $e_j - e'_j = a_j \in a_j$. since $\varphi_{ki}(a_k) = \varphi_{ji}(a_j)$, there exists $a_k \in a_k$ such that $\varphi_{ki}(a_k) = \varphi_{ji}(a_j)$. hence $$ \varphi_{ki}(e'_k + a_k) = \varphi_{ji}(e'_j) + \varphi_{ji}(a_j) = \varphi_{ji}(e_j), $$ so we can take $x_k = e'_k + a_k$. \end{proof} \section{inverse systems} \label{section-inverse-systems} \noindent in many papers (and in this section) the term {\it inverse system} is used to indicate an inverse system over the partially ordered set $(\mathbf{n}, \geq)$. we briefly discuss such systems in this section. this material will be discussed more broadly in homology, section \ref{homology-section-inverse-systems}. suppose we are given a ring $r$ and a sequence of $r$-modules $$ m_1 \xleftarrow{\varphi_2} m_2 \xleftarrow{\varphi_3} m_3 \leftarrow \ldots $$ with maps as indicated. by composing successive maps we obtain maps $\varphi_{ii'} : m_i \to m_{i'}$ whenever $i \geq i'$ such that moreover $\varphi_{ii''} = \varphi_{i'i''} \circ \varphi_{i i'}$ whenever $i \geq i' \geq i''$. conversely, given the system of maps $\varphi_{ii'}$ we can set $\varphi_i = \varphi_{i(i-1)}$ and recover the maps displayed above. in this case $$ \lim m_i = \{(x_i) \in \prod m_i \mid \varphi_i(x_i) = x_{i - 1}, \ i = 2, 3, \ldots\} $$ compare with categories, section \ref{categories-section-limit-sets}. as explained in homology, section \ref{homology-section-inverse-systems} this is actually a limit in the category of $r$-modules, as defined in categories, section \ref{categories-section-limits}. \begin{lemma} \label{lemma-mittag-leffler} let $r$ be a ring. let $0 \to k_i \to l_i \to m_i \to 0$ be short exact sequences of $r$-modules, $i \geq 1$ which fit into maps of short exact sequences $$ \xymatrix{ 0 \ar[r] & k_i \ar[r] & l_i \ar[r] & m_i \ar[r] & 0 \\ 0 \ar[r] & k_{i + 1} \ar[r] \ar[u] & l_{i + 1} \ar[r] \ar[u] & m_{i + 1} \ar[r] \ar[u] & 0} $$ if for every $i$ there exists a $c = c(i) \geq i$ such that $\im(k_c \to k_i) = \im(k_j \to k_i)$ for all $j \geq c$, then the sequence $$ 0 \to \lim k_i \to \lim l_i \to \lim m_i \to 0 $$ is exact. \end{lemma} \begin{proof} this is a special case of the more general lemma \ref{lemma-ml-exact-sequence}. \end{proof} \section{mittag-leffler modules} \label{section-mittag-leffler-modules} \noindent a mittag-leffler module is (very roughly) a module which can be written as a directed limit whose dual is a mittag-leffler system. to be able to give a precise definition we need to do a bit of work. \begin{definition} \label{definition-ml-inductive-system} let $(m_i, f_{ij})$ be a directed system of $r$-modules. we say that $(m_i, f_{ij})$ is a {\it mittag-leffler directed system of modules} if each $m_i$ is an $r$-module of finite presentation and if for every $r$-module $n$, the inverse system $$ (\hom_r(m_i, n), \hom_r(f_{ij}, n)) $$ is mittag-leffler. \end{definition} \noindent we are going to characterize those $r$-modules that are colimits of mittag-leffler directed systems of modules. \begin{definition} \label{definition-domination} let $f: m \to n$ and $g: m \to m'$ be maps of $r$-modules. then we say $g$ {\it dominates} $f$ if for any $r$-module $q$, we have $\ker(f \otimes_r \text{id}_q) \subset \ker(g \otimes_r \text{id}_q)$. \end{definition} \noindent it is enough to check this condition for finitely presented modules. \begin{lemma} \label{lemma-domination-fp} let $f: m \to n$ and $g: m \to m'$ be maps of $r$-modules. then $g$ dominates $f$ if and only if for any finitely presented $r$-module $q$, we have $\ker(f \otimes_r \text{id}_q) \subset \ker(g \otimes_r \text{id}_q)$. \end{lemma} \begin{proof} suppose $\ker(f \otimes_r \text{id}_q) \subset \ker(g \otimes_r \text{id}_q)$ for all finitely presented modules $q$. if $q$ is an arbitrary module, write $q = \colim_{i \in i} q_i$ as a colimit of a directed system of finitely presented modules $q_i$. then $\ker(f \otimes_r \text{id}_{q_i}) \subset \ker(g \otimes_r \text{id}_{q_i})$ for all $i$. since taking directed colimits is exact and commutes with tensor product, it follows that $\ker(f \otimes_r \text{id}_q) \subset \ker(g \otimes_r \text{id}_q)$. \end{proof} \begin{lemma} \label{lemma-domination-universally-injective} let $f : m \to n$ and $g : m \to m'$ be maps of $r$-modules. consider the pushout of $f$ and $g$, $$ \xymatrix{ m \ar[r]_f \ar[d]_g & n \ar[d]^{g'} \\ m' \ar[r]^{f'} & n' } $$ then $g$ dominates $f$ if and only if $f'$ is universally injective. \end{lemma} \begin{proof} recall that $n'$ is $m' \oplus n$ modulo the submodule consisting of elements $(g(x), -f(x))$ for $x \in m$. from the construction of $n'$ we have a short exact sequence $$ 0 \to \ker(f) \cap \ker(g) \to \ker(f) \to \ker(f') \to 0. $$ since tensoring commutes with taking pushouts, we have such a short exact sequence $$ 0 \to \ker(f \otimes \text{id}_q ) \cap \ker(g \otimes \text{id}_q) \to \ker(f \otimes \text{id}_q) \to \ker(f' \otimes \text{id}_q) \to 0 $$ for every $r$-module $q$. so $f'$ is universally injective if and only if $\ker(f \otimes \text{id}_q ) \subset \ker(g \otimes \text{id}_q)$ for every $q$, if and only if $g$ dominates $f$. \end{proof} \noindent the above definition of domination is sometimes related to the usual notion of domination of maps as the following lemma shows. \begin{lemma} \label{lemma-domination} let $f: m \to n$ and $g: m \to m'$ be maps of $r$-modules. suppose $\coker(f)$ is of finite presentation. then $g$ dominates $f$ if and only if $g$ factors through $f$, i.e.\ there exists a module map $h: n \to m'$ such that $g = h \circ f$. \end{lemma} \begin{proof} consider the pushout of $f$ and $g$ as in the statement of lemma \ref{lemma-domination-universally-injective}. from the construction of the pushout it follows that $\coker(f') = \coker(f)$, so $\coker(f')$ is of finite presentation. then by lemma \ref{lemma-universally-exact-split}, $f'$ is universally injective if and only if $$ 0 \to m' \xrightarrow{f'} n' \to \coker(f') \to 0 $$ splits. this is the case if and only if there is a map $h' : n' \to m'$ such that $h' \circ f' = \text{id}_{m'}$. from the universal property of the pushout, the existence of such an $h'$ is equivalent to $g$ factoring through $f$. \end{proof} \begin{proposition} \label{proposition-ml-characterization} let $m$ be an $r$-module. let $(m_i, f_{ij})$ be a directed system of finitely presented $r$-modules, indexed by $i$, such that $m = \colim m_i$. let $f_i: m_i \to m$ be the canonical map. the following are equivalent: \begin{enumerate} \item for every finitely presented $r$-module $p$ and module map $f: p \to m$, there exists a finitely presented $r$-module $q$ and a module map $g: p \to q$ such that $g$ and $f$ dominate each other, i.e., $\ker(f \otimes_r \text{id}_n) = \ker(g \otimes_r \text{id}_n)$ for every $r$-module $n$. \item for each $i \in i$, there exists $j \geq i$ such that $f_{ij}: m_i \to m_j$ dominates $f_i: m_i \to m$. \item for each $i \in i$, there exists $j \geq i$ such that $f_{ij}: m_i \to m_j$ factors through $f_{ik}: m_i \to m_k$ for all $k \geq i$. \item for every $r$-module $n$, the inverse system $(\hom_r(m_i, n), \hom_r(f_{ij}, n))$ is mittag-leffler. \item for $n = \prod_{s \in i} m_s$, the inverse system $(\hom_r(m_i, n), \hom_r(f_{ij}, n))$ is mittag-leffler. \end{enumerate} \end{proposition} \begin{proof} first we prove the equivalence of (1) and (2). suppose (1) holds and let $i \in i$. corresponding to the map $f_i: m_i \to m$, we can choose $g: m_i \to q$ as in (1). since $m_i$ and $q$ are of finite presentation, so is $\coker(g)$. then by lemma \ref{lemma-domination}, $f_i : m_i \to m$ factors through $g: m_i \to q$, say $f_i = h \circ g$ for some $h: q \to m$. then since $q$ is finitely presented, $h$ factors through $m_j \to m$ for some $j \geq i$, say $h = f_j \circ h'$ for some $h': q \to m_j$. in total we have a commutative diagram $$ \xymatrix{ & m & \\ m_i \ar[dr]_g \ar[ur]^{f_i} \ar[rr]^{f_{ij}} & & m_j \ar[ul]_{f_j} \\ & q \ar[ur]_{h'} & } $$ thus $f_{ij}$ dominates $g$. but $g$ dominates $f_i$, so $f_{ij}$ dominates $f_i$. \medskip\noindent conversely, suppose (2) holds. let $p$ be of finite presentation and $f: p \to m$ a module map. then $f$ factors through $f_i: m_i \to m$ for some $i \in i$, say $f = f_i \circ g'$ for some $g': p \to m_i$. choose by (2) a $j \geq i$ such that $f_{ij}$ dominates $f_i$. we have a commutative diagram $$ \xymatrix{ p \ar[d]_{g'} \ar[r]^{f} & m \\ m_i \ar[ur]^{f_i} \ar[r]_{f_{ij}} & m_j \ar[u]_{f_j} } $$ from the diagram and the fact that $f_{ij}$ dominates $f_i$, we find that $f$ and $f_{ij} \circ g'$ dominate each other. hence taking $g = f_{ij} \circ g' : p \to m_j$ works. \medskip\noindent next we prove (2) is equivalent to (3). let $i \in i$. it is always true that $f_i$ dominates $f_{ik}$ for $k \geq i$, since $f_i$ factors through $f_{ik}$. if (2) holds, choose $j \geq i$ such that $f_{ij}$ dominates $f_i$. then since domination is a transitive relation, $f_{ij}$ dominates $f_{ik}$ for $k \geq i$. all $m_i$ are of finite presentation, so $\coker(f_{ik})$ is of finite presentation for $k \geq i$. by lemma \ref{lemma-domination}, $f_{ij}$ factors through $f_{ik}$ for all $k \geq i$. thus (2) implies (3). on the other hand, if (3) holds then for any $r$-module $n$, $f_{ij} \otimes_r \text{id}_n$ factors through $f_{ik} \otimes_r \text{id}_n$ for $k \geq i$. so $\ker(f_{ik} \otimes_r \text{id}_n) \subset \ker(f_{ij} \otimes_r \text{id}_n)$ for $k \geq i$. but $\ker(f_i \otimes_r \text{id}_n: m_i \otimes_r n \to m \otimes_r n)$ is the union of $\ker(f_{ik} \otimes_r \text{id}_n)$ for $k \geq i$. thus $\ker(f_i \otimes_r \text{id}_n) \subset \ker(f_{ij} \otimes_r \text{id}_n)$ for any $r$-module $n$, which by definition means $f_{ij}$ dominates $f_i$. \medskip\noindent it is trivial that (3) implies (4) implies (5). we show (5) implies (3). let $n = \prod_{s \in i} m_s$. if (5) holds, then given $i \in i$ choose $j \geq i$ such that $$ \im( \hom(m_j, n) \to \hom(m_i, n)) = \im( \hom(m_k, n) \to \hom(m_i, n)) $$ for all $k \geq j$. passing the product over $s \in i$ outside of the $\hom$'s and looking at the maps on each component of the product, this says $$ \im( \hom(m_j, m_s) \to \hom(m_i, m_s)) = \im( \hom(m_k, m_s) \to \hom(m_i, m_s)) $$ for all $k \geq j$ and $s \in i$. taking $s = j$ we have $$ \im( \hom(m_j, m_j) \to \hom(m_i, m_j)) = \im( \hom(m_k, m_j) \to \hom(m_i, m_j)) $$ for all $k \geq j$. since $f_{ij}$ is the image of $\text{id} \in \hom(m_j, m_j)$ under $\hom(m_j, m_j) \to \hom(m_i, m_j)$, this shows that for any $k \geq j$ there is $h \in \hom(m_k, m_j)$ such that $f_{ij} = h \circ f_{ik}$. if $j \geq k$ then we can take $h = f_{kj}$. hence (3) holds. \end{proof} \begin{definition} \label{definition-mittag-leffler-module} let $m$ be an $r$-module. we say that $m$ is {\it mittag-leffler} if the equivalent conditions of proposition \ref{proposition-ml-characterization} hold. \end{definition} \noindent in particular a finitely presented module is mittag-leffler. \begin{remark} \label{remark-flat-ml} let $m$ be a flat $r$-module. by lazard's theorem (theorem \ref{theorem-lazard}) we can write $m = \colim m_i$ as the colimit of a directed system $(m_i, f_{ij})$ where the $m_i$ are free finite $r$-modules. for $m$ to be mittag-leffler, it is enough for the inverse system of duals $(\hom_r(m_i, r), \hom_r(f_{ij}, r))$ to be mittag-leffler. this follows from criterion (4) of proposition \ref{proposition-ml-characterization} and the fact that for a free finite $r$-module $f$, there is a functorial isomorphism $\hom_r(f, r) \otimes_r n \cong \hom_r(f, n)$ for any $r$-module $n$. \end{remark} \begin{lemma} \label{lemma-tensor-ml-modules} if $r$ is a ring and $m$, $n$ are mittag-leffler modules over $r$, then $m \otimes_r n$ is a mittag-leffler module. \end{lemma} \begin{proof} write $m = \colim_{i \in i} m_i$ and $n = \colim_{j \in j} n_j$ as directed colimits of finitely presented $r$-modules. denote $f_{ii'} : m_i \to m_{i'}$ and $g_{jj'} : n_j \to n_{j'}$ the transition maps. then $m_i \otimes_r n_j$ is a finitely presented $r$-module (see lemma \ref{lemma-tensor-finiteness}), and $m \otimes_r n = \colim_{(i, j) \in i \times j} m_i \otimes_r m_j$. pick $(i, j) \in i \times j$. by the definition of a mittag-leffler module we have proposition \ref{proposition-ml-characterization} (3) for both systems. in other words there exist $i' \geq i$ and $j' \geq j$ such that for every choice of $i'' \geq i$ and $j'' \geq j$ there exist maps $a : m_{i''} \to m_{i'}$ and $b : m_{j''} \to m_{j'}$ such that $f_{ii'} = a \circ f_{ii''}$ and $g_{jj'} = b \circ g_{jj''}$. then it is clear that $a \otimes b : m_{i''} \otimes_r n_{j''} \to m_{i'} \otimes_r n_{j'}$ serves the same purpose for the system $(m_i \otimes_r n_j, f_{ii'} \otimes g_{jj'})$. thus by the characterization proposition \ref{proposition-ml-characterization} (3) we conclude that $m \otimes_r n$ is mittag-leffler. \end{proof} \begin{lemma} \label{lemma-ml-also} let $r$ be a ring and $m$ an $r$-module. then $m$ is mittag-leffler if and only if for every finite free $r$-module $f$ and module map $f: f \to m$, there exists a finitely presented $r$-module $q$ and a module map $g : f \to q$ such that $g$ and $f$ dominate each other, i.e., $\ker(f \otimes_r \text{id}_n) = \ker(g \otimes_r \text{id}_n)$ for every $r$-module $n$. \end{lemma} \begin{proof} since the condition is clear weaker than condition (1) of proposition \ref{proposition-ml-characterization} we see that a mittag-leffler module satisfies the condition. conversely, suppose that $m$ satisfies the condition and that $f : p \to m$ is an $r$-module map from a finitely presented $r$-module $p$ into $m$. choose a surjection $f \to p$ where $f$ is a finite free $r$-module. by assumption we can find a map $f \to q$ where $q$ is a finitely presented $r$-module such that $f \to q$ and $f \to m$ dominate each other. in particular, the kernel of $f \to q$ contains the kernel of $f \to p$, hence we obtain an $r$-module map $g : p \to q$ such that $f \to q$ is equal to the composition $f \to p \to q$. let $n$ be any $r$-module and consider the commutative diagram $$ \xymatrix{ f \otimes_r n \ar[d] \ar[r] & q \otimes_r n \\ p \otimes_r n \ar[ru] \ar[r] & m \otimes_r n } $$ by assumption the kernels of $f \otimes_r n \to q \otimes_r n$ and $f \otimes_r n \to m \otimes_r n$ are equal. hence, as $f \otimes_r n \to p \otimes_r n$ is surjective, also the kernels of $p \otimes_r n \to q \otimes_r n$ and $p \otimes_r n \to m \otimes_r n$ are equal. \end{proof} \begin{lemma} \label{lemma-restrict-ml-modules} let $r \to s$ be a finite and finitely presented ring map. let $m$ be an $s$-module. if $m$ is a mittag-leffler module over $s$ then $m$ is a mittag-leffler module over $r$. \end{lemma} \begin{proof} assume $m$ is a mittag-leffler module over $s$. write $m = \colim m_i$ as a directed colimit of finitely presented $s$-modules $m_i$. as $m$ is mittag-leffler over $s$ there exists for each $i$ an index $j \geq i$ such that for all $k \geq j$ there is a factorization $f_{ij} = h \circ f_{ik}$ (where $h$ depends on $i$, the choice of $j$ and $k$). note that by lemma \ref{lemma-finite-finitely-presented-extension} the modules $m_i$ are also finitely presented as $r$-modules. moreover, all the maps $f_{ij}, f_{ik}, h$ are maps of $r$-modules. thus we see that the system $(m_i, f_{ij})$ satisfies the same condition when viewed as a system of $r$-modules. thus $m$ is mittag-leffler as an $r$-module. \end{proof} \begin{lemma} \label{lemma-mod-ideal-ml-modules} let $r$ be a ring. let $s = r/i$ for some finitely generated ideal $i$. let $m$ be an $s$-module. then $m$ is a mittag-leffler module over $r$ if and only if $m$ is a mittag-leffler module over $s$. \end{lemma} \begin{proof} one implication follows from lemma \ref{lemma-restrict-ml-modules}. to prove the other, assume $m$ is mittag-leffler as an $r$-module. write $m = \colim m_i$ as a directed colimit of finitely presented $s$-modules. as $i$ is finitely generated, the ring $s$ is finite and finitely presented as an $r$-algebra, hence the modules $m_i$ are finitely presented as $r$-modules, see lemma \ref{lemma-finite-finitely-presented-extension}. next, let $n$ be any $s$-module. note that for each $i$ we have $\hom_r(m_i, n) = \hom_s(m_i, n)$ as $r \to s$ is surjective. hence the condition that the inverse system $(\hom_r(m_i, n))_i$ satisfies mittag-leffler, implies that the system $(\hom_s(m_i, n))_i$ satisfies mittag-leffler. thus $m$ is mittag-leffler over $s$ by definition. \end{proof} \begin{remark} \label{remark-go-up-ml-modules} let $r \to s$ be a finite and finitely presented ring map. let $m$ be an $s$-module which is mittag-leffler as an $r$-module. then it is in general not the case that $m$ is mittag-leffler as an $s$-module. for example suppose that $s$ is the ring of dual numbers over $r$, i.e., $s = r \oplus r\epsilon$ with $\epsilon^2 = 0$. then an $s$-module consists of an $r$-module $m$ endowed with a square zero $r$-linear endomorphism $\epsilon : m \to m$. now suppose that $m_0$ is an $r$-module which is not mittag-leffler. choose a presentation $f_1 \xrightarrow{u} f_0 \to m_0 \to 0$ with $f_1$ and $f_0$ free $r$-modules. set $m = f_1 \oplus f_0$ with $$ \epsilon = \left( \begin{matrix} 0 & 0 \\ u & 0 \end{matrix} \right) : m \longrightarrow m. $$ then $m/\epsilon m \cong f_1 \oplus m_0$ is not mittag-leffler over $r = s/\epsilon s$, hence not mittag-leffler over $s$ (see lemma \ref{lemma-mod-ideal-ml-modules}). on the other hand, $m/\epsilon m = m \otimes_s s/\epsilon s$ which would be mittag-leffler over $s$ if $m$ was, see lemma \ref{lemma-tensor-ml-modules}. \end{remark} \section{interchanging direct products with tensor} \label{section-products-tensor} \noindent let $m$ be an $r$-module and let $(q_{\alpha})_{\alpha \in a}$ be a family of $r$-modules. then there is a canonical map $m \otimes_r \left( \prod_{\alpha \in a} q_{\alpha} \right) \to \prod_{\alpha \in a} ( m \otimes_r q_{\alpha})$ given on pure tensors by $x \otimes (q_{\alpha}) \mapsto (x \otimes q_{\alpha})$. this map is not necessarily injective or surjective, as the following example shows. \begin{example} \label{example-q-not-ml} take $r = \mathbf{z}$, $m = \mathbf{q}$, and consider the family $q_n = \mathbf{z}/n$ for $n \geq 1$. then $\prod_n (m \otimes q_n) = 0$. however there is an injection $\mathbf{q} \to m \otimes (\prod_n q_n)$ obtained by tensoring the injection $\mathbf{z} \to \prod_n q_n$ by $m$, so $m \otimes (\prod_n q_n)$ is nonzero. thus $m \otimes (\prod_n q_n) \to \prod_n (m \otimes q_n)$ is not injective. \medskip\noindent on the other hand, take again $r = \mathbf{z}$, $m = \mathbf{q}$, and let $q_n = \mathbf{z}$ for $n \geq 1$. the image of $m \otimes (\prod_n q_n) \to \prod_n (m \otimes q_n) = \prod_n m$ consists precisely of sequences of the form $(a_n/m)_{n \geq 1}$ with $a_n \in \mathbf{z}$ and $m$ some nonzero integer. hence the map is not surjective. \end{example} \noindent we determine below the precise conditions needed on $m$ for the map $m \otimes_r \left( \prod_{\alpha} q_{\alpha} \right) \to \prod_{\alpha} (m \otimes_r q_{\alpha})$ to be surjective, bijective, or injective for all choices of $(q_{\alpha})_{\alpha \in a}$. this is relevant because the modules for which it is injective turn out to be exactly mittag-leffler modules (proposition \ref{proposition-ml-tensor}). in what follows, if $m$ is an $r$-module and $a$ a set, we write $m^a$ for the product $\prod_{\alpha \in a} m$. \begin{proposition} \label{proposition-fg-tensor} let $m$ be an $r$-module. the following are equivalent: \begin{enumerate} \item $m$ is finitely generated. \item for every family $(q_{\alpha})_{\alpha \in a}$ of $r$-modules, the canonical map $m \otimes_r \left( \prod_{\alpha} q_{\alpha} \right) \to \prod_{\alpha} (m \otimes_r q_{\alpha})$ is surjective. \item for every $r$-module $q$ and every set $a$, the canonical map $m \otimes_r q^{a} \to (m \otimes_r q)^{a}$ is surjective. \item for every set $a$, the canonical map $m \otimes_r r^{a} \to m^{a}$ is surjective. \end{enumerate} \end{proposition} \begin{proof} first we prove (1) implies (2). choose a surjection $r^n \to m$ and consider the commutative diagram $$ \xymatrix{ r^n \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r]^{\cong} \ar[d] & \prod_{\alpha} (r^n \otimes_r q_{\alpha}) \ar[d] \\ m \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] & \prod_{\alpha} ( m \otimes_r q_{\alpha}). } $$ the top arrow is an isomorphism and the vertical arrows are surjections. we conclude that the bottom arrow is a surjection. \medskip\noindent obviously (2) implies (3) implies (4), so it remains to prove (4) implies (1). in fact for (1) to hold it suffices that the element $d = (x)_{x \in m}$ of $m^m$ is in the image of the map $f: m \otimes_r r^{m} \to m^m$. in this case $d = \sum_{i = 1}^{n} f(x_i \otimes a_i)$ for some $x_i \in m$ and $a_i \in r^m$. if for $x \in m$ we write $p_x: m^m \to m$ for the projection onto the $x$-th factor, then $$ x = p_x(d) = \sum\nolimits_{i = 1}^{n} p_x(f(x_i \otimes a_i)) = \sum\nolimits_{i=1}^{n} p_x(a_i) x_i. $$ thus $x_1, \ldots, x_n$ generate $m$. \end{proof} \begin{proposition} \label{proposition-fp-tensor} let $m$ be an $r$-module. the following are equivalent: \begin{enumerate} \item $m$ is finitely presented. \item for every family $(q_{\alpha})_{\alpha \in a}$ of $r$-modules, the canonical map $m \otimes_r \left( \prod_{\alpha} q_{\alpha} \right) \to \prod_{\alpha} (m \otimes_r q_{\alpha})$ is bijective. \item for every $r$-module $q$ and every set $a$, the canonical map $m \otimes_r q^{a} \to (m \otimes_r q)^{a}$ is bijective. \item for every set $a$, the canonical map $m \otimes_r r^{a} \to m^{a}$ is bijective. \end{enumerate} \end{proposition} \begin{proof} first we prove (1) implies (2). choose a presentation $r^m \to r^n \to m$ and consider the commutative diagram $$ \xymatrix{ r^m \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d]^{\cong} & r^n \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d]^{\cong} & m \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d] & 0 \\ \prod_{\alpha} (r^m \otimes_r q_{\alpha}) \ar[r] & \prod_{\alpha} (r^n \otimes_r q_{\alpha}) \ar[r] & \prod_{\alpha} (m \otimes_r q_{\alpha}) \ar[r] & 0. } $$ the first two vertical arrows are isomorphisms and the rows are exact. this implies that the map $m \otimes_r (\prod_{\alpha} q_{\alpha}) \to \prod_{\alpha} ( m \otimes_r q_{\alpha})$ is surjective and, by a diagram chase, also injective. hence (2) holds. \medskip\noindent obviously (2) implies (3) implies (4), so it remains to prove (4) implies (1). from proposition \ref{proposition-fg-tensor}, if (4) holds we already know that $m$ is finitely generated. so we can choose a surjection $f \to m$ where $f$ is free and finite. let $k$ be the kernel. we must show $k$ is finitely generated. for any set $a$, we have a commutative diagram $$ \xymatrix{ & k \otimes_r r^a \ar[r] \ar[d]_{f_3} & f \otimes_r r^a \ar[r] \ar[d]_{f_2}^{\cong} & m \otimes_r r^a \ar[r] \ar[d]_{f_1}^{\cong} & 0 \\ 0 \ar[r] & k^a \ar[r] & f^a \ar[r] & m^a \ar[r] & 0 . } $$ the map $f_1$ is an isomorphism by assumption, the map $f_2$ is an isomorphism since $f$ is free and finite, and the rows are exact. a diagram chase shows that $f_3$ is surjective, hence by proposition \ref{proposition-fg-tensor} we get that $k$ is finitely generated. \end{proof} \noindent we need the following lemma for the next proposition. \begin{lemma} \label{lemma-kernel-tensored-fp} let $m$ be an $r$-module, $p$ a finitely presented $r$-module, and $f: p \to m$ a map. let $q$ be an $r$-module and suppose $x \in \ker(p \otimes q \to m \otimes q)$. then there exists a finitely presented $r$-module $p'$ and a map $f': p \to p'$ such that $f$ factors through $f'$ and $x \in \ker(p \otimes q \to p' \otimes q)$. \end{lemma} \begin{proof} write $m$ as a colimit $m = \colim_{i \in i} m_i$ of a directed system of finitely presented modules $m_i$. since $p$ is finitely presented, the map $f: p \to m$ factors through $m_j \to m$ for some $j \in i$. upon tensoring by $q$ we have a commutative diagram $$ \xymatrix{ & m_j \otimes q \ar[dr] & \\ p \otimes q \ar[ur] \ar[rr] & & m \otimes q . } $$ the image $y$ of $x$ in $m_j \otimes q$ is in the kernel of $m_j \otimes q \to m \otimes q$. since $m \otimes q = \colim_{i \in i} (m_i \otimes q)$, this means $y$ maps to $0$ in $m_{j'} \otimes q$ for some $j' \geq j$. thus we may take $p' = m_{j'}$ and $f'$ to be the composite $p \to m_j \to m_{j'}$. \end{proof} \begin{proposition} \label{proposition-ml-tensor} let $m$ be an $r$-module. the following are equivalent: \begin{enumerate} \item $m$ is mittag-leffler. \item for every family $(q_{\alpha})_{\alpha \in a}$ of $r$-modules, the canonical map $m \otimes_r \left( \prod_{\alpha} q_{\alpha} \right) \to \prod_{\alpha} (m \otimes_r q_{\alpha})$ is injective. \end{enumerate} \end{proposition} \begin{proof} first we prove (1) implies (2). suppose $m$ is mittag-leffler and let $x$ be in the kernel of $m \otimes_r (\prod_{\alpha} q_{\alpha}) \to \prod_{\alpha} (m \otimes_r q_{\alpha})$. write $m$ as a colimit $m = \colim_{i \in i} m_i$ of a directed system of finitely presented modules $m_i$. then $m \otimes_r (\prod_{\alpha} q_{\alpha})$ is the colimit of $m_i \otimes_r (\prod_{\alpha} q_{\alpha})$. so $x$ is the image of an element $x_i \in m_i \otimes_r (\prod_{\alpha} q_{\alpha})$. we must show that $x_i$ maps to $0$ in $m_j \otimes_r (\prod_{\alpha} q_{\alpha})$ for some $j \geq i$. since $m$ is mittag-leffler, we may choose $j \geq i$ such that $m_i \to m_j$ and $m_i \to m$ dominate each other. then consider the commutative diagram $$ \xymatrix{ m \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] & \prod_{\alpha} (m \otimes_r q_{\alpha}) \\ m_i \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r]^{\cong} \ar[d] \ar[u] & \prod_{\alpha} (m_i \otimes_r q_{\alpha}) \ar[d] \ar[u] \\ m_j \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r]^{\cong} & \prod_{\alpha} (m_j \otimes_r q_{\alpha}) } $$ whose bottom two horizontal maps are isomorphisms, according to proposition \ref{proposition-fp-tensor}. since $x_i$ maps to $0$ in $\prod_{\alpha} (m \otimes_r q_{\alpha})$, its image in $\prod_{\alpha} (m_i \otimes_r q_{\alpha})$ is in the kernel of the map $\prod_{\alpha} (m_i \otimes_r q_{\alpha}) \to \prod_{\alpha} (m \otimes_r q_{\alpha})$. but this kernel equals the kernel of $\prod_{\alpha} (m_i \otimes_r q_{\alpha}) \to \prod_{\alpha} (m_j \otimes_r q_{\alpha})$ according to the choice of $j$. thus $x_i$ maps to $0$ in $\prod_{\alpha} (m_j \otimes_r q_{\alpha})$ and hence to $0$ in $m_j \otimes_r (\prod_{\alpha} q_{\alpha})$. \medskip\noindent now suppose (2) holds. we prove $m$ satisfies formulation (1) of being mittag-leffler from proposition \ref{proposition-ml-characterization}. let $f: p \to m$ be a map from a finitely presented module $p$ to $m$. choose a set $b$ of representatives of the isomorphism classes of finitely presented $r$-modules. let $a$ be the set of pairs $(q, x)$ where $q \in b$ and $x \in \ker(p \otimes q \to m \otimes q)$. for $\alpha = (q, x) \in a$, we write $q_{\alpha}$ for $q$ and $x_{\alpha}$ for $x$. consider the commutative diagram $$ \xymatrix{ m \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] & \prod_{\alpha} (m \otimes_r q_{\alpha}) \\ p \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r]^{\cong} \ar[u] & \prod_{\alpha} (p \otimes_r q_{\alpha}) \ar[u] . } $$ the top arrow is an injection by assumption, and the bottom arrow is an isomorphism by proposition \ref{proposition-fp-tensor}. let $x \in p \otimes_r (\prod_{\alpha} q_{\alpha})$ be the element corresponding to $(x_{\alpha}) \in \prod_{\alpha} (p \otimes_r q_{\alpha})$ under this isomorphism. then $x \in \ker( p \otimes_r (\prod_{\alpha} q_{\alpha}) \to m \otimes_r (\prod_{\alpha} q_{\alpha}))$ since the top arrow in the diagram is injective. by lemma \ref{lemma-kernel-tensored-fp}, we get a finitely presented module $p'$ and a map $f': p \to p'$ such that $f: p \to m$ factors through $f'$ and $x \in \ker(p \otimes_r (\prod_{\alpha} q_{\alpha}) \to p' \otimes_r (\prod_{\alpha} q_{\alpha}))$. we have a commutative diagram $$ \xymatrix{ p' \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r]^{\cong} & \prod_{\alpha} (p' \otimes_r q_{\alpha}) \\ p \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r]^{\cong} \ar[u] & \prod_{\alpha} (p \otimes_r q_{\alpha}) \ar[u] . } $$ where both the top and bottom arrows are isomorphisms by proposition \ref{proposition-fp-tensor}. thus since $x$ is in the kernel of the left vertical map, $(x_{\alpha})$ is in the kernel of the right vertical map. this means $x_{\alpha} \in \ker(p \otimes_r q_{\alpha} \to p' \otimes_r q_{\alpha})$ for every $\alpha \in a$. by the definition of $a$ this means $\ker(p \otimes_r q \to p' \otimes_r q) \supset \ker(p \otimes_r q \to m \otimes_r q)$ for all finitely presented $q$ and, since $f: p \to m$ factors through $f': p \to p'$, actually equality holds. by lemma \ref{lemma-domination-fp}, $f$ and $f'$ dominate each other. \end{proof} \begin{lemma} \label{lemma-minimal-contains} let $m$ be a flat mittag-leffler module over $r$. let $f$ be an $r$-module and let $x \in f \otimes_r m$. then there exists a smallest submodule $f' \subset f$ such that $x \in f' \otimes_r m$. also, $f'$ is a finite $r$-module. \end{lemma} \begin{proof} since $m$ is flat we have $f' \otimes_r m \subset f \otimes_r m$ if $f' \subset f$ is a submodule, hence the statement makes sense. let $i = \{f' \subset f \mid x \in f' \otimes_r m\}$ and for $i \in i$ denote $f_i \subset f$ the corresponding submodule. then $x$ maps to zero under the map $$ f \otimes_r m \longrightarrow \prod (f/f_i \otimes_r m) $$ whence by proposition \ref{proposition-ml-tensor} $x$ maps to zero under the map $$ f \otimes_r m \longrightarrow \left(\prod f/f_i\right) \otimes_r m $$ since $m$ is flat the kernel of this arrow is $(\bigcap f_i) \otimes_r m$ which proves that $f' = \bigcap f_i$. to see that $f'$ is a finite module, suppose that $x = \sum_{j = 1, \ldots, m} f_j \otimes m_j$ with $f_j \in f'$ and $m_j \in m$. then $x \in f'' \otimes_r m$ where $f'' \subset f'$ is the submodule generated by $f_1, \ldots, f_m$. of course then $f'' = f'$ and we conclude the final statement holds. \end{proof} \begin{lemma} \label{lemma-pure-submodule-ml} let $0 \to m_1 \to m_2 \to m_3 \to 0$ be a universally exact sequence of $r$-modules. then: \begin{enumerate} \item if $m_2$ is mittag-leffler, then $m_1$ is mittag-leffler. \item if $m_1$ and $m_3$ are mittag-leffler, then $m_2$ is mittag-leffler. \end{enumerate} \end{lemma} \begin{proof} for any family $(q_{\alpha})_{\alpha \in a}$ of $r$-modules we have a commutative diagram $$ \xymatrix{ 0 \ar[r] & m_1 \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d] & m_2 \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d] & m_3 \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d] & 0 \\ 0 \ar[r] & \prod_{\alpha}(m_1 \otimes q_{\alpha}) \ar[r] & \prod_{\alpha}(m_2 \otimes q_{\alpha}) \ar[r] & \prod_{\alpha}(m_3 \otimes q_{\alpha})\ar[r] & 0 } $$ with exact rows. thus (1) and (2) follow from proposition \ref{proposition-ml-tensor}. \end{proof} \begin{lemma} \label{lemma-quotient-module-ml} let $m_1 \to m_2 \to m_3 \to 0$ be an exact sequence of $r$-modules. if $m_1$ is finitely generated and $m_2$ is mittag-leffler, then $m_3$ is mittag-leffler. \end{lemma} \begin{proof} for any family $(q_{\alpha})_{\alpha \in a}$ of $r$-modules, since tensor product is right exact, we have a commutative diagram $$ \xymatrix{ m_1 \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d] & m_2 \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d] & m_3 \otimes_r (\prod_{\alpha} q_{\alpha}) \ar[r] \ar[d] & 0 \\ \prod_{\alpha}(m_1 \otimes q_{\alpha}) \ar[r] & \prod_{\alpha}(m_2 \otimes q_{\alpha}) \ar[r] & \prod_{\alpha}(m_3 \otimes q_{\alpha})\ar[r] & 0 } $$ with exact rows. by proposition \ref{proposition-fg-tensor} the left vertical arrow is surjective. by proposition \ref{proposition-ml-tensor} the middle vertical arrow is injective. a diagram chase shows the right vertical arrow is injective. hence $m_3$ is mittag-leffler by proposition \ref{proposition-ml-tensor}. \end{proof} \begin{lemma} \label{lemma-colimit-universally-injective-ml} if $m = \colim m_i$ is the colimit of a directed system of mittag-leffler $r$-modules $m_i$ with universally injective transition maps, then $m$ is mittag-leffler. \end{lemma} \begin{proof} let $(q_{\alpha})_{\alpha \in a}$ be a family of $r$-modules. we have to show that $m \otimes_r (\prod q_\alpha) \to \prod m \otimes_r q_\alpha$ is injective and we know that $m_i \otimes_r (\prod q_\alpha) \to \prod m_i \otimes_r q_\alpha$ is injective for each $i$, see proposition \ref{proposition-ml-tensor}. since $\otimes$ commutes with filtered colimits, it suffices to show that $\prod m_i \otimes_r q_\alpha \to \prod m \otimes_r q_\alpha$ is injective. this is clear as each of the maps $m_i \otimes_r q_\alpha \to m \otimes_r q_\alpha$ is injective by our assumption that the transition maps are universally injective. \end{proof} \begin{lemma} \label{lemma-direct-sum-ml} if $m = \bigoplus_{i \in i} m_i$ is a direct sum of $r$-modules, then $m$ is mittag-leffler if and only if each $m_i$ is mittag-leffler. \end{lemma} \begin{proof} the ``only if'' direction follows from lemma \ref{lemma-pure-submodule-ml} (1) and the fact that a split short exact sequence is universally exact. the converse follows from lemma \ref{lemma-colimit-universally-injective-ml} but we can also argue it directly as follows. first note that if $i$ is finite then this follows from lemma \ref{lemma-pure-submodule-ml} (2). for general $i$, if all $m_i$ are mittag-leffler then we prove the same of $m$ by verifying condition (1) of proposition \ref{proposition-ml-characterization}. let $f: p \to m$ be a map from a finitely presented module $p$. then $f$ factors as $p \xrightarrow{f'} \bigoplus_{i' \in i'} m_{i'} \hookrightarrow \bigoplus_{i \in i} m_i$ for some finite subset $i'$ of $i$. by the finite case $\bigoplus_{i' \in i'} m_{i'}$ is mittag-leffler and hence there exists a finitely presented module $q$ and a map $g: p \to q$ such that $g$ and $f'$ dominate each other. then also $g$ and $f$ dominate each other. \end{proof} \begin{lemma} \label{lemma-flat-ml-over-ml-ring} let $r \to s$ be a ring map. let $m$ be an $s$-module. if $s$ is mittag-leffler as an $r$-module, and $m$ is flat and mittag-leffler as an $s$-module, then $m$ is mittag-leffler as an $r$-module. \end{lemma} \begin{proof} we deduce this from the characterization of proposition \ref{proposition-ml-tensor}. namely, suppose that $q_\alpha$ is a family of $r$-modules. consider the composition $$ \xymatrix{ m \otimes_r \prod_\alpha q_\alpha = m \otimes_s s \otimes_r \prod_\alpha q_\alpha \ar[d] \\ m \otimes_s \prod_\alpha (s \otimes_r q_\alpha) \ar[d] \\ \prod_\alpha (m \otimes_s s \otimes_r q_\alpha) = \prod_\alpha (m \otimes_r q_\alpha) } $$ the first arrow is injective as $m$ is flat over $s$ and $s$ is mittag-leffler over $r$ and the second arrow is injective as $m$ is mittag-leffler over $s$. hence $m$ is mittag-leffler over $r$. \end{proof} \section{coherent rings} \label{section-coherent} \noindent we use the discussion on interchanging $\prod$ and $\otimes$ to determine for which rings products of flat modules are flat. it turns out that these are the so-called coherent rings. you may be more familiar with the notion of a coherent $\mathcal{o}_x$-module on a ringed space, see modules, section \ref{modules-section-coherent}. \begin{definition} \label{definition-coherent} let $r$ be a ring. let $m$ be an $r$-module. \begin{enumerate} \item we say $m$ is a {\it coherent module} if it is finitely generated and every finitely generated submodule of $m$ is finitely presented over $r$. \item we say $r$ is a {\it coherent ring} if it is coherent as a module over itself. \end{enumerate} \end{definition} \noindent thus a ring is coherent if and only if every finitely generated ideal is finitely presented as a module. \begin{example} \label{example-valuation-ring-coherent} a valuation ring is a coherent ring. namely, every nonzero finitely generated ideal is principal (lemma \ref{lemma-characterize-valuation-ring}), hence free as a valuation ring is a domain, hence finitely presented. \end{example} \noindent the category of coherent modules is abelian. \begin{lemma} \label{lemma-coherent} let $r$ be a ring. \begin{enumerate} \item a finite submodule of a coherent module is coherent. \item let $\varphi : n \to m$ be a homomorphism from a finite module to a coherent module. then $\ker(\varphi)$ is finite, $\im(\varphi)$ is coherent, and $\coker(\varphi)$ is coherent. \item let $\varphi : n \to m$ be a homomorphism of coherent modules. then $\ker(\varphi)$ and $\coker(\varphi)$ are coherent modules. \item given a short exact sequence of $r$-modules $0 \to m_1 \to m_2 \to m_3 \to 0$ if two out of three are coherent so is the third. \end{enumerate} \end{lemma} \begin{proof} the first statement is immediate from the definition. \medskip\noindent let $\varphi : n \to m$ satisfy the assumptions of (2). first, $\im(\varphi)$ is finite, hence coherent by (1). in particular $\im(\varphi)$ is finitely presented, so applying lemma \ref{lemma-extension} to the exact sequence $0 \to \ker(\varphi) \to n \to \im(\varphi) \to 0$ we see that $\ker(\varphi)$ is finite. to prove that $\coker(\varphi)$ is coherent, let $e \subset \coker(\varphi)$ be a finite submodule, and let $e'$ be its inverse image in $m$. from the exact sequence $0 \to \im(\varphi) \to e' \to e \to 0$ and since $\ker(\varphi)$ is finite we conclude by lemma \ref{lemma-extension} that $e' \subset m$ is finite, hence finitely presented because $m$ is coherent. the same exact sequence then shows that $e$ is finitely presented, whence our claim. \medskip\noindent part (3) follows immediately from (1) and (2). \medskip\noindent let $0 \to m_1 \xrightarrow{i} m_2 \xrightarrow{p} m_3 \to 0$ be a short exact sequence of $r$-modules as in (4). it remains to prove that if $m_1$ and $m_3$ are coherent so is $m_2$. by lemma \ref{lemma-extension} we see that $m_2$ is finite. let $n_2 \subset m_2$ be a finite submodule. put $n_3 = p(n_2) \subset m_3$ and $n_1 = i^{-1}(n_2) \subset m_1$. we have an exact sequence $0 \to n_1 \to n_2 \to n_3 \to 0$. clearly $n_3$ is finite (as a quotient of $n_2$), hence finitely presented (as a finite submodule of $m_3$). it follows by lemma \ref{lemma-extension} (5) that $n_1$ is finite, hence finitely presented (as a finite submodule of $m_1$). we conclude by lemma \ref{lemma-extension} (2) that $n_2$ is finitely presented. \end{proof} \begin{lemma} \label{lemma-coherent-ring} let $r$ be a ring. if $r$ is coherent, then a module is coherent if and only if it is finitely presented. \end{lemma} \begin{proof} it is clear that a coherent module is finitely presented (over any ring). conversely, if $r$ is coherent, then $r^{\oplus n}$ is coherent and so is the cokernel of any map $r^{\oplus m} \to r^{\oplus n}$, see lemma \ref{lemma-coherent}. \end{proof} \begin{lemma} \label{lemma-noetherian-coherent} a noetherian ring is a coherent ring. \end{lemma} \begin{proof} by lemma \ref{lemma-noetherian-finite-type-is-finite-presentation} any finite $r$-module is finitely presented. in particular any ideal of $r$ is finitely presented. \end{proof} \begin{proposition} \label{proposition-characterize-coherent} \begin{reference} this is \cite[theorem 2.1]{chase}. \end{reference} let $r$ be a ring. the following are equivalent \begin{enumerate} \item $r$ is coherent, \item any product of flat $r$-modules is flat, and \item for every set $a$ the module $r^a$ is flat. \end{enumerate} \end{proposition} \begin{proof} assume $r$ coherent, and let $q_\alpha$, $\alpha \in a$ be a set of flat $r$-modules. we have to show that $i \otimes_r \prod_\alpha q_\alpha \to \prod q_\alpha$ is injective for every finitely generated ideal $i$ of $r$, see lemma \ref{lemma-flat}. since $r$ is coherent $i$ is an $r$-module of finite presentation. hence $i \otimes_r \prod_\alpha q_\alpha = \prod i \otimes_r q_\alpha$ by proposition \ref{proposition-fp-tensor}. the desired injectivity follows as $i \otimes_r q_\alpha \to q_\alpha$ is injective by flatness of $q_\alpha$. \medskip\noindent the implication (2) $\rightarrow$ (3) is trivial. \medskip\noindent assume that the $r$-module $r^a$ is flat for every set $a$. let $i$ be a finitely generated ideal in $r$. then $i \otimes_r r^a \to r^a$ is injective by assumption. by proposition \ref{proposition-fg-tensor} and the finiteness of $i$ the image is equal to $i^a$. hence $i \otimes_r r^a = i^a$ for every set $a$ and we conclude that $i$ is finitely presented by proposition \ref{proposition-fp-tensor}. \end{proof} \section{examples and non-examples of mittag-leffler modules} \label{section-examples} \noindent we end this section with some examples and non-examples of mittag-leffler modules. \begin{example} \label{example-ml} mittag-leffler modules. \begin{enumerate} \item any finitely presented module is mittag-leffler. this follows, for instance, from proposition \ref{proposition-ml-characterization} (1). in general, it is true that a finitely generated module is mittag-leffler if and only it is finitely presented. this follows from propositions \ref{proposition-fg-tensor}, \ref{proposition-fp-tensor}, and \ref{proposition-ml-tensor}. \item a free module is mittag-leffler since it satisfies condition (1) of proposition \ref{proposition-ml-characterization}. \item by the previous example together with lemma \ref{lemma-direct-sum-ml}, projective modules are mittag-leffler. \end{enumerate} \end{example} \noindent we also want to add to our list of examples power series rings over a noetherian ring $r$. this will be a consequence the following lemma. \begin{lemma} \label{lemma-flat-ml-criterion} let $m$ be a flat $r$-module. the following are equivalent \begin{enumerate} \item $m$ is mittag-leffler, and \item if $f$ is a finite free $r$-module and $x \in f \otimes_r m$, then there exists a smallest submodule $f'$ of $f$ such that $x \in f' \otimes_r m$. \end{enumerate} \end{lemma} \begin{proof} the implication (1) $\rightarrow$ (2) is a special case of lemma \ref{lemma-minimal-contains}. assume (2). by theorem \ref{theorem-lazard} we can write $m$ as the colimit $m = \colim_{i \in i} m_i$ of a directed system $(m_i, f_{ij})$ of finite free $r$-modules. by remark \ref{remark-flat-ml}, it suffices to show that the inverse system $(\hom_r(m_i, r), \hom_r(f_{ij}, r))$ is mittag-leffler. in other words, fix $i \in i$ and for $j \geq i$ let $q_j$ be the image of $\hom_r(m_j, r) \to \hom_r(m_i, r)$; we must show that the $q_j$ stabilize. \medskip\noindent since $m_i$ is free and finite, we can make the identification $\hom_r(m_i, m_j) = \hom_r(m_i, r) \otimes_r m_j$ for all $j$. using the fact that the $m_j$ are free, it follows that for $j \geq i$, $q_j$ is the smallest submodule of $\hom_r(m_i, r)$ such that $f_{ij} \in q_j \otimes_r m_j$. under the identification $\hom_r(m_i, m) = \hom_r(m_i, r) \otimes_r m$, the canonical map $f_i: m_i \to m$ is in $\hom_r(m_i, r) \otimes_r m$. by the assumption on $m$, there exists a smallest submodule $q$ of $\hom_r(m_i, r)$ such that $f_i \in q \otimes_r m$. we are going to show that the $q_j$ stabilize to $q$. \medskip\noindent for $j \geq i$ we have a commutative diagram $$ \xymatrix{ q_j \otimes_r m_j \ar[r] \ar[d] & \hom_r(m_i, r) \otimes_r m_j \ar[d] \\ q_j \otimes_r m \ar[r] & \hom_r(m_i, r) \otimes_r m. } $$ since $f_{ij} \in q_j \otimes_r m_j$ maps to $f_i \in \hom_r(m_i, r) \otimes_r m$, it follows that $f_i \in q_j \otimes_r m$. hence, by the choice of $q$, we have $q \subset q_j$ for all $j \geq i$. \medskip\noindent since the $q_j$ are decreasing and $q \subset q_j$ for all $j \geq i$, to show that the $q_j$ stabilize to $q$ it suffices to find a $j \geq i$ such that $q_j \subset q$. as an element of $$ \hom_r(m_i, r) \otimes_r m = \colim_{j \in j} (\hom_r(m_i, r) \otimes_r m_j), $$ $f_i$ is the colimit of $f_{ij}$ for $j \geq i$, and $f_i$ also lies in the submodule $$ \colim_{j \in j} (q \otimes_r m_j) \subset \colim_{j \in j} (\hom_r(m_i, r) \otimes_r m_j). $$ it follows that for some $j \geq i$, $f_{ij}$ lies in $q \otimes_r m_j$. since $q_j$ is the smallest submodule of $\hom_r(m_i, r)$ with $f_{ij} \in q_j \otimes_r m_j$, we conclude $q_j\subset q$. \end{proof} \begin{lemma} \label{lemma-product-over-noetherian-ring} let $r$ be a noetherian ring and $a$ a set. then $m = r^a$ is a flat and mittag-leffler $r$-module. \end{lemma} \begin{proof} combining lemma \ref{lemma-noetherian-coherent} and proposition \ref{proposition-characterize-coherent} we see that $m$ is flat over $r$. we show that $m$ satisfies the condition of lemma \ref{lemma-flat-ml-criterion}. let $f$ be a free finite $r$-module. if $f'$ is any submodule of $f$ then it is finitely presented since $r$ is noetherian. so by proposition \ref{proposition-fp-tensor} we have a commutative diagram $$ \xymatrix{ f' \otimes_r m \ar[r] \ar[d]^{\cong} & f \otimes_r m \ar[d]^{\cong} \\ (f')^a \ar[r] & f^a } $$ by which we can identify the map $f' \otimes_r m \to f \otimes_r m$ with $(f')^a \to f^a$. hence if $x \in f \otimes_r m$ corresponds to $(x_\alpha) \in f^a$, then the submodule of $f'$ of $f$ generated by the $x_\alpha$ is the smallest submodule of $f$ such that $x \in f' \otimes_r m$. \end{proof} \begin{lemma} \label{lemma-power-series-ml} let $r$ be a noetherian ring and $n$ a positive integer. then the $r$-module $m = r[[t_1, \ldots, t_n]]$ is flat and mittag-leffler. \end{lemma} \begin{proof} as an $r$-module, we have $m = r^a$ for a (countable) set $a$. hence this lemma is a special case of lemma \ref{lemma-product-over-noetherian-ring}. \end{proof} \begin{example} \label{example-not-ml} non mittag-leffler modules. \begin{enumerate} \item by example \ref{example-q-not-ml} and proposition \ref{proposition-ml-tensor}, $\mathbf{q}$ is not a mittag-leffler $\mathbf{z}$-module. \item we prove below (theorem \ref{theorem-projectivity-characterization}) that for a flat and countably generated module, projectivity is equivalent to being mittag-leffler. thus any flat, countably generated, non-projective module $m$ is an example of a non-mittag-leffler module. for such an example, see remark \ref{remark-warning}. \item let $k$ be a field. let $r = k[[x]]$. the $r$-module $m = \prod_{n \in \mathbf{n}} r/(x^n)$ is not mittag-leffler. namely, consider the element $\xi = (\xi_1, \xi_2, \xi_3, \ldots)$ defined by $\xi_{2^m} = x^{2^{m - 1}}$ and $\xi_n = 0$ else, so $$ \xi = (0, x, 0, x^2, 0, 0, 0, x^4, 0, 0, 0, 0, 0, 0, 0, x^8, \ldots) $$ then the annihilator of $\xi$ in $m/x^{2^m}m$ is generated $x^{2^{m - 1}}$ for $m \gg 0$. but if $m$ was mittag-leffler, then there would exist a finite $r$-module $q$ and an element $\xi' \in q$ such that the annihilator of $\xi'$ in $q/x^l q$ agrees with the annihilator of $\xi$ in $m/x^l m$ for all $l \geq 1$, see proposition \ref{proposition-ml-characterization} (1). now you can prove there exists an integer $a \geq 0$ such that the annihilator of $\xi'$ in $q/x^l q$ is generated by either $x^a$ or $x^{l - a}$ for all $l \gg 0$ (depending on whether $\xi' \in q$ is torsion or not). the combination of the above would give for all $l = 2^m >> 0$ the equality $a = l/2$ or $l - a = l/2$ which is nonsensical. \item the same argument shows that $(x)$-adic completion of $\bigoplus_{n \in \mathbf{n}} r/(x^n)$ is not mittag-leffler over $r = k[[x]]$ (hint: $\xi$ is actually an element of this completion). \item let $r = k[a, b]/(a^2, ab, b^2)$. let $s$ be the finitely presented $r$-algebra with presentation $s = r[t]/(at - b)$. then as an $r$-module $s$ is countably generated and indecomposable (details omitted). on the other hand, $r$ is artinian local, hence complete local, hence a henselian local ring, see lemma \ref{lemma-complete-henselian}. if $s$ was mittag-leffler as an $r$-module, then it would be a direct sum of finite $r$-modules by lemma \ref{lemma-split-ml-henselian}. thus we conclude that $s$ is not mittag-leffler as an $r$-module. \end{enumerate} \end{example} \section{countably generated mittag-leffler modules} \label{section-ml-countable} \noindent it turns out that countably generated mittag-leffler modules have a particularly simple structure. \begin{lemma} \label{lemma-ml-countable-colimit} let $m$ be an $r$-module. write $m = \colim_{i \in i} m_i$ where $(m_i, f_{ij})$ is a directed system of finitely presented $r$-modules. if $m$ is mittag-leffler and countably generated, then there is a directed countable subset $i' \subset i$ such that $m \cong \colim_{i \in i'} m_i$. \end{lemma} \begin{proof} let $x_1, x_2, \ldots$ be a countable set of generators for $m$. for each $x_n$ choose $i \in i$ such that $x_n$ is in the image of the canonical map $f_i: m_i \to m$; let $i'_{0} \subset i$ be the set of all these $i$. now since $m$ is mittag-leffler, for each $i \in i'_{0}$ we can choose $j \in i$ such that $j \geq i$ and $f_{ij}: m_i \to m_j$ factors through $f_{ik}: m_i \to m_k$ for all $k \geq i$ (condition (3) of proposition \ref{proposition-ml-characterization}); let $i'_1$ be the union of $i'_0$ with all of these $j$. since $i'_1$ is a countable, we can enlarge it to a countable directed set $i'_{2} \subset i$. now we can apply the same procedure to $i'_{2}$ as we did to $i'_{0}$ to get a new countable set $i'_{3} \subset i$. then we enlarge $i'_{3}$ to a countable directed set $i'_{4}$. continuing in this way---adding in a $j$ as in proposition \ref{proposition-ml-characterization} (3) for each $ i \in i'_{\ell}$ if $\ell$ is odd and enlarging $i'_{\ell}$ to a directed set if $\ell$ is even---we get a sequence of subsets $i'_{\ell} \subset i$ for $\ell \geq 0$. the union $i' = \bigcup i'_{\ell}$ satisfies: \begin{enumerate} \item $i'$ is countable and directed; \item each $x_n$ is in the image of $f_i: m_i \to m$ for some $i \in i'$; \item if $i \in i'$, then there is $j \in i'$ such that $j \geq i$ and $f_{ij}: m_i \to m_j$ factors through $f_{ik}: m_i \to m_k$ for all $k \in i$ with $k \geq i$. in particular $\ker(f_{ik}) \subset \ker(f_{ij})$ for $k \geq i$. \end{enumerate} we claim that the canonical map $\colim_{i \in i'} m_i \to \colim_{i \in i} m_i = m$ is an isomorphism. by (2) it is surjective. for injectivity, suppose $x \in \colim_{i \in i'} m_i$ maps to $0$ in $\colim_{i \in i} m_i$. representing $x$ by an element $\tilde{x} \in m_i$ for some $i \in i'$, this means that $f_{ik}(\tilde{x}) = 0$ for some $k \in i, k \geq i$. but then by (3) there is $j \in i', j \geq i,$ such that $f_{ij}(\tilde{x}) = 0$. hence $x = 0$ in $\colim_{i \in i'} m_i$. \end{proof} \noindent lemma \ref{lemma-ml-countable-colimit} implies that a countably generated mittag-leffler module $m$ over $r$ is the colimit of a system $$ m_1 \to m_2 \to m_3 \to m_4 \to \ldots $$ with each $m_n$ a finitely presented $r$-module. to see this argue as in the proof of lemma \ref{lemma-ml-limit-nonempty} to see that a countable directed set has a cofinal subset isomorphic to $(\mathbf{n}, \geq)$. suppose $r = k[x_1, x_2, x_3, \ldots]$ and $m = r/(x_i)$. then $m$ is finitely generated but not finitely presented, hence not mittag-leffler (see example \ref{example-ml} part (1)). but of course you can write $m = \colim_n m_n$ by taking $m_n = r/(x_1, \ldots, x_n)$, hence the condition that you can write $m$ as such a limit does not imply that $m$ is mittag-leffler. \begin{lemma} \label{lemma-ml-countable} let $r$ be a ring. let $m$ be an $r$-module. assume $m$ is mittag-leffler and countably generated. for any $r$-module map $f : p \to m$ with $p$ finitely generated there exists an endomorphism $\alpha : m \to m$ such that \begin{enumerate} \item $\alpha : m \to m$ factors through a finitely presented $r$-module, and \item $\alpha \circ f = f$. \end{enumerate} \end{lemma} \begin{proof} write $m = \colim_{i \in i} m_i$ as a directed colimit of finitely presented $r$-modules with $i$ countable, see lemma \ref{lemma-ml-countable-colimit}. the transition maps are denoted $f_{ij}$ and we use $f_i : m_i \to m$ to denote the canonical maps into $m$. set $n = \prod_{s \in i} m_s$. denote $$ m_i^* = \hom_r(m_i, n) = \prod\nolimits_{s \in i} \hom_r(m_i, m_s) $$ so that $(m_i^*)$ is an inverse system of $r$-modules over $i$. note that $\hom_r(m, n) = \lim m_i^*$. as $m$ is mittag-leffler, we find for every $i \in i$ an index $k(i) \geq i$ such that $$ e_i := \bigcap\nolimits_{i' \geq i} \im(m_{i'}^* \to m_i^*) = \im(m_{k(i)}^* \to m_i^*) $$ choose and fix $j \in i$ such that $\im(p \to m) \subset \im(m_j \to m)$. this is possible as $p$ is finitely generated. set $k = k(j)$. let $x = (0, \ldots, 0, \text{id}_{m_k}, 0, \ldots, 0) \in m_k^*$ and note that this maps to $y = (0, \ldots, 0, f_{jk}, 0, \ldots, 0) \in m_j^*$. by our choice of $k$ we see that $y \in e_j$. by example \ref{example-ml-surjective-maps} the transition maps $e_i \to e_j$ are surjective for each $i \geq j$ and $\lim e_i = \lim m_i^* = \hom_r(m, n)$. hence lemma \ref{lemma-ml-limit-nonempty} guarantees there exists an element $z \in \hom_r(m, n)$ which maps to $y$ in $e_j \subset m_j^*$. let $z_k$ be the $k$th component of $z$. then $z_k : m \to m_k$ is a homomorphism such that $$ \xymatrix{ m \ar[r]_{z_k} & m_k \\ m_j \ar[ru]_{f_{jk}} \ar[u]^{f_j} } $$ commutes. let $\alpha : m \to m$ be the composition $f_k \circ z_k : m \to m_k \to m$. then $\alpha$ factors through a finitely presented module by construction and $\alpha \circ f_j = f_j$. since the image of $f$ is contained in the image of $f_j$ this also implies that $\alpha \circ f = f$. \end{proof} \noindent we will see later (see lemma \ref{lemma-split-ml-henselian}) that lemma \ref{lemma-ml-countable} means that a countably generated mittag-leffler module over a henselian local ring is a direct sum of finitely presented modules. \section{characterizing projective modules} \label{section-characterize-projective} \noindent the goal of this section is to prove that a module is projective if and only if it is flat, mittag-leffler, and a direct sum of countably generated modules (theorem \ref{theorem-projectivity-characterization} below). \begin{lemma} \label{lemma-countgen-projective} let $m$ be an $r$-module. if $m$ is flat, mittag-leffler, and countably generated, then $m$ is projective. \end{lemma} \begin{proof} by lazard's theorem (theorem \ref{theorem-lazard}), we can write $m = \colim_{i \in i} m_i$ for a directed system of finite free $r$-modules $(m_i, f_{ij})$ indexed by a set $i$. by lemma \ref{lemma-ml-countable-colimit}, we may assume $i$ is countable. now let $$ 0 \to n_1 \to n_2 \to n_3 \to 0 $$ be an exact sequence of $r$-modules. we must show that applying $\hom_r(m, -)$ preserves exactness. since $m_i$ is finite free, $$ 0 \to \hom_r(m_i, n_1) \to \hom_r(m_i, n_2) \to \hom_r(m_i, n_3) \to 0 $$ is exact for each $i$. since $m$ is mittag-leffler, $(\hom_r(m_i, n_{1}))$ is a mittag-leffler inverse system. so by lemma \ref{lemma-ml-exact-sequence}, $$ 0 \to \lim_{i \in i} \hom_r(m_i, n_1) \to \lim_{i \in i} \hom_r(m_i, n_2) \to \lim_{i \in i} \hom_r(m_i, n_3) \to 0 $$ is exact. but for any $r$-module $n$ there is a functorial isomorphism $\hom_r(m, n) \cong \lim_{i \in i} \hom_r(m_i, n)$, so $$ 0 \to \hom_r(m, n_1) \to \hom_r(m, n_2) \to \hom_r(m, n_3) \to 0 $$ is exact. \end{proof} \begin{remark} \label{remark-characterize-projective} lemma \ref{lemma-countgen-projective} does not hold without the countable generation assumption. for example, the $\mathbf z$-module $m = \mathbf{z}[[x]]$ is flat and mittag-leffler but not projective. it is mittag-leffler by lemma \ref{lemma-power-series-ml}. subgroups of free abelian groups are free, hence a projective $\mathbf z$-module is in fact free and so are its submodules. thus to show $m$ is not projective it suffices to produce a non-free submodule. fix a prime $p$ and consider the submodule $n$ consisting of power series $f(x) = \sum a_i x^i$ such that for every integer $m \geq 1$, $p^m$ divides $a_i$ for all but finitely many $i$. then $\sum a_i p^i x^i$ is in $n$ for all $a_i \in \mathbf{z}$, so $n$ is uncountable. thus if $n$ were free it would have uncountable rank and the dimension of $n/pn$ over $\mathbf{z}/p$ would be uncountable. this is not true as the elements $x^i \in n/pn$ for $i \geq 0$ span $n/pn$. \end{remark} \begin{theorem} \label{theorem-projectivity-characterization} let $m$ be an $r$-module. then $m$ is projective if and only it satisfies: \begin{enumerate} \item $m$ is flat, \item $m$ is mittag-leffler, \item $m$ is a direct sum of countably generated $r$-modules. \end{enumerate} \end{theorem} \begin{proof} first suppose $m$ is projective. then $m$ is a direct summand of a free module, so $m$ is flat and mittag-leffler since these properties pass to direct summands. by kaplansky's theorem (theorem \ref{theorem-projective-direct-sum}), $m$ satisfies (3). \medskip\noindent conversely, suppose $m$ satisfies (1)-(3). since being flat and mittag-leffler passes to direct summands, $m$ is a direct sum of flat, mittag-leffler, countably generated $r$-modules. lemma \ref{lemma-countgen-projective} implies $m$ is a direct sum of projective modules. hence $m$ is projective. \end{proof} \begin{lemma} \label{lemma-ml-ui-descent} let $f: m \to n$ be universally injective map of $r$-modules. suppose $m$ is a direct sum of countably generated $r$-modules, and suppose $n$ is flat and mittag-leffler. then $m$ is projective. \end{lemma} \begin{proof} by lemmas \ref{lemma-ui-flat-domain} and \ref{lemma-pure-submodule-ml}, $m$ is flat and mittag-leffler, so the conclusion follows from theorem \ref{theorem-projectivity-characterization}. \end{proof} \begin{lemma} \label{lemma-universally-injective-submodule-powerseries} let $r$ be a noetherian ring and let $m$ be a $r$-module. suppose $m$ is a direct sum of countably generated $r$-modules, and suppose there is a universally injective map $m \to r[[t_1, \ldots, t_n]]$ for some $n$. then $m$ is projective. \end{lemma} \begin{proof} follows from lemmas \ref{lemma-ml-ui-descent} and \ref{lemma-power-series-ml}. \end{proof} \section{ascending properties of modules} \label{section-ascent} \noindent all of the properties of a module in theorem \ref{theorem-projectivity-characterization} ascend along arbitrary ring maps: \begin{lemma} \label{lemma-ascend-properties-modules} let $r \to s$ be a ring map. let $m$ be an $r$-module. then: \begin{enumerate} \item if $m$ is flat, then the $s$-module $m \otimes_r s$ is flat. \item if $m$ is mittag-leffler, then the $s$-module $m \otimes_r s$ is mittag-leffler. \item if $m$ is a direct sum of countably generated $r$-modules, then the $s$-module $m \otimes_r s$ is a direct sum of countably generated $s$-modules. \item if $m$ is projective, then the $s$-module $m \otimes_r s$ is projective. \end{enumerate} \end{lemma} \begin{proof} all are obvious except (2). for this, use formulation (3) of being mittag-leffler from proposition \ref{proposition-ml-characterization} and the fact that tensoring commutes with taking colimits. alternatively, one can use the characterization of proposition \ref{proposition-ml-tensor}. \end{proof} \section{descending properties of modules} \label{section-descent} \noindent we address the faithfully flat descent of the properties from theorem \ref{theorem-projectivity-characterization} that characterize projectivity. in the presence of flatness, the property of being a mittag-leffler module descends: \begin{lemma} \label{lemma-ffdescent-ml} \begin{reference} email from juan pablo acosta lopez dated 12/20/14. \end{reference} let $r \to s$ be a faithfully flat ring map. let $m$ be an $r$-module. if the $s$-module $m \otimes_r s$ is mittag-leffler, then $m$ is mittag-leffler. \end{lemma} \begin{proof} write $m = \colim_{i\in i} m_i$ as a directed colimit of finitely presented $r$-modules $m_i$. using proposition \ref{proposition-ml-characterization}, we see that we have to prove that for each $i \in i$ there exists $i \leq j$, $j\in i$ such that $m_i\rightarrow m_j$ dominates $m_i\rightarrow m$. \medskip\noindent take $n$ the pushout $$ \xymatrix{ m_i \ar[r] \ar[d] & m_j \ar[d] \\ m \ar[r] & n } $$ then the lemma is equivalent to the existence of $j$ such that $m_j\rightarrow n$ is universally injective, see lemma \ref{lemma-domination-universally-injective}. observe that the tensorization by $s$ $$ \xymatrix{ m_i\otimes_r s \ar[r] \ar[d] & m_j\otimes_r s \ar[d] \\ m\otimes_r s \ar[r] & n\otimes_r s } $$ is a pushout diagram. so because $m \otimes_r s = \colim_{i\in i} m_i \otimes_r s$ expresses $m\otimes_r s$ as a colimit of $s$-modules of finite presentation, and $m\otimes_r s$ is mittag-leffler, there exists $j \geq i$ such that $m_j\otimes_r s\rightarrow n\otimes_r s$ is universally injective. so using that $r\rightarrow s$ is faithfully flat we conclude that $m_j\rightarrow n$ is universally injective too. \end{proof} \begin{lemma} \label{lemma-ffdescent-countable} let $r \to s$ be a faithfully flat ring map. let $m$ be an $r$-module. if the $s$-module $m \otimes_r s$ is countably generated, then $m$ is countably generated. \end{lemma} \begin{proof} say $m \otimes_r s$ is generated by the elements $y_i$, $i = 1, 2, 3, \ldots$. write $y_i = \sum_{j = 1, \ldots, n_i} x_{ij} \otimes s_{ij}$ for some $n_i \geq 0$, $x_{ij} \in m$ and $s_{ij} \in s$. denote $m' \subset m$ the submodule generated by the countable collection of elements $x_{ij}$. then $m' \otimes_r s \to m \otimes_r s$ is surjective as the image contains the generators $y_i$. since $s$ is faithfully flat over $r$ we conclude that $m' = m$ as desired. \end{proof} \noindent at this point the faithfully flat descent of countably generated projective modules follows easily. \begin{lemma} \label{lemma-ffdescent-countable-projectivity} let $r \to s$ be a faithfully flat ring map. let $m$ be an $r$-module. if the $s$-module $m \otimes_r s$ is countably generated and projective, then $m$ is countably generated and projective. \end{lemma} \begin{proof} follows from lemmas \ref{lemma-descend-properties-modules}, \ref{lemma-ffdescent-ml}, and \ref{lemma-ffdescent-countable} and theorem \ref{theorem-projectivity-characterization}. \end{proof} \noindent all that remains is to use d\'evissage to reduce descent of projectivity in the general case to the countably generated case. first, two simple lemmas. \begin{lemma} \label{lemma-lift-countably-generated-submodule} let $r \to s$ be a ring map, let $m$ be an $r$-module, and let $q$ be a countably generated $s$-submodule of $m \otimes_r s$. then there exists a countably generated $r$-submodule $p$ of $m$ such that $\im(p \otimes_r s \to m \otimes_r s)$ contains $q$. \end{lemma} \begin{proof} let $y_1, y_2, \ldots$ be generators for $q$ and write $y_j = \sum_k x_{jk} \otimes s_{jk}$ for some $x_{jk} \in m$ and $s_{jk} \in s$. then take $p$ be the submodule of $m$ generated by the $x_{jk}$. \end{proof} \begin{lemma} \label{lemma-adapted-submodule} let $r \to s$ be a ring map, and let $m$ be an $r$-module. suppose $m \otimes_r s = \bigoplus_{i \in i} q_i$ is a direct sum of countably generated $s$-modules $q_i$. if $n$ is a countably generated submodule of $m$, then there is a countably generated submodule $n'$ of $m$ such that $n' \supset n$ and $\im(n' \otimes_r s \to m \otimes_r s) = \bigoplus_{i \in i'} q_i$ for some subset $i' \subset i$. \end{lemma} \begin{proof} let $n'_0 = n$. we construct by induction an increasing sequence of countably generated submodules $n'_{\ell} \subset m$ for $\ell = 0, 1, 2, \ldots$ such that: if $i'_{\ell}$ is the set of $i \in i$ such that the projection of $\im(n'_{\ell} \otimes_r s \to m \otimes_r s)$ onto $q_i$ is nonzero, then $\im(n'_{\ell + 1} \otimes_r s \to m \otimes_r s)$ contains $q_i$ for all $i \in i'_{\ell}$. to construct $n'_{\ell + 1}$ from $n'_\ell$, let $q$ be the sum of (the countably many) $q_i$ for $i \in i'_{\ell}$, choose $p$ as in lemma \ref{lemma-lift-countably-generated-submodule}, and then let $n'_{\ell + 1} = n'_{\ell} + p$. having constructed the $n'_{\ell}$, just take $n' = \bigcup_{\ell} n'_{\ell}$ and $i' = \bigcup_{\ell} i'_{\ell}$. \end{proof} \begin{theorem} \label{theorem-ffdescent-projectivity} let $r \to s$ be a faithfully flat ring map. let $m$ be an $r$-module. if the $s$-module $m \otimes_r s$ is projective, then $m$ is projective. \end{theorem} \begin{proof} we are going to construct a kaplansky d\'evissage of $m$ to show that it is a direct sum of projective modules and hence projective. by theorem \ref{theorem-projective-direct-sum} we can write $m \otimes_r s = \bigoplus_{i \in i} q_i$ as a direct sum of countably generated $s$-modules $q_i$. choose a well-ordering on $m$. using transfinite recursion we are going to define an increasing family of submodules $m_{\alpha}$ of $m$, one for each ordinal $\alpha$, such that $m_{\alpha} \otimes_r s$ is a direct sum of some subset of the $q_i$. \medskip\noindent for $\alpha = 0$ let $m_0 = 0$. if $\alpha$ is a limit ordinal and $m_{\beta}$ has been defined for all $\beta < \alpha$, then define $m_\alpha = \bigcup_{\beta < \alpha} m_{\beta}$. since each $m_{\beta} \otimes_r s$ for $\beta < \alpha$ is a direct sum of a subset of the $q_i$, the same will be true of $m_{\alpha} \otimes_r s$. if $\alpha + 1$ is a successor ordinal and $m_{\alpha}$ has been defined, then define $m_{\alpha + 1}$ as follows. if $m_{\alpha} = m$, then let $m_{\alpha +1} = m$. otherwise choose the smallest $x \in m$ (with respect to the fixed well-ordering) such that $x \notin m_{\alpha}$. since $s$ is flat over $r$, $(m/m_{\alpha}) \otimes_r s = m \otimes_r s/m_{\alpha} \otimes_r s$, so since $m_{\alpha} \otimes_r s$ is a direct sum of some $q_i$, the same is true of $(m/m_{\alpha}) \otimes_r s$. by lemma \ref{lemma-adapted-submodule}, we can find a countably generated $r$-submodule $p$ of $m/m_{\alpha}$ containing the image of $x$ in $m/m_{\alpha}$ and such that $p \otimes_r s$ (which equals $\im(p \otimes_r s \to m \otimes_r s)$ since $s$ is flat over $r$) is a direct sum of some $q_i$. since $m \otimes_r s = \bigoplus_{i \in i} q_i$ is projective and projectivity passes to direct summands, $p \otimes_r s$ is also projective. thus by lemma \ref{lemma-ffdescent-countable-projectivity}, $p$ is projective. finally we define $m_{\alpha + 1}$ to be the preimage of $p$ in $m$, so that $m_{\alpha + 1}/m_{\alpha} = p$ is countably generated and projective. in particular $m_{\alpha}$ is a direct summand of $m_{\alpha + 1}$ since projectivity of $m_{\alpha + 1}/m_{\alpha}$ implies the sequence $0 \to m_{\alpha} \to m_{\alpha + 1} \to m_{\alpha + 1}/m_{\alpha} \to 0$ splits. \medskip\noindent transfinite induction on $m$ (using the fact that we constructed $m_{\alpha + 1}$ to contain the smallest $x \in m$ not contained in $m_{\alpha}$) shows that each $x \in m$ is contained in some $m_{\alpha}$. thus, there is some large enough ordinal $s$ satisfying: for each $x \in m$ there is $\alpha \in s$ such that $x \in m_{\alpha}$. this means $(m_{\alpha})_{\alpha \in s}$ satisfies property (1) of a kaplansky d\'evissage of $m$. the other properties are clear by construction. we conclude $m = \bigoplus_{\alpha + 1 \in s} m_{\alpha + 1}/m_{\alpha}$. since each $m_{\alpha + 1}/m_{\alpha}$ is projective by construction, $m$ is projective. \end{proof} \section{completion} \label{section-completion} \noindent suppose that $r$ is a ring and $i$ is an ideal. we define the {\it completion of $r$ with respect to $i$} to be the limit $$ r^\wedge = \lim_n r/i^n. $$ an element of $r^\wedge$ is given by a sequence of elements $f_n \in r/i^n$ such that $f_n \equiv f_{n + 1} \bmod i^n$ for all $n$. we will view $r^\wedge$ as an $r$-algebra. similarly, if $m$ is an $r$-module then we define the {\it completion of $m$ with respect to $i$} to be the limit $$ m^\wedge = \lim_n m/i^nm. $$ an element of $m^\wedge$ is given by a sequence of elements $m_n \in m/i^nm$ such that $m_n \equiv m_{n + 1} \bmod i^nm$ for all $n$. we will view $m^\wedge$ as an $r^\wedge$-module. from this description it is clear that there are always canonical maps $$ m \longrightarrow m^\wedge \quad\text{and}\quad m \otimes_r r^\wedge \longrightarrow m^\wedge. $$ moreover, given a map $\varphi : m \to n$ of modules we get an induced map $\varphi^\wedge : m^\wedge \to n^\wedge$ on completions making the diagram $$ \xymatrix{ m \ar[r] \ar[d] & n \ar[d] \\ m^\wedge \ar[r] & n^\wedge } $$ commute. in general completion is not an exact functor, see examples, section \ref{examples-section-completion-not-exact}. here are some initial positive results. \begin{lemma} \label{lemma-completion-generalities} let $r$ be a ring. let $i \subset r$ be an ideal. let $\varphi : m \to n$ be a map of $r$-modules. \begin{enumerate} \item if $m/im \to n/in$ is surjective, then $m^\wedge \to n^\wedge$ is surjective. \item if $m \to n$ is surjective, then $m^\wedge \to n^\wedge$ is surjective. \item if $0 \to k \to m \to n \to 0$ is a short exact sequence of $r$-modules and $n$ is flat, then $0 \to k^\wedge \to m^\wedge \to n^\wedge \to 0$ is a short exact sequence. \item the map $m \otimes_r r^\wedge \to m^\wedge$ is surjective for any finite $r$-module $m$. \end{enumerate} \end{lemma} \begin{proof} assume $m/im \to n/in$ is surjective. then the map $m/i^nm \to n/i^nn$ is surjective for each $n \geq 1$ by nakayama's lemma. more precisely, apply lemma \ref{lemma-nak} part (11) to the map $m/i^nm \to n/i^nn$ over the ring $r/i^n$ and the nilpotent ideal $i/i^n$ to see this. set $k_n = \{x \in m \mid \varphi(x) \in i^nn\}$. thus we get short exact sequences $$ 0 \to k_n/i^nm \to m/i^nm \to n/i^nn \to 0 $$ we claim that the canonical map $k_{n + 1}/i^{n + 1}m \to k_n/i^nm$ is surjective. namely, if $x \in k_n$ write $\varphi(x) = \sum z_j n_j$ with $z_j \in i^n$, $n_j \in n$. by assumption we can write $n_j = \varphi(m_j) + \sum z_{jk}n_{jk}$ with $m_j \in m$, $z_{jk} \in i$ and $n_{jk} \in n$. hence $$ \varphi(x - \sum z_j m_j) = \sum z_jz_{jk} n_{jk}. $$ this means that $x' = x - \sum z_j m_j \in k_{n + 1}$ maps to $x \bmod i^nm$ which proves the claim. now we may apply lemma \ref{lemma-mittag-leffler} to the inverse system of short exact sequences above to see (1). part (2) is a special case of (1). if the assumptions of (3) hold, then for each $n$ the sequence $$ 0 \to k/i^nk \to m/i^nm \to n/i^nn \to 0 $$ is short exact by lemma \ref{lemma-flat-tor-zero}. hence we can directly apply lemma \ref{lemma-mittag-leffler} to conclude (3) is true. to see (4) choose generators $x_i \in m$, $i = 1, \ldots, n$. then the map $r^{\oplus n} \to m$, $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ is surjective. hence by (2) we see $(r^\wedge)^{\oplus n} \to m^\wedge$, $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ is surjective. assertion (4) follows from this. \end{proof} \begin{definition} \label{definition-complete} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be an $r$-module. we say $m$ is {\it $i$-adically complete} if the map $$ m \longrightarrow m^\wedge = \lim_n m/i^nm $$ is an isomorphism\footnote{this includes the condition that $\bigcap i^nm = 0$.}. we say $r$ is {\it $i$-adically complete} if $r$ is $i$-adically complete as an $r$-module. \end{definition} \noindent it is not true that the completion of an $r$-module $m$ with respect to $i$ is $i$-adically complete. for an example see examples, section \ref{examples-section-noncomplete-completion}. if the ideal is finitely generated, then the completion is complete. \begin{lemma} \label{lemma-hathat-finitely-generated} \begin{reference} \cite[theorem 15]{matlis}. the slick proof given here is from an email of bjorn poonen dated nov 5, 2016. \end{reference} let $r$ be a ring. let $i$ be a finitely generated ideal of $r$. let $m$ be an $r$-module. then \begin{enumerate} \item the completion $m^\wedge$ is $i$-adically complete, and \item $i^nm^\wedge = \ker(m^\wedge \to m/i^nm) = (i^nm)^\wedge$ for all $n \geq 1$. \end{enumerate} in particular $r^\wedge$ is $i$-adically complete, $i^nr^\wedge = (i^n)^\wedge$, and $r^\wedge/i^nr^\wedge = r/i^n$. \end{lemma} \begin{proof} since $i$ is finitely generated, $i^n$ is finitely generated, say by $f_1, \ldots, f_r$. applying lemma \ref{lemma-completion-generalities} part (2) to the surjection $(f_1, \ldots, f_r) : m^{\oplus r} \to i^n m$ yields a surjection $$ (m^\wedge)^{\oplus r} \xrightarrow{(f_1, \ldots, f_r)} (i^n m)^\wedge = \lim_{m \geq n} i^n m/i^m m = \ker(m^\wedge \to m/i^n m). $$ on the other hand, the image of $(f_1, \ldots, f_r) : (m^\wedge)^{\oplus r} \to m^\wedge$ is $i^n m^\wedge$. thus $m^\wedge / i^n m^\wedge \simeq m/i^n m$. taking inverse limits yields $(m^\wedge)^\wedge \simeq m^\wedge$; that is, $m^\wedge$ is $i$-adically complete. \end{proof} \begin{lemma} \label{lemma-completion-differ-by-torsion} let $r$ be a ring. let $i \subset r$ be an ideal. let $0 \to m \to n \to q \to 0$ be an exact sequence of $r$-modules such that $q$ is annihilated by a power of $i$. then completion produces an exact sequence $0 \to m^\wedge \to n^\wedge \to q \to 0$. \end{lemma} \begin{proof} say $i^c q = 0$. then $q/i^nq = q$ for $n \geq c$. on the other hand, it is clear that $i^nm \subset m \cap i^nn \subset i^{n - c}m$ for $n \geq c$. thus $m^\wedge = \lim m/(m \cap i^n n)$. apply lemma \ref{lemma-mittag-leffler} to the system of exact sequences $$ 0 \to m/(m \cap i^n n) \to n/i^n n \to q \to 0 $$ for $n \geq c$ to conclude. \end{proof} \begin{lemma} \label{lemma-hathat} \begin{reference} taken from an unpublished note of lenstra and de smit. \end{reference} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be an $r$-module. denote $k_n = \ker(m^\wedge \to m/i^nm)$. then $m^\wedge$ is $i$-adically complete if and only if $k_n$ is equal to $i^nm^\wedge$ for all $n \geq 1$. \end{lemma} \begin{proof} the module $i^n m^\wedge$ is contained in $k_n$. thus for each $n \geq 1$ there is a canonical exact sequence $$ 0 \to k_n/i^nm^\wedge \to m^\wedge/i^nm^\wedge \to m/i^nm \to 0. $$ as $i^nm^\wedge$ maps onto $i^nm/i^{n + 1}m$ we see that $k_{n + 1} + i^n m^\wedge = k_n$. thus the inverse system $\{k_n/i^n m^\wedge\}_{n \geq 1}$ has surjective transition maps. by lemma \ref{lemma-mittag-leffler} we see that there is a short exact sequence $$ 0 \to \lim_n k_n/i^n m^\wedge \to (m^\wedge)^\wedge \to m^\wedge \to 0 $$ hence $m^\wedge$ is complete if and only if $k_n/i^n m^\wedge = 0$ for all $n \geq 1$. \end{proof} \begin{lemma} \label{lemma-radical-completion} let $r$ be a ring, let $i \subset r$ be an ideal, and let $r^\wedge = \lim r/i^n$. \begin{enumerate} \item any element of $r^\wedge$ which maps to a unit of $r/i$ is a unit, \item any element of $1 + i$ maps to an invertible element of $r^\wedge$, \item any element of $1 + ir^\wedge$ is invertible in $r^\wedge$, and \item the ideals $ir^\wedge$ and $\ker(r^\wedge \to r/i)$ are contained in the jacobson radical of $r^\wedge$. \end{enumerate} \end{lemma} \begin{proof} let $x \in r^\wedge$ map to a unit $x_1$ in $r/i$. then $x$ maps to a unit $x_n$ in $r/i^n$ for every $n$ by lemma \ref{lemma-locally-nilpotent-unit}. hence $y = (x_n^{-1}) \in \lim r/i^n = r^\wedge$ is an inverse to $x$. parts (2) and (3) follow immediately from (1). part (4) follows from (1) and lemma \ref{lemma-contained-in-radical}. \end{proof} \begin{lemma} \label{lemma-when-surjective-to-completion} let $a$ be a ring. let $i = (f_1, \ldots, f_r)$ be a finitely generated ideal. if $m \to \lim m/f_i^nm$ is surjective for each $i$, then $m \to \lim m/i^nm$ is surjective. \end{lemma} \begin{proof} note that $\lim m/i^nm = \lim m/(f_1^n, \ldots, f_r^n)m$ as $i^n \supset (f_1^n, \ldots, f_r^n) \supset i^{rn}$. an element $\xi$ of $\lim m/(f_1^n, \ldots, f_r^n)m$ can be symbolically written as $$ \xi = \sum\nolimits_{n \geq 0} \sum\nolimits_i f_i^n x_{n, i} $$ with $x_{n, i} \in m$. if $m \to \lim m/f_i^nm$ is surjective, then there is an $x_i \in m$ mapping to $\sum x_{n, i} f_i^n$ in $\lim m/f_i^nm$. then $x = \sum x_i$ maps to $\xi$ in $\lim m/i^nm$. \end{proof} \begin{lemma} \label{lemma-complete-by-sub} let $a$ be a ring. let $i \subset j \subset a$ be ideals. if $m$ is $j$-adically complete and $i$ is finitely generated, then $m$ is $i$-adically complete. \end{lemma} \begin{proof} assume $m$ is $j$-adically complete and $i$ is finitely generated. we have $\bigcap i^nm = 0$ because $\bigcap j^nm = 0$. by lemma \ref{lemma-when-surjective-to-completion} it suffices to prove the surjectivity of $m \to \lim m/i^nm$ in case $i$ is generated by a single element. say $i = (f)$. let $x_n \in m$ with $x_{n + 1} - x_n \in f^nm$. we have to show there exists an $x \in m$ such that $x_n - x \in f^nm$ for all $n$. as $x_{n + 1} - x_n \in j^nm$ and as $m$ is $j$-adically complete, there exists an element $x \in m$ such that $x_n - x \in j^nm$. replacing $x_n$ by $x_n - x$ we may assume that $x_n \in j^nm$. to finish the proof we will show that this implies $x_n \in i^nm$. namely, write $x_n - x_{n + 1} = f^nz_n$. then $$ x_n = f^n(z_n + fz_{n + 1} + f^2z_{n + 2} + \ldots) $$ the sum $z_n + fz_{n + 1} + f^2z_{n + 2} + \ldots$ converges in $m$ as $f^c \in j^c$. the sum $f^n(z_n + fz_{n + 1} + f^2z_{n + 2} + \ldots)$ converges in $m$ to $x_n$ because the partial sums equal $x_n - x_{n + c}$ and $x_{n + c} \in j^{n + c}m$. \end{proof} \begin{lemma} \label{lemma-change-ideal-completion} let $r$ be a ring. let $i$, $j$ be ideals of $r$. assume there exist integers $c, d > 0$ such that $i^c \subset j$ and $j^d \subset i$. then completion with respect to $i$ agrees with completion with respect to $j$ for any $r$-module. in particular an $r$-module $m$ is $i$-adically complete if and only if it is $j$-adically complete. \end{lemma} \begin{proof} consider the system of maps $m/i^nm \to m/j^{\lfloor n/c \rfloor}m$ and the system of maps $m/j^mm \to m/i^{\lfloor m/d \rfloor}m$ to get mutually inverse maps between the completions. \end{proof} \begin{lemma} \label{lemma-quotient-complete} let $r$ be a ring. let $i$ be an ideal of $r$. let $m$ be an $i$-adically complete $r$-module, and let $k \subset m$ be an $r$-submodule. the following are equivalent \begin{enumerate} \item $k = \bigcap (k + i^nm)$ and \item $m/k$ is $i$-adically complete. \end{enumerate} \end{lemma} \begin{proof} set $n = m/k$. by lemma \ref{lemma-completion-generalities} the map $m = m^\wedge \to n^\wedge$ is surjective. hence $n \to n^\wedge$ is surjective. it is easy to see that the kernel of $n \to n^\wedge$ is the module $\bigcap (k + i^nm) / k$. \end{proof} \begin{lemma} \label{lemma-when-finite-module-complete-over-complete-ring} let $r$ be a ring. let $i$ be an ideal of $r$. let $m$ be an $r$-module. if (a) $r$ is $i$-adically complete, (b) $m$ is a finite $r$-module, and (c) $\bigcap i^nm = (0)$, then $m$ is $i$-adically complete. \end{lemma} \begin{proof} by lemma \ref{lemma-completion-generalities} the map $m = m \otimes_r r = m \otimes_r r^\wedge \to m^\wedge$ is surjective. the kernel of this map is $\bigcap i^nm$ hence zero by assumption. hence $m \cong m^\wedge$ and $m$ is complete. \end{proof} \begin{lemma} \label{lemma-finite-over-complete-ring} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be an $r$-module. assume \begin{enumerate} \item $r$ is $i$-adically complete, \item $\bigcap_{n \geq 1} i^nm = (0)$, and \item $m/im$ is a finite $r/i$-module. \end{enumerate} then $m$ is a finite $r$-module. \end{lemma} \begin{proof} let $x_1, \ldots, x_n \in m$ be elements whose images in $m/im$ generate $m/im$ as a $r/i$-module. denote $m' \subset m$ the $r$-submodule generated by $x_1, \ldots, x_n$. by lemma \ref{lemma-completion-generalities} the map $(m')^\wedge \to m^\wedge$ is surjective. since $\bigcap i^nm = 0$ we see in particular that $\bigcap i^nm' = (0)$. hence by lemma \ref{lemma-when-finite-module-complete-over-complete-ring} we see that $m'$ is complete, and we conclude that $m' \to m^\wedge$ is surjective. finally, the kernel of $m \to m^\wedge$ is zero since it is equal to $\bigcap i^nm = (0)$. hence we conclude that $m \cong m' \cong m^\wedge$ is finitely generated. \end{proof} \section{completion for noetherian rings} \label{section-completion-noetherian} \noindent in this section we discuss completion with respect to ideals in noetherian rings. \begin{lemma} \label{lemma-completion-tensor} let $i$ be an ideal of a noetherian ring $r$. denote ${}^\wedge$ completion with respect to $i$. \begin{enumerate} \item if $k \to n$ is an injective map of finite $r$-modules, then the map on completions $k^\wedge \to n^\wedge$ is injective. \item if $0 \to k \to n \to m \to 0$ is a short exact sequence of finite $r$-modules, then $0 \to k^\wedge \to n^\wedge \to m^\wedge \to 0$ is a short exact sequence. \item if $m$ is a finite $r$-module, then $m^\wedge = m \otimes_r r^\wedge$. \end{enumerate} \end{lemma} \begin{proof} setting $m = n/k$ we find that part (1) follows from part (2). let $0 \to k \to n \to m \to 0$ be as in (2). for each $n$ we get the short exact sequence $$ 0 \to k/(i^nn \cap k) \to n/i^nn \to m/i^nm \to 0. $$ by lemma \ref{lemma-mittag-leffler} we obtain the exact sequence $$ 0 \to \lim k/(i^nn \cap k) \to n^\wedge \to m^\wedge \to 0. $$ by the artin-rees lemma \ref{lemma-artin-rees} we may choose $c$ such that $i^nk \subset i^n n \cap k \subset i^{n-c} k$ for $n \geq c$. hence $k^\wedge = \lim k/i^nk = \lim k/(i^nn \cap k)$ and we conclude that (2) is true. \medskip\noindent let $m$ be as in (3) and let $0 \to k \to r^{\oplus t} \to m \to 0$ be a presentation of $m$. we get a commutative diagram $$ \xymatrix{ & k \otimes_r r^\wedge \ar[r] \ar[d] & r^{\oplus t} \otimes_r r^\wedge \ar[r] \ar[d] & m \otimes_r r^\wedge \ar[r] \ar[d] & 0 \\ 0 \ar[r] & k^\wedge \ar[r] & (r^{\oplus t})^\wedge \ar[r] & m^\wedge \ar[r] & 0 } $$ the top row is exact, see section \ref{section-flat}. the bottom row is exact by part (2). by lemma \ref{lemma-completion-generalities} the vertical arrows are surjective. the middle vertical arrow is an isomorphism. we conclude (3) holds by the snake lemma \ref{lemma-snake}. \end{proof} \begin{lemma} \label{lemma-completion-flat} let $i$ be an ideal of a noetherian ring $r$. denote ${}^\wedge$ completion with respect to $i$. \begin{enumerate} \item the ring map $r \to r^\wedge$ is flat. \item the functor $m \mapsto m^\wedge$ is exact on the category of finitely generated $r$-modules. \end{enumerate} \end{lemma} \begin{proof} consider $j \otimes_r r^\wedge \to r \otimes_r r^\wedge = r^\wedge$ where $j$ is an arbitrary ideal of $r$. according to lemma \ref{lemma-completion-tensor} this is identified with $j^\wedge \to r^\wedge$ and $j^\wedge \to r^\wedge$ is injective. part (1) follows from lemma \ref{lemma-flat}. part (2) is a reformulation of lemma \ref{lemma-completion-tensor} part (2). \end{proof} \begin{lemma} \label{lemma-completion-faithfully-flat} let $i$ be an ideal of a noetherian ring $r$. denote $r^\wedge$ the completion of $r$ with respect to $i$. if $i$ is contained in the jacobson radical of $r$, then the ring map $r \to r^\wedge$ is faithfully flat. in particular, if $(r, \mathfrak m)$ is a noetherian local ring, then the completion $\lim_n r/\mathfrak m^n$ is faithfully flat. \end{lemma} \begin{proof} by lemma \ref{lemma-completion-flat} it is flat. the composition $r \to r^\wedge \to r/i$ where the last map is the projection map $r^\wedge \to r/i$ shows that any maximal ideal of $r$ is in the image of $\spec(r^\wedge) \to \spec(r)$. hence the map is faithfully flat by lemma \ref{lemma-ff}. \end{proof} \begin{lemma} \label{lemma-completion-complete} let $r$ be a noetherian ring. let $i$ be an ideal of $r$. let $m$ be an $r$-module. then the completion $m^\wedge$ of $m$ with respect to $i$ is $i$-adically complete, $i^n m^\wedge = (i^nm)^\wedge$, and $m^\wedge/i^nm^\wedge = m/i^nm$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-hathat-finitely-generated} because $i$ is a finitely generated ideal. \end{proof} \begin{lemma} \label{lemma-completion-noetherian} let $i$ be an ideal of a ring $r$. assume \begin{enumerate} \item $r/i$ is a noetherian ring, \item $i$ is finitely generated. \end{enumerate} then the completion $r^\wedge$ of $r$ with respect to $i$ is a noetherian ring complete with respect to $ir^\wedge$. \end{lemma} \begin{proof} by lemma \ref{lemma-hathat-finitely-generated} we see that $r^\wedge$ is $i$-adically complete. hence it is also $ir^\wedge$-adically complete. since $r^\wedge/ir^\wedge = r/i$ is noetherian we see that after replacing $r$ by $r^\wedge$ we may in addition to assumptions (1) and (2) assume that also $r$ is $i$-adically complete. \medskip\noindent let $f_1, \ldots, f_t$ be generators of $i$. then there is a surjection of rings $r/i[t_1, \ldots, t_t] \to \bigoplus i^n/i^{n + 1}$ mapping $t_i$ to the element $\overline{f}_i \in i/i^2$. hence $\bigoplus i^n/i^{n + 1}$ is a noetherian ring. let $j \subset r$ be an ideal. consider the ideal $$ \bigoplus j \cap i^n/j \cap i^{n + 1} \subset \bigoplus i^n/i^{n + 1}. $$ let $\overline{g}_1, \ldots, \overline{g}_m$ be generators of this ideal. we may choose $\overline{g}_j$ to be a homogeneous element of degree $d_j$ and we may pick $g_j \in j \cap i^{d_j}$ mapping to $\overline{g}_j \in j \cap i^{d_j}/j \cap i^{d_j + 1}$. we claim that $g_1, \ldots, g_m$ generate $j$. \medskip\noindent let $x \in j \cap i^n$. there exist $a_j \in i^{\max(0, n - d_j)}$ such that $x - \sum a_j g_j \in j \cap i^{n + 1}$. the reason is that $j \cap i^n/j \cap i^{n + 1}$ is equal to $\sum \overline{g}_j i^{n - d_j}/i^{n - d_j + 1}$ by our choice of $g_1, \ldots, g_m$. hence starting with $x \in j$ we can find a sequence of vectors $(a_{1, n}, \ldots, a_{m, n})_{n \geq 0}$ with $a_{j, n} \in i^{\max(0, n - d_j)}$ such that $$ x = \sum\nolimits_{n = 0, \ldots, n} \sum\nolimits_{j = 1, \ldots, m} a_{j, n} g_j \bmod i^{n + 1} $$ setting $a_j = \sum_{n \geq 0} a_{j, n}$ we see that $x = \sum a_j g_j$ as $r$ is complete. hence $j$ is finitely generated and we win. \end{proof} \begin{lemma} \label{lemma-completion-noetherian-noetherian} let $r$ be a noetherian ring. let $i$ be an ideal of $r$. the completion $r^\wedge$ of $r$ with respect to $i$ is noetherian. \end{lemma} \begin{proof} this is a consequence of lemma \ref{lemma-completion-noetherian}. it can also be seen directly as follows. choose generators $f_1, \ldots, f_n$ of $i$. consider the map $$ r[[x_1, \ldots, x_n]] \longrightarrow r^\wedge, \quad x_i \longmapsto f_i. $$ this is a well defined and surjective ring map (details omitted). since $r[[x_1, \ldots, x_n]]$ is noetherian (see lemma \ref{lemma-noetherian-power-series}) we win. \end{proof} \noindent suppose $r \to s$ is a local homomorphism of local rings $(r, \mathfrak m)$ and $(s, \mathfrak n)$. let $s^\wedge$ be the completion of $s$ with respect to $\mathfrak n$. in general $s^\wedge$ is not the $\mathfrak m$-adic completion of $s$. if $\mathfrak n^t \subset \mathfrak ms$ for some $t \geq 1$ then we do have $s^\wedge = \lim s/\mathfrak m^ns$ by lemma \ref{lemma-change-ideal-completion}. in some cases this even implies that $s^\wedge$ is finite over $r^\wedge$. \begin{lemma} \label{lemma-finite-after-completion} let $r \to s$ be a local homomorphism of local rings $(r, \mathfrak m)$ and $(s, \mathfrak n)$. let $r^\wedge$, resp.\ $s^\wedge$ be the completion of $r$, resp.\ $s$ with respect to $\mathfrak m$, resp.\ $\mathfrak n$. if $\mathfrak m$ and $\mathfrak n$ are finitely generated and $\dim_{\kappa(\mathfrak m)} s/\mathfrak ms < \infty$, then \begin{enumerate} \item $s^\wedge$ is equal to the $\mathfrak m$-adic completion of $s$, and \item $s^\wedge$ is a finite $r^\wedge$-module. \end{enumerate} \end{lemma} \begin{proof} we have $\mathfrak ms \subset \mathfrak n$ because $r \to s$ is a local ring map. the assumption $\dim_{\kappa(\mathfrak m)} s/\mathfrak ms < \infty$ implies that $s/\mathfrak ms$ is an artinian ring, see lemma \ref{lemma-finite-dimensional-algebra}. hence has dimension $0$, see lemma \ref{lemma-noetherian-dimension-0}, hence $\mathfrak n = \sqrt{\mathfrak ms}$. this and the fact that $\mathfrak n$ is finitely generated implies that $\mathfrak n^t \subset \mathfrak ms$ for some $t \geq 1$. by lemma \ref{lemma-change-ideal-completion} we see that $s^\wedge$ can be identified with the $\mathfrak m$-adic completion of $s$. as $\mathfrak m$ is finitely generated we see from lemma \ref{lemma-hathat-finitely-generated} that $s^\wedge$ and $r^\wedge$ are $\mathfrak m$-adically complete. at this point we may apply lemma \ref{lemma-finite-over-complete-ring} to $s^\wedge$ as an $r^\wedge$-module to conclude. \end{proof} \begin{lemma} \label{lemma-completion-finite-extension} let $r$ be a noetherian ring. let $r \to s$ be a finite ring map. let $\mathfrak p \subset r$ be a prime and let $\mathfrak q_1, \ldots, \mathfrak q_m$ be the primes of $s$ lying over $\mathfrak p$ (lemma \ref{lemma-finite-finite-fibres}). then $$ r_\mathfrak p^\wedge \otimes_r s = (s_\mathfrak p)^\wedge = s_{\mathfrak q_1}^\wedge \times \ldots \times s_{\mathfrak q_m}^\wedge $$ where the $(s_\mathfrak p)^\wedge$ is the completion with respect to $\mathfrak p$ and the local rings $r_\mathfrak p$ and $s_{\mathfrak q_i}$ are completed with respect to their maximal ideals. \end{lemma} \begin{proof} we may replace $r$ by the localization $r_\mathfrak p$ and $s$ by $s_\mathfrak p = s \otimes_r r_\mathfrak p$. hence we may assume that $r$ is a local noetherian ring and that $\mathfrak p = \mathfrak m$ is its maximal ideal. the $\mathfrak q_is_{\mathfrak q_i}$-adic completion $s_{\mathfrak q_i}^\wedge$ is equal to the $\mathfrak m$-adic completion by lemma \ref{lemma-finite-after-completion}. for every $n \geq 1$ prime ideals of $s/\mathfrak m^ns$ are in 1-to-1 correspondence with the maximal ideals $\mathfrak q_1, \ldots, \mathfrak q_m$ of $s$ (by going up for $s$ over $r$, see lemma \ref{lemma-integral-going-up}). hence $s/\mathfrak m^ns = \prod s_{\mathfrak q_i}/\mathfrak m^ns_{\mathfrak q_i}$ by lemma \ref{lemma-artinian-finite-length} (using for example proposition \ref{proposition-dimension-zero-ring} to see that $s/\mathfrak m^ns$ is artinian). hence the $\mathfrak m$-adic completion $s^\wedge$ of $s$ is equal to $\prod s_{\mathfrak q_i}^\wedge$. finally, we have $r^\wedge \otimes_r s = s^\wedge$ by lemma \ref{lemma-completion-tensor}. \end{proof} \begin{lemma} \label{lemma-split-completed-sequence} let $r$ be a ring. let $i \subset r$ be an ideal. let $0 \to k \to p \to m \to 0$ be a short exact sequence of $r$-modules. if $m$ is flat over $r$ and $m/im$ is a projective $r/i$-module, then the sequence of $i$-adic completions $$ 0 \to k^\wedge \to p^\wedge \to m^\wedge \to 0 $$ is a split exact sequence. \end{lemma} \begin{proof} as $m$ is flat, each of the sequences $$ 0 \to k/i^nk \to p/i^np \to m/i^nm \to 0 $$ is short exact, see lemma \ref{lemma-flat-tor-zero} and the sequence $0 \to k^\wedge \to p^\wedge \to m^\wedge \to 0$ is a short exact sequence, see lemma \ref{lemma-completion-generalities}. it suffices to show that we can find splittings $s_n : m/i^nm \to p/i^np$ such that $s_{n + 1} \bmod i^n = s_n$. we will construct these $s_n$ by induction on $n$. pick any splitting $s_1$, which exists as $m/im$ is a projective $r/i$-module. assume given $s_n$ for some $n > 0$. set $p_{n + 1} = \{x \in p \mid x \bmod i^np \in \im(s_n)\}$. the map $\pi : p_{n + 1}/i^{n + 1}p_{n + 1} \to m/i^{n + 1}m$ is surjective (details omitted). as $m/i^{n + 1}m$ is projective as a $r/i^{n + 1}$-module by lemma \ref{lemma-lift-projective} we may choose a section $t : m/i^{n + 1}m \to p_{n + 1}/i^{n + 1}p_{n + 1}$ of $\pi$. setting $s_{n + 1}$ equal to the composition of $t$ with the canonical map $p_{n + 1}/i^{n + 1}p_{n + 1} \to p/i^{n + 1}p$ works. \end{proof} \begin{lemma} \label{lemma-complete-modulo-nilpotent} let $a$ be a noetherian ring. let $i, j \subset a$ be ideals. if $a$ is $i$-adically complete and $a/i$ is $j$-adically complete, then $a$ is $j$-adically complete. \end{lemma} \begin{proof} let $b$ be the $(i + j)$-adic completion of $a$. by lemma \ref{lemma-completion-flat} $b/ib$ is the $j$-adic completion of $a/i$ hence isomorphic to $a/i$ by assumption. moreover $b$ is $i$-adically complete by lemma \ref{lemma-complete-by-sub}. hence $b$ is a finite $a$-module by lemma \ref{lemma-finite-over-complete-ring}. by nakayama's lemma (lemma \ref{lemma-nak} using $i$ is in the jacobson radical of $a$ by lemma \ref{lemma-radical-completion}) we find that $a \to b$ is surjective. the map $a \to b$ is flat by lemma \ref{lemma-completion-flat}. the image of $\spec(b) \to \spec(a)$ contains $v(i)$ and as $i$ is contained in the jacobson radical of $a$ we find $a \to b$ is faithfully flat (lemma \ref{lemma-ff-rings}). thus $a \to b$ is injective. thus $a$ is complete with respect to $i + j$, hence a fortiori complete with respect to $j$. \end{proof} \section{taking limits of modules} \label{section-limits} \noindent in this section we discuss what happens when we take a limit of modules. \begin{lemma} \label{lemma-limit-complete-pre} let $i \subset a$ be a finitely generated ideal of a ring. let $(m_n)$ be an inverse system of $a$-modules with $i^n m_n = 0$. then $m = \lim m_n$ is $i$-adically complete. \end{lemma} \begin{proof} we have $m \to m/i^nm \to m_n$. taking the limit we get $m \to m^\wedge \to m$. hence $m$ is a direct summand of $m^\wedge$. since $m^\wedge$ is $i$-adically complete by lemma \ref{lemma-hathat-finitely-generated}, so is $m$. \end{proof} \begin{lemma} \label{lemma-limit-complete} let $i \subset a$ be a finitely generated ideal of a ring. let $(m_n)$ be an inverse system of $a$-modules with $m_n = m_{n + 1}/i^nm_{n + 1}$. set $m = \lim m_n$. then $m/i^nm = m_n$ and $m$ is $i$-adically complete. \end{lemma} \begin{proof} by lemma \ref{lemma-limit-complete-pre} we see that $m$ is $i$-adically complete. since the transition maps are surjective, the maps $m \to m_n$ are surjective. consider the inverse system of short exact sequences $$ 0 \to n_n \to m \to m_n \to 0 $$ defining $n_n$. since $m_n = m_{n + 1}/i^nm_{n + 1}$ the map $n_{n + 1} + i^nm \to n_n$ is surjective. hence $n_{n + 1}/(n_{n + 1} \cap i^{n + 1}m) \to n_n/(n_n \cap i^nm)$ is surjective. taking the inverse limit of the short exact sequences $$ 0 \to n_n/(n_n \cap i^nm) \to m/i^nm \to m_n \to 0 $$ we obtain an exact sequence $$ 0 \to \lim n_n/(n_n \cap i^nm) \to m^\wedge \to m $$ since $m$ is $i$-adically complete we conclude that $\lim n_n/(n_n \cap i^nm) = 0$ and hence by the surjectivity of the transition maps we get $n_n/(n_n \cap i^nm) = 0$ for all $n$. thus $m_n = m/i^nm$ as desired. \end{proof} \begin{lemma} \label{lemma-finiteness-graded} let $a$ be a noetherian graded ring. let $i \subset a_+$ be a homogeneous ideal. let $(n_n)$ be an inverse system of finite graded $a$-modules with $n_n = n_{n + 1}/i^n n_{n + 1}$. then there is a finite graded $a$-module $n$ such that $n_n = n/i^nn$ as graded modules for all $n$. \end{lemma} \begin{proof} pick $r$ and homogeneous elements $x_{1, 1}, \ldots, x_{1, r} \in n_1$ of degrees $d_1, \ldots, d_r$ generating $n_1$. since the transition maps are surjective, we can pick a compatible system of homogeneous elements $x_{n, i} \in n_n$ lifting $x_{1, i}$. by the graded nakayama lemma (lemma \ref{lemma-graded-nak}) we see that $n_n$ is generated by the elements $x_{n, 1}, \ldots, x_{n, r}$ sitting in degrees $d_1, \ldots, d_r$. thus for $m \leq n$ we see that $n_n \to n_n/i^m n_n$ is an isomorphism in degrees $< \min(d_i) + m$ (as $i^mn_n$ is zero in those degrees). thus the inverse system of degree $d$ parts $$ \ldots = n_{2 + d - \min(d_i), d} = n_{1 + d - \min(d_i), d} = n_{d - \min(d_i), d} \to n_{-1 + d - \min(d_i), d} \to \ldots $$ stabilizes as indicated. let $n$ be the graded $a$-module whose $d$th graded part is this stabilization. in particular, we have the elements $x_i = \lim x_{n, i}$ in $n$. we claim the $x_i$ generate $n$: any $x \in n_d$ is a linear combination of $x_1, \ldots, x_r$ because we can check this in $n_{d - \min(d_i), d}$ where it holds as $x_{d - \min(d_i), i}$ generate $n_{d - \min(d_i)}$. finally, the reader checks that the surjective map $n/i^nn \to n_n$ is an isomorphism by checking to see what happens in each degree as before. details omitted. \end{proof} \begin{lemma} \label{lemma-daniel-litt} let $a$ be a graded ring. let $i \subset a_+$ be a homogeneous ideal. denote $a' = \lim a/i^n$. let $(g_n)$ be an inverse system of graded $a$-modules with $g_n$ annihilated by $i^n$. let $m$ be a graded $a$-module and let $\varphi_n : m \to g_n$ be a compatible system of graded $a$-module maps. if the induced map $$ \varphi : m \otimes_a a' \longrightarrow \lim g_n $$ is an isomorphism, then $m_d \to \lim g_{n, d}$ is an isomorphism for all $d \in \mathbf{z}$. \end{lemma} \begin{proof} by convention graded rings are in degrees $\geq 0$ and graded modules may have nonzero parts of any degree, see section \ref{section-graded}. the map $\varphi$ exists because $\lim g_n$ is a module over $a'$ as $g_n$ is annihilated by $i^n$. another useful thing to keep in mind is that we have $$ \bigoplus\nolimits_{d \in \mathbf{z}} \lim g_{n, d} \subset \lim g_n \subset \prod\nolimits_{d \in \mathbf{z}} \lim g_{n, d} $$ where a subscript ${\ }_d$ indicates the $d$th graded part. \medskip\noindent injective. let $x \in m_d$. if $x \mapsto 0$ in $\lim g_{n, d}$ then $x \otimes 1 = 0$ in $m \otimes_a a'$. then we can find a finitely generated submodule $m' \subset m$ with $x \in m'$ such that $x \otimes 1$ is zero in $m' \otimes_a a'$. say $m'$ is generated by homogeneous elements sitting in degrees $d_1, \ldots, d_r$. let $n = d - \min(d_i) + 1$. since $a'$ has a map to $a/i^n$ and since $a \to a/i^n$ is an isomorphism in degrees $\leq n - 1$ we see that $m' \to m' \otimes_a a'$ is injective in degrees $\leq n - 1$. thus $x = 0$ as desired. \medskip\noindent surjective. let $y \in \lim g_{n, d}$. choose a finite sum $\sum x_i \otimes f'_i$ in $m \otimes_a a'$ mapping to $y$. we may assume $x_i$ is homogeneous, say of degree $d_i$. observe that although $a'$ is not a graded ring, it is a limit of the graded rings $a/i^na$ and moreover, in any given degree the transition maps eventually become isomorphisms (see above). this gives $$ a = \bigoplus\nolimits_{d \geq 0} a_d \subset a' \subset \prod\nolimits_{d \geq 0} a_d $$ thus we can write $$ f'_i = \sum\nolimits_{j = 0, \ldots, d - d_i - 1} f_{i, j} + f_i + g'_i $$ with $f_{i, j} \in a_j$, $f_i \in a_{d - d_i}$, and $g'_i \in a'$ mapping to zero in $\prod_{j \leq d - d_i} a_j$. now if we compute $\varphi_n(\sum_{i, j} f_{i, j}x_i) \in g_n$, then we get a sum of homogeneous elements of degree $< d$. hence $\varphi(\sum x_i \otimes f_{i, j})$ maps to zero in $\lim g_{n, d}$. similarly, a computation shows the element $\varphi(\sum x_i \otimes g'_i)$ maps to zero in $\prod_{d' \leq d} \lim g_{n, d'}$. since we know that $\varphi(\sum x_i \otimes f'_i)$ is $y$, we conclude that $\sum f_ix_i \in m_d$ maps to $y$ as desired. \end{proof} \section{criteria for flatness} \label{section-criteria-flatness} \noindent in this section we prove some important technical lemmas in the noetherian case. we will (partially) generalize these to the non-noetherian case in section \ref{section-more-flatness-criteria}. \begin{lemma} \label{lemma-mod-injective} suppose that $r \to s$ is a local homomorphism of local rings with $s$ noetherian. denote $\mathfrak m$ the maximal ideal of $r$. let $m$ be a flat $r$-module and $n$ a finite $s$-module. let $u : n \to m$ be a map of $r$-modules. if $\overline{u} : n/\mathfrak m n \to m/\mathfrak m m$ is injective then $u$ is injective. in this case $m/u(n)$ is flat over $r$. \end{lemma} \begin{proof} first we claim that $u_n : n/{\mathfrak m}^nn \to m/{\mathfrak m}^nm$ is injective for all $n \geq 1$. we proceed by induction, the base case is that $\overline{u} = u_1$ is injective. by our assumption that $m$ is flat over $r$ we have a short exact sequence $0 \to m \otimes_r {\mathfrak m}^n/{\mathfrak m}^{n + 1} \to m/{\mathfrak m}^{n + 1}m \to m/{\mathfrak m}^n m \to 0$. also, $m \otimes_r {\mathfrak m}^n/{\mathfrak m}^{n + 1} = m/{\mathfrak m}m \otimes_{r/{\mathfrak m}} {\mathfrak m}^n/{\mathfrak m}^{n + 1}$. we have a similar exact sequence $n \otimes_r {\mathfrak m}^n/{\mathfrak m}^{n + 1} \to n/{\mathfrak m}^{n + 1}n \to n/{\mathfrak m}^n n \to 0$ for $n$ except we do not have the zero on the left. we also have $n \otimes_r {\mathfrak m}^n/{\mathfrak m}^{n + 1} = n/{\mathfrak m}n \otimes_{r/{\mathfrak m}} {\mathfrak m}^n/{\mathfrak m}^{n + 1}$. thus the map $u_{n + 1}$ is injective as both $u_n$ and the map $\overline{u} \otimes \text{id}_{{\mathfrak m}^n/{\mathfrak m}^{n + 1}}$ are. \medskip\noindent by krull's intersection theorem (lemma \ref{lemma-intersect-powers-ideal-module-zero}) applied to $n$ over the ring $s$ and the ideal $\mathfrak ms$ we have $\bigcap \mathfrak m^nn = 0$. thus the injectivity of $u_n$ for all $n$ implies $u$ is injective. \medskip\noindent to show that $m/u(n)$ is flat over $r$, it suffices to show that $\text{tor}_1^r(m/u(n), r/i) = 0$ for every ideal $i \subset r$, see lemma \ref{lemma-characterize-flat}. from the short exact sequence $$ 0 \to n \xrightarrow{u} m \to m/u(n) \to 0 $$ and the flatness of $m$ we obtain an exact sequence of tors $$ 0 \to \text{tor}_1^r(m/u(n), r/i) \to n/in \to m/im $$ see lemma \ref{lemma-long-exact-sequence-tor}. thus it suffices to show that $n/in$ injects into $m/im$. note that $r/i \to s/is$ is a local homomorphism of local rings with $s/is$ noetherian, $n/in \to m/im$ is a map of $r/i$-modules, $n/in$ is finite over $s/is$, and $m/im$ is flat over $r/i$ and $u \bmod i : n/in \to m/im$ is injective modulo $\mathfrak m$. thus we may apply the first part of the proof to $u \bmod i$ and we conclude. \end{proof} \begin{lemma} \label{lemma-grothendieck} suppose that $r \to s$ is a flat and local ring homomorphism of noetherian local rings. denote $\mathfrak m$ the maximal ideal of $r$. suppose $f \in s$ is a nonzerodivisor in $s/{\mathfrak m}s$. then $s/fs$ is flat over $r$, and $f$ is a nonzerodivisor in $s$. \end{lemma} \begin{proof} follows directly from lemma \ref{lemma-mod-injective}. \end{proof} \begin{lemma} \label{lemma-grothendieck-regular-sequence} suppose that $r \to s$ is a flat and local ring homomorphism of noetherian local rings. denote $\mathfrak m$ the maximal ideal of $r$. suppose $f_1, \ldots, f_c$ is a sequence of elements of $s$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$ form a regular sequence in $s/{\mathfrak m}s$. then $f_1, \ldots, f_c$ is a regular sequence in $s$ and each of the quotients $s/(f_1, \ldots, f_i)$ is flat over $r$. \end{lemma} \begin{proof} induction and lemma \ref{lemma-grothendieck}. \end{proof} \begin{lemma} \label{lemma-free-fibre-flat-free} let $r \to s$ be a local homomorphism of noetherian local rings. let $\mathfrak m$ be the maximal ideal of $r$. let $m$ be a nonzero finite $s$-module. suppose that (a) $m/\mathfrak mm$ is a free $s/\mathfrak ms$-module, and (b) $m$ is flat over $r$. then $m$ is free and $s$ is flat over $r$. \end{lemma} \begin{proof} let $\overline{x}_1, \ldots, \overline{x}_n$ be a basis for the free module $m/\mathfrak mm$. choose $x_1, \ldots, x_n \in m$ with $x_i$ mapping to $\overline{x}_i$. let $u : s^{\oplus n} \to m$ be the map which maps the $i$th standard basis vector to $x_i$. by lemma \ref{lemma-mod-injective} we see that $u$ is injective. on the other hand, by nakayama's lemma \ref{lemma-nak} the map is surjective. the lemma follows. \end{proof} \begin{lemma} \label{lemma-complex-exact-mod} let $r \to s$ be a local homomorphism of local noetherian rings. let $\mathfrak m$ be the maximal ideal of $r$. let $0 \to f_e \to f_{e-1} \to \ldots \to f_0$ be a finite complex of finite $s$-modules. assume that each $f_i$ is $r$-flat, and that the complex $0 \to f_e/\mathfrak m f_e \to f_{e-1}/\mathfrak m f_{e-1} \to \ldots \to f_0 / \mathfrak m f_0$ is exact. then $0 \to f_e \to f_{e-1} \to \ldots \to f_0$ is exact, and moreover the module $\coker(f_1 \to f_0)$ is $r$-flat. \end{lemma} \begin{proof} by induction on $e$. if $e = 1$, then this is exactly lemma \ref{lemma-mod-injective}. if $e > 1$, we see by lemma \ref{lemma-mod-injective} that $f_e \to f_{e-1}$ is injective and that $c = \coker(f_e \to f_{e-1})$ is a finite $s$-module flat over $r$. hence we can apply the induction hypothesis to the complex $0 \to c \to f_{e-2} \to \ldots \to f_0$. we deduce that $c \to f_{e-2}$ is injective and the exactness of the complex follows, as well as the flatness of the cokernel of $f_1 \to f_0$. \end{proof} \noindent in the rest of this section we prove two versions of what is called the ``{\it local criterion of flatness}''. note also the interesting lemma \ref{lemma-cm-over-regular-flat} below. \begin{lemma} \label{lemma-prepare-local-criterion-flatness} let $r$ be a local ring with maximal ideal $\mathfrak m$ and residue field $\kappa = r/\mathfrak m$. let $m$ be an $r$-module. if $\text{tor}_1^r(\kappa, m) = 0$, then for every finite length $r$-module $n$ we have $\text{tor}_1^r(n, m) = 0$. \end{lemma} \begin{proof} by descending induction on the length of $n$. if the length of $n$ is $1$, then $n \cong \kappa$ and we are done. if the length of $n$ is more than $1$, then we can fit $n$ into a short exact sequence $0 \to n' \to n \to n'' \to 0$ where $n'$, $n''$ are finite length $r$-modules of smaller length. the vanishing of $\text{tor}_1^r(n, m)$ follows from the vanishing of $\text{tor}_1^r(n', m)$ and $\text{tor}_1^r(n'', m)$ (induction hypothesis) and the long exact sequence of tor groups, see lemma \ref{lemma-long-exact-sequence-tor}. \end{proof} \begin{lemma}[local criterion for flatness] \label{lemma-local-criterion-flatness} let $r \to s$ be a local homomorphism of local noetherian rings. let $\mathfrak m$ be the maximal ideal of $r$, and let $\kappa = r/\mathfrak m$. let $m$ be a finite $s$-module. if $\text{tor}_1^r(\kappa, m) = 0$, then $m$ is flat over $r$. \end{lemma} \begin{proof} let $i \subset r$ be an ideal. by lemma \ref{lemma-flat} it suffices to show that $i \otimes_r m \to m$ is injective. by remark \ref{remark-tor-ring-mod-ideal} we see that this kernel is equal to $\text{tor}_1^r(m, r/i)$. by lemma \ref{lemma-prepare-local-criterion-flatness} we see that $j \otimes_r m \to m$ is injective for all ideals of finite colength. \medskip\noindent choose $n >> 0$ and consider the following short exact sequence $$ 0 \to i \cap \mathfrak m^n \to i \oplus \mathfrak m^n \to i + \mathfrak m^n \to 0 $$ this is a sub sequence of the short exact sequence $0 \to r \to r^{\oplus 2} \to r \to 0$. thus we get the diagram $$ \xymatrix{ (i\cap \mathfrak m^n) \otimes_r m \ar[r] \ar[d] & i \otimes_r m \oplus \mathfrak m^n \otimes_r m \ar[r] \ar[d] & (i + \mathfrak m^n) \otimes_r m \ar[d] \\ m \ar[r] & m \oplus m \ar[r] & m } $$ note that $i + \mathfrak m^n$ and $\mathfrak m^n$ are ideals of finite colength. thus a diagram chase shows that $\ker((i \cap \mathfrak m^n)\otimes_r m \to m) \to \ker(i \otimes_r m \to m)$ is surjective. we conclude in particular that $k = \ker(i \otimes_r m \to m)$ is contained in the image of $(i \cap \mathfrak m^n) \otimes_r m$ in $i \otimes_r m$. by artin-rees, lemma \ref{lemma-artin-rees} we see that $k$ is contained in $\mathfrak m^{n-c}(i \otimes_r m)$ for some $c > 0$ and all $n >> 0$. since $i \otimes_r m$ is a finite $s$-module (!) and since $s$ is noetherian, we see that this implies $k = 0$. namely, the above implies $k$ maps to zero in the $\mathfrak ms$-adic completion of $i \otimes_r m$. but the map from $s$ to its $\mathfrak ms$-adic completion is faithfully flat by lemma \ref{lemma-completion-faithfully-flat}. hence $k = 0$, as desired. \end{proof} \noindent in the following we often encounter the conditions ``$m/im$ is flat over $r/i$ and $\text{tor}_1^r(r/i, m) = 0$''. the following lemma gives some consequences of these conditions (it is a generalization of lemma \ref{lemma-prepare-local-criterion-flatness}). \begin{lemma} \label{lemma-what-does-it-mean} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be an $r$-module. if $m/im$ is flat over $r/i$ and $\text{tor}_1^r(r/i, m) = 0$ then \begin{enumerate} \item $m/i^nm$ is flat over $r/i^n$ for all $n \geq 1$, and \item for any module $n$ which is annihilated by $i^m$ for some $m \geq 0$ we have $\text{tor}_1^r(n, m) = 0$. \end{enumerate} in particular, if $i$ is nilpotent, then $m$ is flat over $r$. \end{lemma} \begin{proof} assume $m/im$ is flat over $r/i$ and $\text{tor}_1^r(r/i, m) = 0$. let $n$ be an $r/i$-module. choose a short exact sequence $$ 0 \to k \to \bigoplus\nolimits_{i \in i} r/i \to n \to 0 $$ by the long exact sequence of $\text{tor}$ and the vanishing of $\text{tor}_1^r(r/i, m)$ we get $$ 0 \to \text{tor}_1^r(n, m) \to k \otimes_r m \to (\bigoplus\nolimits_{i \in i} r/i) \otimes_r m \to n \otimes_r m \to 0 $$ but since $k$, $\bigoplus_{i \in i} r/i$, and $n$ are all annihilated by $i$ we see that \begin{align*} k \otimes_r m & = k \otimes_{r/i} m/im, \\ (\bigoplus\nolimits_{i \in i} r/i) \otimes_r m & = (\bigoplus\nolimits_{i \in i} r/i) \otimes_{r/i} m/im, \\ n \otimes_r m & = n \otimes_{r/i} m/im. \end{align*} as $m/im$ is flat over $r/i$ we conclude that $$ 0 \to k \otimes_{r/i} m/im \to (\bigoplus\nolimits_{i \in i} r/i) \otimes_{r/i} m/im \to n \otimes_{r/} m/im \to 0 $$ is exact. combining this with the above we conclude that $\text{tor}_1^r(n, m) = 0$ for any $r$-module $n$ annihilated by $i$. \medskip\noindent let us prove (2) by induction on $m$. the case $m = 1$ was done in the previous paragraph. for $n$ annihilated by $i^m$ for $m > 1$ we may choose an exact sequence $0 \to n' \to n \to n'' \to 0$ with $n'$ and $n''$ annihilated by $i^{m - 1}$. for example one can take $n' = in$ and $n'' = n/in$. then the exact sequence $$ \text{tor}_1^r(n', m) \to \text{tor}_1^r(n, m) \to \text{tor}_1^r(n'', m) $$ and induction prove the vanishing we want. \medskip\noindent finally, we prove (1). given $n \geq 1$ we have to show that $m/i^nm$ is flat over $r/i^n$. in other words, we have to show that the functor $n \mapsto n \otimes_{r/i^n} m/i^nm$ is exact on the category of $r$-modules $n$ annihilated by $i^n$. however, for such $n$ we have $n \otimes_{r/i^n} m/i^nm = n \otimes_r m$. by the vanishing of $\text{tor}_1$ in (2) we see that the functor $n \mapsto n \otimes_r m$ is exact on the category of $n$ annihilated by some power of $i$ and we conclude. \end{proof} \begin{lemma} \label{lemma-what-does-it-mean-again} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be an $r$-module. \begin{enumerate} \item if $m/im$ is flat over $r/i$ and $m \otimes_r i/i^2 \to im/i^2m$ is injective, then $m/i^2m$ is flat over $r/i^2$. \item if $m/im$ is flat over $r/i$ and $m \otimes_r i^n/i^{n + 1} \to i^nm/i^{n + 1}m$ is injective for $n = 1, \ldots, k$, then $m/i^{k + 1}m$ is flat over $r/i^{k + 1}$. \end{enumerate} \end{lemma} \begin{proof} the first statement is a consequence of lemma \ref{lemma-what-does-it-mean} applied with $r$ replaced by $r/i^2$ and $m$ replaced by $m/i^2m$ using that $$ \text{tor}_1^{r/i^2}(m/i^2m, r/i) = \ker(m \otimes_r i/i^2 \to im/i^2m), $$ see remark \ref{remark-tor-ring-mod-ideal}. the second statement follows in the same manner using induction on $n$ to show that $m/i^{n + 1}m$ is flat over $r/i^{n + 1}$ for $n = 1, \ldots, k$. here we use that $$ \text{tor}_1^{r/i^{n + 1}}(m/i^{n + 1}m, r/i^n) = \ker(m \otimes_r i^n/i^{n + 1} \to i^nm/i^{n + 1}m) $$ for every $n$. \end{proof} \begin{lemma}[variant of the local criterion] \label{lemma-variant-local-criterion-flatness} let $r \to s$ be a local homomorphism of noetherian local rings. let $i \not = r$ be an ideal in $r$. let $m$ be a finite $s$-module. if $\text{tor}_1^r(m, r/i) = 0$ and $m/im$ is flat over $r/i$, then $m$ is flat over $r$. \end{lemma} \begin{proof} first proof: by lemma \ref{lemma-what-does-it-mean} we see that $\text{tor}_1^r(\kappa, m)$ is zero where $\kappa$ is the residue field of $r$. hence we see that $m$ is flat over $r$ by lemma \ref{lemma-local-criterion-flatness}. \medskip\noindent second proof: let $\mathfrak m$ be the maximal ideal of $r$. we will show that $\mathfrak m \otimes_r m \to m$ is injective, and then apply lemma \ref{lemma-local-criterion-flatness}. suppose that $\sum f_i \otimes x_i \in \mathfrak m \otimes_r m$ and that $\sum f_i x_i = 0$ in $m$. by the equational criterion for flatness lemma \ref{lemma-flat-eq} applied to $m/im$ over $r/i$ we see there exist $\overline{a}_{ij} \in r/i$ and $\overline{y}_j \in m/im$ such that $x_i \bmod im = \sum_j \overline{a}_{ij} \overline{y}_j $ and $0 = \sum_i (f_i \bmod i) \overline{a}_{ij}$. let $a_{ij} \in r$ be a lift of $\overline{a}_{ij}$ and similarly let $y_j \in m$ be a lift of $\overline{y}_j$. then we see that \begin{eqnarray*} \sum f_i \otimes x_i & = & \sum f_i \otimes x_i + \sum f_ia_{ij} \otimes y_j - \sum f_i \otimes a_{ij} y_j \\ & = & \sum f_i \otimes (x_i - \sum a_{ij} y_j) + \sum (\sum f_i a_{ij}) \otimes y_j \end{eqnarray*} since $x_i - \sum a_{ij} y_j \in im$ and $\sum f_i a_{ij} \in i$ we see that there exists an element in $i \otimes_r m$ which maps to our given element $\sum f_i \otimes x_i$ in $\mathfrak m \otimes_r m$. but $i \otimes_r m \to m$ is injective by assumption (see remark \ref{remark-tor-ring-mod-ideal}) and we win. \end{proof} \noindent in particular, in the situation of lemma \ref{lemma-variant-local-criterion-flatness}, suppose that $i = (x)$ is generated by a single element $x$ which is a nonzerodivisor in $r$. then $\text{tor}_1^r(m, r/(x)) = (0)$ if and only if $x$ is a nonzerodivisor on $m$. \begin{lemma} \label{lemma-flat-module-powers} let $r \to s$ be a ring map. let $i \subset r$ be an ideal. let $m$ be an $s$-module. assume \begin{enumerate} \item $r$ is a noetherian ring, \item $s$ is a noetherian ring, \item $m$ is a finite $s$-module, and \item for each $n \geq 1$ the module $m/i^n m$ is flat over $r/i^n$. \end{enumerate} then for every $\mathfrak q \in v(is)$ the localization $m_{\mathfrak q}$ is flat over $r$. in particular, if $s$ is local and $is$ is contained in its maximal ideal, then $m$ is flat over $r$. \end{lemma} \begin{proof} we are going to use lemma \ref{lemma-variant-local-criterion-flatness}. by assumption $m/im$ is flat over $r/i$. hence it suffices to check that $\text{tor}_1^r(m, r/i)$ is zero on localization at $\mathfrak q$. by remark \ref{remark-tor-ring-mod-ideal} this tor group is equal to $k = \ker(i \otimes_r m \to m)$. we know that the kernel of $i/i^n \otimes_{r/i^n} m/i^nm \to m/i^nm$ is zero for all $n \geq 1$. hence an element of $k$ maps to zero in $i/i^n \otimes_{r/i^n} m/i^nm$. since $$ i/i^n \otimes_{r/i^n} m/i^nm = i/i^n \otimes_r m = (i \otimes_r m)/i^{n - 1}(i \otimes_r m) $$ we conclude that $k \subset i^{n - 1}(i \otimes_r m)$ for all $n \geq 1$. by the artin-rees lemma, and more precisely lemma \ref{lemma-intersection-powers-ideal-module} we conclude that $k_{\mathfrak q} = 0$, as desired. \end{proof} \begin{lemma} \label{lemma-surjective-on-tor-one} let $r \to r' \to r''$ be ring maps. let $m$ be an $r$-module. suppose that $m \otimes_r r'$ is flat over $r'$. then the natural map $\text{tor}_1^r(m, r') \otimes_{r'} r'' \to \text{tor}_1^r(m, r'')$ is onto. \end{lemma} \begin{proof} let $f_\bullet$ be a free resolution of $m$ over $r$. the complex $f_2 \otimes_r r' \to f_1\otimes_r r' \to f_0 \otimes_r r'$ computes $\text{tor}_1^r(m, r')$. the complex $f_2 \otimes_r r'' \to f_1\otimes_r r'' \to f_0 \otimes_r r''$ computes $\text{tor}_1^r(m, r'')$. note that $f_i \otimes_r r' \otimes_{r'} r'' = f_i \otimes_r r''$. let $k' = \ker(f_1\otimes_r r' \to f_0 \otimes_r r')$ and similarly $k'' = \ker(f_1\otimes_r r'' \to f_0 \otimes_r r'')$. thus we have an exact sequence $$ 0 \to k' \to f_1\otimes_r r' \to f_0 \otimes_r r' \to m \otimes_r r' \to 0. $$ by the assumption that $m \otimes_r r'$ is flat over $r'$, the sequence $$ k' \otimes_{r'} r'' \to f_1 \otimes_r r'' \to f_0 \otimes_r r'' \to m \otimes_r r'' \to 0 $$ is still exact. this means that $k' \otimes_{r'} r'' \to k''$ is surjective. since $\text{tor}_1^r(m, r')$ is a quotient of $k'$ and $\text{tor}_1^r(m, r'')$ is a quotient of $k''$ we win. \end{proof} \begin{lemma} \label{lemma-surjective-on-tor-one-trivial} let $r \to r'$ be a ring map. let $i \subset r$ be an ideal and $i' = ir'$. let $m$ be an $r$-module and set $m' = m \otimes_r r'$. the natural map $\text{tor}_1^r(r'/i', m) \to \text{tor}_1^{r'}(r'/i', m')$ is surjective. \end{lemma} \begin{proof} let $f_2 \to f_1 \to f_0 \to m \to 0$ be a free resolution of $m$ over $r$. set $f_i' = f_i \otimes_r r'$. the sequence $f_2' \to f_1' \to f_0' \to m' \to 0$ may no longer be exact at $f_1'$. a free resolution of $m'$ over $r'$ therefore looks like $$ f_2' \oplus f_2'' \to f_1' \to f_0' \to m' \to 0 $$ for a suitable free module $f_2''$ over $r'$. next, note that $f_i \otimes_r r'/i' = f_i' / if_i' = f_i'/i'f_i'$. so the complex $f_2'/i'f_2' \to f_1'/i'f_1' \to f_0'/i'f_0'$ computes $\text{tor}_1^r(m, r'/i')$. on the other hand $f_i' \otimes_{r'} r'/i' = f_i'/i'f_i'$ and similarly for $f_2''$. thus the complex $f_2'/i'f_2' \oplus f_2''/i'f_2'' \to f_1'/i'f_1' \to f_0'/i'f_0'$ computes $\text{tor}_1^{r'}(m', r'/i')$. since the vertical map on complexes $$ \xymatrix{ f_2'/i'f_2' \ar[r] \ar[d] & f_1'/i'f_1' \ar[r] \ar[d] & f_0'/i'f_0' \ar[d] \\ f_2'/i'f_2' \oplus f_2''/i'f_2'' \ar[r] & f_1'/i'f_1' \ar[r] & f_0'/i'f_0' } $$ clearly induces a surjection on cohomology we win. \end{proof} \begin{lemma} \label{lemma-another-variant-local-criterion-flatness} let $$ \xymatrix{ s \ar[r] & s' \\ r \ar[r] \ar[u] & r' \ar[u] } $$ be a commutative diagram of local homomorphisms of local noetherian rings. let $i \subset r$ be a proper ideal. let $m$ be a finite $s$-module. denote $i' = ir'$ and $m' = m \otimes_s s'$. assume that \begin{enumerate} \item $s'$ is a localization of the tensor product $s \otimes_r r'$, \item $m/im$ is flat over $r/i$, \item $\text{tor}_1^r(m, r/i) \to \text{tor}_1^{r'}(m', r'/i')$ is zero. \end{enumerate} then $m'$ is flat over $r'$. \end{lemma} \begin{proof} since $s'$ is a localization of $s \otimes_r r'$ we see that $m'$ is a localization of $m \otimes_r r'$. note that by lemma \ref{lemma-flat-base-change} the module $m/im \otimes_{r/i} r'/i' = m \otimes_r r' /i'(m \otimes_r r')$ is flat over $r'/i'$. hence also $m'/i'm'$ is flat over $r'/i'$ as the localization of a flat module is flat. by lemma \ref{lemma-variant-local-criterion-flatness} it suffices to show that $\text{tor}_1^{r'}(m', r'/i')$ is zero. since $m'$ is a localization of $m \otimes_r r'$, the last assumption implies that it suffices to show that $\text{tor}_1^r(m, r/i) \otimes_r r' \to \text{tor}_1^{r'}(m \otimes_r r', r'/i')$ is surjective. \medskip\noindent by lemma \ref{lemma-surjective-on-tor-one-trivial} we see that $\text{tor}_1^r(m, r'/i') \to \text{tor}_1^{r'}(m \otimes_r r', r'/i')$ is surjective. so now it suffices to show that $\text{tor}_1^r(m, r/i) \otimes_r r' \to \text{tor}_1^r(m, r'/i')$ is surjective. this follows from lemma \ref{lemma-surjective-on-tor-one} by looking at the ring maps $r \to r/i \to r'/i'$ and the module $m$. \end{proof} \noindent please compare the lemma below to lemma \ref{lemma-criterion-flatness-fibre-nilpotent} (the case of a nilpotent ideal) and lemma \ref{lemma-criterion-flatness-fibre} (the case of finitely presented algebras). \begin{lemma}[crit\`ere de platitude par fibres; noetherian case] \label{lemma-criterion-flatness-fibre-noetherian} let $r$, $s$, $s'$ be noetherian local rings and let $r \to s \to s'$ be local ring homomorphisms. let $\mathfrak m \subset r$ be the maximal ideal. let $m$ be an $s'$-module. assume \begin{enumerate} \item the module $m$ is finite over $s'$. \item the module $m$ is not zero. \item the module $m/\mathfrak m m$ is a flat $s/\mathfrak m s$-module. \item the module $m$ is a flat $r$-module. \end{enumerate} then $s$ is flat over $r$ and $m$ is a flat $s$-module. \end{lemma} \begin{proof} set $i = \mathfrak ms \subset s$. then we see that $m/im$ is a flat $s/i$-module because of (3). since $\mathfrak m \otimes_r s' \to i \otimes_s s'$ is surjective we see that also $\mathfrak m \otimes_r m \to i \otimes_s m$ is surjective. consider $$ \mathfrak m \otimes_r m \to i \otimes_s m \to m. $$ as $m$ is flat over $r$ the composition is injective and so both arrows are injective. in particular $\text{tor}_1^s(s/i, m) = 0$ see remark \ref{remark-tor-ring-mod-ideal}. by lemma \ref{lemma-variant-local-criterion-flatness} we conclude that $m$ is flat over $s$. note that since $m/\mathfrak m_{s'}m$ is not zero by nakayama's lemma \ref{lemma-nak} we see that actually $m$ is faithfully flat over $s$ by lemma \ref{lemma-ff} (since it forces $m/\mathfrak m_sm \not = 0$). \medskip\noindent consider the exact sequence $0 \to \mathfrak m \to r \to \kappa \to 0$. this gives an exact sequence $0 \to \text{tor}_1^r(\kappa, s) \to \mathfrak m \otimes_r s \to i \to 0$. since $m$ is flat over $s$ this gives an exact sequence $0 \to \text{tor}_1^r(\kappa, s)\otimes_s m \to \mathfrak m \otimes_r m \to i \otimes_s m \to 0$. by the above this implies that $\text{tor}_1^r(\kappa, s)\otimes_s m = 0$. since $m$ is faithfully flat over $s$ this implies that $\text{tor}_1^r(\kappa, s) = 0$ and we conclude that $s$ is flat over $r$ by lemma \ref{lemma-local-criterion-flatness}. \end{proof} \begin{lemma} \label{lemma-flatness-scallop} let $a$ be a ring, let $m$ be an $a$-module, and let $f \in a$. if \begin{enumerate} \item $f$ is a nonzerodivisor on $a$ and $m$, \item $m_f$ is a flat $a_f$-module, and \item $m/fm$ is a flat $a/fa$-module, \end{enumerate} then $m$ is a flat $a$-module. same with ``flat'' replaced by ``faithfully flat''. \end{lemma} \begin{proof} since $0 \to a \to a \to a/fa \to 0$ and $0 \to m \to m \to m/fm \to 0$ are exact, we find that $\text{tor}_i^a(m, a/fa) = 0$ for $i = 1$ and $i = 2$. by lemma \ref{lemma-what-does-it-mean} we conclude that $\text{tor}_1^a(m, n) = 0$ for all $a$-modules $n$ annihilated by $f$ (this uses the flatness of $m/fm$ over $a/fa$). given an $a$-module $n$ annihilated by $f$ we may choose a short exact sequence $0 \to n' \to f \to n \to 0$ of $a$-modules where $f$ is a direct sum of copies of $a/fa$. from the exact sequence $$ \text{tor}_2^a(m, f) \to \text{tor}_2^a(m, n) \to \text{tor}_1^a(m, n') $$ we conclude that $\text{tor}_2^a(m, n) = 0$ for all $a$-modules $n$ annihilated by $f$. next, let $k$ be an arbitrary $a$-module. we may break the map $f : k \to k$ into two short exact sequences $$ 0 \to k[f] \to k \to k' \to 0 \quad\text{and}\quad 0 \to k' \to k \to k/fk \to 0 $$ where $k' = k/k[f] \cong fk$. applying the exact sequences of tor we obtain exact sequences $$ \text{tor}_1^a(k[f], m) \to \text{tor}_1^a(k, m) \to \text{tor}_1^a(k', m) $$ and $$ \text{tor}_2^a(k/fk, m) \to \text{tor}_1^a(k', m) \to \text{tor}_1^a(k, m) $$ using the vanishing of $\text{tor}_1^a(k[f], m)$ and $\text{tor}_2^a(k/fk, m)$ we conclude that $f : k \to k$ induces an injective map on $\text{tor}^a_1(m, k)$. in other words, we see that $\text{tor}^a_1(m, k)$ is zero if and only if $\text{tor}^a_1(m, k) \otimes_a a_f$ is zero. by lemma \ref{lemma-flat-base-change-tor} we have $$ \text{tor}^a_1(m, k) \otimes_a a_f = \text{tor}^{a_f}_1(m_f, k_f) = 0 $$ the vanishing by the flatness of $m_f$ over $a_f$ (lemma \ref{lemma-characterize-flat}). we conclude that $\text{tor}_1^a(m, k) = 0$ for all $a$-modules $k$. hence $m$ is flat over $a$ by lemma \ref{lemma-characterize-flat}. \medskip\noindent we omit the argument for the case of faithfully flat modules. \end{proof} \begin{lemma} \label{lemma-flatness-scallop-pre} let $a$ be a ring, let $m$ be an $a$-module. let $i = (f_1, \ldots, f_r)$ be an ideal of $a$ generated by $r \geq 1$ elements. if \begin{enumerate} \item $m_{f_i}$ is a flat $a_{f_i}$-module for $i = 1, \ldots, r$, \item $m/im$ is a flat $a/i$-module, \item $\text{tor}_i^a(m, a/i) = 0$ for $i = 1, \ldots, r + 1$. \end{enumerate} then $m$ is a flat $a$-module. same with ``flat'' replaced by ``faithfully flat''. \end{lemma} \begin{proof} from lemma \ref{lemma-what-does-it-mean} we see that $\text{tor}_1^a(m, k) = 0$ for all $a$-modules $k$ annihilated by $i$. given an $a$-module $k$ annihilated by $i$ we may choose a short exact sequence $0 \to n \to f \to k \to 0$ of $a$-modules where $f$ is a direct sum of copies of $a/fa$. we obtain an exact sequence $$ \text{tor}_i^a(m, f) \to \text{tor}_i^a(m, k) \to \text{tor}_{i - 1}^a(m, n) $$ thus using assumption (3) and induction on $i$ we conclude that $\text{tor}_i^a(m, k) = 0$ for all $a$-modules $k$ annihilated by $i$ and $i = 1, \ldots, r + 1$. \medskip\noindent suppose that for some $1 \leq j \leq r$ we have shown that $\text{tor}_i^a(m, k) = 0$ for all $a$-modules $k$ annihilated by $f_1, \ldots, f_j$ and $i = 1, \ldots, j + 1$. let $k$ be an $a$-module annihilated by $f_1, \ldots, f_{j - 1}$. we may break the map $f_j : k \to k$ into two short exact sequences $$ 0 \to k[f_j] \to k \to k' \to 0 \quad\text{and}\quad 0 \to k' \to k \to k/f_jk \to 0 $$ where $k' = k/k[f_j] \cong f_jk$. let $1 \leq i \leq j$. applying the exact sequences of tor we obtain exact sequences $$ \text{tor}_i^a(k[f_j], m) \to \text{tor}_i^a(k, m) \to \text{tor}_i^a(k', m) $$ and $$ \text{tor}_{i + 1}^a(k/f_jk, m) \to \text{tor}_i^a(k', m) \to \text{tor}_i^a(k, m) $$ using the vanishing of $\text{tor}_i^a(k[f_j], m)$ and $\text{tor}_{i + 1}^a(k/f_jk, m)$ we conclude that $f_j : k \to k$ induces an injective map on $\text{tor}^a_i(m, k)$. in other words, we see that $\text{tor}^a_i(m, k)$ is zero if and only if $\text{tor}^a_i(m, k) \otimes_a a_{f_j}$ is zero. by lemma \ref{lemma-flat-base-change-tor} we have $$ \text{tor}^a_i(m, k) \otimes_a a_{f_j} = \text{tor}^{a_{f_j}}_i(m_{f_j}, k_{f_j}) = 0 $$ the vanishing by the flatness of $m_{f_j}$ over $a_{f_j}$ (lemma \ref{lemma-characterize-flat}). we conclude that $\text{tor}_i^a(m, k) = 0$ for all $a$-modules $k$ annihilated by $f_1, \ldots, f_{j - 1}$ and $i = 1, \ldots, j$. by descending induction on $j$, we conclude that this holds for $j = 0$, i.e., we see that $\text{tor}_1^a(m, k) = 0$ for all $a$-modules $k$ . hence $m$ is flat over $a$ by lemma \ref{lemma-characterize-flat}. \medskip\noindent we omit the argument for the case of faithfully flat modules. \end{proof} \section{base change and flatness} \label{section-base-change-flat} \noindent some lemmas which deal with what happens with flatness when doing a base change. \begin{lemma} \label{lemma-base-change-flat-up-down} let $$ \xymatrix{ s \ar[r] & s' \\ r \ar[r] \ar[u] & r' \ar[u] } $$ be a commutative diagram of local homomorphisms of local rings. assume that $s'$ is a localization of the tensor product $s \otimes_r r'$. let $m$ be an $s$-module and set $m' = s' \otimes_s m$. \begin{enumerate} \item if $m$ is flat over $r$ then $m'$ is flat over $r'$. \item if $m'$ is flat over $r'$ and $r \to r'$ is flat then $m$ is flat over $r$. \end{enumerate} in particular we have \begin{enumerate} \item[(3)] if $s$ is flat over $r$ then $s'$ is flat over $r'$. \item[(4)] if $r' \to s'$ and $r \to r'$ are flat then $s$ is flat over $r$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). if $m$ is flat over $r$, then $m \otimes_r r'$ is flat over $r'$ by lemma \ref{lemma-flat-base-change}. if $w \subset s \otimes_r r'$ is the multiplicative subset such that $w^{-1}(s \otimes_r r') = s'$ then $m' = w^{-1}(m \otimes_r r')$. hence $m'$ is flat over $r'$ as the localization of a flat module, see lemma \ref{lemma-flat-localization} part (5). this proves (1) and in particular, we see that (3) holds. \medskip\noindent proof of (2). suppose that $m'$ is flat over $r'$ and $r \to r'$ is flat. by (3) applied to the diagram reflected in the northwest diagonal we see that $s \to s'$ is flat. thus $s \to s'$ is faithfully flat by lemma \ref{lemma-local-flat-ff}. we are going to use the criterion of lemma \ref{lemma-flat} (\ref{item-f-ideal}) to show that $m$ is flat. let $i \subset r$ be an ideal. if $i \otimes_r m \to m$ has a kernel, so does $(i \otimes_r m) \otimes_s s' \to m \otimes_s s' = m'$. note that $i \otimes_r r' = ir'$ as $r \to r'$ is flat, and that $$ (i \otimes_r m) \otimes_s s' = (i \otimes_r r') \otimes_{r'} (m \otimes_s s') = ir' \otimes_{r'} m'. $$ from flatness of $m'$ over $r'$ we conclude that this maps injectively into $m'$. this concludes the proof of (2), and hence (4) is true as well. \end{proof} \noindent here is yet another application of the local criterion of flatness. \begin{lemma} \label{lemma-yet-another-variant-local-criterion-flatness} consider a commutative diagram of local rings and local homomorphisms $$ \xymatrix{ s \ar[r] & s' \\ r \ar[r] \ar[u] & r' \ar[u] } $$ let $m$ be a finite $s$-module. assume that \begin{enumerate} \item the horizontal arrows are flat ring maps \item $m$ is flat over $r$, \item $\mathfrak m_r r' = \mathfrak m_{r'}$, \item $r'$ and $s'$ are noetherian. \end{enumerate} then $m' = m \otimes_s s'$ is flat over $r'$. \end{lemma} \begin{proof} since $\mathfrak m_r \subset r$ and $r \to r'$ is flat, we get $\mathfrak m_r \otimes_r r' = \mathfrak m_r r' = \mathfrak m_{r'}$ by assumption (3). observe that $m'$ is a finite $s'$-module which is flat over $r$ by lemma \ref{lemma-flatness-descends-more-general}. thus $\mathfrak m_r \otimes_r m' \to m'$ is injective. then we get $$ \mathfrak m_r \otimes_r m' = \mathfrak m_r \otimes_r r' \otimes_{r'} m' = \mathfrak m_{r'} \otimes_{r'} m' $$ thus $\mathfrak m_{r'} \otimes_{r'} m' \to m'$ is injective. this shows that $\text{tor}_1^{r'}(\kappa_{r'}, m') = 0$ (remark \ref{remark-tor-ring-mod-ideal}). thus $m'$ is flat over $r'$ by lemma \ref{lemma-local-criterion-flatness}. \end{proof} \section{flatness criteria over artinian rings} \label{section-flatness-artinian} \noindent we discuss some flatness criteria for modules over artinian rings. note that an artinian local ring has a nilpotent maximal ideal so that the following two lemmas apply to artinian local rings. \begin{lemma} \label{lemma-local-artinian-basis-when-flat} let $(r, \mathfrak m)$ be a local ring with nilpotent maximal ideal $\mathfrak m$. let $m$ be a flat $r$-module. if $a$ is a set and $x_\alpha \in m$, $\alpha \in a$ is a collection of elements of $m$, then the following are equivalent: \begin{enumerate} \item $\{\overline{x}_\alpha\}_{\alpha \in a}$ forms a basis for the vector space $m/\mathfrak mm$ over $r/\mathfrak m$, and \item $\{x_\alpha\}_{\alpha \in a}$ forms a basis for $m$ over $r$. \end{enumerate} \end{lemma} \begin{proof} the implication (2) $\rightarrow$ (1) is immediate. assume (1). by nakayama's lemma \ref{lemma-nak} the elements $x_\alpha$ generate $m$. then one gets a short exact sequence $$ 0 \to k \to \bigoplus\nolimits_{\alpha \in a} r \to m \to 0 $$ tensoring with $r/\mathfrak m$ and using lemma \ref{lemma-flat-tor-zero} we obtain $k/\mathfrak mk = 0$. by nakayama's lemma \ref{lemma-nak} we conclude $k = 0$. \end{proof} \begin{lemma} \label{lemma-local-artinian-characterize-flat} let $r$ be a local ring with nilpotent maximal ideal. let $m$ be an $r$-module. the following are equivalent \begin{enumerate} \item $m$ is flat over $r$, \item $m$ is a free $r$-module, and \item $m$ is a projective $r$-module. \end{enumerate} \end{lemma} \begin{proof} since any projective module is flat (as a direct summand of a free module) and every free module is projective, it suffices to prove that a flat module is free. let $m$ be a flat module. let $a$ be a set and let $x_\alpha \in m$, $\alpha \in a$ be elements such that $\overline{x_\alpha} \in m/\mathfrak m m$ forms a basis over the residue field of $r$. by lemma \ref{lemma-local-artinian-basis-when-flat} the $x_\alpha$ are a basis for $m$ over $r$ and we win. \end{proof} \begin{lemma} \label{lemma-lift-basis} let $r$ be a ring. let $i \subset r$ be an ideal. let $m$ be an $r$-module. let $a$ be a set and let $x_\alpha \in m$, $\alpha \in a$ be a collection of elements of $m$. assume \begin{enumerate} \item $i$ is nilpotent, \item $\{\overline{x}_\alpha\}_{\alpha \in a}$ forms a basis for $m/im$ over $r/i$, and \item $\text{tor}_1^r(r/i, m) = 0$. \end{enumerate} then $m$ is free on $\{x_\alpha\}_{\alpha \in a}$ over $r$. \end{lemma} \begin{proof} let $r$, $i$, $m$, $\{x_\alpha\}_{\alpha \in a}$ be as in the lemma and satisfy assumptions (1), (2), and (3). by nakayama's lemma \ref{lemma-nak} the elements $x_\alpha$ generate $m$ over $r$. the assumption $\text{tor}_1^r(r/i, m) = 0$ implies that we have a short exact sequence $$ 0 \to i \otimes_r m \to m \to m/im \to 0. $$ let $\sum f_\alpha x_\alpha = 0$ be a relation in $m$. by choice of $x_\alpha$ we see that $f_\alpha \in i$. hence we conclude that $\sum f_\alpha \otimes x_\alpha = 0$ in $i \otimes_r m$. the map $i \otimes_r m \to i/i^2 \otimes_{r/i} m/im$ and the fact that $\{x_\alpha\}_{\alpha \in a}$ forms a basis for $m/im$ implies that $f_\alpha \in i^2$! hence we conclude that there are no relations among the images of the $x_\alpha$ in $m/i^2m$. in other words, we see that $m/i^2m$ is free with basis the images of the $x_\alpha$. using the map $i \otimes_r m \to i/i^3 \otimes_{r/i^2} m/i^2m$ we then conclude that $f_\alpha \in i^3$! and so on. since $i^n = 0$ for some $n$ by assumption (1) we win. \end{proof} \begin{lemma} \label{lemma-prepare-lift-flatness} let $\varphi : r \to r'$ be a ring map. let $i \subset r$ be an ideal. let $m$ be an $r$-module. assume \begin{enumerate} \item $m/im$ is flat over $r/i$, and \item $r' \otimes_r m$ is flat over $r'$. \end{enumerate} set $i_2 = \varphi^{-1}(\varphi(i^2)r')$. then $m/i_2m$ is flat over $r/i_2$. \end{lemma} \begin{proof} we may replace $r$, $m$, and $r'$ by $r/i_2$, $m/i_2m$, and $r'/\varphi(i)^2r'$. then $i^2 = 0$ and $\varphi$ is injective. by lemma \ref{lemma-what-does-it-mean} and the fact that $i^2 = 0$ it suffices to prove that $\text{tor}^r_1(r/i, m) = k = \ker(i \otimes_r m \to m)$ is zero. set $m' = m \otimes_r r'$ and $i' = ir'$. by assumption the map $i' \otimes_{r'} m' \to m'$ is injective. hence $k$ maps to zero in $$ i' \otimes_{r'} m' = i' \otimes_r m = i' \otimes_{r/i} m/im. $$ then $i \to i'$ is an injective map of $r/i$-modules. since $m/im$ is flat over $r/i$ the map $$ i \otimes_{r/i} m/im \longrightarrow i' \otimes_{r/i} m/im $$ is injective. this implies that $k$ is zero in $i \otimes_r m = i \otimes_{r/i} m/im$ as desired. \end{proof} \begin{lemma} \label{lemma-lift-flatness} let $\varphi : r \to r'$ be a ring map. let $i \subset r$ be an ideal. let $m$ be an $r$-module. assume \begin{enumerate} \item $i$ is nilpotent, \item $r \to r'$ is injective, \item $m/im$ is flat over $r/i$, and \item $r' \otimes_r m$ is flat over $r'$. \end{enumerate} then $m$ is flat over $r$. \end{lemma} \begin{proof} define inductively $i_1 = i$ and $i_{n + 1} = \varphi^{-1}(\varphi(i_n)^2r')$ for $n \geq 1$. note that by lemma \ref{lemma-prepare-lift-flatness} we find that $m/i_nm$ is flat over $r/i_n$ for each $n \geq 1$. it is clear that $\varphi(i_{n + 1}) \subset \varphi(i)^{2^n}r'$. since $i$ is nilpotent we see that $\varphi(i_n) = 0$ for some $n$. as $\varphi$ is injective we conclude that $i_n = 0$ for some $n$ and we win. \end{proof} \noindent here is the local artinian version of the local criterion for flatness. \begin{lemma} \label{lemma-artinian-variant-local-criterion-flatness} let $r$ be an artinian local ring. let $m$ be an $r$-module. let $i \subset r$ be a proper ideal. the following are equivalent \begin{enumerate} \item $m$ is flat over $r$, and \item $m/im$ is flat over $r/i$ and $\text{tor}_1^r(r/i, m) = 0$. \end{enumerate} \end{lemma} \begin{proof} the implication (1) $\rightarrow$ (2) follows immediately from the definitions. assume $m/im$ is flat over $r/i$ and $\text{tor}_1^r(r/i, m) = 0$. by lemma \ref{lemma-local-artinian-characterize-flat} this implies that $m/im$ is free over $r/i$. pick a set $a$ and elements $x_\alpha \in m$ such that the images in $m/im$ form a basis. by lemma \ref{lemma-lift-basis} we conclude that $m$ is free and in particular flat. \end{proof} \noindent it turns out that flatness descends along injective homomorphism whose source is an artinian ring. \begin{lemma} \label{lemma-descent-flatness-injective-map-artinian-rings} let $r \to s$ be a ring map. let $m$ be an $r$-module. assume \begin{enumerate} \item $r$ is artinian \item $r \to s$ is injective, and \item $m \otimes_r s$ is a flat $s$-module. \end{enumerate} then $m$ is a flat $r$-module. \end{lemma} \begin{proof} first proof: let $i \subset r$ be the jacobson radical of $r$. then $i$ is nilpotent and $m/im$ is flat over $r/i$ as $r/i$ is a product of fields, see section \ref{section-artinian}. hence $m$ is flat by an application of lemma \ref{lemma-lift-flatness}. \medskip\noindent second proof: by lemma \ref{lemma-artinian-finite-length} we may write $r = \prod r_i$ as a finite product of local artinian rings. this induces similar product decompositions for both $r$ and $s$. hence we reduce to the case where $r$ is local artinian (details omitted). \medskip\noindent assume that $r \to s$, $m$ are as in the lemma satisfying (1), (2), and (3) and in addition that $r$ is local with maximal ideal $\mathfrak m$. let $a$ be a set and $x_\alpha \in a$ be elements such that $\overline{x}_\alpha$ forms a basis for $m/\mathfrak mm$ over $r/\mathfrak m$. by nakayama's lemma \ref{lemma-nak} we see that the elements $x_\alpha$ generate $m$ as an $r$-module. set $n = s \otimes_r m$ and $i = \mathfrak ms$. then $\{1 \otimes x_\alpha\}_{\alpha \in a}$ is a family of elements of $n$ which form a basis for $n/in$. moreover, since $n$ is flat over $s$ we have $\text{tor}_1^s(s/i, n) = 0$. thus we conclude from lemma \ref{lemma-lift-basis} that $n$ is free on $\{1 \otimes x_\alpha\}_{\alpha \in a}$. the injectivity of $r \to s$ then guarantees that there cannot be a nontrivial relation among the $x_\alpha$ with coefficients in $r$. \end{proof} \noindent please compare the lemma below to lemma \ref{lemma-criterion-flatness-fibre-noetherian} (the case of noetherian local rings), lemma \ref{lemma-criterion-flatness-fibre} (the case of finitely presented algebras), and lemma \ref{lemma-criterion-flatness-fibre-locally-nilpotent} (the case of locally nilpotent ideals). \begin{lemma}[crit\`ere de platitude par fibres: nilpotent case] \label{lemma-criterion-flatness-fibre-nilpotent} let $$ \xymatrix{ s \ar[rr] & & s' \\ & r \ar[lu] \ar[ru] } $$ be a commutative diagram in the category of rings. let $i \subset r$ be a nilpotent ideal and $m$ an $s'$-module. assume \begin{enumerate} \item the module $m/im$ is a flat $s/is$-module. \item the module $m$ is a flat $r$-module. \end{enumerate} then $m$ is a flat $s$-module and $s_{\mathfrak q}$ is flat over $r$ for every $\mathfrak q \subset s$ such that $m \otimes_s \kappa(\mathfrak q)$ is nonzero. \end{lemma} \begin{proof} as $m$ is flat over $r$ tensoring with the short exact sequence $0 \to i \to r \to r/i \to 0$ gives a short exact sequence $$ 0 \to i \otimes_r m \to m \to m/im \to 0. $$ note that $i \otimes_r m \to is \otimes_s m$ is surjective. combined with the above this means both maps in $$ i \otimes_r m \to is \otimes_s m \to m $$ are injective. hence $\text{tor}_1^s(is, m) = 0$ (see remark \ref{remark-tor-ring-mod-ideal}) and we conclude that $m$ is a flat $s$-module by lemma \ref{lemma-what-does-it-mean}. to finish we need to show that $s_{\mathfrak q}$ is flat over $r$ for any prime $\mathfrak q \subset s$ such that $m \otimes_s \kappa(\mathfrak q)$ is nonzero. this follows from lemma \ref{lemma-ff} and \ref{lemma-flat-permanence}. \end{proof} \section{what makes a complex exact?} \label{section-complex-exact} \noindent some of this material can be found in the paper \cite{whatexact} by buchsbaum and eisenbud. \begin{situation} \label{situation-complex} here $r$ is a ring, and we have a complex $$ 0 \to r^{n_e} \xrightarrow{\varphi_e} r^{n_{e-1}} \xrightarrow{\varphi_{e-1}} \ldots \xrightarrow{\varphi_{i + 1}} r^{n_i} \xrightarrow{\varphi_i} r^{n_{i-1}} \xrightarrow{\varphi_{i-1}} \ldots \xrightarrow{\varphi_1} r^{n_0} $$ in other words we require $\varphi_i \circ \varphi_{i + 1} = 0$ for $i = 1, \ldots, e - 1$. \end{situation} \begin{lemma} \label{lemma-add-trivial-complex} suppose $r$ is a ring. let $$ \ldots \xrightarrow{\varphi_{i + 1}} r^{n_i} \xrightarrow{\varphi_i} r^{n_{i-1}} \xrightarrow{\varphi_{i-1}} \ldots $$ be a complex of finite free $r$-modules. suppose that for some $i$ some matrix coefficient of the map $\varphi_i$ is invertible. then the displayed complex is isomorphic to the direct sum of a complex $$ \ldots \to r^{n_{i + 2}} \xrightarrow{\varphi_{i + 2}} r^{n_{i + 1}} \to r^{n_i - 1} \to r^{n_{i - 1} - 1} \to r^{n_{i - 2}} \xrightarrow{\varphi_{i - 2}} r^{n_{i - 3}} \to \ldots $$ and the complex $\ldots \to 0 \to r \to r \to 0 \to \ldots$ where the map $r \to r$ is the identity map. \end{lemma} \begin{proof} the assumption means, after a change of basis of $r^{n_i}$ and $r^{n_{i-1}}$ that the first basis vector of $r^{n_i}$ is mapped via $\varphi_i$ to the first basis vector of $r^{n_{i-1}}$. let $e_j$ denote the $j$th basis vector of $r^{n_i}$ and $f_k$ the $k$th basis vector of $r^{n_{i-1}}$. write $\varphi_i(e_j) = \sum a_{jk} f_k$. so $a_{1k} = 0$ unless $k = 1$ and $a_{11} = 1$. change basis on $r^{n_i}$ again by setting $e'_j = e_j - a_{j1} e_1$ for $j > 1$. after this change of coordinates we have $a_{j1} = 0$ for $j > 1$. note the image of $r^{n_{i + 1}} \to r^{n_i}$ is contained in the subspace spanned by $e_j$, $j > 1$. note also that $r^{n_{i-1}} \to r^{n_{i-2}}$ has to annihilate $f_1$ since it is in the image. these conditions and the shape of the matrix $(a_{jk})$ for $\varphi_i$ imply the lemma. \end{proof} \noindent in situation \ref{situation-complex} we say a complex of the form $$ 0 \to \ldots \to 0 \to r \xrightarrow{1} r \to 0 \to \ldots \to 0 $$ or of the form $$ 0 \to \ldots \to 0 \to r $$ is {\it trivial}. more precisely, we say $0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_0}$ is trivial if either there exists an $e \geq i \geq 1$ with $n_i = n_{i - 1} = 1$, $\varphi_i = \text{id}_r$, and $n_j = 0$ for $j \not \in \{i, i - 1\}$ or $n_0 = 1$ and $n_i = 0$ for $i > 0$. the lemma above clearly says that any finite complex of finite free modules over a local ring is up to direct sums with trivial complexes the same as a complex all of whose maps have all matrix coefficients in the maximal ideal. \begin{lemma} \label{lemma-exact-depth-zero-local} in situation \ref{situation-complex}. suppose $r$ is a local noetherian ring with maximal ideal $\mathfrak m$. assume $\mathfrak m \in \text{ass}(r)$, in other words $r$ has depth $0$. suppose that $0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_0}$ is exact at $r^{n_e}, \ldots, r^{n_1}$. then the complex is isomorphic to a direct sum of trivial complexes. \end{lemma} \begin{proof} pick $x \in r$, $x \not = 0$, with $\mathfrak m x = 0$. let $i$ be the biggest index such that $n_i > 0$. if $i = 0$, then the statement is true. if $i > 0$ denote $f_1$ the first basis vector of $r^{n_i}$. since $xf_1$ is not mapped to zero by exactness of the complex we deduce that some matrix coefficient of the map $r^{n_i} \to r^{n_{i - 1}}$ is not in $\mathfrak m$. lemma \ref{lemma-add-trivial-complex} then allows us to decrease $n_e + \ldots + n_1$. induction finishes the proof. \end{proof} \begin{lemma} \label{lemma-exact-artinian-local} in situation \ref{situation-complex}. let $r$ be a artinian local ring. suppose that $0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_0}$ is exact at $r^{n_e}, \ldots, r^{n_1}$. then the complex is isomorphic to a direct sum of trivial complexes. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-exact-depth-zero-local} because an artinian local ring has depth $0$. \end{proof} \noindent below we define the rank of a map of finite free modules. this is just one possible definition of rank. it is just the definition that works in this section; there are others that may be more convenient in other settings. \begin{definition} \label{definition-rank} let $r$ be a ring. suppose that $\varphi : r^m \to r^n$ is a map of finite free modules. \begin{enumerate} \item the {\it rank} of $\varphi$ is the maximal $r$ such that $\wedge^r \varphi : \wedge^r r^m \to \wedge^r r^n$ is nonzero. \item we let $i(\varphi) \subset r$ be the ideal generated by the $r \times r$ minors of the matrix of $\varphi$, where $r$ is the rank as defined above. \end{enumerate} \end{definition} \noindent the rank of $\varphi : r^m \to r^n$ is $0$ if and only if $\varphi = 0$ and in this case $i(\varphi) = r$. \begin{lemma} \label{lemma-trivial-case-exact} in situation \ref{situation-complex}, suppose the complex is isomorphic to a direct sum of trivial complexes. then we have \begin{enumerate} \item the maps $\varphi_i$ have rank $r_i = n_i - n_{i + 1} + \ldots + (-1)^{e-i-1} n_{e-1} + (-1)^{e-i} n_e$, \item for all $i$, $1 \leq i \leq e - 1$ we have $\text{rank}(\varphi_{i + 1}) + \text{rank}(\varphi_i) = n_i$, \item each $i(\varphi_i) = r$. \end{enumerate} \end{lemma} \begin{proof} we may assume the complex is the direct sum of trivial complexes. then for each $i$ we can split the standard basis elements of $r^{n_i}$ into those that map to a basis element of $r^{n_{i-1}}$ and those that are mapped to zero (and these are mapped onto by basis elements of $r^{n_{i + 1}}$ if $i > 0$). using descending induction starting with $i = e$ it is easy to prove that there are $r_{i + 1}$-basis elements of $r^{n_i}$ which are mapped to zero and $r_i$ which are mapped to basis elements of $r^{n_{i-1}}$. from this the result follows. \end{proof} \begin{lemma} \label{lemma-div-x-exact-one-less} in situation \ref{situation-complex}. suppose $r$ is a local ring with maximal ideal $\mathfrak m$. suppose that $0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_0}$ is exact at $r^{n_e}, \ldots, r^{n_1}$. let $x \in \mathfrak m$ be a nonzerodivisor. the complex $0 \to (r/xr)^{n_e} \to \ldots \to (r/xr)^{n_1}$ is exact at $(r/xr)^{n_e}, \ldots, (r/xr)^{n_2}$. \end{lemma} \begin{proof} denote $f_\bullet$ the complex with terms $f_i = r^{n_i}$ and differential given by $\varphi_i$. then we have a short exact sequence of complexes $$ 0 \to f_\bullet \xrightarrow{x} f_\bullet \to f_\bullet/xf_\bullet \to 0 $$ applying the snake lemma we get a long exact sequence $$ h_i(f_\bullet) \xrightarrow{x} h_i(f_\bullet) \to h_i(f_\bullet/xf_\bullet) \to h_{i - 1}(f_\bullet) \xrightarrow{x} h_{i - 1}(f_\bullet) $$ the lemma follows. \end{proof} \begin{lemma}[acyclicity lemma] \label{lemma-acyclic} \begin{reference} \cite[lemma 1.8]{peskine-szpiro} \end{reference} let $r$ be a local noetherian ring. let $0 \to m_e \to m_{e-1} \to \ldots \to m_0$ be a complex of finite $r$-modules. assume $\text{depth}(m_i) \geq i$. let $i$ be the largest index such that the complex is not exact at $m_i$. if $i > 0$ then $\ker(m_i \to m_{i-1})/\im(m_{i + 1} \to m_i)$ has depth $\geq 1$. \end{lemma} \begin{proof} let $h = \ker(m_i \to m_{i-1})/\im(m_{i + 1} \to m_i)$ be the cohomology group in question. we may break the complex into short exact sequences $0 \to m_e \to m_{e-1} \to k_{e-2} \to 0$, $0 \to k_j \to m_j \to k_{j-1} \to 0$, for $i + 2 \leq j \leq e-2 $, $0 \to k_{i + 1} \to m_{i + 1} \to b_i \to 0$, $0 \to k_i \to m_i \to m_{i-1}$, and $0 \to b_i \to k_i \to h \to 0$. we proceed up through these complexes to prove the statements about depths, repeatedly using lemma \ref{lemma-depth-in-ses}. first of all, since $\text{depth}(m_e) \geq e$, and $\text{depth}(m_{e-1}) \geq e-1$ we deduce that $\text{depth}(k_{e-2}) \geq e - 1$. at this point the sequences $0 \to k_j \to m_j \to k_{j-1} \to 0$ for $i + 2 \leq j \leq e-2 $ imply similarly that $\text{depth}(k_{j-1}) \geq j$ for $i + 2 \leq j \leq e-2$. the sequence $0 \to k_{i + 1} \to m_{i + 1} \to b_i \to 0$ then shows that $\text{depth}(b_i) \geq i + 1$. the sequence $0 \to k_i \to m_i \to m_{i-1}$ shows that $\text{depth}(k_i) \geq 1$ since $m_i$ has depth $\geq i \geq 1$ by assumption. the sequence $0 \to b_i \to k_i \to h \to 0$ then implies the result. \end{proof} \begin{proposition} \label{proposition-what-exact} \begin{reference} \cite[corollary 1]{whatexact} \end{reference} in situation \ref{situation-complex}, suppose $r$ is a local noetherian ring. the following are equivalent \begin{enumerate} \item $0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_0}$ is exact at $r^{n_e}, \ldots, r^{n_1}$, and \item for all $i$, $1 \leq i \leq e$ the following two conditions are satisfied: \begin{enumerate} \item $\text{rank}(\varphi_i) = r_i$ where $r_i = n_i - n_{i + 1} + \ldots + (-1)^{e-i-1} n_{e-1} + (-1)^{e-i} n_e$, \item $i(\varphi_i) = r$, or $i(\varphi_i)$ contains a regular sequence of length $i$. \end{enumerate} \end{enumerate} \end{proposition} \begin{proof} if for some $i$ some matrix coefficient of $\varphi_i$ is not in $\mathfrak m$, then we apply lemma \ref{lemma-add-trivial-complex}. it is easy to see that the proposition for a complex and for the same complex with a trivial complex added to it are equivalent. thus we may assume that all matrix entries of each $\varphi_i$ are elements of the maximal ideal. we may also assume that $e \geq 1$. \medskip\noindent assume the complex is exact at $r^{n_e}, \ldots, r^{n_1}$. let $\mathfrak q \in \text{ass}(r)$. note that the ring $r_{\mathfrak q}$ has depth $0$ and that the complex remains exact after localization at $\mathfrak q$. we apply lemmas \ref{lemma-exact-depth-zero-local} and \ref{lemma-trivial-case-exact} to the localized complex over $r_{\mathfrak q}$. we conclude that $\varphi_{i, \mathfrak q}$ has rank $r_i$ for all $i$. since $r \to \bigoplus_{\mathfrak q \in \text{ass}(r)} r_\mathfrak q$ is injective (lemma \ref{lemma-zero-at-ass-zero}), we conclude that $\varphi_i$ has rank $r_i$ over $r$ by the definition of rank as given in definition \ref{definition-rank}. therefore we see that $i(\varphi_i)_\mathfrak q = i(\varphi_{i, \mathfrak q})$ as the ranks do not change. since all of the ideals $i(\varphi_i)_{\mathfrak q}$, $e \geq i \geq 1$ are equal to $r_{\mathfrak q}$ (by the lemmas referenced above) we conclude none of the ideals $i(\varphi_i)$ is contained in $\mathfrak q$. this implies that $i(\varphi_e)i(\varphi_{e-1})\ldots i(\varphi_1)$ is not contained in any of the associated primes of $r$. by lemma \ref{lemma-silly} we may choose $x \in i(\varphi_e)i(\varphi_{e - 1})\ldots i(\varphi_1)$, $x \not \in \mathfrak q$ for all $\mathfrak q \in \text{ass}(r)$. observe that $x$ is a nonzerodivisor (lemma \ref{lemma-ass-zero-divisors}). according to lemma \ref{lemma-div-x-exact-one-less} the complex $0 \to (r/xr)^{n_e} \to \ldots \to (r/xr)^{n_1}$ is exact at $(r/xr)^{n_e}, \ldots, (r/xr)^{n_2}$. by induction on $e$ all the ideals $i(\varphi_i)/xr$ have a regular sequence of length $i - 1$. this proves that $i(\varphi_i)$ contains a regular sequence of length $i$. \medskip\noindent assume (2)(a) and (2)(b) hold. we will prove that (1) holds by induction on $\dim(r)$. if $\dim(r) = 0$, then we must have $i(\varphi_i) = r$ for $1 \leq i \leq e$ by (2)(b). since the coefficients of $\varphi_i$ are contained in the maximal ideal this can happen only if $r_i = 0$ for all $i$. by (2)(a) we conclude that $e = 0$ and (1) holds. assume $\dim(r) > 0$. we claim that for any prime $\mathfrak p \subset r$ conditions (2)(a) and (2)(b) hold for the complex $0 \to r_\mathfrak p^{n_e} \to r_\mathfrak p^{n_{e - 1}} \to \ldots \to r_\mathfrak p^{n_0}$ with maps $\varphi_{i, \mathfrak p}$ over $r_\mathfrak p$. namely, since $i(\varphi_i)$ contains a nonzero divisor, the image of $i(\varphi_i)$ in $r_\mathfrak p$ is nonzero. this implies that the rank of $\varphi_{i, \mathfrak p}$ is the same as the rank of $\varphi_i$: the rank as defined above of a matrix $\varphi$ over a ring $r$ can only drop when passing to an $r$-algebra $r'$ and this happens if and only if $i(\varphi)$ maps to zero in $r'$. thus (2)(a) holds. having said this we know that $i(\varphi_{i, \mathfrak p}) = i(\varphi_i)_\mathfrak p$ and we see that (2)(b) is preserved under localization as well. by induction on the dimension of $r$ we may assume the complex is exact when localized at any nonmaximal prime $\mathfrak p$ of $r$. thus $\ker(\varphi_i)/\im(\varphi_{i + 1})$ has support contained in $\{\mathfrak m\}$ and hence if nonzero has depth $0$. as $i(\varphi_i) \subset \mathfrak m$ for all $i$ because of what was said in the first paragraph of the proof, we see that (2)(b) implies $\text{depth}(r) \geq e$. by lemma \ref{lemma-acyclic} we see that the complex is exact at $r^{n_e}, \ldots, r^{n_1}$ concluding the proof. \end{proof} \begin{remark} \label{remark-what-exact} if in proposition \ref{proposition-what-exact} the equivalent conditions (1) and (2) are satisfied, then there exists a $j$ such that $i(\varphi_i) = r$ if and only if $i \geq j$. as in the proof of the proposition, it suffices to see this when all the matrices have coefficients in the maximal ideal $\mathfrak m$ of $r$. in this case we see that $i(\varphi_j) = r$ if and only if $\varphi_j = 0$. but if $\varphi_j = 0$, then we get arbitrarily long exact complexes $0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_j} \to 0 \to 0 \to \ldots \to 0$ and hence by the proposition we see that $i(\varphi_i)$ for $i > j$ has to be $r$ (since otherwise it is a proper ideal of a noetherian local ring containing arbitrary long regular sequences which is impossible). \end{remark} \section{cohen-macaulay modules} \label{section-cm} \noindent here we show that cohen-macaulay modules have good properties. we postpone using ext groups to establish the connection with duality and so on. \begin{definition} \label{definition-cm} let $r$ be a noetherian local ring. let $m$ be a finite $r$-module. we say $m$ is {\it cohen-macaulay} if $\dim(\text{supp}(m)) = \text{depth}(m)$. \end{definition} \noindent a first goal will be to establish proposition \ref{proposition-cm-module}. we do this by a (perhaps nonstandard) sequence of elementary lemmas involving almost none of the earlier results on depth. let us introduce some notation. \medskip\noindent let $r$ be a local noetherian ring. let $m$ be a cohen-macaulay module, and let $f_1, \ldots, f_d$ be an $m$-regular sequence with $d = \dim(\text{supp}(m))$. we say that $g \in \mathfrak m$ is {\it good with respect to $(m, f_1, \ldots, f_d)$} if for all $i = 0, 1, \ldots, d-1$ we have $\dim (\text{supp}(m) \cap v(g, f_1, \ldots, f_i)) = d - i - 1$. this is equivalent to the condition that $\dim(\text{supp}(m/(f_1, \ldots, f_i)m) \cap v(g)) = d - i - 1$ for $i = 0, 1, \ldots, d - 1$. \begin{lemma} \label{lemma-good-element} notation and assumptions as above. if $g$ is good with respect to $(m, f_1, \ldots, f_d)$, then (a) $g$ is a nonzerodivisor on $m$, and (b) $m/gm$ is cohen-macaulay with maximal regular sequence $f_1, \ldots, f_{d - 1}$. \end{lemma} \begin{proof} we prove the lemma by induction on $d$. if $d = 0$, then $m$ is finite and there is no case to which the lemma applies. if $d = 1$, then we have to show that $g : m \to m$ is injective. the kernel $k$ has support $\{\mathfrak m\}$ because by assumption $\dim \text{supp}(m) \cap v(g) = 0$. hence $k$ has finite length. hence $f_1 : k \to k$ injective implies the length of the image is the length of $k$, and hence $f_1 k = k$, which by nakayama's lemma \ref{lemma-nak} implies $k = 0$. also, $\dim \text{supp}(m/gm) = 0$ and so $m/gm$ is cohen-macaulay of depth $0$. \medskip\noindent assume $d > 1$. observe that $g$ is good for $(m/f_1m, f_2, \ldots, f_d)$, as is easily seen from the definition. by induction, we have that (a) $g$ is a nonzerodivisor on $m/f_1m$ and (b) $m/(g, f_1)m$ is cohen-macaulay with maximal regular sequence $f_2, \ldots, f_{d - 1}$. by lemma \ref{lemma-permute-xi} we see that $g, f_1$ is an $m$-regular sequence. hence $g$ is a nonzerodivisor on $m$ and $f_1, \ldots, f_{d - 1}$ is an $m/gm$-regular sequence. \end{proof} \begin{lemma} \label{lemma-cm-one-g} let $r$ be a noetherian local ring. let $m$ be a cohen-macaulay module over $r$. suppose $g \in \mathfrak m$ is such that $\dim(\text{supp}(m) \cap v(g)) = \dim(\text{supp}(m)) - 1$. then (a) $g$ is a nonzerodivisor on $m$, and (b) $m/gm$ is cohen-macaulay of depth one less. \end{lemma} \begin{proof} choose a $m$-regular sequence $f_1, \ldots, f_d$ with $d = \dim(\text{supp}(m))$. if $g$ is good with respect to $(m, f_1, \ldots, f_d)$ we win by lemma \ref{lemma-good-element}. in particular the lemma holds if $d = 1$. (the case $d = 0$ does not occur.) assume $d > 1$. choose an element $h \in r$ such that (\romannumeral1) $h$ is good with respect to $(m, f_1, \ldots, f_d)$, and (\romannumeral2) $\dim(\text{supp}(m) \cap v(h, g)) = d - 2$. to see $h$ exists, let $\{\mathfrak q_j\}$ be the (finite) set of minimal primes of the closed sets $\text{supp}(m)$, $\text{supp}(m)\cap v(f_1, \ldots, f_i)$, $i = 1, \ldots, d - 1$, and $\text{supp}(m) \cap v(g)$. none of these $\mathfrak q_j$ is equal to $\mathfrak m$ and hence we may find $h \in \mathfrak m$, $h \not \in \mathfrak q_j$ by lemma \ref{lemma-silly}. it is clear that $h$ satisfies (\romannumeral1) and (\romannumeral2). from lemma \ref{lemma-good-element} we conclude that $m/hm$ is cohen-macaulay. by (\romannumeral2) we see that the pair $(m/hm, g)$ satisfies the induction hypothesis. hence $m/(h, g)m$ is cohen-macaulay and $g : m/hm \to m/hm$ is injective. by lemma \ref{lemma-permute-xi} we see that $g : m \to m$ and $h : m/gm \to m/gm$ are injective. combined with the fact that $m/(g, h)m$ is cohen-macaulay this finishes the proof. \end{proof} \begin{proposition} \label{proposition-cm-module} let $r$ be a noetherian local ring, with maximal ideal $\mathfrak m$. let $m$ be a cohen-macaulay module over $r$ whose support has dimension $d$. suppose that $g_1, \ldots, g_c$ are elements of $\mathfrak m$ such that $\dim(\text{supp}(m/(g_1, \ldots, g_c)m)) = d - c$. then $g_1, \ldots, g_c$ is an $m$-regular sequence, and can be extended to a maximal $m$-regular sequence. \end{proposition} \begin{proof} let $z = \text{supp}(m) \subset \spec(r)$. by lemma \ref{lemma-one-equation} in the chain $z \supset z \cap v(g_1) \supset \ldots \supset z \cap v(g_1, \ldots, g_c)$ each step decreases the dimension at most by $1$. hence by assumption each step decreases the dimension by exactly $1$ each time. thus we may successively apply lemma \ref{lemma-cm-one-g} to the modules $m/(g_1, \ldots, g_i)$ and the element $g_{i + 1}$. \medskip\noindent to extend $g_1, \ldots, g_c$ by one element if $c < d$ we simply choose an element $g_{c + 1} \in \mathfrak m$ which is not in any of the finitely many minimal primes of $z \cap v(g_1, \ldots, g_c)$, using lemma \ref{lemma-silly}. \end{proof} \noindent having proved proposition \ref{proposition-cm-module} we continue the development of standard theory. \begin{lemma} \label{lemma-nonzerodivisor-on-cm} let $r$ be a noetherian local ring with maximal ideal $\mathfrak m$. let $m$ be a finite $r$-module. let $x \in \mathfrak m$ be a nonzerodivisor on $m$. then $m$ is cohen-macaulay if and only if $m/xm$ is cohen-macaulay. \end{lemma} \begin{proof} by lemma \ref{lemma-depth-drops-by-one} we have $\text{depth}(m/xm) = \text{depth}(m)-1$. by lemma \ref{lemma-one-equation-module} we have $\dim(\text{supp}(m/xm)) = \dim(\text{supp}(m)) - 1$. \end{proof} \begin{lemma} \label{lemma-cm-over-quotient} let $r \to s$ be a surjective homomorphism of noetherian local rings. let $n$ be a finite $s$-module. then $n$ is cohen-macaulay as an $s$-module if and only if $n$ is cohen-macaulay as an $r$-module. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-cm-ass-minimal-support} \begin{reference} \cite[chapter 0, proposition 16.5.4]{ega} \end{reference} let $r$ be a noetherian local ring. let $m$ be a finite cohen-macaulay $r$-module. if $\mathfrak p \in \text{ass}(m)$, then $\dim(r/\mathfrak p) = \dim(\text{supp}(m))$ and $\mathfrak p$ is a minimal prime in the support of $m$. in particular, $m$ has no embedded associated primes. \end{lemma} \begin{proof} by lemma \ref{lemma-depth-dim-associated-primes} we have $\text{depth}(m) \leq \dim(r/\mathfrak p)$. of course $\dim(r/\mathfrak p) \leq \dim(\text{supp}(m))$ as $\mathfrak p \in \text{supp}(m)$ (lemma \ref{lemma-ass-support}). thus we have equality in both inequalities as $m$ is cohen-macaulay. then $\mathfrak p$ must be minimal in $\text{supp}(m)$ otherwise we would have $\dim(r/\mathfrak p) < \dim(\text{supp}(m))$. finally, minimal primes in the support of $m$ are equal to the minimal elements of $\text{ass}(m)$ (proposition \ref{proposition-minimal-primes-associated-primes}) hence $m$ has no embedded associated primes (definition \ref{definition-embedded-primes}). \end{proof} \begin{definition} \label{definition-maximal-cm} let $r$ be a noetherian local ring. a finite module $m$ over $r$ is called a {\it maximal cohen-macaulay} module if $\text{depth}(m) = \dim(r)$. \end{definition} \noindent in other words, a maximal cohen-macaulay module over a noetherian local ring is a finite module with the largest possible depth over that ring. equivalently, a maximal cohen-macaulay module over a noetherian local ring $r$ is a cohen-macaulay module of dimension equal to the dimension of the ring. in particular, if $m$ is a cohen-macaulay $r$-module with $\spec(r) = \text{supp}(m)$, then $m$ is maximal cohen-macaulay. thus the following two lemmas are on maximal cohen-macaulay modules. \begin{lemma} \label{lemma-maximal-chain-maximal-cm} \begin{slogan} in a local cohen-macaulay ring, any maximal chain of prime ideals has length equal to the dimension. \end{slogan} let $r$ be a noetherian local ring. assume there exists a cohen-macaulay module $m$ with $\spec(r) = \text{supp}(m)$. then any maximal chain of prime ideals $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n$ has length $n = \dim(r)$. \end{lemma} \begin{proof} we will prove this by induction on $\dim(r)$. if $\dim(r) = 0$, then the statement is clear. assume $\dim(r) > 0$. then $n > 0$. choose an element $x \in \mathfrak p_1$, with $x$ not in any of the minimal primes of $r$, and in particular $x \not \in \mathfrak p_0$. (see lemma \ref{lemma-silly}.) then $\dim(r/xr) = \dim(r) - 1$ by lemma \ref{lemma-one-equation}. the module $m/xm$ is cohen-macaulay over $r/xr$ by proposition \ref{proposition-cm-module} and lemma \ref{lemma-cm-over-quotient}. the support of $m/xm$ is $\spec(r/xr)$ by lemma \ref{lemma-support-quotient}. after replacing $x$ by $x^n$ for some $n$, we may assume that $\mathfrak p_1$ is an associated prime of $m/xm$, see lemma \ref{lemma-inherit-minimal-primes}. by lemma \ref{lemma-cm-ass-minimal-support} we conclude that $\mathfrak p_1/(x)$ is a minimal prime of $r/xr$. it follows that the chain $\mathfrak p_1/(x) \subset \ldots \subset \mathfrak p_n/(x)$ is a maximal chain of primes in $r/xr$. by induction we find that this chain has length $\dim(r/xr) = \dim(r) - 1$ as desired. \end{proof} \begin{lemma} \label{lemma-dim-formula-maximal-cm} suppose $r$ is a noetherian local ring. assume there exists a cohen-macaulay module $m$ with $\spec(r) = \text{supp}(m)$. then for a prime $\mathfrak p \subset r$ we have $$ \dim(r) = \dim(r_{\mathfrak p}) + \dim(r/\mathfrak p). $$ \end{lemma} \begin{proof} follows immediately from lemma \ref{lemma-maximal-chain-maximal-cm}. \end{proof} \begin{lemma} \label{lemma-localize-cm-module} suppose $r$ is a noetherian local ring. let $m$ be a cohen-macaulay module over $r$. for any prime $\mathfrak p \subset r$ the module $m_{\mathfrak p}$ is cohen-macaulay over $r_\mathfrak p$. \end{lemma} \begin{proof} we may and do assume $\mathfrak p \not = \mathfrak m$ and $m$ not zero. choose a maximal chain of primes $\mathfrak p = \mathfrak p_c \subset \mathfrak p_{c - 1} \subset \ldots \subset \mathfrak p_1 \subset \mathfrak m$. if we prove the result for $m_{\mathfrak p_1}$ over $r_{\mathfrak p_1}$, then the lemma will follow by induction on $c$. thus we may assume that there is no prime strictly between $\mathfrak p$ and $\mathfrak m$. note that $\dim(\text{supp}(m_\mathfrak p)) \leq \dim(\text{supp}(m)) - 1$ because any chain of primes in the support of $m_\mathfrak p$ can be extended by one more prime (namely $\mathfrak m$) in the support of $m$. on the other hand, we have $\text{depth}(m_\mathfrak p) \geq \text{depth}(m) - \dim(r/\mathfrak p) = \text{depth}(m) - 1$ by lemma \ref{lemma-depth-localization} and our choice of $\mathfrak p$. thus $\text{depth}(m_\mathfrak p) \geq \dim(\text{supp}(m_\mathfrak p))$ as desired (the other inequality is lemma \ref{lemma-bound-depth}). \end{proof} \begin{definition} \label{definition-module-cm} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. we say $m$ is {\it cohen-macaulay} if $m_\mathfrak p$ is a cohen-macaulay module over $r_\mathfrak p$ for all primes $\mathfrak p$ of $r$. \end{definition} \noindent by lemma \ref{lemma-localize-cm-module} it suffices to check this in the maximal ideals of $r$. \begin{lemma} \label{lemma-maximal-cm-polynomial-algebra} let $r$ be a noetherian ring. let $m$ be a cohen-macaulay module over $r$. then $m \otimes_r r[x_1, \ldots, x_n]$ is a cohen-macaulay module over $r[x_1, \ldots, x_n]$. \end{lemma} \begin{proof} by induction on the number of variables it suffices to prove this for $m[x] = m \otimes_r r[x]$ over $r[x]$. let $\mathfrak m \subset r[x]$ be a maximal ideal, and let $\mathfrak p = r \cap \mathfrak m$. let $f_1, \ldots, f_d$ be a $m_\mathfrak p$-regular sequence in the maximal ideal of $r_{\mathfrak p}$ of length $d = \dim(\text{supp}(m_{\mathfrak p}))$. note that since $r[x]$ is flat over $r$ the localization $r[x]_{\mathfrak m}$ is flat over $r_{\mathfrak p}$. hence, by lemma \ref{lemma-flat-increases-depth}, the sequence $f_1, \ldots, f_d$ is a $m[x]_{\mathfrak m}$-regular sequence of length $d$ in $r[x]_{\mathfrak m}$. the quotient $$ q = m[x]_{\mathfrak m}/(f_1, \ldots, f_d)m[x]_{\mathfrak m} = m_{\mathfrak p}/(f_1, \ldots, f_d)m_{\mathfrak p} \otimes_{r_\mathfrak p} r[x]_{\mathfrak m} $$ has support equal to the primes lying over $\mathfrak p$ because $r_\mathfrak p \to r[x]_\mathfrak m$ is flat and the support of $m_{\mathfrak p}/(f_1, \ldots, f_d)m_{\mathfrak p}$ is equal to $\{\mathfrak p\}$ (details omitted; hint: follows from lemmas \ref{lemma-annihilator-flat-base-change} and \ref{lemma-support-closed}). hence the dimension is $1$. to finish the proof it suffices to find an $f \in \mathfrak m$ which is a nonzerodivisor on $q$. since $\mathfrak m$ is a maximal ideal, the field extension $\kappa(\mathfrak m)/\kappa(\mathfrak p)$ is finite (theorem \ref{theorem-nullstellensatz}). hence we can find $f \in \mathfrak m$ which viewed as a polynomial in $x$ has leading coefficient not in $\mathfrak p$. such an $f$ acts as a nonzerodivisor on $$ m_{\mathfrak p}/(f_1, \ldots, f_d)m_{\mathfrak p} \otimes_r r[x] = \bigoplus\nolimits_{n \geq 0} m_{\mathfrak p}/(f_1, \ldots, f_d)m_{\mathfrak p} \cdot x^n $$ and hence acts as a nonzerodivisor on $q$. \end{proof} \section{cohen-macaulay rings} \label{section-cm-ring} \noindent most of the results of this section are special cases of the results in section \ref{section-cm}. \begin{definition} \label{definition-local-ring-cm} a noetherian local ring $r$ is called {\it cohen-macaulay} if it is cohen-macaulay as a module over itself. \end{definition} \noindent note that this is equivalent to requiring the existence of a $r$-regular sequence $x_1, \ldots, x_d$ of the maximal ideal such that $r/(x_1, \ldots, x_d)$ has dimension $0$. we will usually just say ``regular sequence'' and not ``$r$-regular sequence''. \begin{lemma} \label{lemma-reformulate-cm} \begin{slogan} regular sequences in cohen-macaulay local rings are characterized by cutting out something of the correct dimension. \end{slogan} let $r$ be a noetherian local cohen-macaulay ring with maximal ideal $\mathfrak m $. let $x_1, \ldots, x_c \in \mathfrak m$ be elements. then $$ x_1, \ldots, x_c \text{ is a regular sequence } \leftrightarrow \dim(r/(x_1, \ldots, x_c)) = \dim(r) - c $$ if so $x_1, \ldots, x_c$ can be extended to a regular sequence of length $\dim(r)$ and each quotient $r/(x_1, \ldots, x_i)$ is a cohen-macaulay ring of dimension $\dim(r) - i$. \end{lemma} \begin{proof} special case of proposition \ref{proposition-cm-module}. \end{proof} \begin{lemma} \label{lemma-maximal-chain-cm} let $r$ be noetherian local. suppose $r$ is cohen-macaulay of dimension $d$. any maximal chain of ideals $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n$ has length $n = d$. \end{lemma} \begin{proof} special case of lemma \ref{lemma-maximal-chain-maximal-cm}. \end{proof} \begin{lemma} \label{lemma-cm-dim-formula} suppose $r$ is a noetherian local cohen-macaulay ring of dimension $d$. for any prime $\mathfrak p \subset r$ we have $$ \dim(r) = \dim(r_{\mathfrak p}) + \dim(r/\mathfrak p). $$ \end{lemma} \begin{proof} follows immediately from lemma \ref{lemma-maximal-chain-cm}. (also, this is a special case of lemma \ref{lemma-dim-formula-maximal-cm}.) \end{proof} \begin{lemma} \label{lemma-localize-cm} suppose $r$ is a cohen-macaulay local ring. for any prime $\mathfrak p \subset r$ the ring $r_{\mathfrak p}$ is cohen-macaulay as well. \end{lemma} \begin{proof} special case of lemma \ref{lemma-localize-cm-module}. \end{proof} \begin{definition} \label{definition-ring-cm} a noetherian ring $r$ is called {\it cohen-macaulay} if all its local rings are cohen-macaulay. \end{definition} \begin{lemma} \label{lemma-cm-polynomial-algebra} suppose $r$ is a noetherian cohen-macaulay ring. any polynomial algebra over $r$ is cohen-macaulay. \end{lemma} \begin{proof} special case of lemma \ref{lemma-maximal-cm-polynomial-algebra}. \end{proof} \begin{lemma} \label{lemma-dimension-shift} let $r$ be a noetherian local cohen-macaulay ring of dimension $d$. let $0 \to k \to r^{\oplus n} \to m \to 0$ be an exact sequence of $r$-modules. then either $m = 0$, or $\text{depth}(k) > \text{depth}(m)$, or $\text{depth}(k) = \text{depth}(m) = d$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-depth-in-ses}. \end{proof} \begin{lemma} \label{lemma-mcm-resolution} let $r$ be a local noetherian cohen-macaulay ring of dimension $d$. let $m$ be a finite $r$-module of depth $e$. there exists an exact complex $$ 0 \to k \to f_{d-e-1} \to \ldots \to f_0 \to m \to 0 $$ with each $f_i$ finite free and $k$ maximal cohen-macaulay. \end{lemma} \begin{proof} immediate from the definition and lemma \ref{lemma-dimension-shift}. \end{proof} \begin{lemma} \label{lemma-find-sequence-image-regular} let $\varphi : a \to b$ be a map of local rings. assume that $b$ is noetherian and cohen-macaulay and that $\mathfrak m_b = \sqrt{\varphi(\mathfrak m_a) b}$. then there exists a sequence of elements $f_1, \ldots, f_{\dim(b)}$ in $a$ such that $\varphi(f_1), \ldots, \varphi(f_{\dim(b)})$ is a regular sequence in $b$. \end{lemma} \begin{proof} by induction on $\dim(b)$ it suffices to prove: if $\dim(b) \geq 1$, then we can find an element $f$ of $a$ which maps to a nonzerodivisor in $b$. by lemma \ref{lemma-reformulate-cm} it suffices to find $f \in a$ whose image in $b$ is not contained in any of the finitely many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_r$ of $b$. by the assumption that $\mathfrak m_b = \sqrt{\varphi(\mathfrak m_a) b}$ we see that $\mathfrak m_a \not \subset \varphi^{-1}(\mathfrak q_i)$. hence we can find $f$ by lemma \ref{lemma-silly}. \end{proof} \section{catenary rings} \label{section-catenary} \noindent compare with topology, section \ref{topology-section-catenary-spaces}. \begin{definition} \label{definition-catenary} a ring $r$ is said to be {\it catenary} if for any pair of prime ideals $\mathfrak p \subset \mathfrak q$, there exists an integer bounding the lengths of all finite chains of prime ideals $\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_e = \mathfrak q$ and all maximal such chains have the same length. \end{definition} \begin{lemma} \label{lemma-catenary} a ring $r$ is catenary if and only if the topological space $\spec(r)$ is catenary (see topology, definition \ref{topology-definition-catenary}). \end{lemma} \begin{proof} immediate from the definition and the characterization of irreducible closed subsets in lemma \ref{lemma-irreducible}. \end{proof} \noindent in general it is not the case that a finitely generated $r$-algebra is catenary if $r$ is. thus we make the following definition. \begin{definition} \label{definition-universally-catenary} a noetherian ring $r$ is said to be {\it universally catenary} if every $r$-algebra of finite type is catenary. \end{definition} \noindent we restrict to noetherian rings as it is not clear this definition is the right one for non-noetherian rings. by lemma \ref{lemma-quotient-catenary} to check a noetherian ring $r$ is universally catenary, it suffices to check each polynomial algebra $r[x_1, \ldots, x_n]$ is catenary. \begin{lemma} \label{lemma-localization-catenary} any localization of a catenary ring is catenary. any localization of a noetherian universally catenary ring is universally catenary. \end{lemma} \begin{proof} let $a$ be a ring and let $s \subset a$ be a multiplicative subset. the description of $\spec(s^{-1}a)$ in lemma \ref{lemma-spec-localization} shows that if $a$ is catenary, then so is $s^{-1}a$. if $s^{-1}a \to c$ is of finite type, then $c = s^{-1}b$ for some finite type ring map $a \to b$. hence if $a$ is noetherian and universally catenary, then $b$ is catenary and we see that $c$ is catenary too. this proves the lemma. \end{proof} \begin{lemma} \label{lemma-universally-catenary} let $a$ be a noetherian universally catenary ring. any $a$-algebra essentially of finite type over $a$ is universally catenary. \end{lemma} \begin{proof} if $b$ is a finite type $a$-algebra, then $b$ is noetherian by lemma \ref{lemma-noetherian-permanence}. any finite type $b$-algebra is a finite type $a$-algebra and hence catenary by our assumption that $a$ is universally catenary. thus $b$ is universally catenary. any localization of $b$ is universally catenary by lemma \ref{lemma-localization-catenary} and this finishes the proof. \end{proof} \begin{lemma} \label{lemma-catenary-check-local} let $r$ be a ring. the following are equivalent \begin{enumerate} \item $r$ is catenary, \item $r_\mathfrak p$ is catenary for all prime ideals $\mathfrak p$, \item $r_\mathfrak m$ is catenary for all maximal ideals $\mathfrak m$. \end{enumerate} assume $r$ is noetherian. the following are equivalent \begin{enumerate} \item $r$ is universally catenary, \item $r_\mathfrak p$ is universally catenary for all prime ideals $\mathfrak p$, \item $r_\mathfrak m$ is universally catenary for all maximal ideals $\mathfrak m$. \end{enumerate} \end{lemma} \begin{proof} the implication (1) $\rightarrow$ (2) follows from lemma \ref{lemma-localization-catenary} in both cases. the implication (2) $\rightarrow$ (3) is immediate in both cases. assume $r_\mathfrak m$ is catenary for all maximal ideals $\mathfrak m$ of $r$. if $\mathfrak p \subset \mathfrak q$ are primes in $r$, then choose a maximal ideal $\mathfrak q \subset \mathfrak m$. chains of primes ideals between $\mathfrak p$ and $\mathfrak q$ are in 1-to-1 correspondence with chains of prime ideals between $\mathfrak pr_\mathfrak m$ and $\mathfrak qr_\mathfrak m$ hence we see $r$ is catenary. assume $r$ is noetherian and $r_\mathfrak m$ is universally catenary for all maximal ideals $\mathfrak m$ of $r$. let $r \to s$ be a finite type ring map. let $\mathfrak q$ be a prime ideal of $s$ lying over the prime $\mathfrak p \subset r$. choose a maximal ideal $\mathfrak p \subset \mathfrak m$ in $r$. then $r_\mathfrak p$ is a localization of $r_\mathfrak m$ hence universally catenary by lemma \ref{lemma-localization-catenary}. then $s_\mathfrak p$ is catenary as a finite type ring over $r_\mathfrak p$. hence $s_\mathfrak q$ is catenary as a localization. thus $s$ is catenary by the first case treated above. \end{proof} \begin{lemma} \label{lemma-quotient-catenary} any quotient of a catenary ring is catenary. any quotient of a noetherian universally catenary ring is universally catenary. \end{lemma} \begin{proof} let $a$ be a ring and let $i \subset a$ be an ideal. the description of $\spec(a/i)$ in lemma \ref{lemma-spec-closed} shows that if $a$ is catenary, then so is $a/i$. the second statement is a special case of lemma \ref{lemma-universally-catenary}. \end{proof} \begin{lemma} \label{lemma-catenary-check-irreducible} let $r$ be a noetherian ring. \begin{enumerate} \item $r$ is catenary if and only if $r/\mathfrak p$ is catenary for every minimal prime $\mathfrak p$. \item $r$ is universally catenary if and only if $r/\mathfrak p$ is universally catenary for every minimal prime $\mathfrak p$. \end{enumerate} \end{lemma} \begin{proof} if $\mathfrak a \subset \mathfrak b$ is an inclusion of primes of $r$, then we can find a minimal prime $\mathfrak p \subset \mathfrak a$ and the first assertion is clear. we omit the proof of the second. \end{proof} \begin{lemma} \label{lemma-cm-ring-catenary} a noetherian cohen-macaulay ring is universally catenary. more generally, if $r$ is a noetherian ring and $m$ is a cohen-macaulay $r$-module with $\text{supp}(m) = \spec(r)$, then $r$ is universally catenary. \end{lemma} \begin{proof} since a polynomial algebra over $r$ is cohen-macaulay, by lemma \ref{lemma-cm-polynomial-algebra}, it suffices to show that a cohen-macaulay ring is catenary. let $r$ be cohen-macaulay and $\mathfrak p \subset \mathfrak q$ primes of $r$. by definition $r_{\mathfrak q}$ and $r_{\mathfrak p}$ are cohen-macaulay. take a maximal chain of primes $\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n = \mathfrak q$. next choose a maximal chain of primes $\mathfrak q_0 \subset \mathfrak q_1 \subset \ldots \subset \mathfrak q_m = \mathfrak p$. by lemma \ref{lemma-maximal-chain-cm} we have $n + m = \dim(r_{\mathfrak q})$. and we have $m = \dim(r_{\mathfrak p})$ by the same lemma. hence $n = \dim(r_{\mathfrak q}) - \dim(r_{\mathfrak p})$ is independent of choices. \medskip\noindent to prove the more general statement, argue exactly as above but using lemmas \ref{lemma-maximal-cm-polynomial-algebra} and \ref{lemma-maximal-chain-maximal-cm}. \end{proof} \begin{lemma} \label{lemma-catenary-noetherian-local} let $(a, \mathfrak m)$ be a noetherian local ring. the following are equivalent \begin{enumerate} \item $a$ is catenary, and \item $\mathfrak p \mapsto \dim(a/\mathfrak p)$ is a dimension function on $\spec(a)$. \end{enumerate} \end{lemma} \begin{proof} if $a$ is catenary, then $\spec(a)$ has a dimension function $\delta$ by topology, lemma \ref{topology-lemma-locally-dimension-function} (and lemma \ref{lemma-catenary}). we may assume $\delta(\mathfrak m) = 0$. then we see that $$ \delta(\mathfrak p) = \text{codim}(v(\mathfrak m), v(\mathfrak p)) = \dim(a/\mathfrak p) $$ by topology, lemma \ref{topology-lemma-dimension-function-catenary}. in this way we see that (1) implies (2). the reverse implication follows from topology, lemma \ref{topology-lemma-dimension-function-catenary} as well. \end{proof} \section{regular local rings} \label{section-regular} \noindent regular local rings are defined in definition \ref{definition-regular-local}. it is not that easy to show that all prime localizations of a regular local ring are regular. in fact, quite a bit of the material developed so far is geared towards a proof of this fact. see proposition \ref{proposition-finite-gl-dim-regular}, and trace back the references. \begin{lemma} \label{lemma-regular-graded} let $(r, \mathfrak m, \kappa)$ be a regular local ring of dimension $d$. the graded ring $\bigoplus \mathfrak m^n / \mathfrak m^{n + 1}$ is isomorphic to the graded polynomial algebra $\kappa[x_1, \ldots, x_d]$. \end{lemma} \begin{proof} let $x_1, \ldots, x_d$ be a minimal set of generators for the maximal ideal $\mathfrak m$, see definition \ref{definition-regular-local}. there is a surjection $\kappa[x_1, \ldots, x_d] \to \bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$, which maps $x_i$ to the class of $x_i$ in $\mathfrak m/\mathfrak m^2$. since $d(r) = d$ by proposition \ref{proposition-dimension} we know that the numerical polynomial $n \mapsto \dim_\kappa \mathfrak m^n/\mathfrak m^{n + 1}$ has degree $d - 1$. by lemma \ref{lemma-quotient-smaller-d} we conclude that the surjection $\kappa[x_1, \ldots, x_d] \to \bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$ is an isomorphism. \end{proof} \begin{lemma} \label{lemma-regular-domain} any regular local ring is a domain. \end{lemma} \begin{proof} we will use that $\bigcap \mathfrak m^n = 0$ by lemma \ref{lemma-intersect-powers-ideal-module-zero}. let $f, g \in r$ such that $fg = 0$. suppose that $f \in \mathfrak m^a$ and $g \in \mathfrak m^b$, with $a, b$ maximal. since $fg = 0 \in \mathfrak m^{a + b + 1}$ we see from the result of lemma \ref{lemma-regular-graded} that either $f \in \mathfrak m^{a + 1}$ or $g \in \mathfrak m^{b + 1}$. contradiction. \end{proof} \begin{lemma} \label{lemma-regular-ring-cm} let $r$ be a regular local ring and let $x_1, \ldots, x_d$ be a minimal set of generators for the maximal ideal $\mathfrak m$. then $x_1, \ldots, x_d$ is a regular sequence, and each $r/(x_1, \ldots, x_c)$ is a regular local ring of dimension $d - c$. in particular $r$ is cohen-macaulay. \end{lemma} \begin{proof} note that $r/x_1r$ is a noetherian local ring of dimension $\geq d - 1$ by lemma \ref{lemma-one-equation} with $x_2, \ldots, x_d$ generating the maximal ideal. hence it is a regular local ring by definition. since $r$ is a domain by lemma \ref{lemma-regular-domain} $x_1$ is a nonzerodivisor. \end{proof} \begin{lemma} \label{lemma-regular-quotient-regular} let $r$ be a regular local ring. let $i \subset r$ be an ideal such that $r/i$ is a regular local ring as well. then there exists a minimal set of generators $x_1, \ldots, x_d$ for the maximal ideal $\mathfrak m$ of $r$ such that $i = (x_1, \ldots, x_c)$ for some $0 \leq c \leq d$. \end{lemma} \begin{proof} say $\dim(r) = d$ and $\dim(r/i) = d - c$. denote $\overline{\mathfrak m} = \mathfrak m/i$ the maximal ideal of $r/i$. let $\kappa = r/\mathfrak m$. we have $$ \dim_\kappa((i + \mathfrak m^2)/\mathfrak m^2) = \dim_\kappa(\mathfrak m/\mathfrak m^2) - \dim(\overline{\mathfrak m}/\overline{\mathfrak m}^2) = d - (d - c) = c $$ by the definition of a regular local ring. hence we can choose $x_1, \ldots, x_c \in i$ whose images in $\mathfrak m/\mathfrak m^2$ are linearly independent and supplement with $x_{c + 1}, \ldots, x_d$ to get a minimal system of generators of $\mathfrak m$. the induced map $r/(x_1, \ldots, x_c) \to r/i$ is a surjection between regular local rings of the same dimension (lemma \ref{lemma-regular-ring-cm}). it follows that the kernel is zero, i.e., $i = (x_1, \ldots, x_c)$. namely, if not then we would have $\dim(r/i) < \dim(r/(x_1, \ldots, x_c))$ by lemmas \ref{lemma-regular-domain} and \ref{lemma-one-equation}. \end{proof} \begin{lemma} \label{lemma-free-mod-x} let $r$ be a noetherian local ring. let $x \in \mathfrak m$. let $m$ be a finite $r$-module such that $x$ is a nonzerodivisor on $m$ and $m/xm$ is free over $r/xr$. then $m$ is free over $r$. \end{lemma} \begin{proof} let $m_1, \ldots, m_r$ be elements of $m$ which map to a $r/xr$-basis of $m/xm$. by nakayama's lemma \ref{lemma-nak} $m_1, \ldots, m_r$ generate $m$. if $\sum a_i m_i = 0$ is a relation, then $a_i \in xr$ for all $i$. hence $a_i = b_i x$ for some $b_i \in r$. hence the kernel $k$ of $r^r \to m$ satisfies $xk = k$ and hence is zero by nakayama's lemma. \end{proof} \begin{lemma} \label{lemma-regular-mcm-free} let $r$ be a regular local ring. any maximal cohen-macaulay module over $r$ is free. \end{lemma} \begin{proof} let $m$ be a maximal cohen-macaulay module over $r$. let $x \in \mathfrak m$ be part of a regular sequence generating $\mathfrak m$. then $x$ is a nonzerodivisor on $m$ by proposition \ref{proposition-cm-module}, and $m/xm$ is a maximal cohen-macaulay module over $r/xr$. by induction on $\dim(r)$ we see that $m/xm$ is free. we win by lemma \ref{lemma-free-mod-x}. \end{proof} \begin{lemma} \label{lemma-regular-mod-x} suppose $r$ is a noetherian local ring. let $x \in \mathfrak m$ be a nonzerodivisor such that $r/xr$ is a regular local ring. then $r$ is a regular local ring. more generally, if $x_1, \ldots, x_r$ is a regular sequence in $r$ such that $r/(x_1, \ldots, x_r)$ is a regular local ring, then $r$ is a regular local ring. \end{lemma} \begin{proof} this is true because $x$ together with the lifts of a system of minimal generators of the maximal ideal of $r/xr$ will give $\dim(r)$ generators of $\mathfrak m$. use lemma \ref{lemma-one-equation}. the last statement follows from the first and induction. \end{proof} \begin{lemma} \label{lemma-colimit-regular} let $(r_i, \varphi_{ii'})$ be a directed system of local rings whose transition maps are local ring maps. if each $r_i$ is a regular local ring and $r = \colim r_i$ is noetherian, then $r$ is a regular local ring. \end{lemma} \begin{proof} let $\mathfrak m \subset r$ be the maximal ideal; it is the colimit of the maximal ideal $\mathfrak m_i \subset r_i$. we prove the lemma by induction on $d = \dim \mathfrak m/\mathfrak m^2$. if $d = 0$, then $r = r/\mathfrak m$ is a field and $r$ is a regular local ring. if $d > 0$ pick an $x \in \mathfrak m$, $x \not \in \mathfrak m^2$. for some $i$ we can find an $x_i \in \mathfrak m_i$ mapping to $x$. note that $r/xr = \colim_{i' \geq i} r_{i'}/x_ir_{i'}$ is a noetherian local ring. by lemma \ref{lemma-regular-ring-cm} we see that $r_{i'}/x_ir_{i'}$ is a regular local ring. hence by induction we see that $r/xr$ is a regular local ring. since each $r_i$ is a domain (lemma \ref{lemma-regular-graded}) we see that $r$ is a domain. hence $x$ is a nonzerodivisor and we conclude that $r$ is a regular local ring by lemma \ref{lemma-regular-mod-x}. \end{proof} \section{epimorphisms of rings} \label{section-epimorphism} \noindent in any category there is a notion of an {\it epimorphism}. some of this material is taken from \cite{autour} and \cite{mazet}. \begin{lemma} \label{lemma-epimorphism} let $r \to s$ be a ring map. the following are equivalent \begin{enumerate} \item $r \to s$ is an epimorphism, \item the two ring maps $s \to s \otimes_r s$ are equal, \item either of the ring maps $s \to s \otimes_r s$ is an isomorphism, and \item the ring map $s \otimes_r s \to s$ is an isomorphism. \end{enumerate} \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-composition-epimorphism} the composition of two epimorphisms of rings is an epimorphism. \end{lemma} \begin{proof} omitted. hint: this is true in any category. \end{proof} \begin{lemma} \label{lemma-base-change-epimorphism} if $r \to s$ is an epimorphism of rings and $r \to r'$ is any ring map, then $r' \to r' \otimes_r s$ is an epimorphism. \end{lemma} \begin{proof} omitted. hint: true in any category with pushouts. \end{proof} \begin{lemma} \label{lemma-permanence-epimorphism} if $a \to b \to c$ are ring maps and $a \to c$ is an epimorphism, so is $b \to c$. \end{lemma} \begin{proof} omitted. hint: this is true in any category. \end{proof} \noindent this means in particular, that if $r \to s$ is an epimorphism with image $\overline{r} \subset s$, then $\overline{r} \to s$ is an epimorphism. hence while proving results for epimorphisms we may often assume the map is injective. the following lemma means in particular that every localization is an epimorphism. \begin{lemma} \label{lemma-epimorphism-local} let $r \to s$ be a ring map. the following are equivalent: \begin{enumerate} \item $r \to s$ is an epimorphism, and \item $r_{\mathfrak p} \to s_{\mathfrak p}$ is an epimorphism for each prime $\mathfrak p$ of $r$. \end{enumerate} \end{lemma} \begin{proof} since $s_{\mathfrak p} = r_{\mathfrak p} \otimes_r s$ (see lemma \ref{lemma-tensor-localization}) we see that (1) implies (2) by lemma \ref{lemma-base-change-epimorphism}. conversely, assume that (2) holds. let $a, b : s \to a$ be two ring maps from $s$ to a ring $a$ equalizing the map $r \to s$. by assumption we see that for every prime $\mathfrak p$ of $r$ the induced maps $a_{\mathfrak p}, b_{\mathfrak p} : s_{\mathfrak p} \to a_{\mathfrak p}$ are the same. hence $a = b$ as $a \subset \prod_{\mathfrak p} a_{\mathfrak p}$, see lemma \ref{lemma-characterize-zero-local}. \end{proof} \begin{lemma} \label{lemma-finite-epimorphism-surjective} \begin{slogan} a ring map is surjective if and only if it is a finite epimorphism. \end{slogan} let $r \to s$ be a ring map. the following are equivalent \begin{enumerate} \item $r \to s$ is an epimorphism and finite, and \item $r \to s$ is surjective. \end{enumerate} \end{lemma} \begin{proof} (this lemma seems to have been reproved many times in the literature, and has many different proofs.) it is clear that a surjective ring map is an epimorphism. suppose that $r \to s$ is a finite ring map such that $s \otimes_r s \to s$ is an isomorphism. our goal is to show that $r \to s$ is surjective. assume $s/r$ is not zero. the exact sequence $r \to s \to s/r \to 0$ leads to an exact sequence $$ r \otimes_r s \to s \otimes_r s \to s/r \otimes_r s \to 0. $$ our assumption implies that the first arrow is an isomorphism, hence we conclude that $s/r \otimes_r s = 0$. hence also $s/r \otimes_r s/r = 0$. by lemma \ref{lemma-trivial-filter-finite-module} there exists a surjection of $r$-modules $s/r \to r/i$ for some proper ideal $i \subset r$. hence there exists a surjection $s/r \otimes_r s/r \to r/i \otimes_r r/i = r/i \not = 0$, contradiction. \end{proof} \begin{lemma} \label{lemma-faithfully-flat-epimorphism} a faithfully flat epimorphism is an isomorphism. \end{lemma} \begin{proof} this is clear from lemma \ref{lemma-epimorphism} part (3) as the map $s \to s \otimes_r s$ is the map $r \to s$ tensored with $s$. \end{proof} \begin{lemma} \label{lemma-epimorphism-over-field} if $k \to s$ is an epimorphism and $k$ is a field, then $s = k$ or $s = 0$. \end{lemma} \begin{proof} this is clear from the result of lemma \ref{lemma-faithfully-flat-epimorphism} (as any nonzero algebra over $k$ is faithfully flat), or by arguing directly that $r \to r \otimes_k r$ cannot be surjective unless $\dim_k(r) \leq 1$. \end{proof} \begin{lemma} \label{lemma-epimorphism-injective-spec} let $r \to s$ be an epimorphism of rings. then \begin{enumerate} \item $\spec(s) \to \spec(r)$ is injective, and \item for $\mathfrak q \subset s$ lying over $\mathfrak p \subset r$ we have $\kappa(\mathfrak p) = \kappa(\mathfrak q)$. \end{enumerate} \end{lemma} \begin{proof} let $\mathfrak p$ be a prime of $r$. the fibre of the map is the spectrum of the fibre ring $s \otimes_r \kappa(\mathfrak p)$. by lemma \ref{lemma-base-change-epimorphism} the map $\kappa(\mathfrak p) \to s \otimes_r \kappa(\mathfrak p)$ is an epimorphism, and hence by lemma \ref{lemma-epimorphism-over-field} we have either $s \otimes_r \kappa(\mathfrak p) = 0$ or $s \otimes_r \kappa(\mathfrak p) = \kappa(\mathfrak p)$ which proves (1) and (2). \end{proof} \begin{lemma} \label{lemma-relations} let $r$ be a ring. let $m$, $n$ be $r$-modules. let $\{x_i\}_{i \in i}$ be a set of generators of $m$. let $\{y_j\}_{j \in j}$ be a set of generators of $n$. let $\{m_j\}_{j \in j}$ be a family of elements of $m$ with $m_j = 0$ for all but finitely many $j$. then $$ \sum\nolimits_{j \in j} m_j \otimes y_j = 0 \text{ in } m \otimes_r n $$ is equivalent to the following: there exist $a_{i, j} \in r$ with $a_{i, j} = 0$ for all but finitely many pairs $(i, j)$ such that \begin{align*} m_j & = \sum\nolimits_{i \in i} a_{i, j} x_i \quad\text{for all } j \in j, \\ 0 & = \sum\nolimits_{j \in j} a_{i, j} y_j \quad\text{for all } i \in i. \end{align*} \end{lemma} \begin{proof} the sufficiency is immediate. suppose that $\sum_{j \in j} m_j \otimes y_j = 0$. consider the short exact sequence $$ 0 \to k \to \bigoplus\nolimits_{j \in j} r \to n \to 0 $$ where the $j$th basis vector of $\bigoplus\nolimits_{j \in j} r$ maps to $y_j$. tensor this with $m$ to get the exact sequence $$ k \otimes_r m \to \bigoplus\nolimits_{j \in j} m \to n \otimes_r m \to 0. $$ the assumption implies that there exist elements $k_i \in k$ such that $\sum k_i \otimes x_i$ maps to the element $(m_j)_{j \in j}$ of the middle. writing $k_i = (a_{i, j})_{j \in j}$ and we obtain what we want. \end{proof} \begin{lemma} \label{lemma-kernel-difference-projections} let $\varphi : r \to s$ be a ring map. let $g \in s$. the following are equivalent: \begin{enumerate} \item $g \otimes 1 = 1 \otimes g$ in $s \otimes_r s$, and \item there exist $n \geq 0$ and elements $y_i, z_j \in s$ and $x_{i, j} \in r$ for $1 \leq i, j \leq n$ such that \begin{enumerate} \item $g = \sum_{i, j \leq n} x_{i, j} y_i z_j$, \item for each $j$ we have $\sum x_{i, j}y_i \in \varphi(r)$, and \item for each $i$ we have $\sum x_{i, j}z_j \in \varphi(r)$. \end{enumerate} \end{enumerate} \end{lemma} \begin{proof} it is clear that (2) implies (1). conversely, suppose that $g \otimes 1 = 1 \otimes g$. choose generators $\{s_i\}_{i \in i}$ of $s$ as an $r$-module with $0, 1 \in i$ and $s_0 = 1$ and $s_1 = g$. apply lemma \ref{lemma-relations} to the relation $g \otimes s_0 + (-1) \otimes s_1 = 0$. we see that there exist $a_{i, j} \in r$ such that $g = \sum_i a_{i, 0} s_i$, $-1 = \sum_i a_{i, 1} s_i$, and for $j \not = 0, 1$ we have $0 = \sum_i a_{i, j} s_i$, and moreover for all $i$ we have $\sum_j a_{i, j}s_j = 0$. then we have $$ \sum\nolimits_{i, j \not = 0} a_{i, j} s_i s_j = -g + a_{0, 0} $$ and for each $j \not = 0$ we have $\sum_{i \not = 0} a_{i, j}s_i \in r$. this proves that $-g + a_{0, 0}$ can be written as in (2). it follows that $g$ can be written as in (2). details omitted. hint: show that the set of elements of $s$ which have an expression as in (2) form an $r$-subalgebra of $s$. \end{proof} \begin{remark} \label{remark-matrices-associated-to-elements-epicenter} let $r \to s$ be a ring map. sometimes the set of elements $g \in s$ such that $g \otimes 1 = 1 \otimes g$ is called the {\it epicenter} of $s$. it is an $r$-algebra. by the construction of lemma \ref{lemma-kernel-difference-projections} we get for each $g$ in the epicenter a matrix factorization $$ (g) = y x z $$ with $x \in \text{mat}(n \times n, r)$, $y \in \text{mat}(1 \times n, s)$, and $z \in \text{mat}(n \times 1, s)$. namely, let $x_{i, j}, y_i, z_j$ be as in part (2) of the lemma. set $x = (x_{i, j})$, let $y$ be the row vector whose entries are the $y_i$ and let $z$ be the column vector whose entries are the $z_j$. with this notation conditions (b) and (c) of lemma \ref{lemma-kernel-difference-projections} mean exactly that $y x \in \text{mat}(1 \times n, r)$, $x z \in \text{mat}(n \times 1, r)$. it turns out to be very convenient to consider the triple of matrices $(x, yx, xz)$. given $n \in \mathbf{n}$ and a triple $(p, u, v)$ we say that $(p, u, v)$ is a {\it $n$-triple associated to $g$} if there exists a matrix factorization as above such that $p = x$, $u = yx$ and $v = xz$. \end{remark} \begin{lemma} \label{lemma-epimorphism-cardinality} let $r \to s$ be an epimorphism of rings. then the cardinality of $s$ is at most the cardinality of $r$. in a formula: $|s| \leq |r|$. \end{lemma} \begin{proof} the condition that $r \to s$ is an epimorphism means that each $g \in s$ satisfies $g \otimes 1 = 1 \otimes g$, see lemma \ref{lemma-epimorphism}. we are going to use the notation introduced in remark \ref{remark-matrices-associated-to-elements-epicenter}. suppose that $g, g' \in s$ and suppose that $(p, u, v)$ is an $n$-triple which is associated to both $g$ and $g'$. then we claim that $g = g'$. namely, write $(p, u, v) = (x, yx, xz)$ for a matrix factorization $(g) = yxz$ of $g$ and write $(p, u, v) = (x', y'x', x'z')$ for a matrix factorization $(g') = y'x'z'$ of $g'$. then we see that $$ (g) = yxz = uz = y'x'z = y'pz = y'xz = y'v = y'x'z' = (g') $$ and hence $g = g'$. this implies that the cardinality of $s$ is bounded by the number of possible triples, which has cardinality at most $\sup_{n \in \mathbf{n}} |r|^n$. if $r$ is infinite then this is at most $|r|$, see \cite[ch. i, 10.13]{kunen}. \medskip\noindent if $r$ is a finite ring then the argument above only proves that $s$ is at worst countable. in fact in this case $r$ is artinian and the map $r \to s$ is surjective. we omit the proof of this case. \end{proof} \begin{lemma} \label{lemma-epimorphism-modules} let $r \to s$ be an epimorphism of rings. let $n_1, n_2$ be $s$-modules. then $\hom_s(n_1, n_2) = \hom_r(n_1, n_2)$. in other words, the restriction functor $\text{mod}_s \to \text{mod}_r$ is fully faithful. \end{lemma} \begin{proof} let $\varphi : n_1 \to n_2$ be an $r$-linear map. for any $x \in n_1$ consider the map $s \otimes_r s \to n_2$ defined by the rule $g \otimes g' \mapsto g\varphi(g'x)$. since both maps $s \to s \otimes_r s$ are isomorphisms (lemma \ref{lemma-epimorphism}), we conclude that $g \varphi(g'x) = gg'\varphi(x) = \varphi(gg' x)$. thus $\varphi$ is $s$-linear. \end{proof} \section{pure ideals} \label{section-pure-ideals} \noindent the material in this section is discussed in many papers, see for example \cite{lazard}, \cite{bkouche}, and \cite{demarco}. \begin{definition} \label{definition-pure-ideal} let $r$ be a ring. we say that $i \subset r$ is {\it pure} if the quotient ring $r/i$ is flat over $r$. \end{definition} \begin{lemma} \label{lemma-pure} let $r$ be a ring. let $i \subset r$ be an ideal. the following are equivalent: \begin{enumerate} \item $i$ is pure, \item for every ideal $j \subset r$ we have $j \cap i = ij$, \item for every finitely generated ideal $j \subset r$ we have $j \cap i = ji$, \item for every $x \in r$ we have $(x) \cap i = xi$, \item for every $x \in i$ we have $x = yx$ for some $y \in i$, \item for every $x_1, \ldots, x_n \in i$ there exists a $y \in i$ such that $x_i = yx_i$ for all $i = 1, \ldots, n$, \item for every prime $\mathfrak p$ of $r$ we have $ir_{\mathfrak p} = 0$ or $ir_{\mathfrak p} = r_{\mathfrak p}$, \item $\text{supp}(i) = \spec(r) \setminus v(i)$, \item $i$ is the kernel of the map $r \to (1 + i)^{-1}r$, \item $r/i \cong s^{-1}r$ as $r$-algebras for some multiplicative subset $s$ of $r$, and \item $r/i \cong (1 + i)^{-1}r$ as $r$-algebras. \end{enumerate} \end{lemma} \begin{proof} for any ideal $j$ of $r$ we have the short exact sequence $0 \to j \to r \to r/j \to 0$. tensoring with $r/i$ we get an exact sequence $j \otimes_r r/i \to r/i \to r/i + j \to 0$ and $j \otimes_r r/i = j/ji$. thus the equivalence of (1), (2), and (3) follows from lemma \ref{lemma-flat}. moreover, these imply (4). \medskip\noindent the implication (4) $\rightarrow$ (5) is trivial. assume (5) and let $x_1, \ldots, x_n \in i$. choose $y_i \in i$ such that $x_i = y_ix_i$. let $y \in i$ be the element such that $1 - y = \prod_{i = 1, \ldots, n} (1 - y_i)$. then $x_i = yx_i$ for all $i = 1, \ldots, n$. hence (6) holds, and it follows that (5) $\leftrightarrow$ (6). \medskip\noindent assume (5). let $x \in i$. then $x = yx$ for some $y \in i$. hence $x(1 - y) = 0$, which shows that $x$ maps to zero in $(1 + i)^{-1}r$. of course the kernel of the map $r \to (1 + i)^{-1}r$ is always contained in $i$. hence we see that (5) implies (9). assume (9). then for any $x \in i$ we see that $x(1 - y) = 0$ for some $y \in i$. in other words, $x = yx$. we conclude that (5) is equivalent to (9). \medskip\noindent assume (5). let $\mathfrak p$ be a prime of $r$. if $\mathfrak p \not \in v(i)$, then $ir_{\mathfrak p} = r_{\mathfrak p}$. if $\mathfrak p \in v(i)$, in other words, if $i \subset \mathfrak p$, then $x \in i$ implies $x(1 - y) = 0$ for some $y \in i$, implies $x$ maps to zero in $r_{\mathfrak p}$, i.e., $ir_{\mathfrak p} = 0$. thus we see that (7) holds. \medskip\noindent assume (7). then $(r/i)_{\mathfrak p}$ is either $0$ or $r_{\mathfrak p}$ for any prime $\mathfrak p$ of $r$. hence by lemma \ref{lemma-flat-localization} we see that (1) holds. at this point we see that all of (1) -- (7) and (9) are equivalent. \medskip\noindent as $ir_{\mathfrak p} = i_{\mathfrak p}$ we see that (7) implies (8). finally, if (8) holds, then this means exactly that $i_{\mathfrak p}$ is the zero module if and only if $\mathfrak p \in v(i)$, which is clearly saying that (7) holds. now (1) -- (9) are equivalent. \medskip\noindent assume (1) -- (9) hold. then $r/i \subset (1 + i)^{-1}r$ by (9) and the map $r/i \to (1 + i)^{-1}r$ is also surjective by the description of localizations at primes afforded by (7). hence (11) holds. \medskip\noindent the implication (11) $\rightarrow$ (10) is trivial. and (10) implies that (1) holds because a localization of $r$ is flat over $r$, see lemma \ref{lemma-flat-localization}. \end{proof} \begin{lemma} \label{lemma-pure-ideal-determined-by-zero-set} \begin{slogan} pure ideals are determined by their vanishing locus. \end{slogan} let $r$ be a ring. if $i, j \subset r$ are pure ideals, then $v(i) = v(j)$ implies $i = j$. \end{lemma} \begin{proof} for example, by property (7) of lemma \ref{lemma-pure} we see that $i = \ker(r \to \prod_{\mathfrak p \in v(i)} r_{\mathfrak p})$ can be recovered from the closed subset associated to it. \end{proof} \begin{lemma} \label{lemma-pure-open-closed-specializations} let $r$ be a ring. the rule $i \mapsto v(i)$ determines a bijection $$ \{i \subset r \text{ pure}\} \leftrightarrow \{z \subset \spec(r)\text{ closed and closed under generalizations}\} $$ \end{lemma} \begin{proof} let $i$ be a pure ideal. then since $r \to r/i$ is flat, by going down generalizations lift along the map $\spec(r/i) \to \spec(r)$. hence $v(i)$ is closed under generalizations. this shows that the map is well defined. by lemma \ref{lemma-pure-ideal-determined-by-zero-set} the map is injective. suppose that $z \subset \spec(r)$ is closed and closed under generalizations. let $j \subset r$ be the radical ideal such that $z = v(j)$. let $i = \{x \in r : x \in xj\}$. note that $i$ is an ideal: if $x, y \in i$ then there exist $f, g \in j$ such that $x = xf$ and $y = yg$. then $$ x + y = (x + y)(f + g - fg) $$ verification left to the reader. we claim that $i$ is pure and that $v(i) = v(j)$. if the claim is true then the map of the lemma is surjective and the lemma holds. \medskip\noindent note that $i \subset j$, so that $v(j) \subset v(i)$. let $i \subset \mathfrak p$ be a prime. consider the multiplicative subset $s = (r \setminus \mathfrak p)(1 + j)$. by definition of $i$ and $i \subset \mathfrak p$ we see that $0 \not \in s$. hence we can find a prime $\mathfrak q$ of $r$ which is disjoint from $s$, see lemmas \ref{lemma-localization-zero} and \ref{lemma-spec-localization}. hence $\mathfrak q \subset \mathfrak p$ and $\mathfrak q \cap (1 + j) = \emptyset$. this implies that $\mathfrak q + j$ is a proper ideal of $r$. let $\mathfrak m$ be a maximal ideal containing $\mathfrak q + j$. then we get $\mathfrak m \in v(j)$ and hence $\mathfrak q \in v(j) = z$ as $z$ was assumed to be closed under generalization. this in turn implies $\mathfrak p \in v(j)$ as $\mathfrak q \subset \mathfrak p$. thus we see that $v(i) = v(j)$. \medskip\noindent finally, since $v(i) = v(j)$ (and $j$ radical) we see that $j = \sqrt{i}$. pick $x \in i$, so that $x = xy$ for some $y \in j$ by definition. then $x = xy = xy^2 = \ldots = xy^n$. since $y^n \in i$ for some $n > 0$ we conclude that property (5) of lemma \ref{lemma-pure} holds and we see that $i$ is indeed pure. \end{proof} \begin{lemma} \label{lemma-finitely-generated-pure-ideal} let $r$ be a ring. let $i \subset r$ be an ideal. the following are equivalent \begin{enumerate} \item $i$ is pure and finitely generated, \item $i$ is generated by an idempotent, \item $i$ is pure and $v(i)$ is open, and \item $r/i$ is a projective $r$-module. \end{enumerate} \end{lemma} \begin{proof} if (1) holds, then $i = i \cap i = i^2$ by lemma \ref{lemma-pure}. hence $i$ is generated by an idempotent by lemma \ref{lemma-ideal-is-squared-union-connected}. thus (1) $\rightarrow$ (2). if (2) holds, then $i = (e)$ and $r = (1 - e) \oplus (e)$ as an $r$-module hence $r/i$ is flat and $i$ is pure and $v(i) = d(1 - e)$ is open. thus (2) $\rightarrow$ (1) $+$ (3). finally, assume (3). then $v(i)$ is open and closed, hence $v(i) = d(1 - e)$ for some idempotent $e$ of $r$, see lemma \ref{lemma-disjoint-decomposition}. the ideal $j = (e)$ is a pure ideal such that $v(j) = v(i)$ hence $i = j$ by lemma \ref{lemma-pure-ideal-determined-by-zero-set}. in this way we see that (3) $\rightarrow$ (2). by lemma \ref{lemma-finite-projective} we see that (4) is equivalent to the assertion that $i$ is pure and $r/i$ finitely presented. moreover, $r/i$ is finitely presented if and only if $i$ is finitely generated, see lemma \ref{lemma-extension}. hence (4) is equivalent to (1). \end{proof} \noindent we can use the above to characterize those rings for which every finite flat module is finitely presented. \begin{lemma} \label{lemma-finite-flat-module-finitely-presented} let $r$ be a ring. the following are equivalent: \begin{enumerate} \item every $z \subset \spec(r)$ which is closed and closed under generalizations is also open, and \item any finite flat $r$-module is finite locally free. \end{enumerate} \end{lemma} \begin{proof} if any finite flat $r$-module is finite locally free then the support of $r/i$ where $i$ is a pure ideal is open. hence the implication (2) $\rightarrow$ (1) follows from lemma \ref{lemma-pure-ideal-determined-by-zero-set}. \medskip\noindent for the converse assume that $r$ satisfies (1). let $m$ be a finite flat $r$-module. the support $z = \text{supp}(m)$ of $m$ is closed, see lemma \ref{lemma-support-closed}. on the other hand, if $\mathfrak p \subset \mathfrak p'$, then by lemma \ref{lemma-finite-flat-local} the module $m_{\mathfrak p'}$ is free, and $m_{\mathfrak p} = m_{\mathfrak p'} \otimes_{r_{\mathfrak p'}} r_{\mathfrak p}$ hence $\mathfrak p' \in \text{supp}(m) \rightarrow \mathfrak p \in \text{supp}(m)$, in other words, the support is closed under generalization. as $r$ satisfies (1) we see that the support of $m$ is open and closed. suppose that $m$ is generated by $r$ elements $m_1, \ldots, m_r$. the modules $\wedge^i(m)$, $i = 1, \ldots, r$ are finite flat $r$-modules also, because $\wedge^i(m)_{\mathfrak p} = \wedge^i(m_{\mathfrak p})$ is free over $r_{\mathfrak p}$. note that $\text{supp}(\wedge^{i + 1}(m)) \subset \text{supp}(\wedge^i(m))$. thus we see that there exists a decomposition $$ \spec(r) = u_0 \amalg u_1 \amalg \ldots \amalg u_r $$ by open and closed subsets such that the support of $\wedge^i(m)$ is $u_r \cup \ldots \cup u_i$ for all $i = 0, \ldots, r$. let $\mathfrak p$ be a prime of $r$, and say $\mathfrak p \in u_i$. note that $\wedge^i(m) \otimes_r \kappa(\mathfrak p) = \wedge^i(m \otimes_r \kappa(\mathfrak p))$. hence, after possibly renumbering $m_1, \ldots, m_r$ we may assume that $m_1, \ldots, m_i$ generate $m \otimes_r \kappa(\mathfrak p)$. by nakayama's lemma \ref{lemma-nak} we get a surjection $$ r_f^{\oplus i} \longrightarrow m_f, \quad (a_1, \ldots, a_i) \longmapsto \sum a_im_i $$ for some $f \in r$, $f \not \in \mathfrak p$. we may also assume that $d(f) \subset u_i$. this means that $\wedge^i(m_f) = \wedge^i(m)_f$ is a flat $r_f$ module whose support is all of $\spec(r_f)$. by the above it is generated by a single element, namely $m_1 \wedge \ldots \wedge m_i$. hence $\wedge^i(m)_f \cong r_f/j$ for some pure ideal $j \subset r_f$ with $v(j) = \spec(r_f)$. clearly this means that $j = (0)$, see lemma \ref{lemma-pure-ideal-determined-by-zero-set}. thus $m_1 \wedge \ldots \wedge m_i$ is a basis for $\wedge^i(m_f)$ and it follows that the displayed map is injective as well as surjective. this proves that $m$ is finite locally free as desired. \end{proof} \section{rings of finite global dimension} \label{section-ring-finite-gl-dim} \noindent the following lemma is often used to compare different projective resolutions of a given module. \begin{lemma}[schanuel's lemma] \label{lemma-schanuel} let $r$ be a ring. let $m$ be an $r$-module. suppose that $$ 0 \to k \xrightarrow{c_1} p_1 \xrightarrow{p_1} m \to 0 \quad\text{and}\quad 0 \to l \xrightarrow{c_2} p_2 \xrightarrow{p_2} m \to 0 $$ are two short exact sequences, with $p_i$ projective. then $k \oplus p_2 \cong l \oplus p_1$. more precisely, there exist a commutative diagram $$ \xymatrix{ 0 \ar[r] & k \oplus p_2 \ar[r]_{(c_1, \text{id})} \ar[d] & p_1 \oplus p_2 \ar[r]_{(p_1, 0)} \ar[d] & m \ar[r] \ar@{=}[d] & 0 \\ 0 \ar[r] & p_1 \oplus l \ar[r]^{(\text{id}, c_2)} & p_1 \oplus p_2 \ar[r]^{(0, p_2)} & m \ar[r] & 0 } $$ whose vertical arrows are isomorphisms. \end{lemma} \begin{proof} consider the module $n$ defined by the short exact sequence $0 \to n \to p_1 \oplus p_2 \to m \to 0$, where the last map is the sum of the two maps $p_i \to m$. it is easy to see that the projection $n \to p_1$ is surjective with kernel $l$, and that $n \to p_2$ is surjective with kernel $k$. since $p_i$ are projective we have $n \cong k \oplus p_2 \cong l \oplus p_1$. this proves the first statement. \medskip\noindent to prove the second statement (and to reprove the first), choose $a : p_1 \to p_2$ and $b : p_2 \to p_1$ such that $p_1 = p_2 \circ a$ and $p_2 = p_1 \circ b$. this is possible because $p_1$ and $p_2$ are projective. then we get a commutative diagram $$ \xymatrix{ 0 \ar[r] & k \oplus p_2 \ar[r]_{(c_1, \text{id})} & p_1 \oplus p_2 \ar[r]_{(p_1, 0)} & m \ar[r] & 0 \\ 0 \ar[r] & n \ar[r] \ar[d] \ar[u] & p_1 \oplus p_2 \ar[r]_{(p_1, p_2)} \ar[d]_s \ar[u]^t & m \ar[r] \ar@{=}[d] \ar@{=}[u] & 0 \\ 0 \ar[r] & p_1 \oplus l \ar[r]^{(\text{id}, c_2)} & p_1 \oplus p_2 \ar[r]^{(0, p_2)} & m \ar[r] & 0 } $$ with $t$ and $s$ given by the matrices $$ s = \left( \begin{matrix} \text{id} & 0 \\ a & \text{id} \end{matrix} \right) \quad\text{and}\quad t = \left( \begin{matrix} \text{id} & b \\ 0 & \text{id} \end{matrix} \right) $$ then $s$, $t$ and the maps $n \to p_1 \oplus l$ and $n \to k \oplus p_2$ are isomorphisms as desired. \end{proof} \begin{definition} \label{definition-finite-proj-dim} let $r$ be a ring. let $m$ be an $r$-module. we say $m$ has {\it finite projective dimension} if it has a finite length resolution by projective $r$-modules. the minimal length of such a resolution is called the {\it projective dimension} of $m$. \end{definition} \noindent it is clear that the projective dimension of $m$ is $0$ if and only if $m$ is a projective module. the following lemma explains to what extent the projective dimension is independent of the choice of a projective resolution. \begin{lemma} \label{lemma-independent-resolution} let $r$ be a ring. suppose that $m$ is an $r$-module of projective dimension $d$. suppose that $f_e \to f_{e-1} \to \ldots \to f_0 \to m \to 0$ is exact with $f_i$ projective and $e \geq d - 1$. then the kernel of $f_e \to f_{e-1}$ is projective (or the kernel of $f_0 \to m$ is projective in case $e = 0$). \end{lemma} \begin{proof} we prove this by induction on $d$. if $d = 0$, then $m$ is projective. in this case there is a splitting $f_0 = \ker(f_0 \to m) \oplus m$, and hence $\ker(f_0 \to m)$ is projective. this finishes the proof if $e = 0$, and if $e > 0$, then replacing $m$ by $\ker(f_0 \to m)$ we decrease $e$. \medskip\noindent next assume $d > 0$. let $0 \to p_d \to p_{d-1} \to \ldots \to p_0 \to m \to 0$ be a minimal length finite resolution with $p_i$ projective. according to schanuel's lemma \ref{lemma-schanuel} we have $p_0 \oplus \ker(f_0 \to m) \cong f_0 \oplus \ker(p_0 \to m)$. this proves the case $d = 1$, $e = 0$, because then the right hand side is $f_0 \oplus p_1$ which is projective. hence now we may assume $e > 0$. the module $f_0 \oplus \ker(p_0 \to m)$ has the finite projective resolution $$ 0 \to p_d \to p_{d-1} \to \ldots \to p_2 \to p_1 \oplus f_0 \to \ker(p_0 \to m) \oplus f_0 \to 0 $$ of length $d - 1$. by induction applied to the exact sequence $$ f_e \to f_{e-1} \to \ldots \to f_2 \to p_0 \oplus f_1 \to p_0 \oplus \ker(f_0 \to m) \to 0 $$ of length $e - 1$ we conclude $\ker(f_e \to f_{e - 1})$ is projective (if $e \geq 2$) or that $\ker(f_1 \oplus p_0 \to f_0 \oplus p_0)$ is projective. this implies the lemma. \end{proof} \begin{lemma} \label{lemma-what-kind-of-resolutions} let $r$ be a ring. let $m$ be an $r$-module. let $d \geq 0$. the following are equivalent \begin{enumerate} \item $m$ has projective dimension $\leq d$, \item there exists a resolution $0 \to p_d \to p_{d - 1} \to \ldots \to p_0 \to m \to 0$ with $p_i$ projective, \item for some resolution $\ldots \to p_2 \to p_1 \to p_0 \to m \to 0$ with $p_i$ projective we have $\ker(p_{d - 1} \to p_{d - 2})$ is projective if $d \geq 2$, or $\ker(p_0 \to m)$ is projective if $d = 1$, or $m$ is projective if $d = 0$, \item for any resolution $\ldots \to p_2 \to p_1 \to p_0 \to m \to 0$ with $p_i$ projective we have $\ker(p_{d - 1} \to p_{d - 2})$ is projective if $d \geq 2$, or $\ker(p_0 \to m)$ is projective if $d = 1$, or $m$ is projective if $d = 0$. \end{enumerate} \end{lemma} \begin{proof} the equivalence of (1) and (2) is the definition of projective dimension, see definition \ref{definition-finite-proj-dim}. we have (2) $\rightarrow$ (4) by lemma \ref{lemma-independent-resolution}. the implications (4) $\rightarrow$ (3) and (3) $\rightarrow$ (2) are immediate. \end{proof} \begin{lemma} \label{lemma-what-kind-of-resolutions-local} let $r$ be a local ring. let $m$ be an $r$-module. let $d \geq 0$. the equivalent conditions (1) -- (4) of lemma \ref{lemma-what-kind-of-resolutions} are also equivalent to \begin{enumerate} \item[(5)] there exists a resolution $0 \to p_d \to p_{d - 1} \to \ldots \to p_0 \to m \to 0$ with $p_i$ free. \end{enumerate} \end{lemma} \begin{proof} follows from lemma \ref{lemma-what-kind-of-resolutions} and theorem \ref{theorem-projective-free-over-local-ring}. \end{proof} \begin{lemma} \label{lemma-what-kind-of-resolutions-noetherian} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. let $d \geq 0$. the equivalent conditions (1) -- (4) of lemma \ref{lemma-what-kind-of-resolutions} are also equivalent to \begin{enumerate} \item[(6)] there exists a resolution $0 \to p_d \to p_{d - 1} \to \ldots \to p_0 \to m \to 0$ with $p_i$ finite projective. \end{enumerate} \end{lemma} \begin{proof} choose a resolution $\ldots \to f_2 \to f_1 \to f_0 \to m \to 0$ with $f_i$ finite free (lemma \ref{lemma-resolution-by-finite-free}). by lemma \ref{lemma-what-kind-of-resolutions} we see that $p_d = \ker(f_{d - 1} \to f_{d - 2})$ is projective at least if $d \geq 2$. then $p_d$ is a finite $r$-module as $r$ is noetherian and $p_d \subset f_{d - 1}$ which is finite free. whence $0 \to p_d \to f_{d - 1} \to \ldots \to f_1 \to f_0 \to m \to 0$ is the desired resolution. \end{proof} \begin{lemma} \label{lemma-what-kind-of-resolutions-noetherian-local} let $r$ be a local noetherian ring. let $m$ be a finite $r$-module. let $d \geq 0$. the equivalent conditions (1) -- (4) of lemma \ref{lemma-what-kind-of-resolutions}, condition (5) of lemma \ref{lemma-what-kind-of-resolutions-local}, and condition (6) of lemma \ref{lemma-what-kind-of-resolutions-noetherian} are also equivalent to \begin{enumerate} \item[(7)] there exists a resolution $0 \to f_d \to f_{d - 1} \to \ldots \to f_0 \to m \to 0$ with $f_i$ finite free. \end{enumerate} \end{lemma} \begin{proof} this follows from lemmas \ref{lemma-what-kind-of-resolutions}, \ref{lemma-what-kind-of-resolutions-local}, and \ref{lemma-what-kind-of-resolutions-noetherian} and because a finite projective module over a local ring is finite free, see lemma \ref{lemma-finite-projective}. \end{proof} \begin{lemma} \label{lemma-projective-dimension-ext} let $r$ be a ring. let $m$ be an $r$-module. let $n \geq 0$. the following are equivalent \begin{enumerate} \item $m$ has projective dimension $\leq n$, \item $\ext^i_r(m, n) = 0$ for all $r$-modules $n$ and all $i \geq n + 1$, and \item $\ext^{n + 1}_r(m, n) = 0$ for all $r$-modules $n$. \end{enumerate} \end{lemma} \begin{proof} assume (1). choose a free resolution $f_\bullet \to m$ of $m$. denote $d_e : f_e \to f_{e - 1}$. by lemma \ref{lemma-independent-resolution} we see that $p_e = \ker(d_e)$ is projective for $e \geq n - 1$. this implies that $f_e \cong p_e \oplus p_{e - 1}$ for $e \geq n$ where $d_e$ maps the summand $p_{e - 1}$ isomorphically to $p_{e - 1}$ in $f_{e - 1}$. hence, for any $r$-module $n$ the complex $\hom_r(f_\bullet, n)$ is split exact in degrees $\geq n + 1$. whence (2) holds. the implication (2) $\rightarrow$ (3) is trivial. \medskip\noindent assume (3) holds. if $n = 0$ then $m$ is projective by lemma \ref{lemma-characterize-projective} and we see that (1) holds. if $n > 0$ choose a free $r$-module $f$ and a surjection $f \to m$ with kernel $k$. by lemma \ref{lemma-reverse-long-exact-seq-ext} and the vanishing of $\ext_r^i(f, n)$ for all $i > 0$ by part (1) we see that $\ext_r^n(k, n) = 0$ for all $r$-modules $n$. hence by induction we see that $k$ has projective dimension $\leq n - 1$. then $m$ has projective dimension $\leq n$ as any finite projective resolution of $k$ gives a projective resolution of length one more for $m$ by adding $f$ to the front. \end{proof} \begin{lemma} \label{lemma-exact-sequence-projective-dimension} let $r$ be a ring. let $0 \to m' \to m \to m'' \to 0$ be a short exact sequence of $r$-modules. \begin{enumerate} \item if $m$ has projective dimension $\leq n$ and $m''$ has projective dimension $\leq n + 1$, then $m'$ has projective dimension $\leq n$. \item if $m'$ and $m''$ have projective dimension $\leq n$ then $m$ has projective dimension $\leq n$. \item if $m'$ has projective dimension $\leq n$ and $m$ has projective dimension $\leq n + 1$ then $m''$ has projective dimension $\leq n + 1$. \end{enumerate} \end{lemma} \begin{proof} combine the characterization of projective dimension in lemma \ref{lemma-projective-dimension-ext} with the long exact sequence of ext groups in lemma \ref{lemma-reverse-long-exact-seq-ext}. \end{proof} \begin{definition} \label{definition-finite-gl-dim} let $r$ be a ring. the ring $r$ is said to have {\it finite global dimension} if there exists an integer $n$ such that every $r$-module has a resolution by projective $r$-modules of length at most $n$. the minimal such $n$ is then called the {\it global dimension} of $r$. \end{definition} \noindent the argument in the proof of the following lemma can be found in the paper \cite{auslander} by auslander. \begin{lemma} \label{lemma-colimit-projective-dimension} let $r$ be a ring. suppose we have a module $m = \bigcup_{e \in e} m_e$ where the $m_e$ are submodules well-ordered by inclusion. assume the quotients $m_e/\bigcup\nolimits_{e' < e} m_{e'}$ have projective dimension $\leq n$. then $m$ has projective dimension $\leq n$. \end{lemma} \begin{proof} we will prove this by induction on $n$. \medskip\noindent base case: $n = 0$. then $p_e = m_e/\bigcup_{e' < e} m_{e'}$ is projective. thus we may choose a section $p_e \to m_e$ of the projection $m_e \to p_e$. we claim that the induced map $\psi : \bigoplus_{e \in e} p_e \to m$ is an isomorphism. namely, if $x = \sum x_e \in \bigoplus p_e$ is nonzero, then we let $e_{max}$ be maximal such that $x_{e_{max}}$ is nonzero and we conclude that $y = \psi(x) = \psi(\sum x_e)$ is nonzero because $y \in m_{e_{max}}$ has nonzero image $x_{e_{max}}$ in $p_{e_{max}}$. on the other hand, let $y \in m$. then $y \in m_e$ for some $e$. we show that $y \in \im(\psi)$ by transfinite induction on $e$. let $x_e \in p_e$ be the image of $y$. then $y - \psi(x_e) \in \bigcup_{e' < e} m_{e'}$. by induction hypothesis we conclude that $y - \psi(x_e) \in \im(\psi)$ hence $y \in \im(\psi)$. thus the claim is true and $\psi$ is an isomorphism. we conclude that $m$ is projective as a direct sum of projectives, see lemma \ref{lemma-direct-sum-projective}. \medskip\noindent if $n > 0$, then for $e \in e$ we denote $f_e$ the free $r$-module on the set of elements of $m_e$. then we have a system of short exact sequences $$ 0 \to k_e \to f_e \to m_e \to 0 $$ over the well-ordered set $e$. note that the transition maps $f_{e'} \to f_e$ and $k_{e'} \to k_e$ are injective too. set $f = \bigcup f_e$ and $k = \bigcup k_e$. then $$ 0 \to k_e/\bigcup\nolimits_{e' < e} k_{e'} \to f_e/\bigcup\nolimits_{e' < e} f_{e'} \to m_e/\bigcup\nolimits_{e' < e} m_{e'} \to 0 $$ is a short exact sequence of $r$-modules too and $f_e/\bigcup_{e' < e} f_{e'}$ is the free $r$-module on the set of elements in $m_e$ which are not contained in $\bigcup_{e' < e} m_{e'}$. hence by lemma \ref{lemma-exact-sequence-projective-dimension} we see that the projective dimension of $k_e/\bigcup_{e' < e} k_{e'}$ is at most $n - 1$. by induction we conclude that $k$ has projective dimension at most $n - 1$. whence $m$ has projective dimension at most $n$ and we win. \end{proof} \begin{lemma} \label{lemma-finite-gl-dim} let $r$ be a ring. the following are equivalent \begin{enumerate} \item $r$ has finite global dimension $\leq n$, \item every finite $r$-module has projective dimension $\leq n$, and \item every cyclic $r$-module $r/i$ has projective dimension $\leq n$. \end{enumerate} \end{lemma} \begin{proof} it is clear that (1) $\rightarrow$ (2) and (2) $\rightarrow$ (3). assume (3). choose a set $e \subset m$ of generators of $m$. choose a well ordering on $e$. for $e \in e$ denote $m_e$ the submodule of $m$ generated by the elements $e' \in e$ with $e' \leq e$. then $m = \bigcup_{e \in e} m_e$. note that for each $e \in e$ the quotient $$ m_e/\bigcup\nolimits_{e' < e} m_{e'} $$ is either zero or generated by one element, hence has projective dimension $\leq n$ by (3). by lemma \ref{lemma-colimit-projective-dimension} this means that $m$ has projective dimension $\leq n$. \end{proof} \begin{lemma} \label{lemma-localize-finite-gl-dim} let $r$ be a ring. let $m$ be an $r$-module. let $s \subset r$ be a multiplicative subset. \begin{enumerate} \item if $m$ has projective dimension $\leq n$, then $s^{-1}m$ has projective dimension $\leq n$ over $s^{-1}r$. \item if $r$ has finite global dimension $\leq n$, then $s^{-1}r$ has finite global dimension $\leq n$. \end{enumerate} \end{lemma} \begin{proof} let $0 \to p_n \to p_{n - 1} \to \ldots \to p_0 \to m \to 0$ be a projective resolution. as localization is exact, see proposition \ref{proposition-localization-exact}, and as each $s^{-1}p_i$ is a projective $s^{-1}r$-module, see lemma \ref{lemma-ascend-properties-modules}, we see that $0 \to s^{-1}p_n \to \ldots \to s^{-1}p_0 \to s^{-1}m \to 0$ is a projective resolution of $s^{-1}m$. this proves (1). let $m'$ be an $s^{-1}r$-module. note that $m' = s^{-1}m'$. hence we see that (2) follows from (1). \end{proof} \section{regular rings and global dimension} \label{section-regular-finite-gl-dim} \noindent we can use the material on rings of finite global dimension to give another characterization of regular local rings. \begin{proposition} \label{proposition-regular-finite-gl-dim} let $r$ be a regular local ring of dimension $d$. every finite $r$-module $m$ of depth $e$ has a finite free resolution $$ 0 \to f_{d-e} \to \ldots \to f_0 \to m \to 0. $$ in particular a regular local ring has global dimension $\leq d$. \end{proposition} \begin{proof} the first part holds in view of lemma \ref{lemma-regular-mcm-free} and lemma \ref{lemma-mcm-resolution}. the last part follows from this and lemma \ref{lemma-finite-gl-dim}. \end{proof} \begin{lemma} \label{lemma-finite-gl-dim-primes} let $r$ be a noetherian ring. then $r$ has finite global dimension if and only if there exists an integer $n$ such that for all maximal ideals $\mathfrak m$ of $r$ the ring $r_{\mathfrak m}$ has global dimension $\leq n$. \end{lemma} \begin{proof} we saw, lemma \ref{lemma-localize-finite-gl-dim} that if $r$ has finite global dimension $n$, then all the localizations $r_{\mathfrak m}$ have finite global dimension at most $n$. conversely, suppose that all the $r_{\mathfrak m}$ have global dimension $\leq n$. let $m$ be a finite $r$-module. let $0 \to k_n \to f_{n-1} \to \ldots \to f_0 \to m \to 0$ be a resolution with $f_i$ finite free. then $k_n$ is a finite $r$-module. according to lemma \ref{lemma-independent-resolution} and the assumption all the modules $k_n \otimes_r r_{\mathfrak m}$ are projective. hence by lemma \ref{lemma-finite-projective} the module $k_n$ is finite projective. \end{proof} \begin{lemma} \label{lemma-length-resolution-residue-field} suppose that $r$ is a noetherian local ring with maximal ideal $\mathfrak m$ and residue field $\kappa$. in this case the projective dimension of $\kappa$ is $\geq \dim_\kappa \mathfrak m / \mathfrak m^2$. \end{lemma} \begin{proof} let $x_1 , \ldots, x_n$ be elements of $\mathfrak m$ whose images in $\mathfrak m / \mathfrak m^2$ form a basis. consider the {\it koszul complex} on $x_1, \ldots, x_n$. this is the complex $$ 0 \to \wedge^n r^n \to \wedge^{n-1} r^n \to \wedge^{n-2} r^n \to \ldots \to \wedge^i r^n \to \ldots \to r^n \to r $$ with maps given by $$ e_{j_1} \wedge \ldots \wedge e_{j_i} \longmapsto \sum_{a = 1}^i (-1)^{a + 1} x_{j_a} e_{j_1} \wedge \ldots \wedge \hat e_{j_a} \wedge \ldots \wedge e_{j_i} $$ it is easy to see that this is a complex $k_{\bullet}(r, x_{\bullet})$. note that the cokernel of the last map of $k_{\bullet}(r, x_{\bullet})$ is $\kappa$ by lemma \ref{lemma-nak} part (8). \medskip\noindent if $\kappa$ has finite projective dimension $d$, then we can find a resolution $f_{\bullet} \to \kappa$ by finite free $r$-modules of length $d$ (lemma \ref{lemma-what-kind-of-resolutions-noetherian-local}). by lemma \ref{lemma-add-trivial-complex} we may assume all the maps in the complex $f_{\bullet}$ have the property that $\im(f_i \to f_{i-1}) \subset \mathfrak m f_{i-1}$, because removing a trivial summand from the resolution can at worst shorten the resolution. by lemma \ref{lemma-compare-resolutions} we can find a map of complexes $\alpha : k_{\bullet}(r, x_{\bullet}) \to f_{\bullet}$ inducing the identity on $\kappa$. we will prove by induction that the maps $\alpha_i : \wedge^i r^n = k_i(r, x_{\bullet}) \to f_i$ have the property that $\alpha_i \otimes \kappa : \wedge^i \kappa^n \to f_i \otimes \kappa$ are injective. this shows that $f_n \not = 0$ and hence $d \geq n$ as desired. \medskip\noindent the result is clear for $i = 0$ because the composition $r \xrightarrow{\alpha_0} f_0 \to \kappa$ is nonzero. note that $f_0$ must have rank $1$ since otherwise the map $f_1 \to f_0$ whose cokernel is a single copy of $\kappa$ cannot have image contained in $\mathfrak m f_0$. \medskip\noindent next we check the case $i = 1$ as we feel that it is instructive; the reader can skip this as the induction step will deduce the $i = 1$ case from the case $i = 0$. we saw above that $f_0 = r$ and $f_1 \to f_0 = r$ has image $\mathfrak m$. we have a commutative diagram $$ \begin{matrix} r^n & = & k_1(r, x_{\bullet}) & \to & k_0(r, x_{\bullet}) & = & r \\ & & \downarrow & & \downarrow & & \downarrow \\ & & f_1 & \to & f_0 & = & r \end{matrix} $$ where the rightmost vertical arrow is given by multiplication by a unit. hence we see that the image of the composition $r^n \to f_1 \to f_0 = r$ is also equal to $\mathfrak m$. thus the map $r^n \otimes \kappa \to f_1 \otimes \kappa$ has to be injective since $\dim_\kappa (\mathfrak m / \mathfrak m^2) = n$. \medskip\noindent let $i \geq 1$ and assume injectivity of $\alpha_j \otimes \kappa$ has been proved for all $j \leq i - 1$. consider the commutative diagram $$ \begin{matrix} \wedge^i r^n & = & k_i(r, x_{\bullet}) & \to & k_{i-1}(r, x_{\bullet}) & = & \wedge^{i-1} r^n \\ & & \downarrow & & \downarrow & & \\ & & f_i & \to & f_{i-1} & & \end{matrix} $$ we know that $\wedge^{i-1} \kappa^n \to f_{i-1} \otimes \kappa$ is injective. this proves that $\wedge^{i-1} \kappa^n \otimes_{\kappa} \mathfrak m/\mathfrak m^2 \to f_{i-1} \otimes \mathfrak m/\mathfrak m^2$ is injective. also, by our choice of the complex, $f_i$ maps into $\mathfrak mf_{i-1}$, and similarly for the koszul complex. hence we get a commutative diagram $$ \begin{matrix} \wedge^i \kappa^n & \to & \wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^2 \\ \downarrow & & \downarrow \\ f_i \otimes \kappa & \to & f_{i-1} \otimes \mathfrak m/\mathfrak m^2 \end{matrix} $$ at this point it suffices to verify the map $\wedge^i \kappa^n \to \wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^2$ is injective, which can be done by hand. \end{proof} \begin{lemma} \label{lemma-dim-gl-dim} let $r$ be a noetherian local ring. suppose that the residue field $\kappa$ has finite projective dimension $n$ over $r$. in this case $\dim(r) \geq n$. \end{lemma} \begin{proof} let $f_{\bullet}$ be a finite resolution of $\kappa$ by finite free $r$-modules (lemma \ref{lemma-what-kind-of-resolutions-noetherian-local}). by lemma \ref{lemma-add-trivial-complex} we may assume all the maps in the complex $f_{\bullet}$ have to property that $\im(f_i \to f_{i-1}) \subset \mathfrak m f_{i-1}$, because removing a trivial summand from the resolution can at worst shorten the resolution. say $f_n \not = 0$ and $f_i = 0$ for $i > n$, so that the projective dimension of $\kappa$ is $n$. by proposition \ref{proposition-what-exact} we see that $\text{depth}_{i(\varphi_n)}(r) \geq n$ since $i(\varphi_n)$ cannot equal $r$ by our choice of the complex. thus by lemma \ref{lemma-bound-depth} also $\dim(r) \geq n$. \end{proof} \begin{proposition} \label{proposition-finite-gl-dim-regular} let $(r, \mathfrak m, \kappa)$ be a noetherian local ring. the following are equivalent \begin{enumerate} \item $\kappa$ has finite projective dimension as an $r$-module, \item $r$ has finite global dimension, \item $r$ is a regular local ring. \end{enumerate} moreover, in this case the global dimension of $r$ equals $\dim(r) = \dim_\kappa(\mathfrak m/\mathfrak m^2)$. \end{proposition} \begin{proof} we have (3) $\rightarrow$ (2) by proposition \ref{proposition-regular-finite-gl-dim}. the implication (2) $\rightarrow$ (1) is trivial. assume (1). by lemmas \ref{lemma-length-resolution-residue-field} and \ref{lemma-dim-gl-dim} we see that $\dim(r) \geq \dim_\kappa(\mathfrak m /\mathfrak m^2)$. thus $r$ is regular, see definition \ref{definition-regular-local} and the discussion preceding it. assume the equivalent conditions (1) -- (3) hold. by proposition \ref{proposition-regular-finite-gl-dim} the global dimension of $r$ is at most $\dim(r)$ and by lemma \ref{lemma-length-resolution-residue-field} it is at least $\dim_\kappa(\mathfrak m/\mathfrak m^2)$. thus the stated equality holds. \end{proof} \begin{lemma} \label{lemma-localization-of-regular-local-is-regular} a noetherian local ring $r$ is a regular local ring if and only if it has finite global dimension. in this case $r_{\mathfrak p}$ is a regular local ring for all primes $\mathfrak p$. \end{lemma} \begin{proof} by propositions \ref{proposition-finite-gl-dim-regular} and \ref{proposition-regular-finite-gl-dim} we see that a noetherian local ring is a regular local ring if and only if it has finite global dimension. furthermore, any localization $r_{\mathfrak p}$ has finite global dimension, see lemma \ref{lemma-localize-finite-gl-dim}, and hence is a regular local ring. \end{proof} \noindent by lemma \ref{lemma-localization-of-regular-local-is-regular} it makes sense to make the following definition, because it does not conflict with the earlier definition of a regular local ring. \begin{definition} \label{definition-regular} a noetherian ring $r$ is said to be {\it regular} if all the localizations $r_{\mathfrak p}$ at primes are regular local rings. \end{definition} \noindent it is enough to require the local rings at maximal ideals to be regular. note that this is not the same as asking $r$ to have finite global dimension, even assuming $r$ is noetherian. this is because there is an example of a regular noetherian ring which does not have finite global dimension, namely because it does not have finite dimension. \begin{lemma} \label{lemma-finite-gl-dim-finite-dim-regular} let $r$ be a noetherian ring. the following are equivalent: \begin{enumerate} \item $r$ has finite global dimension $n$, \item $r$ is a regular ring of dimension $n$, \item there exists an integer $n$ such that all the localizations $r_{\mathfrak m}$ at maximal ideals are regular of dimension $\leq n$ with equality for at least one $\mathfrak m$, and \item there exists an integer $n$ such that all the localizations $r_{\mathfrak p}$ at prime ideals are regular of dimension $\leq n$ with equality for at least one $\mathfrak p$. \end{enumerate} \end{lemma} \begin{proof} this follows from the discussion above. more precisely, it follows by combining definition \ref{definition-regular} with lemma \ref{lemma-finite-gl-dim-primes} and proposition \ref{proposition-finite-gl-dim-regular}. \end{proof} \begin{lemma} \label{lemma-flat-under-regular} let $r \to s$ be a local homomorphism of local noetherian rings. assume that $r \to s$ is flat and that $s$ is regular. then $r$ is regular. \end{lemma} \begin{proof} let $\mathfrak m \subset r$ be the maximal ideal and let $\kappa = r/\mathfrak m$ be the residue field. let $d = \dim s$. choose any resolution $f_\bullet \to \kappa$ with each $f_i$ a finite free $r$-module. set $k_d = \ker(f_{d - 1} \to f_{d - 2})$. by flatness of $r \to s$ the complex $0 \to k_d \otimes_r s \to f_{d - 1} \otimes_r s \to \ldots \to f_0 \otimes_r s \to \kappa \otimes_r s \to 0$ is still exact. because the global dimension of $s$ is $d$, see proposition \ref{proposition-regular-finite-gl-dim}, we see that $k_d \otimes_r s$ is a finite free $s$-module (see also lemma \ref{lemma-independent-resolution}). by lemma \ref{lemma-finite-projective-descends} we see that $k_d$ is a finite free $r$-module. hence $\kappa$ has finite projective dimension and $r$ is regular by proposition \ref{proposition-finite-gl-dim-regular}. \end{proof} \section{auslander-buchsbaum} \label{section-auslander-buchsbaum} \noindent the following result can be found in \cite{auslander-buchsbaum}. \begin{proposition} \label{proposition-auslander-buchsbaum} let $r$ be a noetherian local ring. let $m$ be a nonzero finite $r$-module which has finite projective dimension $\text{pd}_r(m)$. then we have $$ \text{depth}(r) = \text{pd}_r(m) + \text{depth}(m) $$ \end{proposition} \begin{proof} we prove this by induction on $\text{depth}(m)$. the most interesting case is the case $\text{depth}(m) = 0$. in this case, let $$ 0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_0} \to m \to 0 $$ be a minimal finite free resolution, so $e = \text{pd}_r(m)$. by lemma \ref{lemma-add-trivial-complex} we may assume all matrix coefficients of the maps in the complex are contained in the maximal ideal of $r$. then on the one hand, by proposition \ref{proposition-what-exact} we see that $\text{depth}(r) \geq e$. on the other hand, breaking the long exact sequence into short exact sequences \begin{align*} 0 \to r^{n_e} \to r^{n_{e - 1}} \to k_{e - 2} \to 0,\\ 0 \to k_{e - 2} \to r^{n_{e - 2}} \to k_{e - 3} \to 0,\\ \ldots,\\ 0 \to k_0 \to r^{n_0} \to m \to 0 \end{align*} we see, using lemma \ref{lemma-depth-in-ses}, that \begin{align*} \text{depth}(k_{e - 2}) \geq \text{depth}(r) - 1,\\ \text{depth}(k_{e - 3}) \geq \text{depth}(r) - 2,\\ \ldots,\\ \text{depth}(k_0) \geq \text{depth}(r) - (e - 1),\\ \text{depth}(m) \geq \text{depth}(r) - e \end{align*} and since $\text{depth}(m) = 0$ we conclude $\text{depth}(r) \leq e$. this finishes the proof of the case $\text{depth}(m) = 0$. \medskip\noindent induction step. if $\text{depth}(m) > 0$, then we pick $x \in \mathfrak m$ which is a nonzerodivisor on both $m$ and $r$. this is possible, because either $\text{pd}_r(m) > 0$ and $\text{depth}(r) > 0$ by the aforementioned proposition \ref{proposition-what-exact} or $\text{pd}_r(m) = 0$ in which case $m$ is finite free hence also $\text{depth}(r) = \text{depth}(m) > 0$. thus $\text{depth}(r \oplus m) > 0$ by lemma \ref{lemma-depth-in-ses} (for example) and we can find an $x \in \mathfrak m$ which is a nonzerodivisor on both $r$ and $m$. let $$ 0 \to r^{n_e} \to r^{n_{e-1}} \to \ldots \to r^{n_0} \to m \to 0 $$ be a minimal resolution as above. an application of the snake lemma shows that $$ 0 \to (r/xr)^{n_e} \to (r/xr)^{n_{e-1}} \to \ldots \to (r/xr)^{n_0} \to m/xm \to 0 $$ is a minimal resolution too. thus $\text{pd}_r(m) = \text{pd}_{r/xr}(m/xm)$. by lemma \ref{lemma-depth-drops-by-one} we have $\text{depth}(r/xr) = \text{depth}(r) - 1$ and $\text{depth}(m/xm) = \text{depth}(m) - 1$. till now depths have all been depths as $r$ modules, but we observe that $\text{depth}_r(m/xm) = \text{depth}_{r/xr}(m/xm)$ and similarly for $r/xr$. by induction hypothesis we see that the auslander-buchsbaum formula holds for $m/xm$ over $r/xr$. since the depths of both $r/xr$ and $m/xm$ have decreased by one and the projective dimension has not changed we conclude. \end{proof} \section{homomorphisms and dimension} \label{section-homomorphism-dimension} \noindent this section contains a collection of easy results relating dimensions of rings when there are maps between them. \begin{lemma} \label{lemma-dimension-going-up} suppose $r \to s$ is a ring map satisfying either going up, see definition \ref{definition-going-up-down}, or going down see definition \ref{definition-going-up-down}. assume in addition that $\spec(s) \to \spec(r)$ is surjective. then $\dim(r) \leq \dim(s)$. \end{lemma} \begin{proof} assume going up. take any chain $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_e$ of prime ideals in $r$. by surjectivity we may choose a prime $\mathfrak q_0$ mapping to $\mathfrak p_0$. by going up we may extend this to a chain of length $e$ of primes $\mathfrak q_i$ lying over $\mathfrak p_i$. thus $\dim(s) \geq \dim(r)$. the case of going down is exactly the same. see also topology, lemma \ref{topology-lemma-dimension-specializations-lift} for a purely topological version. \end{proof} \begin{lemma} \label{lemma-going-up-maximal-on-top} suppose that $r \to s$ is a ring map with the going up property, see definition \ref{definition-going-up-down}. if $\mathfrak q \subset s$ is a maximal ideal. then the inverse image of $\mathfrak q$ in $r$ is a maximal ideal too. \end{lemma} \begin{proof} trivial. \end{proof} \begin{lemma} \label{lemma-integral-dim-up} suppose that $r \to s$ is a ring map such that $s$ is integral over $r$. then $\dim (r) \geq \dim(s)$, and every closed point of $\spec(s)$ maps to a closed point of $\spec(r)$. \end{lemma} \begin{proof} immediate from lemmas \ref{lemma-integral-no-inclusion} and \ref{lemma-going-up-maximal-on-top} and the definitions. \end{proof} \begin{lemma} \label{lemma-integral-sub-dim-equal} suppose $r \subset s$ and $s$ integral over $r$. then $\dim(r) = \dim(s)$. \end{lemma} \begin{proof} this is a combination of lemmas \ref{lemma-integral-going-up}, \ref{lemma-integral-overring-surjective}, \ref{lemma-dimension-going-up}, and \ref{lemma-integral-dim-up}. \end{proof} \begin{definition} \label{definition-fibre} suppose that $r \to s$ is a ring map. let $\mathfrak q \subset s$ be a prime lying over the prime $\mathfrak p$ of $r$. the {\it local ring of the fibre at $\mathfrak q$} is the local ring $$ s_{\mathfrak q}/\mathfrak ps_{\mathfrak q} = (s/\mathfrak ps)_{\mathfrak q} = (s \otimes_r \kappa(\mathfrak p))_{\mathfrak q} $$ \end{definition} \begin{lemma} \label{lemma-dimension-base-fibre-total} let $r \to s$ be a homomorphism of noetherian rings. let $\mathfrak q \subset s$ be a prime lying over the prime $\mathfrak p$. then $$ \dim(s_{\mathfrak q}) \leq \dim(r_{\mathfrak p}) + \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}). $$ \end{lemma} \begin{proof} we use the characterization of dimension of proposition \ref{proposition-dimension}. let $x_1, \ldots, x_d$ be elements of $\mathfrak p$ generating an ideal of definition of $r_{\mathfrak p}$ with $d = \dim(r_{\mathfrak p})$. let $y_1, \ldots, y_e$ be elements of $\mathfrak q$ generating an ideal of definition of $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ with $e = \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q})$. it is clear that $s_{\mathfrak q}/(x_1, \ldots, x_d, y_1, \ldots, y_e)$ has a nilpotent maximal ideal. hence $x_1, \ldots, x_d, y_1, \ldots, y_e$ generate an ideal of definition of $s_{\mathfrak q}$. \end{proof} \begin{lemma} \label{lemma-dimension-base-fibre-equals-total} let $r \to s$ be a homomorphism of noetherian rings. let $\mathfrak q \subset s$ be a prime lying over the prime $\mathfrak p$. assume the going down property holds for $r \to s$ (for example if $r \to s$ is flat, see lemma \ref{lemma-flat-going-down}). then $$ \dim(s_{\mathfrak q}) = \dim(r_{\mathfrak p}) + \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}). $$ \end{lemma} \begin{proof} by lemma \ref{lemma-dimension-base-fibre-total} we have an inequality $\dim(s_{\mathfrak q}) \leq \dim(r_{\mathfrak p}) + \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q})$. to get equality, choose a chain of primes $\mathfrak ps \subset \mathfrak q_0 \subset \mathfrak q_1 \subset \ldots \subset \mathfrak q_d = \mathfrak q$ with $d = \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q})$. on the other hand, choose a chain of primes $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_e = \mathfrak p$ with $e = \dim(r_{\mathfrak p})$. by the going down theorem we may choose $\mathfrak q_{-1} \subset \mathfrak q_0$ lying over $\mathfrak p_{e-1}$. and then we may choose $\mathfrak q_{-2} \subset \mathfrak q_{-1}$ lying over $\mathfrak p_{e-2}$. inductively we keep going until we get a chain $\mathfrak q_{-e} \subset \ldots \subset \mathfrak q_d$ of length $e + d$. \end{proof} \begin{lemma} \label{lemma-flat-over-regular-with-regular-fibre} let $r \to s$ be a local homomorphism of local noetherian rings. assume \begin{enumerate} \item $r$ is regular, \item $s/\mathfrak m_rs$ is regular, and \item $r \to s$ is flat. \end{enumerate} then $s$ is regular. \end{lemma} \begin{proof} by lemma \ref{lemma-dimension-base-fibre-equals-total} we have $\dim(s) = \dim(r) + \dim(s/\mathfrak m_rs)$. pick generators $x_1, \ldots, x_d \in \mathfrak m_r$ with $d = \dim(r)$, and pick $y_1, \ldots, y_e \in \mathfrak m_s$ which generate the maximal ideal of $s/\mathfrak m_rs$ with $e = \dim(s/\mathfrak m_rs)$. then we see that $x_1, \ldots, x_d, y_1, \ldots, y_e$ are elements which generate the maximal ideal of $s$ and $e + d = \dim(s)$. \end{proof} \noindent the lemma below will later be used to show that rings of finite type over a field are cohen-macaulay if and only if they are quasi-finite flat over a polynomial ring. it is a partial converse to lemma \ref{lemma-cm-over-regular-flat}. \begin{lemma} \label{lemma-finite-flat-over-regular-cm} let $r \to s$ be a local homomorphism of noetherian local rings. assume $r$ cohen-macaulay. if $s$ is finite flat over $r$, or if $s$ is flat over $r$ and $\dim(s) \leq \dim(r)$, then $s$ is cohen-macaulay and $\dim(r) = \dim(s)$. \end{lemma} \begin{proof} let $x_1, \ldots, x_d \in \mathfrak m_r$ be a regular sequence of length $d = \dim(r)$. by lemma \ref{lemma-flat-increases-depth} this maps to a regular sequence in $s$. hence $s$ is cohen-macaulay if $\dim(s) \leq d$. this is true if $s$ is finite flat over $r$ by lemma \ref{lemma-integral-sub-dim-equal}. and in the second case we assumed it. \end{proof} \section{the dimension formula} \label{section-dimension-formula} \noindent recall the definitions of catenary (definition \ref{definition-catenary}) and universally catenary (definition \ref{definition-universally-catenary}). \begin{lemma} \label{lemma-dimension-formula} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime of $s$ lying over the prime $\mathfrak p$ of $r$. assume that \begin{enumerate} \item $r$ is noetherian, \item $r \to s$ is of finite type, \item $r$, $s$ are domains, and \item $r \subset s$. \end{enumerate} then we have $$ \text{height}(\mathfrak q) \leq \text{height}(\mathfrak p) + \text{trdeg}_r(s) - \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) $$ with equality if $r$ is universally catenary. \end{lemma} \begin{proof} suppose that $r \subset s' \subset s$, where $s'$ is a finitely generated $r$-subalgebra of $s$. in this case set $\mathfrak q' = s' \cap \mathfrak q$. the lemma for the ring maps $r \to s'$ and $s' \to s$ implies the lemma for $r \to s$ by additivity of transcendence degree in towers of fields (fields, lemma \ref{fields-lemma-transcendence-degree-tower}). hence we can use induction on the number of generators of $s$ over $r$ and reduce to the case where $s$ is generated by one element over $r$. \medskip\noindent case i: $s = r[x]$ is a polynomial algebra over $r$. in this case we have $\text{trdeg}_r(s) = 1$. also $r \to s$ is flat and hence $$ \dim(s_{\mathfrak q}) = \dim(r_{\mathfrak p}) + \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) $$ see lemma \ref{lemma-dimension-base-fibre-equals-total}. let $\mathfrak r = \mathfrak ps$. then $\text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) = 1$ is equivalent to $\mathfrak q = \mathfrak r$, and implies that $\dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) = 0$. in the same vein $\text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$ is equivalent to having a strict inclusion $\mathfrak r \subset \mathfrak q$, which implies that $\dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) = 1$. thus we are done with case i with equality in every instance. \medskip\noindent case ii: $s = r[x]/\mathfrak n$ with $\mathfrak n \not = 0$. in this case we have $\text{trdeg}_r(s) = 0$. denote $\mathfrak q' \subset r[x]$ the prime corresponding to $\mathfrak q$. thus we have $$ s_{\mathfrak q} = (r[x])_{\mathfrak q'}/\mathfrak n(r[x])_{\mathfrak q'} $$ by the previous case we have $\dim((r[x])_{\mathfrak q'}) = \dim(r_{\mathfrak p}) + 1 - \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q)$. since $\mathfrak n \not = 0$ we see that the dimension of $s_{\mathfrak q}$ decreases by at least one, see lemma \ref{lemma-one-equation}, which proves the inequality of the lemma. to see the equality in case $r$ is universally catenary note that $\mathfrak n \subset r[x]$ is a height one prime as it corresponds to a nonzero prime in $f[x]$ where $f$ is the fraction field of $r$. hence any maximal chain of primes in $s_\mathfrak q = r[x]_{\mathfrak q'}/\mathfrak nr[x]_{\mathfrak q'}$ corresponds to a maximal chain of primes with length 1 greater between $\mathfrak q'$ and $(0)$ in $r[x]$. if $r$ is universally catenary these all have the same length equal to the height of $\mathfrak q'$. this proves that $\dim(s_\mathfrak q) = \dim(r[x]_{\mathfrak q'}) - 1$ and this implies equality holds as desired. \end{proof} \noindent the following lemma says that generically finite maps tend to be quasi-finite in codimension $1$. \begin{lemma} \label{lemma-finite-in-codim-1} let $a \to b$ be a ring map. assume \begin{enumerate} \item $a \subset b$ is an extension of domains, \item the induced extension of fraction fields is finite, \item $a$ is noetherian, and \item $a \to b$ is of finite type. \end{enumerate} let $\mathfrak p \subset a$ be a prime of height $1$. then there are at most finitely many primes of $b$ lying over $\mathfrak p$ and they all have height $1$. \end{lemma} \begin{proof} by the dimension formula (lemma \ref{lemma-dimension-formula}) for any prime $\mathfrak q$ lying over $\mathfrak p$ we have $$ \dim(b_{\mathfrak q}) \leq \dim(a_{\mathfrak p}) - \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q). $$ as the domain $b_\mathfrak q$ has at least $2$ prime ideals we see that $\dim(b_{\mathfrak q}) \geq 1$. we conclude that $\dim(b_{\mathfrak q}) = 1$ and that the extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is algebraic. hence $\mathfrak q$ defines a closed point of its fibre $\spec(b \otimes_a \kappa(\mathfrak p))$, see lemma \ref{lemma-finite-residue-extension-closed}. since $b \otimes_a \kappa(\mathfrak p)$ is a noetherian ring the fibre $\spec(b \otimes_a \kappa(\mathfrak p))$ is a noetherian topological space, see lemma \ref{lemma-noetherian-topology}. a noetherian topological space consisting of closed points is finite, see for example topology, lemma \ref{topology-lemma-noetherian}. \end{proof} \section{dimension of finite type algebras over fields} \label{section-dimension-finite-type-algebras} \noindent in this section we compute the dimension of a polynomial ring over a field. we also prove that the dimension of a finite type domain over a field is the dimension of its local rings at maximal ideals. we will establish the connection with the transcendence degree over the ground field in section \ref{section-dimension-finite-type-algebras-reprise}. \begin{lemma} \label{lemma-dim-affine-space} let $\mathfrak m$ be a maximal ideal in $k[x_1, \ldots, x_n]$. the ideal $\mathfrak m$ is generated by $n$ elements. the dimension of $k[x_1, \ldots, x_n]_{\mathfrak m}$ is $n$. hence $k[x_1, \ldots, x_n]_{\mathfrak m}$ is a regular local ring of dimension $n$. \end{lemma} \begin{proof} by the hilbert nullstellensatz (theorem \ref{theorem-nullstellensatz}) we know the residue field $\kappa = \kappa(\mathfrak m)$ is a finite extension of $k$. denote $\alpha_i \in \kappa$ the image of $x_i$. denote $\kappa_i = k(\alpha_1, \ldots, \alpha_i) \subset \kappa$, $i = 1, \ldots, n$ and $\kappa_0 = k$. note that $\kappa_i = k[\alpha_1, \ldots, \alpha_i]$ by field theory. define inductively elements $f_i \in \mathfrak m \cap k[x_1, \ldots, x_i]$ as follows: let $p_i(t) \in \kappa_{i-1}[t]$ be the monic minimal polynomial of $\alpha_i $ over $\kappa_{i-1}$. let $q_i(t) \in k[x_1, \ldots, x_{i-1}][t]$ be a monic lift of $p_i(t)$ (of the same degree). set $f_i = q_i(x_i)$. note that if $d_i = \deg_t(p_i) = \deg_t(q_i) = \deg_{x_i}(f_i)$ then $d_1d_2\ldots d_i = [\kappa_i : k]$ by fields, lemmas \ref{fields-lemma-multiplicativity-degrees} and \ref{fields-lemma-degree-minimal-polynomial}. \medskip\noindent we claim that for all $i = 0, 1, \ldots, n$ there is an isomorphism $$ \psi_i : k[x_1, \ldots, x_i] /(f_1, \ldots, f_i) \cong \kappa_i. $$ by construction the composition $k[x_1, \ldots, x_i] \to k[x_1, \ldots, x_n] \to \kappa$ is surjective onto $\kappa_i$ and $f_1, \ldots, f_i$ are in the kernel. this gives a surjective homomorphism. we prove $\psi_i$ is injective by induction. it is clear for $i = 0$. given the statement for $i$ we prove it for $i + 1$. the ring extension $k[x_1, \ldots, x_i]/(f_1, \ldots, f_i) \to k[x_1, \ldots, x_{i + 1}]/(f_1, \ldots, f_{i + 1})$ is generated by $1$ element over a field and one irreducible equation. by elementary field theory $k[x_1, \ldots, x_{i + 1}]/(f_1, \ldots, f_{i + 1})$ is a field, and hence $\psi_i$ is injective. \medskip\noindent this implies that $\mathfrak m = (f_1, \ldots, f_n)$. moreover, we also conclude that $$ k[x_1, \ldots, x_n]/(f_1, \ldots, f_i) \cong \kappa_i[x_{i + 1}, \ldots, x_n]. $$ hence $(f_1, \ldots, f_i)$ is a prime ideal. thus $$ (0) \subset (f_1) \subset (f_1, f_2) \subset \ldots \subset (f_1, \ldots, f_n) = \mathfrak m $$ is a chain of primes of length $n$. the lemma follows. \end{proof} \begin{proposition} \label{proposition-finite-gl-dim-polynomial-ring} a polynomial algebra in $n$ variables over a field is a regular ring. it has global dimension $n$. all localizations at maximal ideals are regular local rings of dimension $n$. \end{proposition} \begin{proof} by lemma \ref{lemma-dim-affine-space} all localizations $k[x_1, \ldots, x_n]_{\mathfrak m}$ at maximal ideals are regular local rings of dimension $n$. hence we conclude by lemma \ref{lemma-finite-gl-dim-finite-dim-regular}. \end{proof} \begin{lemma} \label{lemma-dimension-height-polynomial-ring} let $k$ be a field. let $\mathfrak p \subset \mathfrak q \subset k[x_1, \ldots, x_n]$ be a pair of primes. any maximal chain of primes between $\mathfrak p$ and $\mathfrak q$ has length $\text{height}(\mathfrak q) - \text{height}(\mathfrak p)$. \end{lemma} \begin{proof} by proposition \ref{proposition-finite-gl-dim-polynomial-ring} any local ring of $k[x_1, \ldots, x_n]$ is regular. hence all local rings are cohen-macaulay, see lemma \ref{lemma-regular-ring-cm}. the local rings at maximal ideals have dimension $n$ hence every maximal chain of primes in $k[x_1, \ldots, x_n]$ has length $n$, see lemma \ref{lemma-maximal-chain-cm}. hence every maximal chain of primes between $(0)$ and $\mathfrak p$ has length $\text{height}(\mathfrak p)$, see lemma \ref{lemma-cm-dim-formula} for example. putting these together leads to the assertion of the lemma. \end{proof} \begin{lemma} \label{lemma-dimension-spell-it-out} let $k$ be a field. let $s$ be a finite type $k$-algebra which is an integral domain. then $\dim(s) = \dim(s_{\mathfrak m})$ for any maximal ideal $\mathfrak m$ of $s$. in words: every maximal chain of primes has length equal to the dimension of $s$. \end{lemma} \begin{proof} write $s = k[x_1, \ldots, x_n]/\mathfrak p$. by proposition \ref{proposition-finite-gl-dim-polynomial-ring} and lemma \ref{lemma-dimension-height-polynomial-ring} all the maximal chains of primes in $s$ (which necessarily end with a maximal ideal) have length $n - \text{height}(\mathfrak p)$. thus this number is the dimension of $s$ and of $s_{\mathfrak m}$ for any maximal ideal $\mathfrak m$ of $s$. \end{proof} \noindent recall that we defined the dimension $\dim_x(x)$ of a topological space $x$ at a point $x$ in topology, definition \ref{topology-definition-krull}. \begin{lemma} \label{lemma-dimension-at-a-point-finite-type-over-field} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $x = \spec(s)$. let $\mathfrak p \subset s$ be a prime ideal and let $x \in x$ be the corresponding point. the following numbers are equal \begin{enumerate} \item $\dim_x(x)$, \item $\max \dim(z)$ where the maximum is over those irreducible components $z$ of $x$ passing through $x$, and \item $\min \dim(s_{\mathfrak m})$ where the minimum is over maximal ideals $\mathfrak m$ with $\mathfrak p \subset \mathfrak m$. \end{enumerate} \end{lemma} \begin{proof} let $x = \bigcup_{i \in i} z_i$ be the decomposition of $x$ into its irreducible components. there are finitely many of them (see lemmas \ref{lemma-obvious-noetherian} and \ref{lemma-noetherian-topology}). let $i' = \{i \mid x \in z_i\}$, and let $t = \bigcup_{i \not \in i'} z_i$. then $u = x \setminus t$ is an open subset of $x$ containing the point $x$. the number (2) is $\max_{i \in i'} \dim(z_i)$. for any open $w \subset u$ with $x \in w$ the irreducible components of $w$ are the irreducible sets $w_i = z_i \cap w$ for $i \in i'$ and $x$ is contained in each of these. note that each $w_i$, $i \in i'$ contains a closed point because $x$ is jacobson, see section \ref{section-ring-jacobson}. since $w_i \subset z_i$ we have $\dim(w_i) \leq \dim(z_i)$. the existence of a closed point implies, via lemma \ref{lemma-dimension-spell-it-out}, that there is a chain of irreducible closed subsets of length equal to $\dim(z_i)$ in the open $w_i$. thus $\dim(w_i) = \dim(z_i)$ for any $i \in i'$. hence $\dim(w)$ is equal to the number (2). this proves that (1) $ = $ (2). \medskip\noindent let $\mathfrak m \supset \mathfrak p$ be any maximal ideal containing $\mathfrak p$. let $x_0 \in x$ be the corresponding point. first of all, $x_0$ is contained in all the irreducible components $z_i$, $i \in i'$. let $\mathfrak q_i$ denote the minimal primes of $s$ corresponding to the irreducible components $z_i$. for each $i$ such that $x_0 \in z_i$ (which is equivalent to $\mathfrak m \supset \mathfrak q_i$) we have a surjection $$ s_{\mathfrak m} \longrightarrow s_\mathfrak m/\mathfrak q_i s_\mathfrak m =(s/\mathfrak q_i)_{\mathfrak m} $$ moreover, the primes $\mathfrak q_i s_\mathfrak m$ so obtained exhaust the minimal primes of the noetherian local ring $s_{\mathfrak m}$, see lemma \ref{lemma-irreducible-components-containing-x}. we conclude, using lemma \ref{lemma-dimension-spell-it-out}, that the dimension of $s_{\mathfrak m}$ is the maximum of the dimensions of the $z_i$ passing through $x_0$. to finish the proof of the lemma it suffices to show that we can choose $x_0$ such that $x_0 \in z_i \rightarrow i \in i'$. because $s$ is jacobson (as we saw above) it is enough to show that $v(\mathfrak p) \setminus t$ (with $t$ as above) is nonempty. and this is clear since it contains the point $x$ (i.e. $\mathfrak p$). \end{proof} \begin{lemma} \label{lemma-dimension-closed-point-finite-type-field} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $x = \spec(s)$. let $\mathfrak m \subset s$ be a maximal ideal and let $x \in x$ be the associated closed point. then $\dim_x(x) = \dim(s_{\mathfrak m})$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-dimension-at-a-point-finite-type-over-field}. \end{proof} \begin{lemma} \label{lemma-disjoint-decomposition-cm-algebra} let $k$ be a field. let $s$ be a finite type $k$ algebra. assume that $s$ is cohen-macaulay. then $\spec(s) = \coprod t_d$ is a finite disjoint union of open and closed subsets $t_d$ with $t_d$ equidimensional (see topology, definition \ref{topology-definition-equidimensional}) of dimension $d$. equivalently, $s$ is a product of rings $s_d$, $d = 0, \ldots, \dim(s)$ such that every maximal ideal $\mathfrak m$ of $s_d$ has height $d$. \end{lemma} \begin{proof} the equivalence of the two statements follows from lemma \ref{lemma-disjoint-implies-product}. let $\mathfrak m \subset s$ be a maximal ideal. every maximal chain of primes in $s_{\mathfrak m}$ has the same length equal to $\dim(s_{\mathfrak m})$, see lemma \ref{lemma-maximal-chain-cm}. hence, the dimension of the irreducible components passing through the point corresponding to $\mathfrak m$ all have dimension equal to $\dim(s_{\mathfrak m})$, see lemma \ref{lemma-dimension-spell-it-out}. since $\spec(s)$ is a jacobson topological space the intersection of any two irreducible components of it contains a closed point if nonempty, see lemmas \ref{lemma-finite-type-field-jacobson} and \ref{lemma-jacobson}. thus we have shown that any two irreducible components that meet have the same dimension. the lemma follows easily from this, and the fact that $\spec(s)$ has a finite number of irreducible components (see lemmas \ref{lemma-obvious-noetherian} and \ref{lemma-noetherian-topology}). \end{proof} \section{noether normalization} \label{section-noether-normalization} \noindent in this section we prove variants of the noether normalization lemma. the key ingredient we will use is contained in the following two lemmas. \begin{lemma} \label{lemma-helper} let $n \in \mathbf{n}$. let $n$ be a finite nonempty set of multi-indices $\nu = (\nu_1, \ldots, \nu_n)$. given $e = (e_1, \ldots, e_n)$ we set $e \cdot \nu = \sum e_i\nu_i$. then for $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n$ we have: if $\nu, \nu' \in n$ then $$ (e \cdot \nu = e \cdot \nu') \leftrightarrow (\nu = \nu') $$ \end{lemma} \begin{proof} say $n = \{\nu_j\}$ with $\nu_j = (\nu_{j1}, \ldots, \nu_{jn})$. let $a_i = \max_j \nu_{ji} - \min_j \nu_{ji}$. if for each $i$ we have $e_{i - 1} > a_ie_i + a_{i + 1}e_{i + 1} + \ldots + a_ne_n$ then the lemma holds. for suppose that $e \cdot (\nu - \nu') = 0$. then for $n \ge 2$, $$ e_1(\nu_1 - \nu'_1) = \sum\nolimits_{i = 2}^n e_i(\nu'_i - \nu_i). $$ we may assume that $(\nu_1 - \nu'_1) \ge 0$. if $(\nu_1 - \nu'_1) > 0$, then $$ e_1(\nu_1 - \nu'_1) \ge e_1 > a_2e_2 + \ldots + a_ne_n \ge \sum\nolimits_{i = 2}^n e_i|\nu'_i - \nu_i| \ge \sum\nolimits_{i = 2}^n e_i(\nu'_i - \nu_i). $$ this contradiction implies that $\nu'_1 = \nu_1$. by induction, $\nu'_i = \nu_i$ for $2 \le i \le n$. \end{proof} \begin{lemma} \label{lemma-helper-polynomial} let $r$ be a ring. let $g \in r[x_1, \ldots, x_n]$ be an element which is nonconstant, i.e., $g \not \in r$. for $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n = 1$ the polynomial $$ g(x_1 + x_n^{e_1}, x_2 + x_n^{e_2}, \ldots, x_{n - 1} + x_n^{e_{n - 1}}, x_n) = ax_n^d + \text{lower order terms in }x_n $$ where $d > 0$ and $a \in r$ is one of the nonzero coefficients of $g$. \end{lemma} \begin{proof} write $g = \sum_{\nu \in n} a_\nu x^\nu$ with $a_\nu \in r$ not zero. here $n$ is a finite set of multi-indices as in lemma \ref{lemma-helper} and $x^\nu = x_1^{\nu_1} \ldots x_n^{\nu_n}$. note that the leading term in $$ (x_1 + x_n^{e_1})^{\nu_1} \ldots (x_{n-1} + x_n^{e_{n-1}})^{\nu_{n-1}} x_n^{\nu_n} \quad\text{is}\quad x_n^{e_1\nu_1 + \ldots + e_{n-1}\nu_{n-1} + \nu_n}. $$ hence the lemma follows from lemma \ref{lemma-helper} which guarantees that there is exactly one nonzero term $a_\nu x^\nu$ of $g$ which gives rise to the leading term of $g(x_1 + x_n^{e_1}, x_2 + x_n^{e_2}, \ldots, x_{n - 1} + x_n^{e_{n - 1}}, x_n)$, i.e., $a = a_\nu$ for the unique $\nu \in n$ such that $e \cdot \nu$ is maximal. \end{proof} \begin{lemma} \label{lemma-one-relation} let $k$ be a field. let $s = k[x_1, \ldots, x_n]/i$ for some proper ideal $i$. if $i \not = 0$, then there exist $y_1, \ldots, y_{n-1} \in k[x_1, \ldots, x_n]$ such that $s$ is finite over $k[y_1, \ldots, y_{n-1}]$. moreover we may choose $y_i$ to be in the $\mathbf{z}$-subalgebra of $k[x_1, \ldots, x_n]$ generated by $x_1, \ldots, x_n$. \end{lemma} \begin{proof} pick $f \in i$, $f\not = 0$. it suffices to show the lemma for $k[x_1, \ldots, x_n]/(f)$ since $s$ is a quotient of that ring. we will take $y_i = x_i - x_n^{e_i}$, $i = 1, \ldots, n-1$ for suitable integers $e_i$. when does this work? it suffices to show that $\overline{x_n} \in k[x_1, \ldots, x_n]/(f)$ is integral over the ring $k[y_1, \ldots, y_{n-1}]$. the equation for $\overline{x_n}$ over this ring is $$ f(y_1 + x_n^{e_1}, \ldots, y_{n-1} + x_n^{e_{n-1}}, x_n) = 0. $$ hence we are done if we can show there exists integers $e_i$ such that the leading coefficient with respect to $x_n$ of the equation above is a nonzero element of $k$. this can be achieved for example by choosing $e_1 \gg e_2 \gg \ldots \gg e_{n-1}$, see lemma \ref{lemma-helper-polynomial}. \end{proof} \begin{lemma} \label{lemma-noether-normalization} \begin{slogan} noether normalization \end{slogan} let $k$ be a field. let $s = k[x_1, \ldots, x_n]/i$ for some ideal $i$. if $i \neq (1)$, there exist $r\geq 0$, and $y_1, \ldots, y_r \in k[x_1, \ldots, x_n]$ such that (a) the map $k[y_1, \ldots, y_r] \to s$ is injective where the source is the polynomial ring on $y_1, \ldots, y_r$, and (b) the map $k[y_1, \ldots, y_r] \to s$ is finite. in this case the integer $r$ is the dimension of $s$. moreover we may choose $y_i$ to be in the $\mathbf{z}$-subalgebra of $k[x_1, \ldots, x_n]$ generated by $x_1, \ldots, x_n$. \end{lemma} \begin{proof} by induction on $n$, with $n = 0$ being trivial. if $i = 0$, then take $r = n$ and $y_i = x_i$. if $i \not = 0$, then choose $y_1, \ldots, y_{n-1}$ as in lemma \ref{lemma-one-relation}. let $s' \subset s$ be the subring generated by the images of the $y_i$. by induction we can choose $r$ and $z_1, \ldots, z_r \in k[y_1, \ldots, y_{n-1}]$ such that (a), (b) hold for $k[z_1, \ldots, z_r] \to s'$. since $s' \to s$ is injective and finite we see (a), (b) hold for $k[z_1, \ldots, z_r] \to s$. the last assertion follows from lemma \ref{lemma-integral-sub-dim-equal}. \end{proof} \begin{lemma} \label{lemma-noether-normalization-at-point} let $k$ be a field. let $s$ be a finite type $k$ algebra and denote $x = \spec(s)$. let $\mathfrak q$ be a prime of $s$, and let $x \in x$ be the corresponding point. there exists a $g \in s$, $g \not \in \mathfrak q$ such that $\dim(s_g) = \dim_x(x) =: d$ and such that there exists a finite injective map $k[y_1, \ldots, y_d] \to s_g$. \end{lemma} \begin{proof} note that by definition $\dim_x(x)$ is the minimum of the dimensions of $s_g$ for $g \in s$, $g \not \in \mathfrak q$, i.e., the minimum is attained. thus the lemma follows from lemma \ref{lemma-noether-normalization}. \end{proof} \begin{lemma} \label{lemma-refined-noether-normalization} let $k$ be a field. let $\mathfrak q \subset k[x_1, \ldots, x_n]$ be a prime ideal. set $r = \text{trdeg}_k\ \kappa(\mathfrak q)$. then there exists a finite ring map $\varphi : k[y_1, \ldots, y_n] \to k[x_1, \ldots, x_n]$ such that $\varphi^{-1}(\mathfrak q) = (y_{r + 1}, \ldots, y_n)$. \end{lemma} \begin{proof} by induction on $n$. the case $n = 0$ is clear. assume $n > 0$. if $r = n$, then $\mathfrak q = (0)$ and the result is clear. choose a nonzero $f \in \mathfrak q$. of course $f$ is nonconstant. after applying an automorphism of the form $$ k[x_1, \ldots, x_n] \longrightarrow k[x_1, \ldots, x_n], \quad x_n \mapsto x_n, \quad x_i \mapsto x_i + x_n^{e_i}\ (i < n) $$ we may assume that $f$ is monic in $x_n$ over $k[x_1, \ldots, x_n]$, see lemma \ref{lemma-helper-polynomial}. hence the ring map $$ k[y_1, \ldots, y_n] \longrightarrow k[x_1, \ldots, x_n], \quad y_n \mapsto f, \quad y_i \mapsto x_i\ (i < n) $$ is finite. moreover $y_n \in \mathfrak q \cap k[y_1, \ldots, y_n]$ by construction. thus $\mathfrak q \cap k[y_1, \ldots, y_n] = \mathfrak pk[y_1, \ldots, y_n] + (y_n)$ where $\mathfrak p \subset k[y_1, \ldots, y_{n - 1}]$ is a prime ideal. note that $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite, and hence $r = \text{trdeg}_k\ \kappa(\mathfrak p)$. apply the induction hypothesis to the pair $(k[y_1, \ldots, y_{n - 1}], \mathfrak p)$ and we obtain a finite ring map $k[z_1, \ldots, z_{n - 1}] \to k[y_1, \ldots, y_{n - 1}]$ such that $\mathfrak p \cap k[z_1, \ldots, z_{n - 1}] = (z_{r + 1}, \ldots, z_{n - 1})$. we extend the ring map $k[z_1, \ldots, z_{n - 1}] \to k[y_1, \ldots, y_{n - 1}]$ to a ring map $k[z_1, \ldots, z_n] \to k[y_1, \ldots, y_n]$ by mapping $z_n$ to $y_n$. the composition of the ring maps $$ k[z_1, \ldots, z_n] \to k[y_1, \ldots, y_n] \to k[x_1, \ldots, x_n] $$ solves the problem. \end{proof} \begin{lemma} \label{lemma-noether-normalization-over-a-domain} let $r \to s$ be an injective finite type ring map. assume $r$ is a domain. then there exists an integer $d$ and a factorization $$ r \to r[y_1, \ldots, y_d] \to s' \to s $$ by injective maps such that $s'$ is finite over $r[y_1, \ldots, y_d]$ and such that $s'_f \cong s_f$ for some nonzero $f \in r$. \end{lemma} \begin{proof} pick $x_1, \ldots, x_n \in s$ which generate $s$ over $r$. let $k$ be the fraction field of $r$ and $s_k = s \otimes_r k$. by lemma \ref{lemma-noether-normalization} we can find $y_1, \ldots, y_d \in s$ such that $k[y_1, \ldots, y_d] \to s_k$ is a finite injective map. note that $y_i \in s$ because we may pick the $y_j$ in the $\mathbf{z}$-algebra generated by $x_1, \ldots, x_n$. as a finite ring map is integral (see lemma \ref{lemma-finite-is-integral}) we can find monic $p_i \in k[y_1, \ldots, y_d][t]$ such that $p_i(x_i) = 0$ in $s_k$. let $f \in r$ be a nonzero element such that $fp_i \in r[y_1, \ldots, y_d][t]$ for all $i$. then $fp_i(x_i)$ maps to zero in $s_k$. hence after replacing $f$ by another nonzero element of $r$ we may also assume $fp_i(x_i)$ is zero in $s$. set $x_i' = fx_i$ and let $s' \subset s$ be the $r$-subalgebra generated by $y_1, \ldots, y_d$ and $x'_1, \ldots, x'_n$. note that $x'_i$ is integral over $r[y_1, \ldots, y_d]$ as we have $q_i(x_i') = 0$ where $q_i = f^{\deg_t(p_i)}p_i(t/f)$ which is a monic polynomial in $t$ with coefficients in $r[y_1, \ldots, y_d]$ by our choice of $f$. hence $r[y_1, \ldots, y_d] \subset s'$ is finite by lemma \ref{lemma-characterize-finite-in-terms-of-integral}. since $s' \subset s$ we have $s'_f \subset s_f$ (localization is exact). on the other hand, the elements $x_i = x'_i/f$ in $s'_f$ generate $s_f$ over $r_f$ and hence $s'_f \to s_f$ is surjective. whence $s'_f \cong s_f$ and we win. \end{proof} \section{dimension of finite type algebras over fields, reprise} \label{section-dimension-finite-type-algebras-reprise} \noindent this section is a continuation of section \ref{section-dimension-finite-type-algebras}. in this section we establish the connection between dimension and transcendence degree over the ground field for finite type domains over a field. \begin{lemma} \label{lemma-dimension-prime-polynomial-ring} let $k$ be a field. let $s$ be a finite type $k$ algebra which is an integral domain. let $k$ be the field of fractions of $s$. let $r = \text{trdeg}(k/k)$ be the transcendence degree of $k$ over $k$. then $\dim(s) = r$. moreover, the local ring of $s$ at every maximal ideal has dimension $r$. \end{lemma} \begin{proof} we may write $s = k[x_1, \ldots, x_n]/\mathfrak p$. by lemma \ref{lemma-dimension-height-polynomial-ring} all local rings of $s$ at maximal ideals have the same dimension. apply lemma \ref{lemma-noether-normalization}. we get a finite injective ring map $$ k[y_1, \ldots, y_d] \to s $$ with $d = \dim(s)$. clearly, $k(y_1, \ldots, y_d) \subset k$ is a finite extension and we win. \end{proof} \begin{lemma} \label{lemma-tr-deg-specialization} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $\mathfrak q \subset \mathfrak q' \subset s$ be distinct prime ideals. then $\text{trdeg}_k\ \kappa(\mathfrak q') < \text{trdeg}_k\ \kappa(\mathfrak q)$. \end{lemma} \begin{proof} by lemma \ref{lemma-dimension-prime-polynomial-ring} we have $\dim v(\mathfrak q) = \text{trdeg}_k\ \kappa(\mathfrak q)$ and similarly for $\mathfrak q'$. hence the result follows as the strict inclusion $v(\mathfrak q') \subset v(\mathfrak q)$ implies a strict inequality of dimensions. \end{proof} \noindent the following lemma generalizes lemma \ref{lemma-dimension-closed-point-finite-type-field}. \begin{lemma} \label{lemma-dimension-at-a-point-finite-type-field} let $k$ be a field. let $s$ be a finite type $k$ algebra. let $x = \spec(s)$. let $\mathfrak p \subset s$ be a prime ideal, and let $x \in x$ be the corresponding point. then we have $$ \dim_x(x) = \dim(s_{\mathfrak p}) + \text{trdeg}_k\ \kappa(\mathfrak p). $$ \end{lemma} \begin{proof} by lemma \ref{lemma-dimension-prime-polynomial-ring} we know that $r = \text{trdeg}_k\ \kappa(\mathfrak p)$ is equal to the dimension of $v(\mathfrak p)$. pick any maximal chain of primes $\mathfrak p \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_r$ starting with $\mathfrak p$ in $s$. this has length $r$ by lemma \ref{lemma-dimension-spell-it-out}. let $\mathfrak q_j$, $j \in j$ be the minimal primes of $s$ which are contained in $\mathfrak p$. these correspond $1-1$ to minimal primes in $s_{\mathfrak p}$ via the rule $\mathfrak q_j \mapsto \mathfrak q_js_{\mathfrak p}$. by lemma \ref{lemma-dimension-at-a-point-finite-type-over-field} we know that $\dim_x(x)$ is equal to the maximum of the dimensions of the rings $s/\mathfrak q_j$. for each $j$ pick a maximal chain of primes $\mathfrak q_j \subset \mathfrak p'_1 \subset \ldots \subset \mathfrak p'_{s(j)} = \mathfrak p$. then $\dim(s_{\mathfrak p}) = \max_{j \in j} s(j)$. now, each chain $$ \mathfrak q_i \subset \mathfrak p'_1 \subset \ldots \subset \mathfrak p'_{s(j)} = \mathfrak p \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_r $$ is a maximal chain in $s/\mathfrak q_j$, and by what was said before we have $\dim_x(x) = \max_{j \in j} r + s(j)$. the lemma follows. \end{proof} \noindent the following lemma says that the codimension of one finite type spec in another is the difference of heights. \begin{lemma} \label{lemma-codimension} let $k$ be a field. let $s' \to s$ be a surjection of finite type $k$ algebras. let $\mathfrak p \subset s$ be a prime ideal, and let $\mathfrak p'$ be the corresponding prime ideal of $s'$. let $x = \spec(s)$, resp.\ $x' = \spec(s')$, and let $x \in x$, resp. $x'\in x'$ be the point corresponding to $\mathfrak p$, resp.\ $\mathfrak p'$. then $$ \dim_{x'} x' - \dim_x x = \text{height}(\mathfrak p') - \text{height}(\mathfrak p). $$ \end{lemma} \begin{proof} immediate from lemma \ref{lemma-dimension-at-a-point-finite-type-field}. \end{proof} \begin{lemma} \label{lemma-dimension-preserved-field-extension} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $k/k$ be a field extension. then $\dim(s) = \dim(k \otimes_k s)$. \end{lemma} \begin{proof} by lemma \ref{lemma-noether-normalization} there exists a finite injective map $k[y_1, \ldots, y_d] \to s$ with $d = \dim(s)$. since $k$ is flat over $k$ we also get a finite injective map $k[y_1, \ldots, y_d] \to k \otimes_k s$. the result follows from lemma \ref{lemma-integral-sub-dim-equal}. \end{proof} \begin{lemma} \label{lemma-dimension-at-a-point-preserved-field-extension} let $k$ be a field. let $s$ be a finite type $k$-algebra. set $x = \spec(s)$. let $k/k$ be a field extension. set $s_k = k \otimes_k s$, and $x_k = \spec(s_k)$. let $\mathfrak q \subset s$ be a prime corresponding to $x \in x$ and let $\mathfrak q_k \subset s_k$ be a prime corresponding to $x_k \in x_k$ lying over $\mathfrak q$. then $\dim_x x = \dim_{x_k} x_k$. \end{lemma} \begin{proof} choose a presentation $s = k[x_1, \ldots, x_n]/i$. this gives a presentation $k \otimes_k s = k[x_1, \ldots, x_n]/(k \otimes_k i)$. let $\mathfrak q_k' \subset k[x_1, \ldots, x_n]$, resp.\ $\mathfrak q' \subset k[x_1, \ldots, x_n]$ be the corresponding primes. consider the following commutative diagram of noetherian local rings $$ \xymatrix{ k[x_1, \ldots, x_n]_{\mathfrak q_k'} \ar[r] & (k \otimes_k s)_{\mathfrak q_k} \\ k[x_1, \ldots, x_n]_{\mathfrak q'} \ar[r] \ar[u] & s_{\mathfrak q} \ar[u] } $$ both vertical arrows are flat because they are localizations of the flat ring maps $s \to s_k$ and $k[x_1, \ldots, x_n] \to k[x_1, \ldots, x_n]$. moreover, the vertical arrows have the same fibre rings. hence, we see from lemma \ref{lemma-dimension-base-fibre-equals-total} that $\text{height}(\mathfrak q') - \text{height}(\mathfrak q) = \text{height}(\mathfrak q_k') - \text{height}(\mathfrak q_k)$. denote $x' \in x' = \spec(k[x_1, \ldots, x_n])$ and $x'_k \in x'_k = \spec(k[x_1, \ldots, x_n])$ the points corresponding to $\mathfrak q'$ and $\mathfrak q_k'$. by lemma \ref{lemma-codimension} and what we showed above we have \begin{eqnarray*} n - \dim_x x & = & \dim_{x'} x' - \dim_x x \\ & = & \text{height}(\mathfrak q') - \text{height}(\mathfrak q) \\ & = & \text{height}(\mathfrak q_k') - \text{height}(\mathfrak q_k) \\ & = & \dim_{x'_k} x'_k - \dim_{x_k} x_k \\ & = & n - \dim_{x_k} x_k \end{eqnarray*} and the lemma follows. \end{proof} \begin{lemma} \label{lemma-inequalities-under-field-extension} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $k/k$ be a field extension. set $s_k = k \otimes_k s$. let $\mathfrak q \subset s$ be a prime and let $\mathfrak q_k \subset s_k$ be a prime lying over $\mathfrak q$. then $$ \dim (s_k \otimes_s \kappa(\mathfrak q))_{\mathfrak q_k} = \dim (s_k)_{\mathfrak q_k} - \dim s_\mathfrak q = \text{trdeg}_k \kappa(\mathfrak q) - \text{trdeg}_k \kappa(\mathfrak q_k) $$ moreover, given $\mathfrak q$ we can always choose $\mathfrak q_k$ such that the number above is zero. \end{lemma} \begin{proof} observe that $s_\mathfrak q \to (s_k)_{\mathfrak q_k}$ is a flat local homomorphism of local noetherian rings with special fibre $(s_k \otimes_s \kappa(\mathfrak q))_{\mathfrak q_k}$. hence the first equality by lemma \ref{lemma-dimension-base-fibre-equals-total}. the second equality follows from the fact that we have $\dim_x x = \dim_{x_k} x_k$ with notation as in lemma \ref{lemma-dimension-at-a-point-preserved-field-extension} and we have $\dim_x x = \dim s_\mathfrak q + \text{trdeg}_k \kappa(\mathfrak q)$ by lemma \ref{lemma-dimension-at-a-point-finite-type-field} and similarly for $\dim_{x_k} x_k$. if we choose $\mathfrak q_k$ minimal over $\mathfrak q s_k$, then the dimension of the fibre ring will be zero. \end{proof} \section{dimension of graded algebras over a field} \label{section-dimension-graded} \noindent here is a basic result. \begin{lemma} \label{lemma-dimension-graded} let $k$ be a field. let $s$ be a graded $k$-algebra generated over $k$ by finitely many elements of degree $1$. assume $s_0 = k$. let $p(t) \in \mathbf{q}[t]$ be the polynomial such that $\dim(s_d) = p(d)$ for all $d \gg 0$. see proposition \ref{proposition-graded-hilbert-polynomial}. then \begin{enumerate} \item the irrelevant ideal $s_{+}$ is a maximal ideal $\mathfrak m$. \item any minimal prime of $s$ is a homogeneous ideal and is contained in $s_{+} = \mathfrak m$. \item we have $\dim(s) = \deg(p) + 1 = \dim_x\spec(s)$ (with the convention that $\deg(0) = -1$) where $x$ is the point corresponding to the maximal ideal $s_{+} = \mathfrak m$. \item the hilbert function of the local ring $r = s_{\mathfrak m}$ is equal to the hilbert function of $s$. \end{enumerate} \end{lemma} \begin{proof} the first statement is obvious. the second follows from lemma \ref{lemma-graded-ring-minimal-prime}. by (2) every irreducible component passes through $x$. thus we have $\dim(s) = \dim_x\spec(s) = \dim(s_\mathfrak m)$ by lemma \ref{lemma-dimension-at-a-point-finite-type-over-field}. since $\mathfrak m^d/\mathfrak m^{d + 1} \cong \mathfrak m^ds_\mathfrak m/\mathfrak m^{d + 1}s_\mathfrak m$ we see that the hilbert function of the local ring $s_\mathfrak m$ is equal to the hilbert function of $s$, which is (4). we conclude the last equality of (3) by proposition \ref{proposition-dimension}. \end{proof} \section{generic flatness} \label{section-generic-flatness} \noindent basically this says that a finite type algebra over a domain becomes flat after inverting a single element of the domain. there are several versions of this result (in increasing order of strength). \begin{lemma} \label{lemma-generic-flatness-noetherian} let $r \to s$ be a ring map. let $m$ be an $s$-module. assume \begin{enumerate} \item $r$ is noetherian, \item $r$ is a domain, \item $r \to s$ is of finite type, and \item $m$ is a finite type $s$-module. \end{enumerate} then there exists a nonzero $f \in r$ such that $m_f$ is a free $r_f$-module. \end{lemma} \begin{proof} let $k$ be the fraction field of $r$. set $s_k = k \otimes_r s$. this is an algebra of finite type over $k$. we will argue by induction on $d = \dim(s_k)$ (which is finite for example by noether normalization, see section \ref{section-noether-normalization}). fix $d \geq 0$. assume we know that the lemma holds in all cases where $\dim(s_k) < d$. \medskip\noindent suppose given $r \to s$ and $m$ as in the lemma with $\dim(s_k) = d$. by lemma \ref{lemma-filter-noetherian-module} there exists a filtration $0 \subset m_1 \subset m_2 \subset \ldots \subset m_n = m$ so that $m_i/m_{i - 1}$ is isomorphic to $s/\mathfrak q$ for some prime $\mathfrak q$ of $s$. note that $\dim((s/\mathfrak q)_k) \leq \dim(s_k)$. also, note that an extension of free modules is free (see basic notion \ref{item-extension-free}). thus we may assume $m = s$ and that $s$ is a domain of finite type over $r$. \medskip\noindent if $r \to s$ has a nontrivial kernel, then take a nonzero $f \in r$ in this kernel. in this case $s_f = 0$ and the lemma holds. (this is really the case $d = -1$ and the start of the induction.) hence we may assume that $r \to s$ is a finite type extension of noetherian domains. \medskip\noindent apply lemma \ref{lemma-noether-normalization-over-a-domain} and replace $r$ by $r_f$ (with $f$ as in the lemma) to get a factorization $$ r \subset r[y_1, \ldots, y_d] \subset s $$ where the second extension is finite. choose $z_1, \ldots, z_r \in s$ which form a basis for the fraction field of $s$ over the fraction field of $r[y_1, \ldots, y_d]$. this gives a short exact sequence $$ 0 \to r[y_1, \ldots, y_d]^{\oplus r} \xrightarrow{(z_1, \ldots, z_r)} s \to n \to 0 $$ by construction $n$ is a finite $r[y_1, \ldots, y_d]$-module whose support does not contain the generic point $(0)$ of $\spec(r[y_1, \ldots, y_d])$. by lemma \ref{lemma-support-closed} there exists a nonzero $g \in r[y_1, \ldots, y_d]$ such that $g$ annihilates $n$, so we may view $n$ as a finite module over $s' = r[y_1, \ldots, y_d]/(g)$. since $\dim(s'_k) < d$ by induction there exists a nonzero $f \in r$ such that $n_f$ is a free $r_f$-module. since $(r[y_1, \ldots, y_d])_f \cong r_f[y_1, \ldots, y_d]$ is free also we conclude by the already mentioned fact that an extension of free modules is free. \end{proof} \begin{lemma} \label{lemma-generic-flatness-finitely-presented} \begin{slogan} generic freeness. \end{slogan} let $r \to s$ be a ring map. let $m$ be an $s$-module. assume \begin{enumerate} \item $r$ is a domain, \item $r \to s$ is of finite presentation, and \item $m$ is an $s$-module of finite presentation. \end{enumerate} then there exists a nonzero $f \in r$ such that $m_f$ is a free $r_f$-module. \end{lemma} \begin{proof} write $s = r[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. for $g \in r[x_1, \ldots, x_n]$ denote $\overline{g}$ its image in $s$. we may write $m = s^{\oplus t}/\sum sn_i$ for some $n_i \in s^{\oplus t}$. write $n_i = (\overline{g}_{i1}, \ldots, \overline{g}_{it})$ for some $g_{ij} \in r[x_1, \ldots, x_n]$. let $r_0 \subset r$ be the subring generated by all the coefficients of all the elements $g_i, g_{ij} \in r[x_1, \ldots, x_n]$. define $s_0 = r_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. define $m_0 = s_0^{\oplus t}/\sum s_0n_i$. then $r_0$ is a domain of finite type over $\mathbf{z}$ and hence noetherian (see lemma \ref{lemma-noetherian-permanence}). moreover via the injection $r_0 \to r$ we have $s \cong r \otimes_{r_0} s_0$ and $m \cong r \otimes_{r_0} m_0$. applying lemma \ref{lemma-generic-flatness-noetherian} we obtain a nonzero $f \in r_0$ such that $(m_0)_f$ is a free $(r_0)_f$-module. hence $m_f = r_f \otimes_{(r_0)_f} (m_0)_f$ is a free $r_f$-module. \end{proof} \begin{lemma} \label{lemma-generic-flatness} let $r \to s$ be a ring map. let $m$ be an $s$-module. assume \begin{enumerate} \item $r$ is a domain, \item $r \to s$ is of finite type, and \item $m$ is a finite type $s$-module. \end{enumerate} then there exists a nonzero $f \in r$ such that \begin{enumerate} \item[(a)] $m_f$ and $s_f$ are free as $r_f$-modules, and \item[(b)] $s_f$ is a finitely presented $r_f$-algebra and $m_f$ is a finitely presented $s_f$-module. \end{enumerate} \end{lemma} \begin{proof} we first prove the lemma for $s = r[x_1, \ldots, x_n]$, and then we deduce the result in general. \medskip\noindent assume $s = r[x_1, \ldots, x_n]$. choose elements $m_1, \ldots, m_t$ which generate $m$. this gives a short exact sequence $$ 0 \to n \to s^{\oplus t} \xrightarrow{(m_1, \ldots, m_t)} m \to 0. $$ denote $k$ the fraction field of $r$. denote $s_k = k \otimes_r s = k[x_1, \ldots, x_n]$, and similarly $n_k = k \otimes_r n$, $m_k = k \otimes_r m$. as $r \to k$ is flat the sequence remains exact after tensoring with $k$. as $s_k = k[x_1, \ldots, x_n]$ is a noetherian ring (see lemma \ref{lemma-noetherian-permanence}) we can find finitely many elements $n'_1, \ldots, n'_s \in n_k$ which generate it. choose $n_1, \ldots, n_r \in n$ such that $n'_i = \sum a_{ij}n_j$ for some $a_{ij} \in k$. set $$ m' = s^{\oplus t}/\sum\nolimits_{i = 1, \ldots, r} sn_i $$ by construction $m'$ is a finitely presented $s$-module, and there is a surjection $m' \to m$ which induces an isomorphism $m'_k \cong m_k$. we may apply lemma \ref{lemma-generic-flatness-finitely-presented} to $r \to s$ and $m'$ and we find an $f \in r$ such that $m'_f$ is a free $r_f$-module. thus $m'_f \to m_f$ is a surjection of modules over the domain $r_f$ where the source is a free module and which becomes an isomorphism upon tensoring with $k$. thus it is injective as $m'_f \subset m'_k$ because $m'_f$ is free and $r_f$ is a domain with fraction field $k$. hence $m'_f \to m_f$ is an isomorphism and the result is proved. \medskip\noindent for the general case, choose a surjection $r[x_1, \ldots, x_n] \to s$. think of both $s$ and $m$ as finite modules over $r[x_1, \ldots, x_n]$. by the special case proved above there exists a nonzero $f \in r$ such that both $s_f$ and $m_f$ are free as $r_f$-modules and finitely presented as $r_f[x_1, \ldots, x_n]$-modules. clearly this implies that $s_f$ is a finitely presented $r_f$-algebra and that $m_f$ is a finitely presented $s_f$-module. \end{proof} \noindent let $r \to s$ be a ring map. let $m$ be an $s$-module. consider the following condition on an element $f \in r$: \begin{equation} \label{equation-flat-and-finitely-presented} \left\{ \begin{matrix} s_f & \text{is of finite presentation over }r_f\\ m_f & \text{is of finite presentation as }s_f\text{-module}\\ s_f, m_f & \text{are free as }r_f\text{-modules} \end{matrix} \right. \end{equation} we define \begin{equation} \label{equation-good-locus} u(r \to s, m) = \bigcup\nolimits_{f \in r\text{ with }(\ref{equation-flat-and-finitely-presented})} d(f) \end{equation} which is an open subset of $\spec(r)$. \begin{lemma} \label{lemma-generic-flatness-locus-extension} let $r \to s$ be a ring map. let $0 \to m_1 \to m_2 \to m_3 \to 0$ be a short exact sequence of $s$-modules. then $$ u(r \to s, m_1) \cap u(r \to s, m_3) \subset u(r \to s, m_2). $$ \end{lemma} \begin{proof} let $u \in u(r \to s, m_1) \cap u(r \to s, m_3)$. choose $f_1, f_3 \in r$ such that $u \in d(f_1)$, $u \in d(f_3)$ and such that (\ref{equation-flat-and-finitely-presented}) holds for $f_1$ and $m_1$ and for $f_3$ and $m_3$. then set $f = f_1f_3$. then $u \in d(f)$ and (\ref{equation-flat-and-finitely-presented}) holds for $f$ and both $m_1$ and $m_3$. an extension of free modules is free, and an extension of finitely presented modules is finitely presented (lemma \ref{lemma-extension}). hence we see that (\ref{equation-flat-and-finitely-presented}) holds for $f$ and $m_2$. thus $u \in u(r \to s, m_2)$ and we win. \end{proof} \begin{lemma} \label{lemma-generic-flatness-locus-localize} let $r \to s$ be a ring map. let $m$ be an $s$-module. let $f \in r$. using the identification $\spec(r_f) = d(f)$ we have $u(r_f \to s_f, m_f) = d(f) \cap u(r \to s, m)$. \end{lemma} \begin{proof} suppose that $u \in u(r_f \to s_f, m_f)$. then there exists an element $g \in r_f$ such that $u \in d(g)$ and such that (\ref{equation-flat-and-finitely-presented}) holds for the pair $((r_f)_g \to (s_f)_g, (m_f)_g)$. write $g = a/f^n$ for some $a \in r$. set $h = af$. then $r_h = (r_f)_g$, $s_h = (s_f)_g$, and $m_h = (m_f)_g$. moreover $u \in d(h)$. hence $u \in u(r \to s, m)$. conversely, suppose that $u \in d(f) \cap u(r \to s, m)$. then there exists an element $g \in r$ such that $u \in d(g)$ and such that (\ref{equation-flat-and-finitely-presented}) holds for the pair $(r_g \to s_g, m_g)$. then it is clear that (\ref{equation-flat-and-finitely-presented}) also holds for the pair $(r_{fg} \to s_{fg}, m_{fg}) = ((r_f)_g \to (s_f)_g, (m_f)_g)$. hence $u \in u(r_f \to s_f, m_f)$ and we win. \end{proof} \begin{lemma} \label{lemma-generic-flatness-locus-reduce} let $r \to s$ be a ring map. let $m$ be an $s$-module. let $u \subset \spec(r)$ be a dense open. assume there is a covering $u = \bigcup_{i \in i} d(f_i)$ of opens such that $u(r_{f_i} \to s_{f_i}, m_{f_i})$ is dense in $d(f_i)$ for each $i \in i$. then $u(r \to s, m)$ is dense in $\spec(r)$. \end{lemma} \begin{proof} in view of lemma \ref{lemma-generic-flatness-locus-localize} this is a purely topological statement. namely, by that lemma we see that $u(r \to s, m) \cap d(f_i)$ is dense in $d(f_i)$ for each $i \in i$. by topology, lemma \ref{topology-lemma-nowhere-dense-local} we see that $u(r \to s, m) \cap u$ is dense in $u$. since $u$ is dense in $\spec(r)$ we conclude that $u(r \to s, m)$ is dense in $\spec(r)$. \end{proof} \begin{lemma} \label{lemma-generic-flatness-reduced} let $r \to s$ be a ring map. let $m$ be an $s$-module. assume \begin{enumerate} \item $r \to s$ is of finite type, \item $m$ is a finite $s$-module, and \item $r$ is reduced. \end{enumerate} then there exists a subset $u \subset \spec(r)$ such that \begin{enumerate} \item $u$ is open and dense in $\spec(r)$, \item for every $u \in u$ there exists an $f \in r$ such that $u \in d(f) \subset u$ and such that we have \begin{enumerate} \item $m_f$ and $s_f$ are free over $r_f$, \item $s_f$ is a finitely presented $r_f$-algebra, and \item $m_f$ is a finitely presented $s_f$-module. \end{enumerate} \end{enumerate} \end{lemma} \begin{proof} note that the lemma is equivalent to the statement that the open $u(r \to s, m)$, see equation (\ref{equation-good-locus}), is dense in $\spec(r)$. we first prove the lemma for $s = r[x_1, \ldots, x_n]$, and then we deduce the result in general. \medskip\noindent proof of the case $s = r[x_1, \ldots, x_n]$ and $m$ any finite module over $s$. note that in this case $s_f = r_f[x_1, \ldots, x_n]$ is free and of finite presentation over $r_f$, so we do not have to worry about the conditions regarding $s$, only those that concern $m$. we will use induction on $n$. \medskip\noindent there exists a finite filtration $$ 0 \subset m_1 \subset m_2 \subset \ldots \subset m_t = m $$ such that $m_i/m_{i - 1} \cong s/j_i$ for some ideal $j_i \subset s$, see lemma \ref{lemma-trivial-filter-finite-module}. since a finite intersection of dense opens is dense open, we see from lemma \ref{lemma-generic-flatness-locus-extension} that it suffices to prove the lemma for each of the modules $r/j_i$. hence we may assume that $m = s/j$ for some ideal $j$ of $s = r[x_1, \ldots, x_n]$. \medskip\noindent let $i \subset r$ be the ideal generated by the coefficients of elements of $j$. let $u_1 = \spec(r) \setminus v(i)$ and let $$ u_2 = \spec(r) \setminus \overline{u_1}. $$ then it is clear that $u = u_1 \cup u_2$ is dense in $\spec(r)$. let $f \in r$ be an element such that either (a) $d(f) \subset u_1$ or (b) $d(f) \subset u_2$. if for any such $f$ the lemma holds for the pair $(r_f \to r_f[x_1, \ldots, x_n], m_f)$ then by lemma \ref{lemma-generic-flatness-locus-reduce} we see that $u(r \to s, m)$ is dense in $\spec(r)$. hence we may assume either (a) $i = r$, or (b) $v(i) = \spec(r)$. \medskip\noindent in case (b) we actually have $i = 0$ as $r$ is reduced! hence $j = 0$ and $m = s$ and the lemma holds in this case. \medskip\noindent in case (a) we have to do a little bit more work. note that every element of $i$ is actually the coefficient of a monomial of an element of $j$, because the set of coefficients of elements of $j$ forms an ideal (details omitted). hence we find an element $$ g = \sum\nolimits_{k \in e} a_k x^k \in j $$ where $e$ is a finite set of multi-indices $k = (k_1, \ldots, k_n)$ with at least one coefficient $a_{k_0}$ a unit in $r$. actually we can find one which has a coefficient equal to $1$ as $1 \in i$ in case (a). let $m = \#\{k \in e \mid a_k \text{ is not a unit}\}$. note that $0 \leq m \leq \# e - 1$. we will argue by induction on $m$. \medskip\noindent the case $m = 0$. in this case all the coefficients $a_k$, $k \in e$ of $g$ are units and $e \not = \emptyset$. if $e = \{k_0\}$ is a singleton and $k_0 = (0, \ldots, 0)$, then $g$ is a unit and $j = s$ so the result holds for sure. (this happens in particular when $n = 0$ and it provides the base case of the induction on $n$.) if not $e = \{(0, \ldots, 0)\}$, then at least one $k$ is not equal to $(0, \ldots, 0)$, i.e., $g \not \in r$. at this point we employ the usual trick of noether normalization. namely, we consider $$ g(y_1, \ldots, y_n) = g(y_1 + y_n^{e_1}, y_2 + y_n^{e_2}, \ldots, y_{n - 1} + y_n^{e_{n - 1}}, y_n) $$ with $0 \ll e_{n -1} \ll e_{n - 2} \ll \ldots \ll e_1$. by lemma \ref{lemma-helper-polynomial} it follows that $g(y_1, \ldots, y_n)$ as a polynomial in $y_n$ looks like $$ a_k y_n^{k_n + \sum_{i = 1, \ldots, n - 1} e_i k_i} + \text{lower order terms in }y_n $$ as $a_k$ is a unit we conclude that $m = r[x_1, \ldots, x_n]/j$ is finite over $r[y_1, \ldots, y_{n - 1}]$. hence $u(r \to r[x_1, \ldots, x_n], m) = u(r \to r[y_1, \ldots, y_{n - 1}], m)$ and we win by induction on $n$. \medskip\noindent the case $m > 0$. pick a multi-index $k \in e$ such that $a_k$ is not a unit. as before set $u_1 = \spec(r_{a_k}) = \spec(r) \setminus v(a_k)$ and set $$ u_2 = \spec(r) \setminus \overline{u_1}. $$ then it is clear that $u = u_1 \cup u_2$ is dense in $\spec(r)$. let $f \in r$ be an element such that either (a) $d(f) \subset u_1$ or (b) $d(f) \subset u_2$. if for any such $f$ the lemma holds for the pair $(r_f \to r_f[x_1, \ldots, x_n], m_f)$ then by lemma \ref{lemma-generic-flatness-locus-reduce} we see that $u(r \to s, m)$ is dense in $\spec(r)$. hence we may assume either (a) $a_kr = r$, or (b) $v(a_k) = \spec(r)$. in case (a) the number $m$ drops, as $a_k$ has turned into a unit. in case (b), since $r$ is reduced, we conclude that $a_k = 0$. hence the set $e$ decreases so the number $m$ drops as well. in both cases we win by induction on $m$. \medskip\noindent at this point we have proven the lemma in case $s = r[x_1, \ldots, x_n]$. assume that $(r \to s, m)$ is an arbitrary pair satisfying the conditions of the lemma. choose a surjection $r[x_1, \ldots, x_n] \to s$. observe that, with the notation introduced in (\ref{equation-good-locus}), we have $$ u(r \to s, m) = u(r \to r[x_1, \ldots, x_n], s) \cap u(r \to r[x_1, \ldots, x_n], m) $$ hence as we've just finished proving the right two opens are dense also the open on the left is dense. \end{proof} \section{around krull-akizuki} \label{section-krull-akizuki} \noindent one application of krull-akizuki is to show that there are plenty of discrete valuation rings. more generally in this section we show how to construct discrete valuation rings dominating noetherian local rings. \medskip\noindent first we show how to dominate a noetherian local domain by a $1$-dimensional noetherian local domain by blowing up the maximal ideal. \begin{lemma} \label{lemma-dominate-by-dimension-1} let $r$ be a local noetherian domain with fraction field $k$. assume $r$ is not a field. then there exist $r \subset r' \subset k$ with \begin{enumerate} \item $r'$ local noetherian of dimension $1$, \item $r \to r'$ a local ring map, i.e., $r'$ dominates $r$, and \item $r \to r'$ essentially of finite type. \end{enumerate} \end{lemma} \begin{proof} choose any valuation ring $a \subset k$ dominating $r$ (which exist by lemma \ref{lemma-dominate}). denote $v$ the corresponding valuation. let $x_1, \ldots, x_r$ be a minimal set of generators of the maximal ideal $\mathfrak m$ of $r$. we may and do assume that $v(x_r) = \min\{v(x_1), \ldots, v(x_r)\}$. consider the ring $$ s = r[x_1/x_r, x_2/x_r, \ldots, x_{r - 1}/x_r] \subset k. $$ note that $\mathfrak ms = x_rs$ is a principal ideal. note that $s \subset a$ and that $v(x_r) > 0$, hence we see that $x_rs \not = s$. choose a minimal prime $\mathfrak q$ over $x_rs$. then $\text{height}(\mathfrak q) = 1$ by lemma \ref{lemma-minimal-over-1} and $\mathfrak q$ lies over $\mathfrak m$. hence we see that $r' = s_{\mathfrak q}$ is a solution. \end{proof} \begin{lemma}[koll\'ar] \label{lemma-hart-serre-loc-thm} \begin{reference} this is taken from a forthcoming paper by j\'anos koll\'ar entitled ``variants of normality for noetherian schemes''. \end{reference} let $(r, \mathfrak m)$ be a local noetherian ring. then exactly one of the following holds: \begin{enumerate} \item $(r, \mathfrak m)$ is artinian, \item $(r, \mathfrak m)$ is regular of dimension $1$, \item $\text{depth}(r) \geq 2$, or \item there exists a finite ring map $r \to r'$ which is not an isomorphism whose kernel and cokernel are annihilated by a power of $\mathfrak m$ such that $\mathfrak m$ is not an associated prime of $r'$ and $r' \not = 0$. \end{enumerate} \end{lemma} \begin{proof} observe that $(r, \mathfrak m)$ is not artinian if and only if $v(\mathfrak m) \subset \spec(r)$ is nowhere dense. see proposition \ref{proposition-dimension-zero-ring}. we assume this from now on. \medskip\noindent let $j \subset r$ be the largest ideal killed by a power of $\mathfrak m$. if $j \not = 0$ then $r \to r/j$ shows that $(r, \mathfrak m)$ is as in (4). \medskip\noindent otherwise $j = 0$. in particular $\mathfrak m$ is not an associated prime of $r$ and we see that there is a nonzerodivisor $x \in \mathfrak m$ by lemma \ref{lemma-ideal-nonzerodivisor}. if $\mathfrak m$ is not an associated prime of $r/xr$ then $\text{depth}(r) \geq 2$ by the same lemma. thus we are left with the case when there is a $y \in r$, $y \not \in xr$ such that $y \mathfrak m \subset xr$. \medskip\noindent if $y \mathfrak m \subset x \mathfrak m$ then we can consider the map $\varphi : \mathfrak m \to \mathfrak m$, $f \mapsto yf/x$ (well defined as $x$ is a nonzerodivisor). by the determinantal trick of lemma \ref{lemma-charpoly-module} there exists a monic polynomial $p$ with coefficients in $r$ such that $p(\varphi) = 0$. we conclude that $p(y/x) = 0$ in $r_x$. let $r' \subset r_x$ be the ring generated by $r$ and $y/x$. then $r \subset r'$ and $r'/r$ is a finite $r$-module annihilated by a power of $\mathfrak m$. thus $r$ is as in (4). \medskip\noindent otherwise there is a $t \in \mathfrak m$ such that $y t = u x$ for some unit $u$ of $r$. after replacing $t$ by $u^{-1}t$ we get $yt = x$. in particular $y$ is a nonzerodivisor. for any $t' \in \mathfrak m$ we have $y t' = x s$ for some $s \in r$. thus $y (t' - s t ) = x s - x s = 0$. since $y$ is not a zero-divisor this implies that $t' = ts$ and so $\mathfrak m = (t)$. thus $(r, \mathfrak m)$ is regular of dimension 1. \medskip\noindent the argument so far shows that every $r$ falls into one of the 4 cases. to finish we have to show that no two of the properties can hold simultaneously for each of the 6 combinations of properties. we'll just show that (2) and (3) each exclude (4); the other cases are left to the reader. \medskip\noindent assume $r$ is regular of dimension $1$ and that $r \to r'$ is a finite ring map whose kernel and cokernel are annihilated by a power of $\mathfrak m$ and $\mathfrak m$ is not an associated prime of $r'$. then $r'$ is a finite $r$-module of depth at least $1$ and hence free by lemma \ref{lemma-regular-mcm-free}. since $r \to r'$ is an isomorphism in the generic point, we conclude that $r'$ must be free of rank $1$ as an $r$-module. then $r' \to \text{end}_r(r') \cong r$ is an inverse to the map $r \to r'$. thus (4) cannot be true. \medskip\noindent assume $r$ has depth $\geq 2$ and that $r \to r'$ is a finite ring map whose kernel and cokernel are annihilated by a power of $\mathfrak m$ and $\mathfrak m$ is not an associated prime of $r'$. then $r \to r'$ is necessarily injective (as the kernel would have both depth $0$ and depth $\geq 1$) and the cokernel has depth at least $1$ (by lemma \ref{lemma-depth-in-ses} and the fact that $r'$ has depth $\geq 1$ by assumption) whence cannot be supported on $\{\mathfrak m\}$ unless it is $0$ as well. thus (4) cannot be true. \end{proof} \begin{lemma} \label{lemma-nonregular-dimension-one} let $r$ be a local ring with maximal ideal $\mathfrak m$. assume $r$ is noetherian, has dimension $1$, and that $\dim(\mathfrak m/\mathfrak m^2) > 1$. then there exists a ring map $r \to r'$ such that \begin{enumerate} \item $r \to r'$ is finite, \item $r \to r'$ is not an isomorphism, \item the kernel and cokernel of $r \to r'$ are annihilated by a power of $\mathfrak m$, and \item $\mathfrak m$ is not an associated prime of $r'$. \end{enumerate} \end{lemma} \begin{proof} this follows from lemma \ref{lemma-hart-serre-loc-thm} and the fact that $r$ is not artinian, not regular, and does not have depth $\geq 2$ (the last part because the depth does not exceed the dimension by lemma \ref{lemma-bound-depth}). \end{proof} \begin{example} \label{example-nonreduced} consider the noetherian local ring $$ r = k[[x, y]]/(y^2) $$ it has dimension 1 and it is cohen-macaulay. an example of an extension as in lemma \ref{lemma-nonregular-dimension-one} is the extension $$ k[[x, y]]/(y^2) \subset k[[x, z]]/(z^2), \ \ y \mapsto xz $$ in other words it is gotten by adjoining $y/x$ to $r$. the effect of repeating the construction $n > 1$ times is to adjoin the element $y/x^n$. \end{example} \begin{example} \label{example-bad-dvr-char-p} let $k$ be a field of characteristic $p > 0$ such that $k$ has infinite degree over its subfield $k^p$ of $p$th powers. for example $k = \mathbf{f}_p(t_1, t_2, t_3, \ldots)$. consider the ring $$ a = \left\{ \sum a_i x^i \in k[[x]] \text{ such that } [k^p(a_0, a_1, a_2, \ldots) : k^p] < \infty \right\} $$ then $a$ is a discrete valuation ring and its completion is $a^\wedge = k[[x]]$. note that the induced extension of fraction fields of $a \subset k[[x]]$ is infinite purely inseparable. choose any $f \in k[[x]]$, $f \not \in a$. let $r = a[f] \subset k[[x]]$. then $r$ is a noetherian local domain of dimension $1$ whose completion $r^\wedge$ is nonreduced (think!). \end{example} \begin{remark} \label{remark-resolution-dim-1} suppose that $r$ is a $1$-dimensional semi-local noetherian domain. if there is a maximal ideal $\mathfrak m \subset r$ such that $r_{\mathfrak m}$ is not regular, then we may apply lemma \ref{lemma-nonregular-dimension-one} to $(r, \mathfrak m)$ to get a finite ring extension $r \subset r_1$. (for example one can do this so that $\spec(r_1) \to \spec(r)$ is the blowup of $\spec(r)$ in the ideal $\mathfrak m$.) of course $r_1$ is a $1$-dimensional semi-local noetherian domain with the same fraction field as $r$. if $r_1$ is not a regular semi-local ring, then we may repeat the construction to get $r_1 \subset r_2$. thus we get a sequence $$ r \subset r_1 \subset r_2 \subset r_3 \subset \ldots $$ of finite ring extensions which may stop if $r_n$ is regular for some $n$. resolution of singularities would be the claim that eventually $r_n$ is indeed regular. in reality this is not the case. namely, there exists a characteristic $0$ noetherian local domain $a$ of dimension $1$ whose completion is nonreduced, see \cite[proposition 3.1]{ferrand-raynaud} or our examples, section \ref{examples-section-local-completion-nonreduced}. for an example in characteristic $p > 0$ see example \ref{example-bad-dvr-char-p}. since the construction of blowing up commutes with completion it is easy to see the sequence never stabilizes. see \cite{bennett} for a discussion (mostly in positive characteristic). on the other hand, if the completion of $r$ in all of its maximal ideals is reduced, then the procedure stops (insert future reference here). \end{remark} \begin{lemma} \label{lemma-characterize-dvr} let $a$ be a ring. the following are equivalent. \begin{enumerate} \item the ring $a$ is a discrete valuation ring. \item the ring $a$ is a valuation ring and noetherian but not a field. \item the ring $a$ is a regular local ring of dimension $1$. \item the ring $a$ is a noetherian local domain with maximal ideal $\mathfrak m$ generated by a single nonzero element. \item the ring $a$ is a noetherian local normal domain of dimension $1$. \end{enumerate} in this case if $\pi$ is a generator of the maximal ideal of $a$, then every element of $a$ can be uniquely written as $u\pi^n$, where $u \in a$ is a unit. \end{lemma} \begin{proof} the equivalence of (1) and (2) is lemma \ref{lemma-valuation-ring-noetherian-discrete}. moreover, in the proof of lemma \ref{lemma-valuation-ring-noetherian-discrete} we saw that if $a$ is a discrete valuation ring, then $a$ is a pid, hence (3). note that a regular local ring is a domain (see lemma \ref{lemma-regular-domain}). using this the equivalence of (3) and (4) follows from dimension theory, see section \ref{section-dimension}. \medskip\noindent assume (3) and let $\pi$ be a generator of the maximal ideal $\mathfrak m$. for all $n \geq 0$ we have $\dim_{a/\mathfrak m} \mathfrak m^n/\mathfrak m^{n + 1} = 1$ because it is generated by $\pi^n$ (and it cannot be zero). in particular $\mathfrak m^n = (\pi^n)$ and the graded ring $\bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$ is isomorphic to the polynomial ring $a/\mathfrak m[t]$. for $x \in a \setminus \{0\}$ define $v(x) = \max\{n \mid x \in \mathfrak m^n\}$. in other words $x = u \pi^{v(x)}$ with $u \in a^*$. by the remarks above we have $v(xy) = v(x) + v(y)$ for all $x, y \in a \setminus \{0\}$. we extend this to the field of fractions $k$ of $a$ by setting $v(a/b) = v(a) - v(b)$ (well defined by multiplicativity shown above). then it is clear that $a$ is the set of elements of $k$ which have valuation $\geq 0$. hence we see that $a$ is a valuation ring by lemma \ref{lemma-valuation-valuation-ring}. \medskip\noindent a valuation ring is a normal domain by lemma \ref{lemma-valuation-ring-normal}. hence we see that the equivalent conditions (1) -- (3) imply (5). assume (5). suppose that $\mathfrak m$ cannot be generated by $1$ element to get a contradiction. then lemma \ref{lemma-nonregular-dimension-one} implies there is a finite ring map $a \to a'$ which is an isomorphism after inverting any nonzero element of $\mathfrak m$ but not an isomorphism. in particular we may identify $a'$ with a subset of the fraction field of $a$. since $a \to a'$ is finite it is integral (see lemma \ref{lemma-finite-is-integral}). since $a$ is normal we get $a = a'$ a contradiction. \end{proof} \begin{definition} \label{definition-uniformizer} let $a$ be a discrete valuation ring. a {\it uniformizer} is an element $\pi \in a$ which generates the maximal ideal of $a$. \end{definition} \noindent by lemma \ref{lemma-characterize-dvr} any two uniformizers of a discrete valuation ring are associates. \begin{lemma} \label{lemma-finite-length} let $r$ be a domain with fraction field $k$. let $m$ be an $r$-submodule of $k^{\oplus r}$. assume $r$ is local noetherian of dimension $1$. for any nonzero $x \in r$ we have $\text{length}_r(r/xr) < \infty$ and $$ \text{length}_r(m/xm) \leq r \cdot \text{length}_r(r/xr). $$ \end{lemma} \begin{proof} if $x$ is a unit then the result is true. hence we may assume $x \in \mathfrak m$ the maximal ideal of $r$. since $x$ is not zero and $r$ is a domain we have $\dim(r/xr) = 0$, and hence $r/xr$ has finite length. consider $m \subset k^{\oplus r}$ as in the lemma. we may assume that the elements of $m$ generate $k^{\oplus r}$ as a $k$-vector space after replacing $k^{\oplus r}$ by a smaller subspace if necessary. \medskip\noindent suppose first that $m$ is a finite $r$-module. in that case we can clear denominators and assume $m \subset r^{\oplus r}$. since $m$ generates $k^{\oplus r}$ as a vectors space we see that $r^{\oplus r}/m$ has finite length. in particular there exists an integer $c \geq 0$ such that $x^cr^{\oplus r} \subset m$. note that $m \supset xm \supset x^2m \supset \ldots$ is a sequence of modules with successive quotients each isomorphic to $m/xm$. hence we see that $$ n \text{length}_r(m/xm) = \text{length}_r(m/x^nm). $$ the same argument for $m = r^{\oplus r}$ shows that $$ n \text{length}_r(r^{\oplus r}/xr^{\oplus r}) = \text{length}_r(r^{\oplus r}/x^nr^{\oplus r}). $$ by our choice of $c$ above we see that $x^nm$ is sandwiched between $x^n r^{\oplus r}$ and $x^{n + c}r^{\oplus r}$. this easily gives that $$ r(n + c) \text{length}_r(r/xr) \geq n \text{length}_r(m/xm) \geq r (n - c) \text{length}_r(r/xr) $$ hence in the finite case we actually get the result of the lemma with equality. \medskip\noindent suppose now that $m$ is not finite. suppose that the length of $m/xm$ is $\geq k$ for some natural number $k$. then we can find $$ 0 \subset n_0 \subset n_1 \subset n_2 \subset \ldots n_k \subset m/xm $$ with $n_i \not = n_{i + 1}$ for $i = 0, \ldots k - 1$. choose an element $m_i \in m$ whose congruence class mod $xm$ falls into $n_i$ but not into $n_{i - 1}$ for $i = 1, \ldots, k$. consider the finite $r$-module $m' = rm_1 + \ldots + rm_k \subset m$. let $n'_i \subset m'/xm'$ be the inverse image of $n_i$. it is clear that $n'_i \not =n'_{i + 1}$ by our choice of $m_i$. hence we see that $\text{length}_r(m'/xm') \geq k$. by the finite case we conclude $k \leq r\text{length}_r(r/xr)$ as desired. \end{proof} \noindent here is a first application. \begin{lemma} \label{lemma-finite-extension-residue-fields-dimension-1} let $r \to s$ be a homomorphism of domains inducing an injection of fraction fields $k \subset l$. if $r$ is noetherian local of dimension $1$ and $[l : k] < \infty$ then \begin{enumerate} \item each prime ideal $\mathfrak n_i$ of $s$ lying over the maximal ideal $\mathfrak m$ of $r$ is maximal, \item there are finitely many of these, and \item $[\kappa(\mathfrak n_i) : \kappa(\mathfrak m)] < \infty$ for each $i$. \end{enumerate} \end{lemma} \begin{proof} pick $x \in \mathfrak m$ nonzero. apply lemma \ref{lemma-finite-length} to the submodule $s \subset l \cong k^{\oplus n}$ where $n = [l : k]$. thus the ring $s/xs$ has finite length over $r$. it follows that $s/\mathfrak m s$ has finite length over $\kappa(\mathfrak m)$. in other words, $\dim_{\kappa(\mathfrak m)} s/\mathfrak m s$ is finite (lemma \ref{lemma-dimension-is-length}). thus $s/\mathfrak ms$ is artinian (lemma \ref{lemma-finite-dimensional-algebra}). the structural results on artinian rings implies parts (1) and (2), see for example lemma \ref{lemma-artinian-finite-length}. part (3) is implied by the finiteness established above. \end{proof} \begin{lemma} \label{lemma-finite-length-global} let $r$ be a domain with fraction field $k$. let $m$ be an $r$-submodule of $k^{\oplus r}$. assume $r$ is noetherian of dimension $1$. for any nonzero $x \in r$ we have $\text{length}_r(m/xm) < \infty$. \end{lemma} \begin{proof} since $r$ has dimension $1$ we see that $x$ is contained in finitely many primes $\mathfrak m_i$, $i = 1, \ldots, n$, each maximal. since $r$ is noetherian we see that $r/xr$ is artinian and $r/xr = \prod_{i = 1, \ldots, n} (r/xr)_{\mathfrak m_i}$ by proposition \ref{proposition-dimension-zero-ring} and lemma \ref{lemma-artinian-finite-length}. hence $m/xm$ similarly decomposes as the product $m/xm = \prod (m/xm)_{\mathfrak m_i}$ of its localizations at the $\mathfrak m_i$. by lemma \ref{lemma-finite-length} applied to $m_{\mathfrak m_i}$ over $r_{\mathfrak m_i}$ we see each $m_{\mathfrak m_i}/xm_{\mathfrak m_i} = (m/xm)_{\mathfrak m_i}$ has finite length over $r_{\mathfrak m_i}$. thus $m/xm$ has finite length over $r$ as the above implies $m/xm$ has a finite filtration by $r$-submodules whose successive quotients are isomorphic to the residue fields $\kappa(\mathfrak m_i)$. \end{proof} \begin{lemma}[krull-akizuki] \label{lemma-krull-akizuki} let $r$ be a domain with fraction field $k$. let $l/k$ be a finite extension of fields. assume $r$ is noetherian and $\dim(r) = 1$. in this case any ring $a$ with $r \subset a \subset l$ is noetherian. \end{lemma} \begin{proof} let $i \subset a$ be a nonzero ideal. by lemma \ref{lemma-intersection-not-zero} we can find a nonzero element $x \in i \cap r$. then we get $i/xa \subset a/xa$. by lemma \ref{lemma-finite-length-global} the $r$-module $a/xa$ has finite length as an $r$-module. hence $i/xa$ has finite length as an $r$-module. hence $i$ is finitely generated as an ideal in $a$. \end{proof} \begin{lemma} \label{lemma-exists-dvr} let $r$ be a noetherian local domain with fraction field $k$. assume that $r$ is not a field. let $l/k$ be a finitely generated field extension. then there exists discrete valuation ring $a$ with fraction field $l$ which dominates $r$. \end{lemma} \begin{proof} if $l$ is not finite over $k$ choose a transcendence basis $x_1, \ldots, x_r$ of $l$ over $k$ and replace $r$ by $r[x_1, \ldots, x_r]$ localized at the maximal ideal generated by $\mathfrak m_r$ and $x_1, \ldots, x_r$. thus we may assume $k \subset l$ finite. \medskip\noindent by lemma \ref{lemma-dominate-by-dimension-1} we may assume $\dim(r) = 1$. \medskip\noindent let $a \subset l$ be the integral closure of $r$ in $l$. by lemma \ref{lemma-krull-akizuki} this is noetherian. by lemma \ref{lemma-integral-overring-surjective} there is a prime ideal $\mathfrak q \subset a$ lying over the maximal ideal of $r$. by lemma \ref{lemma-characterize-dvr} the ring $a_{\mathfrak q}$ is a discrete valuation ring dominating $r$ as desired. \end{proof} \section{factorization} \label{section-factoring} \noindent here are some notions and relations between them that are typically taught in a first year course on algebra at the undergraduate level. \begin{definition} \label{definition-irreducible-prime-element} let $r$ be a domain. \begin{enumerate} \item elements $x, y \in r$ are called {\it associates} if there exists a unit $u \in r^*$ such that $x = uy$. \item an element $x \in r$ is called {\it irreducible} if it is nonzero, not a unit and whenever $x = yz$, $y, z \in r$, then $y$ is either a unit or an associate of $x$. \item an element $x \in r$ is called {\it prime} if the ideal generated by $x$ is a prime ideal. \end{enumerate} \end{definition} \begin{lemma} \label{lemma-easy-divisibility} let $r$ be a domain. let $x, y \in r$. then $x$, $y$ are associates if and only if $(x) = (y)$. \end{lemma} \begin{proof} if $x = uy$ for some unit $u \in r$, then $(x) \subset (y)$ and $y = u^{-1}x$ so also $(y) \subset (x)$. conversely, suppose that $(x) = (y)$. then $x = fy$ and $y = gx$ for some $f, g \in a$. then $x = fg x$ and since $r$ is a domain $fg = 1$. thus $x$ and $y$ are associates. \end{proof} \begin{lemma} \label{lemma-factorization-exists} let $r$ be a domain. consider the following conditions: \begin{enumerate} \item the ring $r$ satisfies the ascending chain condition for principal ideals. \item every nonzero, nonunit element $a \in r$ has a factorization $a = b_1 \ldots b_k$ with each $b_i$ an irreducible element of $r$. \end{enumerate} then (1) implies (2). \end{lemma} \begin{proof} let $x$ be a nonzero element, not a unit, which does not have a factorization into irreducibles. set $x_1 = x$. we can write $x = yz$ where neither $y$ nor $z$ is irreducible or a unit. then either $y$ does not have a factorization into irreducibles, in which case we set $x_2 = y$, or $z$ does not have a factorization into irreducibles, in which case we set $x_2 = z$. continuing in this fashion we find a sequence $$ \ldots | x_3 | x_2 | x_1 $$ of elements of $r$ with $x_n/x_{n + 1}$ not a unit. this gives a strictly increasing sequence of principal ideals $(x_1) \subset (x_2) \subset (x_3) \subset \ldots$ thereby finishing the proof. \end{proof} \begin{definition} \label{definition-ufd} a {\it unique factorization domain}, abbreviated {\it ufd}, is a domain $r$ such that if $x \in r$ is a nonzero, nonunit, then $x$ has a factorization into irreducibles, and if $$ x = a_1 \ldots a_m = b_1 \ldots b_n $$ are factorizations into irreducibles then $n = m$ and there exists a permutation $\sigma : \{1, \ldots, n\} \to \{1, \ldots, n\}$ such that $a_i$ and $b_{\sigma(i)}$ are associates. \end{definition} \begin{lemma} \label{lemma-characterize-ufd} let $r$ be a domain. assume every nonzero, nonunit factors into irreducibles. then $r$ is a ufd if and only if every irreducible element is prime. \end{lemma} \begin{proof} assume $r$ is a ufd and let $x \in r$ be an irreducible element. say $ab \in (x)$, i.e., $ab = cx$. choose factorizations $a = a_1 \ldots a_n$, $b = b_1 \ldots b_m$, and $c = c_1 \ldots c_r$. by uniqueness of the factorization $$ a_1 \ldots a_n b_1 \ldots b_m = c_1 \ldots c_r x $$ we find that $x$ is an associate of one of the elements $a_1, \ldots, b_m$. in other words, either $a \in (x)$ or $b \in (x)$ and we conclude that $x$ is prime. \medskip\noindent assume every irreducible element is prime. we have to prove that factorization into irreducibles is unique up to permutation and taking associates. say $a_1 \ldots a_m = b_1 \ldots b_n$ with $a_i$ and $b_j$ irreducible. since $a_1$ is prime, we see that $b_j \in (a_1)$ for some $j$. after renumbering we may assume $b_1 \in (a_1)$. then $b_1 = a_1 u$ and since $b_1$ is irreducible we see that $u$ is a unit. hence $a_1$ and $b_1$ are associates and $a_2 \ldots a_n = ub_2\ldots b_m$. by induction on $n + m$ we see that $n = m$ and $a_i$ associate to $b_{\sigma(i)}$ for $i = 2, \ldots, n$ as desired. \end{proof} \begin{lemma} \label{lemma-characterize-ufd-height-1} let $r$ be a noetherian domain. then $r$ is a ufd if and only if every height $1$ prime ideal is principal. \end{lemma} \begin{proof} assume $r$ is a ufd and let $\mathfrak p$ be a height 1 prime ideal. take $x \in \mathfrak p$ nonzero and let $x = a_1 \ldots a_n$ be a factorization into irreducibles. since $\mathfrak p$ is prime we see that $a_i \in \mathfrak p$ for some $i$. by lemma \ref{lemma-characterize-ufd} the ideal $(a_i)$ is prime. since $\mathfrak p$ has height $1$ we conclude that $(a_i) = \mathfrak p$. \medskip\noindent assume every height $1$ prime is principal. since $r$ is noetherian every nonzero nonunit element $x$ has a factorization into irreducibles, see lemma \ref{lemma-factorization-exists}. it suffices to prove that an irreducible element $x$ is prime, see lemma \ref{lemma-characterize-ufd}. let $(x) \subset \mathfrak p$ be a prime minimal over $(x)$. then $\mathfrak p$ has height $1$ by lemma \ref{lemma-minimal-over-1}. by assumption $\mathfrak p = (y)$. hence $x = yz$ and $z$ is a unit as $x$ is irreducible. thus $(x) = (y)$ and we see that $x$ is prime. \end{proof} \begin{lemma}[nagata's criterion for factoriality] \label{lemma-invert-prime-elements} \begin{reference} \cite[lemma 2]{nagata-ufd} \end{reference} let $a$ be a domain. let $s \subset a$ be a multiplicative subset generated by prime elements. let $x \in a$ be irreducible. then \begin{enumerate} \item the image of $x$ in $s^{-1}a$ is irreducible or a unit, and \item $x$ is prime if and only if the image of $x$ in $s^{-1}a$ is a prime element or a unit in $s^{-1}a$. \end{enumerate} moreover, then $a$ is a ufd if and only if every nonzero nonunit element of $a$ has a factorization into irreducibles and $s^{-1}a$ is a ufd. \end{lemma} \begin{proof} say $x = \alpha \beta$ for $\alpha, \beta \in s^{-1}a$. then $\alpha = a/s$ and $\beta = b/s'$ for $a, b \in a$, $s, s' \in s$. thus we get $ss'x = ab$. by assumption we can write $ss' = p_1 \ldots p_r$ for some prime elements $p_i$. for each $i$ the element $p_i$ divides either $a$ or $b$. dividing we find a factorization $x = a' b'$ and $a = s'' a'$, $b = s''' b'$ for some $s'', s''' \in s$. as $x$ is irreducible, either $a'$ or $b'$ is a unit. tracing back we find that either $\alpha$ or $\beta$ is a unit. this proves (1). \medskip\noindent suppose $x$ is prime. then $a/(x)$ is a domain. hence $s^{-1}a/xs^{-1}a = s^{-1}(a/(x))$ is a domain or zero. thus $x$ maps to a prime element or a unit. \medskip\noindent suppose that the image of $x$ in $s^{-1}a$ is a unit. then $y x = s$ for some $s \in s$ and $y \in a$. by assumption $s = p_1 \ldots p_r$ with $p_i$ a prime element. for each $i$ either $p_i$ divides $y$ or $p_i$ divides $x$. in the second case $p_i$ and $x$ are associates (as $x$ is irreducible) and we are done. but if the first case happens for all $i = 1, \ldots, r$, then $x$ is a unit which is a contradiction. \medskip\noindent suppose that the image of $x$ in $s^{-1}a$ is a prime element. assume $a, b \in a$ and $ab \in (x)$. then $sa = xy$ or $sb = xy$ for some $s \in s$ and $y \in a$. say the first case happens. by assumption $s = p_1 \ldots p_r$ with $p_i$ a prime element. for each $i$ either $p_i$ divides $y$ or $p_i$ divides $x$. in the second case $p_i$ and $x$ are associates (as $x$ is irreducible) and we are done. if the first case happens for all $i = 1, \ldots, r$, then $a \in (x)$ as desired. this completes the proof of (2). \medskip\noindent the final statement of the lemma follows from (1) and (2) and lemma \ref{lemma-characterize-ufd}. \end{proof} \begin{lemma} \label{lemma-ufd-ascending-chain-condition-principal-ideals} a ufd satisfies the ascending chain condition for principal ideals. \end{lemma} \begin{proof} consider an ascending chain $(a_1) \subset (a_2) \subset (a_3) \subset \ldots$ of principal ideals in $r$. write $a_1 = p_1^{e_1} \ldots p_r^{e_r}$ with $p_i$ prime. then we see that $a_n$ is an associate of $p_1^{c_1} \ldots p_r^{c_r}$ for some $0 \leq c_i \leq e_i$. since there are only finitely many possibilities we conclude. \end{proof} \begin{lemma} \label{lemma-factoring-in-polynomial} let $r$ be a domain. assume $r$ has the ascending chain condition for principal ideals. then the same property holds for a polynomial ring over $r$. \end{lemma} \begin{proof} consider an ascending chain $(f_1) \subset (f_2) \subset (f_3) \subset \ldots$ of principal ideals in $r[x]$. since $f_{n + 1}$ divides $f_n$ we see that the degrees decrease in the sequence. thus $f_n$ has fixed degree $d \geq 0$ for all $n \gg 0$. let $a_n$ be the leading coefficient of $f_n$. the condition $f_n \in (f_{n + 1})$ implies that $a_{n + 1}$ divides $a_n$ for all $n$. by our assumption on $r$ we see that $a_{n + 1}$ and $a_n$ are associates for all $n$ large enough (lemma \ref{lemma-easy-divisibility}). thus for large $n$ we see that $f_n = u f_{n + 1}$ where $u \in r$ (for reasons of degree) is a unit (as $a_n$ and $a_{n + 1}$ are associates). \end{proof} \begin{lemma} \label{lemma-polynomial-ring-ufd} a polynomial ring over a ufd is a ufd. in particular, if $k$ is a field, then $k[x_1, \ldots, x_n]$ is a ufd. \end{lemma} \begin{proof} let $r$ be a ufd. then $r$ satisfies the ascending chain condition for principal ideals (lemma \ref{lemma-ufd-ascending-chain-condition-principal-ideals}), hence $r[x]$ satisfies the ascending chain condition for principal ideals (lemma \ref{lemma-factoring-in-polynomial}), and hence every element of $r[x]$ has a factorization into irreducibles (lemma \ref{lemma-factorization-exists}). let $s \subset r$ be the multiplicative subset generated by prime elements. since every nonunit of $r$ is a product of prime elements we see that $k = s^{-1}r$ is the fraction field of $r$. observe that every prime element of $r$ maps to a prime element of $r[x]$ and that $s^{-1}(r[x]) = s^{-1}r[x] = k[x]$ is a ufd (and even a pid). thus we may apply lemma \ref{lemma-invert-prime-elements} to conclude. \end{proof} \begin{lemma} \label{lemma-ufd-normal} a unique factorization domain is normal. \end{lemma} \begin{proof} let $r$ be a ufd. let $x$ be an element of the fraction field of $r$ which is integral over $r$. say $x^d - a_1 x^{d - 1} - \ldots - a_d = 0$ with $a_i \in r$. we can write $x = u p_1^{e_1} \ldots p_r^{e_r}$ with $u$ a unit, $e_i \in \mathbf{z}$, and $p_1, \ldots, p_r$ irreducible elements which are not associates. to prove the lemma we have to show $e_i \geq 0$. if not, say $e_1 < 0$, then for $n \gg 0$ we get $$ u^d p_2^{de_2 + n} \ldots p_r^{de_r + n} = p_1^{-de_1}p_2^n \ldots p_r^n( \sum\nolimits_{i = 1, \ldots, d} a_i x^{d - i} ) \in (p_1) $$ which contradicts uniqueness of factorization in $r$. \end{proof} \begin{definition} \label{definition-pid} a {\it principal ideal domain}, abbreviated {\it pid}, is a domain $r$ such that every ideal is a principal ideal. \end{definition} \begin{lemma} \label{lemma-pid-ufd} a principal ideal domain is a unique factorization domain. \end{lemma} \begin{proof} as a pid is noetherian this follows from lemma \ref{lemma-characterize-ufd-height-1}. \end{proof} \begin{definition} \label{definition-dedekind-domain} a {\it dedekind domain} is a domain $r$ such that every nonzero ideal $i \subset r$ can be written as a product $$ i = \mathfrak p_1 \ldots \mathfrak p_r $$ of nonzero prime ideals uniquely up to permutation of the $\mathfrak p_i$. \end{definition} \begin{lemma} \label{lemma-pid-dedekind} a pid is a dedekind domain. \end{lemma} \begin{proof} let $r$ be a pid. since every nonzero ideal of $r$ is principal, and $r$ is a ufd (lemma \ref{lemma-pid-ufd}), this follows from the fact that every irreducible element in $r$ is prime (lemma \ref{lemma-characterize-ufd}) so that factorizations of elements turn into factorizations into primes. \end{proof} \begin{lemma} \label{lemma-product-ideals-principal} \begin{slogan} a product of ideals is an invertible module iff both factors are. \end{slogan} let $a$ be a ring. let $i$ and $j$ be nonzero ideals of $a$ such that $ij = (f)$ for some nonzerodivisor $f \in a$. then $i$ and $j$ are finitely generated ideals and finitely locally free of rank $1$ as $a$-modules. \end{lemma} \begin{proof} it suffices to show that $i$ and $j$ are finite locally free $a$-modules of rank $1$, see lemma \ref{lemma-finite-projective}. to do this, write $f = \sum_{i = 1, \ldots, n} x_i y_i$ with $x_i \in i$ and $y_i \in j$. we can also write $x_i y_i = a_i f$ for some $a_i \in a$. since $f$ is a nonzerodivisor we see that $\sum a_i = 1$. thus it suffices to show that each $i_{a_i}$ and $j_{a_i}$ is free of rank $1$ over $a_{a_i}$. after replacing $a$ by $a_{a_i}$ we conclude that $f = xy$ for some $x \in i$ and $y \in j$. note that both $x$ and $y$ are nonzerodivisors. we claim that $i = (x)$ and $j = (y)$ which finishes the proof. namely, if $x' \in i$, then $x'y = af = axy$ for some $a \in a$. hence $x' = ax$ and we win. \end{proof} \begin{lemma} \label{lemma-characterize-dedekind} let $r$ be a ring. the following are equivalent \begin{enumerate} \item $r$ is a dedekind domain, \item $r$ is a noetherian domain and for every nonzero maximal ideal $\mathfrak m$ the local ring $r_{\mathfrak m}$ is a discrete valuation ring, and \item $r$ is a noetherian, normal domain, and $\dim(r) \leq 1$. \end{enumerate} \end{lemma} \begin{proof} assume (1). the argument is nontrivial because we did not assume that $r$ was noetherian in our definition of a dedekind domain. let $\mathfrak p \subset r$ be a prime ideal. observe that $\mathfrak p \not = \mathfrak p^2$ by uniqueness of the factorizations in the definition. pick $x \in \mathfrak p$ with $x \not \in \mathfrak p^2$. let $y \in \mathfrak p$ be a second element (for example $y = 0$). write $(x, y) = \mathfrak p_1 \ldots \mathfrak p_r$. since $(x, y) \subset \mathfrak p$ at least one of the primes $\mathfrak p_i$ is contained in $\mathfrak p$. but as $x \not \in \mathfrak p^2$ there is at most one. thus exactly one of $\mathfrak p_1, \ldots, \mathfrak p_r$ is contained in $\mathfrak p$, say $\mathfrak p_1 \subset \mathfrak p$. we conclude that $(x, y)r_\mathfrak p = \mathfrak p_1r_\mathfrak p$ is prime for every choice of $y$. we claim that $(x)r_\mathfrak p = \mathfrak pr_\mathfrak p$. namely, pick $y \in \mathfrak p$. by the above applied with $y^2$ we see that $(x, y^2)r_\mathfrak p$ is prime. hence $y \in (x, y^2)r_\mathfrak p$, i.e., $y = ax + by^2$ in $r_\mathfrak p$. thus $(1 - by)y = ax \in (x)r_\mathfrak p$, i.e., $y \in (x)r_\mathfrak p$ as desired. \medskip\noindent writing $(x) = \mathfrak p_1 \ldots \mathfrak p_r$ anew with $\mathfrak p_1 \subset \mathfrak p$ we conclude that $\mathfrak p_1 r_\mathfrak p = \mathfrak p r_\mathfrak p$, i.e., $\mathfrak p_1 = \mathfrak p$. moreover, $\mathfrak p_1 = \mathfrak p$ is a finitely generated ideal of $r$ by lemma \ref{lemma-product-ideals-principal}. we conclude that $r$ is noetherian by lemma \ref{lemma-cohen}. moreover, it follows that $r_\mathfrak m$ is a discrete valuation ring for every prime ideal $\mathfrak p$, see lemma \ref{lemma-characterize-dvr}. \medskip\noindent the equivalence of (2) and (3) follows from lemmas \ref{lemma-normality-is-local} and \ref{lemma-characterize-dvr}. assume (2) and (3) are satisfied. let $i \subset r$ be an ideal. we will construct a factorization of $i$. if $i$ is prime, then there is nothing to prove. if not, pick $i \subset \mathfrak p$ with $\mathfrak p \subset r$ maximal. let $j = \{x \in r \mid x \mathfrak p \subset i\}$. we claim $j \mathfrak p = i$. it suffices to check this after localization at the maximal ideals $\mathfrak m$ of $r$ (the formation of $j$ commutes with localization and we use lemma \ref{lemma-characterize-zero-local}). then either $\mathfrak p r_\mathfrak m = r_\mathfrak m$ and the result is clear, or $\mathfrak p r_\mathfrak m = \mathfrak m r_\mathfrak m$. in the last case $\mathfrak p r_\mathfrak m = (\pi)$ and the case where $\mathfrak p$ is principal is immediate. by noetherian induction the ideal $j$ has a factorization and we obtain the desired factorization of $i$. we omit the proof of uniqueness of the factorization. \end{proof} \noindent the following is a variant of the krull-akizuki lemma. \begin{lemma} \label{lemma-integral-closure-dedekind} let $a$ be a noetherian domain of dimension $1$ with fraction field $k$. let $l/k$ be a finite extension. let $b$ be the integral closure of $a$ in $l$. then $b$ is a dedekind domain and $\spec(b) \to \spec(a)$ is surjective, has finite fibres, and induces finite residue field extensions. \end{lemma} \begin{proof} by krull-akizuki (lemma \ref{lemma-krull-akizuki}) the ring $b$ is noetherian. by lemma \ref{lemma-integral-sub-dim-equal} $\dim(b) = 1$. thus $b$ is a dedekind domain by lemma \ref{lemma-characterize-dedekind}. surjectivity of the map on spectra follows from lemma \ref{lemma-integral-overring-surjective}. the last two statements follow from lemma \ref{lemma-finite-extension-residue-fields-dimension-1}. \end{proof} \section{orders of vanishing} \label{section-orders-of-vanishing} \begin{lemma} \label{lemma-ord-additive} let $r$ be a semi-local noetherian ring of dimension $1$. if $a, b \in r$ are nonzerodivisors then $$ \text{length}_r(r/(ab)) = \text{length}_r(r/(a)) + \text{length}_r(r/(b)) $$ and these lengths are finite. \end{lemma} \begin{proof} we saw the finiteness in lemma \ref{lemma-finite-length-global}. additivity holds since there is a short exact sequence $0 \to r/(a) \to r/(ab) \to r/(b) \to 0$ where the first map is given by multiplication by $b$. (use length is additive, see lemma \ref{lemma-length-additive}.) \end{proof} \begin{definition} \label{definition-ord} suppose that $k$ is a field, and $r \subset k$ is a local\footnote{we could also define this when $r$ is only semi-local but this is probably never really what you want!} noetherian subring of dimension $1$ with fraction field $k$. in this case we define the {\it order of vanishing along $r$} $$ \text{ord}_r : k^* \longrightarrow \mathbf{z} $$ by the rule $$ \text{ord}_r(x) = \text{length}_r(r/(x)) $$ if $x \in r$ and we set $\text{ord}_r(x/y) = \text{ord}_r(x) - \text{ord}_r(y)$ for $x, y \in r$ both nonzero. \end{definition} \noindent we can use the order of vanishing to compare lattices in a vector space. here is the definition. \begin{definition} \label{definition-lattice} let $r$ be a noetherian local domain of dimension $1$ with fraction field $k$. let $v$ be a finite dimensional $k$-vector space. a {\it lattice in $v$} is a finite $r$-submodule $m \subset v$ such that $v = k \otimes_r m$. \end{definition} \noindent the condition $v = k \otimes_r m$ signifies that $m$ contains a basis for the vector space $v$. we remark that in many places in the literature the notion of a lattice may be defined only in case the ring $r$ is a discrete valuation ring. if $r$ is a discrete valuation ring then any lattice is a free $r$-module, and this may not be the case in general. \begin{lemma} \label{lemma-compare-lattices} let $r$ be a noetherian local domain of dimension $1$ with fraction field $k$. let $v$ be a finite dimensional $k$-vector space. \begin{enumerate} \item if $m$ is a lattice in $v$ and $m \subset m' \subset v$ is an $r$-submodule of $v$ containing $m$ then the following are equivalent \begin{enumerate} \item $m'$ is a lattice, \item $\text{length}_r(m'/m)$ is finite, and \item $m'$ is finitely generated. \end{enumerate} \item if $m$ is a lattice in $v$ and $m' \subset m$ is an $r$-submodule of $m$ then $m'$ is a lattice if and only if $\text{length}_r(m/m')$ is finite. \item if $m$, $m'$ are lattices in $v$, then so are $m \cap m'$ and $m + m'$. \item if $m \subset m' \subset m'' \subset v$ are lattices in $v$ then $$ \text{length}_r(m''/m) = \text{length}_r(m'/m) + \text{length}_r(m''/m'). $$ \item if $m$, $m'$, $n$, $n'$ are lattices in $v$ and $n \subset m \cap m'$, $m + m' \subset n'$, then we have \begin{eqnarray*} & & \text{length}_r(m/m \cap m') - \text{length}_r(m'/m \cap m')\\ & = & \text{length}_r(m/n) - \text{length}_r(m'/n) \\ & = & \text{length}_r(m + m' / m') - \text{length}_r(m + m'/m) \\ & = & \text{length}_r(n' / m') - \text{length}_r(n'/m) \end{eqnarray*} \end{enumerate} \end{lemma} \begin{proof} proof of (1). assume (1)(a). say $y_1, \ldots, y_m$ generate $m'$. then each $y_i = x_i/f_i$ for some $x_i \in m$ and nonzero $f_i \in r$. hence we see that $f_1 \ldots f_m m' \subset m$. since $r$ is noetherian local of dimension $1$ we see that $\mathfrak m^n \subset (f_1 \ldots f_m)$ for some $n$ (for example combine lemmas \ref{lemma-one-equation} and proposition \ref{proposition-dimension-zero-ring} or combine lemmas \ref{lemma-finite-length} and \ref{lemma-length-infinite}). in other words $\mathfrak m^nm' \subset m$ for some $n$ hence $\text{length}(m'/m) < \infty$ by lemma \ref{lemma-length-finite}, in other words (1)(b) holds. assume (1)(b). then $m'/m$ is a finite $r$-module (see lemma \ref{lemma-finite-length-finite}). hence $m'$ is a finite $r$-module as an extension of finite $r$-modules. hence (1)(c). the implication (1)(c) $\rightarrow$ (1)(a) follows from the remark following definition \ref{definition-lattice}. \medskip\noindent proof of (2). suppose $m$ is a lattice in $v$ and $m' \subset m$ is an $r$-submodule. we have seen in (1) that if $m'$ is a lattice, then $\text{length}_r(m/m') < \infty$. conversely, assume that $\text{length}_r(m/m') < \infty$. then $m'$ is finitely generated as $r$ is noetherian and for some $n$ we have $\mathfrak m^n m \subset m'$ (lemma \ref{lemma-length-infinite}). hence it follows that $m'$ contains a basis for $v$, and $m'$ is a lattice. \medskip\noindent proof of (3). assume $m$, $m'$ are lattices in $v$. since $r$ is noetherian the submodule $m \cap m'$ of $m$ is finite. as $m$ is a lattice we can find $x_1, \ldots, x_n \in m$ which form a $k$-basis for $v$. because $m'$ is a lattice we can write $x_i = y_i/f_i$ with $y_i \in m'$ and $f_i \in r$. hence $f_ix_i \in m \cap m'$. hence $m \cap m'$ is a lattice also. the fact that $m + m'$ is a lattice follows from part (1). \medskip\noindent part (4) follows from additivity of lengths (lemma \ref{lemma-length-additive}) and the exact sequence $$ 0 \to m'/m \to m''/m \to m''/m' \to 0 $$ part (5) follows from repeatedly applying part (4). \end{proof} \begin{definition} \label{definition-distance} let $r$ be a noetherian local domain of dimension $1$ with fraction field $k$. let $v$ be a finite dimensional $k$-vector space. let $m$, $m'$ be two lattices in $v$. the {\it distance between $m$ and $m'$} is the integer $$ d(m, m') = \text{length}_r(m/m \cap m') - \text{length}_r(m'/m \cap m') $$ of lemma \ref{lemma-compare-lattices} part (5). \end{definition} \noindent in particular, if $m' \subset m$, then $d(m, m') = \text{length}_r(m/m')$. \begin{lemma} \label{lemma-properties-distance-function} let $r$ be a noetherian local domain of dimension $1$ with fraction field $k$. let $v$ be a finite dimensional $k$-vector space. this distance function has the property that $$ d(m, m'') = d(m, m') + d(m', m'') $$ whenever given three lattices $m$, $m'$, $m''$ of $v$. in particular we have $d(m, m') = - d(m', m)$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-order-vanishing-determinant} let $r$ be a noetherian local domain of dimension $1$ with fraction field $k$. let $v$ be a finite dimensional $k$-vector space. let $\varphi : v \to v$ be a $k$-linear isomorphism. for any lattice $m \subset v$ we have $$ d(m, \varphi(m)) = \text{ord}_r(\det(\varphi)) $$ \end{lemma} \begin{proof} we can see that the integer $d(m, \varphi(m))$ does not depend on the lattice $m$ as follows. suppose that $m'$ is a second such lattice. then we see that \begin{eqnarray*} d(m, \varphi(m)) & = & d(m, m') + d(m', \varphi(m)) \\ & = & d(m, m') + d(\varphi(m'), \varphi(m)) + d(m', \varphi(m')) \end{eqnarray*} since $\varphi$ is an isomorphism we see that $d(\varphi(m'), \varphi(m)) = d(m', m) = -d(m, m')$, and hence $d(m, \varphi(m)) = d(m', \varphi(m'))$. moreover, both sides of the equation (of the lemma) are additive in $\varphi$, i.e., $$ \text{ord}_r(\det(\varphi \circ \psi)) = \text{ord}_r(\det(\varphi)) + \text{ord}_r(\det(\psi)) $$ and also \begin{eqnarray*} d(m, \varphi(\psi((m))) & = & d(m, \psi(m)) + d(\psi(m), \varphi(\psi(m))) \\ & = & d(m, \psi(m)) + d(m, \varphi(m)) \end{eqnarray*} by the independence shown above. hence it suffices to prove the lemma for generators of $\text{gl}(v)$. choose an isomorphism $k^{\oplus n} \cong v$. then $\text{gl}(v) = \text{gl}_n(k)$ is generated by elementary matrices $e$. the result is clear for $e$ equal to the identity matrix. if $e = e_{ij}(\lambda)$ with $i \not = j$, $\lambda \in k$, $\lambda \not = 0$, for example $$ e_{12}(\lambda) = \left( \begin{matrix} 1 & \lambda & \ldots \\ 0 & 1 & \ldots \\ \ldots & \ldots & \ldots \end{matrix} \right) $$ then with respect to a different basis we get $e_{12}(1)$. the result is clear for $e = e_{12}(1)$ by taking as lattice $r^{\oplus n} \subset k^{\oplus n}$. finally, if $e = e_i(a)$, with $a \in k^*$ for example $$ e_1(a) = \left( \begin{matrix} a & 0 & \ldots \\ 0 & 1 & \ldots \\ \ldots & \ldots & \ldots \end{matrix} \right) $$ then $e_1(a)(r^{\oplus b}) = ar \oplus r^{\oplus n - 1}$ and it is clear that $d(r^{\oplus n}, ar \oplus r^{\oplus n - 1}) = \text{ord}_r(a)$ as desired. \end{proof} \begin{lemma} \label{lemma-finite-extension-dim-1} let $a \to b$ be a ring map. assume \begin{enumerate} \item $a$ is a noetherian local domain of dimension $1$, \item $a \subset b$ is a finite extension of domains. \end{enumerate} let $l/k$ be the corresponding finite extension of fraction fields. let $y \in l^*$ and $x = \text{nm}_{l/k}(y)$. in this situation $b$ is semi-local. let $\mathfrak m_i$, $i = 1, \ldots, n$ be the maximal ideals of $b$. then $$ \text{ord}_a(x) = \sum\nolimits_i [\kappa(\mathfrak m_i) : \kappa(\mathfrak m_a)] \text{ord}_{b_{\mathfrak m_i}}(y) $$ where $\text{ord}$ is defined as in definition \ref{definition-ord}. \end{lemma} \begin{proof} the ring $b$ is semi-local by lemma \ref{lemma-finite-in-codim-1}. write $y = b/b'$ for some $b, b' \in b$. by the additivity of $\text{ord}$ and multiplicativity of $\text{nm}$ it suffices to prove the lemma for $y = b$ or $y = b'$. in other words we may assume $y \in b$. in this case the right hand side of the formula is $$ \sum [\kappa(\mathfrak m_i) : \kappa(\mathfrak m_a)] \text{length}_{b_{\mathfrak m_i}}((b/yb)_{\mathfrak m_i}) $$ by lemma \ref{lemma-pushdown-module} this is equal to $\text{length}_a(b/yb)$. by lemma \ref{lemma-order-vanishing-determinant} we have $$ \text{length}_a(b/yb) = d(b, yb) = \text{ord}_a(\det\nolimits_k(l \xrightarrow{y} l)). $$ since $x = \text{nm}_{l/k}(y) = \det\nolimits_k(l \xrightarrow{y} l)$ by definition the lemma is proved. \end{proof} \section{quasi-finite maps} \label{section-quasi-finite} \noindent consider a ring map $r \to s$ of finite type. a map $\spec(s) \to \spec(r)$ is quasi-finite at a point if that point is isolated in its fibre. this means that the fibre is zero dimensional at that point. in this section we study the basic properties of this important but technical notion. more advanced material can be found in the next section. \begin{lemma} \label{lemma-isolated-point} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $\mathfrak q$ be a prime of $s$. the following are equivalent: \begin{enumerate} \item $\mathfrak q$ is an isolated point of $\spec(s)$, \item $s_{\mathfrak q}$ is finite over $k$, \item there exists a $g \in s$, $g \not\in \mathfrak q$ such that $d(g) = \{ \mathfrak q \}$, \item $\dim_{\mathfrak q} \spec(s) = 0$, \item $\mathfrak q$ is a closed point of $\spec(s)$ and $\dim(s_{\mathfrak q}) = 0$, and \item the field extension $\kappa(\mathfrak q)/k$ is finite and $\dim(s_{\mathfrak q}) = 0$. \end{enumerate} in this case $s = s_{\mathfrak q} \times s'$ for some finite type $k$-algebra $s'$. also, the element $g$ as in (3) has the property $s_{\mathfrak q} = s_g$. \end{lemma} \begin{proof} suppose $\mathfrak q$ is an isolated point of $\spec(s)$, i.e., $\{\mathfrak q\}$ is open in $\spec(s)$. because $\spec(s)$ is a jacobson space (see lemmas \ref{lemma-finite-type-field-jacobson} and \ref{lemma-jacobson}) we see that $\mathfrak q$ is a closed point. hence $\{\mathfrak q\}$ is open and closed in $\spec(s)$. by lemmas \ref{lemma-disjoint-decomposition} and \ref{lemma-disjoint-implies-product} we may write $s = s_1 \times s_2$ with $\mathfrak q$ corresponding to the only point $\spec(s_1)$. hence $s_1 = s_{\mathfrak q}$ is a zero dimensional ring of finite type over $k$. hence it is finite over $k$ for example by lemma \ref{lemma-noether-normalization}. we have proved (1) implies (2). \medskip\noindent suppose $s_{\mathfrak q}$ is finite over $k$. then $s_{\mathfrak q}$ is artinian local, see lemma \ref{lemma-finite-dimensional-algebra}. so $\spec(s_{\mathfrak q}) = \{\mathfrak qs_{\mathfrak q}\}$ by lemma \ref{lemma-artinian-finite-length}. consider the exact sequence $0 \to k \to s \to s_{\mathfrak q} \to q \to 0$. it is clear that $k_{\mathfrak q} = q_{\mathfrak q} = 0$. also, $k$ is a finite $s$-module as $s$ is noetherian and $q$ is a finite $s$-module since $s_{\mathfrak q}$ is finite over $k$. hence there exists $g \in s$, $g \not \in \mathfrak q$ such that $k_g = q_g = 0$. thus $s_{\mathfrak q} = s_g$ and $d(g) = \{ \mathfrak q \}$. we have proved that (2) implies (3). \medskip\noindent suppose $d(g) = \{ \mathfrak q \}$. since $d(g)$ is open by construction of the topology on $\spec(s)$ we see that $\mathfrak q$ is an isolated point of $\spec(s)$. we have proved that (3) implies (1). in other words (1), (2) and (3) are equivalent. \medskip\noindent assume $\dim_{\mathfrak q} \spec(s) = 0$. this means that there is some open neighbourhood of $\mathfrak q$ in $\spec(s)$ which has dimension zero. then there is an open neighbourhood of the form $d(g)$ which has dimension zero. since $s_g$ is noetherian we conclude that $s_g$ is artinian and $d(g) = \spec(s_g)$ is a finite discrete set, see proposition \ref{proposition-dimension-zero-ring}. thus $\mathfrak q$ is an isolated point of $d(g)$ and, by the equivalence of (1) and (2) above applied to $\mathfrak qs_g \subset s_g$, we see that $s_{\mathfrak q} = (s_g)_{\mathfrak qs_g}$ is finite over $k$. hence (4) implies (2). it is clear that (1) implies (4). thus (1) -- (4) are all equivalent. \medskip\noindent lemma \ref{lemma-dimension-closed-point-finite-type-field} gives the implication (5) $\rightarrow$ (4). the implication (4) $\rightarrow$ (6) follows from lemma \ref{lemma-dimension-at-a-point-finite-type-field}. the implication (6) $\rightarrow$ (5) follows from lemma \ref{lemma-finite-residue-extension-closed}. at this point we know (1) -- (6) are equivalent. \medskip\noindent the two statements at the end of the lemma we saw during the course of the proof of the equivalence of (1), (2) and (3) above. \end{proof} \begin{lemma} \label{lemma-isolated-point-fibre} \begin{slogan} equivalent conditions for isolated points in fibres \end{slogan} let $r \to s$ be a ring map of finite type. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$. let $f = \spec(s \otimes_r \kappa(\mathfrak p))$ be the fibre of $\spec(s) \to \spec(r)$, see remark \ref{remark-fundamental-diagram}. denote $\overline{\mathfrak q} \in f$ the point corresponding to $\mathfrak q$. the following are equivalent \begin{enumerate} \item $\overline{\mathfrak q}$ is an isolated point of $f$, \item $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ is finite over $\kappa(\mathfrak p)$, \item there exists a $g \in s$, $g \not \in \mathfrak q$ such that the only prime of $d(g)$ mapping to $\mathfrak p$ is $\mathfrak q$, \item $\dim_{\overline{\mathfrak q}}(f) = 0$, \item $\overline{\mathfrak q}$ is a closed point of $f$ and $\dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) = 0$, and \item the field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is finite and $\dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) = 0$. \end{enumerate} \end{lemma} \begin{proof} note that $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q} = (s \otimes_r \kappa(\mathfrak p))_{\overline{\mathfrak q}}$. moreover $s \otimes_r \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$. the conditions correspond exactly to the conditions of lemma \ref{lemma-isolated-point} for the $\kappa(\mathfrak p)$-algebra $s \otimes_r \kappa(\mathfrak p)$ and the prime $\overline{\mathfrak q}$, hence they are equivalent. \end{proof} \begin{definition} \label{definition-quasi-finite} let $r \to s$ be a finite type ring map. let $\mathfrak q \subset s$ be a prime. \begin{enumerate} \item if the equivalent conditions of lemma \ref{lemma-isolated-point-fibre} are satisfied then we say $r \to s$ is {\it quasi-finite at $\mathfrak q$}. \item we say a ring map $a \to b$ is {\it quasi-finite} if it is of finite type and quasi-finite at all primes of $b$. \end{enumerate} \end{definition} \begin{lemma} \label{lemma-quasi-finite-above-p} let $r \to s$ be a finite type ring map and $\mathfrak p$ be a prime ideal of $r$. then the following are equivalent: \begin{enumerate} \item $r \to s$ is quasi-finite at all primes of $s$ lying over $\mathfrak p$, \item $s \otimes_r \kappa(\mathfrak p)$ is a finite $\kappa(\mathfrak p)$-algebra, and \item $\spec(s \otimes_r \kappa(\mathfrak p))$ is a finite set. \end{enumerate} \end{lemma} \begin{proof} condition (1) says the topology on $\spec(s \otimes_r \kappa(\mathfrak p))$ is discrete (as every point is open). hence the equivalence of (1), (2), (3) follows from lemma \ref{lemma-finite-type-algebra-finite-nr-primes}. \end{proof} \begin{lemma} \label{lemma-quasi-finite} let $r \to s$ be a finite type ring map. then $r \to s$ is quasi-finite if and only if for all primes $\mathfrak p \subset r$ the ring $s \otimes_r \kappa(\mathfrak p)$ is finite over $\kappa(\mathfrak p)$. \end{lemma} \begin{proof} follows immediately from the more general lemma \ref{lemma-quasi-finite-above-p}. \end{proof} \begin{lemma} \label{lemma-quasi-finite-local} let $r \to s$ be a finite type ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$. let $f \in r$, $f \not \in \mathfrak p$ and $g \in s$, $g \not \in \mathfrak q$. then $r \to s$ is quasi-finite at $\mathfrak q$ if and only if $r_f \to s_{fg}$ is quasi-finite at $\mathfrak qs_{fg}$. \end{lemma} \begin{proof} the fibre of $\spec(s_{fg}) \to \spec(r_f)$ is homeomorphic to an open subset of the fibre of $\spec(s) \to \spec(r)$. hence the lemma follows from part (1) of the equivalent conditions of lemma \ref{lemma-isolated-point-fibre}. \end{proof} \begin{lemma} \label{lemma-four-rings} let $$ \xymatrix{ s \ar[r] & s' & & \mathfrak q \ar@{-}[r] & \mathfrak q' \\ r \ar[u] \ar[r] & r' \ar[u] & & \mathfrak p \ar@{-}[r] \ar@{-}[u] & \mathfrak p' \ar@{-}[u] } $$ be a commutative diagram of rings with primes as indicated. assume $r \to s$ of finite type, and $s \otimes_r r' \to s'$ surjective. if $r \to s$ is quasi-finite at $\mathfrak q$, then $r' \to s'$ is quasi-finite at $\mathfrak q'$. \end{lemma} \begin{proof} write $s \otimes_r \kappa(\mathfrak p) = s_1 \times s_2$ with $s_1$ finite over $\kappa(\mathfrak p)$ and such that $\mathfrak q$ corresponds to a point of $s_1$ as in lemma \ref{lemma-isolated-point}. this product decomposition induces a corresponding product decomposition for any $s \otimes_r \kappa(\mathfrak p)$-algebra. in particular, we obtain $s' \otimes_{r'} \kappa(\mathfrak p') = s'_1 \times s'_2$. because $s \otimes_r r' \to s'$ is surjective the canonical map $(s \otimes_r \kappa(\mathfrak p)) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p') \to s' \otimes_{r'} \kappa(\mathfrak p')$ is surjective and hence $s_i \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p') \to s'_i$ is surjective. it follows that $s'_1$ is finite over $\kappa(\mathfrak p')$. the map $s' \otimes_{r'} \kappa(\mathfrak p') \to \kappa(\mathfrak q')$ factors through $s_1'$ (i.e.\ it annihilates the factor $s_2'$) because the map $s \otimes_r \kappa(\mathfrak p) \to \kappa(\mathfrak q)$ factors through $s_1$ (i.e.\ it annihilates the factor $s_2$). thus $\mathfrak q'$ corresponds to a point of $\spec(s_1')$ in the disjoint union decomposition of the fibre: $\spec(s' \otimes_{r'} \kappa(\mathfrak p')) = \spec(s_1') \amalg \spec(s_2')$, see lemma \ref{lemma-spec-product}. since $s_1'$ is finite over a field, it is artinian ring, and hence $\spec(s_1')$ is a finite discrete set. (see proposition \ref{proposition-dimension-zero-ring}.) we conclude $\mathfrak q'$ is isolated in its fibre as desired. \end{proof} \begin{lemma} \label{lemma-quasi-finite-composition} a composition of quasi-finite ring maps is quasi-finite. \end{lemma} \begin{proof} suppose $a \to b$ and $b \to c$ are quasi-finite ring maps. by lemma \ref{lemma-compose-finite-type} we see that $a \to c$ is of finite type. let $\mathfrak r \subset c$ be a prime of $c$ lying over $\mathfrak q \subset b$ and $\mathfrak p \subset a$. since $a \to b$ and $b \to c$ are quasi-finite at $\mathfrak q$ and $\mathfrak r$ respectively, then there exist $b \in b$ and $c \in c$ such that $\mathfrak q$ is the only prime of $d(b)$ which maps to $\mathfrak p$ and similarly $\mathfrak r$ is the only prime of $d(c)$ which maps to $\mathfrak q$. if $c' \in c$ is the image of $b \in b$, then $\mathfrak r$ is the only prime of $d(cc')$ which maps to $\mathfrak p$. therefore $a \to c$ is quasi-finite at $\mathfrak r$. \end{proof} \begin{lemma} \label{lemma-quasi-finite-base-change} let $r \to s$ be a ring map of finite type. let $r \to r'$ be any ring map. set $s' = r' \otimes_r s$. \begin{enumerate} \item the set $\{\mathfrak q' \mid r' \to s' \text{ quasi-finite at }\mathfrak q'\}$ is the inverse image of the corresponding set of $\spec(s)$ under the canonical map $\spec(s') \to \spec(s)$. \item if $\spec(r') \to \spec(r)$ is surjective, then $r \to s$ is quasi-finite if and only if $r' \to s'$ is quasi-finite. \item any base change of a quasi-finite ring map is quasi-finite. \end{enumerate} \end{lemma} \begin{proof} let $\mathfrak p' \subset r'$ be a prime lying over $\mathfrak p \subset r$. then the fibre ring $s' \otimes_{r'} \kappa(\mathfrak p')$ is the base change of the fibre ring $s \otimes_r \kappa(\mathfrak p)$ by the field extension $\kappa(\mathfrak p) \to \kappa(\mathfrak p')$. hence the first assertion follows from the invariance of dimension under field extension (lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}) and lemma \ref{lemma-isolated-point}. the stability of quasi-finite maps under base change follows from this and the stability of finite type property under base change. the second assertion follows since the assumption implies that given a prime $\mathfrak q \subset s$ we can find a prime $\mathfrak q' \subset s'$ lying over it. \end{proof} \begin{lemma} \label{lemma-quasi-finite-permanence} let $a \to b$ and $b \to c$ be ring homomorphisms such that $a \to c$ is of finite type. let $\mathfrak r$ be a prime of $c$ lying over $\mathfrak q \subset b$ and $\mathfrak p \subset a$. if $a \to c$ is quasi-finite at $\mathfrak r$, then $b \to c$ is quasi-finite at $\mathfrak r$. \end{lemma} \begin{proof} observe that $b \to c$ is of finite type (lemma \ref{lemma-compose-finite-type}) so that the statement makes sense. let us use characterization (3) of lemma \ref{lemma-isolated-point-fibre}. if $a \to c$ is quasi-finite at $\mathfrak r$, then there exists some $c \in c$ such that $$ \{\mathfrak r' \subset c \text{ lying over }\mathfrak p\} \cap d(c) = \{\mathfrak{r}\}. $$ since the primes $\mathfrak r' \subset c$ lying over $\mathfrak q$ form a subset of the primes $\mathfrak r' \subset c$ lying over $\mathfrak p$ we conclude $b \to c$ is quasi-finite at $\mathfrak r$. \end{proof} \begin{lemma} \label{lemma-generically-finite} let $r \to s$ be a ring map of finite type. let $\mathfrak p \subset r$ be a minimal prime. assume that there are at most finitely many primes of $s$ lying over $\mathfrak p$. then there exists a $g \in r$, $g \not \in \mathfrak p$ such that the ring map $r_g \to s_g$ is finite. \end{lemma} \begin{proof} let $x_1, \ldots, x_n$ be generators of $s$ over $r$. by lemma \ref{lemma-quasi-finite-above-p} the assumption means that $s \otimes_r \kappa(\mathfrak p) = s_{\mathfrak p}/\mathfrak ps_{\mathfrak p}$ is a finite $\kappa(\mathfrak p)$-algebra. thus we may find monic polynomials $p_i \in r_{\mathfrak p}[x]$ such that $p_i(x_i)$ maps to zero in $s_{\mathfrak p}/\mathfrak ps_{\mathfrak p}$. since $\mathfrak p$ is a minimal prime, $\mathfrak pr_{\mathfrak p}$ is a locally nilpotent ideal, see lemma \ref{lemma-minimal-prime-reduced-ring}. hence $\mathfrak ps_{\mathfrak p}$ is a locally nilpotent ideal, see lemma \ref{lemma-locally-nilpotent}. thus there exist $e_i \geq 1$ such that $p(x_i)^{e_i} = 0$ in $s_{\mathfrak p}$. let $g_1 \in r$, $g_1 \not \in \mathfrak p$ be an element such that $p_i$ has coefficients in $r[1/g_1]$ for all $i$. next, let $g_2 \in r$, $g_2 \not \in \mathfrak p$ be an element such that $p(x_i)^{e_i} = 0$ in $s_{g_1g_2}$. setting $g = g_1g_2$ we win. \end{proof} \section{zariski's main theorem} \label{section-zariski} \noindent in this section our aim is to prove the algebraic version of zariski's main theorem. this theorem will be the basis of many further developments in the theory of schemes and morphisms of schemes later in the stacks project. \medskip\noindent let $r \to s$ be a ring map of finite type. our goal in this section is to show that the set of points of $\spec(s)$ where the map is quasi-finite is {\it open} (theorem \ref{theorem-main-theorem}). in fact, it will turn out that there exists a finite ring map $r \to s'$ such that in some sense the quasi-finite locus of $s/r$ is open in $\spec(s')$ (but we will not prove this in the algebra chapter since we do not develop the language of schemes here -- for the case where $r \to s$ is quasi-finite see lemma \ref{lemma-quasi-finite-open-integral-closure}). these statements are somewhat tricky to prove and we do it by a long list of lemmas concerning integral and finite extensions of rings. this material may be found in \cite{henselian}, and \cite{peskine}. we also found notes by thierry coquand helpful. \begin{lemma} \label{lemma-make-integral-trivial} let $\varphi : r \to s$ be a ring map. suppose $t \in s$ satisfies the relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$. then $\varphi(a_n)t$ is integral over $r$. \end{lemma} \begin{proof} namely, multiply the equation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$ with $\varphi(a_n)^{n-1}$ and write it as $\varphi(a_0 a_n^{n-1}) + \varphi(a_1 a_n^{n-2}) (\varphi(a_n)t) + \ldots + (\varphi(a_n) t)^n = 0$. \end{proof} \noindent the following lemma is in some sense the key lemma in this section. \begin{lemma} \label{lemma-make-integral-trick} let $r$ be a ring. let $\varphi : r[x] \to s$ be a ring map. let $t \in s$. assume that (a) $t$ is integral over $r[x]$, and (b) there exists a monic $p \in r[x]$ such that $t \varphi(p) \in \im(\varphi)$. then there exists a $q \in r[x]$ such that $t - \varphi(q)$ is integral over $r$. \end{lemma} \begin{proof} write $t \varphi(p) = \varphi(r)$ for some $r \in r[x]$. using euclidean division, write $r = qp + r'$ with $q, r' \in r[x]$ and $\deg(r') < \deg(p)$. we may replace $t$ by $t - \varphi(q)$ which is still integral over $r[x]$, so that we obtain $t \varphi(p) = \varphi(r')$. in the ring $s_t$ we may write this as $\varphi(p) - (1/t) \varphi(r') = 0$. this implies that $\varphi(x)$ gives an element of the localization $s_t$ which is integral over $\varphi(r)[1/t] \subset s_t$. on the other hand, $t$ is integral over the subring $\varphi(r)[\varphi(x)] \subset s$. combined we conclude that $t$ is integral over the subring $\varphi(r)[1/t] \subset s_t$, see lemma \ref{lemma-integral-transitive}. in other words there exists an equation of the form $$ t^d + \sum\nolimits_{i < d} \left(\sum\nolimits_{j = 0, \ldots, n_i} \varphi(r_{i, j})/t^j\right) t^i = 0 $$ in $s_t$ with $r_{i, j} \in r$. this means that $t^{d + n} + \sum_{i < d} \sum_{j = 0, \ldots, n_i} \varphi(r_{i, j}) t^{i + n - j} = 0$ in $s$ for some $n$ large enough. in other words $t$ is integral over $r$. \end{proof} \begin{lemma} \label{lemma-combine-lemmas} let $r$ be a ring. let $\varphi : r[x] \to s$ be a ring map. let $t \in s$. assume $t$ is integral over $r[x]$. let $p \in r[x]$, $p = a_0 + a_1x + \ldots + a_k x^k$ such that $t \varphi(p) \in \im(\varphi)$. then there exists a $q \in r[x]$ and $n \geq 0$ such that $\varphi(a_k)^n t - \varphi(q)$ is integral over $r$. \end{lemma} \begin{proof} let $r'$ and $s'$ be the localization of $r$ and $s$ at the element $a_k$. let $\varphi' : r'[x] \to s'$ be the localization of $\varphi$. let $t' \in s'$ be the image of $t$. set $p' = p/a_k \in r'[x]$. then $t' \varphi'(p') \in \im(\varphi')$ since $t \varphi(p) \in \im(\varphi)$. as $p'$ is monic, by lemma \ref{lemma-make-integral-trick} there exists a $q' \in r'[x]$ such that $t' - \varphi'(q')$ is integral over $r'$. we may choose an $n \geq 0$ and an element $q \in r[x]$ such that $a_k^n q'$ is the image of $q$. then $\varphi(a_k)^n t - \varphi(q)$ is an element of $s$ whose image in $s'$ is integral over $r'$. by lemma \ref{lemma-integral-closure-localize} there exists an $m \geq 0$ such that $\varphi(a_k)^m(\varphi(a_k)^n t - \varphi(q))$ is integral over $r$. thus $\varphi(a_k)^{m + n}t - \varphi(a_k^m q)$ is integral over $r$ as desired. \end{proof} \begin{situation} \label{situation-one-transcendental-element} let $r$ be a ring. let $\varphi : r[x] \to s$ be finite. let $$ j = \{ g \in s \mid gs \subset \im(\varphi)\} $$ be the ``conductor ideal'' of $\varphi$. assume $\varphi(r) \subset s$ integrally closed in $s$. \end{situation} \begin{lemma} \label{lemma-leading-coefficient-in-j} in situation \ref{situation-one-transcendental-element}. suppose $u \in s$, $a_0, \ldots, a_k \in r$, $u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in j$. then there exists an $m \geq 0$ such that $u \varphi(a_k)^m \in j$. \end{lemma} \begin{proof} assume that $s$ is generated by $t_1, \ldots, t_n$ as an $r[x]$-module. in this case $j = \{ g \in s \mid gt_i \in \im(\varphi)\text{ for all }i\}$. note that each element $u t_i$ is integral over $r[x]$, see lemma \ref{lemma-finite-is-integral}. we have $\varphi(a_0 + a_1x + \ldots + a_k x^k) u t_i \in \im(\varphi)$. by lemma \ref{lemma-combine-lemmas}, for each $i$ there exists an integer $n_i$ and an element $q_i \in r[x]$ such that $\varphi(a_k^{n_i}) u t_i - \varphi(q_i)$ is integral over $r$. by assumption this element is in $\varphi(r)$ and hence $\varphi(a_k^{n_i}) u t_i \in \im(\varphi)$. it follows that $m = \max\{n_1, \ldots, n_n\}$ works. \end{proof} \begin{lemma} \label{lemma-all-coefficients-in-j} in situation \ref{situation-one-transcendental-element}. suppose $u \in s$, $a_0, \ldots, a_k \in r$, $u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in \sqrt{j}$. then $u \varphi(a_i) \in \sqrt{j}$ for all $i$. \end{lemma} \begin{proof} under the assumptions of the lemma we have $u^n \varphi(a_0 + a_1x + \ldots + a_k x^k)^n \in j$ for some $n \geq 1$. by lemma \ref{lemma-leading-coefficient-in-j} we deduce $u^n \varphi(a_k^{nm}) \in j$ for some $m \geq 1$. thus $u \varphi(a_k) \in \sqrt{j}$, and so $u \varphi(a_0 + a_1x + \ldots + a_k x^k) - u \varphi(a_k x^k) = u \varphi(a_0 + a_1x + \ldots + a_{k-1} x^{k-1}) \in \sqrt{j}$. we win by induction on $k$. \end{proof} \noindent this lemma suggests the following definition. \begin{definition} \label{definition-strongly-transcendental} given an inclusion of rings $r \subset s$ and an element $x \in s$ we say that $x$ is {\it strongly transcendental over $r$} if whenever $u(a_0 + a_1 x + \ldots + a_k x^k) = 0$ with $u \in s$ and $a_i \in r$, then we have $ua_i = 0$ for all $i$. \end{definition} \noindent note that if $s$ is a domain then this is the same as saying that $x$ as an element of the fraction field of $s$ is transcendental over the fraction field of $r$. \begin{lemma} \label{lemma-reduced-strongly-transcendental-minimal-prime} suppose $r \subset s$ is an inclusion of reduced rings and suppose that $x \in s$ is strongly transcendental over $r$. let $\mathfrak q \subset s$ be a minimal prime and let $\mathfrak p = r \cap \mathfrak q$. then the image of $x$ in $s/\mathfrak q$ is strongly transcendental over the subring $r/\mathfrak p$. \end{lemma} \begin{proof} suppose $u(a_0 + a_1x + \ldots + a_k x^k) \in \mathfrak q$. by lemma \ref{lemma-minimal-prime-reduced-ring} the local ring $s_{\mathfrak q}$ is a field, and hence $u(a_0 + a_1x + \ldots + a_k x^k) $ is zero in $s_{\mathfrak q}$. thus $uu'(a_0 + a_1x + \ldots + a_k x^k) = 0$ for some $u' \in s$, $u' \not\in \mathfrak q$. since $x$ is strongly transcendental over $r$ we get $uu'a_i = 0$ for all $i$. this in turn implies that $ua_i \in \mathfrak q$. \end{proof} \begin{lemma} \label{lemma-domains-transcendental-not-quasi-finite} suppose $r\subset s$ is an inclusion of domains and let $x \in s$. assume $x$ is (strongly) transcendental over $r$ and that $s$ is finite over $r[x]$. then $r \to s$ is not quasi-finite at any prime of $s$. \end{lemma} \begin{proof} as a first case, assume that $r$ is normal, see definition \ref{definition-ring-normal}. by lemma \ref{lemma-polynomial-ring-normal} we see that $r[x]$ is normal. take a prime $\mathfrak q \subset s$, and set $\mathfrak p = r \cap \mathfrak q$. assume that the extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite. this would be the case if $r \to s$ is quasi-finite at $\mathfrak q$. let $\mathfrak r = r[x] \cap \mathfrak q$. then since $\kappa(\mathfrak p) \subset \kappa(\mathfrak r) \subset \kappa(\mathfrak q)$ we see that the extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak r)$ is finite too. thus the inclusion $\mathfrak r \supset \mathfrak p r[x]$ is strict. by going down for $r[x] \subset s$, see proposition \ref{proposition-going-down-normal-integral}, we find a prime $\mathfrak q' \subset \mathfrak q$, lying over the prime $\mathfrak pr[x]$. hence the fibre $\spec(s \otimes_r \kappa(\mathfrak p))$ contains a point not equal to $\mathfrak q$, namely $\mathfrak q'$, whose closure contains $\mathfrak q$ and hence $\mathfrak q$ is not isolated in its fibre. \medskip\noindent if $r$ is not normal, let $r \subset r' \subset k$ be the integral closure $r'$ of $r$ in its field of fractions $k$. let $s \subset s' \subset l$ be the subring $s'$ of the field of fractions $l$ of $s$ generated by $r'$ and $s$. note that by construction the map $s \otimes_r r' \to s'$ is surjective. this implies that $r'[x] \subset s'$ is finite. also, the map $s \subset s'$ induces a surjection on $\spec$, see lemma \ref{lemma-integral-overring-surjective}. we conclude by lemma \ref{lemma-four-rings} and the normal case we just discussed. \end{proof} \begin{lemma} \label{lemma-reduced-strongly-transcendental-not-quasi-finite} suppose $r \subset s$ is an inclusion of reduced rings. assume $x \in s$ be strongly transcendental over $r$, and $s$ finite over $r[x]$. then $r \to s$ is not quasi-finite at any prime of $s$. \end{lemma} \begin{proof} let $\mathfrak q \subset s$ be any prime. choose a minimal prime $\mathfrak q' \subset \mathfrak q$. according to lemmas \ref{lemma-reduced-strongly-transcendental-minimal-prime} and \ref{lemma-domains-transcendental-not-quasi-finite} the extension $r/(r \cap \mathfrak q') \subset s/\mathfrak q'$ is not quasi-finite at the prime corresponding to $\mathfrak q$. by lemma \ref{lemma-four-rings} the extension $r \to s$ is not quasi-finite at $\mathfrak q$. \end{proof} \begin{lemma} \label{lemma-quasi-finite-monogenic} let $r$ be a ring. let $s = r[x]/i$. let $\mathfrak q \subset s$ be a prime. assume $r \to s$ is quasi-finite at $\mathfrak q$. let $s' \subset s$ be the integral closure of $r$ in $s$. then there exists an element $g \in s'$, $g \not\in \mathfrak q$ such that $s'_g \cong s_g$. \end{lemma} \begin{proof} let $\mathfrak p$ be the image of $\mathfrak q$ in $\spec(r)$. there exists an $f \in i$, $f = a_nx^n + \ldots + a_0$ such that $a_i \not \in \mathfrak p$ for some $i$. namely, otherwise the fibre ring $s \otimes_r \kappa(\mathfrak p)$ would be $\kappa(\mathfrak p)[x]$ and the map would not be quasi-finite at any prime lying over $\mathfrak p$. we conclude there exists a relation $b_m x^m + \ldots + b_0 = 0$ with $b_j \in s'$, $j = 0, \ldots, m$ and $b_j \not \in \mathfrak q \cap s'$ for some $j$. we prove the lemma by induction on $m$. the base case is $m = 0$ is vacuous (because the statements $b_0 = 0$ and $b_0 \not \in \mathfrak q$ are contradictory). \medskip\noindent the case $b_m \not \in \mathfrak q$. in this case $x$ is integral over $s'_{b_m}$, in fact $b_mx \in s'$ by lemma \ref{lemma-make-integral-trivial}. hence the injective map $s'_{b_m} \to s_{b_m}$ is also surjective, i.e., an isomorphism as desired. \medskip\noindent the case $b_m \in \mathfrak q$. in this case we have $b_mx \in s'$ by lemma \ref{lemma-make-integral-trivial}. set $b'_{m - 1} = b_mx + b_{m - 1}$. then $$ b'_{m - 1}x^{m - 1} + b_{m - 2}x^{m - 2} + \ldots + b_0 = 0 $$ since $b'_{m - 1}$ is congruent to $b_{m - 1}$ modulo $s' \cap \mathfrak q$ we see that it is still the case that one of $b'_{m - 1}, b_{m - 2}, \ldots, b_0$ is not in $s' \cap \mathfrak q$. thus we win by induction on $m$. \end{proof} \begin{theorem}[zariski's main theorem] \label{theorem-main-theorem} let $r$ be a ring. let $r \to s$ be a finite type $r$-algebra. let $s' \subset s$ be the integral closure of $r$ in $s$. let $\mathfrak q \subset s$ be a prime of $s$. if $r \to s$ is quasi-finite at $\mathfrak q$ then there exists a $g \in s'$, $g \not \in \mathfrak q$ such that $s'_g \cong s_g$. \end{theorem} \begin{proof} there exist finitely many elements $x_1, \ldots, x_n \in s$ such that $s$ is finite over the $r$-sub algebra generated by $x_1, \ldots, x_n$. (for example generators of $s$ over $r$.) we prove the proposition by induction on the minimal such number $n$. \medskip\noindent the case $n = 0$ is trivial, because in this case $s' = s$, see lemma \ref{lemma-finite-is-integral}. \medskip\noindent the case $n = 1$. we may replace $r$ by its integral closure in $s$ (lemma \ref{lemma-quasi-finite-permanence} guarantees that $r \to s$ is still quasi-finite at $\mathfrak q$). thus we may assume $r \subset s$ is integrally closed in $s$, in other words $r = s'$. consider the map $\varphi : r[x] \to s$, $x \mapsto x_1$. (we will see that $\varphi$ is not injective below.) by assumption $\varphi$ is finite. hence we are in situation \ref{situation-one-transcendental-element}. let $j \subset s$ be the ``conductor ideal'' defined in situation \ref{situation-one-transcendental-element}. consider the diagram $$ \xymatrix{ r[x] \ar[r] & s \ar[r] & s/\sqrt{j} & r/(r \cap \sqrt{j})[x] \ar[l] \\ & r \ar[lu] \ar[r] \ar[u] & r/(r \cap \sqrt{j}) \ar[u] \ar[ru] & } $$ according to lemma \ref{lemma-all-coefficients-in-j} the image of $x$ in the quotient $s/\sqrt{j}$ is strongly transcendental over $r/ (r \cap \sqrt{j})$. hence by lemma \ref{lemma-reduced-strongly-transcendental-not-quasi-finite} the ring map $r/ (r \cap \sqrt{j}) \to s/\sqrt{j}$ is not quasi-finite at any prime of $s/\sqrt{j}$. by lemma \ref{lemma-four-rings} we deduce that $\mathfrak q$ does not lie in $v(j) \subset \spec(s)$. thus there exists an element $s \in j$, $s \not\in \mathfrak q$. by definition of $j$ we may write $s = \varphi(f)$ for some polynomial $f \in r[x]$. let $i = \ker(\varphi : r[x] \to s)$. since $\varphi(f) \in j$ we get $(r[x]/i)_f \cong s_{\varphi(f)}$. also $s \not \in \mathfrak q$ means that $f \not \in \varphi^{-1}(\mathfrak q)$. thus $\varphi^{-1}(\mathfrak q)/i$ is a prime of $r[x]/i$ at which $r \to r[x]/i$ is quasi-finite, see lemma \ref{lemma-quasi-finite-local}. note that $r$ is integrally closed in $r[x]/i$ since $r$ is integrally closed in $s$. by lemma \ref{lemma-quasi-finite-monogenic} there exists an element $h \in r$, $h \not \in r \cap \mathfrak q$ such that $r_h \cong (r[x]/i)_h$. thus $(r[x]/i)_{fh} = s_{\varphi(fh)}$ is isomorphic to a principal localization $r_{h'}$ of $r$ for some $h' \in r$, $h' \not \in \mathfrak q$. \medskip\noindent the case $n > 1$. consider the subring $r' \subset s$ which is the integral closure of $r[x_1, \ldots, x_{n-1}]$ in $s$. by lemma \ref{lemma-quasi-finite-permanence} the extension $s/r'$ is quasi-finite at $\mathfrak q$. also, note that $s$ is finite over $r'[x_n]$. by the case $n = 1$ above, there exists a $g' \in r'$, $g' \not \in \mathfrak q$ such that $(r')_{g'} \cong s_{g'}$. at this point we cannot apply induction to $r \to r'$ since $r'$ may not be finite type over $r$. since $s$ is finitely generated over $r$ we deduce in particular that $(r')_{g'}$ is finitely generated over $r$. say the elements $g'$, and $y_1/(g')^{n_1}, \ldots, y_n/(g')^{n_n}$ with $y_i \in r'$ generate $(r')_{g'}$ over $r$. let $r''$ be the $r$-sub algebra of $r'$ generated by $x_1, \ldots, x_{n-1}, y_1, \ldots, y_n, g'$. this has the property $(r'')_{g'} \cong s_{g'}$. surjectivity because of how we chose $y_i$, injectivity because $r'' \subset r'$, and localization is exact. note that $r''$ is finite over $r[x_1, \ldots, x_{n-1}]$ because of our choice of $r'$, see lemma \ref{lemma-characterize-integral}. let $\mathfrak q'' = r'' \cap \mathfrak q$. since $(r'')_{\mathfrak q''} = s_{\mathfrak q}$ we see that $r \to r''$ is quasi-finite at $\mathfrak q''$, see lemma \ref{lemma-isolated-point-fibre}. we apply our induction hypothesis to $r \to r''$, $\mathfrak q''$ and $x_1, \ldots, x_{n-1} \in r''$ and we find a subring $r''' \subset r''$ which is integral over $r$ and an element $g'' \in r'''$, $g'' \not \in \mathfrak q''$ such that $(r''')_{g''} \cong (r'')_{g''}$. write the image of $g'$ in $(r'')_{g''}$ as $g'''/(g'')^n$ for some $g''' \in r'''$. set $g = g''g''' \in r'''$. then it is clear that $g \not\in \mathfrak q$ and $(r''')_g \cong s_g$. since by construction we have $r''' \subset s'$ we also have $s'_g \cong s_g$ as desired. \end{proof} \begin{lemma} \label{lemma-quasi-finite-open} let $r \to s$ be a finite type ring map. the set of points $\mathfrak q$ of $\spec(s)$ at which $s/r$ is quasi-finite is open in $\spec(s)$. \end{lemma} \begin{proof} let $\mathfrak q \subset s$ be a point at which the ring map is quasi-finite. by theorem \ref{theorem-main-theorem} there exists an integral ring map $r \to s'$, $s' \subset s$ and an element $g \in s'$, $g\not \in \mathfrak q$ such that $s'_g \cong s_g$. since $s$ and hence $s_g$ are of finite type over $r$ we may find finitely many elements $y_1, \ldots, y_n$ of $s'$ such that $s''_g \cong s_g$ where $s'' \subset s'$ is the sub $r$-algebra generated by $g, y_1, \ldots, y_n$. since $s''$ is finite over $r$ (see lemma \ref{lemma-characterize-integral}) we see that $s''$ is quasi-finite over $r$ (see lemma \ref{lemma-quasi-finite}). it is easy to see that this implies that $s''_g$ is quasi-finite over $r$, for example because the property of being quasi-finite at a prime depends only on the local ring at the prime. thus we see that $s_g$ is quasi-finite over $r$. by the same token this implies that $r \to s$ is quasi-finite at every prime of $s$ which lies in $d(g)$. \end{proof} \begin{lemma} \label{lemma-quasi-finite-open-integral-closure} let $r \to s$ be a finite type ring map. suppose that $s$ is quasi-finite over $r$. let $s' \subset s$ be the integral closure of $r$ in $s$. then \begin{enumerate} \item $\spec(s) \to \spec(s')$ is a homeomorphism onto an open subset, \item if $g \in s'$ and $d(g)$ is contained in the image of the map, then $s'_g \cong s_g$, and \item there exists a finite $r$-algebra $s'' \subset s'$ such that (1) and (2) hold for the ring map $s'' \to s$. \end{enumerate} \end{lemma} \begin{proof} because $s/r$ is quasi-finite we may apply theorem \ref{theorem-main-theorem} to each point $\mathfrak q$ of $\spec(s)$. since $\spec(s)$ is quasi-compact, see lemma \ref{lemma-quasi-compact}, we may choose a finite number of $g_i \in s'$, $i = 1, \ldots, n$ such that $s'_{g_i} = s_{g_i}$, and such that $g_1, \ldots, g_n$ generate the unit ideal in $s$ (in other words the standard opens of $\spec(s)$ associated to $g_1, \ldots, g_n$ cover all of $\spec(s)$). \medskip\noindent suppose that $d(g) \subset \spec(s')$ is contained in the image. then $d(g) \subset \bigcup d(g_i)$. in other words, $g_1, \ldots, g_n$ generate the unit ideal of $s'_g$. note that $s'_{gg_i} \cong s_{gg_i}$ by our choice of $g_i$. hence $s'_g \cong s_g$ by lemma \ref{lemma-cover}. \medskip\noindent we construct a finite algebra $s'' \subset s'$ as in (3). to do this note that each $s'_{g_i} \cong s_{g_i}$ is a finite type $r$-algebra. for each $i$ pick some elements $y_{ij} \in s'$ such that each $s'_{g_i}$ is generated as $r$-algebra by $1/g_i$ and the elements $y_{ij}$. then set $s''$ equal to the sub $r$-algebra of $s'$ generated by all $g_i$ and all the $y_{ij}$. details omitted. \end{proof} \section{applications of zariski's main theorem} \label{section-apply-main-theorem} \noindent here is an immediate application characterizing the finite maps of $1$-dimensional semi-local rings among the quasi-finite ones as those where equality always holds in the formula of lemma \ref{lemma-finite-extension-dim-1}. \begin{lemma} \label{lemma-quasi-finite-extension-dim-1} let $a \subset b$ be an extension of domains. assume \begin{enumerate} \item $a$ is a local noetherian ring of dimension $1$, \item $a \to b$ is of finite type, and \item the induced extension $l/k$ of fraction fields is finite. \end{enumerate} then $b$ is semi-local. let $x \in \mathfrak m_a$, $x \not = 0$. let $\mathfrak m_i$, $i = 1, \ldots, n$ be the maximal ideals of $b$. then $$ [l : k]\text{ord}_a(x) \geq \sum\nolimits_i [\kappa(\mathfrak m_i) : \kappa(\mathfrak m_a)] \text{ord}_{b_{\mathfrak m_i}}(x) $$ where $\text{ord}$ is defined as in definition \ref{definition-ord}. we have equality if and only if $a \to b$ is finite. \end{lemma} \begin{proof} the ring $b$ is semi-local by lemma \ref{lemma-finite-in-codim-1}. let $b'$ be the integral closure of $a$ in $b$. by lemma \ref{lemma-quasi-finite-open-integral-closure} we can find a finite $a$-subalgebra $c \subset b'$ such that on setting $\mathfrak n_i = c \cap \mathfrak m_i$ we have $c_{\mathfrak n_i} \cong b_{\mathfrak m_i}$ and the primes $\mathfrak n_1, \ldots, \mathfrak n_n$ are pairwise distinct. the ring $c$ is semi-local by lemma \ref{lemma-finite-in-codim-1}. let $\mathfrak p_j$, $j = 1, \ldots, m$ be the other maximal ideals of $c$ (the ``missing points''). by lemma \ref{lemma-finite-extension-dim-1} we have $$ \text{ord}_a(x^{[l : k]}) = \sum\nolimits_i [\kappa(\mathfrak n_i) : \kappa(\mathfrak m_a)] \text{ord}_{c_{\mathfrak n_i}}(x) + \sum\nolimits_j [\kappa(\mathfrak p_j) : \kappa(\mathfrak m_a)] \text{ord}_{c_{\mathfrak p_j}}(x) $$ hence the inequality follows. in case of equality we conclude that $m = 0$ (no ``missing points''). hence $c \subset b$ is an inclusion of semi-local rings inducing a bijection on maximal ideals and an isomorphism on all localizations at maximal ideals. so if $b \in b$, then $i = \{x \in c \mid xb \in c\}$ is an ideal of $c$ which is not contained in any of the maximal ideals of $c$, and hence $i = c$, hence $b \in c$. thus $b = c$ and $b$ is finite over $a$. \end{proof} \noindent here is a more standard application of zariski's main theorem to the structure of local homomorphisms of local rings. \begin{lemma} \label{lemma-essentially-finite-type-fibre-dim-zero} let $(r, \mathfrak m_r) \to (s, \mathfrak m_s)$ be a local homomorphism of local rings. assume \begin{enumerate} \item $r \to s$ is essentially of finite type, \item $\kappa(\mathfrak m_r) \subset \kappa(\mathfrak m_s)$ is finite, and \item $\dim(s/\mathfrak m_rs) = 0$. \end{enumerate} then $s$ is the localization of a finite $r$-algebra. \end{lemma} \begin{proof} let $s'$ be a finite type $r$-algebra such that $s = s'_{\mathfrak q'}$ for some prime $\mathfrak q'$ of $s'$. by definition \ref{definition-quasi-finite} we see that $r \to s'$ is quasi-finite at $\mathfrak q'$. after replacing $s'$ by $s'_{g'}$ for some $g' \in s'$, $g' \not \in \mathfrak q'$ we may assume that $r \to s'$ is quasi-finite, see lemma \ref{lemma-quasi-finite-open}. then by lemma \ref{lemma-quasi-finite-open-integral-closure} there exists a finite $r$-algebra $s''$ and elements $g' \in s'$, $g' \not \in \mathfrak q'$ and $g'' \in s''$ such that $s'_{g'} \cong s''_{g''}$ as $r$-algebras. this proves the lemma. \end{proof} \begin{lemma} \label{lemma-completion-at-quasi-finite-prime} let $r \to s$ be a ring map, $\mathfrak q$ a prime of $s$ lying over $\mathfrak p$ in $r$. if \begin{enumerate} \item $r$ is noetherian, \item $r \to s$ is of finite type, and \item $r \to s$ is quasi-finite at $\mathfrak q$, \end{enumerate} then $r_\mathfrak p^\wedge \otimes_r s = s_\mathfrak q^\wedge \times b$ for some $r_\mathfrak p^\wedge$-algebra $b$. \end{lemma} \begin{proof} there exists a finite $r$-algebra $s' \subset s$ and an element $g \in s'$, $g \not \in \mathfrak q' = s' \cap \mathfrak q$ such that $s'_g = s_g$ and in particular $s'_{\mathfrak q'} = s_\mathfrak q$, see lemma \ref{lemma-quasi-finite-open-integral-closure}. we have $$ r_\mathfrak p^\wedge \otimes_r s' = (s'_{\mathfrak q'})^\wedge \times b' $$ by lemma \ref{lemma-completion-finite-extension}. observe that under this product decomposition $g$ maps to a pair $(u, b')$ with $u \in (s'_{\mathfrak q'})^\wedge$ a unit because $g \not \in \mathfrak q'$. the product decomposition for $r_\mathfrak p^\wedge \otimes_r s'$ induces a product decomposition $$ r_\mathfrak p^\wedge \otimes_r s = a \times b $$ since $s'_g = s_g$ we also have $(r_\mathfrak p^\wedge \otimes_r s')_g = (r_\mathfrak p^\wedge \otimes_r s)_g$ and since $g \mapsto (u, b')$ where $u$ is a unit we see that $(s'_{\mathfrak q'})^\wedge = a$. since the isomorphism $s'_{\mathfrak q'} = s_\mathfrak q$ determines an isomorphism on completions this also tells us that $a = s_\mathfrak q^\wedge$. this finishes the proof, except that we should perform the sanity check that the induced map $\phi : r_\mathfrak p^\wedge \otimes_r s \to a = s_\mathfrak q^\wedge$ is the natural one. for elements of the form $x \otimes 1$ with $x \in r_\mathfrak p^\wedge$ this is clear as the natural map $r_\mathfrak p^\wedge \to s_\mathfrak q^\wedge$ factors through $(s'_{\mathfrak q'})^\wedge$. for elements of the form $1 \otimes y$ with $y \in s$ we can argue that for some $n \geq 1$ the element $g^ny$ is the image of some $y' \in s'$. thus $\phi(1 \otimes g^ny)$ is the image of $y'$ by the composition $s' \to (s'_{\mathfrak q'})^\wedge \to s_\mathfrak q^\wedge$ which is equal to the image of $g^ny$ by the map $s \to s_\mathfrak q^\wedge$. since $g$ maps to a unit this also implies that $\phi(1 \otimes y)$ has the correct value, i.e., the image of $y$ by $s \to s_\mathfrak q^\wedge$. \end{proof} \section{dimension of fibres} \label{section-dimension-fibres} \noindent we study the behaviour of dimensions of fibres, using zariski's main theorem. recall that we defined the dimension $\dim_x(x)$ of a topological space $x$ at a point $x$ in topology, definition \ref{topology-definition-krull}. \begin{definition} \label{definition-relative-dimension} suppose that $r \to s$ is of finite type, and let $\mathfrak q \subset s$ be a prime lying over a prime $\mathfrak p$ of $r$. we define the {\it relative dimension of $s/r$ at $\mathfrak q$}, denoted $\dim_{\mathfrak q}(s/r)$, to be the dimension of $\spec(s \otimes_r \kappa(\mathfrak p))$ at the point corresponding to $\mathfrak q$. we let $\dim(s/r)$ be the supremum of $\dim_{\mathfrak q}(s/r)$ over all $\mathfrak q$. this is called the {\it relative dimension of} $s/r$. \end{definition} \noindent in particular, $r \to s$ is quasi-finite at $\mathfrak q$ if and only if $\dim_{\mathfrak q}(s/r) = 0$. the following lemma is more or less a reformulation of zariski's main theorem. \begin{lemma} \label{lemma-quasi-finite-over-polynomial-algebra} let $r \to s$ be a finite type ring map. let $\mathfrak q \subset s$ be a prime. suppose that $\dim_{\mathfrak q}(s/r) = n$. there exists a $g \in s$, $g \not\in \mathfrak q$ such that $s_g$ is quasi-finite over a polynomial algebra $r[t_1, \ldots, t_n]$. \end{lemma} \begin{proof} the ring $\overline{s} = s \otimes_r \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$. let $\overline{\mathfrak q}$ be the prime of $\overline{s}$ corresponding to $\mathfrak q$. by definition of the dimension of a topological space at a point there exists an open $u \subset \spec(\overline{s})$ with $\overline{q} \in u$ and $\dim(u) = n$. since the topology on $\spec(\overline{s})$ is induced from the topology on $\spec(s)$ (see remark \ref{remark-fundamental-diagram}), we can find a $g \in s$, $g \not \in \mathfrak q$ with image $\overline{g} \in \overline{s}$ such that $d(\overline{g}) \subset u$. thus after replacing $s$ by $s_g$ we see that $\dim(\overline{s}) = n$. \medskip\noindent next, choose generators $x_1, \ldots, x_n$ for $s$ as an $r$-algebra. by lemma \ref{lemma-noether-normalization} there exist elements $y_1, \ldots, y_n$ in the $\mathbf{z}$-subalgebra of $s$ generated by $x_1, \ldots, x_n$ such that the map $r[t_1, \ldots, t_n] \to s$, $t_i \mapsto y_i$ has the property that $\kappa(\mathfrak p)[t_1\ldots, t_n] \to \overline{s}$ is finite. in particular, $s$ is quasi-finite over $r[t_1, \ldots, t_n]$ at $\mathfrak q$. hence, by lemma \ref{lemma-quasi-finite-open} we may replace $s$ by $s_g$ for some $g\in s$, $g \not \in \mathfrak q$ such that $r[t_1, \ldots, t_n] \to s$ is quasi-finite. \end{proof} \begin{lemma} \label{lemma-refined-quasi-finite-over-polynomial-algebra} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over the prime $\mathfrak p$ of $r$. assume \begin{enumerate} \item $r \to s$ is of finite type, \item $\dim_{\mathfrak q}(s/r) = n$, and \item $\text{trdeg}_{\kappa(\mathfrak p)}\kappa(\mathfrak q) = r$. \end{enumerate} then there exist $f \in r$, $f \not \in \mathfrak p$, $g \in s$, $g \not\in \mathfrak q$ and a quasi-finite ring map $$ \varphi : r_f[x_1, \ldots, x_n] \longrightarrow s_g $$ such that $\varphi^{-1}(\mathfrak qs_g) = (\mathfrak p, x_{r + 1}, \ldots, x_n)r_f[x_{r + 1}, \ldots, x_n]$ \end{lemma} \begin{proof} after replacing $s$ by a principal localization we may assume there exists a quasi-finite ring map $\varphi : r[t_1, \ldots, t_n] \to s$, see lemma \ref{lemma-quasi-finite-over-polynomial-algebra}. set $\mathfrak q' = \varphi^{-1}(\mathfrak q)$. let $\overline{\mathfrak q}' \subset \kappa(\mathfrak p)[t_1, \ldots, t_n]$ be the prime corresponding to $\mathfrak q'$. by lemma \ref{lemma-refined-noether-normalization} there exists a finite ring map $\kappa(\mathfrak p)[x_1, \ldots, x_n] \to \kappa(\mathfrak p)[t_1, \ldots, t_n]$ such that the inverse image of $\overline{\mathfrak q}'$ is $(x_{r + 1}, \ldots, x_n)$. let $\overline{h}_i \in \kappa(\mathfrak p)[t_1, \ldots, t_n]$ be the image of $x_i$. we can find an element $f \in r$, $f \not \in \mathfrak p$ and $h_i \in r_f[t_1, \ldots, t_n]$ which map to $\overline{h}_i$ in $\kappa(\mathfrak p)[t_1, \ldots, t_n]$. then the ring map $$ r_f[x_1, \ldots, x_n] \longrightarrow r_f[t_1, \ldots, t_n] $$ becomes finite after tensoring with $\kappa(\mathfrak p)$. in particular, $r_f[t_1, \ldots, t_n]$ is quasi-finite over $r_f[x_1, \ldots, x_n]$ at the prime $\mathfrak q'r_f[t_1, \ldots, t_n]$. hence, by lemma \ref{lemma-quasi-finite-open} there exists a $g \in r_f[t_1, \ldots, t_n]$, $g \not \in \mathfrak q'r_f[t_1, \ldots, t_n]$ such that $r_f[x_1, \ldots, x_n] \to r_f[t_1, \ldots, t_n, 1/g]$ is quasi-finite. thus we see that the composition $$ r_f[x_1, \ldots, x_n] \longrightarrow r_f[t_1, \ldots, t_n, 1/g] \longrightarrow s_{\varphi(g)} $$ is quasi-finite and we win. \end{proof} \begin{lemma} \label{lemma-dimension-inequality-quasi-finite} let $r \to s$ be a finite type ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$. if $r \to s$ is quasi-finite at $\mathfrak q$, then $\dim(s_{\mathfrak q}) \leq \dim(r_{\mathfrak p})$. \end{lemma} \begin{proof} if $r_{\mathfrak p}$ is noetherian (and hence $s_{\mathfrak q}$ noetherian since it is essentially of finite type over $r_{\mathfrak p}$) then this follows immediately from lemma \ref{lemma-dimension-base-fibre-total} and the definitions. in the general case, let $s'$ be the integral closure of $r_\mathfrak p$ in $s_\mathfrak p$. by zariski's main theorem \ref{theorem-main-theorem} we have $s_{\mathfrak q} = s'_{\mathfrak q'}$ for some $\mathfrak q' \subset s'$ lying over $\mathfrak q$. by lemma \ref{lemma-integral-dim-up} we have $\dim(s') \leq \dim(r_\mathfrak p)$ and hence a fortiori $\dim(s_\mathfrak q) = \dim(s'_{\mathfrak q'}) \leq \dim(r_\mathfrak p)$. \end{proof} \begin{lemma} \label{lemma-dimension-quasi-finite-over-polynomial-algebra} \begin{slogan} a quasi-finite cover of affine n-space has dimension at most n. \end{slogan} let $k$ be a field. let $s$ be a finite type $k$-algebra. suppose there is a quasi-finite $k$-algebra map $k[t_1, \ldots, t_n] \subset s$. then $\dim(s) \leq n$. \end{lemma} \begin{proof} by lemma \ref{lemma-dim-affine-space} the dimension of any local ring of $k[t_1, \ldots, t_n]$ is at most $n$. thus the result follows from lemma \ref{lemma-dimension-inequality-quasi-finite}. \end{proof} \begin{lemma} \label{lemma-dimension-fibres-bounded-open-upstairs} let $r \to s$ be a finite type ring map. let $\mathfrak q \subset s$ be a prime. suppose that $\dim_{\mathfrak q}(s/r) = n$. there exists an open neighbourhood $v$ of $\mathfrak q$ in $\spec(s)$ such that $\dim_{\mathfrak q'}(s/r) \leq n$ for all $\mathfrak q' \in v$. \end{lemma} \begin{proof} by lemma \ref{lemma-quasi-finite-over-polynomial-algebra} we see that we may assume that $s$ is quasi-finite over a polynomial algebra $r[t_1, \ldots, t_n]$. considering the fibres, we reduce to lemma \ref{lemma-dimension-quasi-finite-over-polynomial-algebra}. \end{proof} \noindent in other words, the lemma says that the set of points where the fibre has dimension $\leq n$ is open in $\spec(s)$. the next lemma says that formation of this open commutes with base change. if the ring map is of finite presentation then this set is quasi-compact open (see below). \begin{lemma} \label{lemma-dimension-fibres-bounded-open-upstairs-base-change} let $r \to s$ be a finite type ring map. let $r \to r'$ be any ring map. set $s' = r' \otimes_r s$ and denote $f : \spec(s') \to \spec(s)$ the associated map on spectra. let $n \geq 0$. the inverse image $f^{-1}(\{\mathfrak q \in \spec(s) \mid \dim_{\mathfrak q}(s/r) \leq n\})$ is equal to $\{\mathfrak q' \in \spec(s') \mid \dim_{\mathfrak q'}(s'/r') \leq n\}$. \end{lemma} \begin{proof} the condition is formulated in terms of dimensions of fibre rings which are of finite type over a field. combined with lemma \ref{lemma-dimension-at-a-point-preserved-field-extension} this yields the lemma. \end{proof} \begin{lemma} \label{lemma-dimension-fibres-bounded-quasi-compact-open-upstairs} let $r \to s$ be a ring homomorphism of finite presentation. let $n \geq 0$. the set $$ v_n = \{\mathfrak q \in \spec(s) \mid \dim_{\mathfrak q}(s/r) \leq n\} $$ is a quasi-compact open subset of $\spec(s)$. \end{lemma} \begin{proof} it is open by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}. let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ be a presentation of $s$. let $r_0$ be the $\mathbf{z}$-subalgebra of $r$ generated by the coefficients of the polynomials $f_i$. let $s_0 = r_0[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$. then $s = r \otimes_{r_0} s_0$. by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs-base-change} $v_n$ is the inverse image of an open $v_{0, n}$ under the quasi-compact continuous map $\spec(s) \to \spec(s_0)$. since $s_0$ is noetherian we see that $v_{0, n}$ is quasi-compact. \end{proof} \begin{lemma} \label{lemma-finite-type-domain-over-valuation-ring-dim-fibres} let $r$ be a valuation ring with residue field $k$ and field of fractions $k$. let $s$ be a domain containing $r$ such that $s$ is of finite type over $r$. if $s \otimes_r k$ is not the zero ring then $$ \dim(s \otimes_r k) = \dim(s \otimes_r k) $$ in fact, $\spec(s \otimes_r k)$ is equidimensional. \end{lemma} \begin{proof} it suffices to show that $\dim_{\mathfrak q}(s/k)$ is equal to $\dim(s \otimes_r k)$ for every prime $\mathfrak q$ of $s$ containing $\mathfrak m_rs$. pick such a prime. by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs} the inequality $\dim_{\mathfrak q}(s/k) \geq \dim(s \otimes_r k)$ holds. set $n = \dim_{\mathfrak q}(s/k)$. by lemma \ref{lemma-quasi-finite-over-polynomial-algebra} after replacing $s$ by $s_g$ for some $g \in s$, $g \not \in \mathfrak q$ there exists a quasi-finite ring map $r[t_1, \ldots, t_n] \to s$. if $\dim(s \otimes_r k) < n$, then $k[t_1, \ldots, t_n] \to s \otimes_r k$ has a nonzero kernel. say $f = \sum a_i t_1^{i_1}\ldots t_n^{i_n}$. after dividing $f$ by a nonzero coefficient of $f$ with minimal valuation, we may assume $f\in r[t_1, \ldots, t_n]$ and some $a_i$ does not map to zero in $k$. hence the ring map $k[t_1, \ldots, t_n] \to s \otimes_r k$ has a nonzero kernel which implies that $\dim(s \otimes_r k) < n$. contradiction. \end{proof} \section{algebras and modules of finite presentation} \label{section-finite-presentation} \noindent in this section we discuss some standard results where the key feature is that the assumption involves a finite type or finite presentation assumption. \begin{lemma} \label{lemma-finite-type-descends} let $r \to s$ be a ring map. let $r \to r'$ be a faithfully flat ring map. set $s' = r'\otimes_r s$. then $r \to s$ is of finite type if and only if $r' \to s'$ is of finite type. \end{lemma} \begin{proof} it is clear that if $r \to s$ is of finite type then $r' \to s'$ is of finite type. assume that $r' \to s'$ is of finite type. say $y_1, \ldots, y_m$ generate $s'$ over $r'$. write $y_j = \sum_i a_{ij} \otimes x_{ji}$ for some $a_{ij} \in r'$ and $x_{ji} \in s$. let $a \subset s$ be the $r$-subalgebra generated by the $x_{ij}$. by flatness we have $a' := r' \otimes_r a \subset s'$, and by construction $y_j \in a'$. hence $a' = s'$. by faithful flatness $a = s$. \end{proof} \begin{lemma} \label{lemma-finite-presentation-descends} let $r \to s$ be a ring map. let $r \to r'$ be a faithfully flat ring map. set $s' = r'\otimes_r s$. then $r \to s$ is of finite presentation if and only if $r' \to s'$ is of finite presentation. \end{lemma} \begin{proof} it is clear that if $r \to s$ is of finite presentation then $r' \to s'$ is of finite presentation. assume that $r' \to s'$ is of finite presentation. by lemma \ref{lemma-finite-type-descends} we see that $r \to s$ is of finite type. write $s = r[x_1, \ldots, x_n]/i$. by flatness $s' = r'[x_1, \ldots, x_n]/r'\otimes i$. say $g_1, \ldots, g_m$ generate $r'\otimes i$ over $r'[x_1, \ldots, x_n]$. write $g_j = \sum_i a_{ij} \otimes f_{ji}$ for some $a_{ij} \in r'$ and $f_{ji} \in i$. let $j \subset i$ be the ideal generated by the $f_{ij}$. by flatness we have $r' \otimes_r j \subset r'\otimes_r i$, and both are ideals over $r'[x_1, \ldots, x_n]$. by construction $g_j \in r' \otimes_r j$. hence $r' \otimes_r j = r'\otimes_r i$. by faithful flatness $j = i$. \end{proof} \begin{lemma} \label{lemma-construct-fp-module} let $r$ be a ring. let $i \subset r$ be an ideal. let $s \subset r$ be a multiplicative subset. set $r' = s^{-1}(r/i) = s^{-1}r/s^{-1}i$. \begin{enumerate} \item for any finite $r'$-module $m'$ there exists a finite $r$-module $m$ such that $s^{-1}(m/im) \cong m'$. \item for any finitely presented $r'$-module $m'$ there exists a finitely presented $r$-module $m$ such that $s^{-1}(m/im) \cong m'$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). choose a short exact sequence $0 \to k' \to (r')^{\oplus n} \to m' \to 0$. let $k \subset r^{\oplus n}$ be the inverse image of $k'$ under the map $r^{\oplus n} \to (r')^{\oplus n}$. then $m = r^{\oplus n}/k$ works. \medskip\noindent proof of (2). choose a presentation $(r')^{\oplus m} \to (r')^{\oplus n} \to m' \to 0$. suppose that the first map is given by the matrix $a' = (a'_{ij})$ and the second map is determined by generators $x'_i \in m'$, $i = 1, \ldots, n$. as $r' = s^{-1}(r/i)$ we can choose $s \in s$ and a matrix $a = (a_{ij})$ with coefficients in $r$ such that $a'_{ij} = a_{ij} / s \bmod s^{-1}i$. let $m$ be the finitely presented $r$-module with presentation $r^{\oplus m} \to r^{\oplus n} \to m \to 0$ where the first map is given by the matrix $a$ and the second map is determined by generators $x_i \in m$, $i = 1, \ldots, n$. then the map $m \to m'$, $x_i \mapsto x'_i$ induces an isomorphism $s^{-1}(m/im) \cong m'$. \end{proof} \begin{lemma} \label{lemma-construct-fp-module-from-localization} let $r$ be a ring. let $s \subset r$ be a multiplicative subset. let $m$ be an $r$-module. \begin{enumerate} \item if $s^{-1}m$ is a finite $s^{-1}r$-module then there exists a finite $r$-module $m'$ and a map $m' \to m$ which induces an isomorphism $s^{-1}m' \to s^{-1}m$. \item if $s^{-1}m$ is a finitely presented $s^{-1}r$-module then there exists an $r$-module $m'$ of finite presentation and a map $m' \to m$ which induces an isomorphism $s^{-1}m' \to s^{-1}m$. \end{enumerate} \end{lemma} \begin{proof} proof of (1). let $x_1, \ldots, x_n \in m$ be elements which generate $s^{-1}m$ as an $s^{-1}r$-module. let $m'$ be the $r$-submodule of $m$ generated by $x_1, \ldots, x_n$. \medskip\noindent proof of (2). let $x_1, \ldots, x_n \in m$ be elements which generate $s^{-1}m$ as an $s^{-1}r$-module. let $k = \ker(r^{\oplus n} \to m)$ where the map is given by the rule $(a_1, \ldots, a_n) \mapsto \sum a_i x_i$. by lemma \ref{lemma-extension} we see that $s^{-1}k$ is a finite $s^{-1}r$-module. by (1) we can find a finite submodule $k' \subset k$ with $s^{-1}k' = s^{-1}k$. take $m' = \coker(k' \to r^{\oplus n})$. \end{proof} \begin{lemma} \label{lemma-construct-fp-module-from-stalk} let $r$ be a ring. let $\mathfrak p \subset r$ be a prime ideal. let $m$ be an $r$-module. \begin{enumerate} \item if $m_{\mathfrak p}$ is a finite $r_{\mathfrak p}$-module then there exists a finite $r$-module $m'$ and a map $m' \to m$ which induces an isomorphism $m'_{\mathfrak p} \to m_{\mathfrak p}$. \item if $m_{\mathfrak p}$ is a finitely presented $r_{\mathfrak p}$-module then there exists an $r$-module $m'$ of finite presentation and a map $m' \to m$ which induces an isomorphism $m'_{\mathfrak p} \to m_{\mathfrak p}$. \end{enumerate} \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-construct-fp-module-from-localization} \end{proof} \begin{lemma} \label{lemma-local-isomorphism} let $\varphi : r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$. assume \begin{enumerate} \item $s$ is of finite presentation over $r$, \item $\varphi$ induces an isomorphism $r_\mathfrak p \cong s_\mathfrak q$. \end{enumerate} then there exist $f \in r$, $f \not \in \mathfrak p$ and an $r_f$-algebra $c$ such that $s_f \cong r_f \times c$ as $r_f$-algebras. \end{lemma} \begin{proof} write $s = r[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. let $a_i \in r_\mathfrak p$ be an element mapping to the image of $x_i$ in $s_\mathfrak q$. write $a_i = b_i/f$ for some $f \in r$, $f \not \in \mathfrak p$. after replacing $r$ by $r_f$ and $x_i$ by $x_i - a_i$ we may assume that $s = r[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$ such that $x_i$ maps to zero in $s_\mathfrak q$. then if $c_j$ denotes the constant term of $g_j$ we conclude that $c_j$ maps to zero in $r_\mathfrak p$. after another replacement of $r$ we may assume that the constant coefficients $c_j$ of the $g_j$ are zero. thus we obtain an $r$-algebra map $s \to r$, $x_i \mapsto 0$ whose kernel is the ideal $(x_1, \ldots, x_n)$. \medskip\noindent we have the isomorphisms $r_\mathfrak p \to s_\mathfrak q \to r_\mathfrak p$ and $s \to r$ sends $x_i$ to zero. thus we must have $s_\mathfrak q = r_\mathfrak p[x_1, \ldots, x_n]/(x_1, \ldots, x_n)$ and a fortiori $s_\mathfrak q = s_\mathfrak p/(x_1, \ldots, x_n)s_\mathfrak p$. this means that the finitely generated ideal $(x_1, \ldots, x_n)s_\mathfrak p$ is pure in $s_\mathfrak p$, see definition \ref{definition-pure-ideal}. hence $(x_1, \ldots, x_n)s_\mathfrak p$ is generated by an idempotent $e$ in $s_\mathfrak p$ by lemma \ref{lemma-finitely-generated-pure-ideal}. after replacing $r \to s$ by $r_f \to s_f$ for some $f \in r$, $f \not \in \mathfrak p$ we can find an idempotent $e' \in s$ mapping to $e$. then $e's$ and $(x_1, \ldots, x_n)s$ are finitely generated ideals which become equal in $s_\mathfrak p$. hence after replacing $r \to s$ by $r_f \to s_f$ for some $f \in r$, $f \not \in \mathfrak p$ we may assume $e's = (x_1, \ldots, x_n)s$. setting $c = e's$ finishes the proof. \end{proof} \begin{lemma} \label{lemma-isomorphic-local-rings} let $r$ be a ring. let $s$, $s'$ be of finite presentation over $r$. let $\mathfrak q \subset s$ and $\mathfrak q' \subset s'$ be primes. if $s_{\mathfrak q} \cong s'_{\mathfrak q'}$ as $r$-algebras, then there exist $g \in s$, $g \not \in \mathfrak q$ and $g' \in s'$, $g' \not \in \mathfrak q'$ such that $s_g \cong s'_{g'}$ as $r$-algebras. \end{lemma} \begin{proof} let $\psi : s_{\mathfrak q} \to s'_{\mathfrak q'}$ be the isomorphism of the hypothesis of the lemma. write $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_r)$ and $s' = r[y_1, \ldots, y_m]/j$. for each $i = 1, \ldots, n$ choose a fraction $h_i/g_i$ with $h_i, g_i \in r[y_1, \ldots, y_m]$ and $g_i \bmod j$ not in $\mathfrak q'$ which represents the image of $x_i$ under $\psi$. after replacing $s'$ by $s'_{g_1 \ldots g_n}$ and $r[y_1, \ldots, y_m, y_{m + 1}]$ (mapping $y_{m + 1}$ to $1/(g_1\ldots g_n)$) we may assume that $\psi(x_i)$ is the image of some $h_i \in r[y_1, \ldots, y_m]$. consider the elements $f_j(h_1, \ldots, h_n) \in r[y_1, \ldots, y_m]$. since $\psi$ kills each $f_j$ we see that there exists a $g \in r[y_1, \ldots, y_m]$, $g \bmod j \not \in \mathfrak q'$ such that $g f_j(h_1, \ldots, h_n) \in j$ for each $j = 1, \ldots, r$. after replacing $s'$ by $s'_g$ and $r[y_1, \ldots, y_m, y_{m + 1}]$ as before we may assume that $f_j(h_1, \ldots, h_n) \in j$. thus we obtain a ring map $s \to s'$, $x_i \mapsto h_i$ which induces $\psi$ on local rings. by lemma \ref{lemma-compose-finite-type} the map $s \to s'$ is of finite presentation. by lemma \ref{lemma-local-isomorphism} we may assume that $s' = s \times c$. thus localizing $s'$ at the idempotent corresponding to the factor $c$ we obtain the result. \end{proof} \begin{lemma} \label{lemma-finite-type-mod-nilpotent} let $r$ be a ring. let $i \subset r$ be a nilpotent ideal. let $s$ be an $r$-algebra such that $r/i \to s/is$ is of finite type. then $r \to s$ is of finite type. \end{lemma} \begin{proof} choose $s_1, \ldots, s_n \in s$ whose images in $s/is$ generate $s/is$ as an algebra over $r/i$. by lemma \ref{lemma-nak} part (11) we see that the $r$-algebra map $r[x_1, \ldots, x_n] \to s$, $x_i \mapsto s_i$ is surjective and we conclude. \end{proof} \begin{lemma} \label{lemma-surjective-mod-locally-nilpotent} let $r$ be a ring. let $i \subset r$ be a locally nilpotent ideal. let $s \to s'$ be an $r$-algebra map such that $s \to s'/is'$ is surjective and such that $s'$ is of finite type over $r$. then $s \to s'$ is surjective. \end{lemma} \begin{proof} write $s' = r[x_1, \ldots, x_m]/k$ for some ideal $k$. by assumption there exist $g_j = x_j + \sum \delta_{j, j} x^j \in r[x_1, \ldots, x_n]$ with $\delta_{j, j} \in i$ and with $g_j \bmod k \in \im(s \to s')$. hence it suffices to show that $g_1, \ldots, g_m$ generate $r[x_1, \ldots, x_n]$. let $r_0 \subset r$ be a finitely generated $\mathbf{z}$-subalgebra of $r$ containing at least the $\delta_{j, j}$. then $r_0 \cap i$ is a nilpotent ideal (by lemma \ref{lemma-noetherian-power}). it follows that $r_0[x_1, \ldots, x_n]$ is generated by $g_1, \ldots, g_m$ (because $x_j \mapsto g_j$ defines an automorphism of $r_0[x_1, \ldots, x_m]$; details omitted). since $r$ is the union of the subrings $r_0$ we win. \end{proof} \begin{lemma} \label{lemma-isomorphism-modulo-ideal} let $r$ be a ring. let $i \subset r$ be an ideal. let $s \to s'$ be an $r$-algebra map. let $is \subset \mathfrak q \subset s$ be a prime ideal. assume that \begin{enumerate} \item $s \to s'$ is surjective, \item $s_\mathfrak q/is_\mathfrak q \to s'_\mathfrak q/is'_\mathfrak q$ is an isomorphism, \item $s$ is of finite type over $r$, \item $s'$ of finite presentation over $r$, and \item $s'_\mathfrak q$ is flat over $r$. \end{enumerate} then $s_g \to s'_g$ is an isomorphism for some $g \in s$, $g \not \in \mathfrak q$. \end{lemma} \begin{proof} let $j = \ker(s \to s')$. by lemma \ref{lemma-compose-finite-type} $j$ is a finitely generated ideal. since $s'_\mathfrak q$ is flat over $r$ we see that $j_\mathfrak q/ij_\mathfrak q \subset s_\mathfrak q/is_{\mathfrak q}$ (apply lemma \ref{lemma-flat-tor-zero} to $0 \to j \to s \to s' \to 0$). by assumption (2) we see that $j_\mathfrak q/ij_\mathfrak q$ is zero. by nakayama's lemma (lemma \ref{lemma-nak}) we see that there exists a $g \in s$, $g \not \in \mathfrak q$ such that $j_g = 0$. hence $s_g \cong s'_g$ as desired. \end{proof} \begin{lemma} \label{lemma-isomorphism-modulo-locally-nilpotent} let $r$ be a ring. let $i \subset r$ be an ideal. let $s \to s'$ be an $r$-algebra map. assume that \begin{enumerate} \item $i$ is locally nilpotent, \item $s/is \to s'/is'$ is an isomorphism, \item $s$ is of finite type over $r$, \item $s'$ of finite presentation over $r$, and \item $s'$ is flat over $r$. \end{enumerate} then $s \to s'$ is an isomorphism. \end{lemma} \begin{proof} by lemma \ref{lemma-surjective-mod-locally-nilpotent} the map $s \to s'$ is surjective. as $i$ is locally nilpotent, so are the ideals $is$ and $is'$ (lemma \ref{lemma-locally-nilpotent}). hence every prime ideal $\mathfrak q$ of $s$ contains $is$ and (trivially) $s_\mathfrak q/is_\mathfrak q \cong s'_\mathfrak q/is'_\mathfrak q$. thus lemma \ref{lemma-isomorphism-modulo-ideal} applies and we see that $s_\mathfrak q \to s'_\mathfrak q$ is an isomorphism for every prime $\mathfrak q \subset s$. it follows that $s \to s'$ is injective for example by lemma \ref{lemma-characterize-zero-local}. \end{proof} \section{colimits and maps of finite presentation} \label{section-colimits-flat} \noindent in this section we prove some preliminary lemmas which will eventually help us prove result using absolute noetherian reduction. in categories, section \ref{categories-section-directed-colimits} we discuss filtered colimits in general. here is an example of this very general notion. \begin{lemma} \label{lemma-ring-colimit-fp-category} let $r \to a$ be a ring map. consider the category $\mathcal{i}$ of all diagrams of $r$-algebra maps $a' \to a$ with $a'$ finitely presented over $r$. then $\mathcal{i}$ is filtered, and the colimit of the $a'$ over $\mathcal{i}$ is isomorphic to $a$. \end{lemma} \begin{proof} the category\footnote{to avoid set theoretical difficulties we consider only $a' \to a$ such that $a'$ is a quotient of $r[x_1, x_2, x_3, \ldots]$.} $\mathcal{i}$ is nonempty as $r \to r$ is an object of it. consider a pair of objects $a' \to a$, $a'' \to a$ of $\mathcal{i}$. then $a' \otimes_r a'' \to a$ is in $\mathcal{i}$ (use lemmas \ref{lemma-compose-finite-type} and \ref{lemma-base-change-finiteness}). the ring maps $a' \to a' \otimes_r a''$ and $a'' \to a' \otimes_r a''$ define arrows in $\mathcal{i}$ thereby proving the second defining property of a filtered category, see categories, definition \ref{categories-definition-directed}. finally, suppose that we have two morphisms $\sigma, \tau : a' \to a''$ in $\mathcal{i}$. if $x_1, \ldots, x_r \in a'$ are generators of $a'$ as an $r$-algebra, then we can consider $a''' = a''/(\sigma(x_i) - \tau(x_i))$. this is a finitely presented $r$-algebra and the given $r$-algebra map $a'' \to a$ factors through the surjection $\nu : a'' \to a'''$. thus $\nu$ is a morphism in $\mathcal{i}$ equalizing $\sigma$ and $\tau$ as desired. \medskip\noindent the fact that our index category is cofiltered means that we may compute the value of $b = \colim_{a' \to a} a'$ in the category of sets (some details omitted; compare with the discussion in categories, section \ref{categories-section-directed-colimits}). to see that $b \to a$ is surjective, for every $a \in a$ we can use $r[x] \to a$, $x \mapsto a$ to see that $a$ is in the image of $b \to a$. conversely, if $b \in b$ is mapped to zero in $a$, then we can find $a' \to a$ in $\mathcal{i}$ and $a' \in a'$ which maps to $b$. then $a'/(a') \to a$ is in $\mathcal{i}$ as well and the map $a' \to b$ factors as $a' \to a'/(a') \to b$ which shows that $b = 0$ as desired. \end{proof} \noindent often it is easier to think about colimits over preordered sets. let $(\lambda, \geq)$ a preordered set. a system of rings over $\lambda$ is given by a ring $r_\lambda$ for every $\lambda \in \lambda$, and a morphism $r_\lambda \to r_\mu$ whenever $\lambda \leq \mu$. these morphisms have to satisfy the rule that $r_\lambda \to r_\mu \to r_\nu$ is equal to the map $r_\lambda \to r_\nu$ for all $\lambda \leq \mu \leq \nu$. see categories, section \ref{categories-section-posets-limits}. we will often assume that $(i, \leq)$ is {\it directed}, which means that $\lambda$ is nonempty and given $\lambda, \mu \in \lambda$ there exists a $\nu \in \lambda$ with $\lambda \leq \nu$ and $\mu \leq \nu$. recall that the colimit $\colim_\lambda r_\lambda$ is sometimes called a ``direct limit'' in this case (but we will not use this terminology). \medskip\noindent note that categories, lemma \ref{categories-lemma-directed-category-system} tells us that colimits over filtered index categories are the same thing as colimits over directed sets. \begin{lemma} \label{lemma-ring-colimit-fp} let $r \to a$ be a ring map. there exists a directed system $a_\lambda$ of $r$-algebras of finite presentation such that $a = \colim_\lambda a_\lambda$. if $a$ is of finite type over $r$ we may arrange it so that all the transition maps in the system of $a_\lambda$ are surjective. \end{lemma} \begin{proof} the first proof is that this follows from lemma \ref{lemma-ring-colimit-fp-category} and categories, lemma \ref{categories-lemma-directed-category-system}. \medskip\noindent second proof. compare with the proof of lemma \ref{lemma-module-colimit-fp}. consider any finite subset $s \subset a$, and any finite collection of polynomial relations $e$ among the elements of $s$. so each $s \in s$ corresponds to $x_s \in a$ and each $e \in e$ consists of a polynomial $f_e \in r[x_s; s\in s]$ such that $f_e(x_s) = 0$. let $a_{s, e} = r[x_s; s\in s]/(f_e; e\in e)$ which is a finitely presented $r$-algebra. there are canonical maps $a_{s, e} \to a$. if $s \subset s'$ and if the elements of $e$ correspond, via the map $r[x_s; s \in s] \to r[x_s; s\in s']$, to a subset of $e'$, then there is an obvious map $a_{s, e} \to a_{s', e'}$ commuting with the maps to $a$. thus, setting $\lambda$ equal the set of pairs $(s, e)$ with ordering by inclusion as above, we get a directed partially ordered set. it is clear that the colimit of this directed system is $a$. \medskip\noindent for the last statement, suppose $a = r[x_1, \ldots, x_n]/i$. in this case, consider the subset $\lambda' \subset \lambda$ consisting of those systems $(s, e)$ above with $s = \{x_1, \ldots, x_n\}$. it is easy to see that still $a = \colim_{\lambda' \in \lambda'} a_{\lambda'}$. moreover, the transition maps are clearly surjective. \end{proof} \noindent it turns out that we can characterize ring maps of finite presentation as follows. this in some sense says that the algebras of finite presentation are the ``compact'' objects in the category of $r$-algebras. \begin{lemma} \label{lemma-characterize-finite-presentation} let $\varphi : r \to s$ be a ring map. the following are equivalent \begin{enumerate} \item $\varphi$ is of finite presentation, \item for every directed system $a_\lambda$ of $r$-algebras the map $$ \colim_\lambda \hom_r(s, a_\lambda) \longrightarrow \hom_r(s, \colim_\lambda a_\lambda) $$ is bijective, and \item for every directed system $a_\lambda$ of $r$-algebras the map $$ \colim_\lambda \hom_r(s, a_\lambda) \longrightarrow \hom_r(s, \colim_\lambda a_\lambda) $$ is surjective. \end{enumerate} \end{lemma} \begin{proof} assume (1) and write $s = r[x_1, \ldots, x_n] / (f_1, \ldots, f_m)$. let $a = \colim a_\lambda$. observe that an $r$-algebra homomorphism $s \to a$ or $s \to a_\lambda$ is determined by the images of $x_1, \ldots, x_n$. hence it is clear that $\colim_\lambda \hom_r(s, a_\lambda) \to \hom_r(s, a)$ is injective. to see that it is surjective, let $\chi : s \to a$ be an $r$-algebra homomorphism. then each $x_i$ maps to some element in the image of some $a_{\lambda_i}$. we may pick $\mu \geq \lambda_i$, $i = 1, \ldots, n$ and assume $\chi(x_i)$ is the image of $y_i \in a_\mu$ for $i = 1, \ldots, n$. consider $z_j = f_j(y_1, \ldots, y_n) \in a_\mu$. since $\chi$ is a homomorphism the image of $z_j$ in $a = \colim_\lambda a_\lambda$ is zero. hence there exists a $\mu_j \geq \mu$ such that $z_j$ maps to zero in $a_{\mu_j}$. pick $\nu \geq \mu_j$, $j = 1, \ldots, m$. then the images of $z_1, \ldots, z_m$ are zero in $a_\nu$. this exactly means that the $y_i$ map to elements $y'_i \in a_\nu$ which satisfy the relations $f_j(y'_1, \ldots, y'_n) = 0$. thus we obtain a ring map $s \to a_\nu$. this shows that (1) implies (2). \medskip\noindent it is clear that (2) implies (3). assume (3). by lemma \ref{lemma-ring-colimit-fp} we may write $s = \colim_\lambda s_\lambda$ with $s_\lambda$ of finite presentation over $r$. then the identity map factors as $$ s \to s_\lambda \to s $$ for some $\lambda$. this implies that $s$ is finitely presented over $s_\lambda$ by lemma \ref{lemma-compose-finite-type} part (4) applied to $s \to s_\lambda \to s$. applying part (2) of the same lemma to $r \to s_\lambda \to s$ we conclude that $s$ is of finite presentation over $r$. \end{proof} \noindent using the basic material above we can give a criterion of when an algebra $a$ is a filtered colimit of given type of algebra as follows. \begin{lemma} \label{lemma-when-colimit} let $r \to \lambda$ be a ring map. let $\mathcal{e}$ be a set of $r$-algebras such that each $a \in \mathcal{e}$ is of finite presentation over $r$. then the following two statements are equivalent \begin{enumerate} \item $\lambda$ is a filtered colimit of elements of $\mathcal{e}$, and \item for any $r$ algebra map $a \to \lambda$ with $a$ of finite presentation over $r$ we can find a factorization $a \to b \to \lambda$ with $b \in \mathcal{e}$. \end{enumerate} \end{lemma} \begin{proof} suppose that $\mathcal{i} \to \mathcal{e}$, $i \mapsto a_i$ is a filtered diagram such that $\lambda = \colim_i a_i$. let $a \to \lambda$ be an $r$-algebra map with $a$ of finite presentation over $r$. then we get a factorization $a \to a_i \to \lambda$ by applying lemma \ref{lemma-characterize-finite-presentation}. thus (1) implies (2). \medskip\noindent consider the category $\mathcal{i}$ of lemma \ref{lemma-ring-colimit-fp-category}. by categories, lemma \ref{categories-lemma-cofinal-in-filtered} the full subcategory $\mathcal{j}$ consisting of those $a \to \lambda$ with $a \in \mathcal{e}$ is cofinal in $\mathcal{i}$ and is a filtered category. then $\lambda$ is also the colimit over $\mathcal{j}$ by categories, lemma \ref{categories-lemma-cofinal}. \end{proof} \noindent but more is true. namely, given $r = \colim_\lambda r_\lambda$ we see that the category of finitely presented $r$-modules is equivalent to the limit of the category of finitely presented $r_\lambda$-modules. similarly for the categories of finitely presented $r$-algebras. \begin{lemma} \label{lemma-module-map-property-in-colimit} let $a$ be a ring and let $m, n$ be $a$-modules. suppose that $r = \colim_{i \in i} r_i$ is a directed colimit of $a$-algebras. \begin{enumerate} \item if $m$ is a finite $a$-module, and $u, u' : m \to n$ are $a$-module maps such that $u \otimes 1 = u' \otimes 1 : m \otimes_a r \to n \otimes_a r$ then for some $i$ we have $u \otimes 1 = u' \otimes 1 : m \otimes_a r_i \to n \otimes_a r_i$. \item if $n$ is a finite $a$-module and $u : m \to n$ is an $a$-module map such that $u \otimes 1 : m \otimes_a r \to n \otimes_a r$ is surjective, then for some $i$ the map $u \otimes 1 : m \otimes_a r_i \to n \otimes_a r_i$ is surjective. \item if $n$ is a finitely presented $a$-module, and $v : n \otimes_a r \to m \otimes_a r$ is an $r$-module map, then there exists an $i$ and an $r_i$-module map $v_i : n \otimes_a r_i \to m \otimes_a r_i$ such that $v = v_i \otimes 1$. \item if $m$ is a finite $a$-module, $n$ is a finitely presented $a$-module, and $u : m \to n$ is an $a$-module map such that $u \otimes 1 : m \otimes_a r \to n \otimes_a r$ is an isomorphism, then for some $i$ the map $u \otimes 1 : m \otimes_a r_i \to n \otimes_a r_i$ is an isomorphism. \end{enumerate} \end{lemma} \begin{proof} to prove (1) assume $u$ is as in (1) and let $x_1, \ldots, x_m \in m$ be generators. since $n \otimes_a r = \colim_i n \otimes_a r_i$ we may pick an $i \in i$ such that $u(x_j) \otimes 1 = u'(x_j) \otimes 1$ in $m \otimes_a r_i$, $j = 1, \ldots, m$. for such an $i$ we have $u \otimes 1 = u' \otimes 1 : m \otimes_a r_i \to n \otimes_a r_i$. \medskip\noindent to prove (2) assume $u \otimes 1$ surjective and let $y_1, \ldots, y_m \in n$ be generators. since $n \otimes_a r = \colim_i n \otimes_a r_i$ we may pick an $i \in i$ and $z_j \in m \otimes_a r_i$, $j = 1, \ldots, m$ whose images in $n \otimes_a r$ equal $y_j \otimes 1$. for such an $i$ the map $u \otimes 1 : m \otimes_a r_i \to n \otimes_a r_i$ is surjective. \medskip\noindent to prove (3) let $y_1, \ldots, y_m \in n$ be generators. let $k = \ker(a^{\oplus m} \to n)$ where the map is given by the rule $(a_1, \ldots, a_m) \mapsto \sum a_j x_j$. let $k_1, \ldots, k_t$ be generators for $k$. say $k_s = (k_{s1}, \ldots, k_{sm})$. since $m \otimes_a r = \colim_i m \otimes_a r_i$ we may pick an $i \in i$ and $z_j \in m \otimes_a r_i$, $j = 1, \ldots, m$ whose images in $m \otimes_a r$ equal $v(y_j \otimes 1)$. we want to use the $z_j$ to define the map $v_i : n \otimes_a r_i \to m \otimes_a r_i$. since $k \otimes_a r_i \to r_i^{\oplus m} \to n \otimes_a r_i \to 0$ is a presentation, it suffices to check that $\xi_s = \sum_j k_{sj}z_j$ is zero in $m \otimes_a r_i$ for each $s = 1, \ldots, t$. this may not be the case, but since the image of $\xi_s$ in $m \otimes_a r$ is zero we see that it will be the case after increasing $i$ a bit. \medskip\noindent to prove (4) assume $u \otimes 1$ is an isomorphism, that $m$ is finite, and that $n$ is finitely presented. let $v : n \otimes_a r \to m \otimes_a r$ be an inverse to $u \otimes 1$. apply part (3) to get a map $v_i : n \otimes_a r_i \to m \otimes_a r_i$ for some $i$. apply part (1) to see that, after increasing $i$ we have $v_i \circ (u \otimes 1) = \text{id}_{m \otimes_r r_i}$ and $(u \otimes 1) \circ v_i = \text{id}_{n \otimes_r r_i}$. \end{proof} \begin{lemma} \label{lemma-colimit-category-fp-modules} suppose that $r = \colim_{\lambda \in \lambda} r_\lambda$ is a directed colimit of rings. then the category of finitely presented $r$-modules is the colimit of the categories of finitely presented $r_\lambda$-modules. more precisely \begin{enumerate} \item given a finitely presented $r$-module $m$ there exists a $\lambda \in \lambda$ and a finitely presented $r_\lambda$-module $m_\lambda$ such that $m \cong m_\lambda \otimes_{r_\lambda} r$. \item given a $\lambda \in \lambda$, finitely presented $r_\lambda$-modules $m_\lambda, n_\lambda$, and an $r$-module map $\varphi : m_\lambda \otimes_{r_\lambda} r \to n_\lambda \otimes_{r_\lambda} r$, then there exists a $\mu \geq \lambda$ and an $r_\mu$-module map $\varphi_\mu : m_\lambda \otimes_{r_\lambda} r_\mu \to n_\lambda \otimes_{r_\lambda} r_\mu$ such that $\varphi = \varphi_\mu \otimes 1_r$. \item given a $\lambda \in \lambda$, finitely presented $r_\lambda$-modules $m_\lambda, n_\lambda$, and $r$-module maps $\varphi_\lambda, \psi_\lambda : m_\lambda \to n_\lambda$ such that $\varphi \otimes 1_r = \psi \otimes 1_r$, then $\varphi \otimes 1_{r_\mu} = \psi \otimes 1_{r_\mu}$ for some $\mu \geq \lambda$. \end{enumerate} \end{lemma} \begin{proof} to prove (1) choose a presentation $r^{\oplus m} \to r^{\oplus n} \to m \to 0$. suppose that the first map is given by the matrix $a = (a_{ij})$. we can choose a $\lambda \in \lambda$ and a matrix $a_\lambda = (a_{\lambda, ij})$ with coefficients in $r_\lambda$ which maps to $a$ in $r$. then we simply let $m_\lambda$ be the $r_\lambda$-module with presentation $r_\lambda^{\oplus m} \to r_\lambda^{\oplus n} \to m_\lambda \to 0$ where the first arrow is given by $a_\lambda$. \medskip\noindent parts (2) and (3) follow from lemma \ref{lemma-module-map-property-in-colimit}. \end{proof} \begin{lemma} \label{lemma-algebra-map-property-in-colimit} let $a$ be a ring and let $b, c$ be $a$-algebras. suppose that $r = \colim_{i \in i} r_i$ is a directed colimit of $a$-algebras. \begin{enumerate} \item if $b$ is a finite type $a$-algebra, and $u, u' : b \to c$ are $a$-algebra maps such that $u \otimes 1 = u' \otimes 1 : b \otimes_a r \to c \otimes_a r$ then for some $i$ we have $u \otimes 1 = u' \otimes 1 : b \otimes_a r_i \to c \otimes_a r_i$. \item if $c$ is a finite type $a$-algebra and $u : b \to c$ is an $a$-algebra map such that $u \otimes 1 : b \otimes_a r \to c \otimes_a r$ is surjective, then for some $i$ the map $u \otimes 1 : b \otimes_a r_i \to c \otimes_a r_i$ is surjective. \item if $c$ is of finite presentation over $a$ and $v : c \otimes_a r \to b \otimes_a r$ is an $r$-algebra map, then there exists an $i$ and an $r_i$-algebra map $v_i : c \otimes_a r_i \to b \otimes_a r_i$ such that $v = v_i \otimes 1$. \item if $b$ is a finite type $a$-algebra, $c$ is a finitely presented $a$-algebra, and $u \otimes 1 : b \otimes_a r \to c \otimes_a r$ is an isomorphism, then for some $i$ the map $u \otimes 1 : b \otimes_a r_i \to c \otimes_a r_i$ is an isomorphism. \end{enumerate} \end{lemma} \begin{proof} to prove (1) assume $u$ is as in (1) and let $x_1, \ldots, x_m \in b$ be generators. since $b \otimes_a r = \colim_i b \otimes_a r_i$ we may pick an $i \in i$ such that $u(x_j) \otimes 1 = u'(x_j) \otimes 1$ in $b \otimes_a r_i$, $j = 1, \ldots, m$. for such an $i$ we have $u \otimes 1 = u' \otimes 1 : b \otimes_a r_i \to c \otimes_a r_i$. \medskip\noindent to prove (2) assume $u \otimes 1$ surjective and let $y_1, \ldots, y_m \in c$ be generators. since $b \otimes_a r = \colim_i b \otimes_a r_i$ we may pick an $i \in i$ and $z_j \in b \otimes_a r_i$, $j = 1, \ldots, m$ whose images in $c \otimes_a r$ equal $y_j \otimes 1$. for such an $i$ the map $u \otimes 1 : b \otimes_a r_i \to c \otimes_a r_i$ is surjective. \medskip\noindent to prove (3) let $c_1, \ldots, c_m \in c$ be generators. let $k = \ker(a[x_1, \ldots, x_m] \to n)$ where the map is given by the rule $x_j \mapsto \sum c_j$. let $f_1, \ldots, f_t$ be generators for $k$ as an ideal in $a[x_1, \ldots, x_m]$. we think of $f_j = f_j(x_1, \ldots, x_m)$ as a polynomial. since $b \otimes_a r = \colim_i b \otimes_a r_i$ we may pick an $i \in i$ and $z_j \in b \otimes_a r_i$, $j = 1, \ldots, m$ whose images in $b \otimes_a r$ equal $v(c_j \otimes 1)$. we want to use the $z_j$ to define a map $v_i : c \otimes_a r_i \to b \otimes_a r_i$. since $k \otimes_a r_i \to r_i[x_1, \ldots, x_m] \to c \otimes_a r_i \to 0$ is a presentation, it suffices to check that $\xi_s = f_j(z_1, \ldots, z_m)$ is zero in $b \otimes_a r_i$ for each $s = 1, \ldots, t$. this may not be the case, but since the image of $\xi_s$ in $b \otimes_a r$ is zero we see that it will be the case after increasing $i$ a bit. \medskip\noindent to prove (4) assume $u \otimes 1$ is an isomorphism, that $b$ is a finite type $a$-algebra, and that $c$ is a finitely presented $a$-algebra. let $v : b \otimes_a r \to c \otimes_a r$ be an inverse to $u \otimes 1$. let $v_i : c \otimes_a r_i \to b \otimes_a r_i$ be as in part (3). apply part (1) to see that, after increasing $i$ we have $v_i \circ (u \otimes 1) = \text{id}_{b \otimes_r r_i}$ and $(u \otimes 1) \circ v_i = \text{id}_{c \otimes_r r_i}$. \end{proof} \begin{lemma} \label{lemma-colimit-category-fp-algebras} suppose that $r = \colim_{\lambda \in \lambda} r_\lambda$ is a directed colimit of rings. then the category of finitely presented $r$-algebras is the colimit of the categories of finitely presented $r_\lambda$-algebras. more precisely \begin{enumerate} \item given a finitely presented $r$-algebra $a$ there exists a $\lambda \in \lambda$ and a finitely presented $r_\lambda$-algebra $a_\lambda$ such that $a \cong a_\lambda \otimes_{r_\lambda} r$. \item given a $\lambda \in \lambda$, finitely presented $r_\lambda$-algebras $a_\lambda, b_\lambda$, and an $r$-algebra map $\varphi : a_\lambda \otimes_{r_\lambda} r \to b_\lambda \otimes_{r_\lambda} r$, then there exists a $\mu \geq \lambda$ and an $r_\mu$-algebra map $\varphi_\mu : a_\lambda \otimes_{r_\lambda} r_\mu \to b_\lambda \otimes_{r_\lambda} r_\mu$ such that $\varphi = \varphi_\mu \otimes 1_r$. \item given a $\lambda \in \lambda$, finitely presented $r_\lambda$-algebras $a_\lambda, b_\lambda$, and $r_\lambda$-algebra maps $\varphi_\lambda, \psi_\lambda : a_\lambda \to b_\lambda$ such that $\varphi \otimes 1_r = \psi \otimes 1_r$, then $\varphi \otimes 1_{r_\mu} = \psi \otimes 1_{r_\mu}$ for some $\mu \geq \lambda$. \end{enumerate} \end{lemma} \begin{proof} to prove (1) choose a presentation $a = r[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$. we can choose a $\lambda \in \lambda$ and elements $f_{\lambda, j} \in r_\lambda[x_1, \ldots, x_n]$ mapping to $f_j \in r[x_1, \ldots, x_n]$. then we simply let $a_\lambda = r_\lambda[x_1, \ldots, x_n]/(f_{\lambda, 1}, \ldots, f_{\lambda, m})$. \medskip\noindent parts (2) and (3) follow from lemma \ref{lemma-algebra-map-property-in-colimit}. \end{proof} \begin{lemma} \label{lemma-limit-no-condition-local} suppose $r \to s$ is a local homomorphism of local rings. there exists a directed set $(\lambda, \leq)$, and a system of local homomorphisms $r_\lambda \to s_\lambda$ of local rings such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. \item each $r_\lambda$ is essentially of finite type over $\mathbf{z}$. \item each $s_\lambda$ is essentially of finite type over $r_\lambda$. \end{enumerate} \end{lemma} \begin{proof} denote $\varphi : r \to s$ the ring map. let $\mathfrak m \subset r$ be the maximal ideal of $r$ and let $\mathfrak n \subset s$ be the maximal ideal of $s$. let $$ \lambda = \{ (a, b) \mid a \subset r, b \subset s, \# a < \infty, \# b < \infty, \varphi(a) \subset b \}. $$ as partial ordering we take the inclusion relation. for each $\lambda = (a, b) \in \lambda$ we let $r'_\lambda$ be the sub $\mathbf{z}$-algebra generated by $a \in a$, and we let $s'_\lambda$ be the sub $\mathbf{z}$-algebra generated by $b$, $b \in b$. let $r_\lambda$ be the localization of $r'_\lambda$ at the prime ideal $r'_\lambda \cap \mathfrak m$ and let $s_\lambda$ be the localization of $s'_\lambda$ at the prime ideal $s'_\lambda \cap \mathfrak n$. in a picture $$ \xymatrix{ b \ar[r] & s'_\lambda \ar[r] & s_\lambda \ar[r] & s \\ a \ar[r] \ar[u] & r'_\lambda \ar[r] \ar[u] & r_\lambda \ar[r] \ar[u] & r \ar[u] }. $$ the transition maps are clear. we leave the proofs of the other assertions to the reader. \end{proof} \begin{lemma} \label{lemma-limit-essentially-finite-type} suppose $r \to s$ is a local homomorphism of local rings. assume that $s$ is essentially of finite type over $r$. then there exists a directed set $(\lambda, \leq)$, and a system of local homomorphisms $r_\lambda \to s_\lambda$ of local rings such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. \item each $r_\lambda$ is essentially of finite type over $\mathbf{z}$. \item each $s_\lambda$ is essentially of finite type over $r_\lambda$. \item for each $\lambda \leq \mu$ the map $s_\lambda \otimes_{r_\lambda} r_\mu \to s_\mu$ presents $s_\mu$ as the localization of a quotient of $s_\lambda \otimes_{r_\lambda} r_\mu$. \end{enumerate} \end{lemma} \begin{proof} denote $\varphi : r \to s$ the ring map. let $\mathfrak m \subset r$ be the maximal ideal of $r$ and let $\mathfrak n \subset s$ be the maximal ideal of $s$. let $x_1, \ldots, x_n \in s$ be elements such that $s$ is a localization of the sub $r$-algebra of $s$ generated by $x_1, \ldots, x_n$. in other words, $s$ is a quotient of a localization of the polynomial ring $r[x_1, \ldots, x_n]$. \medskip\noindent let $\lambda = \{ a \subset r \mid \# a < \infty\}$ be the set of finite subsets of $r$. as partial ordering we take the inclusion relation. for each $\lambda = a \in \lambda$ we let $r'_\lambda$ be the sub $\mathbf{z}$-algebra generated by $a \in a$, and we let $s'_\lambda$ be the sub $\mathbf{z}$-algebra generated by $\varphi(a)$, $a \in a$ and the elements $x_1, \ldots, x_n$. let $r_\lambda$ be the localization of $r'_\lambda$ at the prime ideal $r'_\lambda \cap \mathfrak m$ and let $s_\lambda$ be the localization of $s'_\lambda$ at the prime ideal $s'_\lambda \cap \mathfrak n$. in a picture $$ \xymatrix{ \varphi(a) \amalg \{x_i\} \ar[r] & s'_\lambda \ar[r] & s_\lambda \ar[r] & s \\ a \ar[r] \ar[u] & r'_\lambda \ar[r] \ar[u] & r_\lambda \ar[r] \ar[u] & r \ar[u] } $$ it is clear that if $a \subset b$ corresponds to $\lambda \leq \mu$ in $\lambda$, then there are canonical maps $r_\lambda \to r_\mu$, and $s_\lambda \to s_\mu$ and we obtain a system over the directed set $\lambda$. \medskip\noindent the assertion that $r = \colim r_\lambda$ is clear because all the maps $r_\lambda \to r$ are injective and any element of $r$ eventually is in the image. the same argument works for $s = \colim s_\lambda$. assertions (2), (3) are true by construction. the final assertion holds because clearly the maps $s'_\lambda \otimes_{r'_\lambda} r'_\mu \to s'_\mu$ are surjective. \end{proof} \begin{lemma} \label{lemma-limit-essentially-finite-presentation} suppose $r \to s$ is a local homomorphism of local rings. assume that $s$ is essentially of finite presentation over $r$. then there exists a directed set $(\lambda, \leq)$, and a system of local homomorphism $r_\lambda \to s_\lambda$ of local rings such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. \item each $r_\lambda$ is essentially of finite type over $\mathbf{z}$. \item each $s_\lambda$ is essentially of finite type over $r_\lambda$. \item for each $\lambda \leq \mu$ the map $s_\lambda \otimes_{r_\lambda} r_\mu \to s_\mu$ presents $s_\mu$ as the localization of $s_\lambda \otimes_{r_\lambda} r_\mu$ at a prime ideal. \end{enumerate} \end{lemma} \begin{proof} by assumption we may choose an isomorphism $\phi : (r[x_1, \ldots, x_n]/i)_{\mathfrak q} \to s$ where $i \subset r[x_1, \ldots, x_n]$ is a finitely generated ideal, and $\mathfrak q \subset r[x_1, \ldots, x_n]/i$ is a prime. (note that $r \cap \mathfrak q$ is equal to the maximal ideal $\mathfrak m$ of $r$.) we also choose generators $f_1, \ldots, f_m \in i$ for the ideal $i$. write $r$ in any way as a colimit $r = \colim r_\lambda$ over a directed set $(\lambda, \leq )$, with each $r_\lambda$ local and essentially of finite type over $\mathbf{z}$. there exists some $\lambda_0 \in \lambda$ such that $f_j$ is the image of some $f_{j, \lambda_0} \in r_{\lambda_0}[x_1, \ldots, x_n]$. for all $\lambda \geq \lambda_0$ denote $f_{j, \lambda} \in r_{\lambda}[x_1, \ldots, x_n]$ the image of $f_{j, \lambda_0}$. thus we obtain a system of ring maps $$ r_\lambda[x_1, \ldots, x_n]/(f_{1, \lambda}, \ldots, f_{m, \lambda}) \to r[x_1, \ldots, x_n]/(f_1, \ldots, f_m) \to s $$ set $\mathfrak q_\lambda$ the inverse image of $\mathfrak q$. set $s_\lambda = (r_\lambda[x_1, \ldots, x_n]/ (f_{1, \lambda}, \ldots, f_{m, \lambda}))_{\mathfrak q_\lambda}$. we leave it to the reader to see that this works. \end{proof} \begin{remark} \label{remark-suitable-systems-limits} suppose that $r \to s$ is a local homomorphism of local rings, which is essentially of finite presentation. take any system $(\lambda, \leq)$, $r_\lambda \to s_\lambda$ with the properties listed in lemma \ref{lemma-limit-essentially-finite-type}. what may happen is that this is the ``wrong'' system, namely, it may happen that property (4) of lemma \ref{lemma-limit-essentially-finite-presentation} is not satisfied. here is an example. let $k = \mathbf{f}_2$. consider the ring $$ r = \text{localization of } k[z, y_1, y_2, \ldots]/(y_i^2 - zy_{i + 1}) \text{ at }(z, y_1, y_2, \ldots) $$ set $s = r/zr$. as system take $\lambda = \mathbf{n}$ and $$ r_n = \text{localization of } k[z, y_1, \ldots, y_n]/(\{y_i^2 - zy_{i + 1}\}_{i \leq n-1}) \text{ at }(z, y_1, \ldots, y_n) $$ and $s_n = r_n/(z, y_n^2)$. all the maps $s_n \otimes_{r_n} r_{n + 1} \to s_{n + 1}$ are not localizations (i.e., isomorphisms in this case) since $1 \otimes y_{n + 1}^2$ maps to zero. if we take instead $s_n' = r_n/zr_n$ then the maps $s'_n \otimes_{r_n} r_{n + 1} \to s'_{n + 1}$ are isomorphisms. the moral of this remark is that we do have to be a little careful in choosing the systems. \end{remark} \begin{lemma} \label{lemma-limit-module-essentially-finite-presentation} suppose $r \to s$ is a local homomorphism of local rings. assume that $s$ is essentially of finite presentation over $r$. let $m$ be a finitely presented $s$-module. then there exists a directed set $(\lambda, \leq)$, and a system of local homomorphisms $r_\lambda \to s_\lambda$ of local rings together with $s_\lambda$-modules $m_\lambda$, such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. the colimit of the system $m_\lambda$ is $m$. \item each $r_\lambda$ is essentially of finite type over $\mathbf{z}$. \item each $s_\lambda$ is essentially of finite type over $r_\lambda$. \item each $m_\lambda$ is finite over $s_\lambda$. \item for each $\lambda \leq \mu$ the map $s_\lambda \otimes_{r_\lambda} r_\mu \to s_\mu$ presents $s_\mu$ as the localization of $s_\lambda \otimes_{r_\lambda} r_\mu$ at a prime ideal. \item for each $\lambda \leq \mu$ the map $m_\lambda \otimes_{s_\lambda} s_\mu \to m_\mu$ is an isomorphism. \end{enumerate} \end{lemma} \begin{proof} as in the proof of lemma \ref{lemma-limit-essentially-finite-presentation} we may first write $r = \colim r_\lambda$ as a directed colimit of local $\mathbf{z}$-algebras which are essentially of finite type. next, we may assume that for some $\lambda_1 \in \lambda$ there exist $f_{j, \lambda_1} \in r_{\lambda_1}[x_1, \ldots, x_n]$ such that $$ s = \colim_{\lambda \geq \lambda_1} s_\lambda, \text{ with } s_\lambda = (r_\lambda[x_1, \ldots, x_n]/ (f_{1, \lambda}, \ldots, f_{m, \lambda}))_{\mathfrak q_\lambda} $$ choose a presentation $$ s^{\oplus s} \to s^{\oplus t} \to m \to 0 $$ of $m$ over $s$. let $a \in \text{mat}(t \times s, s)$ be the matrix of the presentation. for some $\lambda_2 \in \lambda$, $\lambda_2 \geq \lambda_1$ we can find a matrix $a_{\lambda_2} \in \text{mat}(t \times s, s_{\lambda_2})$ which maps to $a$. for all $\lambda \geq \lambda_2$ we let $m_\lambda = \coker(s_\lambda^{\oplus s} \xrightarrow{a_\lambda} s_\lambda^{\oplus t})$. we leave it to the reader to see that this works. \end{proof} \begin{lemma} \label{lemma-limit-no-condition} suppose $r \to s$ is a ring map. then there exists a directed set $(\lambda, \leq)$, and a system of ring maps $r_\lambda \to s_\lambda$ such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. \item each $r_\lambda$ is of finite type over $\mathbf{z}$. \item each $s_\lambda$ is of finite type over $r_\lambda$. \end{enumerate} \end{lemma} \begin{proof} this is the non-local version of lemma \ref{lemma-limit-no-condition-local}. proof is similar and left to the reader. \end{proof} \begin{lemma} \label{lemma-limit-integral} suppose $r \to s$ is a ring map. assume that $s$ is integral over $r$. then there exists a directed set $(\lambda, \leq)$, and a system of ring maps $r_\lambda \to s_\lambda$ such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. \item each $r_\lambda$ is of finite type over $\mathbf{z}$. \item each $s_\lambda$ is finite over $r_\lambda$. \end{enumerate} \end{lemma} \begin{proof} consider the set $\lambda$ of pairs $(e, f)$ where $e \subset r$ is a finite subset, $f \subset s$ is a finite subset, and every element $f \in f$ is the root of a monic $p(x) \in r[x]$ whose coefficients are in $e$. say $(e, f) \leq (e', f')$ if $e \subset e'$ and $f \subset f'$. given $\lambda = (e, f) \in \lambda$ set $r_\lambda \subset r$ equal to the $\mathbf{z}$-subalgebra of $r$ generated by $e$ and $s_\lambda \subset s$ equal to the $\mathbf{z}$-subalgebra generated by $f$ and the image of $e$ in $s$. it is clear that $r = \colim r_\lambda$. we have $s = \colim s_\lambda$ as every element of $s$ is integral over $s$. the ring maps $r_\lambda \to s_\lambda$ are finite by lemma \ref{lemma-characterize-finite-in-terms-of-integral} and the fact that $s_\lambda$ is generated over $r_\lambda$ by the elements of $f$ which are integral over $r_\lambda$ by our condition on the pairs $(e, f)$. the lemma follows. \end{proof} \begin{lemma} \label{lemma-limit-finite-type} suppose $r \to s$ is a ring map. assume that $s$ is of finite type over $r$. then there exists a directed set $(\lambda, \leq)$, and a system of ring maps $r_\lambda \to s_\lambda$ such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. \item each $r_\lambda$ is of finite type over $\mathbf{z}$. \item each $s_\lambda$ is of finite type over $r_\lambda$. \item for each $\lambda \leq \mu$ the map $s_\lambda \otimes_{r_\lambda} r_\mu \to s_\mu$ presents $s_\mu$ as a quotient of $s_\lambda \otimes_{r_\lambda} r_\mu$. \end{enumerate} \end{lemma} \begin{proof} this is the non-local version of lemma \ref{lemma-limit-essentially-finite-type}. proof is similar and left to the reader. \end{proof} \begin{lemma} \label{lemma-limit-finite-presentation} suppose $r \to s$ is a ring map. assume that $s$ is of finite presentation over $r$. then there exists a directed set $(\lambda, \leq)$, and a system of ring maps $r_\lambda \to s_\lambda$ such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. \item each $r_\lambda$ is of finite type over $\mathbf{z}$. \item each $s_\lambda$ is of finite type over $r_\lambda$. \item for each $\lambda \leq \mu$ the map $s_\lambda \otimes_{r_\lambda} r_\mu \to s_\mu$ is an isomorphism. \end{enumerate} \end{lemma} \begin{proof} this is the non-local version of lemma \ref{lemma-limit-essentially-finite-presentation}. proof is similar and left to the reader. \end{proof} \begin{lemma} \label{lemma-limit-module-finite-presentation} suppose $r \to s$ is a ring map. assume that $s$ is of finite presentation over $r$. let $m$ be a finitely presented $s$-module. then there exists a directed set $(\lambda, \leq)$, and a system of ring maps $r_\lambda \to s_\lambda$ together with $s_\lambda$-modules $m_\lambda$, such that \begin{enumerate} \item the colimit of the system $r_\lambda \to s_\lambda$ is equal to $r \to s$. the colimit of the system $m_\lambda$ is $m$. \item each $r_\lambda$ is of finite type over $\mathbf{z}$. \item each $s_\lambda$ is of finite type over $r_\lambda$. \item each $m_\lambda$ is finite over $s_\lambda$. \item for each $\lambda \leq \mu$ the map $s_\lambda \otimes_{r_\lambda} r_\mu \to s_\mu$ is an isomorphism. \item for each $\lambda \leq \mu$ the map $m_\lambda \otimes_{s_\lambda} s_\mu \to m_\mu$ is an isomorphism. \end{enumerate} in particular, for every $\lambda \in \lambda$ we have $$ m = m_\lambda \otimes_{s_\lambda} s = m_\lambda \otimes_{r_\lambda} r. $$ \end{lemma} \begin{proof} this is the non-local version of lemma \ref{lemma-limit-module-essentially-finite-presentation}. proof is similar and left to the reader. \end{proof} \section{more flatness criteria} \label{section-more-flatness-criteria} \noindent the following lemma is often used in algebraic geometry to show that a finite morphism from a normal surface to a smooth surface is flat. it is a partial converse to lemma \ref{lemma-finite-flat-over-regular-cm} because an injective finite local ring map certainly satisfies condition (3). \begin{lemma} \label{lemma-cm-over-regular-flat} \begin{slogan} miracle flatness \end{slogan} let $r \to s$ be a local homomorphism of noetherian local rings. assume \begin{enumerate} \item $r$ is regular, \item $s$ cohen-macaulay, \item $\dim(s) = \dim(r) + \dim(s/\mathfrak m_r s)$. \end{enumerate} then $r \to s$ is flat. \end{lemma} \begin{proof} by induction on $\dim(r)$. the case $\dim(r) = 0$ is trivial, because then $r$ is a field. assume $\dim(r) > 0$. by (3) this implies that $\dim(s) > 0$. let $\mathfrak q_1, \ldots, \mathfrak q_r$ be the minimal primes of $s$. note that $\mathfrak q_i \not \supset \mathfrak m_r s$ since $$ \dim(s/\mathfrak q_i) = \dim(s) > \dim(s/\mathfrak m_r s) $$ the first equality by lemma \ref{lemma-maximal-chain-cm} and the inequality by (3). thus $\mathfrak p_i = r \cap \mathfrak q_i$ is not equal to $\mathfrak m_r$. pick $x \in \mathfrak m_r$, $x \not \in \mathfrak m_r^2$, and $x \not \in \mathfrak p_i$, see lemma \ref{lemma-silly}. hence we see that $x$ is not contained in any of the minimal primes of $s$. hence $x$ is a nonzerodivisor on $s$ by (2), see lemma \ref{lemma-reformulate-cm} and $s/xs$ is cohen-macaulay with $\dim(s/xs) = \dim(s) - 1$. by (1) and lemma \ref{lemma-regular-ring-cm} the ring $r/xr$ is regular with $\dim(r/xr) = \dim(r) - 1$. by induction we see that $r/xr \to s/xs$ is flat. hence we conclude by lemma \ref{lemma-variant-local-criterion-flatness} and the remark following it. \end{proof} \begin{lemma} \label{lemma-flat-over-regular} let $r \to s$ be a homomorphism of noetherian local rings. assume that $r$ is a regular local ring and that a regular system of parameters maps to a regular sequence in $s$. then $r \to s$ is flat. \end{lemma} \begin{proof} suppose that $x_1, \ldots, x_d$ are a system of parameters of $r$ which map to a regular sequence in $s$. note that $s/(x_1, \ldots, x_d)s$ is flat over $r/(x_1, \ldots, x_d)$ as the latter is a field. then $x_d$ is a nonzerodivisor in $s/(x_1, \ldots, x_{d - 1})s$ hence $s/(x_1, \ldots, x_{d - 1})s$ is flat over $r/(x_1, \ldots, x_{d - 1})$ by the local criterion of flatness (see lemma \ref{lemma-variant-local-criterion-flatness} and remarks following). then $x_{d - 1}$ is a nonzerodivisor in $s/(x_1, \ldots, x_{d - 2})s$ hence $s/(x_1, \ldots, x_{d - 2})s$ is flat over $r/(x_1, \ldots, x_{d - 2})$ by the local criterion of flatness (see lemma \ref{lemma-variant-local-criterion-flatness} and remarks following). continue till one reaches the conclusion that $s$ is flat over $r$. \end{proof} \noindent the following lemma is the key to proving that results for finitely presented modules over finitely presented rings over a base ring follow from the corresponding results for finite modules in the noetherian case. \begin{lemma} \label{lemma-colimit-eventually-flat} let $r \to s$, $m$, $\lambda$, $r_\lambda \to s_\lambda$, $m_\lambda$ be as in lemma \ref{lemma-limit-module-essentially-finite-presentation}. assume that $m$ is flat over $r$. then for some $\lambda \in \lambda$ the module $m_\lambda$ is flat over $r_\lambda$. \end{lemma} \begin{proof} pick some $\lambda \in \lambda$ and consider $$ \text{tor}_1^{r_\lambda}(m_\lambda, r_\lambda/\mathfrak m_\lambda) = \ker(\mathfrak m_\lambda \otimes_{r_\lambda} m_\lambda \to m_\lambda). $$ see remark \ref{remark-tor-ring-mod-ideal}. the right hand side shows that this is a finitely generated $s_\lambda$-module (because $s_\lambda$ is noetherian and the modules in question are finite). let $\xi_1, \ldots, \xi_n$ be generators. because $m$ is flat over $r$ we have that $0 = \ker(\mathfrak m_\lambda r \otimes_r m \to m)$. since $\otimes$ commutes with colimits we see there exists a $\lambda' \geq \lambda$ such that each $\xi_i$ maps to zero in $\mathfrak m_{\lambda}r_{\lambda'} \otimes_{r_{\lambda'}} m_{\lambda'}$. hence we see that $$ \text{tor}_1^{r_\lambda}(m_\lambda, r_\lambda/\mathfrak m_\lambda) \longrightarrow \text{tor}_1^{r_{\lambda'}}(m_{\lambda'}, r_{\lambda'}/\mathfrak m_{\lambda}r_{\lambda'}) $$ is zero. note that $m_\lambda \otimes_{r_\lambda} r_\lambda/\mathfrak m_\lambda$ is flat over $r_\lambda/\mathfrak m_\lambda$ because this last ring is a field. hence we may apply lemma \ref{lemma-another-variant-local-criterion-flatness} to get that $m_{\lambda'}$ is flat over $r_{\lambda'}$. \end{proof} \noindent using the lemma above we can start to reprove the results of section \ref{section-criteria-flatness} in the non-noetherian case. \begin{lemma} \label{lemma-mod-injective-general} suppose that $r \to s$ is a local homomorphism of local rings. denote $\mathfrak m$ the maximal ideal of $r$. let $u : m \to n$ be a map of $s$-modules. assume \begin{enumerate} \item $s$ is essentially of finite presentation over $r$, \item $m$, $n$ are finitely presented over $s$, \item $n$ is flat over $r$, and \item $\overline{u} : m/\mathfrak mm \to n/\mathfrak mn$ is injective. \end{enumerate} then $u$ is injective, and $n/u(m)$ is flat over $r$. \end{lemma} \begin{proof} by lemma \ref{lemma-limit-module-essentially-finite-presentation} and its proof we can find a system $r_\lambda \to s_\lambda$ of local ring maps together with maps of $s_\lambda$-modules $u_\lambda : m_\lambda \to n_\lambda$ satisfying the conclusions (1) -- (6) for both $n$ and $m$ of that lemma and such that the colimit of the maps $u_\lambda$ is $u$. by lemma \ref{lemma-colimit-eventually-flat} we may assume that $n_\lambda$ is flat over $r_\lambda$ for all sufficiently large $\lambda$. denote $\mathfrak m_\lambda \subset r_\lambda$ the maximal ideal and $\kappa_\lambda = r_\lambda / \mathfrak m_\lambda$, resp.\ $\kappa = r/\mathfrak m$ the residue fields. \medskip\noindent consider the map $$ \psi_\lambda : m_\lambda/\mathfrak m_\lambda m_\lambda \otimes_{\kappa_\lambda} \kappa \longrightarrow m/\mathfrak m m. $$ since $s_\lambda/\mathfrak m_\lambda s_\lambda$ is essentially of finite type over the field $\kappa_\lambda$ we see that the tensor product $s_\lambda/\mathfrak m_\lambda s_\lambda \otimes_{\kappa_\lambda} \kappa$ is essentially of finite type over $\kappa$. hence it is a noetherian ring and we conclude the kernel of $\psi_\lambda$ is finitely generated. since $m/\mathfrak m m$ is the colimit of the system $m_\lambda/\mathfrak m_\lambda m_\lambda$ and $\kappa$ is the colimit of the fields $\kappa_\lambda$ there exists a $\lambda' > \lambda$ such that the kernel of $\psi_\lambda$ is generated by the kernel of $$ \psi_{\lambda, \lambda'} : m_\lambda/\mathfrak m_\lambda m_\lambda \otimes_{\kappa_\lambda} \kappa_{\lambda'} \longrightarrow m_{\lambda'}/\mathfrak m_{\lambda'} m_{\lambda'}. $$ by construction there exists a multiplicative subset $w \subset s_\lambda \otimes_{r_\lambda} r_{\lambda'}$ such that $s_{\lambda'} = w^{-1}(s_\lambda \otimes_{r_\lambda} r_{\lambda'})$ and $$ w^{-1}(m_\lambda/\mathfrak m_\lambda m_\lambda \otimes_{\kappa_\lambda} \kappa_{\lambda'}) = m_{\lambda'}/\mathfrak m_{\lambda'} m_{\lambda'}. $$ now suppose that $x$ is an element of the kernel of $$ \psi_{\lambda'} : m_{\lambda'}/\mathfrak m_{\lambda'} m_{\lambda'} \otimes_{\kappa_{\lambda'}} \kappa \longrightarrow m/\mathfrak m m. $$ then for some $w \in w$ we have $wx \in m_\lambda/\mathfrak m_\lambda m_\lambda \otimes \kappa$. hence $wx \in \ker(\psi_\lambda)$. hence $wx$ is a linear combination of elements in the kernel of $\psi_{\lambda, \lambda'}$. hence $wx = 0$ in $m_{\lambda'}/\mathfrak m_{\lambda'} m_{\lambda'} \otimes_{\kappa_{\lambda'}} \kappa$, hence $x = 0$ because $w$ is invertible in $s_{\lambda'}$. we conclude that the kernel of $\psi_{\lambda'}$ is zero for all sufficiently large $\lambda'$! \medskip\noindent by the result of the preceding paragraph we may assume that the kernel of $\psi_\lambda$ is zero for all $\lambda$ sufficiently large, which implies that the map $m_\lambda/\mathfrak m_\lambda m_\lambda \to m/\mathfrak m m$ is injective. combined with $\overline{u}$ being injective this formally implies that also $\overline{u_\lambda} : m_\lambda/\mathfrak m_\lambda m_\lambda \to n_\lambda/\mathfrak m_\lambda n_\lambda$ is injective. by lemma \ref{lemma-mod-injective} we conclude that (for all sufficiently large $\lambda$) the map $u_\lambda$ is injective and that $n_\lambda/u_\lambda(m_\lambda)$ is flat over $r_\lambda$. the lemma follows. \end{proof} \begin{lemma} \label{lemma-grothendieck-general} suppose that $r \to s$ is a local ring homomorphism of local rings. denote $\mathfrak m$ the maximal ideal of $r$. suppose \begin{enumerate} \item $s$ is essentially of finite presentation over $r$, \item $s$ is flat over $r$, and \item $f \in s$ is a nonzerodivisor in $s/{\mathfrak m}s$. \end{enumerate} then $s/fs$ is flat over $r$, and $f$ is a nonzerodivisor in $s$. \end{lemma} \begin{proof} follows directly from lemma \ref{lemma-mod-injective-general}. \end{proof} \begin{lemma} \label{lemma-grothendieck-regular-sequence-general} suppose that $r \to s$ is a local ring homomorphism of local rings. denote $\mathfrak m$ the maximal ideal of $r$. suppose \begin{enumerate} \item $r \to s$ is essentially of finite presentation, \item $r \to s$ is flat, and \item $f_1, \ldots, f_c$ is a sequence of elements of $s$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$ form a regular sequence in $s/{\mathfrak m}s$. \end{enumerate} then $f_1, \ldots, f_c$ is a regular sequence in $s$ and each of the quotients $s/(f_1, \ldots, f_i)$ is flat over $r$. \end{lemma} \begin{proof} induction and lemma \ref{lemma-grothendieck-general}. \end{proof} \noindent here is the version of the local criterion of flatness for the case of local ring maps which are locally of finite presentation. \begin{lemma} \label{lemma-variant-local-criterion-flatness-general} let $r \to s$ be a local homomorphism of local rings. let $i \not = r$ be an ideal in $r$. let $m$ be an $s$-module. assume \begin{enumerate} \item $s$ is essentially of finite presentation over $r$, \item $m$ is of finite presentation over $s$, \item $\text{tor}_1^r(m, r/i) = 0$, and \item $m/im$ is flat over $r/i$. \end{enumerate} then $m$ is flat over $r$. \end{lemma} \begin{proof} let $\lambda$, $r_\lambda \to s_\lambda$, $m_\lambda$ be as in lemma \ref{lemma-limit-module-essentially-finite-presentation}. denote $i_\lambda \subset r_\lambda$ the inverse image of $i$. in this case the system $r/i \to s/is$, $m/im$, $r_\lambda \to s_\lambda/i_\lambda s_\lambda$, and $m_\lambda/i_\lambda m_\lambda$ satisfies the conclusions of lemma \ref{lemma-limit-module-essentially-finite-presentation} as well. hence by lemma \ref{lemma-colimit-eventually-flat} we may assume (after shrinking the index set $\lambda$) that $m_\lambda/i_\lambda m_\lambda$ is flat for all $\lambda$. pick some $\lambda$ and consider $$ \text{tor}_1^{r_\lambda}(m_\lambda, r_\lambda/i_\lambda) = \ker(i_\lambda \otimes_{r_\lambda} m_\lambda \to m_\lambda). $$ see remark \ref{remark-tor-ring-mod-ideal}. the right hand side shows that this is a finitely generated $s_\lambda$-module (because $s_\lambda$ is noetherian and the modules in question are finite). let $\xi_1, \ldots, \xi_n$ be generators. because $\text{tor}_1^r(m, r/i) = 0$ and since $\otimes$ commutes with colimits we see there exists a $\lambda' \geq \lambda$ such that each $\xi_i$ maps to zero in $\text{tor}_1^{r_{\lambda'}}(m_{\lambda'}, r_{\lambda'}/i_{\lambda'})$. the composition of the maps $$ \xymatrix{ r_{\lambda'} \otimes_{r_\lambda} \text{tor}_1^{r_\lambda}(m_\lambda, r_\lambda/i_\lambda) \ar[d]^{\text{surjective by lemma \ref{lemma-surjective-on-tor-one}}} \\ \text{tor}_1^{r_\lambda}(m_\lambda, r_{\lambda'}/i_\lambda r_{\lambda'}) \ar[d]^{\text{surjective up to localization by lemma \ref{lemma-surjective-on-tor-one-trivial}}} \\ \text{tor}_1^{r_{\lambda'}}(m_{\lambda'}, r_{\lambda'}/i_\lambda r_{\lambda'}) \ar[d]^{\text{surjective by lemma \ref{lemma-surjective-on-tor-one}}} \\ \text{tor}_1^{r_{\lambda'}}(m_{\lambda'}, r_{\lambda'}/i_{\lambda'}). } $$ is surjective up to a localization by the reasons indicated. the localization is necessary since $m_{\lambda'}$ is not equal to $m_\lambda \otimes_{r_\lambda} r_{\lambda'}$. namely, it is equal to $m_\lambda \otimes_{s_\lambda} s_{\lambda'}$ and $s_{\lambda'}$ is the localization of $s_{\lambda} \otimes_{r_\lambda} r_{\lambda'}$ whence the statement up to a localization (or tensoring with $s_{\lambda'}$). note that lemma \ref{lemma-surjective-on-tor-one} applies to the first and third arrows because $m_\lambda/i_\lambda m_\lambda$ is flat over $r_\lambda/i_\lambda$ and because $m_{\lambda'}/i_\lambda m_{\lambda'}$ is flat over $r_{\lambda'}/i_\lambda r_{\lambda'}$ as it is a base change of the flat module $m_\lambda/i_\lambda m_\lambda$. the composition maps the generators $\xi_i$ to zero as we explained above. we finally conclude that $\text{tor}_1^{r_{\lambda'}}(m_{\lambda'}, r_{\lambda'}/i_{\lambda'})$ is zero. this implies that $m_{\lambda'}$ is flat over $r_{\lambda'}$ by lemma \ref{lemma-variant-local-criterion-flatness}. \end{proof} \noindent please compare the lemma below to lemma \ref{lemma-criterion-flatness-fibre-noetherian} (the case of noetherian local rings) and lemma \ref{lemma-criterion-flatness-fibre-nilpotent} (the case of a nilpotent ideal in the base). \begin{lemma}[crit\`ere de platitude par fibres] \label{lemma-criterion-flatness-fibre} let $r$, $s$, $s'$ be local rings and let $r \to s \to s'$ be local ring homomorphisms. let $m$ be an $s'$-module. let $\mathfrak m \subset r$ be the maximal ideal. assume \begin{enumerate} \item the ring maps $r \to s$ and $r \to s'$ are essentially of finite presentation. \item the module $m$ is of finite presentation over $s'$. \item the module $m$ is not zero. \item the module $m/\mathfrak mm$ is a flat $s/\mathfrak ms$-module. \item the module $m$ is a flat $r$-module. \end{enumerate} then $s$ is flat over $r$ and $m$ is a flat $s$-module. \end{lemma} \begin{proof} as in the proof of lemma \ref{lemma-limit-essentially-finite-presentation} we may first write $r = \colim r_\lambda$ as a directed colimit of local $\mathbf{z}$-algebras which are essentially of finite type. denote $\mathfrak p_\lambda$ the maximal ideal of $r_\lambda$. next, we may assume that for some $\lambda_1 \in \lambda$ there exist $f_{j, \lambda_1} \in r_{\lambda_1}[x_1, \ldots, x_n]$ such that $$ s = \colim_{\lambda \geq \lambda_1} s_\lambda, \text{ with } s_\lambda = (r_\lambda[x_1, \ldots, x_n]/ (f_{1, \lambda}, \ldots, f_{u, \lambda}))_{\mathfrak q_\lambda} $$ for some $\lambda_2 \in \lambda$, $\lambda_2 \geq \lambda_1$ there exist $g_{j, \lambda_2} \in r_{\lambda_2}[x_1, \ldots, x_n, y_1, \ldots, y_m]$ with images $\overline{g}_{j, \lambda_2} \in s_{\lambda_2}[y_1, \ldots, y_m]$ such that $$ s' = \colim_{\lambda \geq \lambda_2} s'_\lambda, \text{ with } s'_\lambda = (s_\lambda[y_1, \ldots, y_m]/ (\overline{g}_{1, \lambda}, \ldots, \overline{g}_{v, \lambda}))_{\overline{\mathfrak q}'_\lambda} $$ note that this also implies that $$ s'_\lambda = (r_\lambda[x_1, \ldots, x_n, y_1, \ldots, y_m]/ (g_{1, \lambda}, \ldots, g_{v, \lambda}))_{\mathfrak q'_\lambda} $$ choose a presentation $$ (s')^{\oplus s} \to (s')^{\oplus t} \to m \to 0 $$ of $m$ over $s'$. let $a \in \text{mat}(t \times s, s')$ be the matrix of the presentation. for some $\lambda_3 \in \lambda$, $\lambda_3 \geq \lambda_2$ we can find a matrix $a_{\lambda_3} \in \text{mat}(t \times s, s_{\lambda_3})$ which maps to $a$. for all $\lambda \geq \lambda_3$ we let $m_\lambda = \coker((s'_\lambda)^{\oplus s} \xrightarrow{a_\lambda} (s'_\lambda)^{\oplus t})$. \medskip\noindent with these choices, we have for each $\lambda_3 \leq \lambda \leq \mu$ that $s_\lambda \otimes_{r_{\lambda}} r_\mu \to s_\mu$ is a localization, $s'_\lambda \otimes_{s_{\lambda}} s_\mu \to s'_\mu$ is a localization, and the map $m_\lambda \otimes_{s'_\lambda} s'_\mu \to m_\mu$ is an isomorphism. this also implies that $s'_\lambda \otimes_{r_{\lambda}} r_\mu \to s'_\mu$ is a localization. thus, since $m$ is flat over $r$ we see by lemma \ref{lemma-colimit-eventually-flat} that for all $\lambda$ big enough the module $m_\lambda$ is flat over $r_\lambda$. moreover, note that $ \mathfrak m = \colim \mathfrak p_\lambda $, $ s/\mathfrak ms = \colim s_\lambda/\mathfrak p_\lambda s_\lambda $, $ s'/\mathfrak ms' = \colim s'_\lambda/\mathfrak p_\lambda s'_\lambda $, and $ m/\mathfrak mm = \colim m_\lambda/\mathfrak p_\lambda m_\lambda $. also, for each $\lambda_3 \leq \lambda \leq \mu$ we see (from the properties listed above) that $$ s'_\lambda/\mathfrak p_\lambda s'_\lambda \otimes_{s_{\lambda}/\mathfrak p_\lambda s_\lambda} s_\mu/\mathfrak p_\mu s_\mu \longrightarrow s'_\mu/\mathfrak p_\mu s'_\mu $$ is a localization, and the map $$ m_\lambda / \mathfrak p_\lambda m_\lambda \otimes_{s'_\lambda/\mathfrak p_\lambda s'_\lambda} s'_\mu /\mathfrak p_\mu s'_\mu \longrightarrow m_\mu/\mathfrak p_\mu m_\mu $$ is an isomorphism. hence the system $(s_\lambda/\mathfrak p_\lambda s_\lambda \to s'_\lambda/\mathfrak p_\lambda s'_\lambda, m_\lambda/\mathfrak p_\lambda m_\lambda)$ is a system as in lemma \ref{lemma-limit-module-essentially-finite-presentation} as well. we may apply lemma \ref{lemma-colimit-eventually-flat} again because $m/\mathfrak m m$ is assumed flat over $s/\mathfrak ms$ and we see that $m_\lambda/\mathfrak p_\lambda m_\lambda$ is flat over $s_\lambda/\mathfrak p_\lambda s_\lambda$ for all $\lambda$ big enough. thus for $\lambda$ big enough the data $r_\lambda \to s_\lambda \to s'_\lambda, m_\lambda$ satisfies the hypotheses of lemma \ref{lemma-criterion-flatness-fibre-noetherian}. pick such a $\lambda$. then $s = s_\lambda \otimes_{r_\lambda} r$ is flat over $r$, and $m = m_\lambda \otimes_{s_\lambda} s$ is flat over $s$ (since the base change of a flat module is flat). \end{proof} \noindent the following is an easy consequence of the ``crit\`ere de platitude par fibres'' lemma \ref{lemma-criterion-flatness-fibre}. for more results of this kind see more on flatness, section \ref{flat-section-introduction}. \begin{lemma} \label{lemma-criterion-flatness-fibre-fp-over-ft} let $r$, $s$, $s'$ be local rings and let $r \to s \to s'$ be local ring homomorphisms. let $m$ be an $s'$-module. let $\mathfrak m \subset r$ be the maximal ideal. assume \begin{enumerate} \item $r \to s'$ is essentially of finite presentation, \item $r \to s$ is essentially of finite type, \item $m$ is of finite presentation over $s'$, \item $m$ is not zero, \item $m/\mathfrak mm$ is a flat $s/\mathfrak ms$-module, and \item $m$ is a flat $r$-module. \end{enumerate} then $s$ is essentially of finite presentation and flat over $r$ and $m$ is a flat $s$-module. \end{lemma} \begin{proof} as $s$ is essentially of finite presentation over $r$ we can write $s = c_{\overline{\mathfrak q}}$ for some finite type $r$-algebra $c$. write $c = r[x_1, \ldots, x_n]/i$. denote $\mathfrak q \subset r[x_1, \ldots, x_n]$ be the prime ideal corresponding to $\overline{\mathfrak q}$. then we see that $s = b/j$ where $b = r[x_1, \ldots, x_n]_{\mathfrak q}$ is essentially of finite presentation over $r$ and $j = ib$. we can find $f_1, \ldots, f_k \in j$ such that the images $\overline{f}_i \in b/\mathfrak mb$ generate the image $\overline{j}$ of $j$ in the noetherian ring $b/\mathfrak mb$. hence there exist finitely generated ideals $j' \subset j$ such that $b/j' \to b/j$ induces an isomorphism $$ (b/j') \otimes_r r/\mathfrak m \longrightarrow b/j \otimes_r r/\mathfrak m = s/\mathfrak ms. $$ for any $j'$ as above we see that lemma \ref{lemma-criterion-flatness-fibre} applies to the ring maps $$ r \longrightarrow b/j' \longrightarrow s' $$ and the module $m$. hence we conclude that $b/j'$ is flat over $r$ for any choice $j'$ as above. now, if $j' \subset j' \subset j$ are two finitely generated ideals as above, then we conclude that $b/j' \to b/j''$ is a surjective map between flat $r$-algebras which are essentially of finite presentation which is an isomorphism modulo $\mathfrak m$. hence lemma \ref{lemma-mod-injective-general} implies that $b/j' = b/j''$, i.e., $j' = j''$. clearly this means that $j$ is finitely generated, i.e., $s$ is essentially of finite presentation over $r$. thus we may apply lemma \ref{lemma-criterion-flatness-fibre} to $r \to s \to s'$ and we win. \end{proof} \begin{lemma}[crit\`ere de platitude par fibres: locally nilpotent case] \label{lemma-criterion-flatness-fibre-locally-nilpotent} let $$ \xymatrix{ s \ar[rr] & & s' \\ & r \ar[lu] \ar[ru] } $$ be a commutative diagram in the category of rings. let $i \subset r$ be a locally nilpotent ideal and $m$ an $s'$-module. assume \begin{enumerate} \item $r \to s$ is of finite type, \item $r \to s'$ is of finite presentation, \item $m$ is a finitely presented $s'$-module, \item $m/im$ is flat as a $s/is$-module, and \item $m$ is flat as an $r$-module. \end{enumerate} then $m$ is a flat $s$-module and $s_\mathfrak q$ is flat and essentially of finite presentation over $r$ for every $\mathfrak q \subset s$ such that $m \otimes_s \kappa(\mathfrak q)$ is nonzero. \end{lemma} \begin{proof} if $m \otimes_s \kappa(\mathfrak q)$ is nonzero, then $s' \otimes_s \kappa(\mathfrak q)$ is nonzero and hence there exists a prime $\mathfrak q' \subset s'$ lying over $\mathfrak q$ (lemma \ref{lemma-in-image}). let $\mathfrak p \subset r$ be the image of $\mathfrak q$ in $\spec(r)$. then $i \subset \mathfrak p$ as $i$ is locally nilpotent hence $m/\mathfrak p m$ is flat over $s/\mathfrak ps$. hence we may apply lemma \ref{lemma-criterion-flatness-fibre-fp-over-ft} to $r_\mathfrak p \to s_\mathfrak q \to s'_{\mathfrak q'}$ and $m_{\mathfrak q'}$. we conclude that $m_{\mathfrak q'}$ is flat over $s$ and $s_\mathfrak q$ is flat and essentially of finite presentation over $r$. since $\mathfrak q'$ was an arbitrary prime of $s'$ we also see that $m$ is flat over $s$ (lemma \ref{lemma-flat-localization}). \end{proof} \section{openness of the flat locus} \label{section-open-flat} \noindent we use lemma \ref{lemma-colimit-eventually-flat} to reduce to the noetherian case. the noetherian case is handled using the characterization of exact complexes given in section \ref{section-complex-exact}. \begin{lemma} \label{lemma-cm-dim-finite-type} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $f_1, \ldots, f_i$ be elements of $s$. assume that $s$ is cohen-macaulay and equidimensional of dimension $d$, and that $\dim v(f_1, \ldots, f_i) \leq d - i$. then equality holds and $f_1, \ldots, f_i$ forms a regular sequence in $s_{\mathfrak q}$ for every prime $\mathfrak q$ of $v(f_1, \ldots, f_i)$. \end{lemma} \begin{proof} if $s$ is cohen-macaulay and equidimensional of dimension $d$, then we have $\dim(s_{\mathfrak m}) = d$ for all maximal ideals $\mathfrak m$ of $s$, see lemma \ref{lemma-disjoint-decomposition-cm-algebra}. by proposition \ref{proposition-cm-module} we see that for all maximal ideals $\mathfrak m \in v(f_1, \ldots, f_i)$ the sequence is a regular sequence in $s_{\mathfrak m}$ and the local ring $s_{\mathfrak m}/(f_1, \ldots, f_i)$ is cohen-macaulay of dimension $d - i$. this actually means that $s/(f_1, \ldots, f_i)$ is cohen-macaulay and equidimensional of dimension $d - i$. \end{proof} \begin{lemma} \label{lemma-open-regular-sequence} let $r \to s$ be a finite type ring map. let $d$ be an integer such that all fibres $s \otimes_r \kappa(\mathfrak p)$ are cohen-macaulay and equidimensional of dimension $d$. let $f_1, \ldots, f_i$ be elements of $s$. the set $$ \{ \mathfrak q \in v(f_1, \ldots, f_i) \mid f_1, \ldots, f_i \text{ are a regular sequence in } s_{\mathfrak q}/\mathfrak p s_{\mathfrak q} \text{ where }\mathfrak p = r \cap \mathfrak q \} $$ is open in $v(f_1, \ldots, f_i)$. \end{lemma} \begin{proof} write $\overline{s} = s/(f_1, \ldots, f_i)$. suppose $\mathfrak q$ is an element of the set defined in the lemma, and $\mathfrak p$ is the corresponding prime of $r$. we will use relative dimension as defined in definition \ref{definition-relative-dimension}. first, note that $d = \dim_{\mathfrak q}(s/r) = \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) + \text{trdeg}_{\kappa(\mathfrak p)}\ \kappa(\mathfrak q)$ by lemma \ref{lemma-dimension-at-a-point-finite-type-field}. since $f_1, \ldots, f_i$ form a regular sequence in the noetherian local ring $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ lemma \ref{lemma-one-equation} tells us that $\dim(\overline{s}_{\mathfrak q}/\mathfrak p\overline{s}_{\mathfrak q}) = \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) - i$. we conclude that $\dim_{\mathfrak q}(\overline{s}/r) = \dim(\overline{s}_{\mathfrak q}/\mathfrak p\overline{s}_{\mathfrak q}) + \text{trdeg}_{\kappa(\mathfrak p)}\ \kappa(\mathfrak q) = d - i$ by lemma \ref{lemma-dimension-at-a-point-finite-type-field}. by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs} we have $\dim_{\mathfrak q'}(\overline{s}/r) \leq d - i$ for all $\mathfrak q' \in v(f_1, \ldots, f_i) = \spec(\overline{s})$ in a neighbourhood of $\mathfrak q$. thus after replacing $s$ by $s_g$ for some $g \in s$, $g \not \in \mathfrak q$ we may assume that the inequality holds for all $\mathfrak q'$. the result follows from lemma \ref{lemma-cm-dim-finite-type}. \end{proof} \begin{lemma} \label{lemma-exact-on-fibres-open} let $r \to s$ be a ring map. consider a finite homological complex of finite free $s$-modules: $$ f_{\bullet} : 0 \to s^{n_e} \xrightarrow{\varphi_e} s^{n_{e-1}} \xrightarrow{\varphi_{e-1}} \ldots \xrightarrow{\varphi_{i + 1}} s^{n_i} \xrightarrow{\varphi_i} s^{n_{i-1}} \xrightarrow{\varphi_{i-1}} \ldots \xrightarrow{\varphi_1} s^{n_0} $$ for every prime $\mathfrak q$ of $s$ consider the complex $\overline{f}_{\bullet, \mathfrak q} = f_{\bullet, \mathfrak q} \otimes_r \kappa(\mathfrak p)$ where $\mathfrak p$ is inverse image of $\mathfrak q$ in $r$. assume $r$ is noetherian and there exists an integer $d$ such that $r \to s$ is finite type, flat with fibres $s \otimes_r \kappa(\mathfrak p)$ cohen-macaulay of dimension $d$. the set $$ \{\mathfrak q \in \spec(s) \mid \overline{f}_{\bullet, \mathfrak q}\text{ is exact}\} $$ is open in $\spec(s)$. \end{lemma} \begin{proof} let $\mathfrak q$ be an element of the set defined in the lemma. we are going to use proposition \ref{proposition-what-exact} to show there exists a $g \in s$, $g \not \in \mathfrak q$ such that $d(g)$ is contained in the set defined in the lemma. in other words, we are going to show that after replacing $s$ by $s_g$, the set of the lemma is all of $\spec(s)$. thus during the proof we will, finitely often, replace $s$ by such a localization. recall that proposition \ref{proposition-what-exact} characterizes exactness of complexes in terms of ranks of the maps $\varphi_i$ and the ideals $i(\varphi_i)$, in case the ring is local. we first address the rank condition. set $r_i = n_i - n_{i + 1} + \ldots + (-1)^{e - i} n_e$. note that $r_i + r_{i + 1} = n_i$ and note that $r_i$ is the expected rank of $\varphi_i$ (in the exact case). \medskip\noindent by lemma \ref{lemma-complex-exact-mod} we see that if $\overline{f}_{\bullet, \mathfrak q}$ is exact, then the localization $f_{\bullet, \mathfrak q}$ is exact. in particular the complex $f_\bullet$ becomes exact after localizing by an element $g \in s$, $g \not \in \mathfrak q$. in this case proposition \ref{proposition-what-exact} applied to all localizations of $s$ at prime ideals implies that all $(r_i + 1) \times (r_i + 1)$-minors of $\varphi_i$ are zero. thus we see that the rank of $\varphi_i$ is at most $r_i$. \medskip\noindent let $i_i \subset s$ denote the ideal generated by the $r_i \times r_i$-minors of the matrix of $\varphi_i$. by proposition \ref{proposition-what-exact} the complex $\overline{f}_{\bullet, \mathfrak q}$ is exact if and only if for every $1 \leq i \leq e$ we have either $(i_i)_{\mathfrak q} = s_{\mathfrak q}$ or $(i_i)_{\mathfrak q}$ contains a $s_{\mathfrak q}/\mathfrak p s_{\mathfrak q}$-regular sequence of length $i$. namely, by our choice of $r_i$ above and by the bound on the ranks of the $\varphi_i$ this is the only way the conditions of proposition \ref{proposition-what-exact} can be satisfied. \medskip\noindent if $(i_i)_{\mathfrak q} = s_{\mathfrak q}$, then after localizing $s$ at some element $g \not\in \mathfrak q$ we may assume that $i_i = s$. clearly, this is an open condition. \medskip\noindent if $(i_i)_{\mathfrak q} \not = s_{\mathfrak q}$, then we have a sequence $f_1, \ldots, f_i \in (i_i)_{\mathfrak q}$ which form a regular sequence in $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$. note that for any prime $\mathfrak q' \subset s$ such that $(f_1, \ldots, f_i) \not \subset \mathfrak q'$ we have $(i_i)_{\mathfrak q'} = s_{\mathfrak q'}$. thus the result follows from lemma \ref{lemma-open-regular-sequence}. \end{proof} \begin{theorem} \label{theorem-openness-flatness} let $r$ be a ring. let $r \to s$ be a ring map of finite presentation. let $m$ be a finitely presented $s$-module. the set $$ \{ \mathfrak q \in \spec(s) \mid m_{\mathfrak q}\text{ is flat over }r\} $$ is open in $\spec(s)$. \end{theorem} \begin{proof} let $\mathfrak q \in \spec(s)$ be a prime. let $\mathfrak p \subset r$ be the inverse image of $\mathfrak q$ in $r$. note that $m_{\mathfrak q}$ is flat over $r$ if and only if it is flat over $r_{\mathfrak p}$. let us assume that $m_{\mathfrak q}$ is flat over $r$. we claim that there exists a $g \in s$, $g \not \in \mathfrak q$ such that $m_g$ is flat over $r$. \medskip\noindent we first reduce to the case where $r$ and $s$ are of finite type over $\mathbf{z}$. choose a directed set $\lambda$ and a system $(r_\lambda \to s_\lambda, m_\lambda)$ as in lemma \ref{lemma-limit-module-finite-presentation}. set $\mathfrak p_\lambda$ equal to the inverse image of $\mathfrak p$ in $r_\lambda$. set $\mathfrak q_\lambda$ equal to the inverse image of $\mathfrak q$ in $s_\lambda$. then the system $$ ((r_\lambda)_{\mathfrak p_\lambda}, (s_\lambda)_{\mathfrak q_\lambda}, (m_\lambda)_{\mathfrak q_{\lambda}}) $$ is a system as in lemma \ref{lemma-limit-module-essentially-finite-presentation}. hence by lemma \ref{lemma-colimit-eventually-flat} we see that for some $\lambda$ the module $m_\lambda$ is flat over $r_\lambda$ at the prime $\mathfrak q_{\lambda}$. suppose we can prove our claim for the system $(r_\lambda \to s_\lambda, m_\lambda, \mathfrak q_{\lambda})$. in other words, suppose that we can find a $g \in s_\lambda$, $g \not\in \mathfrak q_\lambda$ such that $(m_\lambda)_g$ is flat over $r_\lambda$. by lemma \ref{lemma-limit-module-finite-presentation} we have $m = m_\lambda \otimes_{r_\lambda} r$ and hence also $m_g = (m_\lambda)_g \otimes_{r_\lambda} r$. thus by lemma \ref{lemma-flat-base-change} we deduce the claim for the system $(r \to s, m, \mathfrak q)$. \medskip\noindent at this point we may assume that $r$ and $s$ are of finite type over $\mathbf{z}$. we may write $s$ as a quotient of a polynomial ring $r[x_1, \ldots, x_n]$. of course, we may replace $s$ by $r[x_1, \ldots, x_n]$ and assume that $s$ is a polynomial ring over $r$. in particular we see that $r \to s$ is flat and all fibres rings $s \otimes_r \kappa(\mathfrak p)$ have global dimension $n$. \medskip\noindent choose a resolution $f_\bullet$ of $m$ over $s$ with each $f_i$ finite free, see lemma \ref{lemma-resolution-by-finite-free}. let $k_n = \ker(f_{n-1} \to f_{n-2})$. note that $(k_n)_{\mathfrak q}$ is flat over $r$, since each $f_i$ is flat over $r$ and by assumption on $m$, see lemma \ref{lemma-flat-ses}. in addition, the sequence $$ 0 \to k_n/\mathfrak p k_n \to f_{n-1}/ \mathfrak p f_{n-1} \to \ldots \to f_0 / \mathfrak p f_0 \to m/\mathfrak p m \to 0 $$ is exact upon localizing at $\mathfrak q$, because of vanishing of $\text{tor}_i^{r_\mathfrak p}(\kappa(\mathfrak p), m_{\mathfrak q})$. since the global dimension of $s_\mathfrak q/\mathfrak p s_{\mathfrak q}$ is $n$ we conclude that $k_n / \mathfrak p k_n$ localized at $\mathfrak q$ is a finite free module over $s_\mathfrak q/\mathfrak p s_{\mathfrak q}$. by lemma \ref{lemma-free-fibre-flat-free} $(k_n)_{\mathfrak q}$ is free over $s_{\mathfrak q}$. in particular, there exists a $g \in s$, $g \not \in \mathfrak q$ such that $(k_n)_g$ is finite free over $s_g$. \medskip\noindent by lemma \ref{lemma-exact-on-fibres-open} there exists a further localization $s_g$ such that the complex $$ 0 \to k_n \to f_{n-1} \to \ldots \to f_0 $$ is exact on {\it all fibres} of $r \to s$. by lemma \ref{lemma-complex-exact-mod} this implies that the cokernel of $f_1 \to f_0$ is flat. this proves the theorem in the noetherian case. \end{proof} \section{openness of cohen-macaulay loci} \label{section-cm-open} \noindent in this section we characterize the cohen-macaulay property of finite type algebras in terms of flatness. we then use this to prove the set of points where such an algebra is cohen-macaulay is open. \begin{lemma} \label{lemma-where-cm} let $s$ be a finite type algebra over a field $k$. let $\varphi : k[y_1, \ldots, y_d] \to s$ be a quasi-finite ring map. as subsets of $\spec(s)$ we have $$ \{ \mathfrak q \mid s_{\mathfrak q} \text{ flat over }k[y_1, \ldots, y_d]\} = \{ \mathfrak q \mid s_{\mathfrak q} \text{ cm and }\dim_{\mathfrak q}(s/k) = d\} $$ for notation see definition \ref{definition-relative-dimension}. \end{lemma} \begin{proof} let $\mathfrak q \subset s$ be a prime. denote $\mathfrak p = k[y_1, \ldots, y_d] \cap \mathfrak q$. note that always $\dim(s_{\mathfrak q}) \leq \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$ by lemma \ref{lemma-dimension-inequality-quasi-finite} for example. moreover, the field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is finite and hence $\text{trdeg}_k(\kappa(\mathfrak p)) = \text{trdeg}_k(\kappa(\mathfrak q))$. \medskip\noindent let $\mathfrak q$ be an element of the left hand side. then lemma \ref{lemma-finite-flat-over-regular-cm} applies and we conclude that $s_{\mathfrak q}$ is cohen-macaulay and $\dim(s_{\mathfrak q}) = \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$. combined with the equality of transcendence degrees above and lemma \ref{lemma-dimension-at-a-point-finite-type-field} this implies that $\dim_{\mathfrak q}(s/k) = d$. hence $\mathfrak q$ is an element of the right hand side. \medskip\noindent let $\mathfrak q$ be an element of the right hand side. by the equality of transcendence degrees above, the assumption that $\dim_{\mathfrak q}(s/k) = d$ and lemma \ref{lemma-dimension-at-a-point-finite-type-field} we conclude that $\dim(s_{\mathfrak q}) = \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$. hence lemma \ref{lemma-cm-over-regular-flat} applies and we see that $\mathfrak q$ is an element of the left hand side. \end{proof} \begin{lemma} \label{lemma-finite-type-over-field-cm-open} let $s$ be a finite type algebra over a field $k$. the set of primes $\mathfrak q$ such that $s_{\mathfrak q}$ is cohen-macaulay is open in $s$. \end{lemma} \noindent this lemma is a special case of lemma \ref{lemma-finite-presentation-flat-cm-locus-open} below, so you can skip straight to the proof of that lemma if you like. \begin{proof} let $\mathfrak q \subset s$ be a prime such that $s_{\mathfrak q}$ is cohen-macaulay. we have to show there exists a $g \in s$, $g \not \in \mathfrak q$ such that the ring $s_g$ is cohen-macaulay. for any $g \in s$, $g \not \in \mathfrak q$ we may replace $s$ by $s_g$ and $\mathfrak q$ by $\mathfrak qs_g$. combining this with lemmas \ref{lemma-noether-normalization-at-point} and \ref{lemma-dimension-at-a-point-finite-type-field} we may assume that there exists a finite injective ring map $k[y_1, \ldots, y_d] \to s$ with $d = \dim(s_{\mathfrak q}) + \text{trdeg}_k(\kappa(\mathfrak q))$. set $\mathfrak p = k[y_1, \ldots, y_d] \cap \mathfrak q$. by construction we see that $\mathfrak q$ is an element of the right hand side of the displayed equality of lemma \ref{lemma-where-cm}. hence it is also an element of the left hand side. \medskip\noindent by theorem \ref{theorem-openness-flatness} we see that for some $g \in s$, $g \not \in \mathfrak q$ the ring $s_g$ is flat over $k[y_1, \ldots, y_d]$. hence by the equality of lemma \ref{lemma-where-cm} again we conclude that all local rings of $s_g$ are cohen-macaulay as desired. \end{proof} \begin{lemma} \label{lemma-generic-cm} let $k$ be a field. let $s$ be a finite type $k$ algebra. the set of cohen-macaulay primes forms a dense open $u \subset \spec(s)$. \end{lemma} \begin{proof} the set is open by lemma \ref{lemma-finite-type-over-field-cm-open}. it contains all minimal primes $\mathfrak q \subset s$ since the local ring at a minimal prime $s_{\mathfrak q}$ has dimension zero and hence is cohen-macaulay. \end{proof} \begin{lemma} \label{lemma-finite-presentation-flat-cm-locus-open} let $r$ be a ring. let $r \to s$ be of finite presentation and flat. for any $d \geq 0$ the set $$ \left\{ \begin{matrix} \mathfrak q \in \spec(s) \text{ such that setting }\mathfrak p = r \cap \mathfrak q \text{ the fibre ring}\\ s_{\mathfrak q}/\mathfrak ps_{\mathfrak q} \text{ is cohen-macaulay} \text{ and } \dim_{\mathfrak q}(s/r) = d \end{matrix} \right\} $$ is open in $\spec(s)$. \end{lemma} \begin{proof} let $\mathfrak q$ be an element of the set indicated, with $\mathfrak p$ the corresponding prime of $r$. we have to find a $g \in s$, $g \not \in \mathfrak q$ such that all fibre rings of $r \to s_g$ are cohen-macaulay. during the course of the proof we may (finitely many times) replace $s$ by $s_g$ for a $g \in s$, $g \not \in \mathfrak q$. thus by lemma \ref{lemma-quasi-finite-over-polynomial-algebra} we may assume there is a quasi-finite ring map $r[t_1, \ldots, t_d] \to s$ with $d = \dim_{\mathfrak q}(s/r)$. let $\mathfrak q' = r[t_1, \ldots, t_d] \cap \mathfrak q$. by lemma \ref{lemma-where-cm} we see that the ring map $$ r[t_1, \ldots, t_d]_{\mathfrak q'} / \mathfrak p r[t_1, \ldots, t_d]_{\mathfrak q'} \longrightarrow s_{\mathfrak q}/\mathfrak p s_{\mathfrak q} $$ is flat. hence by the crit\`ere de platitude par fibres lemma \ref{lemma-criterion-flatness-fibre} we see that $r[t_1, \ldots, t_d]_{\mathfrak q'} \to s_{\mathfrak q}$ is flat. hence by theorem \ref{theorem-openness-flatness} we see that for some $g \in s$, $g \not \in \mathfrak q$ the ring map $r[t_1, \ldots, t_d] \to s_g$ is flat. replacing $s$ by $s_g$ we see that for every prime $\mathfrak r \subset s$, setting $\mathfrak r' = r[t_1, \ldots, t_d] \cap \mathfrak r$ and $\mathfrak p' = r \cap \mathfrak r$ the local ring map $r[t_1, \ldots, t_d]_{\mathfrak r'} \to s_{\mathfrak r}$ is flat. hence also the base change $$ r[t_1, \ldots, t_d]_{\mathfrak r'} / \mathfrak p' r[t_1, \ldots, t_d]_{\mathfrak r'} \longrightarrow s_{\mathfrak r}/\mathfrak p' s_{\mathfrak r} $$ is flat. hence by lemma \ref{lemma-where-cm} applied with $k = \kappa(\mathfrak p')$ we see $\mathfrak r$ is in the set of the lemma as desired. \end{proof} \begin{lemma} \label{lemma-generic-cm-flat-finite-presentation} let $r$ be a ring. let $r \to s$ be flat of finite presentation. the set of primes $\mathfrak q$ such that the fibre ring $s_{\mathfrak q} \otimes_r \kappa(\mathfrak p)$, with $\mathfrak p = r \cap \mathfrak q$ is cohen-macaulay is open and dense in every fibre of $\spec(s) \to \spec(r)$. \end{lemma} \begin{proof} the set, call it $w$, is open by lemma \ref{lemma-finite-presentation-flat-cm-locus-open}. it is dense in the fibres because the intersection of $w$ with a fibre is the corresponding set of the fibre to which lemma \ref{lemma-generic-cm} applies. \end{proof} \begin{lemma} \label{lemma-extend-field-cm-locus} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $k/k$ be a field extension, and set $s_k = k \otimes_k s$. let $\mathfrak q \subset s$ be a prime of $s$. let $\mathfrak q_k \subset s_k$ be a prime of $s_k$ lying over $\mathfrak q$. then $s_{\mathfrak q}$ is cohen-macaulay if and only if $(s_k)_{\mathfrak q_k}$ is cohen-macaulay. \end{lemma} \begin{proof} during the course of the proof we may (finitely many times) replace $s$ by $s_g$ for any $g \in s$, $g \not \in \mathfrak q$. hence using lemma \ref{lemma-noether-normalization-at-point} we may assume that $\dim(s) = \dim_{\mathfrak q}(s/k) =: d$ and find a finite injective map $k[x_1, \ldots, x_d] \to s$. note that this also induces a finite injective map $k[x_1, \ldots, x_d] \to s_k$ by base change. by lemma \ref{lemma-dimension-at-a-point-preserved-field-extension} we have $\dim_{\mathfrak q_k}(s_k/k) = d$. set $\mathfrak p = k[x_1, \ldots, x_d] \cap \mathfrak q$ and $\mathfrak p_k = k[x_1, \ldots, x_d] \cap \mathfrak q_k$. consider the following commutative diagram of noetherian local rings $$ \xymatrix{ s_{\mathfrak q} \ar[r] & (s_k)_{\mathfrak q_k} \\ k[x_1, \ldots, x_d]_{\mathfrak p} \ar[r] \ar[u] & k[x_1, \ldots, x_d]_{\mathfrak p_k} \ar[u] } $$ by lemma \ref{lemma-where-cm} we have to show that the left vertical arrow is flat if and only if the right vertical arrow is flat. because the bottom arrow is flat this equivalence holds by lemma \ref{lemma-base-change-flat-up-down}. \end{proof} \begin{lemma} \label{lemma-cm-locus-commutes-base-change} let $r$ be a ring. let $r \to s$ be of finite type. let $r \to r'$ be any ring map. set $s' = r' \otimes_r s$. denote $f : \spec(s') \to \spec(s)$ the map associated to the ring map $s \to s'$. set $w$ equal to the set of primes $\mathfrak q$ such that the fibre ring $s_{\mathfrak q} \otimes_r \kappa(\mathfrak p)$, $\mathfrak p = r \cap \mathfrak q$ is cohen-macaulay, and let $w'$ denote the analogue for $s'/r'$. then $w' = f^{-1}(w)$. \end{lemma} \begin{proof} trivial from lemma \ref{lemma-extend-field-cm-locus} and the definitions. \end{proof} \begin{lemma} \label{lemma-relative-dimension-cm} let $r$ be a ring. let $r \to s$ be a ring map which is (a) flat, (b) of finite presentation, (c) has cohen-macaulay fibres. then we can write $s = s_0 \times \ldots \times s_n$ as a product of $r$-algebras $s_d$ such that each $s_d$ satisfies (a), (b), (c) and has all fibres equidimensional of dimension $d$. \end{lemma} \begin{proof} for each integer $d$ denote $w_d \subset \spec(s)$ the set defined in lemma \ref{lemma-finite-presentation-flat-cm-locus-open}. clearly we have $\spec(s) = \coprod w_d$, and each $w_d$ is open by the lemma we just quoted. hence the result follows from lemma \ref{lemma-disjoint-implies-product}. \end{proof} \section{differentials} \label{section-differentials} \noindent in this section we define the module of differentials of a ring map. \begin{definition} \label{definition-derivation} let $\varphi : r \to s$ be a ring map and let $m$ be an $s$-module. a {\it derivation}, or more precisely an {\it $r$-derivation} into $m$ is a map $d : s \to m$ which is additive, annihilates elements of $\varphi(r)$, and satisfies the {\it leibniz rule}: $d(ab) = ad(b) + bd(a)$. \end{definition} \noindent note that $d(ra) = rd(a)$ if $r \in r$ and $a \in s$. an equivalent definition is that an $r$-derivation is an $r$-linear map $d : s \to m$ which satisfies the leibniz rule. the set of all $r$-derivations forms an $s$-module: given two $r$-derivations $d, d'$ the sum $d + d' : s \to m$, $a \mapsto d(a)+d'(a)$ is an $r$-derivation, and given an $r$-derivation $d$ and an element $c\in s$ the scalar multiple $cd : s \to m$, $a \mapsto cd(a)$ is an $r$-derivation. we denote this $s$-module $$ \text{der}_r(s, m). $$ also, if $\alpha : m \to n$ is an $s$-module map, then the composition $\alpha \circ d$ is an $r$-derivation into $n$. in this way the assignment $m \mapsto \text{der}_r(s, m)$ is a covariant functor. \medskip\noindent consider the following map of free $s$-modules $$ \bigoplus\nolimits_{(a, b)\in s^2} s[(a, b)] \oplus \bigoplus\nolimits_{(f, g)\in s^2} s[(f, g)] \oplus \bigoplus\nolimits_{r\in r} s[r] \longrightarrow \bigoplus\nolimits_{a\in s} s[a] $$ defined by the rules $$ [(a, b)] \longmapsto [a + b] - [a] - [b],\quad [(f, g)] \longmapsto [fg] -f[g] - g[f],\quad [r] \longmapsto [\varphi(r)] $$ with obvious notation. let $\omega_{s/r}$ be the cokernel of this map. there is a map $\text{d} : s \to \omega_{s/r}$ which maps $a$ to the class $\text{d}a$ of $[a]$ in the cokernel. this is an $r$-derivation by the relations imposed on $\omega_{s/r}$, in other words $$ \text{d}(a + b) = \text{d}a + \text{d}b, \quad \text{d}(fg) = f\text{d}g + g\text{d}f, \quad \text{d}\varphi(r) = 0 $$ where $a,b,f,g \in s$ and $r \in r$. \begin{definition} \label{definition-differentials} the pair $(\omega_{s/r}, \text{d})$ is called the {\it module of k\"ahler differentials} or the {\it module of differentials} of $s$ over $r$. \end{definition} \begin{lemma} \label{lemma-universal-omega} \begin{slogan} maps out of the module of differentials are the same as derivations. \end{slogan} the module of differentials of $s$ over $r$ has the following universal property. the map $$ \hom_s(\omega_{s/r}, m) \longrightarrow \text{der}_r(s, m), \quad \alpha \longmapsto \alpha \circ \text{d} $$ is an isomorphism of functors. \end{lemma} \begin{proof} by definition an $r$-derivation is a rule which associates to each $a \in s$ an element $d(a) \in m$. thus $d$ gives rise to a map $[d] : \bigoplus s[a] \to m$. however, the conditions of being an $r$-derivation exactly mean that $[d]$ annihilates the image of the map in the displayed presentation of $\omega_{s/r}$ above. \end{proof} \begin{lemma} \label{lemma-trivial-differential-surjective} suppose that $r \to s$ is surjective. then $\omega_{s/r} = 0$. \end{lemma} \begin{proof} you can see this either because all $r$-derivations clearly have to be zero, or because the map in the presentation of $\omega_{s/r}$ is surjective. \end{proof} \noindent suppose that \begin{equation} \label{equation-functorial-omega} \vcenter{ \xymatrix{ s \ar[r]_\varphi & s' \\ r \ar[r]^\psi \ar[u]^\alpha & r' \ar[u]_\beta } } \end{equation} is a commutative diagram of rings. in this case there is a natural map of modules of differentials fitting into the commutative diagram $$ \xymatrix{ \omega_{s/r} \ar[r] & \omega_{s'/r'} \\ s \ar[u]^{\text{d}} \ar[r]^{\varphi} & s' \ar[u]_{\text{d}} } $$ to construct the map just use the obvious map between the presentations for $\omega_{s/r}$ and $\omega_{s'/r'}$. namely, \begin{equation} \label{equation-map-presentations} \vcenter{ \xymatrix{ \bigoplus s'[(a', b')] \oplus \bigoplus s'[(f', g')] \oplus \bigoplus s'[r'] \ar[r] & \bigoplus s' [a'] \\ \\ \bigoplus s[(a, b)] \oplus \bigoplus s[(f, g)] \oplus \bigoplus s[r] \ar[r] \ar[uu]^{ \begin{matrix} [(a, b)] \mapsto [(\varphi(a), \varphi(b))] \\ [(f, g)] \mapsto [(\varphi(f), \varphi(g))] \\ [r]\mapsto [\psi(r)] \end{matrix} } & \bigoplus s[a] \ar[uu]_{[a] \mapsto [\varphi(a)]} } } \end{equation} the result is simply that $f\text{d}g \in \omega_{s/r}$ is mapped to $\varphi(f)\text{d}\varphi(g)$. \begin{lemma} \label{lemma-colimit-differentials} let $i$ be a directed set. let $(r_i \to s_i, \varphi_{ii'})$ be a system of ring maps over $i$, see categories, section \ref{categories-section-posets-limits}. then we have $$ \omega_{s/r} = \colim_i \omega_{s_i/r_i}. $$ where $r \to s = \colim (r_i \to s_i)$. \end{lemma} \begin{proof} this is clear from the defining presentation of $\omega_{s/r}$ and the functoriality of this described above. \end{proof} \begin{lemma} \label{lemma-differential-surjective} in diagram (\ref{equation-functorial-omega}), suppose that $s \to s'$ is surjective with kernel $i \subset s$. then $\omega_{s/r} \to \omega_{s'/r'}$ is surjective with kernel generated as an $s$-module by the elements $\text{d}a$, where $a \in s$ is such that $\varphi(a) \in \beta(r')$. (this includes in particular the elements $\text{d}(i)$, $i \in i$.) \end{lemma} \begin{proof}[first proof] consider the map of presentations (\ref{equation-map-presentations}). clearly the right vertical map of free modules is surjective. thus the map is surjective. suppose that some element $\eta$ of $\omega_{s/r}$ maps to zero in $\omega_{s'/r'}$. write $\eta$ as the image of $\sum s_i[a_i]$ for some $s_i, a_i \in s$. then we see that $\sum \varphi(s_i)[\varphi(a_i)]$ is the image of an element $$ \theta = \sum s_j'[a_j', b_j'] + \sum s_k'[f_k', g_k'] + \sum s_l'[r_l'] $$ in the upper left corner of the diagram. since $\varphi$ is surjective, the terms $s_j'[a_j', b_j']$ and $s_k'[f_k', g_k']$ are in the image of elements in the lower right corner. thus, modifying $\eta$ and $\theta$ by subtracting the images of these elements, we may assume $\theta = \sum s_l'[r_l']$. in other words, we see $\sum \varphi(s_i)[\varphi(a_i)]$ is of the form $\sum s'_l [\beta(r'_l)]$. next, we may assume that we have some $a' \in s'$ such that $a' = \varphi(a_i)$ for all $i$ and $a' = \beta(r_l')$ for all $l$. this is clear from the direct sum decomposition of the upper right corner of the diagram. choose $a \in s$ with $\varphi(a) = a'$. then we can write $a_i = a + x_i$ for some $x_i \in i$. thus we may assume that all $a_i$ are equal to $a$ by using the relations that are allowed. but then we may assume our element is of the form $s[a]$. we still know that $\varphi(s)[a'] = \sum \varphi(s_l')[\beta(r_l')]$. hence either $\varphi(s) = 0$ and we're done, or $a' = \varphi(a)$ is in the image of $\beta$ and we're done as well. \end{proof} \begin{proof}[second proof] we will use the universal property of modules of differentials given in lemma \ref{lemma-universal-omega} without further mention. \medskip\noindent in (\ref{equation-functorial-omega}) let $r'' = s \times_{s'} r'$. then we have following diagram: $$ \xymatrix{ s \ar[r] & s \ar[r] & s' \\ r \ar[r] \ar[u] & r'' \ar[r] \ar[u] & r' \ar[u] } $$ let $m$ be an $s$-module. it follows immediately from the definitions that an $r$-derivation $d : s \to m$ is an $r''$-derivation if and only if it annihilates the elements in the image of $r'' \to s$. the universal property translates this into the statement that the natural map $\omega_{s/r} \to \omega_{s/r''}$ is surjective with kernel generated as an $s$-module by the image of $r''$. \medskip\noindent from the previous paragraph we see that it suffices to show that $\omega_{s/r} \to \omega_{s'/r'}$ is an isomorphism when $s \to s'$ is surjective and $r = s \times_{s'} r'$. let $m'$ be an $s'$-module. observe that any $r'$-derivation $d' : s' \to m'$ gives an $r$-derivation by precomposing with $s \to s'$. conversely, suppose $m$ is an $s$-module and $d : s \to m$ is an $r$-derivation. if $i \in i$, then there exist an $a \in r$ with $\alpha(a) = i$ (as $r = s \times_{s'} r'$). it follows that $d(i) = 0$ and hence $0 = d(is) = id(s)$ for all $s \in s$. thus the image of $d$ is contained in the submodule $m' \subset m$ of elements annihilated by $i$ and moreover the induced map $s \to m'$ factors through an $r'$-derivation $s' \to m'$. it is an exercise to use the universal property to see that this means $\omega_{s/r} \to \omega_{s'/r'}$ is an isomorphism; details omitted. \end{proof} \begin{lemma} \label{lemma-exact-sequence-differentials} let $a \to b \to c$ be ring maps. then there is a canonical exact sequence $$ c \otimes_b \omega_{b/a} \to \omega_{c/a} \to \omega_{c/b} \to 0 $$ of $c$-modules. \end{lemma} \begin{proof} we get a diagram (\ref{equation-functorial-omega}) by putting $r = a$, $s = c$, $r' = b$, and $s' = c$. by lemma \ref{lemma-differential-surjective} the map $\omega_{c/a} \to \omega_{c/b}$ is surjective, and the kernel is generated by the elements $\text{d}(c)$, where $c \in c$ is in the image of $b \to c$. the lemma follows. \end{proof} \begin{lemma} \label{lemma-differentials-localize} let $\varphi : a \to b$ be a ring map. \begin{enumerate} \item if $s \subset a$ is a multiplicative subset mapping to invertible elements of $b$, then $\omega_{b/a} = \omega_{b/s^{-1}a}$. \item if $s \subset b$ is a multiplicative subset then $s^{-1}\omega_{b/a} = \omega_{s^{-1}b/a}$. \end{enumerate} \end{lemma} \begin{proof} to show the equality of (1) it is enough to show that any $a$-derivation $d : b \to m$ annihilates the elements $\varphi(s)^{-1}$. this is clear from the leibniz rule applied to $1 = \varphi(s) \varphi(s)^{-1}$. to show (2) note that there is an obvious map $s^{-1}\omega_{b/a} \to \omega_{s^{-1}b/a}$. to show it is an isomorphism it is enough to show that there is a $a$-derivation $\text{d}'$ of $s^{-1}b$ into $s^{-1}\omega_{b/a}$. to define it we simply set $\text{d}'(b/s) = (1/s)\text{d}b - (1/s^2)b\text{d}s$. details omitted. \end{proof} \begin{lemma} \label{lemma-differential-seq} in diagram (\ref{equation-functorial-omega}), suppose that $s \to s'$ is surjective with kernel $i \subset s$, and assume that $r' = r$. then there is a canonical exact sequence of $s'$-modules $$ i/i^2 \longrightarrow \omega_{s/r} \otimes_s s' \longrightarrow \omega_{s'/r} \longrightarrow 0 $$ the leftmost map is characterized by the rule that $f \in i$ maps to $\text{d}f \otimes 1$. \end{lemma} \begin{proof} the middle term is $\omega_{s/r} \otimes_s s/i$. for $f \in i$ denote $\overline{f}$ the image of $f$ in $i/i^2$. to show that the map $\overline{f} \mapsto \text{d}f \otimes 1$ is well defined we just have to check that $\text{d} f_1f_2 \otimes 1 = 0$ if $f_1, f_2 \in i$. and this is clear from the leibniz rule $\text{d} f_1f_2 \otimes 1 = (f_1 \text{d}f_2 + f_2 \text{d} f_1 )\otimes 1 = \text{d}f_2 \otimes f_1 + \text{d}f_1 \otimes f_2 = 0$. a similar computation show this map is $s' = s/i$-linear. \medskip\noindent the map $\omega_{s/r} \otimes_s s' \to \omega_{s'/r}$ is the canonical $s'$-linear map associated to the $s$-linear map $\omega_{s/r} \to \omega_{s'/r}$. it is surjective because $\omega_{s/r} \to \omega_{s'/r}$ is surjective by lemma \ref{lemma-differential-surjective}. \medskip\noindent the composite of the two maps is zero because $\text{d}f$ maps to zero in $\omega_{s'/r}$ for $f \in i$. note that exactness just says that the kernel of $\omega_{s/r} \to \omega_{s'/r}$ is generated as an $s$-submodule by the submodule $i\omega_{s/r}$ together with the elements $\text{d}f$, with $f \in i$. we know by lemma \ref{lemma-differential-surjective} that this kernel is generated by the elements $\text{d}(a)$ where $\varphi(a) = \beta(r)$ for some $r \in r$. but then $a = \alpha(r) + a - \alpha(r)$, so $\text{d}(a) = \text{d}(a - \alpha(r))$. and $a - \alpha(r) \in i$ since $\varphi(a - \alpha(r)) = \varphi(a) - \varphi(\alpha(r)) = \beta(r) - \beta(r) = 0$. we conclude the elements $\text{d}f$ with $f \in i$ already generate the kernel as an $s$-module, as desired. \end{proof} \begin{lemma} \label{lemma-differential-seq-split} in diagram (\ref{equation-functorial-omega}), suppose that $s \to s'$ is surjective with kernel $i \subset s$, and assume that $r' = r$. moreover, assume that there exists an $r$-algebra map $s' \to s$ which is a right inverse to $s \to s'$. then the exact sequence of $s'$-modules of lemma \ref{lemma-differential-seq} turns into a short exact sequence $$ 0 \longrightarrow i/i^2 \longrightarrow \omega_{s/r} \otimes_s s' \longrightarrow \omega_{s'/r} \longrightarrow 0 $$ which is even a split short exact sequence. \end{lemma} \begin{proof} let $\beta : s' \to s$ be the right inverse to the surjection $\alpha : s \to s'$, so $s = i \oplus \beta(s')$. clearly we can use $\beta : \omega_{s'/r} \to \omega_{s/r}$, to get a right inverse to the map $\omega_{s/r} \otimes_s s' \to \omega_{s'/r}$. on the other hand, consider the map $$ d : s \longrightarrow i/i^2, \quad x \longmapsto x - \beta(\alpha(x)) $$ it is easy to show that $d$ is an $r$-derivation (omitted). moreover $x d(s) = 0$ if $x \in i, s \in s$. hence, by the universal property $d$ induces a map $\tau : \omega_{s/r} \otimes_s s' \to i/i^2$. we omit the verification that it is a left inverse to $\text{d} : i/i^2 \to \omega_{s/r} \otimes_s s'$. hence we win. \end{proof} \begin{lemma} \label{lemma-differential-mod-power-ideal} let $r \to s$ be a ring map. let $i \subset s$ be an ideal. let $n \geq 1$ be an integer. set $s' = s/i^{n + 1}$. the map $\omega_{s/r} \to \omega_{s'/r}$ induces an isomorphism $$ \omega_{s/r} \otimes_s s/i^n \longrightarrow \omega_{s'/r} \otimes_{s'} s/i^n. $$ \end{lemma} \begin{proof} this follows from lemma \ref{lemma-differential-seq} and the fact that $\text{d}(i^{n + 1}) \subset i^n\omega_{s/r}$ by the leibniz rule for $\text{d}$. \end{proof} \begin{lemma} \label{lemma-differentials-base-change} suppose that we have ring maps $r \to r'$ and $r \to s$. set $s' = s \otimes_r r'$, so that we obtain a diagram (\ref{equation-functorial-omega}). then the canonical map defined above induces an isomorphism $\omega_{s/r} \otimes_r r' = \omega_{s'/r'}$. \end{lemma} \begin{proof} let $\text{d}' : s' = s \otimes_r r' \to \omega_{s/r} \otimes_r r'$ denote the map $\text{d}'( \sum a_i \otimes x_i ) = \sum \text{d}(a_i) \otimes x_i$. it exists because the map $s \times r' \to \omega_{s/r} \otimes_r r'$, $(a, x)\mapsto \text{d}a \otimes_r x$ is $r$-bilinear. this is an $r'$-derivation, as can be verified by a simple computation. we will show that $(\omega_{s/r} \otimes_r r', \text{d}')$ satisfies the universal property. let $d : s' \to m'$ be an $r'$-derivation into an $s'$-module. the composition $s \to s' \to m'$ is an $r$-derivation, hence we get an $s$-linear map $\varphi_d : \omega_{s/r} \to m'$. we may tensor this with $r'$ and get the map $\varphi'_d : \omega_{s/r} \otimes_r r' \to m'$, $\varphi'_d(\eta \otimes x) = x\varphi_d(\eta)$. it is clear that $d = \varphi'_d \circ \text{d}'$. \end{proof} \noindent the multiplication map $s \otimes_r s \to s$ is the $r$-algebra map which maps $a \otimes b$ to $ab$ in $s$. it is also an $s$-algebra map, if we think of $s \otimes_r s$ as an $s$-algebra via either of the maps $s \to s \otimes_r s$. \begin{lemma} \label{lemma-differentials-diagonal} let $r \to s$ be a ring map. let $j = \ker(s \otimes_r s \to s)$ be the kernel of the multiplication map. there is a canonical isomorphism of $s$-modules $\omega_{s/r} \to j/j^2$, $a \text{d} b \mapsto a \otimes b - ab \otimes 1$. \end{lemma} \begin{proof}[first proof] apply lemma \ref{lemma-differential-seq-split} to the commutative diagram $$ \xymatrix{ s \otimes_r s \ar[r] & s \\ s \ar[r] \ar[u] & s \ar[u] } $$ where the left vertical arrow is $a \mapsto a \otimes 1$. we get the exact sequence $0 \to j/j^2 \to \omega_{s \otimes_r s/s} \otimes_{s \otimes_r s} s \to \omega_{s/s} \to 0$. by lemma \ref{lemma-trivial-differential-surjective} the term $\omega_{s/s}$ is $0$, and we obtain an isomorphism between the other two terms. we have $\omega_{s \otimes_r s/s} = \omega_{s/r} \otimes_s (s \otimes_r s)$ by lemma \ref{lemma-differentials-base-change} as $s \to s \otimes_r s$ is the base change of $r \to s$ and hence $$ \omega_{s \otimes_r s/s} \otimes_{s \otimes_r s} s = \omega_{s/r} \otimes_s (s \otimes_r s) \otimes_{s \otimes_r s} s = \omega_{s/r} $$ we omit the verification that the map is given by the rule of the lemma. \end{proof} \begin{proof}[second proof] first we show that the rule $a \text{d} b \mapsto a \otimes b - ab \otimes 1$ is well defined. in order to do this we have to show that $\text{d}r$ and $a\text{d}b + b \text{d}a - d(ab)$ map to zero. the first because $r \otimes 1 - 1 \otimes r = 0$ by definition of the tensor product. the second because $$ (a \otimes b - ab \otimes 1) + (b \otimes a - ba \otimes 1) - (1 \otimes ab - ab \otimes 1) = (a \otimes 1 - 1\otimes a)(1\otimes b - b \otimes 1) $$ is in $j^2$. \medskip\noindent we construct a map in the other direction. we may think of $s \to s \otimes_r s$, $a \mapsto a \otimes 1$ as the base change of $r \to s$. hence we have $\omega_{s \otimes_r s/s} = \omega_{s/r} \otimes_s (s \otimes_r s)$, by lemma \ref{lemma-differentials-base-change}. at this point the sequence of lemma \ref{lemma-differential-seq} gives a map $$ j/j^2 \to \omega_{s \otimes_r s/ s} \otimes_{s \otimes_r s} s = (\omega_{s/r} \otimes_s (s \otimes_r s))\otimes_{s \otimes_r s} s = \omega_{s/r}. $$ we leave it to the reader to see it is the inverse of the map above. \end{proof} \begin{lemma} \label{lemma-differentials-polynomial-ring} if $s = r[x_1, \ldots, x_n]$, then $\omega_{s/r}$ is a finite free $s$-module with basis $\text{d}x_1, \ldots, \text{d}x_n$. \end{lemma} \begin{proof} we first show that $\text{d}x_1, \ldots, \text{d}x_n$ generate $\omega_{s/r}$ as an $s$-module. to prove this we show that $\text{d}g$ can be expressed as a sum $\sum g_i \text{d}x_i$ for any $g \in r[x_1, \ldots, x_n]$. we do this by induction on the (total) degree of $g$. it is clear if the degree of $g$ is $0$, because then $\text{d}g = 0$. if the degree of $g$ is $> 0$, then we may write $g$ as $c + \sum g_i x_i$ with $c\in r$ and $\deg(g_i) < \deg(g)$. by the leibniz rule we have $\text{d}g = \sum g_i \text{d} x_i + \sum x_i \text{d}g_i$, and hence we win by induction. \medskip\noindent consider the $r$-derivation $\partial / \partial x_i : r[x_1, \ldots, x_n] \to r[x_1, \ldots, x_n]$. (we leave it to the reader to define this; the defining property being that $\partial / \partial x_i (x_j) = \delta_{ij}$.) by the universal property this corresponds to an $s$-module map $l_i : \omega_{s/r} \to r[x_1, \ldots, x_n]$ which maps $\text{d}x_i$ to $1$ and $\text{d}x_j$ to $0$ for $j \not = i$. thus it is clear that there are no $s$-linear relations among the elements $\text{d}x_1, \ldots, \text{d}x_n$. \end{proof} \begin{lemma} \label{lemma-differentials-finitely-presented} suppose $r \to s$ is of finite presentation. then $\omega_{s/r}$ is a finitely presented $s$-module. \end{lemma} \begin{proof} write $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$. write $i = (f_1, \ldots, f_m)$. according to lemma \ref{lemma-differential-seq} there is an exact sequence of $s$-modules $$ i/i^2 \to \omega_{r[x_1, \ldots, x_n]/r} \otimes_{r[x_1, \ldots, x_n]} s \to \omega_{s/r} \to 0 $$ the result follows from the fact that $i/i^2$ is a finite $s$-module (generated by the images of the $f_i$), and that the middle term is finite free by lemma \ref{lemma-differentials-polynomial-ring}. \end{proof} \begin{lemma} \label{lemma-differentials-finitely-generated} suppose $r \to s$ is of finite type. then $\omega_{s/r}$ is finitely generated $s$-module. \end{lemma} \begin{proof} this is very similar to, but easier than the proof of lemma \ref{lemma-differentials-finitely-presented}. \end{proof} \section{the de rham complex} \label{section-de-rham-complex} \noindent let $a \to b$ be a ring map. denote $\text{d} : b \to \omega_{b/a}$ the module of differentials with its universal $a$-derivation constructed in section \ref{section-differentials}. let $\omega_{b/a}^i = \wedge^i_b(\omega_{b/a})$ for $i \geq 0$ be the $i$th exterior power as in section \ref{section-tensor-algebra}. the {\it de rham complex of $b$ over $a$} is the complex $$ \omega_{b/a}^0 \to \omega_{b/a}^1 \to \omega_{b/a}^2 \to \ldots $$ with $a$-linear differentials constructed and described below. \medskip\noindent the map $\text{d} : \omega^0_{b/a} \to \omega^1_{b/a}$ is the universal derivation $\text{d} : b \to \omega_{b/a}$. observe that this is indeed $a$-linear. \medskip\noindent for $p \geq 1$ we claim there is a unique $a$-linear map $\text{d} : \omega_{b/a}^p \to \omega_{b/a}^{p + 1}$ such that \begin{equation} \label{equation-rule} \text{d}\left(b_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_p\right) = \text{d}b_0 \wedge \text{d}b_1 \wedge \ldots \wedge \text{d}b_p \end{equation} recall that $\omega_{b/a}$ is generated as a $b$-module by the elements $\text{d}b$. thus $\omega^p_{b/a}$ is generated as an $a$-module by the elements $b_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_p$ and it follows that the map $\text{d} : \omega^p_{b/a} \to \omega^{p + 1}_{b/a}$ if it exists is unique. \medskip\noindent construction of $\text{d} : \omega_{b/a}^1 \to \omega_{b/a}^2$. by definition \ref{definition-differentials} the elements $\text{d}b$ freely generate $\omega_{b/a}$ as a $b$-module subject to the relations $\text{d}a = 0$ for $a \in a$ and $\text{d}(b' + b'') = \text{d}b' + \text{d}b''$ and $\text{d}(b'b'') = b'\text{d}b'' + b''\text{d}b'$ for $b', b'' \in b$. hence to show that the rule $$ \sum b'_i \text{d}b_i \longmapsto \sum \text{d}b'_i \wedge \text{d}b_i $$ is well defined we have to show that the elements $$ b\text{d}a, \quad\text{and}\quad b\text{d}(b' + b'') - b\text{d}b' - b\text{d}b'' \quad\text{and}\quad b\text{d}(b'b'') - bb'\text{d}b'' - bb''\text{d}b' $$ for $a \in a$ and $b, b', b'' \in b$ are mapped to zero. this is clear by direct computation using the leibniz rule for $\text{d}$. \medskip\noindent observe that the composition $\omega^0_{b/a} \to \omega^1_{b/a} \to \omega^2_{b/a}$ is zero as $\text{d}(\text{d}(b)) = \text{d}(1 \text{d}b) = \text{d}(1) \wedge \text{d}(b) = 0 \wedge \text{d}b = 0$. here $\text{d}(1) = 0$ as $1 \in b$ is in the image of $a \to b$. we will use this below. \medskip\noindent construction of $\text{d} : \omega_{b/a}^p \to \omega_{b/a}^{p + 1}$ for $p \geq 2$. we will show the $a$-linear map $$ \gamma : \omega^1_{b/a} \otimes_a \ldots \otimes_a \omega^1_{b/a} \longrightarrow \omega_{b/a}^{p + 1} $$ defined by the formula $$ \omega_1 \otimes \ldots \otimes \omega_p \longmapsto \sum (-1)^{i + 1} \omega_1 \wedge \ldots \wedge \text{d}(\omega_i) \wedge \ldots \wedge \omega_p $$ factors over the natural surjection $\omega^1_{b/a} \otimes_a \ldots \otimes_a \omega^1_{b/a} \to \omega^p_{b/a}$ to give the desired map $\text{d} : \omega^p_{b/a} \to \omega^{p + 1}_{b/a}$. according to lemma \ref{lemma-present-wedge} the kernel of $\omega^1_{b/a} \otimes_a \ldots \otimes_a \omega^1_{b/a} \to \omega^p_{b/a}$ is generated as an $a$-module by the elements $\omega_1 \otimes \ldots \otimes \omega_p$ with $\omega_i = \omega_j$ for some $i \not = j$ and $\omega_1 \otimes \ldots \otimes f\omega_i \otimes \ldots \otimes \omega_p - \omega_1 \otimes \ldots \otimes f\omega_j \otimes \ldots \otimes \omega_p$ for some $f \in b$. a direct computation shows the first type of element is mapped to $0$ by $\gamma$, in other words, $\gamma$ is alternating. to finish we have to show that $$ \gamma( \omega_1 \otimes \ldots \otimes f\omega_i \otimes \ldots \otimes \omega_p) = \gamma( \omega_1 \otimes \ldots \otimes f\omega_j \otimes \ldots \otimes \omega_p) $$ for $f \in b$. by $a$-linearity and the alternating property, it is enough to show this for $p = 2$, $i = 1$, $j = 2$, $\omega_1 = b \text{d}b'$ and $\omega_2 = c \text{d} c'$ for $b, b', c, c' \in b$. thus we need to show that \begin{align*} & \text{d}(fb) \wedge \text{d}b' \wedge c \text{d}c' - fb \text{d}b' \wedge \text{d}c \wedge \text{d}c' \\ & = \text{d}b \wedge \text{d}b' \wedge fc\text{d}c' - b \text{d}b' \wedge \text{d}(fc) \wedge \text{d}c' \end{align*} in other words that $$ (c \text{d}(fb) + fb \text{d}c - fc \text{d}b - b \text{d}(fc)) \wedge \text{d}b' \wedge \text{d}c' = 0. $$ this follows from the leibniz rule. observe that the value of $\gamma$ on the element $b_0\text{d}b_1 \otimes \text{d}b_2 \otimes \ldots \otimes \text{d}b_p$ is $\text{d}b_0 \wedge \text{d}b_1 \wedge \ldots \wedge \text{d}b_p$ and hence (\ref{equation-rule}) will be satisfied for the map $\text{d} : \omega^p_{b/a} \to \omega^{p + 1}_{b/a}$ so obtained. \medskip\noindent finally, since $\omega^p_{b/a}$ is additively generated by the elements $b_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_p$ and since $\text{d}(b_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_p) = \text{d}b_0 \wedge \ldots \wedge \text{d}b_p$ we see in exactly the same manner that the composition $ \omega^p_{b/a} \to \omega^{p + 1}_{b/a} \to \omega^{p + 2}_{b/a} $ is zero for $p \geq 1$. thus the de rham complex is indeed a complex. \medskip\noindent given just a ring $r$ we set $\omega_r = \omega_{r/\mathbf{z}}$. this is sometimes called the absolute module of differentials of $r$; this makes sense: if $\omega_r$ is the module of differentials where we only assume the leibniz rule and not the vanishing of $\text{d}1$, then the leibniz rule gives $\text{d}1 = \text{d}(1 \cdot 1) = 1 \text{d}1 + 1 \text{d}1 = 2 \text{d}1$ and hence $\text{d}1 = 0$ in $\omega_r$. in this case the {\it absolute de rham complex of $r$} is the corresponding complex $$ \omega_r^0 \to \omega_r^1 \to \omega_r^2 \to \ldots $$ where we set $\omega^i_r = \omega^i_{r/\mathbf{z}}$ and so on. \medskip\noindent suppose we have a commutative diagram of rings $$ \xymatrix{ b \ar[r] & b' \\ a \ar[r] \ar[u] & a' \ar[u] } $$ there is a natural map of de rham complexes $$ \omega^\bullet_{b/a} \longrightarrow \omega^\bullet_{b'/a'} $$ namely, in degree $0$ this is the map $b \to b'$, in degree $1$ this is the map $\omega_{b/a} \to \omega_{b'/a'}$ constructed in section \ref{section-differentials}, and for $p \geq 2$ it is the induced map $\omega^p_{b/a} = \wedge^p_b(\omega_{b/a}) \to \wedge^p_{b'}(\omega_{b'/a'}) = \omega^p_{b'/a'}$. the compatibility with differentials follows from the characterization of the differentials by the formula (\ref{equation-rule}). \begin{lemma} \label{lemma-de-rham-complex-base-change} suppose that we have ring maps $a \to a'$ and $a \to b$. set $b' = b \otimes_a a'$, so that we obtain a diagram as above. then the canonical map defined above induces an isomorphism $\omega^\bullet_{b/a} \otimes_a a' = \omega^\bullet_{b'/a'}$ of complexes. \end{lemma} \begin{proof} this follows from lemma \ref{lemma-differentials-base-change} and the fact that taking exterior powers commutes with base change. \end{proof} \begin{lemma} \label{lemma-de-rham-complex} let $a \to b$ be a ring map. let $\pi : \omega_{b/a} \to \omega$ be a surjective $b$-module map. denote $\text{d} : b \to \omega$ the composition of $\pi$ with the universal derivation $\text{d}_{b/a} : b \to \omega_{b/a}$. set $\omega^i = \wedge_b^i(\omega)$. assume that the kernel of $\pi$ is generated, as a $b$-module, by elements $\omega \in \omega_{b/a}$ such that $\text{d}_{b/a}(\omega) \in \omega_{b/a}^2$ maps to zero in $\omega^2$. then there is a de rham complex $$ \omega^0 \to \omega^1 \to \omega^2 \to \ldots $$ whose differential is defined by the rule $$ \text{d} : \omega^p \to \omega^{p + 1},\quad \text{d}\left(f_0\text{d}f_1 \wedge \ldots \wedge \text{d}f_p\right) = \text{d}f_0 \wedge \text{d}f_1 \wedge \ldots \wedge \text{d}f_p $$ \end{lemma} \begin{proof} we will show that there exists a commutative diagram $$ \xymatrix{ \omega_{b/a}^0 \ar[d] \ar[r]_{\text{d}_{b/a}} & \omega_{b/a}^1 \ar[d]_\pi \ar[r]_{\text{d}_{b/a}} & \omega_{b/a}^2 \ar[d]_{\wedge^2\pi} \ar[r]_{\text{d}_{b/a}} & \ldots \\ \omega^0 \ar[r]^{\text{d}} & \omega^1 \ar[r]^{\text{d}} & \omega^2 \ar[r]^{\text{d}} & \ldots } $$ the description of the map $\text{d}$ will follow from the construction of the differentials $\text{d}_{b/a} : \omega^p_{b/a} \to \omega^{p + 1}_{b/a}$ of the de rham complex of $b$ over $a$ given above. since the left most vertical arrow is an isomorphism we have the first square. because $\pi$ is surjective, to get the second square it suffices to show that $\text{d}_{b/a}$ maps the kernel of $\pi$ into the kernel of $\wedge^2\pi$. we are given that any element of the kernel of $\pi$ is of the form $\sum b_i\omega_i$ with $\pi(\omega_i) = 0$ and $\wedge^2\pi(\text{d}_{b/a}(\omega_i)) = 0$. by the leibniz rule for $\text{d}_{b/a}$ we have $\text{d}_{b/a}(\sum b_i\omega_i) = \sum b_i \text{d}_{b/a}(\omega_i) + \sum \text{d}_{b/a}(b_i) \wedge \omega_i$. hence this maps to zero under $\wedge^2\pi$. \medskip\noindent for $i > 1$ we note that $\wedge^i \pi$ is surjective with kernel the image of $\ker(\pi) \wedge \omega^{i - 1}_{b/a} \to \omega_{b/a}^i$. for $\omega_1 \in \ker(\pi)$ and $\omega_2 \in \omega^{i - 1}_{b/a}$ we have $$ \text{d}_{b/a}(\omega_1 \wedge \omega_2) = \text{d}_{b/a}(\omega_1) \wedge \omega_2 - \omega_1 \wedge \text{d}_{b/a}(\omega_2) $$ which is in the kernel of $\wedge^{i + 1}\pi$ by what we just proved above. hence we get the $(i + 1)$st square in the diagram above. this concludes the proof. \end{proof} \section{finite order differential operators} \label{section-differential-operators} \noindent in this section we introduce differential operators of finite order. \begin{definition} \label{definition-differential-operators} let $r \to s$ be a ring map. let $m$, $n$ be $s$-modules. let $k \geq 0$ be an integer. we inductively define a {\it differential operator $d : m \to n$ of order $k$} to be an $r$-linear map such that for all $g \in s$ the map $m \mapsto d(gm) - gd(m)$ is a differential operator of order $k - 1$. for the base case $k = 0$ we define a differential operator of order $0$ to be an $s$-linear map. \end{definition} \noindent if $d : m \to n$ is a differential operator of order $k$, then for all $g \in s$ the map $gd$ is a differential operator of order $k$. the sum of two differential operators of order $k$ is another. hence the set of all these $$ \text{diff}^k(m, n) = \text{diff}^k_{s/r}(m, n) $$ is an $s$-module. we have $$ \text{diff}^0(m, n) \subset \text{diff}^1(m, n) \subset \text{diff}^2(m, n) \subset \ldots $$ \begin{lemma} \label{lemma-composition-differential-operators} let $r \to s$ be a ring map. let $l, m, n$ be $s$-modules. if $d : l \to m$ and $d' : m \to n$ are differential operators of order $k$ and $k'$, then $d' \circ d$ is a differential operator of order $k + k'$. \end{lemma} \begin{proof} let $g \in s$. then the map which sends $x \in l$ to $$ d'(d(gx)) - gd'(d(x)) = d'(d(gx)) - d'(gd(x)) + d'(gd(x)) - gd'(d(x)) $$ is a sum of two compositions of differential operators of lower order. hence the lemma follows by induction on $k + k'$. \end{proof} \begin{lemma} \label{lemma-module-principal-parts} let $r \to s$ be a ring map. let $m$ be an $s$-module. let $k \geq 0$. there exists an $s$-module $p^k_{s/r}(m)$ and a canonical isomorphism $$ \text{diff}^k_{s/r}(m, n) = \hom_s(p^k_{s/r}(m), n) $$ functorial in the $s$-module $n$. \end{lemma} \noindent via the yoneda lemma this tells us there exists a ``universal'' differential operator $d_{univ} : m \to p^k_{s/r}(m)$ of order $k$ such that for every differential operator $d : m \to n$ of order $k$ there is a unique $s$-linear map $\alpha : p^k_{s/r}(m) \to n$ with $d = d_{univ} \circ \alpha$. the pair $(p^k_{s/r}(m), d_{univ})$ is unique up to unique isomorphism. \begin{proof} the existence of $p^k_{s/r}(m)$ follows from general category theoretic arguments (insert future reference here), but we will also give a construction. set $f = \bigoplus_{m \in m} s[m]$ where $[m]$ is a symbol indicating the basis element in the summand corresponding to $m$. given any differential operator $d : m \to n$ we obtain an $s$-linear map $l_d : f \to n$ sending $[m]$ to $d(m)$. if $d$ has order $0$, then $l_d$ annihilates the elements $$ [m + m'] - [m] - [m'],\quad g_0[m] - [g_0m] $$ where $g_0 \in s$ and $m, m' \in m$. if $d$ has order $1$, then $l_d$ annihilates the elements $$ [m + m'] - [m] - [m'],\quad f[m] - [fm], \quad g_0g_1[m] - g_0[g_1m] - g_1[g_0m] + [g_1g_0m] $$ where $f \in r$, $g_0, g_1 \in s$, and $m \in m$. if $d$ has order $k$, then $l_d$ annihilates the elements $[m + m'] - [m] - [m']$, $f[m] - [fm]$, and the elements $$ g_0g_1\ldots g_k[m] - \sum g_0 \ldots \hat g_i \ldots g_k[g_im] + \ldots +(-1)^{k + 1}[g_0\ldots g_km] $$ conversely, if $l : f \to n$ is an $s$-linear map annihilating all the elements listed in the previous sentence, then $m \mapsto l([m])$ is a differential operator of order $k$. thus we see that $p^k_{s/r}(m)$ is the quotient of $f$ by the submodule generated by these elements. \end{proof} \begin{definition} \label{definition-module-principal-parts} let $r \to s$ be a ring map. let $m$ be an $s$-module. the module $p^k_{s/r}(m)$ constructed in lemma \ref{lemma-module-principal-parts} is called the {\it module of principal parts of order $k$} of $m$. \end{definition} \noindent note that the inclusions $$ \text{diff}^0(m, n) \subset \text{diff}^1(m, n) \subset \text{diff}^2(m, n) \subset \ldots $$ correspond via yoneda's lemma (categories, lemma \ref{categories-lemma-yoneda}) to surjections $$ \ldots \to p^2_{s/r}(m) \to p^1_{s/r}(m) \to p^0_{s/r}(m) = m $$ \begin{example} \label{example-derivations-and-differential-operators} let $r \to s$ be a ring map and let $n$ be an $s$-module. observe that $\text{diff}^1(s, n) = \text{der}_r(s, n) \oplus n$. namely, if $d : s \to n$ is a differential operator of order $1$ then $\sigma_d : s \to n$ defined by $\sigma_d(g) := d(g) - gd(1)$ is an $r$-derivation and $d = \sigma_d + \lambda_{d(1)}$ where $\lambda_x : s \to n$ is the linear map sending $g$ to $gx$. it follows that $p^1_{s/r} = \omega_{s/r} \oplus s$ by the universal property of $\omega_{s/r}$. \end{example} \begin{lemma} \label{lemma-sequence-of-principal-parts} let $r \to s$ be a ring map. let $m$ be an $s$-module. there is a canonical short exact sequence $$ 0 \to \omega_{s/r} \otimes_s m \to p^1_{s/r}(m) \to m \to 0 $$ functorial in $m$ called the {\it sequence of principal parts}. \end{lemma} \begin{proof} the map $p^1_{s/r}(m) \to m$ is given above. let $n$ be an $s$-module and let $d : m \to n$ be a differential operator of order $1$. for $m \in m$ the map $$ g \longmapsto d(gm) - gd(m) $$ is an $r$-derivation $s \to n$ by the axioms for differential operators of order $1$. thus it corresponds to a linear map $d_m : \omega_{s/r} \to n$ determined by the rule $a\text{d}b \mapsto ad(bm) - abd(m)$ (see lemma \ref{lemma-universal-omega}). the map $$ \omega_{s/r} \times m \longrightarrow n,\quad (\eta, m) \longmapsto d_m(\eta) $$ is $s$-bilinear (details omitted) and hence determines an $s$-linear map $$ \sigma_d : \omega_{s/r} \otimes_s m \to n $$ in this way we obtain a map $\text{diff}^1(m, n) \to \hom_s(\omega_{s/r} \otimes_s m, n)$, $d \mapsto \sigma_d$ functorial in $n$. by the yoneda lemma this corresponds a map $\omega_{s/r} \otimes_s m \to p^1_{s/r}(m)$. it is immediate from the construction that this map is functorial in $m$. the sequence $$ \omega_{s/r} \otimes_s m \to p^1_{s/r}(m) \to m \to 0 $$ is exact because for every module $n$ the sequence $$ 0 \to \hom_s(m, n) \to \text{diff}^1(m, n) \to \hom_s(\omega_{s/r} \otimes_s m, n) $$ is exact by inspection. \medskip\noindent to see that $\omega_{s/r} \otimes_s m \to p^1_{s/r}(m)$ is injective we argue as follows. choose an exact sequence $$ 0 \to m' \to f \to m \to 0 $$ with $f$ a free $s$-module. this induces an exact sequence $$ 0 \to \text{diff}^1(m, n) \to \text{diff}^1(f, n) \to \text{diff}^1(m', n) $$ for all $n$. this proves that in the commutative diagram $$ \xymatrix{ 0 \ar[r] & \omega_{s/r} \otimes_s m' \ar[r] \ar[d] & p^1_{s/r}(m') \ar[r] \ar[d] & m' \ar[r] \ar[d] & 0 \\ 0 \ar[r] & \omega_{s/r} \otimes_s f \ar[r] \ar[d] & p^1_{s/r}(f) \ar[r] \ar[d] & f \ar[r] \ar[d] & 0 \\ 0 \ar[r] & \omega_{s/r} \otimes_s m \ar[r] \ar[d] & p^1_{s/r}(m) \ar[r] \ar[d] & m \ar[r] \ar[d] & 0 \\ & 0 & 0 & 0 } $$ the middle column is exact. the left column is exact by right exactness of $\omega_{s/r} \otimes_s -$. by the snake lemma (see section \ref{section-snake}) it suffices to prove exactness on the left for the free module $f$. using that $p^1_{s/r}(-)$ commutes with direct sums we reduce to the case $m = s$. this case is a consequence of the discussion in example \ref{example-derivations-and-differential-operators}. \end{proof} \begin{remark} \label{remark-functoriality-principal-parts} suppose given a commutative diagram of rings $$ \xymatrix{ b \ar[r] & b' \\ a \ar[u] \ar[r] & a' \ar[u] } $$ a $b$-module $m$, a $b'$-module $m'$, and a $b$-linear map $m \to m'$. then we get a compatible system of module maps $$ \xymatrix{ \ldots \ar[r] & p^2_{b'/a'}(m') \ar[r] & p^1_{b'/a'}(m') \ar[r] & p^0_{b'/a'}(m') \\ \ldots \ar[r] & p^2_{b/a}(m) \ar[r] \ar[u] & p^1_{b/a}(m) \ar[r] \ar[u] & p^0_{b/a}(m) \ar[u] } $$ these maps are compatible with further composition of maps of this type. the easiest way to see this is to use the description of the modules $p^k_{b/a}(m)$ in terms of generators and relations in the proof of lemma \ref{lemma-module-principal-parts} but it can also be seen directly from the universal property of these modules. moreover, these maps are compatible with the short exact sequences of lemma \ref{lemma-sequence-of-principal-parts}. \end{remark} \begin{lemma} \label{lemma-principal-parts-base-change} suppose that we have ring maps $a \to a'$ and $a \to b$ and a $b$-module $m$. set $b' = b \otimes_a a'$ and view $m' = m \otimes_a a'$ as a $b'$-module. the map of remark \ref{remark-functoriality-principal-parts} induces an isomorphism $p^k_{b/a}(m) \otimes_a a' = p^k_{b'/a'}(m')$. \end{lemma} \begin{proof} let $d_{univ} : m \to p^k_{b/a}(m)$ be the universal differential operator. the induced $a'$-linear map $d_{univ} \otimes 1 : m' = m \otimes_a a' \to p^k_{b/a}(m) \otimes_a a'$ is easily verified to be an order $k$ differential operator for $m'/b'/a'$. we will show that $d_{univ} \otimes 1$ satisfies the universal property. let $d' : m' \to n'$ be a differential operator of order $k$ into a $b'$-module $n'$. then the composition $d : m \to m' \to n'$ is a differential operator into $n'$ viewed as a $b$-module. hence there is a $b$-linear map $\gamma : p^k_{b/a}(m) \to n'$ such that $d = \gamma \circ d_{univ}$. the reader checks easily that the induced $b'$-linear map $\gamma' : p^k_{b/a}(m) \otimes_a a' \to n'$ satisfies $\gamma' \circ (d_{univ} \otimes 1) = d'$. we omit the proof that $\gamma'$ is unique. \end{proof} \begin{lemma} \label{lemma-principal-parts-diagonal} let $r \to s$ be a ring map. let $m$ be an $s$-module. let $j = \ker(s \otimes_r s \to s)$ be the kernel of the multiplication map. there is a canonical isomorphism of $s$-modules $$ p^k_{s/r}(m) \longrightarrow (s \otimes_r m)/j^{k + 1}(s \otimes_r m) $$ where $s \in s$ acts on the target via multiplication by $s \otimes 1$ and such that the universal differential operators of order $k$ to the map given by $m \mapsto \text{class of }1 \otimes m$. \end{lemma} \begin{proof} consider the map $t : m \to s \otimes m$, $m \mapsto 1 \otimes m$ since $t$ is $r$-linear and since \begin{align*} g_0g_1\ldots g_k t(m) - \sum g_0 \ldots \hat g_i \ldots g_k t(g_im) + \ldots +(-1)^{k + 1}t(g_0\ldots g_km) \\ = \prod_{i = 0,\ldots,k} (g_i \otimes 1 - 1 \otimes g_i) 1 \otimes m \end{align*} for $m \in m$ and $g_0, \ldots, g_k \in s$, we conclude that the rule $m \mapsto \text{class of }1 \otimes m$ in the statement of the lemma is a differential operator of order $k$ (see proof of lemma \ref{lemma-module-principal-parts}). by the universal property of $p^k_{s/r}(m)$ we obtain the arrow in the statement of the lemma. on the other hand, if $d : m \to n$ is a differential operator of order $k$, then we can consider the $s$-linear map $l : s \otimes_r m \to n$, $g \otimes m \mapsto gd(m)$. the reader checks, by a computation similar to the one above and using that $j$ is generated by elements of the form $g \otimes 1 - 1 \otimes g$, that $l$ annihilates $j^{k + 1}(s \otimes_r m)$. in particular, if we apply this to the universal differential operator $d_{univ} : m \to p^k_{s/r}(m)$, then we obtain an $s$-linear map $(s \otimes_r m)/j^{k + 1}(s \otimes_r m) \to p^k_{s/r}(m)$. we leave it to the reader to see that this map is the inverse to the map in the statement of the lemma. \end{proof} \begin{lemma} \label{lemma-differentials-de-rham-complex-order-1} let $a \to b$ be a ring map. the differentials $\text{d} : \omega^i_{b/a} \to \omega^{i + 1}_{b/a}$ are differential operators of order $1$. \end{lemma} \begin{proof} given $b \in b$ we have to show that $\text{d} \circ b - b \circ \text{d}$ is a linear operator. thus we have to show that $$ \text{d} \circ b \circ b' - b \circ \text{d} \circ b' - b' \circ \text{d} \circ b + b' \circ b \circ \text{d} = 0 $$ to see this it suffices to check this on additive generators for $\omega^i_{b/a}$. thus it suffices to show that $$ \text{d}(bb'b_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_i) - b\text{d}(b'b_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_i) - b'\text{d}(bb_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_i) + bb'\text{d}(b_0\text{d}b_1 \wedge \ldots \wedge \text{d}b_i) $$ is zero. this is a pleasant calculation using the leibniz rule which is left to the reader. \end{proof} \begin{lemma} \label{lemma-check-differential-operators} let $a \to b$ be a ring map. let $g_i \in b$, $i \in i$ be a set of generators for $b$ as an $a$-algebra. let $m, n$ be $b$-modules. let $d : m \to n$ be an $a$-linear map. in order to show that $d$ is a differential operator of order $k$ it suffices to show that $d \circ g_i - g_i \circ d$ is a differential operator of order $k - 1$ for $i \in i$. \end{lemma} \begin{proof} namely, we claim that the set of elements $g \in b$ such that $d \circ g - g \circ d$ is a differential operator of order $k - 1$ is an $a$-subalgebra of $b$. this follows from the relations $$ d \circ (g + g') - (g + g') \circ d = (d \circ g - g \circ d) + (d \circ g' - g' \circ d) $$ and $$ d \circ gg' - gg' \circ d = (d \circ g - g \circ d) \circ g' + g \circ (d \circ g' - g' \circ d) $$ strictly speaking, to conclude for products we also use lemma \ref{lemma-composition-differential-operators}. \end{proof} \begin{lemma} \label{lemma-invert-system-differential-operators} let $a \to b$ be a ring map. let $m, n$ be $b$-modules. let $s \subset b$ be a multiplicative subset. any differential operator $d : m \to n$ of order $k$ extends uniquely to a differential operator $e : s^{-1}m \to s^{-1}n$ of order $k$. \end{lemma} \begin{proof} by induction on $k$. if $k = 0$, then $d$ is $b$-linear and hence we get the extension by the functoriality of localization. given $b \in b$ the operator $l_b : m \mapsto d(bm) - bd(m)$ has order $k - 1$. hence it has a unique extension to a differential operator $e_b : s^{-1}m \to s^{-1}n$ of order $k - 1$ by induction. moreover, a computation shows that $l_{b'b} = l_{b'} \circ b + b' \circ l_b$ hence by uniqueness we obtain $e_{b'b} = e_{b'} \circ b + b' \circ e_b$. similarly, we obtain $e_{b'} \circ b - b \circ e_{b'} = e_b \circ b' - b' \circ e_b$. now for $m \in m$ and $g \in s$ we set $$ e(m/g) = (1/g)(d(m) - e_g(m/g)) $$ to show that this is well defined it suffices to show that for $g' \in s$ if we use the representative $g'm/g'g$ we get the same result. we compute \begin{align*} (1/g'g)(d(g'm) - e_{g'g}(g'm/gg')) & = (1/gg')(g'd(m) + e_{g'}(m) - e_{g'g}(g'm/gg')) \\ & = (1/g'g)(g'd(m) - g' e_g(m/g)) \end{align*} which is the same as before. it is clear that $e$ is $r$-linear as $d$ and $e_g$ are $r$-linear. taking $g = 1$ and using that $e_1 = 0$ we see that $e$ extends $d$. by lemma \ref{lemma-check-differential-operators} it now suffices to show that $e \circ b - b \circ e$ for $b \in b$ and $e \circ 1/g' - 1/g' \circ e$ for $g' \in s$ are differential operators of order $k - 1$ in order to show that $e$ is a differential operator of order $k$. for the first, choose an element $m/g$ in $s^{-1}m$ and observe that \begin{align*} e(b m/g) - be(m/g) & = (1/g)(d(bm) - bd(m) - e_g(bm/g) + be_g(m/g)) \\ & = (1/g)(l_b(m) - e_b(m) + ge_b(m/g)) \\ & = e_b(m/g) \end{align*} which is a differential operator of order $k - 1$. finally, we have \begin{align*} e(m/g'g) - (1/g')e(m/g) & = (1/g'g)(d(m) - e_{g'g}(m/g'g)) - (1/g'g)(d(m) - e_g(m/g)) \\ & = -(1/g')e_{g'}(m/g'g) \end{align*} which also is a differential operator of order $k - 1$ as the composition of linear maps (multiplication by $1/g'$ and signs) and $e_{g'}$. we omit the proof of uniqueness. \end{proof} \begin{lemma} \label{lemma-base-change-differential-operators} let $r \to a$ and $r \to b$ be ring maps. let $m$ and $m'$ be $a$-modules. let $d : m \to m'$ be a differential operator of order $k$ with respect to $r \to a$. let $n$ be any $b$-module. then the map $$ d \otimes \text{id}_n : m \otimes_r n \to m' \otimes_r n $$ is a differential operator of order $k$ with respect to $b \to a \otimes_r b$. \end{lemma} \begin{proof} it is clear that $d' = d \otimes \text{id}_n$ is $b$-linear. by lemma \ref{lemma-check-differential-operators} it suffices to show that $$ d' \circ a \otimes 1 - a \otimes 1 \circ d' = (d \circ a - a \circ d) \otimes \text{id}_n $$ is a differential operator of order $k - 1$ which follows by induction on $k$. \end{proof} \section{the naive cotangent complex} \label{section-netherlander} \noindent let $r \to s$ be a ring map. denote $r[s]$ the polynomial ring whose variables are the elements $s \in s$. let's denote $[s] \in r[s]$ the variable corresponding to $s \in s$. thus $r[s]$ is a free $r$-module on the basis elements $[s_1] \ldots [s_n]$ where $s_1, \ldots, s_n$ ranges over all unordered sequences of elements of $s$. there is a canonical surjection \begin{equation} \label{equation-canonical-presentation} r[s] \longrightarrow s,\quad [s] \longmapsto s \end{equation} whose kernel we denote $i \subset r[s]$. it is a simple observation that $i$ is generated by the elements $[s + s'] - [s] - [s']$, $[s][s'] - [ss']$ and $[r] - r$. according to lemma \ref{lemma-differential-seq} there is a canonical map \begin{equation} \label{equation-naive-cotangent-complex} i/i^2 \longrightarrow \omega_{r[s]/r} \otimes_{r[s]} s \end{equation} whose cokernel is canonically isomorphic to $\omega_{s/r}$. observe that the $s$-module $\omega_{r[s]/r} \otimes_{r[s]} s$ is free on the generators $\text{d}[s]$. \begin{definition} \label{definition-naive-cotangent-complex} let $r \to s$ be a ring map. the {\it naive cotangent complex} $\nl_{s/r}$ is the chain complex (\ref{equation-naive-cotangent-complex}) $$ \nl_{s/r} = \left(i/i^2 \longrightarrow \omega_{r[s]/r} \otimes_{r[s]} s\right) $$ with $i/i^2$ placed in (homological) degree $1$ and $\omega_{r[s]/r} \otimes_{r[s]} s$ placed in degree $0$. we will denote $h_1(l_{s/r}) = h_1(\nl_{s/r})$\footnote{this module is sometimes denoted $\gamma_{s/r}$ in the literature.} the homology in degree $1$. \end{definition} \noindent before we continue let us say a few words about the actual cotangent complex (cotangent, section \ref{cotangent-section-cotangent-ring-map}). given a ring map $r \to s$ there exists a canonical simplicial $r$-algebra $p_\bullet$ whose terms are polynomial algebras and which comes equipped with a canonical homotopy equivalence $$ p_\bullet \longrightarrow s $$ the cotangent complex $l_{s/r}$ of $s$ over $r$ is defined as the chain complex associated to the simplicial module $$ \omega_{p_\bullet/r} \otimes_{p_\bullet} s $$ the naive cotangent complex as defined above is canonically isomorphic to the truncation $\tau_{\leq 1}l_{s/r}$ (see homology, section \ref{homology-section-truncations} and cotangent, section \ref{cotangent-section-surjections}). in particular, it is indeed the case that $h_1(\nl_{s/r}) = h_1(l_{s/r})$ so our definition is compatible with the one using the cotangent complex. moreover, $h_0(l_{s/r}) = h_0(\nl_{s/r}) = \omega_{s/r}$ as we've seen above. \medskip\noindent let $r \to s$ be a ring map. a {\it presentation of $s$ over $r$} is a surjection $\alpha : p \to s$ of $r$-algebras where $p$ is a polynomial algebra (on a set of variables). often, when $s$ is of finite type over $r$ we will indicate this by saying: ``let $r[x_1, \ldots, x_n] \to s$ be a presentation of $s/r$'', or ``let $0 \to i \to r[x_1, \ldots, x_n] \to s \to 0$ be a presentation of $s/r$'' if we want to indicate that $i$ is the kernel of the presentation. note that the map $r[s] \to s$ used to define the naive cotangent complex is an example of a presentation. \medskip\noindent note that for every presentation $\alpha$ we obtain a two term chain complex of $s$-modules $$ \nl(\alpha) : i/i^2 \longrightarrow \omega_{p/r} \otimes_p s. $$ here the term $i/i^2$ is placed in degree $1$ and the term $\omega_{p/r} \otimes s$ is placed in degree $0$. the class of $f \in i$ in $i/i^2$ is mapped to $\text{d}f \otimes 1$ in $\omega_{p/r} \otimes s$. the cokernel of this complex is canonically $\omega_{s/r}$, see lemma \ref{lemma-differential-seq}. we call the complex $\nl(\alpha)$ the {\it naive cotangent complex associated to the presentation $\alpha : p \to s$ of $s/r$}. note that if $p = r[s]$ with its canonical surjection onto $s$, then we recover $\nl_{s/r}$. if $p = r[x_1, \ldots, x_n]$ then will sometimes use the notation $i/i^2 \to \bigoplus_{i = 1, \ldots, n} s\text{d}x_i$ to denote this complex. \medskip\noindent suppose we are given a commutative diagram \begin{equation} \label{equation-functoriality-nl} \vcenter{ \xymatrix{ s \ar[r]_{\phi} & s' \\ r \ar[r] \ar[u] & r' \ar[u] } } \end{equation} of rings. let $\alpha : p \to s$ be a presentation of $s$ over $r$ and let $\alpha' : p' \to s'$ be a presentation of $s'$ over $r'$. a {\it morphism of presentations from $\alpha : p \to s$ to $\alpha' : p' \to s'$} is defined to be an $r$-algebra map $$ \varphi : p \to p' $$ such that $\phi \circ \alpha = \alpha' \circ \varphi$. note that in this case $\varphi(i) \subset i'$, where $i = \ker(\alpha)$ and $i' = \ker(\alpha')$. thus $\varphi$ induces a map of $s$-modules $i/i^2 \to i'/(i')^2$ and by functoriality of differentials also an $s$-module map $\omega_{p/r} \otimes s \to \omega_{p'/r'} \otimes s'$. these maps are compatible with the differentials of $\nl(\alpha)$ and $\nl(\alpha')$ and we obtain a map of naive cotangent complexes $$ \nl(\alpha) \longrightarrow \nl(\alpha'). $$ it is often convenient to consider the induced map $\nl(\alpha) \otimes_s s' \to \nl(\alpha')$. \medskip\noindent in the special case that $p = r[s]$ and $p' = r'[s']$ the map $\phi : s \to s'$ induces a canonical ring map $\varphi : p \to p'$ by the rule $[s] \mapsto [\phi(s)]$. hence the construction above determines canonical(!) maps of chain complexes $$ \nl_{s/r} \longrightarrow \nl_{s'/r'},\quad\text{and}\quad \nl_{s/r} \otimes_s s' \longrightarrow \nl_{s'/r'} $$ associated to the diagram (\ref{equation-functoriality-nl}). note that this construction is compatible with composition: given a commutative diagram $$ \xymatrix{ s \ar[r]_{\phi} & s' \ar[r]_{\phi'} & s'' \\ r \ar[r] \ar[u] & r' \ar[u] \ar[r] & r'' \ar[u] } $$ we see that the composition of $$ \nl_{s/r} \longrightarrow \nl_{s'/r'} \longrightarrow \nl_{s''/r''} $$ is the map $\nl_{s/r} \to \nl_{s''/r''}$ given by the outer square. \medskip\noindent it turns out that $\nl(\alpha)$ is homotopy equivalent to $\nl_{s/r}$ and that the maps constructed above are well defined up to homotopy (homotopies of maps of complexes are discussed in homology, section \ref{homology-section-complexes} but we also spell out the exact meaning of the statements in the lemma below in its proof). \begin{lemma} \label{lemma-nl-homotopy} suppose given a diagram (\ref{equation-functoriality-nl}). let $\alpha : p \to s$ and $\alpha' : p' \to s'$ be presentations. \begin{enumerate} \item there exists a morphism of presentations from $\alpha$ to $\alpha'$. \item any two morphisms of presentations induce homotopic morphisms of complexes $\nl(\alpha) \to \nl(\alpha')$. \item the construction is compatible with compositions of morphisms of presentations (see proof for exact statement). \item if $r \to r'$ and $s \to s'$ are isomorphisms, then for any map $\varphi$ of presentations from $\alpha$ to $\alpha'$ the induced map $\nl(\alpha) \to \nl(\alpha')$ is a homotopy equivalence and a quasi-isomorphism. \end{enumerate} in particular, comparing $\alpha$ to the canonical presentation (\ref{equation-canonical-presentation}) we conclude there is a quasi-isomorphism $\nl(\alpha) \to \nl_{s/r}$ well defined up to homotopy and compatible with all functorialities (up to homotopy). \end{lemma} \begin{proof} since $p$ is a polynomial algebra over $r$ we can write $p = r[x_a, a \in a]$ for some set $a$. as $\alpha'$ is surjective, we can choose for every $a \in a$ an element $f_a \in p'$ such that $\alpha'(f_a) = \phi(\alpha(x_a))$. let $\varphi : p = r[x_a, a \in a] \to p'$ be the unique $r$-algebra map such that $\varphi(x_a) = f_a$. this gives the morphism in (1). \medskip\noindent let $\varphi$ and $\varphi'$ morphisms of presentations from $\alpha$ to $\alpha'$. let $i = \ker(\alpha)$ and $i' = \ker(\alpha')$. we have to construct the diagonal map $h$ in the diagram $$ \xymatrix{ i/i^2 \ar[r]^-{\text{d}} \ar@<1ex>[d]^{\varphi'_1} \ar@<-1ex>[d]_{\varphi_1} & \omega_{p/r} \otimes_p s \ar@<1ex>[d]^{\varphi'_0} \ar@<-1ex>[d]_{\varphi_0} \ar[ld]_h \\ i'/(i')^2 \ar[r]^-{\text{d}} & \omega_{p'/r'} \otimes_{p'} s' } $$ where the vertical maps are induced by $\varphi$, $\varphi'$ such that $$ \varphi_1 - \varphi'_1 = h \circ \text{d} \quad\text{and}\quad \varphi_0 - \varphi'_0 = \text{d} \circ h $$ consider the map $\varphi - \varphi' : p \to p'$. since both $\varphi$ and $\varphi'$ are compatible with $\alpha$ and $\alpha'$ we obtain $\varphi - \varphi' : p \to i'$. this implies that $\varphi, \varphi' : p \to p'$ induce the same $p$-module structure on $i'/(i')^2$, since $\varphi(p)i' - \varphi'(p)i' = (\varphi - \varphi')(p)i' \in (i')^2$. also $\varphi - \varphi'$ is $r$-linear and $$ (\varphi - \varphi')(fg) = \varphi(f)(\varphi - \varphi')(g) + (\varphi - \varphi')(f)\varphi'(g) $$ hence the induced map $d : p \to i'/(i')^2$ is a $r$-derivation. thus we obtain a canonical map $h : \omega_{p/r} \otimes_p s \to i'/(i')^2$ such that $d = h \circ \text{d}$. a calculation (omitted) shows that $h$ is the desired homotopy. \medskip\noindent suppose that we have a commutative diagram $$ \xymatrix{ s \ar[r]_{\phi} & s' \ar[r]_{\phi'} & s'' \\ r \ar[r] \ar[u] & r' \ar[u] \ar[r] & r'' \ar[u] } $$ and that \begin{enumerate} \item $\alpha : p \to s$, \item $\alpha' : p' \to s'$, and \item $\alpha'' : p'' \to s''$ \end{enumerate} are presentations. suppose that \begin{enumerate} \item $\varphi : p \to p'$ is a morphism of presentations from $\alpha$ to $\alpha'$ and \item $\varphi' : p' \to p''$ is a morphism of presentations from $\alpha'$ to $\alpha''$. \end{enumerate} then it is immediate that $\varphi' \circ \varphi : p \to p''$ is a morphism of presentations from $\alpha$ to $\alpha''$ and that the induced map $\nl(\alpha) \to \nl(\alpha'')$ of naive cotangent complexes is the composition of the maps $\nl(\alpha) \to \nl(\alpha')$ and $\nl(\alpha') \to \nl(\alpha'')$ induced by $\varphi$ and $\varphi'$. \medskip\noindent in the simple case of complexes with 2 terms a quasi-isomorphism is just a map that induces an isomorphism on both the cokernel and the kernel of the maps between the terms. note that homotopic maps of 2 term complexes (as explained above) define the same maps on kernel and cokernel. hence if $\varphi$ is a map from a presentation $\alpha$ of $s$ over $r$ to itself, then the induced map $\nl(\alpha) \to \nl(\alpha)$ is a quasi-isomorphism being homotopic to the identity by part (2). to prove (4) in full generality, consider a morphism $\varphi'$ from $\alpha'$ to $\alpha$ which exists by (1). the compositions $\nl(\alpha) \to \nl(\alpha') \to \nl(\alpha)$ and $\nl(\alpha') \to \nl(\alpha) \to \nl(\alpha')$ are homotopic to the identity maps by (3), hence these maps are homotopy equivalences by definition. it follows formally that both maps $\nl(\alpha) \to \nl(\alpha')$ and $\nl(\alpha') \to \nl(\alpha)$ are quasi-isomorphisms. some details omitted. \end{proof} \begin{lemma} \label{lemma-nl-polynomial-algebra} let $a \to b$ be a polynomial algebra. then $\nl_{b/a}$ is homotopy equivalent to the chain complex $(0 \to \omega_{b/a})$ with $\omega_{b/a}$ in degree $0$. \end{lemma} \begin{proof} follows from lemma \ref{lemma-nl-homotopy} and the fact that $\text{id}_b : b \to b$ is a presentation of $b$ over $a$ with zero kernel. \end{proof} \noindent the following lemma is part of the motivation for introducing the naive cotangent complex. the cotangent complex extends this to a genuine long exact cohomology sequence. if $b \to c$ is a local complete intersection, then one can extend the sequence with a zero on the left, see more on algebra, lemma \ref{more-algebra-lemma-transitive-lci-at-end}. \begin{lemma}[jacobi-zariski sequence] \label{lemma-exact-sequence-nl} let $a \to b \to c$ be ring maps. choose a presentation $\alpha : a[x_s, s \in s] \to b$ with kernel $i$. choose a presentation $\beta : b[y_t, t \in t] \to c$ with kernel $j$. let $\gamma : a[x_s, y_t] \to c$ be the induced presentation of $c$ with kernel $k$. then we get a canonical commutative diagram $$ \xymatrix{ 0 \ar[r] & \omega_{a[x_s]/a} \otimes c \ar[r] & \omega_{a[x_s, y_t]/a} \otimes c \ar[r] & \omega_{b[y_t]/b} \otimes c \ar[r] & 0 \\ & i/i^2 \otimes c \ar[r] \ar[u] & k/k^2 \ar[r] \ar[u] & j/j^2 \ar[r] \ar[u] & 0 } $$ with exact rows. we get the following exact sequence of homology groups $$ h_1(\nl_{b/a} \otimes_b c) \to h_1(l_{c/a}) \to h_1(l_{c/b}) \to c \otimes_b \omega_{b/a} \to \omega_{c/a} \to \omega_{c/b} \to 0 $$ of $c$-modules extending the sequence of lemma \ref{lemma-exact-sequence-differentials}. if $\text{tor}_1^b(\omega_{b/a}, c) = 0$ and $\text{tor}_2^b(\omega_{b/a}, c) = 0$, then $h_1(\nl_{b/a} \otimes_b c) = h_1(l_{b/a}) \otimes_b c$. \end{lemma} \begin{proof} the precise definition of the maps is omitted. the exactness of the top row follows as the $\text{d}x_s$, $\text{d}y_t$ form a basis for the middle module. the map $\gamma$ factors $$ a[x_s, y_t] \to b[y_t] \to c $$ with surjective first arrow and second arrow equal to $\beta$. thus we see that $k \to j$ is surjective. moreover, the kernel of the first displayed arrow is $ia[x_s, y_t]$. hence $i/i^2 \otimes c$ surjects onto the kernel of $k/k^2 \to j/j^2$. finally, we can use lemma \ref{lemma-nl-homotopy} to identify the terms as homology groups of the naive cotangent complexes. \medskip\noindent the final assertion is a statement in homological algebra. recall that $\nl_{b/a} = (n^{-1} \to n^0)$ is a two term complex of $b$-modules with $n^0$ free and cohomology modules $h^0 = \omega_{b/a}$ and $h^{-1} = h_1(l_{b/a})$. write $m \subset n^0$ for the image of the differential. if $\text{tor}_1^b(h^0, c) = 0$, then we have an exact sequence $$ 0 \to m \otimes_b c \to n^0 \otimes_b c \to h^0 \otimes_b c \to 0 $$ since $n^0$ is free, we also see that $\text{tor}_2^b(h^0, c) = \text{tor}_1^b(m, c)$. hence if $\text{tor}_2^b(h^0, c) = 0$ then we also have an exact sequence $$ 0 \to h^{-1} \otimes_b c \to n^{-1} \otimes_b c \to m \otimes_b c \to 0 $$ putting everything together we see that if $\text{tor}_1^b(h^0, c) = 0$ and $\text{tor}_2^b(h^0, c) = 0$, then $h^{-1} \otimes_b c$ is the kernel of $n^{-1} \otimes_b c \to n^0 \otimes_b c$ as desired. \end{proof} \begin{remark} \label{remark-composition-homotopy-equivalent-to-zero} let $a \to b$ and $\phi : b \to c$ be ring maps. then the composition $\nl_{b/a} \to \nl_{c/a} \to \nl_{c/b}$ is homotopy equivalent to zero. namely, this composition is the functoriality of the naive cotangent complex for the square $$ \xymatrix{ b \ar[r]_\phi & c \\ a \ar[r] \ar[u] & b \ar[u] } $$ write $j = \ker(b[c] \to c)$. an explicit homotopy is given by the map $\omega_{a[b]/a} \otimes_a b \to j/j^2$ which maps the basis element $\text{d}[b]$ to the class of $[\phi(b)] - b$ in $j/j^2$. \end{remark} \begin{lemma} \label{lemma-nl-surjection} let $a \to b$ be a surjective ring map with kernel $i$. then $\nl_{b/a}$ is homotopy equivalent to the chain complex $(i/i^2 \to 0)$ with $i/i^2$ in degree $1$. in particular $h_1(l_{b/a}) = i/i^2$. \end{lemma} \begin{proof} follows from lemma \ref{lemma-nl-homotopy} and the fact that $a \to b$ is a presentation of $b$ over $a$. \end{proof} \begin{lemma} \label{lemma-application-nl} let $a \to b \to c$ be ring maps. assume $a \to c$ is surjective (so also $b \to c$ is). denote $i = \ker(a \to c)$ and $j = \ker(b \to c)$. then the sequence $$ i/i^2 \to j/j^2 \to \omega_{b/a} \otimes_b b/j \to 0 $$ is exact. \end{lemma} \begin{proof} follows from lemma \ref{lemma-exact-sequence-nl} and the description of the naive cotangent complexes $\nl_{c/b}$ and $\nl_{c/a}$ in lemma \ref{lemma-nl-surjection}. \end{proof} \begin{lemma}[flat base change] \label{lemma-change-base-nl} let $r \to s$ be a ring map. let $\alpha : p \to s$ be a presentation. let $r \to r'$ be a flat ring map. let $\alpha' : p \otimes_r r' \to s' = s \otimes_r r'$ be the induced presentation. then $\nl(\alpha) \otimes_r r' = \nl(\alpha) \otimes_s s' = \nl(\alpha')$. in particular, the canonical map $$ \nl_{s/r} \otimes_s s' \longrightarrow \nl_{s \otimes_r r'/r'} $$ is a homotopy equivalence if $r \to r'$ is flat. \end{lemma} \begin{proof} this is true because $\ker(\alpha') = r' \otimes_r \ker(\alpha)$ since $r \to r'$ is flat. \end{proof} \begin{lemma} \label{lemma-colimits-nl} let $r_i \to s_i$ be a system of ring maps over the directed set $i$. set $r = \colim r_i$ and $s = \colim s_i$. then $\nl_{s/r} = \colim \nl_{s_i/r_i}$. \end{lemma} \begin{proof} recall that $\nl_{s/r}$ is the complex $i/i^2 \to \bigoplus_{s \in s} s\text{d}[s]$ where $i \subset r[s]$ is the kernel of the canonical presentation $r[s] \to s$. now it is clear that $r[s] = \colim r_i[s_i]$ and similarly that $i = \colim i_i$ where $i_i = \ker(r_i[s_i] \to s_i)$. hence the lemma is clear. \end{proof} \begin{lemma} \label{lemma-nl-of-localization} if $s \subset a$ is a multiplicative subset of $a$, then $\nl_{s^{-1}a/a}$ is homotopy equivalent to the zero complex. \end{lemma} \begin{proof} since $a \to s^{-1}a$ is flat we see that $\nl_{s^{-1}a/a} \otimes_a s^{-1}a \to \nl_{s^{-1}a/s^{-1}a}$ is a homotopy equivalence by flat base change (lemma \ref{lemma-change-base-nl}). since the source of the arrow is isomorphic to $\nl_{s^{-1}a/a}$ and the target of the arrow is zero (by lemma \ref{lemma-nl-surjection}) we win. \end{proof} \begin{lemma} \label{lemma-nl-localize-bottom} let $s \subset a$ is a multiplicative subset of $a$. let $s^{-1}a \to b$ be a ring map. then $\nl_{b/a} \to \nl_{b/s^{-1}a}$ is a homotopy equivalence. \end{lemma} \begin{proof} choose a presentation $\alpha : p \to b$ of $b$ over $a$. then $\beta : s^{-1}p \to b$ is a presentation of $b$ over $s^{-1}a$. a direct computation shows that we have $\nl(\alpha) = \nl(\beta)$ which proves the lemma as the naive cotangent complex is well defined up to homotopy by lemma \ref{lemma-nl-homotopy}. \end{proof} \begin{lemma} \label{lemma-principal-localization-nl} \begin{slogan} the formation of the naive cotangent complex commutes with localization at an element. \end{slogan} let $a \to b$ be a ring map. let $g \in b$. suppose $\alpha : p \to b$ is a presentation with kernel $i$. then a presentation of $b_g$ over $a$ is the map $$ \beta : p[x] \longrightarrow b_g $$ extending $\alpha$ and sending $x$ to $1/g$. the kernel $j$ of $\beta$ is generated by $i$ and the element $f x - 1$ where $f \in p$ is an element mapped to $g \in b$ by $\alpha$. in this situation we have \begin{enumerate} \item $j/j^2 = (i/i^2)_g \oplus b_g (f x - 1)$, \item $\omega_{p[x]/a} \otimes_{p[x]} b_g = \omega_{p/a} \otimes_p b_g \oplus b_g \text{d}x$, \item $\nl(\beta) \cong \nl(\alpha) \otimes_b b_g \oplus (b_g \xrightarrow{g} b_g)$ \end{enumerate} hence the canonical map $\nl_{b/a} \otimes_b b_g \to \nl_{b_g/a}$ is a homotopy equivalence. \end{lemma} \begin{proof} since $p[x]/(i, fx - 1) = b[x]/(gx - 1) = b_g$ we get the statement about $i$ and $fx - 1$ generating $j$. consider the commutative diagram $$ \xymatrix{ 0 \ar[r] & \omega_{p/a} \otimes b_g \ar[r] & \omega_{p[x]/a} \otimes b_g \ar[r] & \omega_{b[x]/b} \otimes b_g \ar[r] & 0 \\ & (i/i^2)_g \ar[r] \ar[u] & j/j^2 \ar[r] \ar[u] & (gx - 1)/(gx - 1)^2 \ar[r] \ar[u] & 0 } $$ with exact rows of lemma \ref{lemma-exact-sequence-nl}. the $b_g$-module $\omega_{b[x]/b} \otimes b_g$ is free of rank $1$ on $\text{d}x$. the element $\text{d}x$ in the $b_g$-module $\omega_{p[x]/a} \otimes b_g$ provides a splitting for the top row. the element $gx - 1 \in (gx - 1)/(gx - 1)^2$ is mapped to $g\text{d}x$ in $\omega_{b[x]/b} \otimes b_g$ and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $b_g$. (this can also be seen by arguing that $gx - 1$ is a nonzerodivisor in $b[x]$ because it is a polynomial with invertible constant term and any nonzerodivisor gives a quasi-regular sequence of length $1$ by lemma \ref{lemma-regular-quasi-regular}.) \medskip\noindent let us prove $(i/i^2)_g \to j/j^2$ injective. consider the $p$-algebra map $$ \pi : p[x] \to (p/i^2)_f = p_f/i_f^2 $$ sending $x$ to $1/f$. since $j$ is generated by $i$ and $fx - 1$ we see that $\pi(j) \subset (i/i^2)_f = (i/i^2)_g$. since this is an ideal of square zero we see that $\pi(j^2) = 0$. if $a \in i$ maps to an element of $j^2$ in $j$, then $\pi(a) = 0$, which implies that $a$ maps to zero in $i_f/i_f^2$. this proves the desired injectivity. \medskip\noindent thus we have a short exact sequence of two term complexes $$ 0 \to \nl(\alpha) \otimes_b b_g \to \nl(\beta) \to (b_g \xrightarrow{g} b_g) \to 0 $$ such a short exact sequence can always be split in the category of complexes. in our particular case we can take as splittings $$ j/j^2 = (i/i^2)_g \oplus b_g (fx - 1)\quad\text{and}\quad \omega_{p[x]/a} \otimes b_g = \omega_{p/a} \otimes b_g \oplus b_g (g^{-2}\text{d}f + \text{d}x) $$ this works because $\text{d}(fx - 1) = x\text{d}f + f \text{d}x = g(g^{-2}\text{d}f + \text{d}x)$ in $\omega_{p[x]/a} \otimes b_g$. \end{proof} \begin{lemma} \label{lemma-localize-nl} let $a \to b$ be a ring map. let $s \subset b$ be a multiplicative subset. the canonical map $\nl_{b/a} \otimes_b s^{-1}b \to \nl_{s^{-1}b/a}$ is a quasi-isomorphism. \end{lemma} \begin{proof} we have $s^{-1}b = \colim_{g \in s} b_g$ where we think of $s$ as a directed set (ordering by divisibility), see lemma \ref{lemma-localization-colimit}. by lemma \ref{lemma-principal-localization-nl} each of the maps $\nl_{b/a} \otimes_b b_g \to \nl_{b_g/a}$ are quasi-isomorphisms. the lemma follows from lemma \ref{lemma-colimits-nl}. \end{proof} \begin{lemma} \label{lemma-sum-two-terms} let $r$ be a ring. let $a_1 \to a_0$, and $b_1 \to b_0$ be two term complexes. suppose that there exist morphisms of complexes $\varphi : a_\bullet \to b_\bullet$ and $\psi : b_\bullet \to a_\bullet$ such that $\varphi \circ \psi$ and $\psi \circ \varphi$ are homotopic to the identity maps. then $a_1 \oplus b_0 \cong b_1 \oplus a_0$ as $r$-modules. \end{lemma} \begin{proof} choose a map $h : a_0 \to a_1$ such that $$ \text{id}_{a_1} - \psi_1 \circ \varphi_1 = h \circ d_a \text{ and } \text{id}_{a_0} - \psi_0 \circ \varphi_0 = d_a \circ h. $$ similarly, choose a map $h' : b_0 \to b_1$ such that $$ \text{id}_{b_1} - \varphi_1 \circ \psi_1 = h' \circ d_b \text{ and } \text{id}_{b_0} - \varphi_0 \circ \psi_0 = d_b \circ h'. $$ a trivial computation shows that $$ \left( \begin{matrix} \text{id}_{a_1} & -h' \circ \psi_1 + h \circ \psi_0 \\ 0 & \text{id}_{b_0} \end{matrix} \right) = \left( \begin{matrix} \psi_1 & h \\ -d_b & \varphi_0 \end{matrix} \right) \left( \begin{matrix} \varphi_1 & - h' \\ d_a & \psi_0 \end{matrix} \right) $$ this shows that both matrices on the right hand side are invertible and proves the lemma. \end{proof} \begin{lemma} \label{lemma-conormal-module} let $r \to s$ be a ring map of finite type. for any presentations $\alpha : r[x_1, \ldots, x_n] \to s$, and $\beta : r[y_1, \ldots, y_m] \to s$ we have $$ i/i^2 \oplus s^{\oplus m} \cong j/j^2 \oplus s^{\oplus n} $$ as $s$-modules where $i = \ker(\alpha)$ and $j = \ker(\beta)$. \end{lemma} \begin{proof} see lemmas \ref{lemma-nl-homotopy} and \ref{lemma-sum-two-terms}. \end{proof} \begin{lemma} \label{lemma-conormal-module-localize} let $r \to s$ be a ring map of finite type. let $g \in s$. for any presentations $\alpha : r[x_1, \ldots, x_n] \to s$, and $\beta : r[y_1, \ldots, y_m] \to s_g$ we have $$ (i/i^2)_g \oplus s^{\oplus m}_g \cong j/j^2 \oplus s_g^{\oplus n} $$ as $s_g$-modules where $i = \ker(\alpha)$ and $j = \ker(\beta)$. \end{lemma} \begin{proof} let $\beta' : r[x_1, \ldots, x_n, x] \to s_g$ be the presentation of lemma \ref{lemma-principal-localization-nl} constructed starting with $\alpha$. then we know that $\nl(\alpha) \otimes_s s_g$ is homotopy equivalent to $\nl(\beta')$. we know that $\nl(\beta)$ and $\nl(\beta')$ are homotopy equivalent by lemma \ref{lemma-nl-homotopy}. we conclude that $\nl(\alpha) \otimes_s s_g$ is homotopy equivalent to $\nl(\beta)$. finally, we apply lemma \ref{lemma-conormal-module}. \end{proof} \section{local complete intersections} \label{section-lci} \noindent the property of being a local complete intersection is an intrinsic property of a noetherian local ring. this will be discussed in divided power algebra, section \ref{dpa-section-lci}. however, for the moment we just define this property for finite type algebras over a field. \begin{definition} \label{definition-lci-field} let $k$ be a field. let $s$ be a finite type $k$-algebra. \begin{enumerate} \item we say that $s$ is a {\it global complete intersection over $k$} if there exists a presentation $s = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ such that $\dim(s) = n - c$. \item we say that $s$ is a {\it local complete intersection over $k$} if there exists a covering $\spec(s) = \bigcup d(g_i)$ such that each of the rings $s_{g_i}$ is a global complete intersection over $k$. \end{enumerate} we will also use the convention that the zero ring is a global complete intersection over $k$. \end{definition} \noindent suppose $s$ is a global complete intersection $s = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ as in definition \ref{definition-lci-field}. for a maximal ideal $\mathfrak m \subset k[x_1, \ldots, x_n]$ we have $\dim(k[x_1, \ldots, x_n]_\mathfrak m) = n$ (lemma \ref{lemma-dim-affine-space}). if $(f_1, \ldots, f_c) \subset \mathfrak m$, then we conclude that $\dim(s_\mathfrak m) \geq n - c$ by lemma \ref{lemma-one-equation}. since $\dim(s) = n - c$ by definition \ref{definition-lci-field} we conclude that $\dim(s_\mathfrak m) = n - c$ for all maximal ideals of $s$ and that $\spec(s)$ is equidimensional (topology, definition \ref{topology-definition-equidimensional}) of dimension $n - c$, see lemma \ref{lemma-dimension-at-a-point-finite-type-over-field}. we will often use this without further mention. \begin{lemma} \label{lemma-localize-lci} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $g \in s$. \begin{enumerate} \item if $s$ is a global complete intersection so is $s_g$. \item if $s$ is a local complete intersection so is $s_g$. \end{enumerate} \end{lemma} \begin{proof} the second statement follows immediately from the first. proof of the first statement. if $s_g$ is the zero ring, then it is true. assume $s_g$ is nonzero. write $s = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ with $n - c = \dim(s)$ as in definition \ref{definition-lci-field}. by the remarks following the definition $\dim(s_g) = n - c$. let $g' \in k[x_1, \ldots, x_n]$ be an element whose residue class corresponds to $g$. then $s_g = k[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}g' - 1)$ as desired. \end{proof} \begin{lemma} \label{lemma-lci-cm} let $k$ be a field. let $s$ be a finite type $k$-algebra. if $s$ is a local complete intersection, then $s$ is a cohen-macaulay ring. \end{lemma} \begin{proof} choose a maximal prime $\mathfrak m$ of $s$. we have to show that $s_\mathfrak m$ is cohen-macaulay. by assumption we may assume $s = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ with $\dim(s) = n - c$. let $\mathfrak m' \subset k[x_1, \ldots, x_n]$ be the maximal ideal corresponding to $\mathfrak m$. according to proposition \ref{proposition-finite-gl-dim-polynomial-ring} the local ring $k[x_1, \ldots, x_n]_{\mathfrak m'}$ is regular local of dimension $n$. in particular it is cohen-macaulay by lemma \ref{lemma-regular-ring-cm}. by lemma \ref{lemma-one-equation} applied $c$ times the local ring $s_{\mathfrak m} = k[x_1, \ldots, x_n]_{\mathfrak m'}/(f_1, \ldots, f_c)$ has dimension $\geq n - c$. by assumption $\dim(s_{\mathfrak m}) \leq n - c$. thus we get equality. this implies that $f_1, \ldots, f_c$ is a regular sequence in $k[x_1, \ldots, x_n]_{\mathfrak m'}$ and that $s_{\mathfrak m}$ is cohen-macaulay, see proposition \ref{proposition-cm-module}. \end{proof} \noindent the following is the technical key to the rest of the material in this section. an important feature of this lemma is that we may choose any presentation for the ring $s$, but that condition (1) does not depend on this choice. \begin{lemma} \label{lemma-lci} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $\mathfrak q$ be a prime of $s$. choose any presentation $s = k[x_1, \ldots, x_n]/i$. let $\mathfrak q'$ be the prime of $k[x_1, \ldots, x_n]$ corresponding to $\mathfrak q$. set $c = \text{height}(\mathfrak q') - \text{height}(\mathfrak q)$, in other words $\dim_{\mathfrak q}(s) = n - c$ (see lemma \ref{lemma-codimension}). the following are equivalent \begin{enumerate} \item there exists a $g \in s$, $g \not \in \mathfrak q$ such that $s_g$ is a global complete intersection over $k$. \item the ideal $i_{\mathfrak q'} \subset k[x_1, \ldots, x_n]_{\mathfrak q'}$ can be generated by $c$ elements. \item the conormal module $(i/i^2)_{\mathfrak q}$ can be generated by $c$ elements over $s_{\mathfrak q}$. \item the conormal module $(i/i^2)_{\mathfrak q}$ is a free $s_{\mathfrak q}$-module of rank $c$. \item the ideal $i_{\mathfrak q'}$ can be generated by a regular sequence in the regular local ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$. \end{enumerate} in this case any $c$ elements of $i_{\mathfrak q'}$ which generate $i_{\mathfrak q'}/\mathfrak q'i_{\mathfrak q'}$ form a regular sequence in the local ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$. \end{lemma} \begin{proof} set $r = k[x_1, \ldots, x_n]_{\mathfrak q'}$. this is a cohen-macaulay local ring of dimension $\text{height}(\mathfrak q')$, see for example lemma \ref{lemma-lci-cm}. moreover, $\overline{r} = r/ir = r/i_{\mathfrak q'} = s_{\mathfrak q}$ is a quotient of dimension $\text{height}(\mathfrak q)$. let $f_1, \ldots, f_c \in i_{\mathfrak q'}$ be elements which generate $(i/i^2)_{\mathfrak q}$. by lemma \ref{lemma-nak} we see that $f_1, \ldots, f_c$ generate $i_{\mathfrak q'}$. since the dimensions work out, we conclude by proposition \ref{proposition-cm-module} that $f_1, \ldots, f_c$ is a regular sequence in $r$. by lemma \ref{lemma-regular-quasi-regular} we see that $(i/i^2)_{\mathfrak q}$ is free. these arguments show that (2), (3), (4) are equivalent and that they imply the last statement of the lemma, and therefore they imply (5). \medskip\noindent if (5) holds, say $i_{\mathfrak q'}$ is generated by a regular sequence of length $e$, then $\text{height}(\mathfrak q) = \dim(s_{\mathfrak q}) = \dim(k[x_1, \ldots, x_n]_{\mathfrak q'}) - e = \text{height}(\mathfrak q') - e$ by dimension theory, see section \ref{section-dimension}. we conclude that $e = c$. thus (5) implies (2). \medskip\noindent we continue with the notation introduced in the first paragraph. for each $f_i$ we may find $d_i \in k[x_1, \ldots, x_n]$, $d_i \not \in \mathfrak q'$ such that $f_i' = d_i f_i \in k[x_1, \ldots, x_n]$. then it is still true that $i_{\mathfrak q'} = (f_1', \ldots, f_c')r$. hence there exists a $g' \in k[x_1, \ldots, x_n]$, $g' \not \in \mathfrak q'$ such that $i_{g'} = (f_1', \ldots, f_c')$. moreover, pick $g'' \in k[x_1, \ldots, x_n]$, $g'' \not \in \mathfrak q'$ such that $\dim(s_{g''}) = \dim_{\mathfrak q} \spec(s)$. by lemma \ref{lemma-codimension} this dimension is equal to $n - c$. finally, set $g$ equal to the image of $g'g''$ in $s$. then we see that $$ s_g \cong k[x_1, \ldots, x_n, x_{n + 1}] / (f_1', \ldots, f_c', x_{n + 1}g'g'' - 1) $$ and by our choice of $g''$ this ring has dimension $n - c$. therefore it is a global complete intersection. thus each of (2), (3), and (4) implies (1). \medskip\noindent assume (1). let $s_g \cong k[y_1, \ldots, y_m]/(f_1, \ldots, f_t)$ be a presentation of $s_g$ as a global complete intersection. write $j = (f_1, \ldots, f_t)$. let $\mathfrak q'' \subset k[y_1, \ldots, y_m]$ be the prime corresponding to $\mathfrak qs_g$. note that $t = m - \dim(s_g) = \text{height}(\mathfrak q'') - \text{height}(\mathfrak q)$, see lemma \ref{lemma-codimension} for the last equality. as seen in the proof of lemma \ref{lemma-lci-cm} (and also above) the elements $f_1, \ldots, f_t$ form a regular sequence in the local ring $k[y_1, \ldots, y_m]_{\mathfrak q''}$. by lemma \ref{lemma-regular-quasi-regular} we see that $(j/j^2)_{\mathfrak q}$ is free of rank $t$. by lemma \ref{lemma-conormal-module-localize} we have $$ j/j^2 \oplus s_g^n \cong (i/i^2)_g \oplus s_g^m $$ thus $(i/i^2)_{\mathfrak q}$ is free of rank $t + n - m = m - \dim(s_g) + n - m = n - \dim(s_g) = \text{height}(\mathfrak q') - \text{height}(\mathfrak q) = c$. thus we obtain (4). \end{proof} \noindent the result of lemma \ref{lemma-lci} suggests the following definition. \begin{definition} \label{definition-lci-local-ring} let $k$ be a field. let $s$ be a local $k$-algebra essentially of finite type over $k$. we say $s$ is a {\it complete intersection (over $k$)} if there exists a local $k$-algebra $r$ and elements $f_1, \ldots, f_c \in \mathfrak m_r$ such that \begin{enumerate} \item $r$ is essentially of finite type over $k$, \item $r$ is a regular local ring, \item $f_1, \ldots, f_c$ form a regular sequence in $r$, and \item $s \cong r/(f_1, \ldots, f_c)$ as $k$-algebras. \end{enumerate} \end{definition} \noindent by the cohen structure theorem (see theorem \ref{theorem-cohen-structure-theorem}) any complete noetherian local ring may be written as the quotient of some regular complete local ring. hence we may use the definition above to define the notion of a complete intersection ring for any complete noetherian local ring. we will discuss this in divided power algebra, section \ref{dpa-section-lci}. in the meantime the following lemma shows that such a definition makes sense. \begin{lemma} \label{lemma-ci-well-defined} let $a \to b \to c$ be surjective local ring homomorphisms. assume $a$ and $b$ are regular local rings. the following are equivalent \begin{enumerate} \item $\ker(a \to c)$ is generated by a regular sequence, \item $\ker(a \to c)$ is generated by $\dim(a) - \dim(c)$ elements, \item $\ker(b \to c)$ is generated by a regular sequence, and \item $\ker(b \to c)$ is generated by $\dim(b) - \dim(c)$ elements. \end{enumerate} \end{lemma} \begin{proof} a regular local ring is cohen-macaulay, see lemma \ref{lemma-regular-ring-cm}. hence the equivalences (1) $\leftrightarrow$ (2) and (3) $\leftrightarrow$ (4), see proposition \ref{proposition-cm-module}. by lemma \ref{lemma-regular-quotient-regular} the ideal $\ker(a \to b)$ can be generated by $\dim(a) - \dim(b)$ elements. hence we see that (4) implies (2). \medskip\noindent it remains to show that (1) implies (4). we do this by induction on $\dim(a) - \dim(b)$. the case $\dim(a) - \dim(b) = 0$ is trivial. assume $\dim(a) > \dim (b)$. write $i = \ker(a \to c)$ and $j = \ker(a \to b)$. note that $j \subset i$. our assumption is that the minimal number of generators of $i$ is $\dim(a) - \dim(c)$. let $\mathfrak m \subset a$ be the maximal ideal. consider the maps $$ j/ \mathfrak m j \to i / \mathfrak m i \to \mathfrak m /\mathfrak m^2 $$ by lemma \ref{lemma-regular-quotient-regular} and its proof the composition is injective. take any element $x \in j$ which is not zero in $j /\mathfrak mj$. by the above and nakayama's lemma $x$ is an element of a minimal set of generators of $i$. hence we may replace $a$ by $a/xa$ and $i$ by $i/xa$ which decreases both $\dim(a)$ and the minimal number of generators of $i$ by $1$. thus we win. \end{proof} \begin{lemma} \label{lemma-lci-local} let $k$ be a field. let $s$ be a local $k$-algebra essentially of finite type over $k$. the following are equivalent: \begin{enumerate} \item $s$ is a complete intersection over $k$, \item for any surjection $r \to s$ with $r$ a regular local ring essentially of finite presentation over $k$ the ideal $\ker(r \to s)$ can be generated by a regular sequence, \item for some surjection $r \to s$ with $r$ a regular local ring essentially of finite presentation over $k$ the ideal $\ker(r \to s)$ can be generated by $\dim(r) - \dim(s)$ elements, \item there exists a global complete intersection $a$ over $k$ and a prime $\mathfrak a$ of $a$ such that $s \cong a_{\mathfrak a}$, and \item there exists a local complete intersection $a$ over $k$ and a prime $\mathfrak a$ of $a$ such that $s \cong a_{\mathfrak a}$. \end{enumerate} \end{lemma} \begin{proof} it is clear that (2) implies (1) and (1) implies (3). it is also clear that (4) implies (5). let us show that (3) implies (4). thus we assume there exists a surjection $r \to s$ with $r$ a regular local ring essentially of finite presentation over $k$ such that the ideal $\ker(r \to s)$ can be generated by $\dim(r) - \dim(s)$ elements. we may write $r = (k[x_1, \ldots, x_n]/j)_{\mathfrak q}$ for some $j \subset k[x_1, \ldots, x_n]$ and some prime $\mathfrak q \subset k[x_1, \ldots, x_n]$ with $j \subset \mathfrak q$. let $i \subset k[x_1, \ldots, x_n]$ be the kernel of the map $k[x_1, \ldots, x_n] \to s$ so that $s \cong (k[x_1, \ldots, x_n]/i)_{\mathfrak q}$. by assumption $(i/j)_{\mathfrak q}$ is generated by $\dim(r) - \dim(s)$ elements. we conclude that $i_{\mathfrak q}$ can be generated by $\dim(k[x_1, \ldots, x_n]_{\mathfrak q}) - \dim(s)$ elements by lemma \ref{lemma-ci-well-defined}. from lemma \ref{lemma-lci} we see that for some $g \in k[x_1, \ldots, x_n]$, $g \not \in \mathfrak q$ the algebra $(k[x_1, \ldots, x_n]/i)_g$ is a global complete intersection and $s$ is isomorphic to a local ring of it. \medskip\noindent to finish the proof of the lemma we have to show that (5) implies (2). assume (5) and let $\pi : r \to s$ be a surjection with $r$ a regular local $k$-algebra essentially of finite type over $k$. by assumption we have $s = a_{\mathfrak a}$ for some local complete intersection $a$ over $k$. choose a presentation $r = (k[y_1, \ldots, y_m]/j)_{\mathfrak q}$ with $j \subset \mathfrak q \subset k[y_1, \ldots, y_m]$. we may and do assume that $j$ is the kernel of the map $k[y_1, \ldots, y_m] \to r$. let $i \subset k[y_1, \ldots, y_m]$ be the kernel of the map $k[y_1, \ldots, y_m] \to s = a_{\mathfrak a}$. then $j \subset i$ and $(i/j)_{\mathfrak q}$ is the kernel of the surjection $\pi : r \to s$. so $s = (k[y_1, \ldots, y_m]/i)_{\mathfrak q}$. \medskip\noindent by lemma \ref{lemma-isomorphic-local-rings} we see that there exist $g \in a$, $g \not \in \mathfrak a$ and $g' \in k[y_1, \ldots, y_m]$, $g' \not \in \mathfrak q$ such that $a_g \cong (k[y_1, \ldots, y_m]/i)_{g'}$. after replacing $a$ by $a_g$ and $k[y_1, \ldots, y_m]$ by $k[y_1, \ldots, y_{m + 1}]$ we may assume that $a \cong k[y_1, \ldots, y_m]/i$. consider the surjective maps of local rings $$ k[y_1, \ldots, y_m]_{\mathfrak q} \to r \to s. $$ we have to show that the kernel of $r \to s$ is generated by a regular sequence. by lemma \ref{lemma-lci} we know that $k[y_1, \ldots, y_m]_{\mathfrak q} \to a_{\mathfrak a} = s$ has this property (as $a$ is a local complete intersection over $k$). we win by lemma \ref{lemma-ci-well-defined}. \end{proof} \begin{lemma} \label{lemma-lci-at-prime} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $\mathfrak q$ be a prime of $s$. the following are equivalent: \begin{enumerate} \item the local ring $s_{\mathfrak q}$ is a complete intersection ring (definition \ref{definition-lci-local-ring}). \item there exists a $g \in s$, $g \not \in \mathfrak q$ such that $s_g$ is a local complete intersection over $k$. \item there exists a $g \in s$, $g \not \in \mathfrak q$ such that $s_g$ is a global complete intersection over $k$. \item for any presentation $s = k[x_1, \ldots, x_n]/i$ with $\mathfrak q' \subset k[x_1, \ldots, x_n]$ corresponding to $\mathfrak q$ any of the equivalent conditions (1) -- (5) of lemma \ref{lemma-lci} hold. \end{enumerate} \end{lemma} \begin{proof} this is a combination of lemmas \ref{lemma-lci} and \ref{lemma-lci-local} and the definitions. \end{proof} \begin{lemma} \label{lemma-lci-global} let $k$ be a field. let $s$ be a finite type $k$-algebra. the following are equivalent: \begin{enumerate} \item the ring $s$ is a local complete intersection over $k$. \item all local rings of $s$ are complete intersection rings over $k$. \item all localizations of $s$ at maximal ideals are complete intersection rings over $k$. \end{enumerate} \end{lemma} \begin{proof} this follows from lemma \ref{lemma-lci-at-prime}, the fact that $\spec(s)$ is quasi-compact and the definitions. \end{proof} \noindent the following lemma says that being a complete intersection is preserved under change of base field (in a strong sense). \begin{lemma} \label{lemma-lci-field-change-local} let $k/k$ be a field extension. let $s$ be a finite type algebra over $k$. let $\mathfrak q_k$ be a prime of $s_k = k \otimes_k s$ and let $\mathfrak q$ be the corresponding prime of $s$. then $s_{\mathfrak q}$ is a complete intersection over $k$ (definition \ref{definition-lci-local-ring}) if and only if $(s_k)_{\mathfrak q_k}$ is a complete intersection over $k$. \end{lemma} \begin{proof} choose a presentation $s = k[x_1, \ldots, x_n]/i$. this gives a presentation $s_k = k[x_1, \ldots, x_n]/i_k$ where $i_k = k \otimes_k i$. let $\mathfrak q_k' \subset k[x_1, \ldots, x_n]$, resp.\ $\mathfrak q' \subset k[x_1, \ldots, x_n]$ be the corresponding prime. we will show that the equivalent conditions of lemma \ref{lemma-lci} hold for the pair $(s = k[x_1, \ldots, x_n]/i, \mathfrak q)$ if and only if they hold for the pair $(s_k = k[x_1, \ldots, x_n]/i_k, \mathfrak q_k)$. the lemma will follow from this (see lemma \ref{lemma-lci-at-prime}). \medskip\noindent by lemma \ref{lemma-dimension-at-a-point-preserved-field-extension} we have $\dim_{\mathfrak q} s = \dim_{\mathfrak q_k} s_k$. hence the integer $c$ occurring in lemma \ref{lemma-lci} is the same for the pair $(s = k[x_1, \ldots, x_n]/i, \mathfrak q)$ as for the pair $(s_k = k[x_1, \ldots, x_n]/i_k, \mathfrak q_k)$. on the other hand we have \begin{eqnarray*} i \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q') \otimes_{\kappa(\mathfrak q')} \kappa(\mathfrak q_k') & = & i \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q_k') \\ & = & i \otimes_{k[x_1, \ldots, x_n]} k[x_1, \ldots, x_n] \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q_k') \\ & = & (k \otimes_k i) \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q_k') \\ & = & i_k \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q'_k). \end{eqnarray*} therefore, $\dim_{\kappa(\mathfrak q')} i \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q') = \dim_{\kappa(\mathfrak q'_k)} i_k \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q_k')$. thus it follows from nakayama's lemma \ref{lemma-nak} that the minimal number of generators of $i_{\mathfrak q'}$ is the same as the minimal number of generators of $(i_k)_{\mathfrak q'_k}$. thus the lemma follows from characterization (2) of lemma \ref{lemma-lci}. \end{proof} \begin{lemma} \label{lemma-lci-field-change} let $k \to k$ be a field extension. let $s$ be a finite type $k$-algebra. then $s$ is a local complete intersection over $k$ if and only if $s \otimes_k k$ is a local complete intersection over $k$. \end{lemma} \begin{proof} this follows from a combination of lemmas \ref{lemma-lci-global} and \ref{lemma-lci-field-change-local}. but we also give a different proof here (based on the same principles). \medskip\noindent set $s' = s \otimes_k k$. let $\alpha : k[x_1, \ldots, x_n] \to s$ be a presentation with kernel $i$. let $\alpha' : k[x_1, \ldots, x_n] \to s'$ be the induced presentation with kernel $i'$. \medskip\noindent suppose that $s$ is a local complete intersection. pick a prime $\mathfrak q \subset s'$. denote $\mathfrak q'$ the corresponding prime of $k[x_1, \ldots, x_n]$, $\mathfrak p$ the corresponding prime of $s$, and $\mathfrak p'$ the corresponding prime of $k[x_1, \ldots, x_n]$. consider the following diagram of noetherian local rings $$ \xymatrix{ s'_{\mathfrak q} & k[x_1, \ldots, x_n]_{\mathfrak q'} \ar[l] \\ s_{\mathfrak p}\ar[u] & k[x_1, \ldots, x_n]_{\mathfrak p'} \ar[u] \ar[l] } $$ by lemma \ref{lemma-lci} we know that $s_{\mathfrak p}$ is cut out by some regular sequence $f_1, \ldots, f_c$ in $k[x_1, \ldots, x_n]_{\mathfrak p'}$. since the right vertical arrow is flat we see that the images of $f_1, \ldots, f_c$ form a regular sequence in $k[x_1, \ldots, x_n]_{\mathfrak q'}$. because tensoring with $k$ over $k$ is an exact functor we have $s'_{\mathfrak q} = k[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_c)$. hence by lemma \ref{lemma-lci} again we see that $s'$ is a local complete intersection in a neighbourhood of $\mathfrak q$. since $\mathfrak q$ was arbitrary we see that $s'$ is a local complete intersection over $k$. \medskip\noindent suppose that $s'$ is a local complete intersection. pick a maximal ideal $\mathfrak m$ of $s$. let $\mathfrak m'$ denote the corresponding maximal ideal of $k[x_1, \ldots, x_n]$. denote $\kappa = \kappa(\mathfrak m)$ the residue field. by remark \ref{remark-fundamental-diagram} the primes of $s'$ lying over $\mathfrak m$ correspond to primes in $k \otimes_k \kappa$. by the hilbert-nullstellensatz theorem \ref{theorem-nullstellensatz} we have $[\kappa : k] < \infty$. hence $k \otimes_k \kappa$ is finite nonzero over $k$. hence $k \otimes_k \kappa$ has a finite number $> 0$ of primes which are all maximal, each of which has a residue field finite over $k$ (see section \ref{section-artinian}). hence there are finitely many $> 0$ prime ideals $\mathfrak n \subset s'$ lying over $\mathfrak m$, each of which is maximal and has a residue field which is finite over $k$. pick one, say $\mathfrak n \subset s'$, and let $\mathfrak n' \subset k[x_1, \ldots, x_n]$ denote the corresponding prime ideal of $k[x_1, \ldots, x_n]$. note that since $v(\mathfrak ms')$ is finite, we see that $\mathfrak n$ is an isolated closed point of it, and we deduce that $\mathfrak ms'_{\mathfrak n}$ is an ideal of definition of $s'_{\mathfrak n}$. this implies that $\dim(s_{\mathfrak m}) = \dim(s'_{\mathfrak n})$ for example by lemma \ref{lemma-dimension-base-fibre-equals-total}. (this can also be seen using lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}.) consider the corresponding diagram of noetherian local rings $$ \xymatrix{ s'_{\mathfrak n} & k[x_1, \ldots, x_n]_{\mathfrak n'} \ar[l] \\ s_{\mathfrak m}\ar[u] & k[x_1, \ldots, x_n]_{\mathfrak m'} \ar[u] \ar[l] } $$ according to lemma \ref{lemma-change-base-nl} we have $\nl(\alpha) \otimes_s s' = \nl(\alpha')$, in particular $i'/(i')^2 = i/i^2 \otimes_s s'$. thus $(i/i^2)_{\mathfrak m} \otimes_{s_{\mathfrak m}} \kappa$ and $(i'/(i')^2)_{\mathfrak n} \otimes_{s'_{\mathfrak n}} \kappa(\mathfrak n)$ have the same dimension. since $(i'/(i')^2)_{\mathfrak n}$ is free of rank $n - \dim s'_{\mathfrak n}$ we deduce that $(i/i^2)_{\mathfrak m}$ can be generated by $n - \dim s'_{\mathfrak n} = n - \dim s_{\mathfrak m}$ elements. by lemma \ref{lemma-lci} we see that $s$ is a local complete intersection in a neighbourhood of $\mathfrak m$. since $\mathfrak m$ was any maximal ideal we conclude that $s$ is a local complete intersection. \end{proof} \noindent we end with a lemma which we will later use to prove that given ring maps $t \to a \to b$ where $b$ is syntomic over $t$, and $b$ is syntomic over $a$, then $a$ is syntomic over $t$. \begin{lemma} \label{lemma-lci-permanence-initial} let $$ \xymatrix{ b & s \ar[l] \\ a \ar[u] & r \ar[l] \ar[u] } $$ be a commutative square of local rings. assume \begin{enumerate} \item $r$ and $\overline{s} = s/\mathfrak m_r s$ are regular local rings, \item $a = r/i$ and $b = s/j$ for some ideals $i$, $j$, \item $j \subset s$ and $\overline{j} = j/\mathfrak m_r \cap j \subset \overline{s}$ are generated by regular sequences, and \item $a \to b$ and $r \to s$ are flat. \end{enumerate} then $i$ is generated by a regular sequence. \end{lemma} \begin{proof} set $\overline{b} = b/\mathfrak m_rb = b/\mathfrak m_ab$ so that $\overline{b} = \overline{s}/\overline{j}$. let $f_1, \ldots, f_{\overline{c}} \in j$ be elements such that $\overline{f}_1, \ldots, \overline{f}_{\overline{c}} \in \overline{j}$ form a regular sequence generating $\overline{j}$. note that $\overline{c} = \dim(\overline{s}) - \dim(\overline{b})$, see lemma \ref{lemma-ci-well-defined}. by lemma \ref{lemma-grothendieck-regular-sequence} the ring $s/(f_1, \ldots, f_{\overline{c}})$ is flat over $r$. hence $s/(f_1, \ldots, f_{\overline{c}}) + is$ is flat over $a$. the map $s/(f_1, \ldots, f_{\overline{c}}) + is \to b$ is therefore a surjection of finite $s/is$-modules flat over $a$ which is an isomorphism modulo $\mathfrak m_a$, and hence an isomorphism by lemma \ref{lemma-mod-injective}. in other words, $j = (f_1, \ldots, f_{\overline{c}}) + is$. \medskip\noindent by lemma \ref{lemma-ci-well-defined} again the ideal $j$ is generated by a regular sequence of $c = \dim(s) - \dim(b)$ elements. hence $j/\mathfrak m_sj$ is a vector space of dimension $c$. by the description of $j$ above there exist $g_1, \ldots, g_{c - \overline{c}} \in i$ such that $j$ is generated by $f_1, \ldots, f_{\overline{c}}, g_1, \ldots, g_{c - \overline{c}}$ (use nakayama's lemma \ref{lemma-nak}). consider the ring $a' = r/(g_1, \ldots, g_{c - \overline{c}})$ and the surjection $a' \to a$. we see from the above that $b = s/(f_1, \ldots, f_{\overline{c}}, g_1, \ldots, g_{c - \overline{c}})$ is flat over $a'$ (as $s/(f_1, \ldots, f_{\overline{c}})$ is flat over $r$). hence $a' \to b$ is injective (as it is faithfully flat, see lemma \ref{lemma-local-flat-ff}). since this map factors through $a$ we get $a' = a$. note that $\dim(b) = \dim(a) + \dim(\overline{b})$, and $\dim(s) = \dim(r) + \dim(\overline{s})$, see lemma \ref{lemma-dimension-base-fibre-equals-total}. hence $c - \overline{c} = \dim(r) -\dim(a)$ by elementary algebra. thus $i = (g_1, \ldots, g_{c - \overline{c}})$ is generated by a regular sequence according to lemma \ref{lemma-ci-well-defined}. \end{proof} \section{syntomic morphisms} \label{section-syntomic} \noindent syntomic ring maps are flat finitely presented ring maps all of whose fibers are local complete intersections. we discuss general local complete intersection ring maps in more on algebra, section \ref{more-algebra-section-lci}. \begin{definition} \label{definition-lci} a ring map $r \to s$ is called {\it syntomic}, or we say $s$ is a {\it flat local complete intersection over $r$} if it is flat, of finite presentation, and if all of its fibre rings $s \otimes_r \kappa(\mathfrak p)$ are local complete intersections, see definition \ref{definition-lci-field}. \end{definition} \noindent clearly, an algebra over a field is syntomic over the field if and only if it is a local complete intersection. here is a pleasing feature of this definition. \begin{lemma} \label{lemma-syntomic-descends} \begin{slogan} being syntomic is fpqc local on the base. \end{slogan} let $r \to s$ be a ring map. let $r \to r'$ be a faithfully flat ring map. set $s' = r'\otimes_r s$. then $r \to s$ is syntomic if and only if $r' \to s'$ is syntomic. \end{lemma} \begin{proof} by lemma \ref{lemma-finite-presentation-descends} and lemma \ref{lemma-flatness-descends} this holds for the property of being flat and for the property of being of finite presentation. the map $\spec(r') \to \spec(r)$ is surjective, see lemma \ref{lemma-ff-rings}. thus it suffices to show given primes $\mathfrak p' \subset r'$ lying over $\mathfrak p \subset r$ that $s \otimes_r \kappa(\mathfrak p)$ is a local complete intersection if and only if $s' \otimes_{r'} \kappa(\mathfrak p')$ is a local complete intersection. note that $s' \otimes_{r'} \kappa(\mathfrak p') = s \otimes_r \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')$. thus lemma \ref{lemma-lci-field-change} applies. \end{proof} \begin{lemma} \label{lemma-base-change-syntomic} any base change of a syntomic map is syntomic. \end{lemma} \begin{proof} this is true for being flat, for being of finite presentation, and for having local complete intersections as fibres by lemmas \ref{lemma-flat-base-change}, \ref{lemma-compose-finite-type} and \ref{lemma-lci-field-change}. \end{proof} \begin{lemma} \label{lemma-local-syntomic} let $r \to s$ be a ring map. suppose we have $g_1, \ldots g_m \in s$ which generate the unit ideal such that each $r \to s_{g_i}$ is syntomic. then $r \to s$ is syntomic. \end{lemma} \begin{proof} this is true for being flat and for being of finite presentation by lemmas \ref{lemma-flat-localization} and \ref{lemma-cover-upstairs}. the property of having fibre rings which are local complete intersections is local on $s$ by its very definition, see definition \ref{definition-lci-field}. \end{proof} \begin{definition} \label{definition-relative-global-complete-intersection} let $r \to s$ be a ring map. we say that $r \to s$ is a {\it relative global complete intersection} if there exists a presentation $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ and every nonempty fibre of $\spec(s) \to \spec(r)$ has dimension $n - c$. we will say ``let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection'' to indicate this situation. \end{definition} \noindent the following lemma is occasionally useful to find global presentations. \begin{lemma} \label{lemma-huber} let $s$ be a finitely presented $r$-algebra which has a presentation $s = r[x_1, \ldots, x_n]/i$ such that $i/i^2$ is free over $s$. then $s$ has a presentation $s = r[y_1, \ldots, y_m]/(f_1, \ldots, f_c)$ such that $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free with basis given by the classes of $f_1, \ldots, f_c$. \end{lemma} \begin{proof} note that $i$ is a finitely generated ideal by lemma \ref{lemma-finite-presentation-independent}. let $f_1, \ldots, f_c \in i$ be elements which map to a basis of $i/i^2$. by nakayama's lemma (lemma \ref{lemma-nak}) there exists a $g \in 1 + i$ such that $$ g \cdot i \subset (f_1, \ldots, f_c) $$ and $i_g \cong (f_1, \ldots, f_c)_g$. hence we see that $$ s \cong r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)[1/g] \cong r[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, gx_{n + 1} - 1) $$ as desired. it follows that $f_1, \ldots, f_c,gx_{n + 1} - 1$ form a basis for $(f_1, \ldots, f_c, gx_{n + 1} - 1)/(f_1, \ldots, f_c, gx_{n + 1} - 1)^2$ for example by applying lemma \ref{lemma-principal-localization-nl}. \end{proof} \begin{example} \label{example-factor-polynomials} let $n , m \geq 1$ be integers. consider the ring map \begin{eqnarray*} r = \mathbf{z}[a_1, \ldots, a_{n + m}] & \longrightarrow & s = \mathbf{z}[b_1, \ldots, b_n, c_1, \ldots, c_m] \\ a_1 & \longmapsto & b_1 + c_1 \\ a_2 & \longmapsto & b_2 + b_1 c_1 + c_2 \\ \ldots & \ldots & \ldots \\ a_{n + m} & \longmapsto & b_n c_m \end{eqnarray*} in other words, this is the unique ring map of polynomial rings as indicated such that the polynomial factorization $$ x^{n + m} + a_1 x^{n + m - 1} + \ldots + a_{n + m} = (x^n + b_1 x^{n - 1} + \ldots + b_n) (x^m + c_1 x^{m - 1} + \ldots + c_m) $$ holds. note that $s$ is generated by $n + m$ elements over $r$ (namely, $b_i, c_j$) and that there are $n + m$ equations (namely $a_k = a_k(b_i, c_j)$). in order to show that $s$ is a relative global complete intersection over $r$ it suffices to prove that all fibres have dimension $0$. \medskip\noindent to prove this, let $r \to k$ be a ring map into a field $k$. say $a_i$ maps to $\alpha_i \in k$. consider the fibre ring $s_k = k \otimes_r s$. let $k \to k$ be a field extension. a $k$-algebra map of $s_k \to k$ is the same thing as finding $\beta_1, \ldots, \beta_n, \gamma_1, \ldots, \gamma_m \in k$ such that $$ x^{n + m} + \alpha_1 x^{n + m - 1} + \ldots + \alpha_{n + m} = (x^n + \beta_1 x^{n - 1} + \ldots + \beta_n) (x^m + \gamma_1 x^{m - 1} + \ldots + \gamma_m). $$ hence we see there are at most finitely many choices of such $n + m$-tuples in $k$. this proves that all fibres have finitely many closed points (use hilbert's nullstellensatz to see they all correspond to solutions in $\overline{k}$ for example) and hence that $r \to s$ is a relative global complete intersection. \medskip\noindent another way to argue this is to show $\mathbf{z}[a_1, \ldots, a_{n + m}] \to \mathbf{z}[b_1, \ldots, b_n, c_1, \ldots, c_m]$ is actually also a {\it finite} ring map. namely, by lemma \ref{lemma-polynomials-divide} each of $b_i, c_j$ is integral over $r$, and hence $r \to s$ is finite by lemma \ref{lemma-characterize-integral}. \end{example} \begin{example} \label{example-roots-universal-polynomial} consider the ring map \begin{eqnarray*} r = \mathbf{z}[a_1, \ldots, a_n] & \longrightarrow & s = \mathbf{z}[\alpha_1, \ldots, \alpha_n] \\ a_1 & \longmapsto & \alpha_1 + \ldots + \alpha_n \\ \ldots & \ldots & \ldots \\ a_n & \longmapsto & \alpha_1 \ldots \alpha_n \end{eqnarray*} in other words this is the unique ring map of polynomial rings as indicated such that $$ x^n + a_1 x^{n - 1} + \ldots + a_n = \prod\nolimits_{i = 1}^n (x + \alpha_i) $$ holds in $\mathbf{z}[\alpha_i, x]$. another way to say this is that $a_i$ maps to the $i$th elementary symmetric function in $\alpha_1, \ldots, \alpha_n$. by the usual theory of elementary symmetric polynomials (details omitted) the ring $s$ is finite free over $r$ with basis the elements $\alpha_1^{e_1} \alpha_2^{e_2} \ldots \alpha_n^{e_n}$ with $0 \leq e_i \leq n - i$. a fortiori, the fibre rings of $r \to s$ are finite and hence have dimension $0$. on the other hand, $s$ is generated by $n$ elements over $r$ subject to $n$ equations. hence $s$ is a relative global complete intersection over $r$. since the rank of $s$ over $r$ is positive, we also see that $s$ is faithfully flat over $r$. \end{example} \begin{lemma} \label{lemma-base-change-relative-global-complete-intersection} let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection (definition \ref{definition-relative-global-complete-intersection}) \begin{enumerate} \item for any $r \to r'$ the base change $r' \otimes_r s = r'[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative global complete intersection. \item for any $g \in s$ which is the image of $h \in r[x_1, \ldots, x_n]$ the ring $s_g = r[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1)$ is a relative global complete intersection. \item if $r \to s$ factors as $r \to r_f \to s$ for some $f \in r$. then the ring $s = r_f[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative global complete intersection over $r_f$. \end{enumerate} \end{lemma} \begin{proof} by lemma \ref{lemma-dimension-preserved-field-extension} the fibres of a base change have the same dimension as the fibres of the original map. moreover $r' \otimes_r r[x_1, \ldots, x_n]/(f_1, \ldots, f_c) = r'[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. thus (1) follows. the proof of (2) is that the localization at one element can be described as $s_g \cong s[x_{n + 1}]/(gx_{n + 1} - 1)$. assertion (3) follows from (1) since under the assumptions of (3) we have $r_f \otimes_r s \cong s$. \end{proof} \begin{lemma} \label{lemma-localize-relative-complete-intersection} let $r$ be a ring. let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. we will find $h \in r[x_1, \ldots, x_n]$ which maps to $g \in s$ such that $$ s_g = r[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1) $$ is a relative global complete intersection with a presentation as in definition \ref{definition-relative-global-complete-intersection} in each of the following cases: \begin{enumerate} \item let $i \subset r$ be an ideal. if the fibres of $\spec(s/is) \to \spec(r/i)$ have dimension $n - c$, then we can find $(h, g)$ as above such that $g$ maps to $1 \in s/is$. \item let $\mathfrak p \subset r$ be a prime. if $\dim(s \otimes_r \kappa(\mathfrak p)) = n - c$, then we can find $(h, g)$ as above such that $g$ maps to a unit of $s \otimes_r \kappa(\mathfrak p)$. \item let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$. if $\dim_{\mathfrak q}(s/r) = n - c$, then we can find $(h, g)$ as above such that $g \not \in \mathfrak q$. \end{enumerate} \end{lemma} \begin{proof} ad (1). by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs} there exists an open subset $w \subset \spec(s)$ containing $v(is)$ such that all fibres of $w \to \spec(r)$ have dimension $\leq n - c$. say $w = \spec(s) \setminus v(j)$. then $v(j) \cap v(is) = \emptyset$ hence we can find a $g \in j$ which maps to $1 \in s/is$. let $h \in r[x_1, \ldots, x_n]$ be any preimage of $g$. \medskip\noindent ad (2). by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs} there exists an open subset $w \subset \spec(s)$ containing $\spec(s \otimes_r \kappa(\mathfrak p))$ such that all fibres of $w \to \spec(r)$ have dimension $\leq n - c$. say $w = \spec(s) \setminus v(j)$. then $v(j \cdot s \otimes_r \kappa(\mathfrak p)) = \emptyset$. hence we can find a $g \in j$ which maps to a unit in $s \otimes_r \kappa(\mathfrak p)$ (details omitted). let $h \in r[x_1, \ldots, x_n]$ be any preimage of $g$. \medskip\noindent ad (3). by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs} there exists a $g \in s$, $g \not \in \mathfrak q$ such that all nonempty fibres of $r \to s_g$ have dimension $\leq n - c$. let $h \in r[x_1, \ldots, x_n]$ be any element that maps to $g$. \end{proof} \noindent the following lemma says we can do absolute noetherian approximation for relative global complete intersections. \begin{lemma} \label{lemma-relative-global-complete-intersection-noetherian} let $r$ be a ring. let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection (definition \ref{definition-relative-global-complete-intersection}). there exist a finite type $\mathbf{z}$-subalgebra $r_0 \subset r$ such that $f_i \in r_0[x_1, \ldots, x_n]$ and such that $$ s_0 = r_0[x_1, \ldots, x_n]/(f_1, \ldots, f_c) $$ is a relative global complete intersection. \end{lemma} \begin{proof} let $r_0 \subset r$ be the $\mathbf{z}$-algebra of $r$ generated by all the coefficients of the polynomials $f_1, \ldots, f_c$. let $s_0 = r_0[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. clearly, $s = r \otimes_{r_0} s_0$. pick a prime $\mathfrak q \subset s$ and denote $\mathfrak p \subset r$, $\mathfrak q_0 \subset s_0$, and $\mathfrak p_0 \subset r_0$ the primes it lies over. because $\dim (s \otimes_r \kappa(\mathfrak p) ) = n - c$ we also have $\dim (s_0 \otimes_{r_0} \kappa(\mathfrak p_0)) = n - c$, see lemma \ref{lemma-dimension-preserved-field-extension}. by lemma \ref{lemma-dimension-fibres-bounded-open-upstairs} there exists a $g \in s_0$, $g \not \in \mathfrak q_0$ such that all nonempty fibres of $r_0 \to (s_0)_g$ have dimension $\leq n - c$. as $\mathfrak q$ was arbitrary and $\spec(s)$ quasi-compact, we can find finitely many $g_1, \ldots, g_m \in s_0$ such that (a) for $j = 1, \ldots, m$ the nonempty fibres of $r_0 \to (s_0)_{g_j}$ have dimension $\leq n - c$ and (b) the image of $\spec(s) \to \spec(s_0)$ is contained in $d(g_1) \cup \ldots \cup d(g_m)$. in other words, the images of $g_1, \ldots, g_m$ in $s = r \otimes_{r_0} s_0$ generate the unit ideal. after increasing $r_0$ we may assume that $g_1, \ldots, g_m$ generate the unit ideal in $s_0$. by (a) the nonempty fibres of $r_0 \to s_0$ all have dimension $\leq n - c$ and we conclude. \end{proof} \begin{lemma} \label{lemma-relative-global-complete-intersection-conormal} let $r$ be a ring. let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection (definition \ref{definition-relative-global-complete-intersection}). for every prime $\mathfrak q$ of $s$, let $\mathfrak q'$ denote the corresponding prime of $r[x_1, \ldots, x_n]$. then \begin{enumerate} \item $f_1, \ldots, f_c$ is a regular sequence in the local ring $r[x_1, \ldots, x_n]_{\mathfrak q'}$, \item each of the rings $r[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i)$ is flat over $r$, and \item the $s$-module $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free with basis given by the elements $f_i \bmod (f_1, \ldots, f_c)^2$. \end{enumerate} \end{lemma} \begin{proof} assume $r$ is noetherian. let $\mathfrak p = r \cap \mathfrak q'$. by lemma \ref{lemma-lci} for example we see that $f_1, \ldots, f_c$ form a regular sequence in the local ring $r[x_1, \ldots, x_n]_{\mathfrak q'} \otimes_r \kappa(\mathfrak p)$. moreover, the local ring $r[x_1, \ldots, x_n]_{\mathfrak q'}$ is flat over $r_{\mathfrak p}$. since $r$, and hence $r[x_1, \ldots, x_n]_{\mathfrak q'}$ is noetherian we see from lemma \ref{lemma-grothendieck-regular-sequence} that (1) and (2) hold. \medskip\noindent let $r$ be general. write $r = \colim_{\lambda \in \lambda} r_\lambda$ as the filtered colimit of finite type $\mathbf{z}$-subalgebras (compare with section \ref{section-colimits-flat}). we may assume that $f_1, \ldots, f_c \in r_\lambda[x_1, \ldots, x_n]$ for all $\lambda$. let $r_0 \subset r$ be as in lemma \ref{lemma-relative-global-complete-intersection-noetherian}. then we may assume $r_0 \subset r_\lambda$ for all $\lambda$. it follows that $s_\lambda = r_\lambda[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative global complete intersection (as base change of $s_0$ via $r_0 \to r_\lambda$, see lemma \ref{lemma-base-change-relative-global-complete-intersection}). denote $\mathfrak p_\lambda$, $\mathfrak q_\lambda$, $\mathfrak q'_\lambda$ the prime of $r_\lambda$, $s_\lambda$, $r_\lambda[x_1, \ldots, x_n]$ induced by $\mathfrak p$, $\mathfrak q$, $\mathfrak q'$. with this notation, we have (1) and (2) for each $\lambda$. since $$ r[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i) = \colim r_\lambda[x_1, \ldots, x_n]_{\mathfrak q_\lambda'}/(f_1, \ldots, f_i) $$ we deduce flatness in (2) over $r$ from lemma \ref{lemma-colimit-rings-flat}. since we have \begin{align*} r[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i) \xrightarrow{f_{i + 1}} r[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i) \\ = \colim \left( r_\lambda[x_1, \ldots, x_n]_{\mathfrak q_\lambda'}/(f_1, \ldots, f_i) \xrightarrow{f_{i + 1}} r_\lambda[x_1, \ldots, x_n]_{\mathfrak q_\lambda'}/(f_1, \ldots, f_i) \right) \end{align*} and since filtered colimits are exact (lemma \ref{lemma-directed-colimit-exact}) we conclude that we have (1). \medskip\noindent proof of (3). denote $n$ the $s$-module $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ and $e_i \in n$ the image of $f_i$. by lemma \ref{lemma-regular-quasi-regular} and (1) we know that $e_1, \ldots, e_c$ is a basis of $n_\mathfrak q$ for all primes $\mathfrak q$ of $s$. by lemma \ref{lemma-characterize-zero-local} we conclude that (3) is true. \end{proof} \begin{lemma} \label{lemma-relative-global-complete-intersection} a relative global complete intersection is syntomic, i.e., flat. \end{lemma} \begin{proof} let $r \to s$ be a relative global complete intersection. the fibres are global complete intersections, and $s$ is of finite presentation over $r$. thus the only thing to prove is that $r \to s$ is flat. this is true by (2) of lemma \ref{lemma-relative-global-complete-intersection-conormal}. \end{proof} \begin{lemma} \label{lemma-adjoin-roots} suppose that $a$ is a ring, and $p(x) = x^n + b_1 x^{n-1} + \ldots + b_n \in a[x]$ is a monic polynomial over $a$. then there exists a syntomic, finite free, faithfully flat ring extension $a \subset a'$ such that $p(x) = \prod_{i = 1, \ldots, n} (x - \beta_i)$ for certain $\beta_i \in a'$. \end{lemma} \begin{proof} take $a' = a \otimes_r s$, where $r$ and $s$ are as in example \ref{example-roots-universal-polynomial}, where $r \to a$ maps $a_i$ to $b_i$, and let $\beta_i = -1 \otimes \alpha_i$. observe that $r \to s$ is faithfully flat and finite free and syntomic by lemma \ref{lemma-relative-global-complete-intersection}. these properties are inherited by the base change $a \to a'$; some details omitted. \end{proof} \begin{lemma} \label{lemma-syntomic} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over the prime $\mathfrak p$ of $r$. the following are equivalent: \begin{enumerate} \item there exists an element $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is syntomic. \item there exists an element $g \in s$, $g \not \in \mathfrak q$ such that $s_g$ is a relative global complete intersection over $r$. \item there exists an element $g \in s$, $g \not \in \mathfrak q$, such that $r \to s_g$ is of finite presentation, the local ring map $r_{\mathfrak p} \to s_{\mathfrak q}$ is flat, and the local ring $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ is a complete intersection ring over $\kappa(\mathfrak p)$ (see definition \ref{definition-lci-local-ring}). \end{enumerate} \end{lemma} \begin{proof} the implication (1) $\rightarrow$ (3) is lemma \ref{lemma-lci-at-prime}. the implication (2) $\rightarrow$ (1) is lemma \ref{lemma-relative-global-complete-intersection}. it remains to show that (3) implies (2). \medskip\noindent assume (3). after replacing $s$ by $s_g$ for some $g \in s$, $g\not\in \mathfrak q$ we may assume $s$ is finitely presented over $r$. choose a presentation $s = r[x_1, \ldots, x_n]/i$. let $\mathfrak q' \subset r[x_1, \ldots, x_n]$ be the prime corresponding to $\mathfrak q$. write $\kappa(\mathfrak p) = k$. note that $s \otimes_r k = k[x_1, \ldots, x_n]/\overline{i}$ where $\overline{i} \subset k[x_1, \ldots, x_n]$ is the ideal generated by the image of $i$. let $\overline{\mathfrak q}' \subset k[x_1, \ldots, x_n]$ be the prime ideal generated by the image of $\mathfrak q'$. by lemma \ref{lemma-lci-at-prime} the equivalent conditions of lemma \ref{lemma-lci} hold for $\overline{i}$ and $\overline{\mathfrak q}'$. say the dimension of $\overline{i}_{\overline{\mathfrak q}'}/ \overline{\mathfrak q}'\overline{i}_{\overline{\mathfrak q}'}$ over $\kappa(\overline{\mathfrak q}')$ is $c$. pick $f_1, \ldots, f_c \in i$ mapping to a basis of this vector space. the images $\overline{f}_j \in \overline{i}$ generate $\overline{i}_{\overline{\mathfrak q}'}$ (by lemma \ref{lemma-lci}). set $s' = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. let $j$ be the kernel of the surjection $s' \to s$. since $s$ is of finite presentation $j$ is a finitely generated ideal (lemma \ref{lemma-compose-finite-type}). consider the short exact sequence $$ 0 \to j \to s' \to s \to 0 $$ as $s_\mathfrak q$ is flat over $r$ we see that $j_{\mathfrak q'} \otimes_r k \to s'_{\mathfrak q'} \otimes_r k$ is injective (lemma \ref{lemma-flat-tor-zero}). however, by construction $s'_{\mathfrak q'} \otimes_r k$ maps isomorphically to $s_\mathfrak q \otimes_r k$. hence we conclude that $j_{\mathfrak q'} \otimes_r k = j_{\mathfrak q'}/\mathfrak pj_{\mathfrak q'} = 0$. by nakayama's lemma (lemma \ref{lemma-nak}) we conclude that there exists a $g \in r[x_1, \ldots, x_n]$, $g \not \in \mathfrak q'$ such that $j_g = 0$. in other words $s'_g \cong s_g$. after further localizing we see that $s'$ (and hence $s$) becomes a relative global complete intersection by lemma \ref{lemma-localize-relative-complete-intersection} as desired. \end{proof} \begin{lemma} \label{lemma-syntomic-presentation-ideal-mod-squares} let $r$ be a ring. let $s = r[x_1, \ldots, x_n]/i$ for some finitely generated ideal $i$. if $g \in s$ is such that $s_g$ is syntomic over $r$, then $(i/i^2)_g$ is a finite projective $s_g$-module. \end{lemma} \begin{proof} by lemma \ref{lemma-syntomic} there exist finitely many elements $g_1, \ldots, g_m \in s$ which generate the unit ideal in $s_g$ such that each $s_{gg_j}$ is a relative global complete intersection over $r$. since it suffices to prove that $(i/i^2)_{gg_j}$ is finite projective, see lemma \ref{lemma-finite-projective}, we may assume that $s_g$ is a relative global complete intersection. in this case the result follows from lemmas \ref{lemma-conormal-module-localize} and \ref{lemma-relative-global-complete-intersection-conormal}. \end{proof} \begin{lemma} \label{lemma-composition-syntomic} let $r \to s$, $s \to s'$ be ring maps. \begin{enumerate} \item if $r \to s$ and $s \to s'$ are syntomic, then $r \to s'$ is syntomic. \item if $r \to s$ and $s \to s'$ are relative global complete intersections, then $r \to s'$ is a relative global complete intersection. \end{enumerate} \end{lemma} \begin{proof} proof of (2). say $r \to s$ and $s \to s'$ are relative global complete intersections and we have presentations $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ and $s' = s[y_1, \ldots, y_m]/(h_1, \ldots, h_d)$ as in definition \ref{definition-relative-global-complete-intersection}. then $$ s' \cong r[x_1, \ldots, x_n, y_1, \ldots, y_m]/(f_1, \ldots, f_c, h'_1, \ldots, h'_d) $$ for some lifts $h_j' \in r[x_1, \ldots, x_n, y_1, \ldots, y_m]$ of the $h_j$. hence it suffices to bound the dimensions of the fibre rings. thus we may assume $r = k$ is a field. in this case we see that we have a ring, namely $s$, which is of finite type over $k$ and equidimensional of dimension $n - c$, and a finite type ring map $s \to s'$ all of whose nonempty fibre rings are equidimensional of dimension $m - d$. then, by lemma \ref{lemma-dimension-base-fibre-total} for example applied to localizations at maximal ideals of $s'$, we see that $\dim(s') \leq n - c + m - d$ as desired. \medskip\noindent we will reduce part (1) to part (2). assume $r \to s$ and $s \to s'$ are syntomic. let $\mathfrak q' \subset s$ be a prime ideal lying over $\mathfrak q \subset s$. by lemma \ref{lemma-syntomic} there exists a $g' \in s'$, $g' \not \in \mathfrak q'$ such that $s \to s'_{g'}$ is a relative global complete intersection. similarly, we find $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is a relative global complete intersection. by lemma \ref{lemma-base-change-relative-global-complete-intersection} the ring map $s_g \to s_{gg'}$ is a relative global complete intersection. by part (2) we see that $r \to s_{gg'}$ is a relative global complete intersection and $gg' \not \in \mathfrak q'$. since $\mathfrak q'$ was arbitrary combining lemmas \ref{lemma-syntomic} and \ref{lemma-local-syntomic} we see that $r \to s'$ is syntomic (this also uses that the spectrum of $s'$ is quasi-compact, see lemma \ref{lemma-quasi-compact}). \end{proof} \noindent the following lemma will be improved later, see smoothing ring maps, proposition \ref{smoothing-proposition-lift-smooth}. \begin{lemma} \label{lemma-lift-syntomic} let $r$ be a ring and let $i \subset r$ be an ideal. let $r/i \to \overline{s}$ be a syntomic map. then there exists elements $\overline{g}_i \in \overline{s}$ which generate the unit ideal of $\overline{s}$ such that each $\overline{s}_{g_i} \cong s_i/is_i$ for some relative global complete intersection $s_i$ over $r$. \end{lemma} \begin{proof} by lemma \ref{lemma-syntomic} we find a collection of elements $\overline{g}_i \in \overline{s}$ which generate the unit ideal of $\overline{s}$ such that each $\overline{s}_{g_i}$ is a relative global complete intersection over $r/i$. hence we may assume that $\overline{s}$ is a relative global complete intersection. write $\overline{s} = (r/i)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_c)$ as in definition \ref{definition-relative-global-complete-intersection}. choose $f_1, \ldots, f_c \in r[x_1, \ldots, x_n]$ lifting $\overline{f}_1, \ldots, \overline{f}_c$. set $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. note that $s/is \cong \overline{s}$. by lemma \ref{lemma-localize-relative-complete-intersection} we can find $g \in s$ mapping to $1$ in $\overline{s}$ such that $s_g$ is a relative global complete intersection over $r$. since $\overline{s} \cong s_g/is_g$ this finishes the proof. \end{proof} \section{smooth ring maps} \label{section-smooth} \noindent let us motivate the definition of a smooth ring map by an example. suppose $r$ is a ring and $s = r[x, y]/(f)$ for some nonzero $f \in r[x, y]$. in this case there is an exact sequence $$ s \to s\text{d}x \oplus s\text{d}y \to \omega_{s/r} \to 0 $$ where the first arrow maps $1$ to $\frac{\partial f}{\partial x} \text{d}x + \frac{\partial f}{\partial y} \text{d}y$ see section \ref{section-netherlander}. we conclude that $\omega_{s/r}$ is locally free of rank $1$ if the partial derivatives of $f$ generate the unit ideal in $s$. in this case $s$ is smooth of relative dimension $1$ over $r$. but it can happen that $\omega_{s/r}$ is locally free of rank $2$ namely if both partial derivatives of $f$ are zero. for example if for a prime $p$ we have $p = 0$ in $r$ and $f = x^p + y^p$ then this happens. here $r \to s$ is a relative global complete intersection of relative dimension $1$ which is not smooth. hence, in order to check that a ring map is smooth it is not sufficient to check whether the module of differentials is free. the correct condition is the following. \begin{definition} \label{definition-smooth} a ring map $r \to s$ is {\it smooth} if it is of finite presentation and the naive cotangent complex $\nl_{s/r}$ is quasi-isomorphic to a finite projective $s$-module placed in degree $0$: this means that $h_1(\nl_{s/r}) = 0$ and that $\omega_{s/r}$ is a finite projective $s$-module. \end{definition} \noindent let $r \to s$ be a ring map. by lemma \ref{lemma-nl-homotopy} for any presentation $\alpha : p \to s$ we have $h_1(\nl(\alpha)) = h_1(\nl_{s/r})$ and $h_0(\nl(\alpha)) = \omega_{s/r}$. thus, if $r \to s$ is smooth, then for any surjection $\alpha : r[x_1, \ldots, x_n] \to s$ with kernel $i$ the map $$ i/i^2 \longrightarrow \omega_{r[x_1, \ldots, x_n]/r} \otimes_{r[x_1, \ldots, x_n]} s $$ is an injective map whose cokernel is a finite projective $s$-module. thus the displayed arrow is a split injection. in other words $\bigoplus_{i = 1}^n s \text{d}x_i \cong i/i^2 \oplus \omega_{s/r}$ as $s$-modules and $i/i^2$ is a finite projective $s$-module as well. conversely, if $r \to s$ is of finite presentation and we have a surjection $\alpha : r[x_1, \ldots, x_n] \to s$ with kernel $i$ such that the displayed arrow is a split injection, then $r \to s$ is smooth. \begin{lemma} \label{lemma-localize-smooth} let $r \to s$ be a smooth ring map. any localization $s_g$ is smooth over $r$. if $f \in r$ maps to an invertible element of $s$, then $r_f \to s$ is smooth. \end{lemma} \begin{proof} by lemma \ref{lemma-localize-nl} the naive cotangent complex for $s_g$ over $r$ is the base change of the naive cotangent complex of $s$ over $r$. the assumption is that the naive cotangent complex of $s/r$ is $\omega_{s/r}$ and that this is a finite projective $s$-module. hence so is its base change. thus $s_g$ is smooth over $r$. \medskip\noindent the second assertion follows in the same way from lemma \ref{lemma-nl-localize-bottom}. \end{proof} \begin{lemma} \label{lemma-base-change-smooth} \begin{slogan} smoothness is preserved under base change \end{slogan} let $r \to s$ be a smooth ring map. let $r \to r'$ be any ring map. then the base change $r' \to s' = r' \otimes_r s$ is smooth. \end{lemma} \begin{proof} let $\alpha : r[x_1, \ldots, x_n] \to s$ be a presentation with kernel $i$. let $\alpha' : r'[x_1, \ldots, x_n] \to r' \otimes_r s$ be the induced presentation. let $i' = \ker(\alpha')$. since $0 \to i \to r[x_1, \ldots, x_n] \to s \to 0$ is exact, the sequence $r' \otimes_r i \to r'[x_1, \ldots, x_n] \to r' \otimes_r s \to 0$ is exact. thus $r' \otimes_r i \to i'$ is surjective. by definition \ref{definition-smooth} there is a short exact sequence $$ 0 \to i/i^2 \to \omega_{r[x_1, \ldots, x_n]/r} \otimes_{r[x_1, \ldots, x_n]} s \to \omega_{s/r} \to 0 $$ and the $s$-module $\omega_{s/r}$ is finite projective. in particular $i/i^2$ is a direct summand of $\omega_{r[x_1, \ldots, x_n]/r} \otimes_{r[x_1, \ldots, x_n]} s$. consider the commutative diagram $$ \xymatrix{ r' \otimes_r (i/i^2) \ar[r] \ar[d] & r' \otimes_r (\omega_{r[x_1, \ldots, x_n]/r} \otimes_{r[x_1, \ldots, x_n]} s) \ar[d] \\ i'/(i')^2 \ar[r] & \omega_{r'[x_1, \ldots, x_n]/r'} \otimes_{r'[x_1, \ldots, x_n]} (r' \otimes_r s) } $$ since the right vertical map is an isomorphism we see that the left vertical map is injective and surjective by what was said above. thus we conclude that $\nl(\alpha')$ is quasi-isomorphic to $\omega_{s'/r'} \cong s' \otimes_s \omega_{s/r}$ placed in degree $0$. this module is finite projective since it is the base change of a finite projective module. \end{proof} \begin{lemma} \label{lemma-smooth-over-field} let $k$ be a field. let $s$ be a smooth $k$-algebra. then $s$ is a local complete intersection. \end{lemma} \begin{proof} by lemmas \ref{lemma-base-change-smooth} and \ref{lemma-lci-field-change} it suffices to prove this when $k$ is algebraically closed. choose a presentation $\alpha : k[x_1, \ldots, x_n] \to s$ with kernel $i$. let $\mathfrak m$ be a maximal ideal of $s$, and let $\mathfrak m' \supset i$ be the corresponding maximal ideal of $k[x_1, \ldots, x_n]$. we will show that condition (5) of lemma \ref{lemma-lci} holds (with $\mathfrak m$ instead of $\mathfrak q$). we may write $\mathfrak m' = (x_1 - a_1, \ldots, x_n - a_n)$ for some $a_i \in k$, because $k$ is algebraically closed, see theorem \ref{theorem-nullstellensatz}. by our assumption that $k \to s$ is smooth the $s$-module map $\text{d} : i/i^2 \to \bigoplus_{i = 1}^n s \text{d}x_i$ is a split injection. hence the corresponding map $i/\mathfrak m' i \to \bigoplus \kappa(\mathfrak m') \text{d}x_i$ is injective. say $\dim_{\kappa(\mathfrak m')}(i/\mathfrak m' i) = c$ and pick $f_1, \ldots, f_c \in i$ which map to a $\kappa(\mathfrak m')$-basis of $i/\mathfrak m' i$. by nakayama's lemma \ref{lemma-nak} we see that $f_1, \ldots, f_c$ generate $i_{\mathfrak m'}$ over $k[x_1, \ldots, x_n]_{\mathfrak m'}$. consider the commutative diagram $$ \xymatrix{ i \ar[r] \ar[d] & i/i^2 \ar[rr] \ar[d] & & i/\mathfrak m'i \ar[d] \\ \omega_{k[x_1, \ldots, x_n]/k} \ar[r] & \bigoplus s\text{d}x_i \ar[rr]^{\text{d}x_i \mapsto x_i - a_i} & & \mathfrak m'/(\mathfrak m')^2 } $$ (proof commutativity omitted). the middle vertical map is the one defining the naive cotangent complex of $\alpha$. note that the right lower horizontal arrow induces an isomorphism $\bigoplus \kappa(\mathfrak m') \text{d}x_i \to \mathfrak m'/(\mathfrak m')^2$. hence our generators $f_1, \ldots, f_c$ of $i_{\mathfrak m'}$ map to a collection of elements in $k[x_1, \ldots, x_n]_{\mathfrak m'}$ whose classes in $\mathfrak m'/(\mathfrak m')^2$ are linearly independent over $\kappa(\mathfrak m')$. therefore they form a regular sequence in the ring $k[x_1, \ldots, x_n]_{\mathfrak m'}$ by lemma \ref{lemma-regular-ring-cm}. this verifies condition (5) of lemma \ref{lemma-lci} hence $s_g$ is a global complete intersection over $k$ for some $g \in s$, $g \not \in \mathfrak m$. as this works for any maximal ideal of $s$ we conclude that $s$ is a local complete intersection over $k$. \end{proof} \begin{definition} \label{definition-standard-smooth} let $r$ be a ring. given integers $n \geq c \geq 0$ and $f_1, \ldots, f_c \in r[x_1, \ldots, x_n]$ we say $$ r[x_1, \ldots, x_n]/(f_1, \ldots, f_c) $$ is a {\it standard smooth algebra over $r$} if the polynomial $$ g = \det \left( \begin{matrix} \partial f_1/\partial x_1 & \partial f_2/\partial x_1 & \ldots & \partial f_c/\partial x_1 \\ \partial f_1/\partial x_2 & \partial f_2/\partial x_2 & \ldots & \partial f_c/\partial x_2 \\ \ldots & \ldots & \ldots & \ldots \\ \partial f_1/\partial x_c & \partial f_2/\partial x_c & \ldots & \partial f_c/\partial x_c \end{matrix} \right) $$ maps to an invertible element in $r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. we say an $r$-algebra $s$ is {\it standard smooth} or that the ring map $r \to s$ is {\it standard smooth} if there exist $n \geq c \geq 0$ and $f_1, \ldots, f_c \in r[x_1, \ldots, x_n]$ such that $r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a standard smooth algebra over $r$ and $s$ is isomorphic to $r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ as an $r$-algebra. \end{definition} \begin{lemma} \label{lemma-standard-smooth} let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c) = r[x_1, \ldots, x_n]/i$ be a standard smooth algebra. then \begin{enumerate} \item the ring map $r \to s$ is smooth, \item the $s$-module $\omega_{s/r}$ is free on $\text{d}x_{c + 1}, \ldots, \text{d}x_n$, \item the $s$-module $i/i^2$ is free on the classes of $f_1, \ldots, f_c$, \item for any $g \in s$ the ring map $r \to s_g$ is standard smooth, \item for any ring map $r \to r'$ the base change $r' \to r'\otimes_r s$ is standard smooth, \item if $f \in r$ maps to an invertible element in $s$, then $r_f \to s$ is standard smooth, and \item the ring $s$ is a relative global complete intersection over $r$. \end{enumerate} \end{lemma} \begin{proof} consider the naive cotangent complex of the given presentation $$ (f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2 \longrightarrow \bigoplus\nolimits_{i = 1}^n s \text{d}x_i $$ let us compose this map with the projection onto the first $c$ direct summands of the direct sum. according to the definition of a standard smooth algebra the classes $f_i \bmod (f_1, \ldots, f_c)^2$ map to a basis of $\bigoplus_{i = 1}^c s\text{d}x_i$. we conclude that $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free of rank $c$ with a basis given by the elements $f_i \bmod (f_1, \ldots, f_c)^2$, and that the homology in degree $0$, i.e., $\omega_{s/r}$, of the naive cotangent complex is a free $s$-module with basis the images of $\text{d}x_{c + j}$, $j = 1, \ldots, n - c$. in particular, this proves $r \to s$ is smooth. \medskip\noindent the proofs of (4) and (6) are omitted. but see the example below and the proof of lemma \ref{lemma-base-change-relative-global-complete-intersection}. \medskip\noindent let $\varphi : r \to r'$ be any ring map. denote $s' = r'[x_1, \ldots, x_n]/(f_1^\varphi, \ldots, f_c^\varphi)$ where $f^\varphi$ is the polynomial obtained from $f \in r[x_1, \ldots, x_n]$ by applying $\varphi$ to all the coefficients. then $s' \cong r' \otimes_r s$. moreover, the determinant of definition \ref{definition-standard-smooth} for $s'/r'$ is equal to $g^\varphi$. its image in $s'$ is therefore the image of $g$ via $r[x_1, \ldots, x_n] \to s \to s'$ and hence invertible. this proves (5). \medskip\noindent to prove (7) it suffices to show that $s \otimes_r \kappa(\mathfrak p)$ has dimension $n - c$ for every prime $\mathfrak p \subset r$. by (5) it suffices to prove that any standard smooth algebra $k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ over a field $k$ has dimension $n - c$. we already know that $k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a local complete intersection by lemma \ref{lemma-smooth-over-field}. hence, since $i/i^2$ is free of rank $c$ we see that $k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ has dimension $n - c$, by lemma \ref{lemma-lci} for example. \end{proof} \begin{example} \label{example-make-standard-smooth} let $r$ be a ring. let $f_1, \ldots, f_c \in r[x_1, \ldots, x_n]$. let $$ h = \det \left( \begin{matrix} \partial f_1/\partial x_1 & \partial f_2/\partial x_1 & \ldots & \partial f_c/\partial x_1 \\ \partial f_1/\partial x_2 & \partial f_2/\partial x_2 & \ldots & \partial f_c/\partial x_2 \\ \ldots & \ldots & \ldots & \ldots \\ \partial f_1/\partial x_c & \partial f_2/\partial x_c & \ldots & \partial f_c/\partial x_c \end{matrix} \right). $$ set $s = r[x_1, \ldots, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}h - 1)$. this is an example of a standard smooth algebra, except that the presentation is wrong and the variables should be in the following order: $x_1, \ldots, x_c, x_{n + 1}, x_{c + 1}, \ldots, x_n$. \end{example} \begin{lemma} \label{lemma-compose-standard-smooth} a composition of standard smooth ring maps is standard smooth. \end{lemma} \begin{proof} suppose that $r \to s$ and $s \to s'$ are standard smooth. we choose presentations $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ and $s' = s[y_1, \ldots, y_m]/(g_1, \ldots, g_d)$. choose elements $g_j' \in r[x_1, \ldots, x_n, y_1, \ldots, y_m]$ mapping to the $g_j$. in this way we see $s' = r[x_1, \ldots, x_n, y_1, \ldots, y_m]/ (f_1, \ldots, f_c, g'_1, \ldots, g'_d)$. to show that $s'$ is standard smooth it suffices to verify that the determinant $$ \det \left( \begin{matrix} \partial f_1/\partial x_1 & \ldots & \partial f_c/\partial x_1 & \partial g_1/\partial x_1 & \ldots & \partial g_d/\partial x_1 \\ \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\ \partial f_1/\partial x_c & \ldots & \partial f_c/\partial x_c & \partial g_1/\partial x_c & \ldots & \partial g_d/\partial x_c \\ 0 & \ldots & 0 & \partial g_1/\partial y_1 & \ldots & \partial g_d/\partial y_1 \\ \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\ 0 & \ldots & 0 & \partial g_1/\partial y_d & \ldots & \partial g_d/\partial y_d \end{matrix} \right) $$ is invertible in $s'$. this is clear since it is the product of the two determinants which were assumed to be invertible by hypothesis. \end{proof} \begin{lemma} \label{lemma-smooth-syntomic} let $r \to s$ be a smooth ring map. there exists an open covering of $\spec(s)$ by standard opens $d(g)$ such that each $s_g$ is standard smooth over $r$. in particular $r \to s$ is syntomic. \end{lemma} \begin{proof} choose a presentation $\alpha : r[x_1, \ldots, x_n] \to s$ with kernel $i = (f_1, \ldots, f_m)$. for every subset $e \subset \{1, \ldots, m\}$ consider the open subset $u_e$ where the classes $f_e, e\in e$ freely generate the finite projective $s$-module $i/i^2$, see lemma \ref{lemma-cokernel-flat}. we may cover $\spec(s)$ by standard opens $d(g)$ each completely contained in one of the opens $u_e$. for such a $g$ we look at the presentation $$ \beta : r[x_1, \ldots, x_n, x_{n + 1}] \longrightarrow s_g $$ mapping $x_{n + 1}$ to $1/g$. setting $j = \ker(\beta)$ we use lemma \ref{lemma-principal-localization-nl} to see that $j/j^2 \cong (i/i^2)_g \oplus s_g$ is free. we may and do replace $s$ by $s_g$. then using lemma \ref{lemma-huber} we may assume we have a presentation $\alpha : r[x_1, \ldots, x_n] \to s$ with kernel $i = (f_1, \ldots, f_c)$ such that $i/i^2$ is free on the classes of $f_1, \ldots, f_c$. \medskip\noindent using the presentation $\alpha$ obtained at the end of the previous paragraph, we more or less repeat this argument with the basis elements $\text{d}x_1, \ldots, \text{d}x_n$ of $\omega_{r[x_1, \ldots, x_n]/r}$. namely, for any subset $e \subset \{1, \ldots, n\}$ of cardinality $c$ we may consider the open subset $u_e$ of $\spec(s)$ where the differential of $\nl(\alpha)$ composed with the projection $$ s^{\oplus c} \cong i/i^2 \longrightarrow \omega_{r[x_1, \ldots, x_n]/r} \otimes_{r[x_1, \ldots, x_n]} s \longrightarrow \bigoplus\nolimits_{i \in e} s\text{d}x_i $$ is an isomorphism. again we may find a covering of $\spec(s)$ by (finitely many) standard opens $d(g)$ such that each $d(g)$ is completely contained in one of the opens $u_e$. by renumbering, we may assume $e = \{1, \ldots, c\}$. for a $g$ with $d(g) \subset u_e$ we look at the presentation $$ \beta : r[x_1, \ldots, x_n, x_{n + 1}] \to s_g $$ mapping $x_{n + 1}$ to $1/g$. setting $j = \ker(\beta)$ we conclude from lemma \ref{lemma-principal-localization-nl} that $j = (f_1, \ldots, f_c, fx_{n + 1} - 1)$ where $\alpha(f) = g$ and that the composition $$ j/j^2 \longrightarrow \omega_{r[x_1, \ldots, x_{n + 1}]/r} \otimes_{r[x_1, \ldots, x_{n + 1}]} s_g \longrightarrow \bigoplus\nolimits_{i = 1}^c s_g\text{d}x_i \oplus s_g \text{d}x_{n + 1} $$ is an isomorphism. reordering the coordinates as $x_1, \ldots, x_c, x_{n + 1}, x_{c + 1}, \ldots, x_n$ we conclude that $s_g$ is standard smooth over $r$ as desired. \medskip\noindent this finishes the proof as standard smooth algebras are syntomic (lemmas \ref{lemma-standard-smooth} and \ref{lemma-relative-global-complete-intersection}) and being syntomic over $r$ is local on $s$ (lemma \ref{lemma-local-syntomic}). \end{proof} \begin{definition} \label{definition-smooth-at-prime} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime of $s$. we say $r \to s$ is {\it smooth at $\mathfrak q$} if there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is smooth. \end{definition} \noindent for ring maps of finite presentation we can characterize this as follows. \begin{lemma} \label{lemma-smooth-at-point} let $r \to s$ be of finite presentation. let $\mathfrak q$ be a prime of $s$. the following are equivalent \begin{enumerate} \item $r \to s$ is smooth at $\mathfrak q$, \item $h_1(l_{s/r})_\mathfrak q = 0$ and $\omega_{s/r, \mathfrak q}$ is a finite free $s_\mathfrak q$-module, \item $h_1(l_{s/r})_\mathfrak q = 0$ and $\omega_{s/r, \mathfrak q}$ is a projective $s_\mathfrak q$-module, and \item $h_1(l_{s/r})_\mathfrak q = 0$ and $\omega_{s/r, \mathfrak q}$ is a flat $s_\mathfrak q$-module. \end{enumerate} \end{lemma} \begin{proof} we will use without further mention that formation of the naive cotangent complex commutes with localization, see section \ref{section-netherlander}, especially lemma \ref{lemma-localize-nl}. note that $\omega_{s/r}$ is a finitely presented $s$-module, see lemma \ref{lemma-differentials-finitely-presented}. hence (2), (3), and (4) are equivalent by lemma \ref{lemma-finite-projective}. it is clear that (1) implies the equivalent conditions (2), (3), and (4). assume (2) holds. writing $s_\mathfrak q$ as the colimit of principal localizations we see from lemma \ref{lemma-colimit-category-fp-modules} that we can find a $g \in s$, $g \not \in \mathfrak q$ such that $(\omega_{s/r})_g$ is finite free. choose a presentation $\alpha : r[x_1, \ldots, x_n] \to s$ with kernel $i$. we may work with $\nl(\alpha)$ instead of $\nl_{s/r}$, see lemma \ref{lemma-nl-homotopy}. the surjection $$ \omega_{r[x_1, \ldots, x_n]/r} \otimes_r s \to \omega_{s/r} \to 0 $$ has a right inverse after inverting $g$ because $(\omega_{s/r})_g$ is projective. hence the image of $\text{d} : (i/i^2)_g \to \omega_{r[x_1, \ldots, x_n]/r} \otimes_r s_g$ is a direct summand and this map has a right inverse too. we conclude that $h_1(l_{s/r})_g$ is a quotient of $(i/i^2)_g$. in particular $h_1(l_{s/r})_g$ is a finite $s_g$-module. thus the vanishing of $h_1(l_{s/r})_{\mathfrak q}$ implies the vanishing of $h_1(l_{s/r})_{gg'}$ for some $g' \in s$, $g' \not \in \mathfrak q$. then $r \to s_{gg'}$ is smooth by definition. \end{proof} \begin{lemma} \label{lemma-locally-smooth} \begin{slogan} a ring map is smooth if and only if it is smooth at all primes of the target \end{slogan} let $r \to s$ be a ring map. then $r \to s$ is smooth if and only if $r \to s$ is smooth at every prime $\mathfrak q$ of $s$. \end{lemma} \begin{proof} the direct implication is trivial. suppose that $r \to s$ is smooth at every prime $\mathfrak q$ of $s$. since $\spec(s)$ is quasi-compact, see lemma \ref{lemma-quasi-compact}, there exists a finite covering $\spec(s) = \bigcup d(g_i)$ such that each $s_{g_i}$ is smooth. by lemma \ref{lemma-cover-upstairs} this implies that $s$ is of finite presentation over $r$. according to lemma \ref{lemma-localize-nl} we see that $\nl_{s/r} \otimes_s s_{g_i}$ is quasi-isomorphic to a finite projective $s_{g_i}$-module placed in degree $0$. by lemma \ref{lemma-finite-projective} this implies that $\nl_{s/r}$ is quasi-isomorphic to a finite projective $s$-module placed in degree $0$. \end{proof} \begin{lemma} \label{lemma-compose-smooth} a composition of smooth ring maps is smooth. \end{lemma} \begin{proof} you can prove this in many different ways. one way is to use the snake lemma (lemma \ref{lemma-snake}), the jacobi-zariski sequence (lemma \ref{lemma-exact-sequence-nl}), combined with the characterization of projective modules as being direct summands of free modules (lemma \ref{lemma-characterize-projective}). another proof can be obtained by combining lemmas \ref{lemma-smooth-syntomic}, \ref{lemma-compose-standard-smooth} and \ref{lemma-locally-smooth}. \end{proof} \begin{lemma} \label{lemma-product-smooth} let $r$ be a ring. let $s = s' \times s''$ be a product of $r$-algebras. then $s$ is smooth over $r$ if and only if both $s'$ and $s''$ are smooth over $r$. \end{lemma} \begin{proof} omitted. hints: by lemma \ref{lemma-locally-smooth} we can check smoothness one prime at a time. since $\spec(s)$ is the disjoint union of $\spec(s')$ and $\spec(s'')$ by lemma \ref{lemma-spec-product} we find that smoothness of $r \to s$ at $\mathfrak q$ corresponds to either smoothness of $r \to s'$ at the corresponding prime or smoothness of $r \to s''$ at the corresponding prime. \end{proof} \begin{lemma} \label{lemma-relative-global-complete-intersection-smooth} let $r$ be a ring. let $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection. let $\mathfrak q \subset s$ be a prime. then $r \to s$ is smooth at $\mathfrak q$ if and only if there exists a subset $i \subset \{1, \ldots, n\}$ of cardinality $c$ such that the polynomial $$ g_i = \det (\partial f_j/\partial x_i)_{j = 1, \ldots, c, \ i \in i}. $$ does not map to an element of $\mathfrak q$. \end{lemma} \begin{proof} by lemma \ref{lemma-relative-global-complete-intersection-conormal} we see that the naive cotangent complex associated to the given presentation of $s$ is the complex $$ \bigoplus\nolimits_{j = 1}^c s \cdot f_j \longrightarrow \bigoplus\nolimits_{i = 1}^n s \cdot \text{d}x_i, \quad f_j \longmapsto \sum \frac{\partial f_j}{\partial x_i} \text{d}x_i. $$ the maximal minors of the matrix giving the map are exactly the polynomials $g_i$. \medskip\noindent assume $g_i$ maps to $g \in s$, with $g \not \in \mathfrak q$. then the algebra $s_g$ is smooth over $r$. namely, its naive cotangent complex is quasi-isomorphic to the complex above localized at $g$, see lemma \ref{lemma-localize-nl}. and by construction it is quasi-isomorphic to a free rank $n - c$ module in degree $0$. \medskip\noindent conversely, suppose that all $g_i$ end up in $\mathfrak q$. in this case the complex above tensored with $\kappa(\mathfrak q)$ does not have maximal rank, and hence there is no localization by an element $g \in s$, $g \not \in \mathfrak q$ where this map becomes a split injection. by lemma \ref{lemma-localize-nl} again there is no such localization which is smooth over $r$. \end{proof} \begin{lemma} \label{lemma-flat-fibre-smooth} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over the prime $\mathfrak p$ of $r$. assume \begin{enumerate} \item there exists a $g \in s$, $g \not\in \mathfrak q$ such that $r \to s_g$ is of finite presentation, \item the local ring homomorphism $r_{\mathfrak p} \to s_{\mathfrak q}$ is flat, \item the fibre $s \otimes_r \kappa(\mathfrak p)$ is smooth over $\kappa(\mathfrak p)$ at the prime corresponding to $\mathfrak q$. \end{enumerate} then $r \to s$ is smooth at $\mathfrak q$. \end{lemma} \begin{proof} by lemmas \ref{lemma-syntomic} and \ref{lemma-smooth-over-field} we see that there exists a $g \in s$ such that $s_g$ is a relative global complete intersection. replacing $s$ by $s_g$ we may assume $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative global complete intersection. for any subset $i \subset \{1, \ldots, n\}$ of cardinality $c$ consider the polynomial $g_i = \det (\partial f_j/\partial x_i)_{j = 1, \ldots, c, i \in i}$ of lemma \ref{lemma-relative-global-complete-intersection-smooth}. note that the image $\overline{g}_i$ of $g_i$ in the polynomial ring $\kappa(\mathfrak p)[x_1, \ldots, x_n]$ is the determinant of the partial derivatives of the images $\overline{f}_j$ of the $f_j$ in the ring $\kappa(\mathfrak p)[x_1, \ldots, x_n]$. thus the lemma follows by applying lemma \ref{lemma-relative-global-complete-intersection-smooth} both to $r \to s$ and to $\kappa(\mathfrak p) \to s \otimes_r \kappa(\mathfrak p)$. \end{proof} \noindent note that the sets $u, v$ in the following lemma are open by definition. \begin{lemma} \label{lemma-flat-base-change-locus-smooth} let $r \to s$ be a ring map of finite presentation. let $r \to r'$ be a flat ring map. denote $s' = r' \otimes_r s$ the base change. let $u \subset \spec(s)$ be the set of primes at which $r \to s$ is smooth. let $v \subset \spec(s')$ the set of primes at which $r' \to s'$ is smooth. then $v$ is the inverse image of $u$ under the map $f : \spec(s') \to \spec(s)$. \end{lemma} \begin{proof} by lemma \ref{lemma-change-base-nl} we see that $\nl_{s/r} \otimes_s s'$ is homotopy equivalent to $\nl_{s'/r'}$. this already implies that $f^{-1}(u) \subset v$. \medskip\noindent let $\mathfrak q' \subset s'$ be a prime lying over $\mathfrak q \subset s$. assume $\mathfrak q' \in v$. we have to show that $\mathfrak q \in u$. since $s \to s'$ is flat, we see that $s_{\mathfrak q} \to s'_{\mathfrak q'}$ is faithfully flat (lemma \ref{lemma-local-flat-ff}). thus the vanishing of $h_1(l_{s'/r'})_{\mathfrak q'}$ implies the vanishing of $h_1(l_{s/r})_{\mathfrak q}$. by lemma \ref{lemma-finite-projective-descends} applied to the $s_{\mathfrak q}$-module $(\omega_{s/r})_{\mathfrak q}$ and the map $s_{\mathfrak q} \to s'_{\mathfrak q'}$ we see that $(\omega_{s/r})_{\mathfrak q}$ is projective. hence $r \to s$ is smooth at $\mathfrak q$ by lemma \ref{lemma-smooth-at-point}. \end{proof} \begin{lemma} \label{lemma-smooth-field-change-local} let $k/k$ be a field extension. let $s$ be a finite type algebra over $k$. let $\mathfrak q_k$ be a prime of $s_k = k \otimes_k s$ and let $\mathfrak q$ be the corresponding prime of $s$. then $s$ is smooth over $k$ at $\mathfrak q$ if and only if $s_k$ is smooth at $\mathfrak q_k$ over $k$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-flat-base-change-locus-smooth}. \end{proof} \begin{lemma} \label{lemma-lift-smooth} let $r$ be a ring and let $i \subset r$ be an ideal. let $r/i \to \overline{s}$ be a smooth ring map. then there exists elements $\overline{g}_i \in \overline{s}$ which generate the unit ideal of $\overline{s}$ such that each $\overline{s}_{g_i} \cong s_i/is_i$ for some (standard) smooth ring $s_i$ over $r$. \end{lemma} \begin{proof} by lemma \ref{lemma-smooth-syntomic} we find a collection of elements $\overline{g}_i \in \overline{s}$ which generate the unit ideal of $\overline{s}$ such that each $\overline{s}_{g_i}$ is standard smooth over $r/i$. hence we may assume that $\overline{s}$ is standard smooth over $r/i$. write $\overline{s} = (r/i)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_c)$ as in definition \ref{definition-standard-smooth}. choose $f_1, \ldots, f_c \in r[x_1, \ldots, x_n]$ lifting $\overline{f}_1, \ldots, \overline{f}_c$. set $s = r[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}\delta - 1)$ where $\delta = \det(\frac{\partial f_j}{\partial x_i})_{i, j = 1, \ldots, c}$ as in example \ref{example-make-standard-smooth}. this proves the lemma. \end{proof} \section{formally smooth maps} \label{section-formally-smooth} \noindent in this section we define formally smooth ring maps. it will turn out that a ring map of finite presentation is formally smooth if and only if it is smooth, see proposition \ref{proposition-smooth-formally-smooth}. \begin{definition} \label{definition-formally-smooth} let $r \to s$ be a ring map. we say $s$ is {\it formally smooth over $r$} if for every commutative solid diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & a/i \\ r \ar[r] \ar[u] & a \ar[u] } $$ where $i \subset a$ is an ideal of square zero, a dotted arrow exists which makes the diagram commute. \end{definition} \begin{lemma} \label{lemma-base-change-fs} let $r \to s$ be a formally smooth ring map. let $r \to r'$ be any ring map. then the base change $s' = r' \otimes_r s$ is formally smooth over $r'$. \end{lemma} \begin{proof} let a solid diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rrd] & r' \otimes_r s \ar[r] \ar@{-->}[rd] & a/i \\ r \ar[u] \ar[r] & r' \ar[r] \ar[u] & a \ar[u] } $$ as in definition \ref{definition-formally-smooth} be given. by assumption the longer dotted arrow exists. by the universal property of tensor product we obtain the shorter dotted arrow. \end{proof} \begin{lemma} \label{lemma-compose-formally-smooth} a composition of formally smooth ring maps is formally smooth. \end{lemma} \begin{proof} omitted. (hint: this is completely formal, and follows from considering a suitable diagram.) \end{proof} \begin{lemma} \label{lemma-polynomial-ring-formally-smooth} a polynomial ring over $r$ is formally smooth over $r$. \end{lemma} \begin{proof} suppose we have a diagram as in definition \ref{definition-formally-smooth} with $s = r[x_j; j \in j]$. then there exists a dotted arrow simply by choosing lifts $a_j \in a$ of the elements in $a/i$ to which the elements $x_j$ map to under the top horizontal arrow. \end{proof} \begin{lemma} \label{lemma-characterize-formally-smooth} let $r \to s$ be a ring map. let $p \to s$ be a surjective $r$-algebra map from a polynomial ring $p$ onto $s$. denote $j \subset p$ the kernel. then $r \to s$ is formally smooth if and only if there exists an $r$-algebra map $\sigma : s \to p/j^2$ which is a right inverse to the surjection $p/j^2 \to s$. \end{lemma} \begin{proof} assume $r \to s$ is formally smooth. consider the commutative diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & p/j \\ r \ar[r] \ar[u] & p/j^2\ar[u] } $$ by assumption the dotted arrow exists. this proves that $\sigma$ exists. \medskip\noindent conversely, suppose we have a $\sigma$ as in the lemma. let a solid diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & a/i \\ r \ar[r] \ar[u] & a \ar[u] } $$ as in definition \ref{definition-formally-smooth} be given. because $p$ is formally smooth by lemma \ref{lemma-polynomial-ring-formally-smooth}, there exists an $r$-algebra homomorphism $\psi : p \to a$ which lifts the map $p \to s \to a/i$. clearly $\psi(j) \subset i$ and since $i^2 = 0$ we conclude that $\psi(j^2) = 0$. hence $\psi$ factors as $\overline{\psi} : p/j^2 \to a$. the desired dotted arrow is the composition $\overline{\psi} \circ \sigma : s \to a$. \end{proof} \begin{remark} \label{remark-lemma-characterize-formally-smooth} lemma \ref{lemma-characterize-formally-smooth} holds more generally whenever $p$ is formally smooth over $r$. \end{remark} \begin{lemma} \label{lemma-characterize-formally-smooth-again} let $r \to s$ be a ring map. let $p \to s$ be a surjective $r$-algebra map from a polynomial ring $p$ onto $s$. denote $j \subset p$ the kernel. then $r \to s$ is formally smooth if and only if the sequence $$ 0 \to j/j^2 \to \omega_{p/r} \otimes_p s \to \omega_{s/r} \to 0 $$ of lemma \ref{lemma-differential-seq} is a split exact sequence. \end{lemma} \begin{proof} assume $s$ is formally smooth over $r$. by lemma \ref{lemma-characterize-formally-smooth} this means there exists an $r$-algebra map $s \to p/j^2$ which is a right inverse to the canonical map $p/j^2 \to s$. by lemma \ref{lemma-differential-mod-power-ideal} we have $\omega_{p/r} \otimes_p s = \omega_{(p/j^2)/r} \otimes_{p/j^2} s$. by lemma \ref{lemma-differential-seq-split} the sequence is split. \medskip\noindent assume the exact sequence of the lemma is split exact. choose a splitting $\sigma : \omega_{s/r} \to \omega_{p/r} \otimes_p s$. for each $\lambda \in s$ choose $x_\lambda \in p$ which maps to $\lambda$. next, for each $\lambda \in s$ choose $f_\lambda \in j$ such that $$ \text{d}f_\lambda = \text{d}x_\lambda - \sigma(\text{d}\lambda) $$ in the middle term of the exact sequence. we claim that $s : \lambda \mapsto x_\lambda - f_\lambda \mod j^2$ is an $r$-algebra homomorphism $s : s \to p/j^2$. to prove this we will repeatedly use that if $h \in j$ and $\text{d}h = 0$ in $\omega_{p/r} \otimes_r s$, then $h \in j^2$. let $\lambda, \mu \in s$. then $\sigma(\text{d}\lambda + \text{d}\mu - \text{d}(\lambda + \mu)) = 0$. this implies $$ \text{d}(x_\lambda + x_\mu - x_{\lambda + \mu} - f_\lambda - f_\mu + f_{\lambda + \mu}) = 0 $$ which means that $x_\lambda + x_\mu - x_{\lambda + \mu} - f_\lambda - f_\mu + f_{\lambda + \mu} \in j^2$, which in turn means that $s(\lambda) + s(\mu) = s(\lambda + \mu)$. similarly, we have $\sigma(\lambda \text{d}\mu + \mu \text{d}\lambda - \text{d}\lambda \mu) = 0$ which implies that $$ \mu(\text{d}x_\lambda - \text{d}f_\lambda) + \lambda(\text{d}x_\mu - \text{d}f_\mu) - \text{d}x_{\lambda\mu} + \text{d}f_{\lambda\mu} = 0 $$ in the middle term of the exact sequence. moreover we have $$ \text{d}(x_\lambda x_\mu) = x_\lambda \text{d}x_\mu + x_\mu \text{d}x_\lambda = \lambda \text{d}x_\mu + \mu \text{d} x_\lambda $$ in the middle term again. combined these equations mean that $x_\lambda x_\mu - x_{\lambda\mu} - \mu f_\lambda - \lambda f_\mu + f_{\lambda\mu} \in j^2$, hence $(x_\lambda - f_\lambda)(x_\mu - f_\mu) - (x_{\lambda\mu} - f_{\lambda\mu}) \in j^2$ as $f_\lambda f_\mu \in j^2$, which means that $s(\lambda)s(\mu) = s(\lambda\mu)$. if $\lambda \in r$, then $\text{d}\lambda = 0$ and we see that $\text{d}f_\lambda = \text{d}x_\lambda$, hence $\lambda - x_\lambda + f_\lambda \in j^2$ and hence $s(\lambda) = \lambda$ as desired. at this point we can apply lemma \ref{lemma-characterize-formally-smooth} to conclude that $s/r$ is formally smooth. \end{proof} \begin{proposition} \label{proposition-characterize-formally-smooth} let $r \to s$ be a ring map. consider a formally smooth $r$-algebra $p$ and a surjection $p \to s$ with kernel $j$. the following are equivalent \begin{enumerate} \item $s$ is formally smooth over $r$, \item for some $p \to s$ as above there exists a section to $p/j^2 \to s$, \item for all $p \to s$ as above there exists a section to $p/j^2 \to s$, \item for some $p \to s$ as above the sequence $0 \to j/j^2 \to \omega_{p/r} \otimes s \to \omega_{s/r} \to 0$ is split exact, \item for all $p \to s$ as above the sequence $0 \to j/j^2 \to \omega_{p/r} \otimes s \to \omega_{s/r} \to 0$ is split exact, and \item the naive cotangent complex $\nl_{s/r}$ is quasi-isomorphic to a projective $s$-module placed in degree $0$: this means that $h_1(\nl_{s/r}) = 0$ and that $\omega_{s/r}$ is a projective $s$-module. \end{enumerate} \end{proposition} \begin{proof} it is clear that (1) implies (3) implies (2), see first part of the proof of lemma \ref{lemma-characterize-formally-smooth}. it is also true that (3) implies (5) implies (4) and that (2) implies (4), see first part of the proof of lemma \ref{lemma-characterize-formally-smooth-again}. finally, lemma \ref{lemma-characterize-formally-smooth-again} applied to the canonical surjection $r[s] \to s$ (\ref{equation-canonical-presentation}) shows that (1) implies (6). \medskip\noindent assume (4) and let's prove (6). consider the sequence of lemma \ref{lemma-exact-sequence-nl} associated to the ring maps $r \to p \to s$. by the implication (1) $\rightarrow$ (6) proved above we see that $\nl_{p/r} \otimes_r s$ is quasi-isomorphic to $\omega_{p/r} \otimes_p s$ placed in degree $0$. hence $h_1(\nl_{p/r} \otimes_p s) = 0$. since $p \to s$ is surjective we see that $\nl_{s/p}$ is homotopy equivalent to $j/j^2$ placed in degree $1$ (lemma \ref{lemma-nl-surjection}). thus we obtain the exact sequence $0 \to h_1(l_{s/r}) \to j/j^2 \to \omega_{p/r} \otimes_p s \to \omega_{s/r} \to 0$. by assumption we see that $h_1(l_{s/r}) = 0$ and that $\omega_{s/r}$ is a projective $s$-module. thus (6) follows. \medskip\noindent finally, let's prove that (6) implies (1). the assumption means that the complex $j/j^2 \to \omega_{p/r} \otimes s$ where $p = r[s]$ and $p \to s$ is the canonical surjection (\ref{equation-canonical-presentation}) is quasi-isomorphic to a projective $s$-module placed in degree $0$. hence lemma \ref{lemma-characterize-formally-smooth-again} shows that $s$ is formally smooth over $r$. \end{proof} \begin{lemma} \label{lemma-ses-formally-smooth} let $a \to b \to c$ be ring maps. assume $b \to c$ is formally smooth. then the sequence $$ 0 \to \omega_{b/a} \otimes_b c \to \omega_{c/a} \to \omega_{c/b} \to 0 $$ of lemma \ref{lemma-exact-sequence-differentials} is a split short exact sequence. \end{lemma} \begin{proof} follows from proposition \ref{proposition-characterize-formally-smooth} and lemma \ref{lemma-exact-sequence-nl}. \end{proof} \begin{lemma} \label{lemma-differential-seq-formally-smooth} let $a \to b \to c$ be ring maps with $a \to c$ formally smooth and $b \to c$ surjective with kernel $j \subset b$. then the exact sequence $$ 0 \to j/j^2 \to \omega_{b/a} \otimes_b c \to \omega_{c/a} \to 0 $$ of lemma \ref{lemma-differential-seq} is split exact. \end{lemma} \begin{proof} follows from proposition \ref{proposition-characterize-formally-smooth}, lemma \ref{lemma-exact-sequence-nl}, and lemma \ref{lemma-differential-seq}. \end{proof} \begin{lemma} \label{lemma-application-nl-formally-smooth} let $a \to b \to c$ be ring maps. assume $a \to c$ is surjective (so also $b \to c$ is) and $a \to b$ formally smooth. denote $i = \ker(a \to c)$ and $j = \ker(b \to c)$. then the sequence $$ 0 \to i/i^2 \to j/j^2 \to \omega_{b/a} \otimes_b b/j \to 0 $$ of lemma \ref{lemma-application-nl} is split exact. \end{lemma} \begin{proof} since $a \to b$ is formally smooth there exists a ring map $\sigma : b \to a/i^2$ whose composition with $a \to b$ equals the quotient map $a \to a/i^2$. then $\sigma$ induces a map $j/j^2 \to i/i^2$ which is inverse to the map $i/i^2 \to j/j^2$. \end{proof} \begin{lemma} \label{lemma-lift-formal-smoothness} let $r \to s$ be a ring map. let $i \subset r$ be an ideal. assume \begin{enumerate} \item $i^2 = 0$, \item $r \to s$ is flat, and \item $r/i \to s/is$ is formally smooth. \end{enumerate} then $r \to s$ is formally smooth. \end{lemma} \begin{proof} assume (1), (2) and (3). let $p = r[\{x_t\}_{t \in t}] \to s$ be a surjection of $r$-algebras with kernel $j$. thus $0 \to j \to p \to s \to 0$ is a short exact sequence of flat $r$-modules. this implies that $i \otimes_r s = is$, $i \otimes_r p = ip$ and $i \otimes_r j = ij$ as well as $j \cap ip = ij$. we will use throughout the proof that $$ \omega_{(s/is)/(r/i)} = \omega_{s/r} \otimes_s (s/is) = \omega_{s/r} \otimes_r r/i = \omega_{s/r} / i\omega_{s/r} $$ and similarly for $p$ (see lemma \ref{lemma-differentials-base-change}). by lemma \ref{lemma-characterize-formally-smooth-again} the sequence \begin{equation} \label{equation-split} 0 \to j/(ij + j^2) \to \omega_{p/r} \otimes_p s/is \to \omega_{s/r} \otimes_s s/is \to 0 \end{equation} is split exact. of course the middle term is $\bigoplus_{t \in t} s/is \text{d}x_t$. choose a splitting $\sigma : \omega_{p/r} \otimes_p s/is \to j/(ij + j^2)$. for each $t \in t$ choose an element $f_t \in j$ which maps to $\sigma(\text{d}x_t)$ in $j/(ij + j^2)$. this determines a unique $s$-module map $$ \tilde \sigma : \omega_{p/r} \otimes_r s = \bigoplus s\text{d}x_t \longrightarrow j/j^2 $$ with the property that $\tilde\sigma(\text{d}x_t) = f_t$. as $\sigma$ is a section to $\text{d}$ the difference $$ \delta = \text{id}_{j/j^2} - \tilde \sigma \circ \text{d} $$ is a self map $j/j^2 \to j/j^2$ whose image is contained in $(ij + j^2)/j^2$. in particular $\delta((ij + j^2)/j^2) = 0$ because $i^2 = 0$. this means that $\delta$ factors as $$ j/j^2 \to j/(ij + j^2) \xrightarrow{\overline{\delta}} (ij + j^2)/j^2 \to j/j^2 $$ where $\overline{\delta}$ is a $s/is$-module map. using again that the sequence (\ref{equation-split}) is split, we can find a $s/is$-module map $\overline{\delta} : \omega_{p/r} \otimes_p s/is \to (ij + j^2)/j^2$ such that $\overline{\delta} \circ d$ is equal to $\overline{\delta}$. in the same manner as above the map $\overline{\delta}$ determines an $s$-module map $\delta : \omega_{p/r} \otimes_p s \to j/j^2$. after replacing $\tilde \sigma$ by $\tilde \sigma + \delta$ a simple computation shows that $\delta = 0$. in other words $\tilde \sigma$ is a section of $j/j^2 \to \omega_{p/r} \otimes_p s$. by lemma \ref{lemma-characterize-formally-smooth-again} we conclude that $r \to s$ is formally smooth. \end{proof} \begin{proposition} \label{proposition-smooth-formally-smooth} let $r \to s$ be a ring map. the following are equivalent \begin{enumerate} \item $r \to s$ is of finite presentation and formally smooth, \item $r \to s$ is smooth. \end{enumerate} \end{proposition} \begin{proof} follows from proposition \ref{proposition-characterize-formally-smooth} and definition \ref{definition-smooth}. (note that $\omega_{s/r}$ is a finitely presented $s$-module if $r \to s$ is of finite presentation, see lemma \ref{lemma-differentials-finitely-presented}.) \end{proof} \begin{lemma} \label{lemma-finite-presentation-fs-noetherian} let $r \to s$ be a smooth ring map. then there exists a subring $r_0 \subset r$ of finite type over $\mathbf{z}$ and a smooth ring map $r_0 \to s_0$ such that $s \cong r \otimes_{r_0} s_0$. \end{lemma} \begin{proof} we are going to use that smooth is equivalent to finite presentation and formally smooth, see proposition \ref{proposition-smooth-formally-smooth}. write $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ and denote $i = (f_1, \ldots, f_m)$. choose a right inverse $\sigma : s \to r[x_1, \ldots, x_n]/i^2$ to the projection to $s$ as in lemma \ref{lemma-characterize-formally-smooth}. choose $h_i \in r[x_1, \ldots, x_n]$ such that $\sigma(x_i \bmod i) = h_i \bmod i^2$. since $x_i - h_i \in i$, there exist $b_{ij} \in r[x_1, \ldots, x_n]$ such that $$ x_i - h_i = \sum\nolimits_j b_{ij} f_j $$ the fact that $\sigma$ is an $r$-algebra homomorphism $r[x_1, \ldots, x_n]/i \to r[x_1, \ldots, x_n]/i^2$ is equivalent to the condition that $$ f_j(h_1, \ldots, h_n) = \sum\nolimits_{j_1 j_2} a_{j_1 j_2} f_{j_1} f_{j_2} $$ for certain $a_{kl} \in r[x_1, \ldots, x_n]$. let $r_0 \subset r$ be the subring generated over $\mathbf{z}$ by all the coefficients of the polynomials $f_j, h_i, a_{kl}, b_{ij}$. set $s_0 = r_0[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$, with $i_0 = (f_1, \ldots, f_m)$. since the second displayed equation holds in $r_0[x_1, \ldots, x_n]$ we can let $\sigma_0 : s_0 \to r_0[x_1, \ldots, x_n]/i_0^2$ be the $r_0$-algebra map defined by the rule $x_i \mapsto h_i \bmod i_0^2$. since the first displayed equation holds in $r_0[x_1, \ldots, x_n]$ we see that $\sigma_0$ is a right inverse to the projection $r_0[x_1, \ldots, x_n] / i_0^2 \to r_0[x_1, \ldots, x_n] / i_0 = s_0$. thus by lemma \ref{lemma-characterize-formally-smooth} the ring $s_0$ is formally smooth over $r_0$. \end{proof} \begin{lemma} \label{lemma-smooth-descends-through-colimit} let $a = \colim a_i$ be a filtered colimit of rings. let $a \to b$ be a smooth ring map. there exists an $i$ and a smooth ring map $a_i \to b_i$ such that $b = b_i \otimes_{a_i} a$. \end{lemma} \begin{proof} follows from lemma \ref{lemma-finite-presentation-fs-noetherian} since $r_0 \to a$ will factor through $a_i$ for some $i$ by lemma \ref{lemma-characterize-finite-presentation}. \end{proof} \begin{lemma} \label{lemma-descent-formally-smooth} let $r \to s$ be a ring map. let $r \to r'$ be a faithfully flat ring map. set $s' = s \otimes_r r'$. then $r \to s$ is formally smooth if and only if $r' \to s'$ is formally smooth. \end{lemma} \begin{proof} if $r \to s$ is formally smooth, then $r' \to s'$ is formally smooth by lemma \ref{lemma-base-change-fs}. to prove the converse, assume $r' \to s'$ is formally smooth. note that $n \otimes_r r' = n \otimes_s s'$ for any $s$-module $n$. in particular $s \to s'$ is faithfully flat also. choose a polynomial ring $p = r[\{x_i\}_{i \in i}]$ and a surjection of $r$-algebras $p \to s$ with kernel $j$. note that $p' = p \otimes_r r'$ is a polynomial algebra over $r'$. since $r \to r'$ is flat the kernel $j'$ of the surjection $p' \to s'$ is $j \otimes_r r'$. hence the split exact sequence (see lemma \ref{lemma-characterize-formally-smooth-again}) $$ 0 \to j'/(j')^2 \to \omega_{p'/r'} \otimes_{p'} s' \to \omega_{s'/r'} \to 0 $$ is the base change via $s \to s'$ of the corresponding sequence $$ j/j^2 \to \omega_{p/r} \otimes_p s \to \omega_{s/r} \to 0 $$ see lemma \ref{lemma-differential-seq}. as $s \to s'$ is faithfully flat we conclude two things: (1) this sequence (without ${}'$) is exact too, and (2) $\omega_{s/r}$ is a projective $s$-module. namely, $\omega_{s'/r'}$ is projective as a direct summand of the free module $\omega_{p'/r'} \otimes_{p'} s'$ and $\omega_{s/r} \otimes_s {s'} = \omega_{s'/r'}$ by what we said above. thus (2) follows by descent of projectivity through faithfully flat ring maps, see theorem \ref{theorem-ffdescent-projectivity}. hence the sequence $0 \to j/j^2 \to \omega_{p/r} \otimes_p s \to \omega_{s/r} \to 0$ is exact also and we win by applying lemma \ref{lemma-characterize-formally-smooth-again} once more. \end{proof} \noindent it turns out that smooth ring maps satisfy the following strong lifting property. \begin{lemma} \label{lemma-smooth-strong-lift} let $r \to s$ be a smooth ring map. given a commutative solid diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & a/i \\ r \ar[r] \ar[u] & a \ar[u] } $$ where $i \subset a$ is a locally nilpotent ideal, a dotted arrow exists which makes the diagram commute. \end{lemma} \begin{proof} by lemma \ref{lemma-finite-presentation-fs-noetherian} we can extend the diagram to a commutative diagram $$ \xymatrix{ s_0 \ar[r] & s \ar[r] \ar@{-->}[rd] & a/i \\ r_0 \ar[r] \ar[u] & r \ar[r] \ar[u] & a \ar[u] } $$ with $r_0 \to s_0$ smooth, $r_0$ of finite type over $\mathbf{z}$, and $s = s_0 \otimes_{r_0} r$. let $x_1, \ldots, x_n \in s_0$ be generators of $s_0$ over $r_0$. let $a_1, \ldots, a_n$ be elements of $a$ which map to the same elements in $a/i$ as the elements $x_1, \ldots, x_n$. denote $a_0 \subset a$ the subring generated by the image of $r_0$ and the elements $a_1, \ldots, a_n$. set $i_0 = a_0 \cap i$. then $a_0/i_0 \subset a/i$ and $s_0 \to a/i$ maps into $a_0/i_0$. thus it suffices to find the dotted arrow in the diagram $$ \xymatrix{ s_0 \ar[r] \ar@{-->}[rd] & a_0/i_0 \\ r_0 \ar[r] \ar[u] & a_0 \ar[u] } $$ the ring $a_0$ is of finite type over $\mathbf{z}$ by construction. hence $a_0$ is noetherian, whence $i_0$ is nilpotent, see lemma \ref{lemma-noetherian-power}. say $i_0^n = 0$. by proposition \ref{proposition-smooth-formally-smooth} we can successively lift the $r_0$-algebra map $s_0 \to a_0/i_0$ to $s_0 \to a_0/i_0^2$, $s_0 \to a_0/i_0^3$, $\ldots$, and finally $s_0 \to a_0/i_0^n = a_0$. \end{proof} \section{smoothness and differentials} \label{section-smooth-differential} \noindent some results on differentials and smooth ring maps. \begin{lemma} \label{lemma-triangle-differentials-smooth} given ring maps $a \to b \to c$ with $b \to c$ smooth, then the sequence $$ 0 \to c \otimes_b \omega_{b/a} \to \omega_{c/a} \to \omega_{c/b} \to 0 $$ of lemma \ref{lemma-exact-sequence-differentials} is exact. \end{lemma} \begin{proof} this follows from the more general lemma \ref{lemma-ses-formally-smooth} because a smooth ring map is formally smooth, see proposition \ref{proposition-smooth-formally-smooth}. but it also follows directly from lemma \ref{lemma-exact-sequence-nl} since $h_1(l_{c/b}) = 0$ is part of the definition of smoothness of $b \to c$. \end{proof} \begin{lemma} \label{lemma-differential-seq-smooth} let $a \to b \to c$ be ring maps with $a \to c$ smooth and $b \to c$ surjective with kernel $j \subset b$. then the exact sequence $$ 0 \to j/j^2 \to \omega_{b/a} \otimes_b c \to \omega_{c/a} \to 0 $$ of lemma \ref{lemma-differential-seq} is split exact. \end{lemma} \begin{proof} this follows from the more general lemma \ref{lemma-differential-seq-formally-smooth} because a smooth ring map is formally smooth, see proposition \ref{proposition-smooth-formally-smooth}. \end{proof} \begin{lemma} \label{lemma-application-nl-smooth} let $a \to b \to c$ be ring maps. assume $a \to c$ is surjective (so also $b \to c$ is) and $a \to b$ smooth. denote $i = \ker(a \to c)$ and $j = \ker(b \to c)$. then the sequence $$ 0 \to i/i^2 \to j/j^2 \to \omega_{b/a} \otimes_b b/j \to 0 $$ of lemma \ref{lemma-application-nl} is exact. \end{lemma} \begin{proof} this follows from the more general lemma \ref{lemma-application-nl-formally-smooth} because a smooth ring map is formally smooth, see proposition \ref{proposition-smooth-formally-smooth}. \end{proof} \begin{lemma} \label{lemma-section-smooth} \begin{slogan} if $r$ is a summand of $s$ and $s$ is smooth over $r$, then the $i$-adic completion of $s$ is often a power series over $r$ where $i$ is the kernel of the projection map from $s$ to $r$. \end{slogan} let $\varphi : r \to s$ be a smooth ring map. let $\sigma : s \to r$ be a left inverse to $\varphi$. set $i = \ker(\sigma)$. then \begin{enumerate} \item $i/i^2$ is a finite locally free $r$-module, and \item if $i/i^2$ is free, then $s^\wedge \cong r[[t_1, \ldots, t_d]]$ as $r$-algebras, where $s^\wedge$ is the $i$-adic completion of $s$. \end{enumerate} \end{lemma} \begin{proof} by lemma \ref{lemma-differential-seq-split} applied to $r \to s \to r$ we see that $i/i^2 = \omega_{s/r} \otimes_{s, \sigma} r$. since by definition of a smooth morphism the module $\omega_{s/r}$ is finite locally free over $s$ we deduce that (1) holds. if $i/i^2$ is free, then choose $f_1, \ldots, f_d \in i$ whose images in $i/i^2$ form an $r$-basis. consider the $r$-algebra map defined by $$ \psi : r[[x_1, \ldots, x_d]] \longrightarrow s^\wedge, \quad x_i \longmapsto f_i. $$ denote $p = r[[x_1, \ldots, x_d]]$ and $j = (x_1, \ldots, x_d) \subset p$. we write $\psi_n : p/j^n \to s/i^n$ for the induced map of quotient rings. note that $s/i^2 = \varphi(r) \oplus i/i^2$. thus $\psi_2$ is an isomorphism. denote $\sigma_2 : s/i^2 \to p/j^2$ the inverse of $\psi_2$. we will prove by induction on $n$ that for all $n > 2$ there exists an inverse $\sigma_n : s/i^n \to p/j^n$ of $\psi_n$. namely, as $s$ is formally smooth over $r$ (by proposition \ref{proposition-smooth-formally-smooth}) we see that in the solid diagram $$ \xymatrix{ s \ar@{..>}[r] \ar[rd]_{\sigma_{n - 1}} & p/j^n \ar[d] \\ & p/j^{n - 1} } $$ of $r$-algebras we can fill in the dotted arrow by some $r$-algebra map $\tau : s \to p/j^n$ making the diagram commute. this induces an $r$-algebra map $\overline{\tau} : s/i^n \to p/j^n$ which is equal to $\sigma_{n - 1}$ modulo $j^{n - 1}$. by construction the map $\psi_n$ is surjective and now $\overline{\tau} \circ \psi_n$ is an $r$-algebra endomorphism of $p/j^n$ which maps $x_i$ to $x_i + \delta_{i, n}$ with $\delta_{i, n} \in j^{n - 1}/j^n$. it follows that $\psi_n$ is an isomorphism and hence it has an inverse $\sigma_n$. this proves the lemma. \end{proof} \section{smooth algebras over fields} \label{section-smooth-over-field} \noindent warning: the following two lemmas do not hold over nonperfect fields in general. \begin{lemma} \label{lemma-rank-omega} let $k$ be an algebraically closed field. let $s$ be a finite type $k$-algebra. let $\mathfrak m \subset s$ be a maximal ideal. then $$ \dim_{\kappa(\mathfrak m)} \omega_{s/k} \otimes_s \kappa(\mathfrak m) = \dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2. $$ \end{lemma} \begin{proof} consider the exact sequence $$ \mathfrak m/\mathfrak m^2 \to \omega_{s/k} \otimes_s \kappa(\mathfrak m) \to \omega_{\kappa(\mathfrak m)/k} \to 0 $$ of lemma \ref{lemma-differential-seq}. we would like to show that the first map is an isomorphism. since $k$ is algebraically closed the composition $k \to \kappa(\mathfrak m)$ is an isomorphism by theorem \ref{theorem-nullstellensatz}. so the surjection $s \to \kappa(\mathfrak m)$ splits as a map of $k$-algebras, and lemma \ref{lemma-differential-seq-split} shows that the sequence above is exact on the left. since $\omega_{\kappa(\mathfrak m)/k} = 0$, we win. \end{proof} \begin{lemma} \label{lemma-characterize-smooth-kbar} let $k$ be an algebraically closed field. let $s$ be a finite type $k$-algebra. let $\mathfrak m \subset s$ be a maximal ideal. the following are equivalent: \begin{enumerate} \item the ring $s_{\mathfrak m}$ is a regular local ring. \item we have $\dim_{\kappa(\mathfrak m)} \omega_{s/k} \otimes_s \kappa(\mathfrak m) \leq \dim(s_{\mathfrak m})$. \item we have $\dim_{\kappa(\mathfrak m)} \omega_{s/k} \otimes_s \kappa(\mathfrak m) = \dim(s_{\mathfrak m})$. \item there exists a $g \in s$, $g \not \in \mathfrak m$ such that $s_g$ is smooth over $k$. in other words $s/k$ is smooth at $\mathfrak m$. \end{enumerate} \end{lemma} \begin{proof} note that (1), (2) and (3) are equivalent by lemma \ref{lemma-rank-omega} and definition \ref{definition-regular}. \medskip\noindent assume that $s$ is smooth at $\mathfrak m$. by lemma \ref{lemma-smooth-syntomic} we see that $s_g$ is standard smooth over $k$ for a suitable $g \in s$, $g \not \in \mathfrak m$. hence by lemma \ref{lemma-standard-smooth} we see that $\omega_{s_g/k}$ is free of rank $\dim(s_g)$. hence by lemma \ref{lemma-rank-omega} we see that $\dim(s_{\mathfrak m}) = \dim (\mathfrak m/\mathfrak m^2)$ in other words $s_\mathfrak m$ is regular. \medskip\noindent conversely, suppose that $s_{\mathfrak m}$ is regular. let $d = \dim(s_{\mathfrak m}) = \dim \mathfrak m/\mathfrak m^2$. choose a presentation $s = k[x_1, \ldots, x_n]/i$ such that $x_i$ maps to an element of $\mathfrak m$ for all $i$. in other words, $\mathfrak m'' = (x_1, \ldots, x_n)$ is the corresponding maximal ideal of $k[x_1, \ldots, x_n]$. note that we have a short exact sequence $$ i/\mathfrak m''i \to \mathfrak m''/(\mathfrak m'')^2 \to \mathfrak m/(\mathfrak m)^2 \to 0 $$ pick $c = n - d$ elements $f_1, \ldots, f_c \in i$ such that their images in $\mathfrak m''/(\mathfrak m'')^2$ span the kernel of the map to $\mathfrak m/\mathfrak m^2$. this is clearly possible. denote $j = (f_1, \ldots, f_c)$. so $j \subset i$. denote $s' = k[x_1, \ldots, x_n]/j$ so there is a surjection $s' \to s$. denote $\mathfrak m' = \mathfrak m''s'$ the corresponding maximal ideal of $s'$. hence we have $$ \xymatrix{ k[x_1, \ldots, x_n] \ar[r] & s' \ar[r] & s \\ \mathfrak m'' \ar[u] \ar[r] & \mathfrak m' \ar[r] \ar[u] & \mathfrak m \ar[u] } $$ by our choice of $j$ the exact sequence $$ j/\mathfrak m''j \to \mathfrak m''/(\mathfrak m'')^2 \to \mathfrak m'/(\mathfrak m')^2 \to 0 $$ shows that $\dim( \mathfrak m'/(\mathfrak m')^2 ) = d$. since $s'_{\mathfrak m'}$ surjects onto $s_{\mathfrak m}$ we see that $\dim(s_{\mathfrak m'}) \geq d$. hence by the discussion preceding definition \ref{definition-regular-local} we conclude that $s'_{\mathfrak m'}$ is regular of dimension $d$ as well. because $s'$ was cut out by $c = n - d$ equations we conclude that there exists a $g' \in s'$, $g' \not \in \mathfrak m'$ such that $s'_{g'}$ is a global complete intersection over $k$, see lemma \ref{lemma-lci}. also the map $s'_{\mathfrak m'} \to s_{\mathfrak m}$ is a surjection of noetherian local domains of the same dimension and hence an isomorphism. hence $s' \to s$ is surjective with finitely generated kernel and becomes an isomorphism after localizing at $\mathfrak m'$. thus we can find $g' \in s'$, $g \not \in \mathfrak m'$ such that $s'_{g'} \to s_{g'}$ is an isomorphism. all in all we conclude that after replacing $s$ by a principal localization we may assume that $s$ is a global complete intersection. \medskip\noindent at this point we may write $s = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ with $\dim s = n - c$. recall that the naive cotangent complex of this algebra is given by $$ \bigoplus s \cdot f_j \to \bigoplus s \cdot \text{d}x_i $$ see lemma \ref{lemma-relative-global-complete-intersection-conormal}. by lemma \ref{lemma-relative-global-complete-intersection-smooth} in order to show that $s$ is smooth at $\mathfrak m$ we have to show that one of the $c \times c$ minors $g_i$ of the matrix ``$a$'' giving the map above does not vanish at $\mathfrak m$. by lemma \ref{lemma-rank-omega} the matrix $a \bmod \mathfrak m$ has rank $c$. thus we win. \end{proof} \begin{lemma} \label{lemma-characterize-smooth-over-field} let $k$ be any field. let $s$ be a finite type $k$-algebra. let $x = \spec(s)$. let $\mathfrak q \subset s$ be a prime corresponding to $x \in x$. the following are equivalent: \begin{enumerate} \item the $k$-algebra $s$ is smooth at $\mathfrak q$ over $k$. \item we have $\dim_{\kappa(\mathfrak q)} \omega_{s/k} \otimes_s \kappa(\mathfrak q) \leq \dim_x x$. \item we have $\dim_{\kappa(\mathfrak q)} \omega_{s/k} \otimes_s \kappa(\mathfrak q) = \dim_x x$. \end{enumerate} moreover, in this case the local ring $s_{\mathfrak q}$ is regular. \end{lemma} \begin{proof} if $s$ is smooth at $\mathfrak q$ over $k$, then there exists a $g \in s$, $g \not \in \mathfrak q$ such that $s_g$ is standard smooth over $k$, see lemma \ref{lemma-smooth-syntomic}. a standard smooth algebra over $k$ has a module of differentials which is free of rank equal to the dimension, see lemma \ref{lemma-standard-smooth} (use that a relative global complete intersection over a field has dimension equal to the number of variables minus the number of equations). thus we see that (1) implies (3). to finish the proof of the lemma it suffices to show that (2) implies (1) and that it implies that $s_{\mathfrak q}$ is regular. \medskip\noindent assume (2). by nakayama's lemma \ref{lemma-nak} we see that $\omega_{s/k, \mathfrak q}$ can be generated by $\leq \dim_x x$ elements. we may replace $s$ by $s_g$ for some $g \in s$, $g \not \in \mathfrak q$ such that $\omega_{s/k}$ is generated by at most $\dim_x x$ elements. let $k/k$ be an algebraically closed field extension such that there exists a $k$-algebra map $\psi : \kappa(\mathfrak q) \to k$. consider $s_k = k \otimes_k s$. let $\mathfrak m \subset s_k$ be the maximal ideal corresponding to the surjection $$ \xymatrix{ s_k = k \otimes_k s \ar[r] & k \otimes_k \kappa(\mathfrak q) \ar[r]^-{\text{id}_k \otimes \psi} & k. } $$ note that $\mathfrak m \cap s = \mathfrak q$, in other words $\mathfrak m$ lies over $\mathfrak q$. by lemma \ref{lemma-dimension-at-a-point-preserved-field-extension} the dimension of $x_k = \spec(s_k)$ at the point corresponding to $\mathfrak m$ is $\dim_x x$. by lemma \ref{lemma-dimension-closed-point-finite-type-field} this is equal to $\dim((s_k)_{\mathfrak m})$. by lemma \ref{lemma-differentials-base-change} the module of differentials of $s_k$ over $k$ is the base change of $\omega_{s/k}$, hence also generated by at most $\dim_x x = \dim((s_k)_{\mathfrak m})$ elements. by lemma \ref{lemma-characterize-smooth-kbar} we see that $s_k$ is smooth at $\mathfrak m$ over $k$. by lemma \ref{lemma-flat-base-change-locus-smooth} this implies that $s$ is smooth at $\mathfrak q$ over $k$. this proves (1). moreover, we know by lemma \ref{lemma-characterize-smooth-kbar} that the local ring $(s_k)_{\mathfrak m}$ is regular. since $s_{\mathfrak q} \to (s_k)_{\mathfrak m}$ is flat we conclude from lemma \ref{lemma-flat-under-regular} that $s_{\mathfrak q}$ is regular. \end{proof} \noindent the following lemma can be significantly generalized (in several different ways). \begin{lemma} \label{lemma-computation-differential} let $k$ be a field. let $r$ be a noetherian local ring containing $k$. assume that the residue field $\kappa = r/\mathfrak m$ is a finitely generated separable extension of $k$. then the map $$ \text{d} : \mathfrak m/\mathfrak m^2 \longrightarrow \omega_{r/k} \otimes_r \kappa(\mathfrak m) $$ is injective. \end{lemma} \begin{proof} we may replace $r$ by $r/\mathfrak m^2$. hence we may assume that $\mathfrak m^2 = 0$. by assumption we may write $\kappa = k(\overline{x}_1, \ldots, \overline{x}_r, \overline{y})$ where $\overline{x}_1, \ldots, \overline{x}_r$ is a transcendence basis of $\kappa$ over $k$ and $\overline{y}$ is separable algebraic over $k(\overline{x}_1, \ldots, \overline{x}_r)$. say its minimal equation is $p(\overline{y}) = 0$ with $p(t) = t^d + \sum_{i < d} a_it^i$, with $a_i \in k(\overline{x}_1, \ldots, \overline{x}_r)$ and $p'(\overline{y}) \not = 0$. choose any lifts $x_i \in r$ of the elements $\overline{x}_i \in \kappa$. this gives a commutative diagram $$ \xymatrix{ r \ar[r] & \kappa \\ & k(\overline{x}_1, \ldots, \overline{x}_r) \ar[lu]^\varphi \ar[u] } $$ of $k$-algebras. we want to extend the left upwards arrow $\varphi$ to a $k$-algebra map from $\kappa$ to $r$. to do this choose any $y \in r$ lifting $\overline{y}$. to see that it defines a $k$-algebra map defined on $\kappa \cong k(\overline{x}_1, \ldots, \overline{x}_r)[t]/(p)$ all we have to show is that we may choose $y$ such that $p^\varphi(y) = 0$. if not then we compute for $\delta \in \mathfrak m$ that $$ p(y + \delta) = p(y) + p'(y)\delta $$ because $\mathfrak m^2 = 0$. since $p'(y)\delta = p'(\overline{y})\delta$ we see that we can adjust our choice as desired. this shows that $r \cong \kappa \oplus \mathfrak m$ as $k$-algebras! now either a direct computation of $\omega_{\kappa \oplus \mathfrak m/k}$ or an application of lemma \ref{lemma-differential-seq-split} finishes the proof. \end{proof} \begin{lemma} \label{lemma-separable-smooth} let $k$ be a field. let $s$ be a finite type $k$-algebra. let $\mathfrak q \subset s$ be a prime. assume $\kappa(\mathfrak q)$ is separable over $k$. the following are equivalent: \begin{enumerate} \item the algebra $s$ is smooth at $\mathfrak q$ over $k$. \item the ring $s_{\mathfrak q}$ is regular. \end{enumerate} \end{lemma} \begin{proof} denote $r = s_{\mathfrak q}$ and denote its maximal by $\mathfrak m$ and its residue field $\kappa$. by lemma \ref{lemma-computation-differential} and \ref{lemma-differential-seq} we see that there is a short exact sequence $$ 0 \to \mathfrak m/\mathfrak m^2 \to \omega_{r/k} \otimes_r \kappa \to \omega_{\kappa/k} \to 0 $$ note that $\omega_{r/k} = \omega_{s/k, \mathfrak q}$, see lemma \ref{lemma-differentials-localize}. moreover, since $\kappa$ is separable over $k$ we have $\dim_{\kappa} \omega_{\kappa/k} = \text{trdeg}_k(\kappa)$. hence we get $$ \dim_{\kappa} \omega_{r/k} \otimes_r \kappa = \dim_\kappa \mathfrak m/\mathfrak m^2 + \text{trdeg}_k (\kappa) \geq \dim r + \text{trdeg}_k (\kappa) = \dim_{\mathfrak q} s $$ (see lemma \ref{lemma-dimension-at-a-point-finite-type-field} for the last equality) with equality if and only if $r$ is regular. thus we win by applying lemma \ref{lemma-characterize-smooth-over-field}. \end{proof} \begin{lemma} \label{lemma-characteristic-zero} let $r \to s$ be a $\mathbf{q}$-algebra map. let $f \in s$ be such that $\omega_{s/r} = s \text{d}f \oplus c$ for some $s$-submodule $c$. then \begin{enumerate} \item $f$ is not nilpotent, and \item if $s$ is a noetherian local ring, then $f$ is a nonzerodivisor in $s$. \end{enumerate} \end{lemma} \begin{proof} for $a \in s$ write $\text{d}(a) = \theta(a)\text{d}f + c(a)$ for some $\theta(a) \in s$ and $c(a) \in c$. consider the $r$-derivation $s \to s$, $a \mapsto \theta(a)$. note that $\theta(f) = 1$. \medskip\noindent if $f^n = 0$ with $n > 1$ minimal, then $0 = \theta(f^n) = n f^{n - 1}$ contradicting the minimality of $n$. we conclude that $f$ is not nilpotent. \medskip\noindent suppose $fa = 0$. if $f$ is a unit then $a = 0$ and we win. assume $f$ is not a unit. then $0 = \theta(fa) = f\theta(a) + a$ by the leibniz rule and hence $a \in (f)$. by induction suppose we have shown $fa = 0 \rightarrow a \in (f^n)$. then writing $a = f^nb$ we get $0 = \theta(f^{n + 1}b) = (n + 1)f^nb + f^{n + 1}\theta(b)$. hence $a = f^n b = -f^{n + 1}\theta(b)/(n + 1) \in (f^{n + 1})$. since in the noetherian local ring $s$ we have $\bigcap (f^n) = 0$, see lemma \ref{lemma-intersect-powers-ideal-module-zero} we win. \end{proof} \noindent the following is probably quite useless in applications. \begin{lemma} \label{lemma-characteristic-zero-local-smooth} let $k$ be a field of characteristic $0$. let $s$ be a finite type $k$-algebra. let $\mathfrak q \subset s$ be a prime. the following are equivalent: \begin{enumerate} \item the algebra $s$ is smooth at $\mathfrak q$ over $k$. \item the $s_{\mathfrak q}$-module $\omega_{s/k, \mathfrak q}$ is (finite) free. \item the ring $s_{\mathfrak q}$ is regular. \end{enumerate} \end{lemma} \begin{proof} in characteristic zero any field extension is separable and hence the equivalence of (1) and (3) follows from lemma \ref{lemma-separable-smooth}. also (1) implies (2) by definition of smooth algebras. assume that $\omega_{s/k, \mathfrak q}$ is free over $s_{\mathfrak q}$. we are going to use the notation and observations made in the proof of lemma \ref{lemma-separable-smooth}. so $r = s_{\mathfrak q}$ with maximal ideal $\mathfrak m$ and residue field $\kappa$. our goal is to prove $r$ is regular. \medskip\noindent if $\mathfrak m/\mathfrak m^2 = 0$, then $\mathfrak m = 0$ and $r \cong \kappa$. hence $r$ is regular and we win. \medskip\noindent if $\mathfrak m/ \mathfrak m^2 \not = 0$, then choose any $f \in \mathfrak m$ whose image in $\mathfrak m/ \mathfrak m^2$ is not zero. by lemma \ref{lemma-computation-differential} we see that $\text{d}f$ has nonzero image in $\omega_{r/k}/\mathfrak m\omega_{r/k}$. by assumption $\omega_{r/k} = \omega_{s/k, \mathfrak q}$ is finite free and hence by nakayama's lemma \ref{lemma-nak} we see that $\text{d}f$ generates a direct summand. we apply lemma \ref{lemma-characteristic-zero} to deduce that $f$ is a nonzerodivisor in $r$. furthermore, by lemma \ref{lemma-differential-seq} we get an exact sequence $$ (f)/(f^2) \to \omega_{r/k} \otimes_r r/fr \to \omega_{(r/fr)/k} \to 0 $$ this implies that $\omega_{(r/fr)/k}$ is finite free as well. hence by induction we see that $r/fr$ is a regular local ring. since $f \in \mathfrak m$ was a nonzerodivisor we conclude that $r$ is regular, see lemma \ref{lemma-regular-mod-x}. \end{proof} \begin{example} \label{example-characteristic-p} lemma \ref{lemma-characteristic-zero-local-smooth} does not hold in characteristic $p > 0$. the standard examples are the ring maps $$ \mathbf{f}_p \longrightarrow \mathbf{f}_p[x]/(x^p) $$ whose module of differentials is free but is clearly not smooth, and the ring map ($p > 2$) $$ \mathbf{f}_p(t) \to \mathbf{f}_p(t)[x, y]/(x^p + y^2 + \alpha) $$ which is not smooth at the prime $\mathfrak q = (y, x^p + \alpha)$ but is regular. \end{example} \noindent using the material above we can characterize smoothness at the generic point in terms of field extensions. \begin{lemma} \label{lemma-smooth-at-generic-point} let $r \to s$ be an injective finite type ring map with $r$ and $s$ domains. then $r \to s$ is smooth at $\mathfrak q = (0)$ if and only if the induced extension $l/k$ of fraction fields is separable. \end{lemma} \begin{proof} assume $r \to s$ is smooth at $(0)$. we may replace $s$ by $s_g$ for some nonzero $g \in s$ and assume that $r \to s$ is smooth. then $k \to s \otimes_r k$ is smooth (lemma \ref{lemma-base-change-smooth}). moreover, for any field extension $k'/k$ the ring map $k' \to s \otimes_r k'$ is smooth as well. hence $s \otimes_r k'$ is a regular ring by lemma \ref{lemma-characterize-smooth-over-field}, in particular reduced. it follows that $s \otimes_r k$ is a geometrically reduced over $k$. hence $l$ is geometrically reduced over $k$, see lemma \ref{lemma-geometrically-reduced-permanence}. hence $l/k$ is separable by lemma \ref{lemma-characterize-separable-field-extensions}. \medskip\noindent conversely, assume that $l/k$ is separable. we may assume $r \to s$ is of finite presentation, see lemma \ref{lemma-generic-finite-presentation}. it suffices to prove that $k \to s \otimes_r k$ is smooth at $(0)$, see lemma \ref{lemma-flat-base-change-locus-smooth}. this follows from lemma \ref{lemma-separable-smooth}, the fact that a field is a regular ring, and the assumption that $l/k$ is separable. \end{proof} \section{smooth ring maps in the noetherian case} \label{section-smooth-noetherian} \begin{definition} \label{definition-small-extension} let $\varphi : b' \to b$ be a ring map. we say $\varphi$ is a {\it small extension} if $b'$ and $b$ are local artinian rings, $\varphi$ is surjective and $i = \ker(\varphi)$ has length $1$ as a $b'$-module. \end{definition} \noindent clearly this means that $i^2 = 0$ and that $i = (x)$ for some $x \in b'$ such that $\mathfrak m' x = 0$ where $\mathfrak m' \subset b'$ is the maximal ideal. \begin{lemma} \label{lemma-smooth-test-artinian} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime ideal of $s$ lying over $\mathfrak p \subset r$. assume $r$ is noetherian and $r \to s$ of finite type. the following are equivalent: \begin{enumerate} \item $r \to s$ is smooth at $\mathfrak q$, \item for every surjection of local $r$-algebras $(b', \mathfrak m') \to (b, \mathfrak m)$ with $\ker(b' \to b)$ having square zero and every solid commutative diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & b \\ r \ar[r] \ar[u] & b' \ar[u] } $$ such that $\mathfrak q = s \cap \mathfrak m$ there exists a dotted arrow making the diagram commute, \item same as in (2) but with $b' \to b$ ranging over small extensions, and \item same as in (2) but with $b' \to b$ ranging over small extensions such that in addition $s \to b$ induces an isomorphism $\kappa(\mathfrak q) \cong \kappa(\mathfrak m)$. \end{enumerate} \end{lemma} \begin{proof} assume (1). this means there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is smooth. by proposition \ref{proposition-smooth-formally-smooth} we know that $r \to s_g$ is formally smooth. note that given any diagram as in (2) the map $s \to b$ factors automatically through $s_{\mathfrak q}$ and a fortiori through $s_g$. the formal smoothness of $s_g$ over $r$ gives us a morphism $s_g \to b'$ fitting into a similar diagram with $s_g$ at the upper left corner. composing with $s \to s_g$ gives the desired arrow. in other words, we have shown that (1) implies (2). \medskip\noindent clearly (2) implies (3) and (3) implies (4). \medskip\noindent assume (4). we are going to show that (1) holds, thereby finishing the proof of the lemma. choose a presentation $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$. this is possible as $s$ is of finite type over $r$ and therefore of finite presentation (see lemma \ref{lemma-noetherian-finite-type-is-finite-presentation}). set $i = (f_1, \ldots, f_m)$. consider the naive cotangent complex $$ \text{d} : i/i^2 \longrightarrow \bigoplus\nolimits_{j = 1}^n s\text{d}x_j $$ of this presentation (see section \ref{section-netherlander}). it suffices to show that when we localize this complex at $\mathfrak q$ then the map becomes a split injection, see lemma \ref{lemma-smooth-at-point}. denote $s' = r[x_1, \ldots, x_n]/i^2$. by lemma \ref{lemma-differential-mod-power-ideal} we have $$ s \otimes_{s'} \omega_{s'/r} = s \otimes_{r[x_1, \ldots, x_n]} \omega_{r[x_1, \ldots, x_n]/r} = \bigoplus\nolimits_{j = 1}^m s\text{d}x_j. $$ thus the map $$ \text{d} : i/i^2 \longrightarrow s \otimes_{s'} \omega_{s'/r} $$ is the same as the map in the naive cotangent complex above. in particular the truth of the assertion we are trying to prove depends only on the three rings $r \to s' \to s$. let $\mathfrak q' \subset r[x_1, \ldots, x_n]$ be the prime ideal corresponding to $\mathfrak q$. since localization commutes with taking modules of differentials (lemma \ref{lemma-differentials-localize}) we see that it suffices to show that the map \begin{equation} \label{equation-target-map} \text{d} : i_{\mathfrak q'}/i_{\mathfrak q'}^2 \longrightarrow s_{\mathfrak q} \otimes_{s'_{\mathfrak q'}} \omega_{s'_{\mathfrak q'}/r} \end{equation} coming from $r \to s'_{\mathfrak q'} \to s_{\mathfrak q}$ is a split injection. \medskip\noindent let $n \in \mathbf{n}$ be an integer. consider the ring $$ b'_n = s'_{\mathfrak q'} / (\mathfrak q')^n s'_{\mathfrak q'} = (s'/(\mathfrak q')^n s')_{\mathfrak q'} $$ and its quotient $b_n = b'_n/ib'_n$. note that $b_n \cong s_{\mathfrak q}/\mathfrak q^ns_{\mathfrak q}$. observe that $b'_n$ is an artinian local ring since it is the quotient of a local noetherian ring by a power of its maximal ideal. consider a filtration of the kernel $i_n$ of $b'_n \to b_n$ by $b'_n$-submodules $$ 0 \subset j_{n, 1} \subset j_{n, 2} \subset \ldots \subset j_{n, n(n)} = i_n $$ such that each successive quotient $j_{n, i}/j_{n, i - 1}$ has length $1$. (as $b'_n$ is artinian such a filtration exists.) this gives a sequence of small extensions $$ b'_n \to b'_n/j_{n, 1} \to b'_n/j_{n, 2} \to \ldots \to b'_n/j_{n, n(n)} = b'_n/i_n = b_n = s_{\mathfrak q}/\mathfrak q^ns_{\mathfrak q} $$ applying condition (4) successively to these small extensions starting with the map $s \to b_n$ we see there exists a commutative diagram $$ \xymatrix{ s \ar[r] \ar[rd] & b_n \\ r \ar[r] \ar[u] & b'_n \ar[u] } $$ clearly the ring map $s \to b'_n$ factors as $s \to s_{\mathfrak q} \to b'_n$ where $s_{\mathfrak q} \to b'_n$ is a local homomorphism of local rings. moreover, since the maximal ideal of $b'_n$ to the $n$th power is zero we conclude that $s_{\mathfrak q} \to b'_n$ factors through $s_{\mathfrak q}/(\mathfrak q)^ns_{\mathfrak q} = b_n$. in other words we have shown that for all $n \in \mathbf{n}$ the surjection of $r$-algebras $b'_n \to b_n$ has a splitting. \medskip\noindent consider the presentation $$ i_n \to b_n \otimes_{b'_n} \omega_{b'_n/r} \to \omega_{b_n/r} \to 0 $$ coming from the surjection $b'_n \to b_n$ with kernel $i_n$ (see lemma \ref{lemma-differential-seq}). by the above the $r$-algebra map $b'_n \to b_n$ has a right inverse. hence by lemma \ref{lemma-differential-seq-split} we see that the sequence above is split exact! thus for every $n$ the map $$ i_n \longrightarrow b_n \otimes_{b'_n} \omega_{b'_n/r} $$ is a split injection. the rest of the proof is gotten by unwinding what this means exactly. note that $$ i_n = i_{\mathfrak q'}/ (i_{\mathfrak q'}^2 + (\mathfrak q')^n \cap i_{\mathfrak q'}) $$ by artin-rees (lemma \ref{lemma-artin-rees}) we find a $c \geq 0$ such that $$ s_{\mathfrak q}/\mathfrak q^{n - c}s_{\mathfrak q} \otimes_{s_{\mathfrak q}} i_n = s_{\mathfrak q}/\mathfrak q^{n - c}s_{\mathfrak q} \otimes_{s_{\mathfrak q}} i_{\mathfrak q'}/i_{\mathfrak q'}^2 $$ for all $n \geq c$ (these tensor product are just a fancy way of dividing by $\mathfrak q^{n - c}$). we may of course assume $c \geq 1$. by lemma \ref{lemma-differential-mod-power-ideal} we see that $$ s'_{\mathfrak q'}/(\mathfrak q')^{n - c}s'_{\mathfrak q'} \otimes_{s'_{\mathfrak q'}} \omega_{b'_n/r} = s'_{\mathfrak q'}/(\mathfrak q')^{n - c}s'_{\mathfrak q'} \otimes_{s'_{\mathfrak q'}} \omega_{s'_{\mathfrak q'}/r} $$ we can further tensor this by $b_n = s_{\mathfrak q}/\mathfrak q^n$ to see that $$ s_{\mathfrak q}/\mathfrak q^{n - c}s_{\mathfrak q} \otimes_{s'_{\mathfrak q'}} \omega_{b'_n/r} = s_{\mathfrak q}/\mathfrak q^{n - c}s_{\mathfrak q} \otimes_{s'_{\mathfrak q'}} \omega_{s'_{\mathfrak q'}/r}. $$ since a split injection remains a split injection after tensoring with anything we see that $$ s_{\mathfrak q}/\mathfrak q^{n - c}s_{\mathfrak q} \otimes_{s_{\mathfrak q}} (\ref{equation-target-map}) = s_{\mathfrak q}/\mathfrak q^{n - c}s_{\mathfrak q} \otimes_{s_{\mathfrak q}/\mathfrak q^n s_{\mathfrak q}} (i_n \longrightarrow b_n \otimes_{b'_n} \omega_{b'_n/r}) $$ is a split injection for all $n \geq c$. by lemma \ref{lemma-split-injection-after-completion} we see that (\ref{equation-target-map}) is a split injection. this finishes the proof. \end{proof} \section{overview of results on smooth ring maps} \label{section-smooth-overview} \noindent here is a list of results on smooth ring maps that we proved in the preceding sections. for more precise statements and definitions please consult the references given. \begin{enumerate} \item a ring map $r \to s$ is smooth if it is of finite presentation and the naive cotangent complex of $s/r$ is quasi-isomorphic to a finite projective $s$-module in degree $0$, see definition \ref{definition-smooth}. \item if $s$ is smooth over $r$, then $\omega_{s/r}$ is a finite projective $s$-module, see discussion following definition \ref{definition-smooth}. \item the property of being smooth is local on $s$, see lemma \ref{lemma-locally-smooth}. \item the property of being smooth is stable under base change, see lemma \ref{lemma-base-change-smooth}. \item the property of being smooth is stable under composition, see lemma \ref{lemma-compose-smooth}. \item a smooth ring map is syntomic, in particular flat, see lemma \ref{lemma-smooth-syntomic}. \item a finitely presented, flat ring map with smooth fibre rings is smooth, see lemma \ref{lemma-flat-fibre-smooth}. \item a finitely presented ring map $r \to s$ is smooth if and only if it is formally smooth, see proposition \ref{proposition-smooth-formally-smooth}. \item if $r \to s$ is a finite type ring map with $r$ noetherian then to check that $r \to s$ is smooth it suffices to check the lifting property of formal smoothness along small extensions of artinian local rings, see lemma \ref{lemma-smooth-test-artinian}. \item a smooth ring map $r \to s$ is the base change of a smooth ring map $r_0 \to s_0$ with $r_0$ of finite type over $\mathbf{z}$, see lemma \ref{lemma-finite-presentation-fs-noetherian}. \item formation of the set of points where a ring map is smooth commutes with flat base change, see lemma \ref{lemma-flat-base-change-locus-smooth}. \item if $s$ is of finite type over an algebraically closed field $k$, and $\mathfrak m \subset s$ a maximal ideal, then the following are equivalent \begin{enumerate} \item $s$ is smooth over $k$ in a neighbourhood of $\mathfrak m$, \item $s_{\mathfrak m}$ is a regular local ring, \item $\dim(s_{\mathfrak m}) = \dim_{\kappa(m)} \omega_{s/k} \otimes_s \kappa(\mathfrak m)$. \end{enumerate} see lemma \ref{lemma-characterize-smooth-kbar}. \item if $s$ is of finite type over a field $k$, and $\mathfrak q \subset s$ a prime ideal, then the following are equivalent \begin{enumerate} \item $s$ is smooth over $k$ in a neighbourhood of $\mathfrak q$, \item $\dim_{\mathfrak q}(s/k) = \dim_{\kappa(\mathfrak q)} \omega_{s/k} \otimes_s \kappa(\mathfrak q)$. \end{enumerate} see lemma \ref{lemma-characterize-smooth-over-field}. \item if $s$ is smooth over a field, then all its local rings are regular, see lemma \ref{lemma-characterize-smooth-over-field}. \item if $s$ is of finite type over a field $k$, $\mathfrak q \subset s$ a prime ideal, the field extension $\kappa(\mathfrak q)/k$ is separable and $s_{\mathfrak q}$ is regular, then $s$ is smooth over $k$ at $\mathfrak q$, see lemma \ref{lemma-separable-smooth}. \item if $s$ is of finite type over a field $k$, if $k$ has characteristic $0$, if $\mathfrak q \subset s$ a prime ideal, and if $\omega_{s/k, \mathfrak q}$ is free, then $s$ is smooth over $k$ at $\mathfrak q$, see lemma \ref{lemma-characteristic-zero-local-smooth}. \end{enumerate} some of these results were proved using the notion of a standard smooth ring map, see definition \ref{definition-standard-smooth}. this is the analogue of what a relative global complete intersection map is for the case of syntomic morphisms. it is also the easiest way to make examples. \section{\'etale ring maps} \label{section-etale} \noindent an \'etale ring map is a smooth ring map whose relative dimension is equal to zero. this is the same as the following slightly more direct definition. \begin{definition} \label{definition-etale} let $r \to s$ be a ring map. we say $r \to s$ is {\it \'etale} if it is of finite presentation and the naive cotangent complex $\nl_{s/r}$ is quasi-isomorphic to zero: this means that $h_1(\nl_{s/r}) = 0$ and $\omega_{s/r} = 0$. given a prime $\mathfrak q$ of $s$ we say that $r \to s$ is {\it \'etale at $\mathfrak q$} if there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is \'etale. \end{definition} \noindent in particular we see that $\omega_{s/r} = 0$ if $s$ is \'etale over $r$. if $r \to s$ is smooth, then $r \to s$ is \'etale if and only if $\omega_{s/r} = 0$. from our results on smooth ring maps we automatically get a whole host of results for \'etale maps. we summarize these in lemma \ref{lemma-etale} below. but before we do so we prove that {\it any} \'etale ring map is standard smooth. \begin{lemma} \label{lemma-etale-standard-smooth} any \'etale ring map is standard smooth. more precisely, if $r \to s$ is \'etale, then there exists a presentation $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_n)$ such that the image of $\det(\partial f_j/\partial x_i)$ is invertible in $s$. \end{lemma} \begin{proof} let $r \to s$ be \'etale. choose a presentation $s = r[x_1, \ldots, x_n]/i$. as $r \to s$ is \'etale we know that $$ \text{d} : i/i^2 \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} s\text{d}x_i $$ is an isomorphism, in particular $i/i^2$ is a free $s$-module. thus by lemma \ref{lemma-huber} we may assume (after possibly changing the presentation), that $i = (f_1, \ldots, f_c)$ such that the classes $f_i \bmod i^2$ form a basis of $i/i^2$. it follows immediately from the fact that the displayed map above is an isomorphism that $c = n$ and that $\det(\partial f_j/\partial x_i)$ is invertible in $s$. \end{proof} \begin{lemma} \label{lemma-etale} results on \'etale ring maps. \begin{enumerate} \item the ring map $r \to r_f$ is \'etale for any ring $r$ and any $f \in r$. \item compositions of \'etale ring maps are \'etale. \item a base change of an \'etale ring map is \'etale. \item the property of being \'etale is local: given a ring map $r \to s$ and elements $g_1, \ldots, g_m \in s$ which generate the unit ideal such that $r \to s_{g_j}$ is \'etale for $j = 1, \ldots, m$ then $r \to s$ is \'etale. \item given $r \to s$ of finite presentation, and a flat ring map $r \to r'$, set $s' = r' \otimes_r s$. the set of primes where $r' \to s'$ is \'etale is the inverse image via $\spec(s') \to \spec(s)$ of the set of primes where $r \to s$ is \'etale. \item an \'etale ring map is syntomic, in particular flat. \item if $s$ is finite type over a field $k$, then $s$ is \'etale over $k$ if and only if $\omega_{s/k} = 0$. \item any \'etale ring map $r \to s$ is the base change of an \'etale ring map $r_0 \to s_0$ with $r_0$ of finite type over $\mathbf{z}$. \item let $a = \colim a_i$ be a filtered colimit of rings. let $a \to b$ be an \'etale ring map. then there exists an \'etale ring map $a_i \to b_i$ for some $i$ such that $b \cong a \otimes_{a_i} b_i$. \item let $a$ be a ring. let $s$ be a multiplicative subset of $a$. let $s^{-1}a \to b'$ be \'etale. then there exists an \'etale ring map $a \to b$ such that $b' \cong s^{-1}b$. \item let $a$ be a ring. let $b = b' \times b''$ be a product of $a$-algebras. then $b$ is \'etale over $a$ if and only if both $b'$ and $b''$ are \'etale over $a$. \end{enumerate} \end{lemma} \begin{proof} in each case we use the corresponding result for smooth ring maps with a small argument added to show that $\omega_{s/r}$ is zero. \medskip\noindent proof of (1). the ring map $r \to r_f$ is smooth and $\omega_{r_f/r} = 0$. \medskip\noindent proof of (2). the composition $a \to c$ of smooth maps $a \to b$ and $b \to c$ is smooth, see lemma \ref{lemma-compose-smooth}. by lemma \ref{lemma-exact-sequence-differentials} we see that $\omega_{c/a}$ is zero as both $\omega_{c/b}$ and $\omega_{b/a}$ are zero. \medskip\noindent proof of (3). let $r \to s$ be \'etale and $r \to r'$ be arbitrary. then $r' \to s' = r' \otimes_r s$ is smooth, see lemma \ref{lemma-base-change-smooth}. since $\omega_{s'/r'} = s' \otimes_s \omega_{s/r}$ by lemma \ref{lemma-differentials-base-change} we conclude that $\omega_{s'/r'} = 0$. hence $r' \to s'$ is \'etale. \medskip\noindent proof of (4). assume the hypotheses of (4). by lemma \ref{lemma-locally-smooth} we see that $r \to s$ is smooth. we are also given that $\omega_{s_{g_i}/r} = (\omega_{s/r})_{g_i} = 0$ for all $i$. then $\omega_{s/r} = 0$, see lemma \ref{lemma-cover}. \medskip\noindent proof of (5). the result for smooth maps is lemma \ref{lemma-flat-base-change-locus-smooth}. in the proof of that lemma we used that $\nl_{s/r} \otimes_s s'$ is homotopy equivalent to $\nl_{s'/r'}$. this reduces us to showing that if $m$ is a finitely presented $s$-module the set of primes $\mathfrak q'$ of $s'$ such that $(m \otimes_s s')_{\mathfrak q'} = 0$ is the inverse image of the set of primes $\mathfrak q$ of $s$ such that $m_{\mathfrak q} = 0$. this follows from lemma \ref{lemma-support-base-change}. \medskip\noindent proof of (6). follows directly from the corresponding result for smooth ring maps (lemma \ref{lemma-smooth-syntomic}). \medskip\noindent proof of (7). follows from lemma \ref{lemma-characterize-smooth-over-field} and the definitions. \medskip\noindent proof of (8). lemma \ref{lemma-finite-presentation-fs-noetherian} gives the result for smooth ring maps. the resulting smooth ring map $r_0 \to s_0$ satisfies the hypotheses of lemma \ref{lemma-relative-dimension-cm}, and hence we may replace $s_0$ by the factor of relative dimension $0$ over $r_0$. \medskip\noindent proof of (9). follows from (8) since $r_0 \to a$ will factor through $a_i$ for some $i$ by lemma \ref{lemma-characterize-finite-presentation}. \medskip\noindent proof of (10). follows from (9), (1), and (2) since $s^{-1}a$ is a filtered colimit of principal localizations of $a$. \medskip\noindent proof of (11). use lemma \ref{lemma-product-smooth} to see the result for smoothness and then use that $\omega_{b/a}$ is zero if and only if both $\omega_{b'/a}$ and $\omega_{b''/a}$ are zero. \end{proof} \noindent next we work out in more detail what it means to be \'etale over a field. \begin{lemma} \label{lemma-etale-over-field} let $k$ be a field. a ring map $k \to s$ is \'etale if and only if $s$ is isomorphic as a $k$-algebra to a finite product of finite separable extensions of $k$. \end{lemma} \begin{proof} we are going to use without further mention: if $s = s_1 \times \ldots \times s_n$ is a finite product of $k$-algebras, then $s$ is \'etale over $k$ if and only if each $s_i$ is \'etale over $k$. see lemma \ref{lemma-etale} part (11). \medskip\noindent if $k'/k$ is a finite separable field extension then we can write $k' = k(\alpha) \cong k[x]/(f)$. here $f$ is the minimal polynomial of the element $\alpha$. since $k'$ is separable over $k$ we have $\gcd(f, f') = 1$. this implies that $\text{d} : k'\cdot f \to k' \cdot \text{d}x$ is an isomorphism. hence $k \to k'$ is \'etale. thus if $s$ is a finite product of finite separable extensions of $k$, then $s$ is \'etale over $k$. \medskip\noindent conversely, suppose that $k \to s$ is \'etale. then $s$ is smooth over $k$ and $\omega_{s/k} = 0$. by lemma \ref{lemma-characterize-smooth-over-field} we see that $\dim_\mathfrak m \spec(s) = 0$ for every maximal ideal $\mathfrak m$ of $s$. thus $\dim(s) = 0$. by proposition \ref{proposition-dimension-zero-ring} we find that $s$ is a finite product of artinian local rings. by the already used lemma \ref{lemma-characterize-smooth-over-field} these local rings are fields. hence we may assume $s = k'$ is a field. by the hilbert nullstellensatz (theorem \ref{theorem-nullstellensatz}) we see that the extension $k'/k$ is finite. the smoothness of $k \to k'$ implies by lemma \ref{lemma-smooth-at-generic-point} that $k'/k$ is a separable extension and the proof is complete. \end{proof} \begin{lemma} \label{lemma-etale-at-prime} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p$ in $r$. if $s/r$ is \'etale at $\mathfrak q$ then \begin{enumerate} \item we have $\mathfrak p s_{\mathfrak q} = \mathfrak qs_{\mathfrak q}$ is the maximal ideal of the local ring $s_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is finite separable. \end{enumerate} \end{lemma} \begin{proof} first we may replace $s$ by $s_g$ for some $g \in s$, $g \not \in \mathfrak q$ and assume that $r \to s$ is \'etale. then the lemma follows from lemma \ref{lemma-etale-over-field} by unwinding the fact that $s \otimes_r \kappa(\mathfrak p)$ is \'etale over $\kappa(\mathfrak p)$. \end{proof} \begin{lemma} \label{lemma-etale-quasi-finite} an \'etale ring map is quasi-finite. \end{lemma} \begin{proof} let $r \to s$ be an \'etale ring map. by definition $r \to s$ is of finite type. for any prime $\mathfrak p \subset r$ the fibre ring $s \otimes_r \kappa(\mathfrak p)$ is \'etale over $\kappa(\mathfrak p)$ and hence a finite products of fields finite separable over $\kappa(\mathfrak p)$, in particular finite over $\kappa(\mathfrak p)$. thus $r \to s$ is quasi-finite by lemma \ref{lemma-quasi-finite}. \end{proof} \begin{lemma} \label{lemma-characterize-etale} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime of $s$ lying over a prime $\mathfrak p$ of $r$. if \begin{enumerate} \item $r \to s$ is of finite presentation, \item $r_{\mathfrak p} \to s_{\mathfrak q}$ is flat \item $\mathfrak p s_{\mathfrak q}$ is the maximal ideal of the local ring $s_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is finite separable, \end{enumerate} then $r \to s$ is \'etale at $\mathfrak q$. \end{lemma} \begin{proof} apply lemma \ref{lemma-isolated-point-fibre} to find a $g \in s$, $g \not \in \mathfrak q$ such that $\mathfrak q$ is the only prime of $s_g$ lying over $\mathfrak p$. we may and do replace $s$ by $s_g$. then $s \otimes_r \kappa(\mathfrak p)$ has a unique prime, hence is a local ring, hence is equal to $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q} \cong \kappa(\mathfrak q)$. by lemma \ref{lemma-flat-fibre-smooth} there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is smooth. replace $s$ by $s_g$ again we may assume that $r \to s$ is smooth. by lemma \ref{lemma-smooth-syntomic} we may even assume that $r \to s$ is standard smooth, say $s = r[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. since $s \otimes_r \kappa(\mathfrak p) = \kappa(\mathfrak q)$ has dimension $0$ we conclude that $n = c$, i.e., $r \to s$ is \'etale. \end{proof} \noindent here is a completely new phenomenon. \begin{lemma} \label{lemma-map-between-etale} let $r \to s$ and $r \to s'$ be \'etale. then any $r$-algebra map $s' \to s$ is \'etale. \end{lemma} \begin{proof} first of all we note that $s' \to s$ is of finite presentation by lemma \ref{lemma-compose-finite-type}. let $\mathfrak q \subset s$ be a prime ideal lying over the primes $\mathfrak q' \subset s'$ and $\mathfrak p \subset r$. by lemma \ref{lemma-etale-at-prime} the ring map $s'_{\mathfrak q'}/\mathfrak p s'_{\mathfrak q'} \to s_{\mathfrak q}/\mathfrak p s_{\mathfrak q}$ is a map of finite separable extensions of $\kappa(\mathfrak p)$. in particular it is flat. hence by lemma \ref{lemma-criterion-flatness-fibre} we see that $s'_{\mathfrak q'} \to s_{\mathfrak q}$ is flat. thus $s' \to s$ is flat. moreover, the above also shows that $\mathfrak q's_{\mathfrak q}$ is the maximal ideal of $s_{\mathfrak q}$ and that the residue field extension of $s'_{\mathfrak q'} \to s_{\mathfrak q}$ is finite separable. hence from lemma \ref{lemma-characterize-etale} we conclude that $s' \to s$ is \'etale at $\mathfrak q$. since being \'etale is local (see lemma \ref{lemma-etale}) we win. \end{proof} \begin{lemma} \label{lemma-surjective-flat-finitely-presented} let $\varphi : r \to s$ be a ring map. if $r \to s$ is surjective, flat and finitely presented then there exist an idempotent $e \in r$ such that $s = r_e$. \end{lemma} \begin{proof}[first proof] let $i$ be the kernel of $\varphi$. we have that $i$ is finitely generated by lemma \ref{lemma-finite-presentation-independent} since $\varphi$ is of finite presentation. moreover, since $s$ is flat over $r$, tensoring the exact sequence $0 \to i \to r \to s \to 0$ over $r$ with $s$ gives $i/i^2 = 0$. now we conclude by lemma \ref{lemma-ideal-is-squared-union-connected}. \end{proof} \begin{proof}[second proof] since $\spec(s) \to \spec(r)$ is a homeomorphism onto a closed subset (see lemma \ref{lemma-spec-closed}) and is open (see proposition \ref{proposition-fppf-open}) we see that the image is $d(e)$ for some idempotent $e \in r$ (see lemma \ref{lemma-disjoint-decomposition}). thus $r_e \to s$ induces a bijection on spectra. now this map induces an isomorphism on all local rings for example by lemmas \ref{lemma-finite-flat-local} and \ref{lemma-nak}. then it follows that $r_e \to s$ is also injective, for example see lemma \ref{lemma-characterize-zero-local}. \end{proof} \begin{lemma} \label{lemma-lift-etale} \begin{slogan} \'etale ring maps lift along surjections of rings \end{slogan} let $r$ be a ring and let $i \subset r$ be an ideal. let $r/i \to \overline{s}$ be an \'etale ring map. then there exists an \'etale ring map $r \to s$ such that $\overline{s} \cong s/is$ as $r/i$-algebras. \end{lemma} \begin{proof} by lemma \ref{lemma-etale-standard-smooth} we can write $\overline{s} = (r/i)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_n)$ as in definition \ref{definition-standard-smooth} with $\overline{\delta} = \det(\frac{\partial \overline{f}_i}{\partial x_j})_{i, j = 1, \ldots, n}$ invertible in $\overline{s}$. just take some lifts $f_i$ and set $s = r[x_1, \ldots, x_n, x_{n+1}]/(f_1, \ldots, f_n, x_{n + 1}\delta - 1)$ where $\delta = \det(\frac{\partial f_i}{\partial x_j})_{i, j = 1, \ldots, n}$ as in example \ref{example-make-standard-smooth}. this proves the lemma. \end{proof} \begin{lemma} \label{lemma-lift-etale-infinitesimal} consider a commutative diagram $$ \xymatrix{ 0 \ar[r] & j \ar[r] & b' \ar[r] & b \ar[r] & 0 \\ 0 \ar[r] & i \ar[r] \ar[u] & a' \ar[r] \ar[u] & a \ar[r] \ar[u] & 0 } $$ with exact rows where $b' \to b$ and $a' \to a$ are surjective ring maps whose kernels are ideals of square zero. if $a \to b$ is \'etale, and $j = i \otimes_a b$, then $a' \to b'$ is \'etale. \end{lemma} \begin{proof} by lemma \ref{lemma-lift-etale} there exists an \'etale ring map $a' \to c$ such that $c/ic = b$. then $a' \to c$ is formally smooth (by proposition \ref{proposition-smooth-formally-smooth}) hence we get an $a'$-algebra map $\varphi : c \to b'$. since $a' \to c$ is flat we have $i \otimes_a b = i \otimes_a c/ic = ic$. hence the assumption that $j = i \otimes_a b$ implies that $\varphi$ induces an isomorphism $ic \to j$ and an isomorphism $c/ic \to b'/ib'$, whence $\varphi$ is an isomorphism. \end{proof} \begin{example} \label{example-factor-polynomials-etale} let $n , m \geq 1$ be integers. consider the ring map \begin{eqnarray*} r = \mathbf{z}[a_1, \ldots, a_{n + m}] & \longrightarrow & s = \mathbf{z}[b_1, \ldots, b_n, c_1, \ldots, c_m] \\ a_1 & \longmapsto & b_1 + c_1 \\ a_2 & \longmapsto & b_2 + b_1 c_1 + c_2 \\ \ldots & \ldots & \ldots \\ a_{n + m} & \longmapsto & b_n c_m \end{eqnarray*} of example \ref{example-factor-polynomials}. write symbolically $$ s = r[b_1, \ldots, c_m]/(\{a_k(b_i, c_j) - a_k\}_{k = 1, \ldots, n + m}) $$ where for example $a_1(b_i, c_j) = b_1 + c_1$. the matrix of partial derivatives is $$ \left( \begin{matrix} 1 & c_1 & \ldots & c_m & 0 & \ldots & \ldots & 0 \\ 0 & 1 & c_1 & \ldots & c_m & 0 & \ldots & 0 \\ \ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\ 0 & \ldots & 0 & 1 & c_1 & c_2 & \ldots & c_m \\ 1 & b_1 & \ldots & b_{n - 1} & b_n & 0 & \ldots & 0 \\ 0 & 1 & b_1 & \ldots & b_{n - 1} & b_n & \ldots & 0 \\ \ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\ 0 & \ldots & \ldots & 0 & 1 & b_1 & \ldots & b_n \end{matrix} \right) $$ the determinant $\delta$ of this matrix is better known as the {\it resultant} of the polynomials $g = x^n + b_1 x^{n - 1} + \ldots + b_n$ and $h = x^m + c_1 x^{m - 1} + \ldots + c_m$, and the matrix above is known as the {\it sylvester matrix} associated to $g, h$. in a formula $\delta = \text{res}_x(g, h)$. the sylvester matrix is the transpose of the matrix of the linear map \begin{eqnarray*} s[x]_{< m} \oplus s[x]_{< n} & \longrightarrow & s[x]_{< n + m} \\ a \oplus b & \longmapsto & ag + bh \end{eqnarray*} let $\mathfrak q \subset s$ be any prime. by the above the following are equivalent: \begin{enumerate} \item $r \to s$ is \'etale at $\mathfrak q$, \item $\delta = \text{res}_x(g, h) \not \in \mathfrak q$, \item the images $\overline{g}, \overline{h} \in \kappa(\mathfrak q)[x]$ of the polynomials $g, h$ are relatively prime in $\kappa(\mathfrak q)[x]$. \end{enumerate} the equivalence of (2) and (3) holds because the image of the sylvester matrix in $\text{mat}(n + m, \kappa(\mathfrak q))$ has a kernel if and only if the polynomials $\overline{g}, \overline{h}$ have a factor in common. we conclude that the ring map $$ r \longrightarrow s[\frac{1}{\delta}] = s[\frac{1}{\text{res}_x(g, h)}] $$ is \'etale. \end{example} \begin{lemma} \label{lemma-factor-mod-lift-etale} let $r$ be a ring. let $f \in r[x]$ be a monic polynomial. let $\mathfrak p$ be a prime of $r$. let $f \bmod \mathfrak p = \overline{g} \overline{h}$ be a factorization of the image of $f$ in $\kappa(\mathfrak p)[x]$. if $\gcd(\overline{g}, \overline{h}) = 1$, then there exist \begin{enumerate} \item an \'etale ring map $r \to r'$, \item a prime $\mathfrak p' \subset r'$ lying over $\mathfrak p$, and \item a factorization $f = g h$ in $r'[x]$ \end{enumerate} such that \begin{enumerate} \item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$, \item $\overline{g} = g \bmod \mathfrak p'$, $\overline{h} = h \bmod \mathfrak p'$, and \item the polynomials $g, h$ generate the unit ideal in $r'[x]$. \end{enumerate} \end{lemma} \begin{proof} suppose $\overline{g} = \overline{b}_0 x^n + \overline{b}_1 x^{n - 1} + \ldots + \overline{b}_n$, and $\overline{h} = \overline{c}_0 x^m + \overline{c}_1 x^{m - 1} + \ldots + \overline{c}_m$ with $\overline{b}_0, \overline{c}_0 \in \kappa(\mathfrak p)$ nonzero. after localizing $r$ at some element of $r$ not contained in $\mathfrak p$ we may assume $\overline{b}_0$ is the image of an invertible element $b_0 \in r$. replacing $\overline{g}$ by $\overline{g}/b_0$ and $\overline{h}$ by $b_0\overline{h}$ we reduce to the case where $\overline{g}$, $\overline{h}$ are monic (verification omitted). say $\overline{g} = x^n + \overline{b}_1 x^{n - 1} + \ldots + \overline{b}_n$, and $\overline{h} = x^m + \overline{c}_1 x^{m - 1} + \ldots + \overline{c}_m$. write $f = x^{n + m} + a_1 x^{n + m - 1} + \ldots + a_{n + m}$. consider the fibre product $$ r' = r \otimes_{\mathbf{z}[a_1, \ldots, a_{n + m}]} \mathbf{z}[b_1, \ldots, b_n, c_1, \ldots, c_m] $$ where the map $\mathbf{z}[a_k] \to \mathbf{z}[b_i, c_j]$ is as in examples \ref{example-factor-polynomials} and \ref{example-factor-polynomials-etale}. by construction there is an $r$-algebra map $$ r' = r \otimes_{\mathbf{z}[a_1, \ldots, a_{n + m}]} \mathbf{z}[b_1, \ldots, b_n, c_1, \ldots, c_m] \longrightarrow \kappa(\mathfrak p) $$ which maps $b_i$ to $\overline{b}_i$ and $c_j$ to $\overline{c}_j$. denote $\mathfrak p' \subset r'$ the kernel of this map. since by assumption the polynomials $\overline{g}, \overline{h}$ are relatively prime we see that the element $\delta = \text{res}_x(g, h) \in \mathbf{z}[b_i, c_j]$ (see example \ref{example-factor-polynomials-etale}) does not map to zero in $\kappa(\mathfrak p)$ under the displayed map. we conclude that $r \to r'$ is \'etale at $\mathfrak p'$. in fact a solution to the problem posed in the lemma is the ring map $r \to r'[1/\delta]$ and the prime $\mathfrak p' r'[1/\delta]$. because $\text{res}_x(f, g)$ is invertible in this ring the sylvester matrix is invertible over $r'[1/\delta]$ and hence $1 = a g + b h$ for some $a, b \in r'[1/\delta][x]$ see example \ref{example-factor-polynomials-etale}. \end{proof} \section{local structure of \'etale ring maps} \label{section-etale-local-structure} \noindent lemma \ref{lemma-etale-standard-smooth} tells us that it does not really make sense to define a standard \'etale morphism to be a standard smooth morphism of relative dimension $0$. as a model for an \'etale morphism we take the example given by a finite separable extension $k'/k$ of fields. namely, we can always find an element $\alpha \in k'$ such that $k' = k(\alpha)$ and such that the minimal polynomial $f(x) \in k[x]$ of $\alpha$ has derivative $f'$ which is relatively prime to $f$. \begin{definition} \label{definition-standard-etale} let $r$ be a ring. let $g , f \in r[x]$. assume that $f$ is monic and the derivative $f'$ is invertible in the localization $r[x]_g/(f)$. in this case the ring map $r \to r[x]_g/(f)$ is said to be {\it standard \'etale}. \end{definition} \noindent in proposition \ref{proposition-etale-locally-standard} we show that every \'etale ring map is locally standard \'etale. \begin{lemma} \label{lemma-standard-etale} let $r \to r[x]_g/(f)$ be standard \'etale. \begin{enumerate} \item the ring map $r \to r[x]_g/(f)$ is \'etale. \item for any ring map $r \to r'$ the base change $r' \to r'[x]_g/(f)$ of the standard \'etale ring map $r \to r[x]_g/(f)$ is standard \'etale. \item any principal localization of $r[x]_g/(f)$ is standard \'etale over $r$. \item a composition of standard \'etale maps is {\bf not} standard \'etale in general. \end{enumerate} \end{lemma} \begin{proof} omitted. here is an example for (4). the ring map $\mathbf{f}_2 \to \mathbf{f}_{2^2}$ is standard \'etale. the ring map $\mathbf{f}_{2^2} \to \mathbf{f}_{2^2} \times \mathbf{f}_{2^2} \times \mathbf{f}_{2^2} \times \mathbf{f}_{2^2}$ is standard \'etale. but the ring map $\mathbf{f}_2 \to \mathbf{f}_{2^2} \times \mathbf{f}_{2^2} \times \mathbf{f}_{2^2} \times \mathbf{f}_{2^2}$ is not standard \'etale. \end{proof} \noindent standard \'etale morphisms are a convenient way to produce \'etale maps. here is an example. \begin{lemma} \label{lemma-make-etale-map-prescribed-residue-field} let $r$ be a ring. let $\mathfrak p$ be a prime of $r$. let $l/\kappa(\mathfrak p)$ be a finite separable field extension. there exists an \'etale ring map $r \to r'$ together with a prime $\mathfrak p'$ lying over $\mathfrak p$ such that the field extension $\kappa(\mathfrak p')/\kappa(\mathfrak p)$ is isomorphic to $\kappa(\mathfrak p) \subset l$. \end{lemma} \begin{proof} by the theorem of the primitive element we may write $l = \kappa(\mathfrak p)[\alpha]$. let $\overline{f} \in \kappa(\mathfrak p)[x]$ denote the minimal polynomial for $\alpha$ (in particular this is monic). after replacing $\alpha$ by $c\alpha$ for some $c \in r$, $c\not \in \mathfrak p$ we may assume all the coefficients of $\overline{f}$ are in the image of $r \to \kappa(\mathfrak p)$ (verification omitted). thus we can find a monic polynomial $f \in r[x]$ which maps to $\overline{f}$ in $\kappa(\mathfrak p)[x]$. since $\kappa(\mathfrak p) \subset l$ is separable, we see that $\gcd(\overline{f}, \overline{f}') = 1$. hence there is an element $\gamma \in l$ such that $\overline{f}'(\alpha) \gamma = 1$. thus we get a $r$-algebra map \begin{eqnarray*} r[x, 1/f']/(f) & \longrightarrow & l \\ x & \longmapsto & \alpha \\ 1/f' & \longmapsto & \gamma \end{eqnarray*} the left hand side is a standard \'etale algebra $r'$ over $r$ and the kernel of the ring map gives the desired prime. \end{proof} \begin{proposition} \label{proposition-etale-locally-standard} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime. if $r \to s$ is \'etale at $\mathfrak q$, then there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is standard \'etale. \end{proposition} \begin{proof} the following proof is a little roundabout and there may be ways to shorten it. \medskip\noindent step 1. by definition \ref{definition-etale} there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is \'etale. thus we may assume that $s$ is \'etale over $r$. \medskip\noindent step 2. by lemma \ref{lemma-etale} there exists an \'etale ring map $r_0 \to s_0$ with $r_0$ of finite type over $\mathbf{z}$, and a ring map $r_0 \to r$ such that $r = r \otimes_{r_0} s_0$. denote $\mathfrak q_0$ the prime of $s_0$ corresponding to $\mathfrak q$. if we show the result for $(r_0 \to s_0, \mathfrak q_0)$ then the result follows for $(r \to s, \mathfrak q)$ by base change. hence we may assume that $r$ is noetherian. \medskip\noindent step 3. note that $r \to s$ is quasi-finite by lemma \ref{lemma-etale-quasi-finite}. by lemma \ref{lemma-quasi-finite-open-integral-closure} there exists a finite ring map $r \to s'$, an $r$-algebra map $s' \to s$, an element $g' \in s'$ such that $g' \not \in \mathfrak q$ such that $s' \to s$ induces an isomorphism $s'_{g'} \cong s_{g'}$. (note that of course $s'$ is not \'etale over $r$ in general.) thus we may assume that (a) $r$ is noetherian, (b) $r \to s$ is finite and (c) $r \to s$ is \'etale at $\mathfrak q$ (but no longer necessarily \'etale at all primes). \medskip\noindent step 4. let $\mathfrak p \subset r$ be the prime corresponding to $\mathfrak q$. consider the fibre ring $s \otimes_r \kappa(\mathfrak p)$. this is a finite algebra over $\kappa(\mathfrak p)$. hence it is artinian (see lemma \ref{lemma-finite-dimensional-algebra}) and so a finite product of local rings $$ s \otimes_r \kappa(\mathfrak p) = \prod\nolimits_{i = 1}^n a_i $$ see proposition \ref{proposition-dimension-zero-ring}. one of the factors, say $a_1$, is the local ring $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ which is isomorphic to $\kappa(\mathfrak q)$, see lemma \ref{lemma-etale-at-prime}. the other factors correspond to the other primes, say $\mathfrak q_2, \ldots, \mathfrak q_n$ of $s$ lying over $\mathfrak p$. \medskip\noindent step 5. we may choose a nonzero element $\alpha \in \kappa(\mathfrak q)$ which generates the finite separable field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ (so even if the field extension is trivial we do not allow $\alpha = 0$). note that for any $\lambda \in \kappa(\mathfrak p)^*$ the element $\lambda \alpha$ also generates $\kappa(\mathfrak q)$ over $\kappa(\mathfrak p)$. consider the element $$ \overline{t} = (\alpha, 0, \ldots, 0) \in \prod\nolimits_{i = 1}^n a_i = s \otimes_r \kappa(\mathfrak p). $$ after possibly replacing $\alpha$ by $\lambda \alpha$ as above we may assume that $\overline{t}$ is the image of $t \in s$. let $i \subset r[x]$ be the kernel of the $r$-algebra map $r[x] \to s$ which maps $x$ to $t$. set $s' = r[x]/i$, so $s' \subset s$. here is a diagram $$ \xymatrix{ r[x] \ar[r] & s' \ar[r] & s \\ r \ar[u] \ar[ru] \ar[rru] & & } $$ by construction the primes $\mathfrak q_j$, $j \geq 2$ of $s$ all lie over the prime $(\mathfrak p, x)$ of $r[x]$, whereas the prime $\mathfrak q$ lies over a different prime of $r[x]$ because $\alpha \not = 0$. \medskip\noindent step 6. denote $\mathfrak q' \subset s'$ the prime of $s'$ corresponding to $\mathfrak q$. by the above $\mathfrak q$ is the only prime of $s$ lying over $\mathfrak q'$. thus we see that $s_{\mathfrak q} = s_{\mathfrak q'}$, see lemma \ref{lemma-unique-prime-over-localize-below} (we have going up for $s' \to s$ by lemma \ref{lemma-integral-going-up} since $s' \to s$ is finite as $r \to s$ is finite). it follows that $s'_{\mathfrak q'} \to s_{\mathfrak q}$ is finite and injective as the localization of the finite injective ring map $s' \to s$. consider the maps of local rings $$ r_{\mathfrak p} \to s'_{\mathfrak q'} \to s_{\mathfrak q} $$ the second map is finite and injective. we have $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q} = \kappa(\mathfrak q)$, see lemma \ref{lemma-etale-at-prime}. hence a fortiori $s_{\mathfrak q}/\mathfrak q's_{\mathfrak q} = \kappa(\mathfrak q)$. since $$ \kappa(\mathfrak p) \subset \kappa(\mathfrak q') \subset \kappa(\mathfrak q) $$ and since $\alpha$ is in the image of $\kappa(\mathfrak q')$ in $\kappa(\mathfrak q)$ we conclude that $\kappa(\mathfrak q') = \kappa(\mathfrak q)$. hence by nakayama's lemma \ref{lemma-nak} applied to the $s'_{\mathfrak q'}$-module map $s'_{\mathfrak q'} \to s_{\mathfrak q}$, the map $s'_{\mathfrak q'} \to s_{\mathfrak q}$ is surjective. in other words, $s'_{\mathfrak q'} \cong s_{\mathfrak q}$. \medskip\noindent step 7. by lemma \ref{lemma-isomorphic-local-rings} there exist $g \in s$, $g \not \in \mathfrak q$ and $g' \in s'$, $g' \not \in \mathfrak q'$ such that $s'_{g'} \cong s_g$. as $r$ is noetherian the ring $s'$ is finite over $r$ because it is an $r$-submodule of the finite $r$-module $s$. hence after replacing $s$ by $s'$ we may assume that (a) $r$ is noetherian, (b) $s$ finite over $r$, (c) $s$ is \'etale over $r$ at $\mathfrak q$, and (d) $s = r[x]/i$. \medskip\noindent step 8. consider the ring $s \otimes_r \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]/\overline{i}$ where $\overline{i} = i \cdot \kappa(\mathfrak p)[x]$ is the ideal generated by $i$ in $\kappa(\mathfrak p)[x]$. as $\kappa(\mathfrak p)[x]$ is a pid we know that $\overline{i} = (\overline{h})$ for some monic $\overline{h} \in \kappa(\mathfrak p)[x]$. after replacing $\overline{h}$ by $\lambda \cdot \overline{h}$ for some $\lambda \in \kappa(\mathfrak p)$ we may assume that $\overline{h}$ is the image of some $h \in i \subset r[x]$. (the problem is that we do not know if we may choose $h$ monic.) also, as in step 4 we know that $s \otimes_r \kappa(\mathfrak p) = a_1 \times \ldots \times a_n$ with $a_1 = \kappa(\mathfrak q)$ a finite separable extension of $\kappa(\mathfrak p)$ and $a_2, \ldots, a_n$ local. this implies that $$ \overline{h} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n} $$ for certain pairwise coprime irreducible monic polynomials $\overline{h}_i \in \kappa(\mathfrak p)[x]$ and certain $e_2, \ldots, e_n \geq 1$. here the numbering is chosen so that $a_i = \kappa(\mathfrak p)[x]/(\overline{h}_i^{e_i})$ as $\kappa(\mathfrak p)[x]$-algebras. note that $\overline{h}_1$ is the minimal polynomial of $\alpha \in \kappa(\mathfrak q)$ and hence is a separable polynomial (its derivative is prime to itself). \medskip\noindent step 9. let $m \in i$ be a monic element; such an element exists because the ring extension $r \to r[x]/i$ is finite hence integral. denote $\overline{m}$ the image in $\kappa(\mathfrak p)[x]$. we may factor $$ \overline{m} = \overline{k} \overline{h}_1^{d_1} \overline{h}_2^{d_2} \ldots \overline{h}_n^{d_n} $$ for some $d_1 \geq 1$, $d_j \geq e_j$, $j = 2, \ldots, n$ and $\overline{k} \in \kappa(\mathfrak p)[x]$ prime to all the $\overline{h}_i$. set $f = m^l + h$ where $l \deg(m) > \deg(h)$, and $l \geq 2$. then $f$ is monic as a polynomial over $r$. also, the image $\overline{f}$ of $f$ in $\kappa(\mathfrak p)[x]$ factors as $$ \overline{f} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n} + \overline{k}^l \overline{h}_1^{ld_1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n} = \overline{h}_1(\overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n} + \overline{k}^l \overline{h}_1^{ld_1 - 1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n}) = \overline{h}_1 \overline{w} $$ with $\overline{w}$ a polynomial relatively prime to $\overline{h}_1$. set $g = f'$ (the derivative with respect to $x$). \medskip\noindent step 10. the ring map $r[x] \to s = r[x]/i$ has the properties: (1) it maps $f$ to zero, and (2) it maps $g$ to an element of $s \setminus \mathfrak q$. the first assertion is clear since $f$ is an element of $i$. for the second assertion we just have to show that $g$ does not map to zero in $\kappa(\mathfrak q) = \kappa(\mathfrak p)[x]/(\overline{h}_1)$. the image of $g$ in $\kappa(\mathfrak p)[x]$ is the derivative of $\overline{f}$. thus (2) is clear because $$ \overline{g} = \frac{\text{d}\overline{f}}{\text{d}x} = \overline{w}\frac{\text{d}\overline{h}_1}{\text{d}x} + \overline{h}_1\frac{\text{d}\overline{w}}{\text{d}x}, $$ $\overline{w}$ is prime to $\overline{h}_1$ and $\overline{h}_1$ is separable. \medskip\noindent step 11. we conclude that $\varphi : r[x]/(f) \to s$ is a surjective ring map, $r[x]_g/(f)$ is \'etale over $r$ (because it is standard \'etale, see lemma \ref{lemma-standard-etale}) and $\varphi(g) \not \in \mathfrak q$. pick an element $g' \in r[x]/(f)$ such that also $\varphi(g') \not \in \mathfrak q$ and $s_{\varphi(g')}$ is \'etale over $r$ (which exists since $s$ is \'etale over $r$ at $\mathfrak q$). then the ring map $r[x]_{gg'}/(f) \to s_{\varphi(gg')}$ is a surjective map of \'etale algebras over $r$. hence it is \'etale by lemma \ref{lemma-map-between-etale}. hence it is a localization by lemma \ref{lemma-surjective-flat-finitely-presented}. thus a localization of $s$ at an element not in $\mathfrak q$ is isomorphic to a localization of a standard \'etale algebra over $r$ which is what we wanted to show. \end{proof} \noindent the following two lemmas say that the \'etale topology is coarser than the topology generated by zariski coverings and finite flat morphisms. they should be skipped on a first reading. \begin{lemma} \label{lemma-standard-etale-finite-flat-zariski} let $r \to s$ be a standard \'etale morphism. there exists a ring map $r \to s'$ with the following properties \begin{enumerate} \item $r \to s'$ is finite, finitely presented, and flat (in other words $s'$ is finite projective as an $r$-module), \item $\spec(s') \to \spec(r)$ is surjective, \item for every prime $\mathfrak q \subset s$, lying over $\mathfrak p \subset r$ and every prime $\mathfrak q' \subset s'$ lying over $\mathfrak p$ there exists a $g' \in s'$, $g' \not \in \mathfrak q'$ such that the ring map $r \to s'_{g'}$ factors through a map $\varphi : s \to s'_{g'}$ with $\varphi^{-1}(\mathfrak q's'_{g'}) = \mathfrak q$. \end{enumerate} \end{lemma} \begin{proof} let $s = r[x]_g/(f)$ be a presentation of $s$ as in definition \ref{definition-standard-etale}. write $f = x^n + a_1 x^{n - 1} + \ldots + a_n$ with $a_i \in r$. by lemma \ref{lemma-adjoin-roots} there exists a finite free and faithfully flat ring map $r \to s'$ such that $f = \prod (x - \alpha_i)$ for certain $\alpha_i \in s'$. hence $r \to s'$ satisfies conditions (1), (2). let $\mathfrak q \subset r[x]/(f)$ be a prime ideal with $g \not \in \mathfrak q$ (i.e., it corresponds to a prime of $s$). let $\mathfrak p = r \cap \mathfrak q$ and let $\mathfrak q' \subset s'$ be a prime lying over $\mathfrak p$. note that there are $n$ maps of $r$-algebras \begin{eqnarray*} \varphi_i : r[x]/(f) & \longrightarrow & s' \\ x & \longmapsto & \alpha_i \end{eqnarray*} to finish the proof we have to show that for some $i$ we have (a) the image of $\varphi_i(g)$ in $\kappa(\mathfrak q')$ is not zero, and (b) $\varphi_i^{-1}(\mathfrak q') = \mathfrak q$. because then we can just take $g' = \varphi_i(g)$, and $\varphi = \varphi_i$ for that $i$. \medskip\noindent let $\overline{f}$ denote the image of $f$ in $\kappa(\mathfrak p)[x]$. note that as a point of $\spec(\kappa(\mathfrak p)[x]/(\overline{f}))$ the prime $\mathfrak q$ corresponds to an irreducible factor $f_1$ of $\overline{f}$. moreover, $g \not \in \mathfrak q$ means that $f_1$ does not divide the image $\overline{g}$ of $g$ in $\kappa(\mathfrak p)[x]$. denote $\overline{\alpha}_1, \ldots, \overline{\alpha}_n$ the images of $\alpha_1, \ldots, \alpha_n$ in $\kappa(\mathfrak q')$. note that the polynomial $\overline{f}$ splits completely in $\kappa(\mathfrak q')[x]$, namely $$ \overline{f} = \prod\nolimits_i (x - \overline{\alpha}_i) $$ moreover $\varphi_i(g)$ reduces to $\overline{g}(\overline{\alpha}_i)$. it follows we may pick $i$ such that $f_1(\overline{\alpha}_i) = 0$ and $\overline{g}(\overline{\alpha}_i) \not = 0$. for this $i$ properties (a) and (b) hold. some details omitted. \end{proof} \begin{lemma} \label{lemma-etale-finite-flat-zariski} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is \'etale, and \item $\spec(s) \to \spec(r)$ is surjective. \end{enumerate} then there exists a ring map $r \to s'$ such that \begin{enumerate} \item $r \to s'$ is finite, finitely presented, and flat (in other words it is finite projective as an $r$-module), \item $\spec(s') \to \spec(r)$ is surjective, \item for every prime $\mathfrak q' \subset s'$ there exists a $g' \in s'$, $g' \not \in \mathfrak q'$ such that the ring map $r \to s'_{g'}$ factors as $r \to s \to s'_{g'}$. \end{enumerate} \end{lemma} \begin{proof} by proposition \ref{proposition-etale-locally-standard} and the quasi-compactness of $\spec(s)$ (see lemma \ref{lemma-quasi-compact}) we can find $g_1, \ldots, g_n \in s$ generating the unit ideal of $s$ such that each $r \to s_{g_i}$ is standard \'etale. if we prove the lemma for the ring map $r \to \prod_{i = 1, \ldots, n} s_{g_i}$ then the lemma follows for the ring map $r \to s$. hence we may assume that $s = \prod_{i = 1, \ldots, n} s_i$ is a finite product of standard \'etale morphisms. \medskip\noindent for each $i$ choose a ring map $r \to s_i'$ as in lemma \ref{lemma-standard-etale-finite-flat-zariski} adapted to the standard \'etale morphism $r \to s_i$. set $s' = s_1' \otimes_r \ldots \otimes_r s_n'$; we will use the $r$-algebra maps $s_i' \to s'$ without further mention below. we claim this works. properties (1) and (2) are immediate. for property (3) suppose that $\mathfrak q' \subset s'$ is a prime. denote $\mathfrak p$ its image in $\spec(r)$. choose $i \in \{1, \ldots, n\}$ such that $\mathfrak p$ is in the image of $\spec(s_i) \to \spec(r)$; this is possible by assumption. set $\mathfrak q_i' \subset s_i'$ the image of $\mathfrak q'$ in the spectrum of $s_i'$. by construction of $s'_i$ there exists a $g'_i \in s_i'$ such that $r \to (s_i')_{g_i'}$ factors as $r \to s_i \to (s_i')_{g_i'}$. hence also $r \to s'_{g_i'}$ factors as $$ r \to s_i \to (s_i')_{g_i'} \to s'_{g_i'} $$ as desired. \end{proof} \section{\'etale local structure of quasi-finite ring maps} \label{section-etale-local-quasi-finite} \noindent the following lemmas say roughly that after an \'etale extension a quasi-finite ring map becomes finite. to help interpret the results recall that the locus where a finite type ring map is quasi-finite is open (see lemma \ref{lemma-quasi-finite-open}) and that formation of this locus commutes with arbitrary base change (see lemma \ref{lemma-quasi-finite-base-change}). \begin{lemma} \label{lemma-produce-finite} let $r \to s' \to s$ be ring maps. let $\mathfrak p \subset r$ be a prime. let $g \in s'$ be an element. assume \begin{enumerate} \item $r \to s'$ is integral, \item $r \to s$ is finite type, \item $s'_g \cong s_g$, and \item $g$ invertible in $s' \otimes_r \kappa(\mathfrak p)$. \end{enumerate} then there exists a $f \in r$, $f \not \in \mathfrak p$ such that $r_f \to s_f$ is finite. \end{lemma} \begin{proof} by assumption the image $t$ of $v(g) \subset \spec(s')$ under the morphism $\spec(s') \to \spec(r)$ does not contain $\mathfrak p$. by section \ref{section-going-up} especially, lemma \ref{lemma-going-up-closed} we see $t$ is closed. pick $f \in r$, $f \not \in \mathfrak p$ such that $t \cap d(f) = \emptyset$. then we see that $g$ becomes invertible in $s'_f$. hence $s'_f \cong s_f$. thus $s_f$ is both of finite type and integral over $r_f$, hence finite. \end{proof} \begin{lemma} \label{lemma-etale-makes-quasi-finite-finite-one-prime} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over the prime $\mathfrak p \subset r$. assume $r \to s$ finite type and quasi-finite at $\mathfrak q$. then there exists \begin{enumerate} \item an \'etale ring map $r \to r'$, \item a prime $\mathfrak p' \subset r'$ lying over $\mathfrak p$, \item a product decomposition $$ r' \otimes_r s = a \times b $$ \end{enumerate} with the following properties \begin{enumerate} \item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$, \item $r' \to a$ is finite, \item $a$ has exactly one prime $\mathfrak r$ lying over $\mathfrak p'$, \item $\mathfrak r$ lies over $\mathfrak q$, and \item $b$ does not have a prime lying over $\mathfrak q$ and $\mathfrak p'$. \end{enumerate} \end{lemma} \begin{proof} let $s' \subset s$ be the integral closure of $r$ in $s$. let $\mathfrak q' = s' \cap \mathfrak q$. by zariski's main theorem \ref{theorem-main-theorem} there exists a $g \in s'$, $g \not \in \mathfrak q'$ such that $s'_g \cong s_g$. consider the fibre rings $f = s \otimes_r \kappa(\mathfrak p)$ and $f' = s' \otimes_r \kappa(\mathfrak p)$. denote $\overline{\mathfrak q}'$ the prime of $f'$ corresponding to $\mathfrak q'$. since $f'$ is integral over $\kappa(\mathfrak p)$ we see that $\overline{\mathfrak q}'$ is a closed point of $\spec(f')$, see lemma \ref{lemma-integral-over-field}. note that $\mathfrak q$ defines an isolated closed point $\overline{\mathfrak q}$ of $\spec(f)$ (see definition \ref{definition-quasi-finite}). since $s'_g \cong s_g$ we have $f'_g \cong f_g$, so $\overline{\mathfrak q}$ and $\overline{\mathfrak q}'$ have isomorphic open neighbourhoods in $\spec(f)$ and $\spec(f')$. we conclude the set $\{\overline{\mathfrak q}'\} \subset \spec(f')$ is open. combined with $\mathfrak q'$ being closed (shown above) we conclude that $\overline{\mathfrak q}'$ defines an isolated closed point of $\spec(f')$ as well. \medskip\noindent an additional small remark is that under the map $\spec(f) \to \spec(f')$ the point $\overline{\mathfrak q}$ is the only point mapping to $\overline{\mathfrak q}'$. this follows from the discussion above. \medskip\noindent by lemma \ref{lemma-disjoint-implies-product} we may write $f' = f'_1 \times f'_2$ with $\spec(f'_1) = \{\overline{\mathfrak q}'\}$. since $f' = s' \otimes_r \kappa(\mathfrak p)$, there exists an $s' \in s'$ which maps to the element $(r, 0) \in f'_1 \times f'_2 = f'$ for some $r \in r$, $r \not \in \mathfrak p$. in fact, what we will use about $s'$ is that it is an element of $s'$, not contained in $\mathfrak q'$, and contained in any other prime lying over $\mathfrak p$. \medskip\noindent let $f(x) \in r[x]$ be a monic polynomial such that $f(s') = 0$. denote $\overline{f} \in \kappa(\mathfrak p)[x]$ the image. we can factor it as $\overline{f} = x^e \overline{h}$ where $\overline{h}(0) \not = 0$. after replacing $f$ by $x f$ if necessary, we may assume $e \geq 1$. by lemma \ref{lemma-factor-mod-lift-etale} we can find an \'etale ring extension $r \to r'$, a prime $\mathfrak p'$ lying over $\mathfrak p$, and a factorization $f = h i$ in $r'[x]$ such that $\kappa(\mathfrak p) = \kappa(\mathfrak p')$, $\overline{h} = h \bmod \mathfrak p'$, $x^e = i \bmod \mathfrak p'$, and we can write $a h + b i = 1$ in $r'[x]$ (for suitable $a, b$). \medskip\noindent consider the elements $h(s'), i(s') \in r' \otimes_r s'$. by construction we have $h(s')i(s') = f(s') = 0$. on the other hand they generate the unit ideal since $a(s')h(s') + b(s')i(s') = 1$. thus we see that $r' \otimes_r s'$ is the product of the localizations at these elements: $$ r' \otimes_r s' = (r' \otimes_r s')_{i(s')} \times (r' \otimes_r s')_{h(s')} = s'_1 \times s'_2 $$ moreover this product decomposition is compatible with the product decomposition we found for the fibre ring $f'$; this comes from our choices of $s', i, h$ which guarantee that $\overline{\mathfrak q}'$ is the only prime of $f'$ which does not contain the image of $i(s')$ in $f'$. here we use that the fibre ring of $r'\otimes_r s'$ over $r'$ at $\mathfrak p'$ is the same as $f'$ due to the fact that $\kappa(\mathfrak p) = \kappa(\mathfrak p')$. it follows that $s'_1$ has exactly one prime, say $\mathfrak r'$, lying over $\mathfrak p'$ and that this prime lies over $\mathfrak q'$. hence the element $g \in s'$ maps to an element of $s'_1$ not contained in $\mathfrak r'$. \medskip\noindent the base change $r'\otimes_r s$ inherits a similar product decomposition $$ r' \otimes_r s = (r' \otimes_r s)_{i(s')} \times (r' \otimes_r s)_{h(s')} = s_1 \times s_2 $$ it follows from the above that $s_1$ has exactly one prime, say $\mathfrak r$, lying over $\mathfrak p'$ (consider the fibre ring as above), and that this prime lies over $\mathfrak q$. \medskip\noindent now we may apply lemma \ref{lemma-produce-finite} to the ring maps $r' \to s'_1 \to s_1$, the prime $\mathfrak p'$ and the element $g$ to see that after replacing $r'$ by a principal localization we can assume that $s_1$ is finite over $r'$ as desired. \end{proof} \begin{lemma} \label{lemma-etale-makes-quasi-finite-finite} let $r \to s$ be a ring map. let $\mathfrak p \subset r$ be a prime. assume $r \to s$ finite type. then there exists \begin{enumerate} \item an \'etale ring map $r \to r'$, \item a prime $\mathfrak p' \subset r'$ lying over $\mathfrak p$, \item a product decomposition $$ r' \otimes_r s = a_1 \times \ldots \times a_n \times b $$ \end{enumerate} with the following properties \begin{enumerate} \item we have $\kappa(\mathfrak p) = \kappa(\mathfrak p')$, \item each $a_i$ is finite over $r'$, \item each $a_i$ has exactly one prime $\mathfrak r_i$ lying over $\mathfrak p'$, and \item $r' \to b$ not quasi-finite at any prime lying over $\mathfrak p'$. \end{enumerate} \end{lemma} \begin{proof} denote $f = s \otimes_r \kappa(\mathfrak p)$ the fibre ring of $s/r$ at the prime $\mathfrak p$. as $f$ is of finite type over $\kappa(\mathfrak p)$ it is noetherian and hence $\spec(f)$ has finitely many isolated closed points. if there are no isolated closed points, i.e., no primes $\mathfrak q$ of $s$ over $\mathfrak p$ such that $s/r$ is quasi-finite at $\mathfrak q$, then the lemma holds. if there exists at least one such prime $\mathfrak q$, then we may apply lemma \ref{lemma-etale-makes-quasi-finite-finite-one-prime}. this gives a diagram $$ \xymatrix{ s \ar[r] & r'\otimes_r s \ar@{=}[r] & a_1 \times b' \\ r \ar[r] \ar[u] & r' \ar[u] \ar[ru] } $$ as in said lemma. since the residue fields at $\mathfrak p$ and $\mathfrak p'$ are the same, the fibre rings of $s/r$ and $(a_1 \times b')/r'$ are the same. hence, by induction on the number of isolated closed points of the fibre we may assume that the lemma holds for $r' \to b'$ and $\mathfrak p'$. thus we get an \'etale ring map $r' \to r''$, a prime $\mathfrak p'' \subset r''$ and a decomposition $$ r'' \otimes_{r'} b' = a_2 \times \ldots \times a_n \times b $$ we omit the verification that the ring map $r \to r''$, the prime $\mathfrak p''$ and the resulting decomposition $$ r'' \otimes_r s = (r'' \otimes_{r'} a_1) \times a_2 \times \ldots \times a_n \times b $$ is a solution to the problem posed in the lemma. \end{proof} \begin{lemma} \label{lemma-etale-makes-quasi-finite-finite-variant} let $r \to s$ be a ring map. let $\mathfrak p \subset r$ be a prime. assume $r \to s$ finite type. then there exists \begin{enumerate} \item an \'etale ring map $r \to r'$, \item a prime $\mathfrak p' \subset r'$ lying over $\mathfrak p$, \item a product decomposition $$ r' \otimes_r s = a_1 \times \ldots \times a_n \times b $$ \end{enumerate} with the following properties \begin{enumerate} \item each $a_i$ is finite over $r'$, \item each $a_i$ has exactly one prime $\mathfrak r_i$ lying over $\mathfrak p'$, \item the finite field extensions $\kappa(\mathfrak r_i)/\kappa(\mathfrak p')$ are purely inseparable, and \item $r' \to b$ not quasi-finite at any prime lying over $\mathfrak p'$. \end{enumerate} \end{lemma} \begin{proof} the strategy of the proof is to make two \'etale ring extensions: first we control the residue fields, then we apply lemma \ref{lemma-etale-makes-quasi-finite-finite}. \medskip\noindent denote $f = s \otimes_r \kappa(\mathfrak p)$ the fibre ring of $s/r$ at the prime $\mathfrak p$. as in the proof of lemma \ref{lemma-etale-makes-quasi-finite-finite} there are finitely may primes, say $\mathfrak q_1, \ldots, \mathfrak q_n$ of $s$ lying over $r$ at which the ring map $r \to s$ is quasi-finite. let $\kappa(\mathfrak p) \subset l_i \subset \kappa(\mathfrak q_i)$ be the subfield such that $\kappa(\mathfrak p) \subset l_i$ is separable, and the field extension $\kappa(\mathfrak q_i)/l_i$ is purely inseparable. let $l/\kappa(\mathfrak p)$ be a finite galois extension into which $l_i$ embeds for $i = 1, \ldots, n$. by lemma \ref{lemma-make-etale-map-prescribed-residue-field} we can find an \'etale ring extension $r \to r'$ together with a prime $\mathfrak p'$ lying over $\mathfrak p$ such that the field extension $\kappa(\mathfrak p')/\kappa(\mathfrak p)$ is isomorphic to $\kappa(\mathfrak p) \subset l$. thus the fibre ring of $r' \otimes_r s$ at $\mathfrak p'$ is isomorphic to $f \otimes_{\kappa(\mathfrak p)} l$. the primes lying over $\mathfrak q_i$ correspond to primes of $\kappa(\mathfrak q_i) \otimes_{\kappa(\mathfrak p)} l$ which is a product of fields purely inseparable over $l$ by our choice of $l$ and elementary field theory. these are also the only primes over $\mathfrak p'$ at which $r' \to r' \otimes_r s$ is quasi-finite, by lemma \ref{lemma-quasi-finite-base-change}. hence after replacing $r$ by $r'$, $\mathfrak p$ by $\mathfrak p'$, and $s$ by $r' \otimes_r s$ we may assume that for all primes $\mathfrak q$ lying over $\mathfrak p$ for which $s/r$ is quasi-finite the field extensions $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ are purely inseparable. \medskip\noindent next apply lemma \ref{lemma-etale-makes-quasi-finite-finite}. the result is what we want since the field extensions do not change under this \'etale ring extension. \end{proof} \section{local homomorphisms} \label{section-local-homomorphisms} \noindent some lemmas which don't have a natural section to go into. the first lemma says, loosely speaking, that an \'etale map of local rings is an isomorphism modulo all powers of a nonunit principal ideal. \begin{lemma} \label{lemma-lindel} \begin{reference} \cite[lemma on page 321]{lindel}, \cite[lemma 4.1.5]{kc} \end{reference} let $(r, \mathfrak m_r) \to (s, \mathfrak m_s)$ be a local homomorphism of local rings. assume $s$ is the localization of an \'etale ring extension of $r$ and that $\kappa(\mathfrak m_r) \to \kappa(\mathfrak m_s)$ is an isomorphism. then there exists an $t \in \mathfrak m_r$ such that $r/t^nr \to s/t^ns$ is an isomorphsm for all $n \geq 1$. \end{lemma} \begin{proof} write $s = t_{\mathfrak q}$ for some \'etale $r$-algebra $t$ and prime ideal $\mathfrak q \subset t$ lying over $\mathfrak m_r$. by proposition \ref{proposition-etale-locally-standard} we may assume $r \to t$ is standard \'etale. write $t = r[x]_g/(f)$ as in definition \ref{definition-standard-etale}. by our assumption on residue fields, we may choose $a \in r$ such that $x$ and $a$ have the same image in $\kappa(\mathfrak q) = \kappa(\mathfrak m_s) = \kappa(\mathfrak m_r)$. then after replacing $x$ by $x - a$ we may assume that $\mathfrak q$ is generated by $x$ and $\mathfrak m_r$ in $t$. in particular $t = f(0) \in \mathfrak m_r$. we will show that $t = f(0)$ works. \medskip\noindent write $f = x^d + \sum_{i = 1, \ldots, d - 1} a_i x^i + t$. since $r \to t$ is standard \'etale we find that $a_1$ is a unit in $r$: the derivative of $f$ is invertible in $t$ in particular is not contained in $\mathfrak q$. let $h = a_1 + a_2 x + \ldots + a_{d - 1} x^{d - 2} + x^{d - 1} \in r[x]$ so that $f = t + xh$ in $r[x]$. we see that $h \not \in \mathfrak q$ and hence we may replace $t$ by $r[x]_{hg}/(f)$. after this replacement we see that $$ t/tt = (r/tr)[x]_{hg}/(f) = (r/tr)[x]_{hg}/(xh) = (r/tr)[x]_{hg}/(x) $$ is a quotient of $r/tr$. by lemma \ref{lemma-surjective-mod-locally-nilpotent} we conclude that $r/t^nr \to t/t^nt$ is surjective for all $n \geq 1$. on the other hand, we know that the flat local ring map $r/t^nr \to s/t^ns$ factors through $r/t^nr \to t/t^nt$ for all $n$, hence these maps are also injective (a flat local homomorphism of local rings is faithfully flat and hence injective, see lemmas \ref{lemma-local-flat-ff} and \ref{lemma-faithfully-flat-universally-injective}). as $s$ is the localization of $t$ we see that $s/t^ns$ is the localization of $t/t^nt = r/t^nr$ at a prime lying over the maximal ideal, but this ring is already local and the proof is complete. \end{proof} \begin{lemma} \label{lemma-etale-under-finite-flat} let $(r, \mathfrak m_r) \to (s, \mathfrak m_s)$ be a local homomorphism of local rings. assume $s$ is the localization of an \'etale ring extension of $r$. then there exists a finite, finitely presented, faithfully flat ring map $r \to s'$ such that for every maximal ideal $\mathfrak m'$ of $s'$ there is a factorization $$ r \to s \to s'_{\mathfrak m'}. $$ of the ring map $r \to s'_{\mathfrak m'}$. \end{lemma} \begin{proof} write $s = t_{\mathfrak q}$ for some \'etale $r$-algebra $t$. by proposition \ref{proposition-etale-locally-standard} we may assume $t$ is standard \'etale. apply lemma \ref{lemma-standard-etale-finite-flat-zariski} to the ring map $r \to t$ to get $r \to s'$. then in particular for every maximal ideal $\mathfrak m'$ of $s'$ we get a factorization $\varphi : t \to s'_{g'}$ for some $g' \not \in \mathfrak m'$ such that $\mathfrak q = \varphi^{-1}(\mathfrak m's'_{g'})$. thus $\varphi$ induces the desired local ring map $s \to s'_{\mathfrak m'}$. \end{proof} \section{integral closure and smooth base change} \label{section-integral-closure-smooth-base-change} \begin{lemma} \label{lemma-trick} let $r$ be a ring. let $f \in r[x]$ be a monic polynomial. let $r \to b$ be a ring map. if $h \in b[x]/(f)$ is integral over $r$, then the element $f' h$ can be written as $f'h = \sum_i b_i x^i$ with $b_i \in b$ integral over $r$. \end{lemma} \begin{proof} say $h^e + r_1 h^{e - 1} + \ldots + r_e = 0$ in the ring $b[x]/(f)$ with $r_i \in r$. there exists a finite free ring extension $b \subset b'$ such that $f = (x - \alpha_1) \ldots (x - \alpha_d)$ for some $\alpha_i \in b'$, see lemma \ref{lemma-adjoin-roots}. note that each $\alpha_i$ is integral over $r$. we may represent $h = h_0 + h_1 x + \ldots + h_{d - 1} x^{d - 1}$ with $h_i \in b$. then it is a universal fact that $$ f' h = \sum\nolimits_{i = 1, \ldots, d} h(\alpha_i) (x - \alpha_1) \ldots \widehat{(x - \alpha_i)} \ldots (x - \alpha_d) $$ as elements of $b'[x]/(f)$. you prove this by evaluating both sides at the points $\alpha_i$ over the ring $b_{univ} = \mathbf{z}[\alpha_i, h_j]$ (some details omitted). by our assumption that $h$ satisfies $h^e + r_1 h^{e - 1} + \ldots + r_e = 0$ in the ring $b[x]/(f)$ we see that $$ h(\alpha_i)^e + r_1 h(\alpha_i)^{e - 1} + \ldots + r_e = 0 $$ in $b'$. hence $h(\alpha_i)$ is integral over $r$. using the formula above we see that $f'h \equiv \sum_{j = 0, \ldots, d - 1} b'_j x^j$ in $b'[x]/(f)$ with $b'_j \in b'$ integral over $r$. however, since $f' h \in b[x]/(f)$ and since $1, x, \ldots, x^{d - 1}$ is a $b'$-basis for $b'[x]/(f)$ we see that $b'_j \in b$ as desired. \end{proof} \begin{lemma} \label{lemma-integral-closure-commutes-etale} let $r \to s$ be an \'etale ring map. let $r \to b$ be any ring map. let $a \subset b$ be the integral closure of $r$ in $b$. let $a' \subset s \otimes_r b$ be the integral closure of $s$ in $s \otimes_r b$. then the canonical map $s \otimes_r a \to a'$ is an isomorphism. \end{lemma} \begin{proof} the map $s \otimes_r a \to a'$ is injective because $a \subset b$ and $r \to s$ is flat. we are going to use repeatedly that taking integral closure commutes with localization, see lemma \ref{lemma-integral-closure-localize}. hence we may localize on $s$, by lemma \ref{lemma-cover} (the criterion for checking whether an $s$-module map is an isomorphism). thus we may assume that $s = r[x]_g/(f) = (r[x]/(f))_g$ is standard \'etale over $r$, see proposition \ref{proposition-etale-locally-standard}. applying localization one more time we see that $a'$ is $(a'')_g$ where $a''$ is the integral closure of $r[x]/(f)$ in $b[x]/(f)$. suppose that $a \in a''$. it suffices to show that $a$ is in $s \otimes_r a$. by lemma \ref{lemma-trick} we see that $f' a = \sum a_i x^i$ with $a_i \in a$. since $f'$ is invertible in $s$ (by definition of a standard \'etale ring map) we conclude that $a \in s \otimes_r a$ as desired. \end{proof} \begin{example} \label{example-fourier} let $p$ be a prime number. the ring extension $$ r = \mathbf{z}[1/p] \subset r' = \mathbf{z}[1/p][x]/(x^{p - 1} + \ldots + x + 1) $$ has the following property: for $d < p$ there exist elements $\alpha_0, \ldots, \alpha_{d - 1} \in r'$ such that $$ \prod\nolimits_{0 \leq i < j < d} (\alpha_i - \alpha_j) $$ is a unit in $r'$. namely, take $\alpha_i$ equal to the class of $x^i$ in $r'$ for $i = 0, \ldots, p - 1$. then we have $$ t^p - 1 = \prod\nolimits_{i = 0, \ldots, p - 1} (t - \alpha_i) $$ in $r'[t]$. namely, the ring $\mathbf{q}[x]/(x^{p - 1} + \ldots + x + 1)$ is a field because the cyclotomic polynomial $x^{p - 1} + \ldots + x + 1$ is irreducible over $\mathbf{q}$ and the $\alpha_i$ are pairwise distinct roots of $t^p - 1$, whence the equality. taking derivatives on both sides and substituting $t = \alpha_i$ we obtain $$ p \alpha_i^{p - 1} = (\alpha_i - \alpha_1) \ldots \widehat{(\alpha_i - \alpha_i)} \ldots (\alpha_i - \alpha_1) $$ and we see this is invertible in $r'$. \end{example} \begin{lemma} \label{lemma-integral-closure-commutes-smooth} let $r \to s$ be a smooth ring map. let $r \to b$ be any ring map. let $a \subset b$ be the integral closure of $r$ in $b$. let $a' \subset s \otimes_r b$ be the integral closure of $s$ in $s \otimes_r b$. then the canonical map $s \otimes_r a \to a'$ is an isomorphism. \end{lemma} \begin{proof} arguing as in the proof of lemma \ref{lemma-integral-closure-commutes-etale} we may localize on $s$. hence we may assume that $r \to s$ is a standard smooth ring map, see lemma \ref{lemma-smooth-syntomic}. by definition of a standard smooth ring map we see that $s$ is \'etale over a polynomial ring $r[x_1, \ldots, x_n]$. since we have seen the result in the case of an \'etale ring extension (lemma \ref{lemma-integral-closure-commutes-etale}) this reduces us to the case where $s = r[x]$. thus we have to show $$ f = \sum b_i x^i \text{ integral over }r[x] \leftrightarrow \text{each }b_i\text{ integral over }r. $$ the implication from right to left holds because the set of elements in $b[x]$ integral over $r[x]$ is a ring (lemma \ref{lemma-integral-closure-is-ring}) and contains $x$. \medskip\noindent suppose that $f \in b[x]$ is integral over $r[x]$, and assume that $f = \sum_{i < d} b_i x^i$ has degree $< d$. since integral closure and localization commute, it suffices to show there exist distinct primes $p, q$ such that each $b_i$ is integral both over $r[1/p]$ and over $r[1/q]$. hence, we can find a finite free ring extension $r \subset r'$ such that $r'$ contains $\alpha_1, \ldots, \alpha_d$ with the property that $\prod_{i < j} (\alpha_i - \alpha_j)$ is a unit in $r'$, see example \ref{example-fourier}. in this case we have the universal equality $$ f = \sum_i f(\alpha_i) \frac{(x - \alpha_1) \ldots \widehat{(x - \alpha_i)} \ldots (x - \alpha_d)} {(\alpha_i - \alpha_1) \ldots \widehat{(\alpha_i - \alpha_i)} \ldots (\alpha_i - \alpha_d)}. $$ ok, and the elements $f(\alpha_i)$ are integral over $r'$ since $(r' \otimes_r b)[x] \to r' \otimes_r b$, $h \mapsto h(\alpha_i)$ is a ring map. hence we see that the coefficients of $f$ in $(r' \otimes_r b)[x]$ are integral over $r'$. since $r'$ is finite over $r$ (hence integral over $r$) we see that they are integral over $r$ also, as desired. \end{proof} \begin{lemma} \label{lemma-integral-closure-commutes-colim-smooth} let $r \to s$ and $r \to b$ be ring maps. let $a \subset b$ be the integral closure of $r$ in $b$. let $a' \subset s \otimes_r b$ be the integral closure of $s$ in $s \otimes_r b$. if $s$ is a filtered colimit of smooth $r$-algebras, then the canonical map $s \otimes_r a \to a'$ is an isomorphism. \end{lemma} \begin{proof} this follows from the straightforward fact that taking tensor products and taking integral closures commutes with filtered colimits and lemma \ref{lemma-integral-closure-commutes-smooth}. \end{proof} \section{formally unramified maps} \label{section-formally-unramified} \noindent it turns out to be logically more efficient to define the notion of a formally unramified map before introducing the notion of a formally \'etale one. \begin{definition} \label{definition-formally-unramified} let $r \to s$ be a ring map. we say $s$ is {\it formally unramified over $r$} if for every commutative solid diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & a/i \\ r \ar[r] \ar[u] & a \ar[u] } $$ where $i \subset a$ is an ideal of square zero, there exists at most one dotted arrow making the diagram commute. \end{definition} \begin{lemma} \label{lemma-base-change-formally-unramified} let $r \to s$ be a formally unramified map. let $r \to r'$ be any ring map. then the base change $s' = r' \otimes_r s$ is formally unramified over $r'$. \end{lemma} \begin{proof} let a solid diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rrd] & r' \otimes_r s \ar[r] \ar@{-->}[rd] & a/i \\ r \ar[u] \ar[r] & r' \ar[r] \ar[u] & a \ar[u] } $$ as in definition \ref{definition-formally-unramified} be given. by assumption there exists at most one longer dotted arrow. by the universal property of tensor product we conclude there is at most one shorter dotted arrow. \end{proof} \begin{lemma} \label{lemma-characterize-formally-unramified} let $r \to s$ be a ring map. the following are equivalent: \begin{enumerate} \item $r \to s$ is formally unramified, \item the module of differentials $\omega_{s/r}$ is zero. \end{enumerate} \end{lemma} \begin{proof} let $j = \ker(s \otimes_r s \to s)$ be the kernel of the multiplication map. let $a_{univ} = s \otimes_r s/j^2$. recall that $i_{univ} = j/j^2$ is isomorphic to $\omega_{s/r}$, see lemma \ref{lemma-differentials-diagonal}. moreover, the two $r$-algebra maps $\sigma_1, \sigma_2 : s \to a_{univ}$, $\sigma_1(s) = s \otimes 1 \bmod j^2$, and $\sigma_2(s) = 1 \otimes s \bmod j^2$ differ by the universal derivation $\text{d} : s \to \omega_{s/r} = i_{univ}$. \medskip\noindent assume $r \to s$ formally unramified. then we see that $\sigma_1 = \sigma_2$. hence $\text{d}(s) = 0$ for all $s \in s$. hence $\omega_{s/r} = 0$. \medskip\noindent assume that $\omega_{s/r} = 0$. let $a, i, r \to a, s \to a/i$ be a solid diagram as in definition \ref{definition-formally-unramified}. let $\tau_1, \tau_2 : s \to a$ be two dotted arrows making the diagram commute. consider the $r$-algebra map $a_{univ} \to a$ defined by the rule $s_1 \otimes s_2 \mapsto \tau_1(s_1)\tau_2(s_2)$. we omit the verification that this is well defined. since $a_{univ} \cong s$ as $i_{univ} = \omega_{s/r} = 0$ we conclude that $\tau_1 = \tau_2$. \end{proof} \begin{lemma} \label{lemma-formally-unramified-local} let $r \to s$ be a ring map. the following are equivalent: \begin{enumerate} \item $r \to s$ is formally unramified, \item $r \to s_{\mathfrak q}$ is formally unramified for all primes $\mathfrak q$ of $s$, and \item $r_{\mathfrak p} \to s_{\mathfrak q}$ is formally unramified for all primes $\mathfrak q$ of $s$ with $\mathfrak p = r \cap \mathfrak q$. \end{enumerate} \end{lemma} \begin{proof} we have seen in lemma \ref{lemma-characterize-formally-unramified} that (1) is equivalent to $\omega_{s/r} = 0$. similarly, by lemma \ref{lemma-differentials-localize} we see that (2) and (3) are equivalent to $(\omega_{s/r})_{\mathfrak q} = 0$ for all $\mathfrak q$. hence the equivalence follows from lemma \ref{lemma-characterize-zero-local}. \end{proof} \begin{lemma} \label{lemma-formally-unramified-localize} let $a \to b$ be a formally unramified ring map. \begin{enumerate} \item for $s \subset a$ a multiplicative subset, $s^{-1}a \to s^{-1}b$ is formally unramified. \item for $s \subset b$ a multiplicative subset, $a \to s^{-1}b$ is formally unramified. \end{enumerate} \end{lemma} \begin{proof} follows from lemma \ref{lemma-formally-unramified-local}. (you can also deduce it from lemma \ref{lemma-characterize-formally-unramified} combined with lemma \ref{lemma-differentials-localize}.) \end{proof} \begin{lemma} \label{lemma-colimit-formally-unramified} let $r$ be a ring. let $i$ be a directed set. let $(s_i, \varphi_{ii'})$ be a system of $r$-algebras over $i$. if each $r \to s_i$ is formally unramified, then $s = \colim_{i \in i} s_i$ is formally unramified over $r$ \end{lemma} \begin{proof} consider a diagram as in definition \ref{definition-formally-unramified}. by assumption there exists at most one $r$-algebra map $s_i \to a$ lifting the compositions $s_i \to s \to a/i$. since every element of $s$ is in the image of one of the maps $s_i \to s$ we see that there is at most one map $s \to a$ fitting into the diagram. \end{proof} \section{conormal modules and universal thickenings} \label{section-conormal} \noindent it turns out that one can define the first infinitesimal neighbourhood not just for a closed immersion of schemes, but already for any formally unramified morphism. this is based on the following algebraic fact. \begin{lemma} \label{lemma-universal-thickening} let $r \to s$ be a formally unramified ring map. there exists a surjection of $r$-algebras $s' \to s$ whose kernel is an ideal of square zero with the following universal property: given any commutative diagram $$ \xymatrix{ s \ar[r]_a & a/i \\ r \ar[r]^b \ar[u] & a \ar[u] } $$ where $i \subset a$ is an ideal of square zero, there is a unique $r$-algebra map $a' : s' \to a$ such that $s' \to a \to a/i$ is equal to $s' \to s \to a/i$. \end{lemma} \begin{proof} choose a set of generators $z_i \in s$, $i \in i$ for $s$ as an $r$-algebra. let $p = r[\{x_i\}_{i \in i}]$ denote the polynomial ring on generators $x_i$, $i \in i$. consider the $r$-algebra map $p \to s$ which maps $x_i$ to $z_i$. let $j = \ker(p \to s)$. consider the map $$ \text{d} : j/j^2 \longrightarrow \omega_{p/r} \otimes_p s $$ see lemma \ref{lemma-differential-seq}. this is surjective since $\omega_{s/r} = 0$ by assumption, see lemma \ref{lemma-characterize-formally-unramified}. note that $\omega_{p/r}$ is free on $\text{d}x_i$, and hence the module $\omega_{p/r} \otimes_p s$ is free over $s$. thus we may choose a splitting of the surjection above and write $$ j/j^2 = k \oplus \omega_{p/r} \otimes_p s $$ let $j^2 \subset j' \subset j$ be the ideal of $p$ such that $j'/j^2$ is the second summand in the decomposition above. set $s' = p/j'$. we obtain a short exact sequence $$ 0 \to j/j' \to s' \to s \to 0 $$ and we see that $j/j' \cong k$ is a square zero ideal in $s'$. hence $$ \xymatrix{ s \ar[r]_1 & s \\ r \ar[r] \ar[u] & s' \ar[u] } $$ is a diagram as above. in fact we claim that this is an initial object in the category of diagrams. namely, let $(i \subset a, a, b)$ be an arbitrary diagram. we may choose an $r$-algebra map $\beta : p \to a$ such that $$ \xymatrix{ s \ar[r]_1 & s \ar[r]_a & a/i \\ r \ar[r] \ar@/_/[rr]_b \ar[u] & p \ar[u] \ar[r]^\beta & a \ar[u] } $$ is commutative. now it may not be the case that $\beta(j') = 0$, in other words it may not be true that $\beta$ factors through $s' = p/j'$. but what is clear is that $\beta(j') \subset i$ and since $\beta(j) \subset i$ and $i^2 = 0$ we have $\beta(j^2) = 0$. thus the ``obstruction'' to finding a morphism from $(j/j' \subset s', 1, r \to s')$ to $(i \subset a, a, b)$ is the corresponding $s$-linear map $\overline{\beta} : j'/j^2 \to i$. the choice in picking $\beta$ lies in the choice of $\beta(x_i)$. a different choice of $\beta$, say $\beta'$, is gotten by taking $\beta'(x_i) = \beta(x_i) + \delta_i$ with $\delta_i \in i$. in this case, for $g \in j'$, we obtain $$ \beta'(g) = \beta(g) + \sum\nolimits_i \delta_i \beta(\frac{\partial g}{\partial x_i}) $$ since the map $\text{d}|_{j'/j^2} : j'/j^2 \to \omega_{p/r} \otimes_p s$ given by $g \mapsto \frac{\partial g}{\partial x_i}\text{d}x_i \otimes 1$ is an isomorphism by construction, we see that there is a unique choice of $\delta_i \in i$ such that $\beta'(g) = 0$ for all $g \in j'$. (namely, $\delta_i$ is $-\overline{\beta}(g)$ where $g \in j'/j^2$ is the unique element mapped to $\text{d}x_i \otimes 1$ by $\text{d}|_{j'/j^2}$.) the uniqueness of the solution implies the uniqueness required in the lemma. \end{proof} \noindent in the situation of lemma \ref{lemma-universal-thickening} the $r$-algebra map $s' \to s$ is unique up to unique isomorphism. \begin{definition} \label{definition-universal-thickening} let $r \to s$ be a formally unramified ring map. \begin{enumerate} \item the {\it universal first order thickening} of $s$ over $r$ is the surjection of $r$-algebras $s' \to s$ of lemma \ref{lemma-universal-thickening}. \item the {\it conormal module} of $r \to s$ is the kernel $i$ of the universal first order thickening $s' \to s$, seen as an $s$-module. \end{enumerate} we often denote the conormal module {\it $c_{s/r}$} in this situation. \end{definition} \begin{lemma} \label{lemma-universal-thickening-quotient} let $i \subset r$ be an ideal of a ring. the universal first order thickening of $r/i$ over $r$ is the surjection $r/i^2 \to r/i$. the conormal module of $r/i$ over $r$ is $c_{(r/i)/r} = i/i^2$. \end{lemma} \begin{proof} omitted. \end{proof} \begin{lemma} \label{lemma-universal-thickening-localize} let $a \to b$ be a formally unramified ring map. let $\varphi : b' \to b$ be the universal first order thickening of $b$ over $a$. \begin{enumerate} \item let $s \subset a$ be a multiplicative subset. then $s^{-1}b' \to s^{-1}b$ is the universal first order thickening of $s^{-1}b$ over $s^{-1}a$. in particular $s^{-1}c_{b/a} = c_{s^{-1}b/s^{-1}a}$. \item let $s \subset b$ be a multiplicative subset. then $s' = \varphi^{-1}(s)$ is a multiplicative subset in $b'$ and $(s')^{-1}b' \to s^{-1}b$ is the universal first order thickening of $s^{-1}b$ over $a$. in particular $s^{-1}c_{b/a} = c_{s^{-1}b/a}$. \end{enumerate} note that the lemma makes sense by lemma \ref{lemma-formally-unramified-localize}. \end{lemma} \begin{proof} with notation and assumptions as in (1). let $(s^{-1}b)' \to s^{-1}b$ be the universal first order thickening of $s^{-1}b$ over $s^{-1}a$. note that $s^{-1}b' \to s^{-1}b$ is a surjection of $s^{-1}a$-algebras whose kernel has square zero. hence by definition we obtain a map $(s^{-1}b)' \to s^{-1}b'$ compatible with the maps towards $s^{-1}b$. consider any commutative diagram $$ \xymatrix{ b \ar[r] & s^{-1}b \ar[r] & d/i \\ a \ar[r] \ar[u] & s^{-1}a \ar[r] \ar[u] & d \ar[u] } $$ where $i \subset d$ is an ideal of square zero. since $b'$ is the universal first order thickening of $b$ over $a$ we obtain an $a$-algebra map $b' \to d$. but it is clear that the image of $s$ in $d$ is mapped to invertible elements of $d$, and hence we obtain a compatible map $s^{-1}b' \to d$. applying this to $d = (s^{-1}b)'$ we see that we get a map $s^{-1}b' \to (s^{-1}b)'$. we omit the verification that this map is inverse to the map described above. \medskip\noindent with notation and assumptions as in (2). let $(s^{-1}b)' \to s^{-1}b$ be the universal first order thickening of $s^{-1}b$ over $a$. note that $(s')^{-1}b' \to s^{-1}b$ is a surjection of $a$-algebras whose kernel has square zero. hence by definition we obtain a map $(s^{-1}b)' \to (s')^{-1}b'$ compatible with the maps towards $s^{-1}b$. consider any commutative diagram $$ \xymatrix{ b \ar[r] & s^{-1}b \ar[r] & d/i \\ a \ar[r] \ar[u] & a \ar[r] \ar[u] & d \ar[u] } $$ where $i \subset d$ is an ideal of square zero. since $b'$ is the universal first order thickening of $b$ over $a$ we obtain an $a$-algebra map $b' \to d$. but it is clear that the image of $s'$ in $d$ is mapped to invertible elements of $d$, and hence we obtain a compatible map $(s')^{-1}b' \to d$. applying this to $d = (s^{-1}b)'$ we see that we get a map $(s')^{-1}b' \to (s^{-1}b)'$. we omit the verification that this map is inverse to the map described above. \end{proof} \begin{lemma} \label{lemma-differentials-universal-thickening} let $r \to a \to b$ be ring maps. assume $a \to b$ formally unramified. let $b' \to b$ be the universal first order thickening of $b$ over $a$. then $b'$ is formally unramified over $a$, and the canonical map $\omega_{a/r} \otimes_a b \to \omega_{b'/r} \otimes_{b'} b$ is an isomorphism. \end{lemma} \begin{proof} we are going to use the construction of $b'$ from the proof of lemma \ref{lemma-universal-thickening} although in principle it should be possible to deduce these results formally from the definition. namely, we choose a presentation $b = p/j$, where $p = a[x_i]$ is a polynomial ring over $a$. next, we choose elements $f_i \in j$ such that $\text{d}f_i = \text{d}x_i \otimes 1$ in $\omega_{p/a} \otimes_p b$. having made these choices we have $b' = p/j'$ with $j' = (f_i) + j^2$, see proof of lemma \ref{lemma-universal-thickening}. \medskip\noindent consider the canonical exact sequence $$ j'/(j')^2 \to \omega_{p/a} \otimes_p b' \to \omega_{b'/a} \to 0 $$ see lemma \ref{lemma-differential-seq}. by construction the classes of the $f_i \in j'$ map to elements of the module $\omega_{p/a} \otimes_p b'$ which generate it modulo $j'/j^2$ by construction. since $j'/j^2$ is a nilpotent ideal, we see that these elements generate the module altogether (by nakayama's lemma \ref{lemma-nak}). this proves that $\omega_{b'/a} = 0$ and hence that $b'$ is formally unramified over $a$, see lemma \ref{lemma-characterize-formally-unramified}. \medskip\noindent since $p$ is a polynomial ring over $a$ we have $\omega_{p/r} = \omega_{a/r} \otimes_a p \oplus \bigoplus p\text{d}x_i$. we are going to use this decomposition. consider the following exact sequence $$ j'/(j')^2 \to \omega_{p/r} \otimes_p b' \to \omega_{b'/r} \to 0 $$ see lemma \ref{lemma-differential-seq}. we may tensor this with $b$ and obtain the exact sequence $$ j'/(j')^2 \otimes_{b'} b \to \omega_{p/r} \otimes_p b \to \omega_{b'/r} \otimes_{b'} b \to 0 $$ if we remember that $j' = (f_i) + j^2$ then we see that the first arrow annihilates the submodule $j^2/(j')^2$. in terms of the direct sum decomposition $\omega_{p/r} \otimes_p b = \omega_{a/r} \otimes_a b \oplus \bigoplus b\text{d}x_i $ given we see that the submodule $(f_i)/(j')^2 \otimes_{b'} b$ maps isomorphically onto the summand $\bigoplus b\text{d}x_i$. hence what is left of this exact sequence is an isomorphism $\omega_{a/r} \otimes_a b \to \omega_{b'/r} \otimes_{b'} b$ as desired. \end{proof} \section{formally \'etale maps} \label{section-formally-etale} \begin{definition} \label{definition-formally-etale} let $r \to s$ be a ring map. we say $s$ is {\it formally \'etale over $r$} if for every commutative solid diagram $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & a/i \\ r \ar[r] \ar[u] & a \ar[u] } $$ where $i \subset a$ is an ideal of square zero, there exists a unique dotted arrow making the diagram commute. \end{definition} \noindent clearly a ring map is formally \'etale if and only if it is both formally smooth and formally unramified. \begin{lemma} \label{lemma-base-change-formally-etale} let $r \to s$ be a formally \'etale map. let $r \to r'$ be any ring map. then the base change $s' = r' \otimes_r s$ is formally \'etale over $r'$. \end{lemma} \begin{proof} combine lemmas \ref{lemma-base-change-fs} and \ref{lemma-base-change-formally-unramified}. \end{proof} \begin{lemma} \label{lemma-formally-etale-etale} let $r \to s$ be a ring map of finite presentation. the following are equivalent: \begin{enumerate} \item $r \to s$ is formally \'etale, \item $r \to s$ is \'etale. \end{enumerate} \end{lemma} \begin{proof} assume that $r \to s$ is formally \'etale. then $r \to s$ is smooth by proposition \ref{proposition-smooth-formally-smooth}. by lemma \ref{lemma-characterize-formally-unramified} we have $\omega_{s/r} = 0$. hence $r \to s$ is \'etale by definition. \medskip\noindent assume that $r \to s$ is \'etale. then $r \to s$ is formally smooth by proposition \ref{proposition-smooth-formally-smooth}. by lemma \ref{lemma-characterize-formally-unramified} it is formally unramified. hence $r \to s$ is formally \'etale. \end{proof} \begin{lemma} \label{lemma-colimit-formally-etale} let $r$ be a ring. let $i$ be a directed set. let $(s_i, \varphi_{ii'})$ be a system of $r$-algebras over $i$. if each $r \to s_i$ is formally \'etale, then $s = \colim_{i \in i} s_i$ is formally \'etale over $r$ \end{lemma} \begin{proof} consider a diagram as in definition \ref{definition-formally-etale}. by assumption we get unique $r$-algebra maps $s_i \to a$ lifting the compositions $s_i \to s \to a/i$. hence these are compatible with the transition maps $\varphi_{ii'}$ and define a lift $s \to a$. this proves existence. the uniqueness is clear by restricting to each $s_i$. \end{proof} \begin{lemma} \label{lemma-localization-formally-etale} let $r$ be a ring. let $s \subset r$ be any multiplicative subset. then the ring map $r \to s^{-1}r$ is formally \'etale. \end{lemma} \begin{proof} let $i \subset a$ be an ideal of square zero. what we are saying here is that given a ring map $\varphi : r \to a$ such that $\varphi(f) \mod i$ is invertible for all $f \in s$ we have also that $\varphi(f)$ is invertible in $a$ for all $f \in s$. this is true because $a^*$ is the inverse image of $(a/i)^*$ under the canonical map $a \to a/i$. \end{proof} \begin{lemma} \label{lemma-formally-etale-lift-infinitesimal} let $r \to s$ be a ring map. let $j \subset s$ be an ideal such that $r \to s/j$ is surjective; let $i \subset r$ be the kernel. if $r \to s$ is formally \'etale, then $r/i^n \to s/j^n$ is an isomorphism for all $n$ and $\bigoplus i^n/i^{n + 1} \to \bigoplus j^n/j^{n + 1}$ is an isomorphism of graded rings. \end{lemma} \begin{proof} using the lifting property inductively we find dotted arrows $$ \xymatrix{ s \ar[r] \ar@{-->}[rd] & s/j = r/i \\ r \ar[r] \ar[u] & r/i^2 \ar[u] } \quad \xymatrix{ s \ar[r] \ar@{-->}[rd] & r/i^2 \\ r \ar[r] \ar[u] & r/i^3 \ar[u] } \quad \xymatrix{ s \ar[r] \ar@{-->}[rd] & r/i^3 \\ r \ar[r] \ar[u] & r/i^4 \ar[u] } $$ the corresponding maps $s/j^n \to r/i^n$ are isomorphisms since the compositions $s/j^n \to r/i^n \to s/j^n$ are (inductively) the identity by the uniqueness in the lifting property of formally \'etale ring maps. \end{proof} \begin{lemma} \label{lemma-formally-etale-omega} let $r \to s \to s'$ be ring maps. let $j$, resp.\ $j'$ be the kernel of the multiplication map $s \otimes_r s \to s$, resp.\ $s' \otimes_{r'} s' \to s'$. if $s \to s'$ is formally \'etale, then the map $$ s' \otimes_s \left((s \otimes_r s)/j^{k + 1}\right) \longrightarrow (s' \otimes_r s')/(j')^{k + 1} $$ is an isomorphism for all $k \geq 0$. in particular, the map $s' \otimes_s \omega_{s/r} \to \omega_{s'/r}$ is an isomorphism. \end{lemma} \begin{proof} observe that $s' \otimes_s (s \otimes_r s) = s' \otimes_r s$ and the ideal $j$ generates in $s' \otimes_r s$ the kernel $i$ of the surjection $s' \otimes_r s \to s'$. whence the left hand side is equal to $s' \otimes_r s/i^{k + 1}$. the map $s' \otimes_r s \to s' \otimes_r s'$ is formally \'etale by lemma \ref{lemma-base-change-formally-etale}. thus we conclude that the displayed arrow in the statement of the lemma is an isomorphism by lemma \ref{lemma-formally-etale-lift-infinitesimal}. the final assertion follows from this and the fact that $\omega_{s/r} = j/j^2$ and $\omega_{s'/r} = j'/(j')^2$ by lemma \ref{lemma-differentials-diagonal}. \end{proof} \begin{lemma} \label{lemma-formally-etale-principal-parts} let $r \to s \to s'$ be ring maps with $s \to s'$ formally \'etale (for example \'etale). let $m$ be an $s$-module. set $m' = s' \otimes_r m$. then we have $$ s' \otimes_s p^k_{s/r}(m) = p^k_{s'/r}(m') $$ it follows that for any $s$-module $n$ and any finite order differential operator $d : m \to n$ there exists a unique extension $d' : m' \to s' \otimes_s n$ of $d$ to a differential operator (of the same or lesser order). \end{lemma} \begin{proof} let $j$ and $j'$ be as in the statement of lemma \ref{lemma-formally-etale-omega}. then we have \begin{align*} s' \otimes_s p^k_{s/r}(m) & = s' \otimes_s \left((s \otimes_r m)/j^{k + 1}(s \otimes_r m)\right) \\ & = s' \otimes_s \left((s \otimes_r s)/j^{k + 1}\right) \otimes_s m \\ & = \left(s' \otimes_r s'/(j')^{k + 1}\right) \otimes_s m \\ & = \left(s' \otimes_r s'/(j')^{k + 1}\right) \otimes_{s'} m' \\ & = s' \otimes_r m'/(j')^{k + 1}(s' \otimes_r m') \\ & = p^k_{s'/r'}(m') \end{align*} the first and the last equalities are from lemma \ref{lemma-principal-parts-diagonal}. the third equality is lemma \ref{lemma-formally-etale-omega}. the final assertion holds because if $d$ corresponds to the linear map $\gamma : p^k_{s/r}(m) \to n$, then we can let $d' : m' \to s' \otimes_r n$ correspond to the linear map $1 \otimes \gamma : s' \otimes_r p^k_{s/r}(m) \to s' \otimes_r n$. \end{proof} \begin{remark} \label{remark-formally-etale-differential-operators} let $r \to s \to s'$ be ring maps with $s \to s'$ formally \'etale (for example \'etale). let $m_i$, $i = 1, 2, 3$ be $s$-modules and let $d_i : m_i \to m_{i + 1}$, $i = 1, 2$ be differential operators of finite order. then if $d'_i : m'_i \to m'_{i + 1}$, $i = 1, 2$ are the extensions of $d_i$ to $m'_i = s' \otimes_s m_i$ as in lemma \ref{lemma-formally-etale-principal-parts}, then $d'_2 \circ d'_1$ is the extension of $d_2 \circ d_1$. in particular, if $m$ is an $s$-module, then $m' = s' \otimes_s m$ is a module over the $s$-algebra $\text{diff}_{s/r}(m, m)$. \end{remark} \section{unramified ring maps} \label{section-unramified} \noindent the definition of a g-unramified ring map is the one from ega. the definition of an unramified ring map is the one from \cite{henselian}. \begin{definition} \label{definition-unramified} let $r \to s$ be a ring map. \begin{enumerate} \item we say $r \to s$ is {\it unramified} if $r \to s$ is of finite type and $\omega_{s/r} = 0$. \item we say $r \to s$ is {\it g-unramified} if $r \to s$ is of finite presentation and $\omega_{s/r} = 0$. \item given a prime $\mathfrak q$ of $s$ we say that $s$ is {\it unramified at $\mathfrak q$} if there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is unramified. \item given a prime $\mathfrak q$ of $s$ we say that $s$ is {\it g-unramified at $\mathfrak q$} if there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is g-unramified. \end{enumerate} \end{definition} \noindent of course a g-unramified map is unramified. \begin{lemma} \label{lemma-formally-unramified-unramified} let $r \to s$ be a ring map. the following are equivalent \begin{enumerate} \item $r \to s$ is formally unramified and of finite type, and \item $r \to s$ is unramified. \end{enumerate} moreover, also the following are equivalent \begin{enumerate} \item $r \to s$ is formally unramified and of finite presentation, and \item $r \to s$ is g-unramified. \end{enumerate} \end{lemma} \begin{proof} follows from lemma \ref{lemma-characterize-formally-unramified} and the definitions. \end{proof} \begin{lemma} \label{lemma-unramified} properties of unramified and g-unramified ring maps. \begin{enumerate} \item the base change of an unramified ring map is unramified. the base change of a g-unramified ring map is g-unramified. \item the composition of unramified ring maps is unramified. the composition of g-unramified ring maps is g-unramified. \item any principal localization $r \to r_f$ is g-unramified and unramified. \item if $i \subset r$ is an ideal, then $r \to r/i$ is unramified. if $i \subset r$ is a finitely generated ideal, then $r \to r/i$ is g-unramified. \item an \'etale ring map is g-unramified and unramified. \item if $r \to s$ is of finite type (resp.\ finite presentation), $\mathfrak q \subset s$ is a prime and $(\omega_{s/r})_{\mathfrak q} = 0$, then $r \to s$ is unramified (resp.\ g-unramified) at $\mathfrak q$. \item if $r \to s$ is of finite type (resp.\ finite presentation), $\mathfrak q \subset s$ is a prime and $\omega_{s/r} \otimes_s \kappa(\mathfrak q) = 0$, then $r \to s$ is unramified (resp.\ g-unramified) at $\mathfrak q$. \item if $r \to s$ is of finite type (resp.\ finite presentation), $\mathfrak q \subset s$ is a prime lying over $\mathfrak p \subset r$ and $(\omega_{s \otimes_r \kappa(\mathfrak p)/\kappa(\mathfrak p)})_{\mathfrak q} = 0$, then $r \to s$ is unramified (resp.\ g-unramified) at $\mathfrak q$. \item if $r \to s$ is of finite type (resp.\ presentation), $\mathfrak q \subset s$ is a prime lying over $\mathfrak p \subset r$ and $(\omega_{s \otimes_r \kappa(\mathfrak p)/\kappa(\mathfrak p)}) \otimes_{s \otimes_r \kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$, then $r \to s$ is unramified (resp.\ g-unramified) at $\mathfrak q$. \item if $r \to s$ is a ring map, $g_1, \ldots, g_m \in s$ generate the unit ideal and $r \to s_{g_j}$ is unramified (resp.\ g-unramified) for $j = 1, \ldots, m$, then $r \to s$ is unramified (resp.\ g-unramified). \item if $r \to s$ is a ring map which is unramified (resp.\ g-unramified) at every prime of $s$, then $r \to s$ is unramified (resp.\ g-unramified). \item if $r \to s$ is g-unramified, then there exists a finite type $\mathbf{z}$-algebra $r_0$ and a g-unramified ring map $r_0 \to s_0$ and a ring map $r_0 \to r$ such that $s = r \otimes_{r_0} s_0$. \item if $r \to s$ is unramified, then there exists a finite type $\mathbf{z}$-algebra $r_0$ and an unramified ring map $r_0 \to s_0$ and a ring map $r_0 \to r$ such that $s$ is a quotient of $r \otimes_{r_0} s_0$. \end{enumerate} \end{lemma} \begin{proof} we prove each point, in order. \medskip\noindent ad (1). follows from lemmas \ref{lemma-differentials-base-change} and \ref{lemma-base-change-finiteness}. \medskip\noindent ad (2). follows from lemmas \ref{lemma-exact-sequence-differentials} and \ref{lemma-base-change-finiteness}. \medskip\noindent ad (3). follows by direct computation of $\omega_{r_f/r}$ which we omit. \medskip\noindent ad (4). we have $\omega_{(r/i)/r} = 0$, see lemma \ref{lemma-trivial-differential-surjective}, and the ring map $r \to r/i$ is of finite type. if $i$ is a finitely generated ideal then $r \to r/i$ is of finite presentation. \medskip\noindent ad (5). see discussion following definition \ref{definition-etale}. \medskip\noindent ad (6). in this case $\omega_{s/r}$ is a finite $s$-module (see lemma \ref{lemma-differentials-finitely-generated}) and hence there exists a $g \in s$, $g \not \in \mathfrak q$ such that $(\omega_{s/r})_g = 0$. by lemma \ref{lemma-differentials-localize} this means that $\omega_{s_g/r} = 0$ and hence $r \to s_g$ is unramified as desired. \medskip\noindent ad (7). use nakayama's lemma (lemma \ref{lemma-nak}) to see that the condition is equivalent to the condition of (6). \medskip\noindent ad (8) and (9). these are equivalent in the same manner that (6) and (7) are equivalent. moreover $\omega_{s \otimes_r \kappa(\mathfrak p)/\kappa(\mathfrak p)} = \omega_{s/r} \otimes_s (s \otimes_r \kappa(\mathfrak p))$ by lemma \ref{lemma-differentials-base-change}. hence we see that (9) is equivalent to (7) since the $\kappa(\mathfrak q)$ vector spaces in both are canonically isomorphic. \medskip\noindent ad (10). follows from lemmas \ref{lemma-cover} and \ref{lemma-differentials-localize}. \medskip\noindent ad (11). follows from (6) and (7) and the fact that the spectrum of $s$ is quasi-compact. \medskip\noindent ad (12). write $s = r[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. as $\omega_{s/r} = 0$ we can write $$ \text{d}x_i = \sum h_{ij}\text{d}g_j + \sum a_{ijk}g_j\text{d}x_k $$ in $\omega_{r[x_1, \ldots, x_n]/r}$ for some $h_{ij}, a_{ijk} \in r[x_1, \ldots, x_n]$. choose a finitely generated $\mathbf{z}$-subalgebra $r_0 \subset r$ containing all the coefficients of the polynomials $g_i, h_{ij}, a_{ijk}$. set $s_0 = r_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. this works. \medskip\noindent ad (13). write $s = r[x_1, \ldots, x_n]/i$. as $\omega_{s/r} = 0$ we can write $$ \text{d}x_i = \sum h_{ij}\text{d}g_{ij} + \sum g'_{ik}\text{d}x_k $$ in $\omega_{r[x_1, \ldots, x_n]/r}$ for some $h_{ij} \in r[x_1, \ldots, x_n]$ and $g_{ij}, g'_{ik} \in i$. choose a finitely generated $\mathbf{z}$-subalgebra $r_0 \subset r$ containing all the coefficients of the polynomials $g_{ij}, h_{ij}, g'_{ik}$. set $s_0 = r_0[x_1, \ldots, x_n]/(g_{ij}, g'_{ik})$. this works. \end{proof} \begin{lemma} \label{lemma-diagonal-unramified} let $r \to s$ be a ring map. if $r \to s$ is unramified, then there exists an idempotent $e \in s \otimes_r s$ such that $s \otimes_r s \to s$ is isomorphic to $s \otimes_r s \to (s \otimes_r s)_e$. \end{lemma} \begin{proof} let $j = \ker(s \otimes_r s \to s)$. by assumption $j/j^2 = 0$, see lemma \ref{lemma-differentials-diagonal}. since $s$ is of finite type over $r$ we see that $j$ is finitely generated, namely by $x_i \otimes 1 - 1 \otimes x_i$, where $x_i$ generate $s$ over $r$. we win by lemma \ref{lemma-ideal-is-squared-union-connected}. \end{proof} \begin{lemma} \label{lemma-unramified-at-prime} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p$ in $r$. if $s/r$ is unramified at $\mathfrak q$ then \begin{enumerate} \item we have $\mathfrak p s_{\mathfrak q} = \mathfrak qs_{\mathfrak q}$ is the maximal ideal of the local ring $s_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is finite separable. \end{enumerate} \end{lemma} \begin{proof} we may first replace $s$ by $s_g$ for some $g \in s$, $g \not \in \mathfrak q$ and assume that $r \to s$ is unramified. the base change $s \otimes_r \kappa(\mathfrak p)$ is unramified over $\kappa(\mathfrak p)$ by lemma \ref{lemma-unramified}. by lemma \ref{lemma-characterize-smooth-over-field} it is smooth hence \'etale over $\kappa(\mathfrak p)$. hence we see that $s \otimes_r \kappa(\mathfrak p) = (r \setminus \mathfrak p)^{-1} s/\mathfrak ps$ is a product of finite separable field extensions of $\kappa(\mathfrak p)$ by lemma \ref{lemma-etale-over-field}. this implies the lemma. \end{proof} \begin{lemma} \label{lemma-unramified-quasi-finite} let $r \to s$ be a finite type ring map. let $\mathfrak q$ be a prime of $s$. if $r \to s$ is unramified at $\mathfrak q$ then $r \to s$ is quasi-finite at $\mathfrak q$. in particular, an unramified ring map is quasi-finite. \end{lemma} \begin{proof} an unramified ring map is of finite type. thus it is clear that the second statement follows from the first. to see the first statement apply the characterization of lemma \ref{lemma-isolated-point-fibre} part (2) using lemma \ref{lemma-unramified-at-prime}. \end{proof} \begin{lemma} \label{lemma-characterize-unramified} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime of $s$ lying over a prime $\mathfrak p$ of $r$. if \begin{enumerate} \item $r \to s$ is of finite type, \item $\mathfrak p s_{\mathfrak q}$ is the maximal ideal of the local ring $s_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is finite separable, \end{enumerate} then $r \to s$ is unramified at $\mathfrak q$. \end{lemma} \begin{proof} by lemma \ref{lemma-unramified} (8) it suffices to show that $\omega_{s \otimes_r \kappa(\mathfrak p) / \kappa(\mathfrak p)}$ is zero when localized at $\mathfrak q$. hence we may replace $s$ by $s \otimes_r \kappa(\mathfrak p)$ and $r$ by $\kappa(\mathfrak p)$. in other words, we may assume that $r = k$ is a field and $s$ is a finite type $k$-algebra. in this case the hypotheses imply that $s_{\mathfrak q} \cong \kappa(\mathfrak q)$. thus $(\omega_{s/k})_{\mathfrak q} = \omega_{s_\mathfrak q/k} = \omega_{\kappa(\mathfrak q)/k}$ is zero as desired (the first equality is lemma \ref{lemma-differentials-localize}). \end{proof} \begin{lemma} \label{lemma-etale-flat-unramified-finite-presentation} let $r \to s$ be a ring map. the following are equivalent \begin{enumerate} \item $r \to s$ is \'etale, \item $r \to s$ is flat and g-unramified, and \item $r \to s$ is flat, unramified, and of finite presentation. \end{enumerate} \end{lemma} \begin{proof} parts (2) and (3) are equivalent by definition. the implication (1) $\rightarrow$ (3) follows from the fact that \'etale ring maps are of finite presentation, lemma \ref{lemma-etale} (flatness of \'etale maps), and lemma \ref{lemma-unramified} (\'etale maps are unramified). conversely, the characterization of \'etale ring maps in lemma \ref{lemma-characterize-etale} and the structure of unramified ring maps in lemma \ref{lemma-unramified-at-prime} shows that (3) implies (1). (this uses that $r \to s$ is \'etale if $r \to s$ is \'etale at every prime $\mathfrak q \subset s$, see lemma \ref{lemma-etale}.) \end{proof} \begin{lemma} \label{lemma-characterize-etale-over-polynomial-ring} let $k$ be a field. let $$ \varphi : k[x_1, \ldots, x_n] \to a, \quad x_i \longmapsto a_i $$ be a finite type ring map. then $\varphi$ is \'etale if and only if we have the following two conditions: (a) the local rings of $a$ at maximal ideals have dimension $n$, and (b) the elements $\text{d}(a_1), \ldots, \text{d}(a_n)$ generate $\omega_{a/k}$ as an $a$-module. \end{lemma} \begin{proof} assume (a) and (b). condition (b) implies that $\omega_{a/k[x_1, \ldots, x_n]} = 0$ and hence $\varphi$ is unramified. thus it suffices to prove that $\varphi$ is flat, see lemma \ref{lemma-etale-flat-unramified-finite-presentation}. let $\mathfrak m \subset a$ be a maximal ideal. set $x = \spec(a)$ and denote $x \in x$ the closed point corresponding to $\mathfrak m$. then $\dim(a_\mathfrak m)$ is $\dim_x x$, see lemma \ref{lemma-dimension-closed-point-finite-type-field}. thus by lemma \ref{lemma-characterize-smooth-over-field} we see that if (a) and (b) hold, then $a_\mathfrak m$ is a regular local ring for every maximal ideal $\mathfrak m$. then $k[x_1, \ldots, x_n]_{\varphi^{-1}(\mathfrak m)} \to a_\mathfrak m$ is flat by lemma \ref{lemma-cm-over-regular-flat} (and the fact that a regular local ring is cm, see lemma \ref{lemma-regular-ring-cm}). thus $\varphi$ is flat by lemma \ref{lemma-flat-localization}. \medskip\noindent assume $\varphi$ is \'etale. then $\omega_{a/k[x_1, \ldots, x_n]} = 0$ and hence (b) holds. on the other hand, \'etale ring maps are flat (lemma \ref{lemma-etale}) and quasi-finite (lemma \ref{lemma-etale-quasi-finite}). hence for every maximal ideal $\mathfrak m$ of $a$ we my apply lemma \ref{lemma-dimension-base-fibre-equals-total} to $k[x_1, \ldots, x_n]_{\varphi^{-1}(\mathfrak m)} \to a_\mathfrak m$ to see that $\dim(a_\mathfrak m) = n$ and hence (a) holds. \end{proof} \section{local structure of unramified ring maps} \label{section-local-structure-unramified} \noindent an unramified morphism is locally (in a suitable sense) the composition of a closed immersion and an \'etale morphism. the algebraic underpinnings of this fact are discussed in this section. \begin{proposition} \label{proposition-unramified-locally-standard} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime. if $r \to s$ is unramified at $\mathfrak q$, then there exist \begin{enumerate} \item a $g \in s$, $g \not \in \mathfrak q$, \item a standard \'etale ring map $r \to s'$, and \item a surjective $r$-algebra map $s' \to s_g$. \end{enumerate} \end{proposition} \begin{proof} this proof is the ``same'' as the proof of proposition \ref{proposition-etale-locally-standard}. the proof is a little roundabout and there may be ways to shorten it. \medskip\noindent step 1. by definition \ref{definition-unramified} there exists a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is unramified. thus we may assume that $s$ is unramified over $r$. \medskip\noindent step 2. by lemma \ref{lemma-unramified} there exists an unramified ring map $r_0 \to s_0$ with $r_0$ of finite type over $\mathbf{z}$, and a ring map $r_0 \to r$ such that $s$ is a quotient of $r \otimes_{r_0} s_0$. denote $\mathfrak q_0$ the prime of $s_0$ corresponding to $\mathfrak q$. if we show the result for $(r_0 \to s_0, \mathfrak q_0)$ then the result follows for $(r \to s, \mathfrak q)$ by base change. hence we may assume that $r$ is noetherian. \medskip\noindent step 3. note that $r \to s$ is quasi-finite by lemma \ref{lemma-unramified-quasi-finite}. by lemma \ref{lemma-quasi-finite-open-integral-closure} there exists a finite ring map $r \to s'$, an $r$-algebra map $s' \to s$, an element $g' \in s'$ such that $g' \not \in \mathfrak q$ such that $s' \to s$ induces an isomorphism $s'_{g'} \cong s_{g'}$. (note that $s'$ may not be unramified over $r$.) thus we may assume that (a) $r$ is noetherian, (b) $r \to s$ is finite and (c) $r \to s$ is unramified at $\mathfrak q$ (but no longer necessarily unramified at all primes). \medskip\noindent step 4. let $\mathfrak p \subset r$ be the prime corresponding to $\mathfrak q$. consider the fibre ring $s \otimes_r \kappa(\mathfrak p)$. this is a finite algebra over $\kappa(\mathfrak p)$. hence it is artinian (see lemma \ref{lemma-finite-dimensional-algebra}) and so a finite product of local rings $$ s \otimes_r \kappa(\mathfrak p) = \prod\nolimits_{i = 1}^n a_i $$ see proposition \ref{proposition-dimension-zero-ring}. one of the factors, say $a_1$, is the local ring $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ which is isomorphic to $\kappa(\mathfrak q)$, see lemma \ref{lemma-unramified-at-prime}. the other factors correspond to the other primes, say $\mathfrak q_2, \ldots, \mathfrak q_n$ of $s$ lying over $\mathfrak p$. \medskip\noindent step 5. we may choose a nonzero element $\alpha \in \kappa(\mathfrak q)$ which generates the finite separable field extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ (so even if the field extension is trivial we do not allow $\alpha = 0$). note that for any $\lambda \in \kappa(\mathfrak p)^*$ the element $\lambda \alpha$ also generates $\kappa(\mathfrak q)$ over $\kappa(\mathfrak p)$. consider the element $$ \overline{t} = (\alpha, 0, \ldots, 0) \in \prod\nolimits_{i = 1}^n a_i = s \otimes_r \kappa(\mathfrak p). $$ after possibly replacing $\alpha$ by $\lambda \alpha$ as above we may assume that $\overline{t}$ is the image of $t \in s$. let $i \subset r[x]$ be the kernel of the $r$-algebra map $r[x] \to s$ which maps $x$ to $t$. set $s' = r[x]/i$, so $s' \subset s$. here is a diagram $$ \xymatrix{ r[x] \ar[r] & s' \ar[r] & s \\ r \ar[u] \ar[ru] \ar[rru] & & } $$ by construction the primes $\mathfrak q_j$, $j \geq 2$ of $s$ all lie over the prime $(\mathfrak p, x)$ of $r[x]$, whereas the prime $\mathfrak q$ lies over a different prime of $r[x]$ because $\alpha \not = 0$. \medskip\noindent step 6. denote $\mathfrak q' \subset s'$ the prime of $s'$ corresponding to $\mathfrak q$. by the above $\mathfrak q$ is the only prime of $s$ lying over $\mathfrak q'$. thus we see that $s_{\mathfrak q} = s_{\mathfrak q'}$, see lemma \ref{lemma-unique-prime-over-localize-below} (we have going up for $s' \to s$ by lemma \ref{lemma-integral-going-up} since $s' \to s$ is finite as $r \to s$ is finite). it follows that $s'_{\mathfrak q'} \to s_{\mathfrak q}$ is finite and injective as the localization of the finite injective ring map $s' \to s$. consider the maps of local rings $$ r_{\mathfrak p} \to s'_{\mathfrak q'} \to s_{\mathfrak q} $$ the second map is finite and injective. we have $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q} = \kappa(\mathfrak q)$, see lemma \ref{lemma-unramified-at-prime}. hence a fortiori $s_{\mathfrak q}/\mathfrak q's_{\mathfrak q} = \kappa(\mathfrak q)$. since $$ \kappa(\mathfrak p) \subset \kappa(\mathfrak q') \subset \kappa(\mathfrak q) $$ and since $\alpha$ is in the image of $\kappa(\mathfrak q')$ in $\kappa(\mathfrak q)$ we conclude that $\kappa(\mathfrak q') = \kappa(\mathfrak q)$. hence by nakayama's lemma \ref{lemma-nak} applied to the $s'_{\mathfrak q'}$-module map $s'_{\mathfrak q'} \to s_{\mathfrak q}$, the map $s'_{\mathfrak q'} \to s_{\mathfrak q}$ is surjective. in other words, $s'_{\mathfrak q'} \cong s_{\mathfrak q}$. \medskip\noindent step 7. by lemma \ref{lemma-isomorphic-local-rings} there exist $g \in s$, $g \not \in \mathfrak q$ and $g' \in s'$, $g' \not \in \mathfrak q'$ such that $s'_{g'} \cong s_g$. as $r$ is noetherian the ring $s'$ is finite over $r$ because it is an $r$-submodule of the finite $r$-module $s$. hence after replacing $s$ by $s'$ we may assume that (a) $r$ is noetherian, (b) $s$ finite over $r$, (c) $s$ is unramified over $r$ at $\mathfrak q$, and (d) $s = r[x]/i$. \medskip\noindent step 8. consider the ring $s \otimes_r \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]/\overline{i}$ where $\overline{i} = i \cdot \kappa(\mathfrak p)[x]$ is the ideal generated by $i$ in $\kappa(\mathfrak p)[x]$. as $\kappa(\mathfrak p)[x]$ is a pid we know that $\overline{i} = (\overline{h})$ for some monic $\overline{h} \in \kappa(\mathfrak p)$. after replacing $\overline{h}$ by $\lambda \cdot \overline{h}$ for some $\lambda \in \kappa(\mathfrak p)$ we may assume that $\overline{h}$ is the image of some $h \in r[x]$. (the problem is that we do not know if we may choose $h$ monic.) also, as in step 4 we know that $s \otimes_r \kappa(\mathfrak p) = a_1 \times \ldots \times a_n$ with $a_1 = \kappa(\mathfrak q)$ a finite separable extension of $\kappa(\mathfrak p)$ and $a_2, \ldots, a_n$ local. this implies that $$ \overline{h} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n} $$ for certain pairwise coprime irreducible monic polynomials $\overline{h}_i \in \kappa(\mathfrak p)[x]$ and certain $e_2, \ldots, e_n \geq 1$. here the numbering is chosen so that $a_i = \kappa(\mathfrak p)[x]/(\overline{h}_i^{e_i})$ as $\kappa(\mathfrak p)[x]$-algebras. note that $\overline{h}_1$ is the minimal polynomial of $\alpha \in \kappa(\mathfrak q)$ and hence is a separable polynomial (its derivative is prime to itself). \medskip\noindent step 9. let $m \in i$ be a monic element; such an element exists because the ring extension $r \to r[x]/i$ is finite hence integral. denote $\overline{m}$ the image in $\kappa(\mathfrak p)[x]$. we may factor $$ \overline{m} = \overline{k} \overline{h}_1^{d_1} \overline{h}_2^{d_2} \ldots \overline{h}_n^{d_n} $$ for some $d_1 \geq 1$, $d_j \geq e_j$, $j = 2, \ldots, n$ and $\overline{k} \in \kappa(\mathfrak p)[x]$ prime to all the $\overline{h}_i$. set $f = m^l + h$ where $l \deg(m) > \deg(h)$, and $l \geq 2$. then $f$ is monic as a polynomial over $r$. also, the image $\overline{f}$ of $f$ in $\kappa(\mathfrak p)[x]$ factors as $$ \overline{f} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n} + \overline{k}^l \overline{h}_1^{ld_1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n} = \overline{h}_1(\overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n} + \overline{k}^l \overline{h}_1^{ld_1 - 1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n}) = \overline{h}_1 \overline{w} $$ with $\overline{w}$ a polynomial relatively prime to $\overline{h}_1$. set $g = f'$ (the derivative with respect to $x$). \medskip\noindent step 10. the ring map $r[x] \to s = r[x]/i$ has the properties: (1) it maps $f$ to zero, and (2) it maps $g$ to an element of $s \setminus \mathfrak q$. the first assertion is clear since $f$ is an element of $i$. for the second assertion we just have to show that $g$ does not map to zero in $\kappa(\mathfrak q) = \kappa(\mathfrak p)[x]/(\overline{h}_1)$. the image of $g$ in $\kappa(\mathfrak p)[x]$ is the derivative of $\overline{f}$. thus (2) is clear because $$ \overline{g} = \frac{\text{d}\overline{f}}{\text{d}x} = \overline{w}\frac{\text{d}\overline{h}_1}{\text{d}x} + \overline{h}_1\frac{\text{d}\overline{w}}{\text{d}x}, $$ $\overline{w}$ is prime to $\overline{h}_1$ and $\overline{h}_1$ is separable. \medskip\noindent step 11. we conclude that $\varphi : r[x]/(f) \to s$ is a surjective ring map, $r[x]_g/(f)$ is \'etale over $r$ (because it is standard \'etale, see lemma \ref{lemma-standard-etale}) and $\varphi(g) \not \in \mathfrak q$. thus the map $(r[x]/(f))_g \to s_{\varphi(g)}$ is the desired surjection. \end{proof} \begin{lemma} \label{lemma-etale-makes-unramified-closed-at-prime} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime of $s$ lying over $\mathfrak p \subset r$. assume that $r \to s$ is of finite type and unramified at $\mathfrak q$. then there exist \begin{enumerate} \item an \'etale ring map $r \to r'$, \item a prime $\mathfrak p' \subset r'$ lying over $\mathfrak p$. \item a product decomposition $$ r' \otimes_r s = a \times b $$ \end{enumerate} with the following properties \begin{enumerate} \item $r' \to a$ is surjective, and \item $\mathfrak p'a$ is a prime of $a$ lying over $\mathfrak p'$ and over $\mathfrak q$. \end{enumerate} \end{lemma} \begin{proof} we may replace $(r \to s, \mathfrak p, \mathfrak q)$ with any base change $(r' \to r'\otimes_r s, \mathfrak p', \mathfrak q')$ by an \'etale ring map $r \to r'$ with a prime $\mathfrak p'$ lying over $\mathfrak p$, and a choice of $\mathfrak q'$ lying over both $\mathfrak q$ and $\mathfrak p'$. note also that given $r \to r'$ and $\mathfrak p'$ a suitable $\mathfrak q'$ can always be found. \medskip\noindent the assumption that $r \to s$ is of finite type means that we may apply lemma \ref{lemma-etale-makes-quasi-finite-finite-variant}. thus we may assume that $s = a_1 \times \ldots \times a_n \times b$, that each $r \to a_i$ is finite with exactly one prime $\mathfrak r_i$ lying over $\mathfrak p$ such that $\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$ is purely inseparable and that $r \to b$ is not quasi-finite at any prime lying over $\mathfrak p$. then clearly $\mathfrak q = \mathfrak r_i$ for some $i$, since an unramified morphism is quasi-finite (see lemma \ref{lemma-unramified-quasi-finite}). say $\mathfrak q = \mathfrak r_1$. by lemma \ref{lemma-unramified-at-prime} we see that $\kappa(\mathfrak r_1)/\kappa(\mathfrak p)$ is separable hence the trivial field extension, and that $\mathfrak p(a_1)_{\mathfrak r_1}$ is the maximal ideal. also, by lemma \ref{lemma-unique-prime-over-localize-below} (which applies to $r \to a_1$ because a finite ring map satisfies going up by lemma \ref{lemma-integral-going-up}) we have $(a_1)_{\mathfrak r_1} = (a_1)_{\mathfrak p}$. it follows from nakayama's lemma \ref{lemma-nak} that the map of local rings $r_{\mathfrak p} \to (a_1)_{\mathfrak p} = (a_1)_{\mathfrak r_1}$ is surjective. since $a_1$ is finite over $r$ we see that there exists a $f \in r$, $f \not \in \mathfrak p$ such that $r_f \to (a_1)_f$ is surjective. after replacing $r$ by $r_f$ we win. \end{proof} \begin{lemma} \label{lemma-etale-makes-unramified-closed} \begin{slogan} in an unramified ring map, one can separate the points in a fiber by passing to an \'etale neighbourhood. \end{slogan} let $r \to s$ be a ring map. let $\mathfrak p$ be a prime of $r$. if $r \to s$ is unramified then there exist \begin{enumerate} \item an \'etale ring map $r \to r'$, \item a prime $\mathfrak p' \subset r'$ lying over $\mathfrak p$. \item a product decomposition $$ r' \otimes_r s = a_1 \times \ldots \times a_n \times b $$ \end{enumerate} with the following properties \begin{enumerate} \item $r' \to a_i$ is surjective, \item $\mathfrak p'a_i$ is a prime of $a_i$ lying over $\mathfrak p'$, and \item there is no prime of $b$ lying over $\mathfrak p'$. \end{enumerate} \end{lemma} \begin{proof} we may apply lemma \ref{lemma-etale-makes-quasi-finite-finite-variant}. thus, after an \'etale base change, we may assume that $s = a_1 \times \ldots \times a_n \times b$, that each $r \to a_i$ is finite with exactly one prime $\mathfrak r_i$ lying over $\mathfrak p$ such that $\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$ is purely inseparable, and that $r \to b$ is not quasi-finite at any prime lying over $\mathfrak p$. since $r \to s$ is quasi-finite (see lemma \ref{lemma-unramified-quasi-finite}) we see there is no prime of $b$ lying over $\mathfrak p$. by lemma \ref{lemma-unramified-at-prime} we see that $\kappa(\mathfrak r_i)/\kappa(\mathfrak p)$ is separable hence the trivial field extension, and that $\mathfrak p(a_i)_{\mathfrak r_i}$ is the maximal ideal. also, by lemma \ref{lemma-unique-prime-over-localize-below} (which applies to $r \to a_i$ because a finite ring map satisfies going up by lemma \ref{lemma-integral-going-up}) we have $(a_i)_{\mathfrak r_i} = (a_i)_{\mathfrak p}$. it follows from nakayama's lemma \ref{lemma-nak} that the map of local rings $r_{\mathfrak p} \to (a_i)_{\mathfrak p} = (a_i)_{\mathfrak r_i}$ is surjective. since $a_i$ is finite over $r$ we see that there exists a $f \in r$, $f \not \in \mathfrak p$ such that $r_f \to (a_i)_f$ is surjective. after replacing $r$ by $r_f$ we win. \end{proof} \section{henselian local rings} \label{section-henselian} \noindent in this section we discuss a bit the notion of a henselian local ring. let $(r, \mathfrak m, \kappa)$ be a local ring. for $a \in r$ we denote $\overline{a}$ the image of $a$ in $\kappa$. for a polynomial $f \in r[t]$ we often denote $\overline{f}$ the image of $f$ in $\kappa[t]$. given a polynomial $f \in r[t]$ we denote $f'$ the derivative of $f$ with respect to $t$. note that $\overline{f}' = \overline{f'}$. \begin{definition} \label{definition-henselian} let $(r, \mathfrak m, \kappa)$ be a local ring. \begin{enumerate} \item we say $r$ is {\it henselian} if for every monic $f \in r[t]$ and every root $a_0 \in \kappa$ of $\overline{f}$ such that $\overline{f'}(a_0) \not = 0$ there exists an $a \in r$ such that $f(a) = 0$ and $a_0 = \overline{a}$. \item we say $r$ is {\it strictly henselian} if $r$ is henselian and its residue field is separably algebraically closed. \end{enumerate} \end{definition} \noindent note that the condition $\overline{f'}(a_0) \not = 0$ is equivalent to the condition that $a_0$ is a simple root of the polynomial $\overline{f}$. in fact, it implies that the lift $a \in r$, if it exists, is unique. \begin{lemma} \label{lemma-uniqueness} let $(r, \mathfrak m, \kappa)$ be a local ring. let $f \in r[t]$. let $a, b \in r$ such that $f(a) = f(b) = 0$, $a = b \bmod \mathfrak m$, and $f'(a) \not \in \mathfrak m$. then $a = b$. \end{lemma} \begin{proof} write $f(x + y) - f(x) = f'(x)y + g(x, y) y^2$ in $r[x, y]$ (this is possible as one sees by expanding $f(x + y)$; details omitted). then we see that $0 = f(b) - f(a) = f(a + (b - a)) - f(a) = f'(a)(b - a) + c (b - a)^2$ for some $c \in r$. by assumption $f'(a)$ is a unit in $r$. hence $(b - a)(1 + f'(a)^{-1}c(b - a)) = 0$. by assumption $b - a \in \mathfrak m$, hence $1 + f'(a)^{-1}c(b - a)$ is a unit in $r$. hence $b - a = 0$ in $r$. \end{proof} \noindent here is the characterization of henselian local rings. \begin{lemma} \label{lemma-characterize-henselian} \begin{slogan} characterizations of henselian local rings \end{slogan} let $(r, \mathfrak m, \kappa)$ be a local ring. the following are equivalent \begin{enumerate} \item $r$ is henselian, \item for every $f \in r[t]$ and every root $a_0 \in \kappa$ of $\overline{f}$ such that $\overline{f'}(a_0) \not = 0$ there exists an $a \in r$ such that $f(a) = 0$ and $a_0 = \overline{a}$, \item for any monic $f \in r[t]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $r[t]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$, \item for any monic $f \in r[t]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $r[t]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$ and moreover $\deg_t(g) = \deg_t(g_0)$, \item for any $f \in r[t]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $r[t]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$, \item for any $f \in r[t]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $r[t]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$ and moreover $\deg_t(g) = \deg_t(g_0)$, \item for any \'etale ring map $r \to s$ and prime $\mathfrak q$ of $s$ lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$ there exists a retraction $\tau : s \to r$ of $r \to s$, \item for any \'etale ring map $r \to s$ and prime $\mathfrak q$ of $s$ lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$ there exists a unique retraction $\tau : s \to r$ of $r \to s$ such that $\mathfrak q = \tau^{-1}(\mathfrak m)$, \item any finite $r$-algebra is a product of local rings, \item any finite $r$-algebra is a finite product of local rings, \item any finite type $r$-algebra $s$ can be written as $a \times b$ with $r \to a$ finite and $r \to b$ not quasi-finite at any prime lying over $\mathfrak m$, \item any finite type $r$-algebra $s$ can be written as $a \times b$ with $r \to a$ finite such that each irreducible component of $\spec(b \otimes_r \kappa)$ has dimension $\geq 1$, and \item any quasi-finite $r$-algebra $s$ can be written as $s = a \times b$ with $r \to a$ finite such that $b \otimes_r \kappa = 0$. \end{enumerate} \end{lemma} \begin{proof} here is a list of the easier implications: \begin{enumerate} \item 2$\rightarrow$1 because in (2) we consider all polynomials and in (1) only monic ones, \item 5$\rightarrow$3 because in (5) we consider all polynomials and in (3) only monic ones, \item 6$\rightarrow$4 because in (6) we consider all polynomials and in (4) only monic ones, \item 4$\rightarrow$3 is obvious, \item 6$\rightarrow$5 is obvious, \item 8$\rightarrow$7 is obvious, \item 10$\rightarrow$9 is obvious, \item 11$\leftrightarrow$12 by definition of being quasi-finite at a prime, \item 11$\rightarrow$13 by definition of being quasi-finite, \end{enumerate} \noindent proof of 1$\rightarrow$8. assume (1). let $r \to s$ be \'etale, and let $\mathfrak q \subset s$ be a prime ideal such that $\kappa(\mathfrak q) \cong \kappa$. by proposition \ref{proposition-etale-locally-standard} we can find a $g \in s$, $g \not \in \mathfrak q$ such that $r \to s_g$ is standard \'etale. after replacing $s$ by $s_g$ we may assume that $s = r[t]_g/(f)$ is standard \'etale (details omitted). since the prime $\mathfrak q$ has residue field $\kappa$ it corresponds to a root $a_0$ of $\overline{f}$ which is not a root of $\overline{g}$. by definition of a standard \'etale algebra this also means that $\overline{f'}(a_0) \not = 0$. since also $f$ is monic by definition of a standard \'etale algebra again we may use that $r$ is henselian to conclude that there exists an $a \in r$ with $a_0 = \overline{a}$ such that $f(a) = 0$. this implies that $g(a)$ is a unit of $r$ and we obtain the desired map $\tau : s = r[t]_g/(f) \to r$ by the rule $t \mapsto a$. by construction $\tau^{-1}(\mathfrak m) = \mathfrak q$. by lemma \ref{lemma-uniqueness} the map $\tau$ is unique. this proves (8) holds. \medskip\noindent proof of 7$\rightarrow$8. (this is really unimportant and should be skipped.) assume (7) holds and assume $r \to s$ is \'etale. let $\mathfrak q_1, \ldots, \mathfrak q_r$ be the other primes of $s$ lying over $\mathfrak m$. then we can find a $g \in s$, $g \not \in \mathfrak q$ and $g \in \mathfrak q_i$ for $i = 1, \ldots, r$. namely, we can argue that $\bigcap_{i=1}^{r} \mathfrak{q}_{i} \not\subset \mathfrak{q}$ since otherwise $\mathfrak{q}_{i} \subset \mathfrak{q}$ for some $i$, but this cannot happen as the fiber of an \'etale morphism is discrete (use lemma \ref{lemma-etale-over-field} for example). apply (7) to the \'etale ring map $r \to s_g$ and the prime $\mathfrak qs_g$. this gives a retraction $\tau_g : s_g \to r$ such that the composition $\tau : s \to s_g \to r$ has the property $\tau^{-1}(\mathfrak m) = \mathfrak q$. details omitted. \medskip\noindent proof of 8$\rightarrow$11. assume (8) and let $r \to s$ be a finite type ring map. apply lemma \ref{lemma-etale-makes-quasi-finite-finite}. we find an \'etale ring map $r \to r'$ and a prime $\mathfrak m' \subset r'$ lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak m')$ such that $r' \otimes_r s = a' \times b'$ with $a'$ finite over $r'$ and $b'$ not quasi-finite over $r'$ at any prime lying over $\mathfrak m'$. apply (8) to get a retraction $\tau : r' \to r$ with $\mathfrak m = \tau^{-1}(\mathfrak m')$. then use that $$ s = (s \otimes_r r') \otimes_{r', \tau} r = (a' \times b') \otimes_{r', \tau} r = (a' \otimes_{r', \tau} r) \times (b' \otimes_{r', \tau} r) $$ which gives a decomposition as in (11). \medskip\noindent proof of 8$\rightarrow$10. assume (8) and let $r \to s$ be a finite ring map. apply lemma \ref{lemma-etale-makes-quasi-finite-finite}. we find an \'etale ring map $r \to r'$ and a prime $\mathfrak m' \subset r'$ lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak m')$ such that $r' \otimes_r s = a'_1 \times \ldots \times a'_n \times b'$ with $a'_i$ finite over $r'$ having exactly one prime over $\mathfrak m'$ and $b'$ not quasi-finite over $r'$ at any prime lying over $\mathfrak m'$. apply (8) to get a retraction $\tau : r' \to r$ with $\mathfrak m' = \tau^{-1}(\mathfrak m)$. then we obtain \begin{align*} s & = (s \otimes_r r') \otimes_{r', \tau} r \\ & = (a'_1 \times \ldots \times a'_n \times b') \otimes_{r', \tau} r \\ & = (a'_1 \otimes_{r', \tau} r) \times \ldots \times (a'_1 \otimes_{r', \tau} r) \times (b' \otimes_{r', \tau} r) \\ & = a_1 \times \ldots \times a_n \times b \end{align*} the factor $b$ is finite over $r$ but $r \to b$ is not quasi-finite at any prime lying over $\mathfrak m$. hence $b = 0$. the factors $a_i$ are finite $r$-algebras having exactly one prime lying over $\mathfrak m$, hence they are local rings. this proves that $s$ is a finite product of local rings. \medskip\noindent proof of 9$\rightarrow$10. this holds because if $s$ is finite over the local ring $r$, then it has at most finitely many maximal ideals. namely, by going up for $r \to s$ the maximal ideals of $s$ all lie over $\mathfrak m$, and $s/\mathfrak ms$ is artinian hence has finitely many primes. \medskip\noindent proof of 10$\rightarrow$1. assume (10). let $f \in r[t]$ be a monic polynomial and $a_0 \in \kappa$ a simple root of $\overline{f}$. then $s = r[t]/(f)$ is a finite $r$-algebra. applying (10) we get $s = a_1 \times \ldots \times a_r$ is a finite product of local $r$-algebras. in particular we see that $s/\mathfrak ms = \prod a_i/\mathfrak ma_i$ is the decomposition of $\kappa[t]/(\overline{f})$ as a product of local rings. this means that one of the factors, say $a_1/\mathfrak ma_1$ is the quotient $\kappa[t]/(\overline{f}) \to \kappa[t]/(t - a_0)$. since $a_1$ is a summand of the finite free $r$-module $s$ it is a finite free $r$-module itself. as $a_1/\mathfrak ma_1$ is a $\kappa$-vector space of dimension 1 we see that $a_1 \cong r$ as an $r$-module. clearly this means that $r \to a_1$ is an isomorphism. let $a \in r$ be the image of $t$ under the map $r[t] \to s \to a_1 \to r$. then $f(a) = 0$ and $\overline{a} = a_0$ as desired. \medskip\noindent proof of 13$\rightarrow$1. assume (13). let $f \in r[t]$ be a monic polynomial and $a_0 \in \kappa$ a simple root of $\overline{f}$. then $s_1 = r[t]/(f)$ is a finite $r$-algebra. let $g \in r[t]$ be any element such that $\overline{g} = \overline{f}/(t - a_0)$. then $s = (s_1)_g$ is a quasi-finite $r$-algebra such that $s \otimes_r \kappa \cong \kappa[t]_{\overline{g}}/(\overline{f}) \cong \kappa[t]/(t - a_0) \cong \kappa$. applying (13) to $s$ we get $s = a \times b$ with $a$ finite over $r$ and $b \otimes_r \kappa = 0$. in particular we see that $\kappa \cong s/\mathfrak ms = a/\mathfrak ma$. since $a$ is a summand of the flat $r$-algebra $s$ we see that it is finite flat, hence free over $r$. as $a/\mathfrak ma$ is a $\kappa$-vector space of dimension 1 we see that $a \cong r$ as an $r$-module. clearly this means that $r \to a$ is an isomorphism. let $a \in r$ be the image of $t$ under the map $r[t] \to s \to a \to r$. then $f(a) = 0$ and $\overline{a} = a_0$ as desired. \medskip\noindent proof of 8$\rightarrow$2. assume (8). let $f \in r[t]$ be any polynomial and let $a_0 \in \kappa$ be a simple root. then the algebra $s = r[t]_{f'}/(f)$ is \'etale over $r$. let $\mathfrak q \subset s$ be the prime generated by $\mathfrak m$ and $t - b$ where $b \in r$ is any element such that $\overline{b} = a_0$. apply (8) to $s$ and $\mathfrak q$ to get $\tau : s \to r$. then the image $\tau(t) = a \in r$ works in (2). \medskip\noindent at this point we see that (1), (2), (7), (8), (9), (10), (11), (12), (13) are all equivalent. the weakest assertion of (3), (4), (5) and (6) is (3) and the strongest is (6). hence we still have to prove that (3) implies (1) and (1) implies (6). \medskip\noindent proof of 3$\rightarrow$1. assume (3). let $f \in r[t]$ be monic and let $a_0 \in \kappa$ be a simple root of $\overline{f}$. this gives a factorization $\overline{f} = (t - a_0)h_0$ with $h_0(a_0) \not = 0$, so $\gcd(t - a_0, h_0) = 1$. apply (3) to get a factorization $f = gh$ with $\overline{g} = t - a_0$ and $\overline{h} = h_0$. set $s = r[t]/(f)$ which is a finite free $r$-algebra. we will write $g$, $h$ also for the images of $g$ and $h$ in $s$. then $gs + hs = s$ by nakayama's lemma \ref{lemma-nak} as the equality holds modulo $\mathfrak m$. since $gh = f = 0$ in $s$ this also implies that $gs \cap hs = 0$. hence by the chinese remainder theorem we obtain $s = s/(g) \times s/(h)$. this implies that $a = s/(g)$ is a summand of a finite free $r$-module, hence finite free. moreover, the rank of $a$ is $1$ as $a/\mathfrak ma = \kappa[t]/(t - a_0)$. thus the map $r \to a$ is an isomorphism. setting $a \in r$ equal to the image of $t$ under the maps $r[t] \to s \to a \to r$ gives an element of $r$ with $f(a) = 0$ and $\overline{a} = a_0$. \medskip\noindent proof of 1$\rightarrow$6. assume (1) or equivalently all of (1), (2), (7), (8), (9), (10), (11), (12), (13). let $f \in r[t]$ be a polynomial. suppose that $\overline{f} = g_0h_0$ is a factorization with $\gcd(g_0, h_0) = 1$. we may and do assume that $g_0$ is monic. consider $s = r[t]/(f)$. because we have the factorization we see that the coefficients of $f$ generate the unit ideal in $r$. this implies that $s$ has finite fibres over $r$, hence is quasi-finite over $r$. it also implies that $s$ is flat over $r$ by lemma \ref{lemma-grothendieck-general}. combining (13) and (10) we may write $s = a_1 \times \ldots \times a_n \times b$ where each $a_i$ is local and finite over $r$, and $b \otimes_r \kappa = 0$. after reordering the factors $a_1, \ldots, a_n$ we may assume that $$ \kappa[t]/(g_0) = a_1/\mathfrak m a_1 \times \ldots \times a_r/\mathfrak ma_r, \ \kappa[t]/(h_0) = a_{r + 1}/\mathfrak ma_{r + 1} \times \ldots \times a_n/\mathfrak ma_n $$ as quotients of $\kappa[t]$. the finite flat $r$-algebra $a = a_1 \times \ldots \times a_r$ is free as an $r$-module, see lemma \ref{lemma-finite-flat-local}. its rank is $\deg_t(g_0)$. let $g \in r[t]$ be the characteristic polynomial of the $r$-linear operator $t : a \to a$. then $g$ is a monic polynomial of degree $\deg_t(g) = \deg_t(g_0)$ and moreover $\overline{g} = g_0$. by cayley-hamilton (lemma \ref{lemma-charpoly}) we see that $g(t_a) = 0$ where $t_a$ indicates the image of $t$ in $a$. hence we obtain a well defined surjective map $r[t]/(g) \to a$ which is an isomorphism by nakayama's lemma \ref{lemma-nak}. the map $r[t] \to a$ factors through $r[t]/(f)$ by construction hence we may write $f = gh$ for some $h$. this finishes the proof. \end{proof} \begin{lemma} \label{lemma-finite-over-henselian} let $(r, \mathfrak m, \kappa)$ be a henselian local ring. \begin{enumerate} \item if $r \to s$ is a finite ring map then $s$ is a finite product of henselian local rings each finite over $r$. \item if $r \to s$ is a finite ring map and $s$ is local, then $s$ is a henselian local ring and $r \to s$ is a (finite) local ring map. \item if $r \to s$ is a finite type ring map, and $\mathfrak q$ is a prime of $s$ lying over $\mathfrak m$ at which $r \to s$ is quasi-finite, then $s_{\mathfrak q}$ is henselian and finite over $r$. \item if $r \to s$ is quasi-finite then $s_{\mathfrak q}$ is henselian and finite over $r$ for every prime $\mathfrak q$ lying over $\mathfrak m$. \end{enumerate} \end{lemma} \begin{proof} part (2) implies part (1) since $s$ as in part (1) is a finite product of its localizations at the primes lying over $\mathfrak m$ by lemma \ref{lemma-characterize-henselian} part (10). part (2) also follows from lemma \ref{lemma-characterize-henselian} part (10) since any finite $s$-algebra is also a finite $r$-algebra (of course any finite ring map between local rings is local). \medskip\noindent let $r \to s$ and $\mathfrak q$ be as in (3). write $s = a \times b$ with $a$ finite over $r$ and $b$ not quasi-finite over $r$ at any prime lying over $\mathfrak m$, see lemma \ref{lemma-characterize-henselian} part (11). hence $s_\mathfrak q$ is a localization of $a$ at a maximal ideal and we deduce (3) from (1). part (4) follows from part (3). \end{proof} \begin{lemma} \label{lemma-mop-up} let $(r, \mathfrak m, \kappa)$ be a henselian local ring. any finite type $r$-algebra $s$ can be written as $s = a_1 \times \ldots \times a_n \times b$ with $a_i$ local and finite over $r$ and $r \to b$ not quasi-finite at any prime of $b$ lying over $\mathfrak m$. \end{lemma} \begin{proof} this is a combination of parts (11) and (10) of lemma \ref{lemma-characterize-henselian}. \end{proof} \begin{lemma} \label{lemma-mop-up-strictly-henselian} let $(r, \mathfrak m, \kappa)$ be a strictly henselian local ring. any finite type $r$-algebra $s$ can be written as $s = a_1 \times \ldots \times a_n \times b$ with $a_i$ local and finite over $r$ and $\kappa \subset \kappa(\mathfrak m_{a_i})$ finite purely inseparable and $r \to b$ not quasi-finite at any prime of $b$ lying over $\mathfrak m$. \end{lemma} \begin{proof} first write $s = a_1 \times \ldots \times a_n \times b$ as in lemma \ref{lemma-mop-up}. the field extension $\kappa(\mathfrak m_{a_i})/\kappa$ is finite and $\kappa$ is separably algebraically closed, hence it is finite purely inseparable. \end{proof} \begin{lemma} \label{lemma-henselian-cat-finite-etale} let $(r, \mathfrak m, \kappa)$ be a henselian local ring. the category of finite \'etale ring extensions $r \to s$ is equivalent to the category of finite \'etale algebras $\kappa \to \overline{s}$ via the functor $s \mapsto s/\mathfrak ms$. \end{lemma} \begin{proof} denote $\mathcal{c} \to \mathcal{d}$ the functor of categories of the statement. suppose that $r \to s$ is finite \'etale. then we may write $$ s = a_1 \times \ldots \times a_n $$ with $a_i$ local and finite \'etale over $s$, use either lemma \ref{lemma-mop-up} or lemma \ref{lemma-characterize-henselian} part (10). in particular $a_i/\mathfrak ma_i$ is a finite separable field extension of $\kappa$, see lemma \ref{lemma-etale-at-prime}. thus we see that every object of $\mathcal{c}$ and $\mathcal{d}$ decomposes canonically into irreducible pieces which correspond via the given functor. next, suppose that $s_1$, $s_2$ are finite \'etale over $r$ such that $\kappa_1 = s_1/\mathfrak ms_1$ and $\kappa_2 = s_2/\mathfrak ms_2$ are fields (finite separable over $\kappa$). then $s_1 \otimes_r s_2$ is finite \'etale over $r$ and we may write $$ s_1 \otimes_r s_2 = a_1 \times \ldots \times a_n $$ as before. then we see that $\hom_r(s_1, s_2)$ is identified with the set of indices $i \in \{1, \ldots, n\}$ such that $s_2 \to a_i$ is an isomorphism. to see this use that given any $r$-algebra map $\varphi : s_1 \to s_2$ the map $\varphi \times 1 : s_1 \otimes_r s_2 \to s_2$ is surjective, and hence is equal to projection onto one of the factors $a_i$. but in exactly the same way we see that $\hom_\kappa(\kappa_1, \kappa_2)$ is identified with the set of indices $i \in \{1, \ldots, n\}$ such that $\kappa_2 \to a_i/\mathfrak ma_i$ is an isomorphism. by the discussion above these sets of indices match, and we conclude that our functor is fully faithful. finally, let $\kappa'/\kappa$ be a finite separable field extension. by lemma \ref{lemma-make-etale-map-prescribed-residue-field} there exists an \'etale ring map $r \to s$ and a prime $\mathfrak q$ of $s$ lying over $\mathfrak m$ such that $\kappa \subset \kappa(\mathfrak q)$ is isomorphic to the given extension. by part (1) we may write $s = a_1 \times \ldots \times a_n \times b$. since $r \to s$ is quasi-finite we see that there exists no prime of $b$ over $\mathfrak m$. hence $s_{\mathfrak q}$ is equal to $a_i$ for some $i$. hence $r \to a_i$ is finite \'etale and produces the given residue field extension. thus the functor is essentially surjective and we win. \end{proof} \begin{lemma} \label{lemma-unramified-over-strictly-henselian} let $(r, \mathfrak m, \kappa)$ be a strictly henselian local ring. let $r \to s$ be an unramified ring map. then $$ s = a_1 \times \ldots \times a_n \times b $$ with each $r \to a_i$ surjective and no prime of $b$ lying over $\mathfrak m$. \end{lemma} \begin{proof} first write $s = a_1 \times \ldots \times a_n \times b$ as in lemma \ref{lemma-mop-up}. now we see that $r \to a_i$ is finite unramified and $a_i$ local. hence the maximal ideal of $a_i$ is $\mathfrak ma_i$ and its residue field $a_i / \mathfrak m a_i$ is a finite separable extension of $\kappa$, see lemma \ref{lemma-unramified-at-prime}. however, the condition that $r$ is strictly henselian means that $\kappa$ is separably algebraically closed, so $\kappa = a_i / \mathfrak m a_i$. by nakayama's lemma \ref{lemma-nak} we conclude that $r \to a_i$ is surjective as desired. \end{proof} \begin{lemma} \label{lemma-complete-henselian} \begin{slogan} complete local rings are henselian by newton's method \end{slogan} let $(r, \mathfrak m, \kappa)$ be a complete local ring, see definition \ref{definition-complete-local-ring}. then $r$ is henselian. \end{lemma} \begin{proof} let $f \in r[t]$ be monic. denote $f_n \in r/\mathfrak m^{n + 1}[t]$ the image. denote $f'_n$ the derivative of $f_n$ with respect to $t$. let $a_0 \in \kappa$ be a simple root of $f_0$. we lift this to a solution of $f$ over $r$ inductively as follows: suppose given $a_n \in r/\mathfrak m^{n + 1}$ such that $a_n \bmod \mathfrak m = a_0$ and $f_n(a_n) = 0$. pick any element $b \in r/\mathfrak m^{n + 2}$ such that $a_n = b \bmod \mathfrak m^{n + 1}$. then $f_{n + 1}(b) \in \mathfrak m^{n + 1}/\mathfrak m^{n + 2}$. set $$ a_{n + 1} = b - f_{n + 1}(b)/f'_{n + 1}(b) $$ (newton's method). this makes sense as $f'_{n + 1}(b) \in r/\mathfrak m^{n + 2}$ is invertible by the condition on $a_0$. then we compute $f_{n + 1}(a_{n + 1}) = f_{n + 1}(b) - f_{n + 1}(b) = 0$ in $r/\mathfrak m^{n + 2}$. since the system of elements $a_n \in r/\mathfrak m^{n + 1}$ so constructed is compatible we get an element $a \in \lim r/\mathfrak m^n = r$ (here we use that $r$ is complete). moreover, $f(a) = 0$ since it maps to zero in each $r/\mathfrak m^n$. finally $\overline{a} = a_0$ and we win. \end{proof} \begin{lemma} \label{lemma-local-dimension-zero-henselian} \begin{slogan} local rings of dimension zero are henselian. \end{slogan} let $(r, \mathfrak m)$ be a local ring of dimension $0$. then $r$ is henselian. \end{lemma} \begin{proof} let $r \to s$ be a finite ring map. by lemma \ref{lemma-characterize-henselian} it suffices to show that $s$ is a product of local rings. by lemma \ref{lemma-finite-finite-fibres} $s$ has finitely many primes $\mathfrak m_1, \ldots, \mathfrak m_r$ which all lie over $\mathfrak m$. there are no inclusions among these primes, see lemma \ref{lemma-integral-no-inclusion}, hence they are all maximal. every element of $\mathfrak m_1 \cap \ldots \cap \mathfrak m_r$ is nilpotent by lemma \ref{lemma-zariski-topology}. it follows $s$ is the product of the localizations of $s$ at the primes $\mathfrak m_i$ by lemma \ref{lemma-product-local}. \end{proof} \noindent the following lemma will be the key to the uniqueness and functorial properties of henselization and strict henselization. \begin{lemma} \label{lemma-map-into-henselian} let $r \to s$ be a ring map with $s$ henselian local. given \begin{enumerate} \item an \'etale ring map $r \to a$, \item a prime $\mathfrak q$ of $a$ lying over $\mathfrak p = r \cap \mathfrak m_s$, \item a $\kappa(\mathfrak p)$-algebra map $\tau : \kappa(\mathfrak q) \to s/\mathfrak m_s$, \end{enumerate} then there exists a unique homomorphism of $r$-algebras $f : a \to s$ such that $\mathfrak q = f^{-1}(\mathfrak m_s)$ and $f$ induces the map $\tau$ on residue fields. \end{lemma} \begin{proof} consider $a \otimes_r s$. this is an \'etale algebra over $s$, see lemma \ref{lemma-etale}. moreover, the kernel $$ \mathfrak q' = \ker(a \otimes_r s \to \kappa(\mathfrak q) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak m_s) \xrightarrow{\tau \otimes 1} \kappa(\mathfrak m_s)) $$ is a prime ideal lying over $\mathfrak m_s$ with residue field equal to the residue field of $s$. hence by lemma \ref{lemma-characterize-henselian} there exists a unique retraction $\sigma : a \otimes_r s \to s$ with $\sigma^{-1}(\mathfrak m_s) = \mathfrak q'$. set $f$ equal to the composition $a \to a \otimes_r s \to s$. we omit the verification of the properties of $f$; the uniqueness of $f$ comes from the uniqueness of $\sigma$ (details omitted). \end{proof} \begin{lemma} \label{lemma-strictly-henselian-solutions} let $\varphi : r \to s$ be a local homomorphism of strictly henselian local rings. let $p_1, \ldots, p_n \in r[x_1, \ldots, x_n]$ be polynomials such that $r[x_1, \ldots, x_n]/(p_1, \ldots, p_n)$ is \'etale over $r$. then the map $$ r^n \longrightarrow s^n, \quad (h_1, \ldots, h_n) \longmapsto (\varphi(h_1), \ldots, \varphi(h_n)) $$ induces a bijection between $$ \{ (r_1, \ldots, r_n) \in r^n \mid p_i(r_1, \ldots, r_n) = 0, \ i = 1, \ldots, n \} $$ and $$ \{ (s_1, \ldots, s_n) \in s^n \mid p^\varphi_i(s_1, \ldots, s_n) = 0, \ i = 1, \ldots, n \} $$ where $p^\varphi_i \in s[x_1, \ldots, x_n]$ are the images of the $p_i$ under $\varphi$. \end{lemma} \begin{proof} the first solution set is canonically isomorphic to the set $$ \hom_r(r[x_1, \ldots, x_n]/(p_1, \ldots, p_n), r). $$ as $r$ is henselian the map $r \to r/\mathfrak m_r$ induces a bijection between this set and the set of solutions in the residue field $r/\mathfrak m_r$, see lemma \ref{lemma-characterize-henselian}. the same is true for $s$. now since $r[x_1, \ldots, x_n]/(p_1, \ldots, p_n)$ is \'etale over $r$ and $r/\mathfrak m_r$ is separably algebraically closed we see that $r/\mathfrak m_r[x_1, \ldots, x_n]/(\overline{p}_1, \ldots, \overline{p}_n)$ is a finite product of copies of $r/\mathfrak m_r$ where $\overline{p}_i$ is the image of $p_i$ in $r/\mathfrak m_r[x_1, \ldots, x_n]$. hence the tensor product $$ r/\mathfrak m_r[x_1, \ldots, x_n]/(\overline{p}_1, \ldots, \overline{p}_n) \otimes_{r/\mathfrak m_r} s/\mathfrak m_s = s/\mathfrak m_s[x_1, \ldots, x_n]/ (\overline{p}^\varphi_1, \ldots, \overline{p}^\varphi_n) $$ is also a finite product of copies of $s/\mathfrak m_s$ with the same index set. this proves the lemma. \end{proof} \begin{lemma} \label{lemma-split-ml-henselian} let $r$ be a henselian local ring. any countably generated mittag-leffler module over $r$ is a direct sum of finitely presented $r$-modules. \end{lemma} \begin{proof} let $m$ be a countably generated and mittag-leffler $r$-module. we claim that for any element $x \in m$ there exists a direct sum decomposition $m = n \oplus k$ with $x \in n$, the module $n$ finitely presented, and $k$ mittag-leffler. \medskip\noindent suppose the claim is true. choose generators $x_1, x_2, x_3, \ldots$ of $m$. by the claim we can inductively find direct sum decompositions $$ m = n_1 \oplus n_2 \oplus \ldots \oplus n_n \oplus k_n $$ with $n_i$ finitely presented, $x_1, \ldots, x_n \in n_1 \oplus \ldots \oplus n_n$, and $k_n$ mittag-leffler. repeating ad infinitum we see that $m = \bigoplus n_i$. \medskip\noindent we still have to prove the claim. let $x \in m$. by lemma \ref{lemma-ml-countable} there exists an endomorphism $\alpha : m \to m$ such that $\alpha$ factors through a finitely presented module, and $\alpha (x) = x$. say $\alpha$ factors as $$ \xymatrix{ m \ar[r]^\pi & p \ar[r]^i & m } $$ set $a = \pi \circ \alpha \circ i : p \to p$, so $i \circ a \circ \pi = \alpha^3$. by lemma \ref{lemma-charpoly-module} there exists a monic polynomial $p \in r[t]$ such that $p(a) = 0$. note that this implies formally that $\alpha^2 p(\alpha) = 0$. hence we may think of $m$ as a module over $r[t]/(t^2p)$. assume that $x \not = 0$. then $\alpha(x) = x$ implies that $0 = \alpha^2p(\alpha)x = p(1)x$ hence $p(1) = 0$ in $r/i$ where $i = \{r \in r \mid rx = 0\}$ is the annihilator of $x$. as $x \not = 0$ we see $i \subset \mathfrak m_r$, hence $1$ is a root of $\overline{p} = p \bmod \mathfrak m_r \in r/\mathfrak m_r[t]$. as $r$ is henselian we can find a factorization $$ t^2p = (t^2 q_1) q_2 $$ for some $q_1, q_2 \in r[t]$ with $q_2 = (t - 1)^e \bmod \mathfrak m_r r[t]$ and $q_1(1) \not = 0 \bmod \mathfrak m_r$, see lemma \ref{lemma-characterize-henselian}. let $n = \im(\alpha^2q_1(\alpha) : m \to m)$ and $k = \im(q_2(\alpha) : m \to m)$. as $t^2q_1$ and $q_2$ generate the unit ideal of $r[t]$ we get a direct sum decomposition $m = n \oplus k$. moreover, $q_2$ acts as zero on $n$ and $t^2q_1$ acts as zero on $k$. note that $n$ is a quotient of $p$ hence is finitely generated. also $x \in n$ because $\alpha^2q_1(\alpha)x = q_1(1)x$ and $q_1(1)$ is a unit in $r$. by lemma \ref{lemma-direct-sum-ml} the modules $n$ and $k$ are mittag-leffler. finally, the finitely generated module $n$ is finitely presented as a finitely generated mittag-leffler module is finitely presented, see example \ref{example-ml} part (1). \end{proof} \section{filtered colimits of \'etale ring maps} \label{section-ind-etale} \noindent this section is a precursor to the section on ind-\'etale ring maps (pro-\'etale cohomology, section \ref{proetale-section-ind-etale}). the material will also be useful to prove uniqueness properties of the henselization and strict henselization of a local ring. \begin{lemma} \label{lemma-base-change-colimit-etale} let $r \to a$ and $r \to r'$ be ring maps. if $a$ is a filtered colimit of \'etale ring maps, then so is $r' \to r' \otimes_r a$. \end{lemma} \begin{proof} this is true because colimits commute with tensor products and \'etale ring maps are preserved under base change (lemma \ref{lemma-etale}). \end{proof} \begin{lemma} \label{lemma-composition-colimit-etale} let $a \to b \to c$ be ring maps. if $a \to b$ is a filtered colimit of \'etale ring maps and $b \to c$ is a filtered colimit of \'etale ring maps, then $a \to c$ is a filtered colimit of \'etale ring maps. \end{lemma} \begin{proof} we will use the criterion of lemma \ref{lemma-when-colimit}. let $a \to p \to c$ be a factorization of $a \to c$ with $p$ of finite presentation over $a$. write $b = \colim_{i \in i} b_i$ where $i$ is a directed set and where $b_i$ is an \'etale $a$-algebra. write $c = \colim_{j \in j} c_j$ where $j$ is a directed set and where $c_j$ is an \'etale $b$-algebra. we can factor $p \to c$ as $p \to c_j \to c$ for some $j$ by lemma \ref{lemma-characterize-finite-presentation}. by lemma \ref{lemma-etale} we can find an $i \in i$ and an \'etale ring map $b_i \to c'_j$ such that $c_j = b \otimes_{b_i} c'_j$. then $c_j = \colim_{i' \geq i} b_{i'} \otimes_{b_i} c'_j$ and again we see that $p \to c_j$ factors as $p \to b_{i'} \otimes_{b_i} c'_j \to c$. as $a \to c' = b_{i'} \otimes_{b_i} c'_j$ is \'etale as compositions and tensor products of \'etale ring maps are \'etale. hence we have factored $p \to c$ as $p \to c' \to c$ with $c'$ \'etale over $a$ and the criterion of lemma \ref{lemma-when-colimit} applies. \end{proof} \begin{lemma} \label{lemma-colimit-colimit-etale} let $r$ be a ring. let $a = \colim a_i$ be a filtered colimit of $r$-algebras such that each $a_i$ is a filtered colimit of \'etale $r$-algebras. then $a$ is a filtered colimit of \'etale $r$-algebras. \end{lemma} \begin{proof} write $a_i = \colim_{j \in j_i} a_j$ where $j_i$ is a directed set and $a_j$ is an \'etale $r$-algebra. for each $i \leq i'$ and $j \in j_i$ there exists an $j' \in j_{i'}$ and an $r$-algebra map $\varphi_{jj'} : a_j \to a_{j'}$ making the diagram $$ \xymatrix{ a_i \ar[r] & a_{i'} \\ a_j \ar[u] \ar[r]^{\varphi_{jj'}} & a_{j'} \ar[u] } $$ commute. this is true because $r \to a_j$ is of finite presentation so that lemma \ref{lemma-characterize-finite-presentation} applies. let $\mathcal{j}$ be the category with objects $\coprod_{i \in i} j_i$ and morphisms triples $(j, j', \varphi_{jj'})$ as above (and obvious composition law). then $\mathcal{j}$ is a filtered category and $a = \colim_\mathcal{j} a_j$. details omitted. \end{proof} \begin{lemma} \label{lemma-colimit-colimit-etale-better} let $i$ be a directed set. let $i \mapsto (r_i \to a_i)$ be a system of arrows of rings over $i$. set $r = \colim r_i$ and $a = \colim a_i$. if each $a_i$ is a filtered colimit of \'etale $r_i$-algebras, then $a$ is a filtered colimit of \'etale $r$-algebras. \end{lemma} \begin{proof} this is true because $a = a \otimes_r r = \colim a_i \otimes_{r_i} r$ and hence we can apply lemma \ref{lemma-colimit-colimit-etale} because $r \to a_i \otimes_{r_i} r$ is a filtered colimit of \'etale ring maps by lemma \ref{lemma-base-change-colimit-etale}. \end{proof} \begin{lemma} \label{lemma-colimits-of-etale} let $r$ be a ring. let $a \to b$ be an $r$-algebra homomorphism. if $a$ and $b$ are filtered colimits of \'etale $r$-algebras, then $b$ is a filtered colimit of \'etale $a$-algebras. \end{lemma} \begin{proof} write $a = \colim a_i$ and $b = \colim b_j$ as filtered colimits with $a_i$ and $b_j$ \'etale over $r$. for each $i$ we can find a $j$ such that $a_i \to b$ factors through $b_j$, see lemma \ref{lemma-characterize-finite-presentation}. the factorization $a_i \to b_j$ is \'etale by lemma \ref{lemma-map-between-etale}. since $a \to a \otimes_{a_i} b_j$ is \'etale (lemma \ref{lemma-etale}) it suffices to prove that $b = \colim a \otimes_{a_i} b_j$ where the colimit is over pairs $(i, j)$ and factorizations $a_i \to b_j \to b$ of $a_i \to b$ (this is a directed system; details omitted). this is clear because colimits commute with tensor products and hence $\colim a \otimes_{a_i} b_j = a \otimes_a b = b$. \end{proof} \begin{lemma} \label{lemma-map-into-henselian-colimit} let $r \to s$ be a ring map with $s$ henselian local. given \begin{enumerate} \item an $r$-algebra $a$ which is a filtered colimit of \'etale $r$-algebras, \item a prime $\mathfrak q$ of $a$ lying over $\mathfrak p = r \cap \mathfrak m_s$, \item a $\kappa(\mathfrak p)$-algebra map $\tau : \kappa(\mathfrak q) \to s/\mathfrak m_s$, \end{enumerate} then there exists a unique homomorphism of $r$-algebras $f : a \to s$ such that $\mathfrak q = f^{-1}(\mathfrak m_s)$ and $f \bmod \mathfrak q = \tau$. \end{lemma} \begin{proof} write $a = \colim a_i$ as a filtered colimit of \'etale $r$-algebras. set $\mathfrak q_i = a_i \cap \mathfrak q$. we obtain $f_i : a_i \to s$ by applying lemma \ref{lemma-map-into-henselian}. set $f = \colim f_i$. \end{proof} \begin{lemma} \label{lemma-uniqueness-henselian} let $r$ be a ring. given a commutative diagram of ring maps $$ \xymatrix{ s \ar[r] & k \\ r \ar[u] \ar[r] & s' \ar[u] } $$ where $s$, $s'$ are henselian local, $s$, $s'$ are filtered colimits of \'etale $r$-algebras, $k$ is a field and the arrows $s \to k$ and $s' \to k$ identify $k$ with the residue field of both $s$ and $s'$. then there exists a unique $r$-algebra isomorphism $s \to s'$ compatible with the maps to $k$. \end{lemma} \begin{proof} follows immediately from lemma \ref{lemma-map-into-henselian-colimit}. \end{proof} \noindent the following lemma is not strictly speaking about colimits of \'etale ring maps. \begin{lemma} \label{lemma-colimit-henselian} a filtered colimit of (strictly) henselian local rings along local homomorphisms is (strictly) henselian. \end{lemma} \begin{proof} categories, lemma \ref{categories-lemma-directed-category-system} says that this is really just a question about a colimit of (strictly) henselian local rings over a directed set. let $(r_i, \varphi_{ii'})$ be such a system with each $\varphi_{ii'}$ local. then $r = \colim_i r_i$ is local, and its residue field $\kappa$ is $\colim \kappa_i$ (argument omitted). it is easy to see that $\colim \kappa_i$ is separably algebraically closed if each $\kappa_i$ is so; thus it suffices to prove $r$ is henselian if each $r_i$ is henselian. suppose that $f \in r[t]$ is monic and that $a_0 \in \kappa$ is a simple root of $\overline{f}$. then for some large enough $i$ there exists an $f_i \in r_i[t]$ mapping to $f$ and an $a_{0, i} \in \kappa_i$ mapping to $a_0$. since $\overline{f_i}(a_{0, i}) \in \kappa_i$, resp.\ $\overline{f_i'}(a_{0, i}) \in \kappa_i$ maps to $0 = \overline{f}(a_0) \in \kappa$, resp.\ $0 \not = \overline{f'}(a_0) \in \kappa$ we conclude that $a_{0, i}$ is a simple root of $\overline{f_i}$. as $r_i$ is henselian we can find $a_i \in r_i$ such that $f_i(a_i) = 0$ and $a_{0, i} = \overline{a_i}$. then the image $a \in r$ of $a_i$ is the desired solution. thus $r$ is henselian. \end{proof} \section{henselization and strict henselization} \label{section-henselization} \noindent in this section we construct the henselization. we encourage the reader to keep in mind the uniqueness already proved in lemma \ref{lemma-uniqueness-henselian} and the functorial behaviour pointed out in lemma \ref{lemma-map-into-henselian-colimit} while reading this material. \begin{lemma} \label{lemma-henselization} let $(r, \mathfrak m, \kappa)$ be a local ring. there exists a local ring map $r \to r^h$ with the following properties \begin{enumerate} \item $r^h$ is henselian, \item $r^h$ is a filtered colimit of \'etale $r$-algebras, \item $\mathfrak m r^h$ is the maximal ideal of $r^h$, and \item $\kappa = r^h/\mathfrak m r^h$. \end{enumerate} \end{lemma} \begin{proof} consider the category of pairs $(s, \mathfrak q)$ where $r \to s$ is an \'etale ring map, and $\mathfrak q$ is a prime of $s$ lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$. a morphism of pairs $(s, \mathfrak q) \to (s', \mathfrak q')$ is given by an $r$-algebra map $\varphi : s \to s'$ such that $\varphi^{-1}(\mathfrak q') = \mathfrak q$. we set $$ r^h = \colim_{(s, \mathfrak q)} s. $$ let us show that the category of pairs is filtered, see categories, definition \ref{categories-definition-directed}. the category contains the pair $(r, \mathfrak m)$ and hence is not empty, which proves part (1) of categories, definition \ref{categories-definition-directed}. for any pair $(s, \mathfrak q)$ the prime ideal $\mathfrak q$ is maximal with residue field $\kappa$ since the composition $\kappa \to s/\mathfrak q \to \kappa(\mathfrak q)$ is an isomorphism. suppose that $(s, \mathfrak q)$ and $(s', \mathfrak q')$ are two objects. set $s'' = s \otimes_r s'$ and $\mathfrak q'' = \mathfrak qs'' + \mathfrak q's''$. then $s''/\mathfrak q'' = s/\mathfrak q \otimes_r s'/\mathfrak q' = \kappa$ by what we said above. moreover, $r \to s''$ is \'etale by lemma \ref{lemma-etale}. this proves part (2) of categories, definition \ref{categories-definition-directed}. next, suppose that $\varphi, \psi : (s, \mathfrak q) \to (s', \mathfrak q')$ are two morphisms of pairs. then $\varphi$, $\psi$, and $s' \otimes_r s' \to s'$ are \'etale ring maps by lemma \ref{lemma-map-between-etale}. consider $$ s'' = (s' \otimes_{\varphi, s, \psi} s') \otimes_{s' \otimes_r s'} s' $$ with prime ideal $$ \mathfrak q'' = (\mathfrak q' \otimes s' + s' \otimes \mathfrak q') \otimes s' + (s' \otimes_{\varphi, s, \psi} s') \otimes \mathfrak q' $$ arguing as above (base change of \'etale maps is \'etale, composition of \'etale maps is \'etale) we see that $s''$ is \'etale over $r$. moreover, the canonical map $s' \to s''$ (using the right most factor for example) equalizes $\varphi$ and $\psi$. this proves part (3) of categories, definition \ref{categories-definition-directed}. hence we conclude that $r^h$ consists of triples $(s, \mathfrak q, f)$ with $f \in s$, and two such triples $(s, \mathfrak q, f)$, $(s', \mathfrak q', f')$ define the same element of $r^h$ if and only if there exists a pair $(s'', \mathfrak q'')$ and morphisms of pairs $\varphi : (s, \mathfrak q) \to (s'', \mathfrak q'')$ and $\varphi' : (s', \mathfrak q') \to (s'', \mathfrak q'')$ such that $\varphi(f) = \varphi'(f')$. \medskip\noindent suppose that $x \in r^h$. represent $x$ by a triple $(s, \mathfrak q, f)$. let $\mathfrak q_1, \ldots, \mathfrak q_r$ be the other primes of $s$ lying over $\mathfrak m$. then $\mathfrak q \not \subset \mathfrak q_i$ as we have seen above that $\mathfrak q$ is maximal. thus, since $\mathfrak q$ is a prime ideal, we can find a $g \in s$, $g \not \in \mathfrak q$ and $g \in \mathfrak q_i$ for $i = 1, \ldots, r$. consider the morphism of pairs $(s, \mathfrak q) \to (s_g, \mathfrak qs_g)$. in this way we see that we may always assume that $x$ is given by a triple $(s, \mathfrak q, f)$ where $\mathfrak q$ is the only prime of $s$ lying over $\mathfrak m$, i.e., $\sqrt{\mathfrak ms} = \mathfrak q$. but since $r \to s$ is \'etale, we have $\mathfrak ms_{\mathfrak q} = \mathfrak qs_{\mathfrak q}$, see lemma \ref{lemma-etale-at-prime}. hence we actually get that $\mathfrak ms = \mathfrak q$. \medskip\noindent suppose that $x \not \in \mathfrak mr^h$. represent $x$ by a triple $(s, \mathfrak q, f)$ with $\mathfrak ms = \mathfrak q$. then $f \not \in \mathfrak ms$, i.e., $f \not \in \mathfrak q$. hence $(s, \mathfrak q) \to (s_f, \mathfrak qs_f)$ is a morphism of pairs such that the image of $f$ becomes invertible. hence $x$ is invertible with inverse represented by the triple $(s_f, \mathfrak qs_f, 1/f)$. we conclude that $r^h$ is a local ring with maximal ideal $\mathfrak mr^h$. the residue field is $\kappa$ since we can define $r^h/\mathfrak mr^h \to \kappa$ by mapping a triple $(s, \mathfrak q, f)$ to the residue class of $f$ modulo $\mathfrak q$. \medskip\noindent we still have to show that $r^h$ is henselian. namely, suppose that $p \in r^h[t]$ is a monic polynomial and $a_0 \in \kappa$ is a simple root of the reduction $\overline{p} \in \kappa[t]$. then we can find a pair $(s, \mathfrak q)$ such that $p$ is the image of a monic polynomial $q \in s[t]$. set $s' = s[t]/(q)$ and let $\mathfrak q' \subset s'$ be the maximal ideal $\mathfrak q' = \mathfrak qs' + (t - a')s'$ where $a' \in s$ is any element lifting $a_0$. by construction $s \to s'$ is \'etale at $\mathfrak q'$ and $\kappa = \kappa(\mathfrak q')$. pick $g \in s'$, $g \not \in \mathfrak q'$ such that $s'' = s'_g$ is \'etale over $s$. then $(s, \mathfrak q) \to (s'', \mathfrak q's'')$ is a morphism of pairs. now that triple $(s'', \mathfrak q's'', \text{class of }t)$ determines an element $a \in r^h$ with the properties $p(a) = 0$, and $\overline{a} = a_0$ as desired. \end{proof} \begin{lemma} \label{lemma-strict-henselization} let $(r, \mathfrak m, \kappa)$ be a local ring. let $\kappa \subset \kappa^{sep}$ be a separable algebraic closure. there exists a commutative diagram $$ \xymatrix{ \kappa \ar[r] & \kappa \ar[r] & \kappa^{sep} \\ r \ar[r] \ar[u] & r^h \ar[r] \ar[u] & r^{sh} \ar[u] } $$ with the following properties \begin{enumerate} \item the map $r^h \to r^{sh}$ is local \item $r^{sh}$ is strictly henselian, \item $r^{sh}$ is a filtered colimit of \'etale $r$-algebras, \item $\mathfrak m r^{sh}$ is the maximal ideal of $r^{sh}$, and \item $\kappa^{sep} = r^{sh}/\mathfrak m r^{sh}$. \end{enumerate} \end{lemma} \begin{proof} this is proved by exactly the same proof as used for lemma \ref{lemma-henselization}. the only difference is that, instead of pairs, one uses triples $(s, \mathfrak q, \alpha)$ where $r \to s$ \'etale, $\mathfrak q$ is a prime of $s$ lying over $\mathfrak m$, and $\alpha : \kappa(\mathfrak q) \to \kappa^{sep}$ is an embedding of extensions of $\kappa$. \end{proof} \begin{definition} \label{definition-henselization} let $(r, \mathfrak m, \kappa)$ be a local ring. \begin{enumerate} \item the local ring map $r \to r^h$ constructed in lemma \ref{lemma-henselization} is called the {\it henselization} of $r$. \item given a separable algebraic closure $\kappa \subset \kappa^{sep}$ the local ring map $r \to r^{sh}$ constructed in lemma \ref{lemma-strict-henselization} is called the {\it strict henselization of $r$ with respect to $\kappa \subset \kappa^{sep}$}. \item a local ring map $r \to r^{sh}$ is called a {\it strict henselization} of $r$ if it is isomorphic to one of the local ring maps constructed in lemma \ref{lemma-strict-henselization} \end{enumerate} \end{definition} \noindent the maps $r \to r^h \to r^{sh}$ are flat local ring homomorphisms. by lemma \ref{lemma-uniqueness-henselian} the $r$-algebras $r^h$ and $r^{sh}$ are well defined up to unique isomorphism by the conditions that they are henselian local, filtered colimits of \'etale $r$-algebras with residue field $\kappa$ and $\kappa^{sep}$. in the rest of this section we mostly just discuss functoriality of the (strict) henselizations. we will discuss more intricate results concerning the relationship between $r$ and its henselization in more on algebra, section \ref{more-algebra-section-permanence-henselization}. \begin{remark} \label{remark-construct-sh-from-h} we can also construct $r^{sh}$ from $r^h$. namely, for any finite separable subextension $\kappa^{sep}/\kappa'/\kappa$ there exists a unique (up to unique isomorphism) finite \'etale local ring extension $r^h \subset r^h(\kappa')$ whose residue field extension reproduces the given extension, see lemma \ref{lemma-henselian-cat-finite-etale}. hence we can set $$ r^{sh} = \bigcup\nolimits_{\kappa \subset \kappa' \subset \kappa^{sep}} r^h(\kappa') $$ the arrows in this system, compatible with the arrows on the level of residue fields, exist by lemma \ref{lemma-henselian-cat-finite-etale}. this will produce a henselian local ring by lemma \ref{lemma-colimit-henselian} since each of the rings $r^h(\kappa')$ is henselian by lemma \ref{lemma-finite-over-henselian}. by construction the residue field extension induced by $r^h \to r^{sh}$ is the field extension $\kappa^{sep}/\kappa$. hence $r^{sh}$ so constructed is strictly henselian. by lemma \ref{lemma-composition-colimit-etale} the $r$-algebra $r^{sh}$ is a colimit of \'etale $r$-algebras. hence the uniqueness of lemma \ref{lemma-uniqueness-henselian} shows that $r^{sh}$ is the strict henselization. \end{remark} \begin{lemma} \label{lemma-henselian-functorial-prepare} let $r \to s$ be a local map of local rings. let $s \to s^h$ be the henselization. let $r \to a$ be an \'etale ring map and let $\mathfrak q$ be a prime of $a$ lying over $\mathfrak m_r$ such that $r/\mathfrak m_r \cong \kappa(\mathfrak q)$. then there exists a unique morphism of rings $f : a \to s^h$ fitting into the commutative diagram $$ \xymatrix{ a \ar[r]_f & s^h \\ r \ar[u] \ar[r] & s \ar[u] } $$ such that $f^{-1}(\mathfrak m_{s^h}) = \mathfrak q$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-map-into-henselian}. \end{proof} \begin{lemma} \label{lemma-henselian-functorial} let $r \to s$ be a local map of local rings. let $r \to r^h$ and $s \to s^h$ be the henselizations. there exists a unique local ring map $r^h \to s^h$ fitting into the commutative diagram $$ \xymatrix{ r^h \ar[r]_f & s^h \\ r \ar[u] \ar[r] & s \ar[u] } $$ \end{lemma} \begin{proof} follows immediately from lemma \ref{lemma-map-into-henselian-colimit}. \end{proof} \noindent here is a slightly different construction of the henselization. \begin{lemma} \label{lemma-henselization-different} let $r$ be a ring. let $\mathfrak p \subset r$ be a prime ideal. consider the category of pairs $(s, \mathfrak q)$ where $r \to s$ is \'etale and $\mathfrak q$ is a prime lying over $\mathfrak p$ such that $\kappa(\mathfrak p) = \kappa(\mathfrak q)$. this category is filtered and $$ (r_{\mathfrak p})^h = \colim_{(s, \mathfrak q)} s = \colim_{(s, \mathfrak q)} s_{\mathfrak q} $$ canonically. \end{lemma} \begin{proof} a morphism of pairs $(s, \mathfrak q) \to (s', \mathfrak q')$ is given by an $r$-algebra map $\varphi : s \to s'$ such that $\varphi^{-1}(\mathfrak q') = \mathfrak q$. let us show that the category of pairs is filtered, see categories, definition \ref{categories-definition-directed}. the category contains the pair $(r, \mathfrak p)$ and hence is not empty, which proves part (1) of categories, definition \ref{categories-definition-directed}. suppose that $(s, \mathfrak q)$ and $(s', \mathfrak q')$ are two pairs. note that $\mathfrak q$, resp.\ $\mathfrak q'$ correspond to primes of the fibre rings $s \otimes \kappa(\mathfrak p)$, resp.\ $s' \otimes \kappa(\mathfrak p)$ with residue fields $\kappa(\mathfrak p)$, hence they correspond to maximal ideals of $s \otimes \kappa(\mathfrak p)$, resp.\ $s' \otimes \kappa(\mathfrak p)$. set $s'' = s \otimes_r s'$. by the above there exists a unique prime $\mathfrak q'' \subset s''$ lying over $\mathfrak q$ and over $\mathfrak q'$ whose residue field is $\kappa(\mathfrak p)$. the ring map $r \to s''$ is \'etale by lemma \ref{lemma-etale}. this proves part (2) of categories, definition \ref{categories-definition-directed}. next, suppose that $\varphi, \psi : (s, \mathfrak q) \to (s', \mathfrak q')$ are two morphisms of pairs. then $\varphi$, $\psi$, and $s' \otimes_r s' \to s'$ are \'etale ring maps by lemma \ref{lemma-map-between-etale}. consider $$ s'' = (s' \otimes_{\varphi, s, \psi} s') \otimes_{s' \otimes_r s'} s' $$ arguing as above (base change of \'etale maps is \'etale, composition of \'etale maps is \'etale) we see that $s''$ is \'etale over $r$. the fibre ring of $s''$ over $\mathfrak p$ is $$ f'' = (f' \otimes_{\varphi, f, \psi} f') \otimes_{f' \otimes_{\kappa(\mathfrak p)} f'} f' $$ where $f', f$ are the fibre rings of $s'$ and $s$. since $\varphi$ and $\psi$ are morphisms of pairs the map $f' \to \kappa(\mathfrak p)$ corresponding to $\mathfrak p'$ extends to a map $f'' \to \kappa(\mathfrak p)$ and in turn corresponds to a prime ideal $\mathfrak q'' \subset s''$ whose residue field is $\kappa(\mathfrak p)$. the canonical map $s' \to s''$ (using the right most factor for example) is a morphism of pairs $(s', \mathfrak q') \to (s'', \mathfrak q'')$ which equalizes $\varphi$ and $\psi$. this proves part (3) of categories, definition \ref{categories-definition-directed}. hence we conclude that the category is filtered. \medskip\noindent recall that in the proof of lemma \ref{lemma-henselization} we constructed $(r_{\mathfrak p})^h$ as the corresponding colimit but starting with $r_{\mathfrak p}$ and its maximal ideal $\mathfrak pr_{\mathfrak p}$. now, given any pair $(s, \mathfrak q)$ for $(r, \mathfrak p)$ we obtain a pair $(s_{\mathfrak p}, \mathfrak qs_{\mathfrak p})$ for $(r_{\mathfrak p}, \mathfrak pr_{\mathfrak p})$. moreover, in this situation $$ s_{\mathfrak p} = \colim_{f \in r, f \not \in \mathfrak p} s_f. $$ hence in order to show the equalities of the lemma, it suffices to show that any pair $(s_{loc}, \mathfrak q_{loc})$ for $(r_{\mathfrak p}, \mathfrak pr_{\mathfrak p})$ is of the form $(s_{\mathfrak p}, \mathfrak qs_{\mathfrak p})$ for some pair $(s, \mathfrak q)$ over $(r, \mathfrak p)$ (some details omitted). this follows from lemma \ref{lemma-etale}. \end{proof} \begin{lemma} \label{lemma-henselian-functorial-improve} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$. let $r \to r^h$ and $s \to s^h$ be the henselizations of $r_\mathfrak p$ and $s_\mathfrak q$. the local ring map $r^h \to s^h$ of lemma \ref{lemma-henselian-functorial} identifies $s^h$ with the henselization of $r^h \otimes_r s$ at the unique prime lying over $\mathfrak m^h$ and $\mathfrak q$. \end{lemma} \begin{proof} by lemma \ref{lemma-henselization-different} we see that $r^h$, resp.\ $s^h$ are filtered colimits of \'etale $r$, resp.\ $s$-algebras. hence we see that $r^h \otimes_r s$ is a filtered colimit of \'etale $s$-algebras $a_i$ (lemma \ref{lemma-etale}). by lemma \ref{lemma-colimits-of-etale} we see that $s^h$ is a filtered colimit of \'etale $r^h \otimes_r s$-algebras. since moreover $s^h$ is a henselian local ring with residue field equal to $\kappa(\mathfrak q)$, the statement follows from the uniqueness result of lemma \ref{lemma-uniqueness-henselian}. \end{proof} \begin{lemma} \label{lemma-strictly-henselian-functorial-prepare} let $\varphi : r \to s$ be a local map of local rings. let $s/\mathfrak m_s \subset \kappa^{sep}$ be a separable algebraic closure. let $s \to s^{sh}$ be the strict henselization of $s$ with respect to $s/\mathfrak m_s \subset \kappa^{sep}$. let $r \to a$ be an \'etale ring map and let $\mathfrak q$ be a prime of $a$ lying over $\mathfrak m_r$. given any commutative diagram $$ \xymatrix{ \kappa(\mathfrak q) \ar[r]_{\phi} & \kappa^{sep} \\ r/\mathfrak m_r \ar[r]^{\varphi} \ar[u] & s/\mathfrak m_s \ar[u] } $$ there exists a unique morphism of rings $f : a \to s^{sh}$ fitting into the commutative diagram $$ \xymatrix{ a \ar[r]_f & s^{sh} \\ r \ar[u] \ar[r]^{\varphi} & s \ar[u] } $$ such that $f^{-1}(\mathfrak m_{s^h}) = \mathfrak q$ and the induced map $\kappa(\mathfrak q) \to \kappa^{sep}$ is the given one. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-map-into-henselian}. \end{proof} \begin{lemma} \label{lemma-strictly-henselian-functorial} let $r \to s$ be a local map of local rings. choose separable algebraic closures $r/\mathfrak m_r \subset \kappa_1^{sep}$ and $s/\mathfrak m_s \subset \kappa_2^{sep}$. let $r \to r^{sh}$ and $s \to s^{sh}$ be the corresponding strict henselizations. given any commutative diagram $$ \xymatrix{ \kappa_1^{sep} \ar[r]_{\phi} & \kappa_2^{sep} \\ r/\mathfrak m_r \ar[r]^{\varphi} \ar[u] & s/\mathfrak m_s \ar[u] } $$ there exists a unique local ring map $r^{sh} \to s^{sh}$ fitting into the commutative diagram $$ \xymatrix{ r^{sh} \ar[r]_f & s^{sh} \\ r \ar[u] \ar[r] & s \ar[u] } $$ and inducing $\phi$ on the residue fields of $r^{sh}$ and $s^{sh}$. \end{lemma} \begin{proof} follows immediately from lemma \ref{lemma-map-into-henselian-colimit}. \end{proof} \begin{lemma} \label{lemma-strict-henselization-different} let $r$ be a ring. let $\mathfrak p \subset r$ be a prime ideal. let $\kappa(\mathfrak p) \subset \kappa^{sep}$ be a separable algebraic closure. consider the category of triples $(s, \mathfrak q, \phi)$ where $r \to s$ is \'etale, $\mathfrak q$ is a prime lying over $\mathfrak p$, and $\phi : \kappa(\mathfrak q) \to \kappa^{sep}$ is a $\kappa(\mathfrak p)$-algebra map. this category is filtered and $$ (r_{\mathfrak p})^{sh} = \colim_{(s, \mathfrak q, \phi)} s = \colim_{(s, \mathfrak q, \phi)} s_{\mathfrak q} $$ canonically. \end{lemma} \begin{proof} a morphism of triples $(s, \mathfrak q, \phi) \to (s', \mathfrak q', \phi')$ is given by an $r$-algebra map $\varphi : s \to s'$ such that $\varphi^{-1}(\mathfrak q') = \mathfrak q$ and such that $\phi' \circ \varphi = \phi$. let us show that the category of pairs is filtered, see categories, definition \ref{categories-definition-directed}. the category contains the triple $(r, \mathfrak p, \kappa(\mathfrak p) \subset \kappa^{sep})$ and hence is not empty, which proves part (1) of categories, definition \ref{categories-definition-directed}. suppose that $(s, \mathfrak q, \phi)$ and $(s', \mathfrak q', \phi')$ are two triples. note that $\mathfrak q$, resp.\ $\mathfrak q'$ correspond to primes of the fibre rings $s \otimes \kappa(\mathfrak p)$, resp.\ $s' \otimes \kappa(\mathfrak p)$ with residue fields finite separable over $\kappa(\mathfrak p)$ and $\phi$, resp.\ $\phi'$ correspond to maps into $\kappa^{sep}$. hence this data corresponds to $\kappa(\mathfrak p)$-algebra maps $$ \phi : s \otimes_r \kappa(\mathfrak p) \longrightarrow \kappa^{sep}, \quad \phi' : s' \otimes_r \kappa(\mathfrak p) \longrightarrow \kappa^{sep}. $$ set $s'' = s \otimes_r s'$. combining the maps the above we get a unique $\kappa(\mathfrak p)$-algebra map $$ \phi'' = \phi \otimes \phi' : s'' \otimes_r \kappa(\mathfrak p) \longrightarrow \kappa^{sep} $$ whose kernel corresponds to a prime $\mathfrak q'' \subset s''$ lying over $\mathfrak q$ and over $\mathfrak q'$, and whose residue field maps via $\phi''$ to the compositum of $\phi(\kappa(\mathfrak q))$ and $\phi'(\kappa(\mathfrak q'))$ in $\kappa^{sep}$. the ring map $r \to s''$ is \'etale by lemma \ref{lemma-etale}. hence $(s'', \mathfrak q'', \phi'')$ is a triple dominating both $(s, \mathfrak q, \phi)$ and $(s', \mathfrak q', \phi')$. this proves part (2) of categories, definition \ref{categories-definition-directed}. next, suppose that $\varphi, \psi : (s, \mathfrak q, \phi) \to (s', \mathfrak q', \phi')$ are two morphisms of pairs. then $\varphi$, $\psi$, and $s' \otimes_r s' \to s'$ are \'etale ring maps by lemma \ref{lemma-map-between-etale}. consider $$ s'' = (s' \otimes_{\varphi, s, \psi} s') \otimes_{s' \otimes_r s'} s' $$ arguing as above (base change of \'etale maps is \'etale, composition of \'etale maps is \'etale) we see that $s''$ is \'etale over $r$. the fibre ring of $s''$ over $\mathfrak p$ is $$ f'' = (f' \otimes_{\varphi, f, \psi} f') \otimes_{f' \otimes_{\kappa(\mathfrak p)} f'} f' $$ where $f', f$ are the fibre rings of $s'$ and $s$. since $\varphi$ and $\psi$ are morphisms of triples the map $\phi' : f' \to \kappa^{sep}$ extends to a map $\phi'' : f'' \to \kappa^{sep}$ which in turn corresponds to a prime ideal $\mathfrak q'' \subset s''$. the canonical map $s' \to s''$ (using the right most factor for example) is a morphism of triples $(s', \mathfrak q', \phi') \to (s'', \mathfrak q'', \phi'')$ which equalizes $\varphi$ and $\psi$. this proves part (3) of categories, definition \ref{categories-definition-directed}. hence we conclude that the category is filtered. \medskip\noindent we still have to show that the colimit $r_{colim}$ of the system is equal to the strict henselization of $r_{\mathfrak p}$ with respect to $\kappa^{sep}$. to see this note that the system of triples $(s, \mathfrak q, \phi)$ contains as a subsystem the pairs $(s, \mathfrak q)$ of lemma \ref{lemma-henselization-different}. hence $r_{colim}$ contains $r_{\mathfrak p}^h$ by the result of that lemma. moreover, it is clear that $r_{\mathfrak p}^h \subset r_{colim}$ is a directed colimit of \'etale ring extensions. it follows that $r_{colim}$ is henselian by lemmas \ref{lemma-finite-over-henselian} and \ref{lemma-colimit-henselian}. finally, by lemma \ref{lemma-make-etale-map-prescribed-residue-field} we see that the residue field of $r_{colim}$ is equal to $\kappa^{sep}$. hence we conclude that $r_{colim}$ is strictly henselian and hence equals the strict henselization of $r_{\mathfrak p}$ as desired. some details omitted. \end{proof} \begin{lemma} \label{lemma-strictly-henselian-functorial-improve} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$. choose separable algebraic closures $\kappa(\mathfrak p) \subset \kappa_1^{sep}$ and $\kappa(\mathfrak q) \subset \kappa_2^{sep}$. let $r^{sh}$ and $s^{sh}$ be the corresponding strict henselizations of $r_\mathfrak p$ and $s_\mathfrak q$. given any commutative diagram $$ \xymatrix{ \kappa_1^{sep} \ar[r]_{\phi} & \kappa_2^{sep} \\ \kappa(\mathfrak p) \ar[r]^{\varphi} \ar[u] & \kappa(\mathfrak q) \ar[u] } $$ the local ring map $r^{sh} \to s^{sh}$ of lemma \ref{lemma-strictly-henselian-functorial} identifies $s^{sh}$ with the strict henselization of $r^{sh} \otimes_r s$ at a prime lying over $\mathfrak q$ and the maximal ideal $\mathfrak m^{sh} \subset r^{sh}$. \end{lemma} \begin{proof} the proof is identical to the proof of lemma \ref{lemma-henselian-functorial-improve} except that it uses lemma \ref{lemma-strict-henselization-different} instead of lemma \ref{lemma-henselization-different}. \end{proof} \begin{lemma} \label{lemma-sh-from-h-map} let $r \to s$ be a ring map. let $\mathfrak q \subset s$ be a prime lying over $\mathfrak p \subset r$ such that $\kappa(\mathfrak p) \to \kappa(\mathfrak q)$ is an isomorphism. choose a separable algebraic closure $\kappa^{sep}$ of $\kappa(\mathfrak p) = \kappa(\mathfrak q)$. then $$ (s_\mathfrak q)^{sh} = (s_\mathfrak q)^h \otimes_{(r_\mathfrak p)^h} (r_\mathfrak p)^{sh} $$ \end{lemma} \begin{proof} this follows from the alternative construction of the strict henselization of a local ring in remark \ref{remark-construct-sh-from-h} and the fact that the residue fields are equal. some details omitted. \end{proof} \section{henselization and quasi-finite ring maps} \label{section-henselization-quasi-finite} \noindent in this section we prove some results concerning the functorial maps between (strict) henselizations for quasi-finite ring maps. \begin{lemma} \label{lemma-quasi-finite-henselization} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime of $s$ lying over $\mathfrak p$ in $r$. assume $r \to s$ is quasi-finite at $\mathfrak q$. the commutative diagram $$ \xymatrix{ r_{\mathfrak p}^h \ar[r] & s_{\mathfrak q}^h \\ r_{\mathfrak p} \ar[u] \ar[r] & s_{\mathfrak q} \ar[u] } $$ of lemma \ref{lemma-henselian-functorial} identifies $s_{\mathfrak q}^h$ with the localization of $r_{\mathfrak p}^h \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$ at the prime generated by $\mathfrak q$. moreover, the ring map $r_{\mathfrak p}^h \to s_{\mathfrak q}^h$ is finite. \end{lemma} \begin{proof} note that $r_{\mathfrak p}^h \otimes_r s$ is quasi-finite over $r_{\mathfrak p}^h$ at the prime ideal corresponding to $\mathfrak q$, see lemma \ref{lemma-four-rings}. hence the localization $s'$ of $r_{\mathfrak p}^h \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$ is henselian and finite over $r_{\mathfrak p}^h$, see lemma \ref{lemma-finite-over-henselian}. as a localization $s'$ is a filtered colimit of \'etale $r_{\mathfrak p}^h \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$-algebras. by lemma \ref{lemma-henselian-functorial-improve} we see that $s_\mathfrak q^h$ is the henselization of $r_{\mathfrak p}^h \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$. thus $s' = s_\mathfrak q^h$ by the uniqueness result of lemma \ref{lemma-uniqueness-henselian}. \end{proof} \begin{lemma} \label{lemma-quotient-henselization} \begin{slogan} henselization is compatible with quotients. \end{slogan} let $r$ be a local ring with henselization $r^h$. let $i \subset \mathfrak m_r$. then $r^h/ir^h$ is the henselization of $r/i$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-quasi-finite-henselization}. \end{proof} \begin{lemma} \label{lemma-quasi-finite-strict-henselization} let $r \to s$ be a ring map. let $\mathfrak q$ be a prime of $s$ lying over $\mathfrak p$ in $r$. assume $r \to s$ is quasi-finite at $\mathfrak q$. let $\kappa_2^{sep}/\kappa(\mathfrak q)$ be a separable algebraic closure and denote $\kappa_1^{sep} \subset \kappa_2^{sep}$ the subfield of elements separable algebraic over $\kappa(\mathfrak p)$ (fields, lemma \ref{fields-lemma-separable-first}). the commutative diagram $$ \xymatrix{ r_{\mathfrak p}^{sh} \ar[r] & s_{\mathfrak q}^{sh} \\ r_{\mathfrak p} \ar[u] \ar[r] & s_{\mathfrak q} \ar[u] } $$ of lemma \ref{lemma-strictly-henselian-functorial} identifies $s_{\mathfrak q}^{sh}$ with the localization of $r_{\mathfrak p}^{sh} \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$ at the prime ideal which is the kernel of the map $$ r_{\mathfrak p}^{sh} \otimes_{r_{\mathfrak p}} s_{\mathfrak q} \longrightarrow \kappa_1^{sep} \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak q) \longrightarrow \kappa_2^{sep} $$ moreover, the ring map $r_{\mathfrak p}^{sh} \to s_{\mathfrak q}^{sh}$ is a finite local homomorphism of local rings whose residue field extension is the extension $\kappa_2^{sep}/\kappa_1^{sep}$ which is both finite and purely inseparable. \end{lemma} \begin{proof} since $r \to s$ is quasi-finite at $\mathfrak q$ we see that the extension $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is finite, see definition \ref{definition-quasi-finite} and lemma \ref{lemma-isolated-point-fibre}. hence $\kappa_1^{sep}$ is a separable algebraic closure of $\kappa(\mathfrak p)$ (small detail omitted). in particular lemma \ref{lemma-strictly-henselian-functorial} does really apply. next, the compositum of $\kappa(\mathfrak q)$ and $\kappa_1^{sep}$ in $\kappa_2^{sep}$ is separably algebraically closed and hence equal to $\kappa_2^{sep}$. we conclude that $\kappa_2^{sep}/\kappa_1^{sep}$ is finite. by construction the extension $\kappa_2^{sep}/\kappa_1^{sep}$ is purely inseparable. the ring map $r_{\mathfrak p}^{sh} \to s_{\mathfrak q}^{sh}$ is indeed local and induces the residue field extension $\kappa_2^{sep}/\kappa_1^{sep}$ which is indeed finite purely inseparable. \medskip\noindent note that $r_{\mathfrak p}^{sh} \otimes_r s$ is quasi-finite over $r_{\mathfrak p}^{sh}$ at the prime ideal $\mathfrak q'$ given in the statement of the lemma, see lemma \ref{lemma-four-rings}. hence the localization $s'$ of $r_{\mathfrak p}^{sh} \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$ at $\mathfrak q'$ is henselian and finite over $r_{\mathfrak p}^{sh}$, see lemma \ref{lemma-finite-over-henselian}. note that the residue field of $s'$ is $\kappa_2^{sep}$ as the map $\kappa_1^{sep} \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak q) \to \kappa_2^{sep}$ is surjective by the discussion in the previous paragraph. furthermore, as a localization $s'$ is a filtered colimit of \'etale $r_{\mathfrak p}^{sh} \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$-algebras. by lemma \ref{lemma-strictly-henselian-functorial-improve} we see that $s_{\mathfrak q}^{sh}$ is the strict henselization of $r_{\mathfrak p}^{sh} \otimes_{r_{\mathfrak p}} s_{\mathfrak q}$ at $\mathfrak q'$. thus $s' = s_\mathfrak q^{sh}$ by the uniqueness result of lemma \ref{lemma-uniqueness-henselian}. \end{proof} \begin{lemma} \label{lemma-quotient-strict-henselization} let $r$ be a local ring with strict henselization $r^{sh}$. let $i \subset \mathfrak m_r$. then $r^{sh}/ir^{sh}$ is a strict henselization of $r/i$. \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-quasi-finite-strict-henselization}. \end{proof} \begin{lemma} \label{lemma-local-tensor-with-integral} let $a \to b$ and $a \to c$ be local homomorphisms of local rings. if $a \to c$ is integral and either $\kappa(\mathfrak m_c)/\kappa(\mathfrak m_a)$ or $\kappa(\mathfrak m_b)/\kappa(\mathfrak m_a)$ is purely inseparable, then $d = b \otimes_a c$ is a local ring and $b \to d$ and $c \to d$ are local. \end{lemma} \begin{proof} any maximal ideal of $d$ lies over the maximal ideal of $b$ by going up for the integral ring map $b \to d$ (lemma \ref{lemma-integral-going-up}). now $d/\mathfrak m_b d = \kappa(\mathfrak m_b) \otimes_a c = \kappa(\mathfrak m_b) \otimes_{\kappa(\mathfrak m_a)} c/\mathfrak m_a c$. the spectrum of $c/\mathfrak m_a c$ consists of a single point, namely $\mathfrak m_c$. thus the spectrum of $d/\mathfrak m_b d$ is the same as the spectrum of $\kappa(\mathfrak m_b) \otimes_{\kappa(\mathfrak m_a)} \kappa(\mathfrak m_c)$ which is a single point by our assumption that either $\kappa(\mathfrak m_c)/\kappa(\mathfrak m_a)$ or $\kappa(\mathfrak m_b)/\kappa(\mathfrak m_a)$ is purely inseparable. this proves that $d$ is local and that the ring maps $b \to d$ and $c \to d$ are local. \end{proof} \begin{lemma} \label{lemma-base-change-strict-henselization-quasi-finite} let $a \to b$ and $a \to c$ be ring maps. let $\kappa$ be a separably algebraically closed field and let $b \otimes_a c \to \kappa$ be a ring homomorphism. denote $$ \xymatrix{ b^{sh} \ar[r] & (b \otimes_a c)^{sh} \\ a^{sh} \ar[u] \ar[r] & c^{sh} \ar[u] } $$ the corresponding maps of strict henselizations (see proof). if \begin{enumerate} \item $a \to b$ is quasi-finite at the prime $\mathfrak p_b = \ker(b \to \kappa)$, or \item $b$ is a filtered colimit of quasi-finite $a$-algebras, or \item $b_{\mathfrak p_b}$ is a filtered colimit of quasi-finite algebras over $a_{\mathfrak p_a}$, or \item $b$ is integral over $a$, \end{enumerate} then $b^{sh} \otimes_{a^{sh}} c^{sh} \to (b \otimes_a c)^{sh}$ is an isomorphism. \end{lemma} \begin{proof} write $d = b \otimes_a c$. denote $\mathfrak p_a = \ker(a \to \kappa)$ and similarly for $\mathfrak p_b$, $\mathfrak p_c$, and $\mathfrak p_d$. denote $\kappa_a \subset \kappa$ the separable algebraic closure of $\kappa(\mathfrak p_a)$ in $\kappa$ and similarly for $\kappa_b$, $\kappa_c$, and $\kappa_d$. denote $a^{sh}$ the strict henselization of $a_{\mathfrak p_a}$ constructed using the separable algebraic closure $\kappa_a/\kappa(\mathfrak p_a)$. similarly for $b^{sh}$, $c^{sh}$, and $d^{sh}$. we obtain the commutative diagram of the lemma from the functoriality of lemma \ref{lemma-strictly-henselian-functorial}. \medskip\noindent consider the map $$ c : b^{sh} \otimes_{a^{sh}} c^{sh} \to d^{sh} = (b \otimes_a c)^{sh} $$ we obtain from the commutative diagram. if $a \to b$ is quasi-finite at $\mathfrak p_b = \ker(b \to \kappa)$, then the ring map $c \to d$ is quasi-finite at $\mathfrak p_d$ by lemma \ref{lemma-four-rings}. hence by lemma \ref{lemma-quasi-finite-strict-henselization} (and lemma \ref{lemma-base-change-integral}) the ring map $c$ is a homomorphism of finite $c^{sh}$-algebras and $$ b^{sh} = (b \otimes_a a^{sh})_{\mathfrak q} \quad\text{and}\quad d^{sh} = (d \otimes_c c^{sh})_{\mathfrak r} = (b \otimes_a c^{sh})_{\mathfrak r} $$ for some primes $\mathfrak q$ and $\mathfrak r$. since $$ b^{sh} \otimes_{a^{sh}} c^{sh} = (b \otimes_a a^{sh})_{\mathfrak q} \otimes_{a^{sh}} c^{sh} = \text{a localization of } b \otimes_a c^{sh} $$ we conclude that source and target of $c$ are both localizations of $b \otimes_a c^{sh}$ (compatibly with the map). hence it suffices to show that $b^{sh} \otimes_{a^{sh}} c^{sh}$ is local (small detail omitted). this follows from lemma \ref{lemma-local-tensor-with-integral} and the fact that $a^{sh} \to b^{sh}$ is finite with purely inseparable residue field extension by the already used lemma \ref{lemma-quasi-finite-strict-henselization}. this proves case (1) of the lemma. \medskip\noindent in case (2) write $b = \colim b_i$ as a filtered colimit of quasi-finite $a$-algebras. we correspondingly get $d = \colim d_i$ with $d_i = b_i \otimes_a c$. observe that $b^{sh} = \colim b_i^{sh}$. namely, the ring $\colim b_i^{sh}$ is a strictly henselian local ring by lemma \ref{lemma-colimit-henselian}. also $\colim b_i^{sh}$ is a filtered colimit of \'etale $b$-algebras by lemma \ref{lemma-colimit-colimit-etale-better}. finally, the residue field of $\colim b_i^{sh}$ is a separable algebraic closure of $\kappa(\mathfrak p_b)$ (details omitted). hence we conclude that $b^{sh} = \colim b_i^{sh}$, see discussion following definition \ref{definition-henselization}. similarly, we have $d^{sh} = \colim d_i^{sh}$. then we conclude by case (1) because $$ d^{sh} = \colim d_i^{sh} = \colim b_i^{sh} \otimes_{a^{sh}} c^{sh} = b^{sh} \otimes_{a^{sh}} c^{sh} $$ since filtered colimit commute with tensor products. \medskip\noindent case (3). we may replace $a$, $b$, $c$ by their localizations at $\mathfrak p_a$, $\mathfrak p_b$, and $\mathfrak p_c$. thus (3) follows from (2). \medskip\noindent since an integral ring map is a filtered colimit of finite ring maps, we see that (4) follows from (2) as well. \end{proof} \section{serre's criterion for normality} \label{section-serre-criterion} \noindent we introduce the following properties of noetherian rings. \begin{definition} \label{definition-conditions} let $r$ be a noetherian ring. let $k \geq 0$ be an integer. \begin{enumerate} \item we say $r$ has property {\it $(r_k)$} if for every prime $\mathfrak p$ of height $\leq k$ the local ring $r_{\mathfrak p}$ is regular. we also say that $r$ is {\it regular in codimension $\leq k$}. \item we say $r$ has property {\it $(s_k)$} if for every prime $\mathfrak p$ the local ring $r_{\mathfrak p}$ has depth at least $\min\{k, \dim(r_{\mathfrak p})\}$. \item let $m$ be a finite $r$-module. we say $m$ has property $(s_k)$ if for every prime $\mathfrak p$ the module $m_{\mathfrak p}$ has depth at least $\min\{k, \dim(\text{supp}(m_{\mathfrak p}))\}$. \end{enumerate} \end{definition} \noindent any noetherian ring has property $(s_0)$ and so does any finite module over it. our convention that the depth of the zero module is $\infty$ (see section \ref{section-depth}) and the dimension of the empty set is $-\infty$ (see topology, section \ref{topology-section-krull-dimension}) guarantees that the zero module has property $(s_k)$ for all $k$. \begin{lemma} \label{lemma-criterion-no-embedded-primes} let $r$ be a noetherian ring. let $m$ be a finite $r$-module. the following are equivalent: \begin{enumerate} \item $m$ has no embedded associated prime, and \item $m$ has property $(s_1)$. \end{enumerate} \end{lemma} \begin{proof} let $\mathfrak p$ be an embedded associated prime of $m$. then there exists another associated prime $\mathfrak q$ of $m$ such that $\mathfrak p \supset \mathfrak q$. in particular this implies that $\dim(\text{supp}(m_{\mathfrak p})) \geq 1$ (since $\mathfrak q$ is in the support as well). on the other hand $\mathfrak pr_{\mathfrak p}$ is associated to $m_{\mathfrak p}$ (lemma \ref{lemma-associated-primes-localize}) and hence $\text{depth}(m_{\mathfrak p}) = 0$ (see lemma \ref{lemma-ideal-nonzerodivisor}). in other words $(s_1)$ does not hold. conversely, if $(s_1)$ does not hold then there exists a prime $\mathfrak p$ such that $\dim(\text{supp}(m_{\mathfrak p})) \geq 1$ and $\text{depth}(m_{\mathfrak p}) = 0$. since $\text{depth}(m_{\mathfrak p}) = 0$, we see that $\mathfrak p \in \text{ass}(m)$ by the two lemmas \ref{lemma-associated-primes-localize} and \ref{lemma-ideal-nonzerodivisor}. since $\dim(\text{supp}(m_{\mathfrak p})) \geq 1$, there is a prime $\mathfrak q \in \text{supp}(m)$ with $\mathfrak q \subset \mathfrak p$, $\mathfrak q \not = \mathfrak p$. we can take such a $\mathfrak q$ that is minimal in $\text{supp}(m)$. then by proposition \ref{proposition-minimal-primes-associated-primes} we have $\mathfrak q \in \text{ass}(m)$ and hence $\mathfrak p$ is an embedded associated prime. \end{proof} \begin{lemma} \label{lemma-criterion-reduced} \begin{slogan} reduced equals r0 plus s1. \end{slogan} let $r$ be a noetherian ring. the following are equivalent: \begin{enumerate} \item $r$ is reduced, and \item $r$ has properties $(r_0)$ and $(s_1)$. \end{enumerate} \end{lemma} \begin{proof} suppose that $r$ is reduced. then $r_{\mathfrak p}$ is a field for every minimal prime $\mathfrak p$ of $r$, according to lemma \ref{lemma-minimal-prime-reduced-ring}. hence we have $(r_0)$. let $\mathfrak p$ be a prime of height $\geq 1$. then $a = r_{\mathfrak p}$ is a reduced local ring of dimension $\geq 1$. hence its maximal ideal $\mathfrak m$ is not an associated prime since this would mean there exists an $x \in \mathfrak m$ with annihilator $\mathfrak m$ so $x^2 = 0$. hence the depth of $a = r_{\mathfrak p}$ is at least one, by lemma \ref{lemma-ass-zero-divisors}. this shows that $(s_1)$ holds. \medskip\noindent conversely, assume that $r$ satisfies $(r_0)$ and $(s_1)$. if $\mathfrak p$ is a minimal prime of $r$, then $r_{\mathfrak p}$ is a field by $(r_0)$, and hence is reduced. if $\mathfrak p$ is not minimal, then we see that $r_{\mathfrak p}$ has depth $\geq 1$ by $(s_1)$ and we conclude there exists an element $t \in \mathfrak pr_{\mathfrak p}$ such that $r_{\mathfrak p} \to r_{\mathfrak p}[1/t]$ is injective. now $r_\mathfrak p[1/t]$ is contained in the product of its localizations at prime ideals, see lemma \ref{lemma-characterize-zero-local}. this implies that $r_{\mathfrak p}$ is a subring of a product of localizations of $r$ at $\mathfrak p \supset \mathfrak q$ with $t \not \in \mathfrak q$. since these primes have smaller height by induction on the height we conclude that $r$ is reduced. \end{proof} \begin{lemma}[serre's criterion for normality] \label{lemma-criterion-normal} \begin{reference} \cite[iv, theorem 5.8.6]{ega} \end{reference} \begin{slogan} normal equals r1 plus s2. \end{slogan} let $r$ be a noetherian ring. the following are equivalent: \begin{enumerate} \item $r$ is a normal ring, and \item $r$ has properties $(r_1)$ and $(s_2)$. \end{enumerate} \end{lemma} \begin{proof} proof of (1) $\rightarrow$ (2). assume $r$ is normal, i.e., all localizations $r_{\mathfrak p}$ at primes are normal domains. in particular we see that $r$ has $(r_0)$ and $(s_1)$ by lemma \ref{lemma-criterion-reduced}. hence it suffices to show that a local noetherian normal domain $r$ of dimension $d$ has depth $\geq \min(2, d)$ and is regular if $d = 1$. the assertion if $d = 1$ follows from lemma \ref{lemma-characterize-dvr}. \medskip\noindent let $r$ be a local noetherian normal domain with maximal ideal $\mathfrak m$ and dimension $d \geq 2$. apply lemma \ref{lemma-hart-serre-loc-thm} to $r$. it is clear that $r$ does not fall into cases (1) or (2) of the lemma. let $r \to r'$ as in (4) of the lemma. since $r$ is a domain we have $r \subset r'$. since $\mathfrak m$ is not an associated prime of $r'$ there exists an $x \in \mathfrak m$ which is a nonzerodivisor on $r'$. then $r_x = r'_x$ so $r$ and $r'$ are domains with the same fraction field. but finiteness of $r \subset r'$ implies every element of $r'$ is integral over $r$ (lemma \ref{lemma-finite-is-integral}) and we conclude that $r = r'$ as $r$ is normal. this means (4) does not happen. thus we get the remaining possibility (3), i.e., $\text{depth}(r) \geq 2$ as desired. \medskip\noindent proof of (2) $\rightarrow$ (1). assume $r$ satisfies $(r_1)$ and $(s_2)$. by lemma \ref{lemma-criterion-reduced} we conclude that $r$ is reduced. hence it suffices to show that if $r$ is a reduced local noetherian ring of dimension $d$ satisfying $(s_2)$ and $(r_1)$ then $r$ is a normal domain. if $d = 0$, the result is clear. if $d = 1$, then the result follows from lemma \ref{lemma-characterize-dvr}. \medskip\noindent let $r$ be a reduced local noetherian ring with maximal ideal $\mathfrak m$ and dimension $d \geq 2$ which satisfies $(r_1)$ and $(s_2)$. by lemma \ref{lemma-characterize-reduced-ring-normal} it suffices to show that $r$ is integrally closed in its total ring of fractions $q(r)$. pick $x \in q(r)$ which is integral over $r$. then $r' = r[x]$ is a finite ring extension of $r$ (lemma \ref{lemma-characterize-finite-in-terms-of-integral}). because $\dim(r_\mathfrak p) < d$ for every nonmaximal prime $\mathfrak p \subset r$ we have $r_\mathfrak p = r'_\mathfrak p$ by induction. hence the support of $r'/r$ is $\{\mathfrak m\}$. it follows that $r'/r$ is annihilated by a power of $\mathfrak m$ (lemma \ref{lemma-noetherian-power-ideal-kills-module}). by lemma \ref{lemma-hart-serre-loc-thm} this contradicts the assumption that the depth of $r$ is $\geq 2 = \min(2, d)$ and the proof is complete. \end{proof} \begin{lemma} \label{lemma-regular-normal} a regular ring is normal. \end{lemma} \begin{proof} let $r$ be a regular ring. by lemma \ref{lemma-criterion-normal} it suffices to prove that $r$ is $(r_1)$ and $(s_2)$. as a regular local ring is cohen-macaulay, see lemma \ref{lemma-regular-ring-cm}, it is clear that $r$ is $(s_2)$. property $(r_1)$ is immediate. \end{proof} \begin{lemma} \label{lemma-normal-domain-intersection-localizations-height-1} let $r$ be a noetherian normal domain with fraction field $k$. then \begin{enumerate} \item for any nonzero $a \in r$ the quotient $r/ar$ has no embedded primes, and all its associated primes have height $1$ \item $$ r = \bigcap\nolimits_{\text{height}(\mathfrak p) = 1} r_{\mathfrak p} $$ \item for any nonzero $x \in k$ the quotient $r/(r \cap xr)$ has no embedded primes, and all its associates primes have height $1$. \end{enumerate} \end{lemma} \begin{proof} by lemma \ref{lemma-criterion-normal} we see that $r$ has $(s_2)$. hence for any nonzero element $a \in r$ we see that $r/ar$ has $(s_1)$ (use lemma \ref{lemma-depth-in-ses} for example) hence $r/ar$ has no embedded primes (lemma \ref{lemma-criterion-no-embedded-primes}). we conclude the associated primes of $r/ar$ are exactly the minimal primes $\mathfrak p$ over $(a)$, which have height $1$ as $a$ is not zero (lemma \ref{lemma-minimal-over-1}). this proves (1). \medskip\noindent thus, given $b \in r$ we have $b \in ar$ if and only if $b \in ar_{\mathfrak p}$ for every minimal prime $\mathfrak p$ over $(a)$ (see lemma \ref{lemma-zero-at-ass-zero}). these primes all have height $1$ as seen above so $b/a \in r$ if and only if $b/a \in r_{\mathfrak p}$ for all height 1 primes. hence (2) holds. \medskip\noindent for (3) write $x = a/b$. let $\mathfrak p_1, \ldots, \mathfrak p_r$ be the minimal primes over $(ab)$. these all have height 1 by the above. then we see that $r \cap xr = \bigcap_{i = 1, \ldots, r} (r \cap xr_{\mathfrak p_i})$ by part (2) of the lemma. hence $r/(r \cap xr)$ is a submodule of $\bigoplus r/(r \cap xr_{\mathfrak p_i})$. as $r_{\mathfrak p_i}$ is a discrete valuation ring (by property $(r_1)$ for the noetherian normal domain $r$, see lemma \ref{lemma-criterion-normal}) we have $xr_{\mathfrak p_i} = \mathfrak p_i^{e_i}r_{\mathfrak p_i}$ for some $e_i \in \mathbf{z}$. hence the direct sum is equal to $\bigoplus_{e_i > 0} r/\mathfrak p_i^{(e_i)}$, see definition \ref{definition-symbolic-power}. by lemma \ref{lemma-symbolic-power-associated} the only associated prime of the module $r/\mathfrak p^{(n)}$ is $\mathfrak p$. hence the set of associate primes of $r/(r \cap xr)$ is a subset of $\{\mathfrak p_i\}$ and there are no inclusion relations among them. this proves (3). \end{proof} \section{formal smoothness of fields} \label{section-p-bases} \noindent in this section we show that field extensions are formally smooth if and only if they are separable. however, we first prove finitely generated field extensions are separable algebraic if and only if they are formally unramified. \begin{lemma} \label{lemma-characterize-separable-algebraic-field-extensions} let $k/k$ be a finitely generated field extension. the following are equivalent \begin{enumerate} \item $k$ is a finite separable field extension of $k$, \item $\omega_{k/k} = 0$, \item $k$ is formally unramified over $k$, \item $k$ is unramified over $k$, \item $k$ is formally \'etale over $k$, \item $k$ is \'etale over $k$. \end{enumerate} \end{lemma} \begin{proof} the equivalence of (2) and (3) is lemma \ref{lemma-characterize-formally-unramified}. by lemma \ref{lemma-etale-over-field} we see that (1) is equivalent to (6). property (6) implies (5) and (4) which both in turn imply (3) (lemmas \ref{lemma-formally-etale-etale}, \ref{lemma-unramified}, and \ref{lemma-formally-unramified-unramified}). thus it suffices to show that (2) implies (1). choose a finitely generated $k$-subalgebra $a \subset k$ such that $k$ is the fraction field of the domain $a$. set $s = a \setminus \{0\}$. since $0 = \omega_{k/k} = s^{-1}\omega_{a/k}$ (lemma \ref{lemma-differentials-localize}) and since $\omega_{a/k}$ is finitely generated (lemma \ref{lemma-differentials-finitely-generated}), we can replace $a$ by a localization $a_f$ to reduce to the case that $\omega_{a/k} = 0$ (details omitted). then $a$ is unramified over $k$, hence $k/k$ is finite separable for example by lemma \ref{lemma-unramified-at-prime} applied with $\mathfrak q = (0)$. \end{proof} \begin{lemma} \label{lemma-derivative-zero-pth-power} let $k$ be a perfect field of characteristic $p > 0$. let $k/k$ be an extension. let $a \in k$. then $\text{d}a = 0$ in $\omega_{k/k}$ if and only if $a$ is a $p$th power. \end{lemma} \begin{proof} by lemma \ref{lemma-colimit-differentials} we see that there exists a subfield $k \subset l \subset k$ such that $l/k$ is a finitely generated field extension and such that $\text{d}a$ is zero in $\omega_{l/k}$. hence we may assume that $k$ is a finitely generated field extension of $k$. \medskip\noindent choose a transcendence basis $x_1, \ldots, x_r \in k$ such that $k$ is finite separable over $k(x_1, \ldots, x_r)$. this is possible by the definitions, see definitions \ref{definition-perfect} and \ref{definition-separable-field-extension}. we remark that the result holds for the purely transcendental subfield $k(x_1, \ldots, x_r) \subset k$. namely, $$ \omega_{k(x_1, \ldots, x_r)/k} = \bigoplus\nolimits_{i = 1}^r k(x_1, \ldots, x_r) \text{d}x_i $$ and any rational function all of whose partial derivatives are zero is a $p$th power. moreover, we also have $$ \omega_{k/k} = \bigoplus\nolimits_{i = 1}^r k\text{d}x_i $$ since $k(x_1, \ldots, x_r) \subset k$ is finite separable (computation omitted). suppose $a \in k$ is an element such that $\text{d}a = 0$ in the module of differentials. by our choice of $x_i$ we see that the minimal polynomial $p(t) \in k(x_1, \ldots, x_r)[t]$ of $a$ is separable. write $$ p(t) = t^d + \sum\nolimits_{i = 1}^d a_i t^{d - i} $$ and hence $$ 0 = \text{d}p(a) = \sum\nolimits_{i = 1}^d a^{d - i}\text{d}a_i $$ in $\omega_{k/k}$. by the description of $\omega_{k/k}$ above and the fact that $p$ was the minimal polynomial of $a$, we see that this implies $\text{d}a_i = 0$. hence $a_i = b_i^p$ for each $i$. therefore by fields, lemma \ref{fields-lemma-pth-root} we see that $a$ is a $p$th power. \end{proof} \begin{lemma} \label{lemma-size-extension-pth-roots} let $k$ be a field of characteristic $p > 0$. let $a_1, \ldots, a_n \in k$ be elements such that $\text{d}a_1, \ldots, \text{d}a_n$ are linearly independent in $\omega_{k/\mathbf{f}_p}$. then the field extension $k(a_1^{1/p}, \ldots, a_n^{1/p})$ has degree $p^n$ over $k$. \end{lemma} \begin{proof} by induction on $n$. if $n = 1$ the result is lemma \ref{lemma-derivative-zero-pth-power}. for the induction step, suppose that $k(a_1^{1/p}, \ldots, a_{n - 1}^{1/p})$ has degree $p^{n - 1}$ over $k$. we have to show that $a_n$ does not map to a $p$th power in $k(a_1^{1/p}, \ldots, a_{n - 1}^{1/p})$. if it does then we can write \begin{align*} a_n & = \left(\sum\nolimits_{i = (i_1, \ldots, i_{n - 1}),\ 0 \leq i_j \leq p - 1} \lambda_i a_1^{i_1/p} \ldots a_{n - 1}^{i_{n - 1}/p}\right)^p \\ & = \sum\nolimits_{i = (i_1, \ldots, i_{n - 1}),\ 0 \leq i_j \leq p - 1} \lambda_i^p a_1^{i_1} \ldots a_{n - 1}^{i_{n - 1}} \end{align*} applying $\text{d}$ we see that $\text{d}a_n$ is linearly dependent on $\text{d}a_i$, $i < n$. this is a contradiction. \end{proof} \begin{lemma} \label{lemma-separable-differentials} let $k$ be a field of characteristic $p > 0$. the following are equivalent: \begin{enumerate} \item the field extension $k/k$ is separable (see definition \ref{definition-separable-field-extension}), and \item the map $k \otimes_k \omega_{k/\mathbf{f}_p} \to \omega_{k/\mathbf{f}_p}$ is injective. \end{enumerate} \end{lemma} \begin{proof} write $k$ as a directed colimit $k = \colim_i k_i$ of finitely generated field extensions $k_i/k$. by definition $k$ is separable if and only if each $k_i$ is separable over $k$, and by lemma \ref{lemma-colimit-differentials} we see that $k \otimes_k \omega_{k/\mathbf{f}_p} \to \omega_{k/\mathbf{f}_p}$ is injective if and only if each $k_i \otimes_k \omega_{k/\mathbf{f}_p} \to \omega_{k_i/\mathbf{f}_p}$ is injective. hence we may assume that $k/k$ is a finitely generated field extension. \medskip\noindent assume $k/k$ is a finitely generated field extension which is separable. choose $x_1, \ldots, x_{r + 1} \in k$ as in lemma \ref{lemma-generating-finitely-generated-separable-field-extensions}. in this case there exists an irreducible polynomial $g(x_1, \ldots, x_{r + 1}) \in k[x_1, \ldots, x_{r + 1}]$ such that $g(x_1, \ldots, x_{r + 1}) = 0$ and such that $\partial g/\partial x_{r + 1}$ is not identically zero. moreover $k$ is the field of fractions of the domain. $s = k[x_1, \ldots, x_{r + 1}]/(g)$. write $$ g = \sum a_i x^i, \quad x^i = x_1^{i_1}\ldots x_{r + 1}^{i_{r + 1}}. $$ using the presentation of $s$ above we see that $$ \omega_{s/\mathbf{f}_p} = \frac{ s \otimes_k \omega_k \oplus \bigoplus\nolimits_{i = 1, \ldots, r + 1} s\text{d}x_i }{ \langle \sum x^i \text{d}a_i + \sum \partial g/\partial x_i \text{d}x_i \rangle } $$ since $\omega_{k/\mathbf{f}_p}$ is the localization of the $s$-module $\omega_{s/\mathbf{f}_p}$ (see lemma \ref{lemma-differentials-localize}) we conclude that $$ \omega_{k/\mathbf{f}_p} = \frac{ k \otimes_k \omega_k \oplus \bigoplus\nolimits_{i = 1, \ldots, r + 1} k\text{d}x_i }{ \langle \sum x^i \text{d}a_i + \sum \partial g/\partial x_i \text{d}x_i \rangle } $$ now, since the polynomial $\partial g/\partial x_{r + 1}$ is not identically zero we conclude that the map $k \otimes_k \omega_{k/\mathbf{f}_p} \to \omega_{s/\mathbf{f}_p}$ is injective as desired. \medskip\noindent assume $k/k$ is a finitely generated field extension and that $k \otimes_k \omega_{k/\mathbf{f}_p} \to \omega_{k/\mathbf{f}_p}$ is injective. (this part of the proof is the same as the argument proving lemma \ref{lemma-characterize-separable-field-extensions}.) let $x_1, \ldots, x_r$ be a transcendence basis of $k$ over $k$ such that the degree of inseparability of the finite extension $k(x_1, \ldots, x_r) \subset k$ is minimal. if $k$ is separable over $k(x_1, \ldots, x_r)$ then we win. assume this is not the case to get a contradiction. then there exists an element $\alpha \in k$ which is not separable over $k(x_1, \ldots, x_r)$. let $p(t) \in k(x_1, \ldots, x_r)[t]$ be its minimal polynomial. because $\alpha$ is not separable actually $p$ is a polynomial in $t^p$. clear denominators to get an irreducible polynomial $$ g(x_1, \ldots, x_r, t) = \sum a_{i, i} x^i t^i \in k[x_1, \ldots, x_r, t] $$ such that $g(x_1, \ldots, x_r, \alpha) = 0$ in $k$. note that this means $k[x_1, \ldots, x_r, t]/(g) \subset k$. we may assume that for some pair $(i_0, i_0)$ the coefficient $a_{i_0, i_0} = 1$. we claim that $\text{d}g/\text{d}x_i$ is not identically zero for at least one $i$. namely, if this is not the case, then $g$ is actually a polynomial in $x_1^p, \ldots, x_r^p, t^p$. then this means that $$ \sum\nolimits_{(i, i) \not = (i_0, i_0)} x^i\alpha^i \text{d}a_{i, i} $$ is zero in $\omega_{k/\mathbf{f}_p}$. note that there is no $k$-linear relation among the elements $$ \{x^i\alpha^i \mid a_{i, i} \not = 0 \text{ and } (i, i) \not = (i_0, i_0)\} $$ of $k$. hence the assumption that $k \otimes_k \omega_{k/\mathbf{f}_p} \to \omega_{k/\mathbf{f}_p}$ is injective implies that $\text{d}a_{i, i} = 0$ in $\omega_{k/\mathbf{f}_p}$ for all $(i, i)$. by lemma \ref{lemma-derivative-zero-pth-power} we see that each $a_{i, i}$ is a $p$th power, which implies that $g$ is a $p$th power contradicting the irreducibility of $g$. thus, after renumbering, we may assume that $\text{d}g/\text{d}x_1$ is not zero. then we see that $x_1$ is separably algebraic over $k(x_2, \ldots, x_r, \alpha)$, and that $x_2, \ldots, x_r, \alpha$ is a transcendence basis of $k$ over $k$. this means that the degree of inseparability of the finite extension $k(x_2, \ldots, x_r, \alpha) \subset k$ is less than the degree of inseparability of the finite extension $k(x_1, \ldots, x_r) \subset k$, which is a contradiction. \end{proof} \begin{lemma} \label{lemma-formally-smooth-implies-separable} let $k/k$ be an extension of fields. if $k$ is formally smooth over $k$, then $k$ is a separable extension of $k$. \end{lemma} \begin{proof} assume $k$ is formally smooth over $k$. by lemma \ref{lemma-ses-formally-smooth} we see that $k \otimes_k \omega_{k/\mathbf{z}} \to \omega_{k/\mathbf{z}}$ is injective. hence $k$ is separable over $k$ by lemma \ref{lemma-separable-differentials}. \end{proof} \begin{lemma} \label{lemma-characterize-formally-smooth-field-extension} let $k/k$ be an extension of fields. then $k$ is formally smooth over $k$ if and only if $h_1(l_{k/k}) = 0$. \end{lemma} \begin{proof} this follows from proposition \ref{proposition-characterize-formally-smooth} and the fact that a vector spaces is free (hence projective). \end{proof} \begin{lemma} \label{lemma-formally-smooth-extensions-easy} let $k/k$ be an extension of fields. \begin{enumerate} \item if $k$ is purely transcendental over $k$, then $k$ is formally smooth over $k$. \item if $k$ is separable algebraic over $k$, then $k$ is formally smooth over $k$. \item if $k$ is separable over $k$, then $k$ is formally smooth over $k$. \end{enumerate} \end{lemma} \begin{proof} for (1) write $k = k(x_j; j \in j)$. suppose that $a$ is a $k$-algebra, and $i \subset a$ is an ideal of square zero. let $\varphi : k \to a/i$ be a $k$-algebra map. let $a_j \in a$ be an element such that $a_j \mod i = \varphi(x_j)$. then it is easy to see that there is a unique $k$-algebra map $k \to a$ which maps $x_j$ to $a_j$ and which reduces to $\varphi$ mod $i$. hence $k \subset k$ is formally smooth. \medskip\noindent in case (2) we see that $k \subset k$ is a colimit of \'etale ring extensions. an \'etale ring map is formally \'etale (lemma \ref{lemma-formally-etale-etale}). hence this case follows from lemma \ref{lemma-colimit-formally-etale} and the trivial observation that a formally \'etale ring map is formally smooth. \medskip\noindent in case (3), write $k = \colim k_i$ as the filtered colimit of its finitely generated sub $k$-extensions. by definition \ref{definition-separable-field-extension} each $k_i$ is separable algebraic over a purely transcendental extension of $k$. hence $k_i/k$ is formally smooth by cases (1) and (2) and lemma \ref{lemma-compose-formally-smooth}. thus $h_1(l_{k_i/k}) = 0$ by lemma \ref{lemma-characterize-formally-smooth-field-extension}. hence $h_1(l_{k/k}) = 0$ by lemma \ref{lemma-colimits-nl}. hence $k/k$ is formally smooth by lemma \ref{lemma-characterize-formally-smooth-field-extension} again. \end{proof} \begin{lemma} \label{lemma-fields-are-formally-smooth} \begin{slogan} formally smooth equals separable for field extensions. \end{slogan} let $k$ be a field. \begin{enumerate} \item if the characteristic of $k$ is zero, then any extension field of $k$ is formally smooth over $k$. \item if the characteristic of $k$ is $p > 0$, then $k/k$ is formally smooth if and only if it is a separable field extension. \end{enumerate} \end{lemma} \begin{proof} combine lemmas \ref{lemma-formally-smooth-implies-separable} and \ref{lemma-formally-smooth-extensions-easy}. \end{proof} \noindent here we put together all the different characterizations of separable field extensions. \begin{proposition} \label{proposition-characterize-separable-field-extensions} let $k/k$ be a field extension. if the characteristic of $k$ is zero then \begin{enumerate} \item $k$ is separable over $k$, \item $k$ is geometrically reduced over $k$, \item $k$ is formally smooth over $k$, \item $h_1(l_{k/k}) = 0$, and \item the map $k \otimes_k \omega_{k/\mathbf{z}} \to \omega_{k/\mathbf{z}}$ is injective. \end{enumerate} if the characteristic of $k$ is $p > 0$, then the following are equivalent: \begin{enumerate} \item $k$ is separable over $k$, \item the ring $k \otimes_k k^{1/p}$ is reduced, \item $k$ is geometrically reduced over $k$, \item the map $k \otimes_k \omega_{k/\mathbf{f}_p} \to \omega_{k/\mathbf{f}_p}$ is injective, \item $h_1(l_{k/k}) = 0$, and \item $k$ is formally smooth over $k$. \end{enumerate} \end{proposition} \begin{proof} this is a combination of lemmas \ref{lemma-characterize-separable-field-extensions}, \ref{lemma-fields-are-formally-smooth} \ref{lemma-formally-smooth-implies-separable}, and \ref{lemma-separable-differentials}. \end{proof} \noindent here is yet another characterization of finitely generated separable field extensions. \begin{lemma} \label{lemma-localization-smooth-separable} let $k/k$ be a finitely generated field extension. then $k$ is separable over $k$ if and only if $k$ is the localization of a smooth $k$-algebra. \end{lemma} \begin{proof} choose a finite type $k$-algebra $r$ which is a domain whose fraction field is $k$. lemma \ref{lemma-smooth-at-generic-point} says that $k \to r$ is smooth at $(0)$ if and only if $k/k$ is separable. this proves the lemma. \end{proof} \begin{lemma} \label{lemma-colimit-syntomic} let $k/k$ be a field extension. then $k$ is a filtered colimit of global complete intersection algebras over $k$. if $k/k$ is separable, then $k$ is a filtered colimit of smooth algebras over $k$. \end{lemma} \begin{proof} suppose that $e \subset k$ is a finite subset. it suffices to show that there exists a $k$ subalgebra $a \subset k$ which contains $e$ and which is a global complete intersection (resp.\ smooth) over $k$. the separable/smooth case follows from lemma \ref{lemma-localization-smooth-separable}. in general let $l \subset k$ be the subfield generated by $e$. pick a transcendence basis $x_1, \ldots, x_d \in l$ over $k$. the extension $l/k(x_1, \ldots, x_d)$ is finite. say $l = k(x_1, \ldots, x_d)[y_1, \ldots, y_r]$. pick inductively polynomials $p_i \in k(x_1, \ldots, x_d)[y_1, \ldots, y_r]$ such that $p_i = p_i(y_1, \ldots, y_i)$ is monic in $y_i$ over $k(x_1, \ldots, x_d)[y_1, \ldots, y_{i - 1}]$ and maps to the minimum polynomial of $y_i$ in $k(x_1, \ldots, x_d)[y_1, \ldots, y_{i - 1}][y_i]$. then it is clear that $p_1, \ldots, p_r$ is a regular sequence in $k(x_1, \ldots, x_r)[y_1, \ldots, y_r]$ and that $l = k(x_1, \ldots, x_r)[y_1, \ldots, y_r]/(p_1, \ldots, p_r)$. if $h \in k[x_1, \ldots, x_d]$ is a polynomial such that $p_i \in k[x_1, \ldots, x_d, 1/h, y_1, \ldots, y_r]$, then we see that $p_1, \ldots, p_r$ is a regular sequence in $k[x_1, \ldots, x_d, 1/h, y_1, \ldots, y_r]$ and $a = k[x_1, \ldots, x_d, 1/h, y_1, \ldots, y_r]/(p_1, \ldots, p_r)$ is a global complete intersection. after adjusting our choice of $h$ we may assume $e \subset a$ and we win. \end{proof} \section{constructing flat ring maps} \label{section-constructing-flat} \noindent the following lemma is occasionally useful. \begin{lemma} \label{lemma-flat-local-given-residue-field} let $(r, \mathfrak m, k)$ be a local ring. let $k/k$ be a field extension. there exists a local ring $(r', \mathfrak m', k')$, a flat local ring map $r \to r'$ such that $\mathfrak m' = \mathfrak mr'$ and such that $k'$ is isomorphic to $k$ as an extension of $k$. \end{lemma} \begin{proof} suppose that $k' = k(\alpha)$ is a monogenic extension of $k$. then $k'$ is the residue field of a flat local extension $r \subset r'$ as in the lemma. namely, if $\alpha$ is transcendental over $k$, then we let $r'$ be the localization of $r[x]$ at the prime $\mathfrak mr[x]$. if $\alpha$ is algebraic with minimal polynomial $t^d + \sum \overline{\lambda}_it^{d - i}$, then we let $r' = r[t]/(t^d + \sum \lambda_i t^{d - i})$. \medskip\noindent consider the collection of triples $(k', r \to r', \phi)$, where $k \subset k' \subset k$ is a subfield, $r \to r'$ is a local ring map as in the lemma, and $\phi : r' \to k'$ induces an isomorphism $r'/\mathfrak mr' \cong k'$ of $k$-extensions. these form a ``big'' category $\mathcal{c}$ with morphisms $(k_1, r_1, \phi_1) \to (k_2, r_2, \phi_2)$ given by ring maps $\psi : r_1 \to r_2$ such that $$ \xymatrix{ r_1 \ar[d]_\psi \ar[r]_{\phi_1} & k_1 \ar[r] & k \ar@{=}[d] \\ r_2 \ar[r]^{\phi_2} & k_2 \ar[r] & k } $$ commutes. this implies that $k_1 \subset k_2$. \medskip\noindent suppose that $i$ is a directed set, and $((r_i, k_i, \phi_i), \psi_{ii'})$ is a system over $i$, see categories, section \ref{categories-section-posets-limits}. in this case we can consider $$ r' = \colim_{i \in i} r_i $$ this is a local ring with maximal ideal $\mathfrak mr'$, and residue field $k' = \bigcup_{i \in i} k_i$. moreover, the ring map $r \to r'$ is flat as it is a colimit of flat maps (and tensor products commute with directed colimits). hence we see that $(r', k', \phi')$ is an ``upper bound'' for the system. \medskip\noindent an almost trivial application of zorn's lemma would finish the proof if $\mathcal{c}$ was a set, but it isn't. (actually, you can make this work by finding a reasonable bound on the cardinals of the local rings occurring.) to get around this problem we choose a well ordering on $k$. for $x \in k$ we let $k(x)$ be the subfield of $k$ generated by all elements of $k$ which are $\leq x$. by transfinite recursion on $x \in k$ we will produce ring maps $r \subset r(x)$ as in the lemma with residue field extension $k(x)/k$. moreover, by construction we will have that $r(x)$ will contain $r(y)$ for all $y \leq x$. namely, if $x$ has a predecessor $x'$, then $k(x) = k(x')[x]$ and hence we can let $r(x') \subset r(x)$ be the local ring extension constructed in the first paragraph of the proof. if $x$ does not have a predecessor, then we first set $r'(x) = \colim_{x' < x} r(x')$ as in the third paragraph of the proof. the residue field of $r'(x)$ is $k'(x) = \bigcup_{x' < x} k(x')$. since $k(x) = k'(x)[x]$ we see that we can use the construction of the first paragraph of the proof to produce $r'(x) \subset r(x)$. this finishes the proof of the lemma. \end{proof} \begin{lemma} \label{lemma-colimit-finite-etale-given-residue-field} let $(r, \mathfrak m, k)$ be a local ring. if $k \subset k$ is a separable algebraic extension, then there exists a directed set $i$ and a system of finite \'etale extensions $r \subset r_i$, $i \in i$ of local rings such that $r' = \colim r_i$ has residue field $k$ (as extension of $k$). \end{lemma} \begin{proof} let $r \subset r'$ be the extension constructed in the proof of lemma \ref{lemma-flat-local-given-residue-field}. by construction $r' = \colim_{\alpha \in a} r_\alpha$ where $a$ is a well-ordered set and the transition maps $r_\alpha \to r_{\alpha + 1}$ are finite \'etale and $r_\alpha = \colim_{\beta < \alpha} r_\beta$ if $\alpha$ is not a successor. we will prove the result by transfinite induction. \medskip\noindent suppose the result holds for $r_\alpha$, i.e., $r_\alpha = \colim r_i$ with $r_i$ finite \'etale over $r$. since $r_\alpha \to r_{\alpha + 1}$ is finite \'etale there exists an $i$ and a finite \'etale extension $r_i \to r_{i, 1}$ such that $r_{\alpha + 1} = r_\alpha \otimes_{r_i} r_{i, 1}$. thus $r_{\alpha + 1} = \colim_{i' \geq i} r_{i'} \otimes_{r_i} r_{i, 1}$ and the result holds for $\alpha + 1$. suppose $\alpha$ is not a successor and the result holds for $r_\beta$ for all $\beta < \alpha$. since every finite subset $e \subset r_\alpha$ is contained in $r_\beta$ for some $\beta < \alpha$ and we see that $e$ is contained in a finite \'etale subextension by assumption. thus the result holds for $r_\alpha$. \end{proof} \begin{lemma} \label{lemma-finite-free-given-residue-field-extension} let $r$ be a ring. let $\mathfrak p \subset r$ be a prime and let $l/\kappa(\mathfrak p)$ be a finite extension of fields. then there exists a finite free ring map $r \to s$ such that $\mathfrak q = \mathfrak ps$ is prime and $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is isomorphic to the given extension $l/\kappa(\mathfrak p)$. \end{lemma} \begin{proof} by induction of the degree of $\kappa(\mathfrak p) \subset l$. if the degree is $1$, then we take $r = s$. in general, if there exists a sub extension $\kappa(\mathfrak p) \subset l' \subset l$ then we win by induction on the degree (by first constructing $r \subset s'$ corresponding to $l'/\kappa(\mathfrak p)$ and then construction $s' \subset s$ corresponding to $l/l'$). thus we may assume that $l \supset \kappa(\mathfrak p)$ is generated by a single element $\alpha \in l$. let $x^d + \sum_{i < d} a_ix^i$ be the minimal polynomial of $\alpha$ over $\kappa(\mathfrak p)$, so $a_i \in \kappa(\mathfrak p)$. we may write $a_i$ as the image of $f_i/g$ for some $f_i, g \in r$ and $g \not \in \mathfrak p$. after replacing $\alpha$ by $g\alpha$ (and correspondingly replacing $a_i$ by $g^{d - i}a_i$) we may assume that $a_i$ is the image of some $f_i \in r$. then we simply take $s = r[x]/(x^d + \sum f_ix^i)$. \end{proof} \begin{lemma} \label{lemma-cofinal-system-flat} let $a$ be a ring. let $\kappa = \max(|a|, \aleph_0)$. then every flat $a$-algebra $b$ is the filtered colimit of its flat $a$-subalgebras $b' \subset b$ of cardinality $|b'| \leq \kappa$. (observe that $b'$ is faithfully flat over $a$ if $b$ is faithfully flat over $a$.) \end{lemma} \begin{proof} if $b$ has cardinality $\leq \kappa$ then this is true. let $e \subset b$ be an $a$-subalgebra with $|e| \leq \kappa$. we will show that $e$ is contained in a flat $a$-subalgebra $b'$ with $|b'| \leq \kappa$. the lemma follows because (a) every finite subset of $b$ is contained in an $a$-subalgebra of cardinality at most $\kappa$ and (b) every pair of $a$-subalgebras of $b$ of cardinality at most $\kappa$ is contained in an $a$-subalgebra of cardinality at most $\kappa$. details omitted. \medskip\noindent we will inductively construct a sequence of $a$-subalgebras $$ e = e_0 \subset e_1 \subset e_2 \subset \ldots $$ each having cardinality $\leq \kappa$ and we will show that $b' = \bigcup e_k$ is flat over $a$ to finish the proof. \medskip\noindent the construction is as follows. set $e_0 = e$. given $e_k$ for $k \geq 0$ we consider the set $s_k$ of relations between elements of $e_k$ with coefficients in $a$. thus an element $s \in s_k$ is given by an integer $n \geq 1$ and $a_1, \ldots, a_n \in a$, and $e_1, \ldots, e_n \in e_k$ such that $\sum a_i e_i = 0$ in $e_k$. the flatness of $a \to b$ implies by lemma \ref{lemma-flat-eq} that for every $s = (n, a_1, \ldots, a_n, e_1, \ldots, e_n) \in s_k$ we may choose $$ (m_s, b_{s, 1}, \ldots, b_{s, m_s}, a_{s, 11}, \ldots, a_{s, nm_s}) $$ where $m_s \geq 0$ is an integer, $b_{s, j} \in b$, $a_{s, ij} \in a$, and $$ e_i = \sum\nolimits_j a_{s, ij} b_{s, j}, \forall i, \quad\text{and}\quad 0 = \sum\nolimits_i a_i a_{s, ij}, \forall j. $$ given these choicse, we let $e_{k + 1} \subset b$ be the $a$-subalgebra generated by \begin{enumerate} \item $e_k$ and \item the elements $b_{s, 1}, \ldots, b_{s, m_s}$ for every $s \in s_k$. \end{enumerate} some set theory (omitted) shows that $e_{k + 1}$ has at most cardinality $\kappa$ (this uses that we inductively know $|e_k| \leq \kappa$ and consequently the cardinality of $s_k$ is also at most $\kappa$). \medskip\noindent to show that $b' = \bigcup e_k$ is flat over $a$ we consider a relation $\sum_{i = 1, \ldots, n} a_i b'_i = 0$ in $b'$ with coefficients in $a$. choose $k$ large enough so that $b'_i \in e_k$ for $i = 1, \ldots, n$. then $(n, a_1, \ldots, a_n, b'_1, \ldots, b'_n) \in s_k$ and hence we see that the relation is trivial in $e_{k + 1}$ and a fortiori in $b'$. thus $a \to b'$ is flat by lemma \ref{lemma-flat-eq}. \end{proof} \section{the cohen structure theorem} \label{section-cohen-structure-theorem} \noindent here is a fundamental notion in commutative algebra. \begin{definition} \label{definition-complete-local-ring} let $(r, \mathfrak m)$ be a local ring. we say $r$ is a {\it complete local ring} if the canonical map $$ r \longrightarrow \lim_n r/\mathfrak m^n $$ to the completion of $r$ with respect to $\mathfrak m$ is an isomorphism\footnote{this includes the condition that $\bigcap \mathfrak m^n = (0)$; in some texts this may be indicated by saying that $r$ is complete and separated. warning: it can happen that the completion $\lim_n r/\mathfrak m^n$ of a local ring is non-complete, see examples, lemma \ref{examples-lemma-noncomplete-completion}. this does not happen when $\mathfrak m$ is finitely generated, see lemma \ref{lemma-hathat-finitely-generated} in which case the completion is noetherian, see lemma \ref{lemma-completion-noetherian}.}. \end{definition} \noindent note that an artinian local ring $r$ is a complete local ring because $\mathfrak m_r^n = 0$ for some $n > 0$. in this section we mostly focus on noetherian complete local rings. \begin{lemma} \label{lemma-quotient-complete-local} let $r$ be a noetherian complete local ring. any quotient of $r$ is also a noetherian complete local ring. given a finite ring map $r \to s$, then $s$ is a product of noetherian complete local rings. \end{lemma} \begin{proof} the ring $s$ is noetherian by lemma \ref{lemma-noetherian-permanence}. as an $r$-module $s$ is complete by lemma \ref{lemma-completion-tensor}. hence $s$ is the product of the completions at its maximal ideals by lemma \ref{lemma-completion-finite-extension}. \end{proof} \begin{lemma} \label{lemma-complete-local-ring-noetherian} let $(r, \mathfrak m)$ be a complete local ring. if $\mathfrak m$ is a finitely generated ideal then $r$ is noetherian. \end{lemma} \begin{proof} see lemma \ref{lemma-completion-noetherian}. \end{proof} \begin{definition} \label{definition-coefficient-ring} let $(r, \mathfrak m)$ be a complete local ring. a subring $\lambda \subset r$ is called a {\it coefficient ring} if the following conditions hold: \begin{enumerate} \item $\lambda$ is a complete local ring with maximal ideal $\lambda \cap \mathfrak m$, \item the residue field of $\lambda$ maps isomorphically to the residue field of $r$, and \item $\lambda \cap \mathfrak m = p\lambda$, where $p$ is the characteristic of the residue field of $r$. \end{enumerate} \end{definition} \noindent let us make some remarks on this definition. we split the discussion into the following cases: \begin{enumerate} \item the local ring $r$ contains a field. this happens if either $\mathbf{q} \subset r$, or $pr = 0$ where $p$ is the characteristic of $r/\mathfrak m$. in this case a coefficient ring $\lambda$ is a field contained in $r$ which maps isomorphically to $r/\mathfrak m$. \item the characteristic of $r/\mathfrak m$ is $p > 0$ but no power of $p$ is zero in $r$. in this case $\lambda$ is a complete discrete valuation ring with uniformizer $p$ and residue field $r/\mathfrak m$. \item the characteristic of $r/\mathfrak m$ is $p > 0$, and for some $n > 1$ we have $p^{n - 1} \not = 0$, $p^n = 0$ in $r$. in this case $\lambda$ is an artinian local ring whose maximal ideal is generated by $p$ and which has residue field $r/\mathfrak m$. \end{enumerate} the complete discrete valuation rings with uniformizer $p$ above play a special role and we baptize them as follows. \begin{definition} \label{definition-cohen-ring} a {\it cohen ring} is a complete discrete valuation ring with uniformizer $p$ a prime number. \end{definition} \begin{lemma} \label{lemma-cohen-rings-exist} let $p$ be a prime number. let $k$ be a field of characteristic $p$. there exists a cohen ring $\lambda$ with $\lambda/p\lambda \cong k$. \end{lemma} \begin{proof} first note that the $p$-adic integers $\mathbf{z}_p$ form a cohen ring for $\mathbf{f}_p$. let $k$ be an arbitrary field of characteristic $p$. let $\mathbf{z}_p \to r$ be a flat local ring map such that $\mathfrak m_r = pr$ and $r/pr = k$, see lemma \ref{lemma-flat-local-given-residue-field}. by lemma \ref{lemma-completion-noetherian} the completion $\lambda = r^\wedge$ is noetherian. it is a complete noetherian local ring with maximal ideal $(p)$ as $\lambda/p\lambda = r/pr$ is a field (use lemma \ref{lemma-hathat-finitely-generated}). since $\mathbf{z}_p \to r \to \lambda$ is flat (by lemma \ref{lemma-completion-flat}) we see that $p$ is a nonzerodivisor in $\lambda$. hence $\lambda$ has dimension $\geq 1$ (lemma \ref{lemma-one-equation}) and we conclude that $\lambda$ is regular of dimension $1$, i.e., a discrete valuation ring by lemma \ref{lemma-characterize-dvr}. we conclude $\lambda$ is a cohen ring for $k$. \end{proof} \begin{lemma} \label{lemma-cohen-ring-formally-smooth} let $p > 0$ be a prime. let $\lambda$ be a cohen ring with residue field of characteristic $p$. for every $n \geq 1$ the ring map $$ \mathbf{z}/p^n\mathbf{z} \to \lambda/p^n\lambda $$ is formally smooth. \end{lemma} \begin{proof} if $n = 1$, this follows from proposition \ref{proposition-characterize-separable-field-extensions}. for general $n$ we argue by induction on $n$. namely, if $\mathbf{z}/p^n\mathbf{z} \to \lambda/p^n\lambda$ is formally smooth, then we can apply lemma \ref{lemma-lift-formal-smoothness} to the ring map $\mathbf{z}/p^{n + 1}\mathbf{z} \to \lambda/p^{n + 1}\lambda$ and the ideal $i = (p^n) \subset \mathbf{z}/p^{n + 1}\mathbf{z}$. \end{proof} \begin{theorem}[cohen structure theorem] \label{theorem-cohen-structure-theorem} let $(r, \mathfrak m)$ be a complete local ring. \begin{enumerate} \item $r$ has a coefficient ring (see definition \ref{definition-coefficient-ring}), \item if $\mathfrak m$ is a finitely generated ideal, then $r$ is isomorphic to a quotient $$ \lambda[[x_1, \ldots, x_n]]/i $$ where $\lambda$ is either a field or a cohen ring. \end{enumerate} \end{theorem} \begin{proof} let us prove a coefficient ring exists. first we prove this in case the characteristic of the residue field $\kappa$ is zero. namely, in this case we will prove by induction on $n > 0$ that there exists a section $$ \varphi_n : \kappa \longrightarrow r/\mathfrak m^n $$ to the canonical map $r/\mathfrak m^n \to \kappa = r/\mathfrak m$. this is trivial for $n = 1$. if $n > 1$, let $\varphi_{n - 1}$ be given. the field extension $\kappa/\mathbf{q}$ is formally smooth by proposition \ref{proposition-characterize-separable-field-extensions}. hence we can find the dotted arrow in the following diagram $$ \xymatrix{ r/\mathfrak m^{n - 1} & r/\mathfrak m^n \ar[l] \\ \kappa \ar[u]^{\varphi_{n - 1}} \ar@{..>}[ru] & \mathbf{q} \ar[l] \ar[u] } $$ this proves the induction step. putting these maps together $$ \lim_n\ \varphi_n : \kappa \longrightarrow r = \lim_n\ r/\mathfrak m^n $$ gives a map whose image is the desired coefficient ring. \medskip\noindent next, we prove the existence of a coefficient ring in the case where the characteristic of the residue field $\kappa$ is $p > 0$. namely, choose a cohen ring $\lambda$ with $\kappa = \lambda/p\lambda$, see lemma \ref{lemma-cohen-rings-exist}. in this case we will prove by induction on $n > 0$ that there exists a map $$ \varphi_n : \lambda/p^n\lambda \longrightarrow r/\mathfrak m^n $$ whose composition with the reduction map $r/\mathfrak m^n \to \kappa$ produces the given isomorphism $\lambda/p\lambda = \kappa$. this is trivial for $n = 1$. if $n > 1$, let $\varphi_{n - 1}$ be given. the ring map $\mathbf{z}/p^n\mathbf{z} \to \lambda/p^n\lambda$ is formally smooth by lemma \ref{lemma-cohen-ring-formally-smooth}. hence we can find the dotted arrow in the following diagram $$ \xymatrix{ r/\mathfrak m^{n - 1} & r/\mathfrak m^n \ar[l] \\ \lambda/p^n\lambda \ar[u]^{\varphi_{n - 1}} \ar@{..>}[ru] & \mathbf{z}/p^n\mathbf{z} \ar[l] \ar[u] } $$ this proves the induction step. putting these maps together $$ \lim_n\ \varphi_n : \lambda = \lim_n\ \lambda/p^n\lambda \longrightarrow r = \lim_n\ r/\mathfrak m^n $$ gives a map whose image is the desired coefficient ring. \medskip\noindent the final statement of the theorem follows readily. namely, if $y_1, \ldots, y_n$ are generators of the ideal $\mathfrak m$, then we can use the map $\lambda \to r$ just constructed to get a map $$ \lambda[[x_1, \ldots, x_n]] \longrightarrow r, \quad x_i \longmapsto y_i. $$ since both sides are $(x_1, \ldots, x_n)$-adically complete this map is surjective by lemma \ref{lemma-completion-generalities} as it is surjective modulo $(x_1, \ldots, x_n)$ by construction. \end{proof} \begin{remark} \label{remark-noetherian-complete-local-ring-universally-catenary} if $k$ is a field then the power series ring $k[[x_1, \ldots, x_d]]$ is a noetherian complete local regular ring of dimension $d$. if $\lambda$ is a cohen ring then $\lambda[[x_1, \ldots, x_d]]$ is a complete local noetherian regular ring of dimension $d + 1$. hence the cohen structure theorem implies that any noetherian complete local ring is a quotient of a regular local ring. in particular we see that a noetherian complete local ring is universally catenary, see lemma \ref{lemma-cm-ring-catenary} and lemma \ref{lemma-regular-ring-cm}. \end{remark} \begin{lemma} \label{lemma-regular-complete-containing-coefficient-field} let $(r, \mathfrak m)$ be a noetherian complete local ring. assume $r$ is regular. \begin{enumerate} \item if $r$ contains either $\mathbf{f}_p$ or $\mathbf{q}$, then $r$ is isomorphic to a power series ring over its residue field. \item if $k$ is a field and $k \to r$ is a ring map inducing an isomorphism $k \to r/\mathfrak m$, then $r$ is isomorphic as a $k$-algebra to a power series ring over $k$. \end{enumerate} \end{lemma} \begin{proof} in case (1), by the cohen structure theorem (theorem \ref{theorem-cohen-structure-theorem}) there exists a coefficient ring which must be a field mapping isomorphically to the residue field. thus it suffices to prove (2). in case (2) we pick $f_1, \ldots, f_d \in \mathfrak m$ which map to a basis of $\mathfrak m/\mathfrak m^2$ and we consider the continuous $k$-algebra map $k[[x_1, \ldots, x_d]] \to r$ sending $x_i$ to $f_i$. as both source and target are $(x_1, \ldots, x_d)$-adically complete, this map is surjective by lemma \ref{lemma-completion-generalities}. on the other hand, it has to be injective because otherwise the dimension of $r$ would be $< d$ by lemma \ref{lemma-one-equation}. \end{proof} \begin{lemma} \label{lemma-complete-local-noetherian-domain-finite-over-regular} let $(r, \mathfrak m)$ be a noetherian complete local domain. then there exists a $r_0 \subset r$ with the following properties \begin{enumerate} \item $r_0$ is a regular complete local ring, \item $r_0 \subset r$ is finite and induces an isomorphism on residue fields, \item $r_0$ is either isomorphic to $k[[x_1, \ldots, x_d]]$ where $k$ is a field or $\lambda[[x_1, \ldots, x_d]]$ where $\lambda$ is a cohen ring. \end{enumerate} \end{lemma} \begin{proof} let $\lambda$ be a coefficient ring of $r$. since $r$ is a domain we see that either $\lambda$ is a field or $\lambda$ is a cohen ring. \medskip\noindent case i: $\lambda = k$ is a field. let $d = \dim(r)$. choose $x_1, \ldots, x_d \in \mathfrak m$ which generate an ideal of definition $i \subset r$. (see section \ref{section-dimension}.) by lemma \ref{lemma-change-ideal-completion} we see that $r$ is $i$-adically complete as well. consider the map $r_0 = k[[x_1, \ldots, x_d]] \to r$ which maps $x_i$ to $x_i$. note that $r_0$ is complete with respect to the ideal $i_0 = (x_1, \ldots, x_d)$, and that $r/i_0r \cong r/ir$ is finite over $k = r_0/i_0$ (because $\dim(r/i) = 0$, see section \ref{section-dimension}.) hence we conclude that $r_0 \to r$ is finite by lemma \ref{lemma-finite-over-complete-ring}. since $\dim(r) = \dim(r_0)$ this implies that $r_0 \to r$ is injective (see lemma \ref{lemma-integral-dim-up}), and the lemma is proved. \medskip\noindent case ii: $\lambda$ is a cohen ring. let $d + 1 = \dim(r)$. let $p > 0$ be the characteristic of the residue field $k$. as $r$ is a domain we see that $p$ is a nonzerodivisor in $r$. hence $\dim(r/pr) = d$, see lemma \ref{lemma-one-equation}. choose $x_1, \ldots, x_d \in r$ which generate an ideal of definition in $r/pr$. then $i = (p, x_1, \ldots, x_d)$ is an ideal of definition of $r$. by lemma \ref{lemma-change-ideal-completion} we see that $r$ is $i$-adically complete as well. consider the map $r_0 = \lambda[[x_1, \ldots, x_d]] \to r$ which maps $x_i$ to $x_i$. note that $r_0$ is complete with respect to the ideal $i_0 = (p, x_1, \ldots, x_d)$, and that $r/i_0r \cong r/ir$ is finite over $k = r_0/i_0$ (because $\dim(r/i) = 0$, see section \ref{section-dimension}.) hence we conclude that $r_0 \to r$ is finite by lemma \ref{lemma-finite-over-complete-ring}. since $\dim(r) = \dim(r_0)$ this implies that $r_0 \to r$ is injective (see lemma \ref{lemma-integral-dim-up}), and the lemma is proved. \end{proof} \section{japanese rings} \label{section-japanese} \noindent in this section we begin to discuss finiteness of integral closure. \begin{definition} \label{definition-n} \begin{reference} \cite[chapter 0, definition 23.1.1]{ega} \end{reference} let $r$ be a domain with field of fractions $k$. \begin{enumerate} \item we say $r$ is {\it n-1} if the integral closure of $r$ in $k$ is a finite $r$-module. \item we say $r$ is {\it n-2} or {\it japanese} if for any finite extension $l/k$ of fields the integral closure of $r$ in $l$ is finite over $r$. \end{enumerate} \end{definition} \noindent the main interest in these notions is for noetherian rings, but here is a non-noetherian example. \begin{example} \label{example-japanese-not-noetherian} let $k$ be a field. the domain $r = k[x_1, x_2, x_3, \ldots]$ is n-2, but not noetherian. the reason is the following. suppose that $r \subset l$ and the field $l$ is a finite extension of the fraction field of $r$. then there exists an integer $n$ such that $l$ comes from a finite extension $l_0/k(x_1, \ldots, x_n)$ by adjoining the (transcendental) elements $x_{n + 1}, x_{n + 2}$, etc. let $s_0$ be the integral closure of $k[x_1, \ldots, x_n]$ in $l_0$. by proposition \ref{proposition-ubiquity-nagata} below it is true that $s_0$ is finite over $k[x_1, \ldots, x_n]$. moreover, the integral closure of $r$ in $l$ is $s = s_0[x_{n + 1}, x_{n + 2}, \ldots]$ (use lemma \ref{lemma-polynomial-domain-normal}) and hence finite over $r$. the same argument works for $r = \mathbf{z}[x_1, x_2, x_3, \ldots]$. \end{example} \begin{lemma} \label{lemma-localize-n} let $r$ be a domain. if $r$ is n-1 then so is any localization of $r$. same for n-2. \end{lemma} \begin{proof} these statements hold because taking integral closure commutes with localization, see lemma \ref{lemma-integral-closure-localize}. \end{proof} \begin{lemma} \label{lemma-japanese-local} let $r$ be a domain. let $f_1, \ldots, f_n \in r$ generate the unit ideal. if each domain $r_{f_i}$ is n-1 then so is $r$. same for n-2. \end{lemma} \begin{proof} assume $r_{f_i}$ is n-2 (or n-1). let $l$ be a finite extension of the fraction field of $r$ (equal to the fraction field in the n-1 case). let $s$ be the integral closure of $r$ in $l$. by lemma \ref{lemma-integral-closure-localize} we see that $s_{f_i}$ is the integral closure of $r_{f_i}$ in $l$. hence $s_{f_i}$ is finite over $r_{f_i}$ by assumption. thus $s$ is finite over $r$ by lemma \ref{lemma-cover}. \end{proof} \begin{lemma} \label{lemma-quasi-finite-over-noetherian-japanese} let $r$ be a domain. let $r \subset s$ be a quasi-finite extension of domains (for example finite). assume $r$ is n-2 and noetherian. then $s$ is n-2. \end{lemma} \begin{proof} let $l/k$ be the induced extension of fraction fields. note that this is a finite field extension (for example by lemma \ref{lemma-isolated-point-fibre} (2) applied to the fibre $s \otimes_r k$, and the definition of a quasi-finite ring map). let $s'$ be the integral closure of $r$ in $s$. then $s'$ is contained in the integral closure of $r$ in $l$ which is finite over $r$ by assumption. as $r$ is noetherian this implies $s'$ is finite over $r$. by lemma \ref{lemma-quasi-finite-open-integral-closure} there exist elements $g_1, \ldots, g_n \in s'$ such that $s'_{g_i} \cong s_{g_i}$ and such that $g_1, \ldots, g_n$ generate the unit ideal in $s$. hence it suffices to show that $s'$ is n-2 by lemmas \ref{lemma-localize-n} and \ref{lemma-japanese-local}. thus we have reduced to the case where $s$ is finite over $r$. \medskip\noindent assume $r \subset s$ with hypotheses as in the lemma and moreover that $s$ is finite over $r$. let $m$ be a finite field extension of the fraction field of $s$. then $m$ is also a finite field extension of $k$ and we conclude that the integral closure $t$ of $r$ in $m$ is finite over $r$. by lemma \ref{lemma-integral-closure-transitive} we see that $t$ is also the integral closure of $s$ in $m$ and we win by lemma \ref{lemma-integral-permanence}. \end{proof} \begin{lemma} \label{lemma-laurent-ring-n-1} let $r$ be a noetherian domain. if $r[z, z^{-1}]$ is n-1, then so is $r$. \end{lemma} \begin{proof} let $r'$ be the integral closure of $r$ in its field of fractions $k$. let $s'$ be the integral closure of $r[z, z^{-1}]$ in its field of fractions. clearly $r' \subset s'$. since $k[z, z^{-1}]$ is a normal domain we see that $s' \subset k[z, z^{-1}]$. suppose that $f_1, \ldots, f_n \in s'$ generate $s'$ as $r[z, z^{-1}]$-module. say $f_i = \sum a_{ij}z^j$ (finite sum), with $a_{ij} \in k$. for any $x \in r'$ we can write $$ x = \sum h_i f_i $$ with $h_i \in r[z, z^{-1}]$. thus we see that $r'$ is contained in the finite $r$-submodule $\sum ra_{ij} \subset k$. since $r$ is noetherian we conclude that $r'$ is a finite $r$-module. \end{proof} \begin{lemma} \label{lemma-finite-extension-n-2} let $r$ be a noetherian domain, and let $r \subset s$ be a finite extension of domains. if $s$ is n-1, then so is $r$. if $s$ is n-2, then so is $r$. \end{lemma} \begin{proof} omitted. (hint: integral closures of $r$ in extension fields are contained in integral closures of $s$ in extension fields.) \end{proof} \begin{lemma} \label{lemma-noetherian-normal-domain-finite-separable-extension} let $r$ be a noetherian normal domain with fraction field $k$. let $l/k$ be a finite separable field extension. then the integral closure of $r$ in $l$ is finite over $r$. \end{lemma} \begin{proof} consider the trace pairing (fields, definition \ref{fields-definition-trace-pairing}) $$ l \times l \longrightarrow k, \quad (x, y) \longmapsto \langle x, y\rangle := \text{trace}_{l/k}(xy). $$ since $l/k$ is separable this is nondegenerate (fields, lemma \ref{fields-lemma-separable-trace-pairing}). moreover, if $x \in l$ is integral over $r$, then $\text{trace}_{l/k}(x)$ is in $r$. this is true because the minimal polynomial of $x$ over $k$ has coefficients in $r$ (lemma \ref{lemma-minimal-polynomial-normal-domain}) and because $\text{trace}_{l/k}(x)$ is an integer multiple of one of these coefficients (fields, lemma \ref{fields-lemma-trace-and-norm-from-minimal-polynomial}). pick $x_1, \ldots, x_n \in l$ which are integral over $r$ and which form a $k$-basis of $l$. then the integral closure $s \subset l$ is contained in the $r$-module $$ m = \{y \in l \mid \langle x_i, y\rangle \in r, \ i = 1, \ldots, n\} $$ by linear algebra we see that $m \cong r^{\oplus n}$ as an $r$-module. hence $s \subset r^{\oplus n}$ is a finitely generated $r$-module as $r$ is noetherian. \end{proof} \begin{example} \label{example-bad-invariants} lemma \ref{lemma-noetherian-normal-domain-finite-separable-extension} does not work if the ring is not noetherian. for example consider the action of $g = \{+1, -1\}$ on $a = \mathbf{c}[x_1, x_2, x_3, \ldots]$ where $-1$ acts by mapping $x_i$ to $-x_i$. the invariant ring $r = a^g$ is the $\mathbf{c}$-algebra generated by all $x_ix_j$. hence $r \subset a$ is not finite. but $r$ is a normal domain with fraction field $k = l^g$ the $g$-invariants in the fraction field $l$ of $a$. and clearly $a$ is the integral closure of $r$ in $l$. \end{example} \noindent the following lemma can sometimes be used as a substitute for lemma \ref{lemma-noetherian-normal-domain-finite-separable-extension} in case of purely inseparable extensions. \begin{lemma} \label{lemma-noetherian-normal-domain-insep-extension} let $r$ be a noetherian normal domain with fraction field $k$ of characteristic $p > 0$. let $a \in k$ be an element such that there exists a derivation $d : r \to r$ with $d(a) \not = 0$. then the integral closure of $r$ in $l = k[x]/(x^p - a)$ is finite over $r$. \end{lemma} \begin{proof} after replacing $x$ by $fx$ and $a$ by $f^pa$ for some $f \in r$ we may assume $a \in r$. hence also $d(a) \in r$. we will show by induction on $i \leq p - 1$ that if $$ y = a_0 + a_1x + \ldots + a_i x^i,\quad a_j \in k $$ is integral over $r$, then $d(a)^i a_j \in r$. thus the integral closure is contained in the finite $r$-module with basis $d(a)^{-p + 1}x^j$, $j = 0, \ldots, p - 1$. since $r$ is noetherian this proves the lemma. \medskip\noindent if $i = 0$, then $y = a_0$ is integral over $r$ if and only if $a_0 \in r$ and the statement is true. suppose the statement holds for some $i < p - 1$ and suppose that $$ y = a_0 + a_1x + \ldots + a_{i + 1} x^{i + 1},\quad a_j \in k $$ is integral over $r$. then $$ y^p = a_0^p + a_1^p a + \ldots + a_{i + 1}^pa^{i + 1} $$ is an element of $r$ (as it is in $k$ and integral over $r$). applying $d$ we obtain $$ (a_1^p + 2a_2^p a + \ldots + (i + 1)a_{i + 1}^p a^i)d(a) $$ is in $r$. hence it follows that $$ d(a)a_1 + 2d(a) a_2 x + \ldots + (i + 1)d(a) a_{i + 1} x^i $$ is integral over $r$. by induction we find $d(a)^{i + 1}a_j \in r$ for $j = 1, \ldots, i + 1$. (here we use that $1, \ldots, i + 1$ are invertible.) hence $d(a)^{i + 1}a_0$ is also in $r$ because it is the difference of $d(a)^{i + 1}y$ and $\sum_{j > 0} d(a)^{i + 1}a_jx^j$ which are integral over $r$ (since $x$ is integral over $r$ as $a \in r$). \end{proof} \begin{lemma} \label{lemma-domain-char-zero-n-1-2} a noetherian domain whose fraction field has characteristic zero is n-1 if and only if it is n-2 (i.e., japanese). \end{lemma} \begin{proof} this is clear from lemma \ref{lemma-noetherian-normal-domain-finite-separable-extension} since every field extension in characteristic zero is separable. \end{proof} \begin{lemma} \label{lemma-domain-char-p-n-1-2} let $r$ be a noetherian domain with fraction field $k$ of characteristic $p > 0$. then $r$ is n-2 if and only if for every finite purely inseparable extension $l/k$ the integral closure of $r$ in $l$ is finite over $r$. \end{lemma} \begin{proof} assume the integral closure of $r$ in every finite purely inseparable field extension of $k$ is finite. let $l/k$ be any finite extension. we have to show the integral closure of $r$ in $l$ is finite over $r$. choose a finite normal field extension $m/k$ containing $l$. as $r$ is noetherian it suffices to show that the integral closure of $r$ in $m$ is finite over $r$. by fields, lemma \ref{fields-lemma-normal-case} there exists a subextension $m/m_{insep}/k$ such that $m_{insep}/k$ is purely inseparable, and $m/m_{insep}$ is separable. by assumption the integral closure $r'$ of $r$ in $m_{insep}$ is finite over $r$. by lemma \ref{lemma-noetherian-normal-domain-finite-separable-extension} the integral closure $r''$ of $r'$ in $m$ is finite over $r'$. then $r''$ is finite over $r$ by lemma \ref{lemma-finite-transitive}. since $r''$ is also the integral closure of $r$ in $m$ (see lemma \ref{lemma-integral-closure-transitive}) we win. \end{proof} \begin{lemma} \label{lemma-polynomial-ring-n-2} let $r$ be a noetherian domain. if $r$ is n-1 then $r[x]$ is n-1. if $r$ is n-2 then $r[x]$ is n-2. \end{lemma} \begin{proof} assume $r$ is n-1. let $r'$ be the integral closure of $r$ which is finite over $r$. hence also $r'[x]$ is finite over $r[x]$. the ring $r'[x]$ is normal (see lemma \ref{lemma-polynomial-domain-normal}), hence n-1. this proves the first assertion. \medskip\noindent for the second assertion, by lemma \ref{lemma-finite-extension-n-2} it suffices to show that $r'[x]$ is n-2. in other words we may and do assume that $r$ is a normal n-2 domain. in characteristic zero we are done by lemma \ref{lemma-domain-char-zero-n-1-2}. in characteristic $p > 0$ we have to show that the integral closure of $r[x]$ is finite in any finite purely inseparable extension of $l/k(x)$ where $k$ is the fraction field of $r$. there exists a finite purely inseparable field extension $l'/k$ and $q = p^e$ such that $l \subset l'(x^{1/q})$; some details omitted. as $r[x]$ is noetherian it suffices to show that the integral closure of $r[x]$ in $l'(x^{1/q})$ is finite over $r[x]$. and this integral closure is equal to $r'[x^{1/q}]$ with $r \subset r' \subset l'$ the integral closure of $r$ in $l'$. since $r$ is n-2 we see that $r'$ is finite over $r$ and hence $r'[x^{1/q}]$ is finite over $r[x]$. \end{proof} \begin{lemma} \label{lemma-openness-normal-locus} let $r$ be a noetherian domain. if there exists a nonzero $f \in r$ such that $r_f$ is normal then $$ u = \{\mathfrak p \in \spec(r) \mid r_{\mathfrak p} \text{ is normal}\} $$ is open in $\spec(r)$. \end{lemma} \begin{proof} it is clear that the standard open $d(f)$ is contained in $u$. by serre's criterion lemma \ref{lemma-criterion-normal} we see that $\mathfrak p \not \in u$ implies that for some $\mathfrak q \subset \mathfrak p$ we have either \begin{enumerate} \item case i: $\text{depth}(r_{\mathfrak q}) < 2$ and $\dim(r_{\mathfrak q}) \geq 2$, and \item case ii: $r_{\mathfrak q}$ is not regular and $\dim(r_{\mathfrak q}) = 1$. \end{enumerate} this in particular also means that $r_{\mathfrak q}$ is not normal, and hence $f \in \mathfrak q$. in case i we see that $\text{depth}(r_{\mathfrak q}) = \text{depth}(r_{\mathfrak q}/fr_{\mathfrak q}) + 1$. hence such a prime $\mathfrak q$ is the same thing as an embedded associated prime of $r/fr$. in case ii $\mathfrak q$ is an associated prime of $r/fr$ of height 1. thus there is a finite set $e$ of such primes $\mathfrak q$ (see lemma \ref{lemma-finite-ass}) and $$ \spec(r) \setminus u = \bigcup\nolimits_{\mathfrak q \in e} v(\mathfrak q) $$ as desired. \end{proof} \begin{lemma} \label{lemma-characterize-n-1} let $r$ be a noetherian domain. then $r$ is n-1 if and only if the following two conditions hold \begin{enumerate} \item there exists a nonzero $f \in r$ such that $r_f$ is normal, and \item for every maximal ideal $\mathfrak m \subset r$ the local ring $r_{\mathfrak m}$ is n-1. \end{enumerate} \end{lemma} \begin{proof} first assume $r$ is n-1. let $r'$ be the integral closure of $r$ in its field of fractions $k$. by assumption we can find $x_1, \ldots, x_n$ in $r'$ which generate $r'$ as an $r$-module. since $r' \subset k$ we can find $f_i \in r$ nonzero such that $f_i x_i \in r$. then $r_f \cong r'_f$ where $f = f_1 \ldots f_n$. hence $r_f$ is normal and we have (1). part (2) follows from lemma \ref{lemma-localize-n}. \medskip\noindent assume (1) and (2). let $k$ be the fraction field of $r$. suppose that $r \subset r' \subset k$ is a finite extension of $r$ contained in $k$. note that $r_f = r'_f$ since $r_f$ is already normal. hence by lemma \ref{lemma-openness-normal-locus} the set of primes $\mathfrak p' \in \spec(r')$ with $r'_{\mathfrak p'}$ non-normal is closed in $\spec(r')$. since $\spec(r') \to \spec(r)$ is closed the image of this set is closed in $\spec(r)$. for such a ring $r'$ denote $z_{r'} \subset \spec(r)$ this image. \medskip\noindent pick a maximal ideal $\mathfrak m \subset r$. let $r_{\mathfrak m} \subset r_{\mathfrak m}'$ be the integral closure of the local ring in $k$. by assumption this is a finite ring extension. by lemma \ref{lemma-integral-closure-localize} we can find finitely many elements $x_1, \ldots, x_n \in k$ integral over $r$ such that $r_{\mathfrak m}'$ is generated by $x_1, \ldots, x_n$ over $r_{\mathfrak m}$. let $r' = r[x_1, \ldots, x_n] \subset k$. with this choice it is clear that $\mathfrak m \not \in z_{r'}$. \medskip\noindent as $\spec(r)$ is quasi-compact, the above shows that we can find a finite collection $r \subset r'_i \subset k$ such that $\bigcap z_{r'_i} = \emptyset$. let $r'$ be the subring of $k$ generated by all of these. it is finite over $r$. also $z_{r'} = \emptyset$. namely, every prime $\mathfrak p'$ lies over a prime $\mathfrak p'_i$ such that $(r'_i)_{\mathfrak p'_i}$ is normal. this implies that $r'_{\mathfrak p'} = (r'_i)_{\mathfrak p'_i}$ is normal too. hence $r'$ is normal, in other words $r'$ is the integral closure of $r$ in $k$. \end{proof} \begin{lemma}[tate] \label{lemma-tate-japanese} \begin{reference} \cite[theorem 23.1.3]{ega} \end{reference} let $r$ be a ring. let $x \in r$. assume \begin{enumerate} \item $r$ is a normal noetherian domain, \item $r/xr$ is a domain and n-2, \item $r \cong \lim_n r/x^nr$ is complete with respect to $x$. \end{enumerate} then $r$ is n-2. \end{lemma} \begin{proof} we may assume $x \not = 0$ since otherwise the lemma is trivial. let $k$ be the fraction field of $r$. if the characteristic of $k$ is zero the lemma follows from (1), see lemma \ref{lemma-domain-char-zero-n-1-2}. hence we may assume that the characteristic of $k$ is $p > 0$, and we may apply lemma \ref{lemma-domain-char-p-n-1-2}. thus given $l/k$ a finite purely inseparable field extension we have to show that the integral closure $s$ of $r$ in $l$ is finite over $r$. \medskip\noindent let $q$ be a power of $p$ such that $l^q \subset k$. by enlarging $l$ if necessary we may assume there exists an element $y \in l$ such that $y^q = x$. since $r \to s$ induces a homeomorphism of spectra (see lemma \ref{lemma-p-ring-map}) there is a unique prime ideal $\mathfrak q \subset s$ lying over the prime ideal $\mathfrak p = xr$. it is clear that $$ \mathfrak q = \{f \in s \mid f^q \in \mathfrak p\} = ys $$ since $y^q = x$. observe that $r_{\mathfrak p}$ is a discrete valuation ring by lemma \ref{lemma-characterize-dvr}. then $s_{\mathfrak q}$ is noetherian by krull-akizuki (lemma \ref{lemma-krull-akizuki}). whereupon we conclude $s_{\mathfrak q}$ is a discrete valuation ring by lemma \ref{lemma-characterize-dvr} once again. by lemma \ref{lemma-finite-extension-residue-fields-dimension-1} we see that $\kappa(\mathfrak q)/\kappa(\mathfrak p)$ is a finite field extension. hence the integral closure $s' \subset \kappa(\mathfrak q)$ of $r/xr$ is finite over $r/xr$ by assumption (2). since $s/ys \subset s'$ this implies that $s/ys$ is finite over $r$. note that $s/y^ns$ has a finite filtration whose subquotients are the modules $y^is/y^{i + 1}s \cong s/ys$. hence we see that each $s/y^ns$ is finite over $r$. in particular $s/xs$ is finite over $r$. also, it is clear that $\bigcap x^ns = (0)$ since an element in the intersection has $q$th power contained in $\bigcap x^nr = (0)$ (lemma \ref{lemma-intersect-powers-ideal-module-zero}). thus we may apply lemma \ref{lemma-finite-over-complete-ring} to conclude that $s$ is finite over $r$, and we win. \end{proof} \begin{lemma} \label{lemma-power-series-over-n-2} let $r$ be a ring. if $r$ is noetherian, a domain, and n-2, then so is $r[[x]]$. \end{lemma} \begin{proof} observe that $r[[x]]$ is noetherian by lemma \ref{lemma-noetherian-power-series}. let $r' \supset r$ be the integral closure of $r$ in its fraction field. because $r$ is n-2 this is finite over $r$. hence $r'[[x]]$ is finite over $r[[x]]$. by lemma \ref{lemma-power-series-over-noetherian-normal-domain} we see that $r'[[x]]$ is a normal domain. apply lemma \ref{lemma-tate-japanese} to the element $x \in r'[[x]]$ to see that $r'[[x]]$ is n-2. then lemma \ref{lemma-finite-extension-n-2} shows that $r[[x]]$ is n-2. \end{proof} \section{nagata rings} \label{section-nagata} \noindent here is the definition. \begin{definition} \label{definition-nagata} let $r$ be a ring. \begin{enumerate} \item we say $r$ is {\it universally japanese} if for any finite type ring map $r \to s$ with $s$ a domain we have that $s$ is n-2 (i.e., japanese). \item we say that $r$ is a {\it nagata ring} if $r$ is noetherian and for every prime ideal $\mathfrak p$ the ring $r/\mathfrak p$ is n-2. \end{enumerate} \end{definition} \noindent it is clear that a noetherian universally japanese ring is a nagata ring. it is our goal to show that a nagata ring is universally japanese. this is not obvious at all, and requires some work. but first, here is a useful lemma. \begin{lemma} \label{lemma-nagata-in-reduced-finite-type-finite-integral-closure} let $r$ be a nagata ring. let $r \to s$ be essentially of finite type with $s$ reduced. then the integral closure $a$ of $r$ in $s$ is finite over $r$. \end{lemma} \begin{proof} as $s$ is essentially of finite type over $r$ it is noetherian and has finitely many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_m$, see lemma \ref{lemma-noetherian-irreducible-components}. since $s$ is reduced we have $s \subset \prod s_{\mathfrak q_i}$ and each $s_{\mathfrak q_i} = k_i$ is a field, see lemmas \ref{lemma-total-ring-fractions-no-embedded-points} and \ref{lemma-minimal-prime-reduced-ring}. it suffices to show that the integral closure $a_i'$ of $r$ in each $k_i$ is finite over $r$. this is true because $r$ is noetherian and $a \subset \prod a_i'$. let $\mathfrak p_i \subset r$ be the prime of $r$ corresponding to $\mathfrak q_i$. as $s$ is essentially of finite type over $r$ we see that $k_i = s_{\mathfrak q_i} = \kappa(\mathfrak q_i)$ is a finitely generated field extension of $\kappa(\mathfrak p_i)$. hence the algebraic closure $l_i$ of $\kappa(\mathfrak p_i)$ in $k_i$ is finite over $\kappa(\mathfrak p_i)$, see fields, lemma \ref{fields-lemma-algebraic-closure-in-finitely-generated}. it is clear that $a_i'$ is the integral closure of $r/\mathfrak p_i$ in $l_i$, and hence we win by definition of a nagata ring. \end{proof} \begin{lemma} \label{lemma-check-universally-japanese} let $r$ be a ring. to check that $r$ is universally japanese it suffices to show: if $r \to s$ is of finite type, and $s$ a domain then $s$ is n-1. \end{lemma} \begin{proof} namely, assume the condition of the lemma. let $r \to s$ be a finite type ring map with $s$ a domain. let $l$ be a finite extension of the fraction field of $s$. then there exists a finite ring extension $s \subset s' \subset l$ such that $l$ is the fraction field of $s'$. by assumption $s'$ is n-1, and hence the integral closure $s''$ of $s'$ in $l$ is finite over $s'$. thus $s''$ is finite over $s$ (lemma \ref{lemma-finite-transitive}) and $s''$ is the integral closure of $s$ in $l$ (lemma \ref{lemma-integral-closure-transitive}). we conclude that $r$ is universally japanese. \end{proof} \begin{lemma} \label{lemma-universally-japanese} if $r$ is universally japanese then any algebra essentially of finite type over $r$ is universally japanese. \end{lemma} \begin{proof} the case of an algebra of finite type over $r$ is immediate from the definition. the general case follows on applying lemma \ref{lemma-localize-n}. \end{proof} \begin{lemma} \label{lemma-quasi-finite-over-nagata} let $r$ be a nagata ring. if $r \to s$ is a quasi-finite ring map (for example finite) then $s$ is a nagata ring also. \end{lemma} \begin{proof} first note that $s$ is noetherian as $r$ is noetherian and a quasi-finite ring map is of finite type. let $\mathfrak q \subset s$ be a prime ideal, and set $\mathfrak p = r \cap \mathfrak q$. then $r/\mathfrak p \subset s/\mathfrak q$ is quasi-finite and hence we conclude that $s/\mathfrak q$ is n-2 by lemma \ref{lemma-quasi-finite-over-noetherian-japanese} as desired. \end{proof} \begin{lemma} \label{lemma-nagata-localize} a localization of a nagata ring is a nagata ring. \end{lemma} \begin{proof} clear from lemma \ref{lemma-localize-n}. \end{proof} \begin{lemma} \label{lemma-nagata-local} let $r$ be a ring. let $f_1, \ldots, f_n \in r$ generate the unit ideal. \begin{enumerate} \item if each $r_{f_i}$ is universally japanese then so is $r$. \item if each $r_{f_i}$ is nagata then so is $r$. \end{enumerate} \end{lemma} \begin{proof} let $\varphi : r \to s$ be a finite type ring map so that $s$ is a domain. then $\varphi(f_1), \ldots, \varphi(f_n)$ generate the unit ideal in $s$. hence if each $s_{f_i} = s_{\varphi(f_i)}$ is n-1 then so is $s$, see lemma \ref{lemma-japanese-local}. this proves (1). \medskip\noindent if each $r_{f_i}$ is nagata, then each $r_{f_i}$ is noetherian and hence $r$ is noetherian, see lemma \ref{lemma-cover}. and if $\mathfrak p \subset r$ is a prime, then we see each $r_{f_i}/\mathfrak pr_{f_i} = (r/\mathfrak p)_{f_i}$ is n-2 and hence we conclude $r/\mathfrak p$ is n-2 by lemma \ref{lemma-japanese-local}. this proves (2). \end{proof} \begin{lemma} \label{lemma-noetherian-complete-local-nagata} a noetherian complete local ring is a nagata ring. \end{lemma} \begin{proof} let $r$ be a complete local noetherian ring. let $\mathfrak p \subset r$ be a prime. then $r/\mathfrak p$ is also a complete local noetherian ring, see lemma \ref{lemma-quotient-complete-local}. hence it suffices to show that a noetherian complete local domain $r$ is n-2. by lemmas \ref{lemma-quasi-finite-over-noetherian-japanese} and \ref{lemma-complete-local-noetherian-domain-finite-over-regular} we reduce to the case $r = k[[x_1, \ldots, x_d]]$ where $k$ is a field or $r = \lambda[[x_1, \ldots, x_d]]$ where $\lambda$ is a cohen ring. \medskip\noindent in the case $k[[x_1, \ldots, x_d]]$ we reduce to the statement that a field is n-2 by lemma \ref{lemma-power-series-over-n-2}. this is clear. in the case $\lambda[[x_1, \ldots, x_d]]$ we reduce to the statement that a cohen ring $\lambda$ is n-2. applying lemma \ref{lemma-tate-japanese} once more with $x = p \in \lambda$ we reduce yet again to the case of a field. thus we win. \end{proof} \begin{definition} \label{definition-analytically-unramified} let $(r, \mathfrak m)$ be a noetherian local ring. we say $r$ is {\it analytically unramified} if its completion $r^\wedge = \lim_n r/\mathfrak m^n$ is reduced. a prime ideal $\mathfrak p \subset r$ is said to be {\it analytically unramified} if $r/\mathfrak p$ is analytically unramified. \end{definition} \noindent at this point we know the following are true for any noetherian local ring $r$: the map $r \to r^\wedge$ is a faithfully flat local ring homomorphism (lemma \ref{lemma-completion-faithfully-flat}). the completion $r^\wedge$ is noetherian (lemma \ref{lemma-completion-noetherian}) and complete (lemma \ref{lemma-completion-complete}). hence the completion $r^\wedge$ is a nagata ring (lemma \ref{lemma-noetherian-complete-local-nagata}). moreover, we have seen in section \ref{section-cohen-structure-theorem} that $r^\wedge$ is a quotient of a regular local ring (theorem \ref{theorem-cohen-structure-theorem}), and hence universally catenary (remark \ref{remark-noetherian-complete-local-ring-universally-catenary}). \begin{lemma} \label{lemma-analytically-unramified-easy} let $(r, \mathfrak m)$ be a noetherian local ring. \begin{enumerate} \item if $r$ is analytically unramified, then $r$ is reduced. \item if $r$ is analytically unramified, then each minimal prime of $r$ is analytically unramified. \item if $r$ is reduced with minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$, and each $\mathfrak q_i$ is analytically unramified, then $r$ is analytically unramified. \item if $r$ is analytically unramified, then the integral closure of $r$ in its total ring of fractions $q(r)$ is finite over $r$. \item if $r$ is a domain and analytically unramified, then $r$ is n-1. \end{enumerate} \end{lemma} \begin{proof} in this proof we will use the remarks immediately following definition \ref{definition-analytically-unramified}. as $r \to r^\wedge$ is a faithfully flat local ring homomorphism it is injective and (1) follows. \medskip\noindent let $\mathfrak q$ be a minimal prime of $r$, and assume $r$ is analytically unramified. then $\mathfrak q$ is an associated prime of $r$ (see proposition \ref{proposition-minimal-primes-associated-primes}). hence there exists an $f \in r$ such that $\{x \in r \mid fx = 0\} = \mathfrak q$. note that $(r/\mathfrak q)^\wedge = r^\wedge/\mathfrak q^\wedge$, and that $\{x \in r^\wedge \mid fx = 0\} = \mathfrak q^\wedge$, because completion is exact (lemma \ref{lemma-completion-flat}). if $x \in r^\wedge$ is such that $x^2 \in \mathfrak q^\wedge$, then $fx^2 = 0$ hence $(fx)^2 = 0$ hence $fx = 0$ hence $x \in \mathfrak q^\wedge$. thus $\mathfrak q$ is analytically unramified and (2) holds. \medskip\noindent assume $r$ is reduced with minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$, and each $\mathfrak q_i$ is analytically unramified. then $r \to r/\mathfrak q_1 \times \ldots \times r/\mathfrak q_t$ is injective. since completion is exact (see lemma \ref{lemma-completion-flat}) we see that $r^\wedge \subset (r/\mathfrak q_1)^\wedge \times \ldots \times (r/\mathfrak q_t)^\wedge$. hence (3) is clear. \medskip\noindent assume $r$ is analytically unramified. let $\mathfrak p_1, \ldots, \mathfrak p_s$ be the minimal primes of $r^\wedge$. then we see that $$ q(r^\wedge) = r^\wedge_{\mathfrak p_1} \times \ldots \times r^\wedge_{\mathfrak p_s} $$ with each $r^\wedge_{\mathfrak p_i}$ a field as $r^\wedge$ is reduced (see lemma \ref{lemma-total-ring-fractions-no-embedded-points}). hence the integral closure $s$ of $r^\wedge$ in $q(r^\wedge)$ is equal to $s = s_1 \times \ldots \times s_s$ with $s_i$ the integral closure of $r^\wedge/\mathfrak p_i$ in its fraction field. by lemma \ref{lemma-noetherian-complete-local-nagata} the ring $s_i$ is finite over $r^\wedge/\mathfrak p_i$. thus $s$ is finite over $r^\wedge$. denote $r'$ the integral closure of $r$ in $q(r)$. as $r \to r^\wedge$ is flat we see that $r' \otimes_r r^\wedge \subset q(r) \otimes_r r^\wedge \subset q(r^\wedge)$. moreover $r' \otimes_r r^\wedge$ is integral over $r^\wedge$ (lemma \ref{lemma-base-change-integral}). hence $r' \otimes_r r^\wedge \subset s$ is a $r^\wedge$-submodule. as $r^\wedge$ is noetherian it is a finite $r^\wedge$-module. thus we may find $f_1, \ldots, f_n \in r'$ such that $r' \otimes_r r^\wedge$ is generated by the elements $f_i \otimes 1$ as a $r^\wedge$-module. by faithful flatness we see that $r'$ is generated by $f_1, \ldots, f_n$ as an $r$-module. this proves (4). \medskip\noindent part (5) is a special case of part (4). \end{proof} \begin{lemma} \label{lemma-codimension-1-analytically-unramified} let $r$ be a noetherian local ring. let $\mathfrak p \subset r$ be a prime. assume \begin{enumerate} \item $r_{\mathfrak p}$ is a discrete valuation ring, and \item $\mathfrak p$ is analytically unramified. \end{enumerate} then for any associated prime $\mathfrak q$ of $r^\wedge/\mathfrak pr^\wedge$ the local ring $(r^\wedge)_{\mathfrak q}$ is a discrete valuation ring. \end{lemma} \begin{proof} assumption (2) says that $r^\wedge/\mathfrak pr^\wedge$ is a reduced ring. hence an associated prime $\mathfrak q \subset r^\wedge$ of $r^\wedge/\mathfrak pr^\wedge$ is the same thing as a minimal prime over $\mathfrak pr^\wedge$. in particular we see that the maximal ideal of $(r^\wedge)_{\mathfrak q}$ is $\mathfrak p(r^\wedge)_{\mathfrak q}$. choose $x \in r$ such that $xr_{\mathfrak p} = \mathfrak pr_{\mathfrak p}$. by the above we see that $x \in (r^\wedge)_{\mathfrak q}$ generates the maximal ideal. as $r \to r^\wedge$ is faithfully flat we see that $x$ is a nonzerodivisor in $(r^\wedge)_{\mathfrak q}$. hence we win. \end{proof} \begin{lemma} \label{lemma-criterion-analytically-unramified} let $(r, \mathfrak m)$ be a noetherian local domain. let $x \in \mathfrak m$. assume \begin{enumerate} \item $x \not = 0$, \item $r/xr$ has no embedded primes, and \item for each associated prime $\mathfrak p \subset r$ of $r/xr$ we have \begin{enumerate} \item the local ring $r_{\mathfrak p}$ is regular, and \item $\mathfrak p$ is analytically unramified. \end{enumerate} \end{enumerate} then $r$ is analytically unramified. \end{lemma} \begin{proof} let $\mathfrak p_1, \ldots, \mathfrak p_t$ be the associated primes of the $r$-module $r/xr$. since $r/xr$ has no embedded primes we see that each $\mathfrak p_i$ has height $1$, and is a minimal prime over $(x)$. for each $i$, let $\mathfrak q_{i1}, \ldots, \mathfrak q_{is_i}$ be the associated primes of the $r^\wedge$-module $r^\wedge/\mathfrak p_ir^\wedge$. by lemma \ref{lemma-codimension-1-analytically-unramified} we see that $(r^\wedge)_{\mathfrak q_{ij}}$ is regular. by lemma \ref{lemma-bourbaki} we see that $$ \text{ass}_{r^\wedge}(r^\wedge/xr^\wedge) = \bigcup\nolimits_{\mathfrak p \in \text{ass}_r(r/xr)} \text{ass}_{r^\wedge}(r^\wedge/\mathfrak pr^\wedge) = \{\mathfrak q_{ij}\}. $$ let $y \in r^\wedge$ with $y^2 = 0$. as $(r^\wedge)_{\mathfrak q_{ij}}$ is regular, and hence a domain (lemma \ref{lemma-regular-domain}) we see that $y$ maps to zero in $(r^\wedge)_{\mathfrak q_{ij}}$. hence $y$ maps to zero in $r^\wedge/xr^\wedge$ by lemma \ref{lemma-zero-at-ass-zero}. hence $y = xy'$. since $x$ is a nonzerodivisor (as $r \to r^\wedge$ is flat) we see that $(y')^2 = 0$. hence we conclude that $y \in \bigcap x^nr^\wedge = (0)$ (lemma \ref{lemma-intersect-powers-ideal-module-zero}). \end{proof} \begin{lemma} \label{lemma-local-nagata-domain-analytically-unramified} let $(r, \mathfrak m)$ be a local ring. if $r$ is noetherian, a domain, and nagata, then $r$ is analytically unramified. \end{lemma} \begin{proof} by induction on $\dim(r)$. the case $\dim(r) = 0$ is trivial. hence we assume $\dim(r) = d$ and that the lemma holds for all noetherian nagata domains of dimension $< d$. \medskip\noindent let $r \subset s$ be the integral closure of $r$ in the field of fractions of $r$. by assumption $s$ is a finite $r$-module. by lemma \ref{lemma-quasi-finite-over-nagata} we see that $s$ is nagata. by lemma \ref{lemma-integral-sub-dim-equal} we see $\dim(r) = \dim(s)$. let $\mathfrak m_1, \ldots, \mathfrak m_t$ be the maximal ideals of $s$. each of these lies over the maximal ideal $\mathfrak m$ of $r$. moreover $$ (\mathfrak m_1 \cap \ldots \cap \mathfrak m_t)^n \subset \mathfrak ms $$ for sufficiently large $n$ as $s/\mathfrak ms$ is artinian. by lemma \ref{lemma-completion-flat} $r^\wedge \to s^\wedge$ is an injective map, and by the chinese remainder lemma \ref{lemma-chinese-remainder} combined with lemma \ref{lemma-change-ideal-completion} we have $s^\wedge = \prod s^\wedge_i$ where $s^\wedge_i$ is the completion of $s$ with respect to the maximal ideal $\mathfrak m_i$. hence it suffices to show that $s_{\mathfrak m_i}$ is analytically unramified. in other words, we have reduced to the case where $r$ is a noetherian normal nagata domain. \medskip\noindent assume $r$ is a noetherian, normal, local nagata domain. pick a nonzero $x \in \mathfrak m$ in the maximal ideal. we are going to apply lemma \ref{lemma-criterion-analytically-unramified}. we have to check properties (1), (2), (3)(a) and (3)(b). property (1) is clear. we have that $r/xr$ has no embedded primes by lemma \ref{lemma-normal-domain-intersection-localizations-height-1}. thus property (2) holds. the same lemma also tells us each associated prime $\mathfrak p$ of $r/xr$ has height $1$. hence $r_{\mathfrak p}$ is a $1$-dimensional normal domain hence regular (lemma \ref{lemma-characterize-dvr}). thus (3)(a) holds. finally (3)(b) holds by induction hypothesis, since $r/\mathfrak p$ is nagata (by lemma \ref{lemma-quasi-finite-over-nagata} or directly from the definition). thus we conclude $r$ is analytically unramified. \end{proof} \begin{lemma} \label{lemma-local-nagata-and-analytically-unramified} let $(r, \mathfrak m)$ be a noetherian local ring. the following are equivalent \begin{enumerate} \item $r$ is nagata, \item for $r \to s$ finite with $s$ a domain and $\mathfrak m' \subset s$ maximal the local ring $s_{\mathfrak m'}$ is analytically unramified, \item for $(r, \mathfrak m) \to (s, \mathfrak m')$ finite local homomorphism with $s$ a domain, then $s$ is analytically unramified. \end{enumerate} \end{lemma} \begin{proof} assume $r$ is nagata and let $r \to s$ and $\mathfrak m' \subset s$ be as in (2). then $s$ is nagata by lemma \ref{lemma-quasi-finite-over-nagata}. hence the local ring $s_{\mathfrak m'}$ is nagata (lemma \ref{lemma-nagata-localize}). thus it is analytically unramified by lemma \ref{lemma-local-nagata-domain-analytically-unramified}. it is clear that (2) implies (3). \medskip\noindent assume (3) holds. let $\mathfrak p \subset r$ be a prime ideal and let $l/\kappa(\mathfrak p)$ be a finite extension of fields. to prove (1) we have to show that the integral closure of $r/\mathfrak p$ is finite over $r/\mathfrak p$. choose $x_1, \ldots, x_n \in l$ which generate $l$ over $\kappa(\mathfrak p)$. for each $i$ let $p_i(t) = t^{d_i} + a_{i, 1} t^{d_i - 1} + \ldots + a_{i, d_i}$ be the minimal polynomial for $x_i$ over $\kappa(\mathfrak p)$. after replacing $x_i$ by $f_i x_i$ for a suitable $f_i \in r$, $f_i \not \in \mathfrak p$ we may assume $a_{i, j} \in r/\mathfrak p$. in fact, after further multiplying by elements of $\mathfrak m$, we may assume $a_{i, j} \in \mathfrak m/\mathfrak p \subset r/\mathfrak p$ for all $i, j$. having done this let $s = r/\mathfrak p[x_1, \ldots, x_n] \subset l$. then $s$ is finite over $r$, a domain, and $s/\mathfrak m s$ is a quotient of $r/\mathfrak m[t_1, \ldots, t_n]/(t_1^{d_1}, \ldots, t_n^{d_n})$. hence $s$ is local. by (3) $s$ is analytically unramified and by lemma \ref{lemma-analytically-unramified-easy} we find that its integral closure $s'$ in $l$ is finite over $s$. since $s'$ is also the integral closure of $r/\mathfrak p$ in $l$ we win. \end{proof} \noindent the following proposition says in particular that an algebra of finite type over a nagata ring is a nagata ring. \begin{proposition}[nagata] \label{proposition-nagata-universally-japanese} let $r$ be a ring. the following are equivalent: \begin{enumerate} \item $r$ is a nagata ring, \item any finite type $r$-algebra is nagata, and \item $r$ is universally japanese and noetherian. \end{enumerate} \end{proposition} \begin{proof} it is clear that a noetherian universally japanese ring is universally nagata (i.e., condition (2) holds). let $r$ be a nagata ring. we will show that any finitely generated $r$-algebra $s$ is nagata. this will prove the proposition. \medskip\noindent step 1. there exists a sequence of ring maps $r = r_0 \to r_1 \to r_2 \to \ldots \to r_n = s$ such that each $r_i \to r_{i + 1}$ is generated by a single element. hence by induction it suffices to prove $s$ is nagata if $s \cong r[x]/i$. \medskip\noindent step 2. let $\mathfrak q \subset s$ be a prime of $s$, and let $\mathfrak p \subset r$ be the corresponding prime of $r$. we have to show that $s/\mathfrak q$ is n-2. hence we have reduced to proving the following: (*) given a nagata domain $r$ and a monogenic extension $r \subset s$ of domains then $s$ is n-2. \medskip\noindent step 3: let $r$ be a nagata domain and let $r \subset s$ be a monogenic extension of domains. suppose the induced extension of fraction fields of $r$ and $s$ is purely transcendental. in this case $s = r[x]$. by lemma \ref{lemma-polynomial-ring-n-2} we see that $s$ is n-2. hence we have reduced to proving the following: (**) given a nagata domain $r$ and a monogenic extension $r \subset s$ of domains inducing a finite extension of fraction fields then $s$ is n-2. \medskip\noindent step 4. let $r$ be a normal nagata domain and let $r \subset s$ be a monogenic extension of domains inducing a finite extension of fraction fields $l/k$. choose an element $x \in s$ which generates $s$ as an $r$-algebra. let $m/l$ be a finite extension of fields. let $r'$ be the integral closure of $r$ in $m$. then the integral closure $s'$ of $s$ in $m$ is equal to the integral closure of $r'[x]$ in $m$. also the fraction field of $r'$ is $m$ and $r \subset r'$ is finite (by the nagata property of $r$). this implies that $r'$ is a nagata ring (lemma \ref{lemma-quasi-finite-over-nagata}). to show that $s'$ is finite over $s$ is the same as showing that $s'$ is finite over $r'[x]$. replace $r$ by $r'$ and $s$ by $r'[x]$ to reduce to the following statement: (***) given a normal nagata domain $r$ with fraction field $k$, and $x \in k$, the ring $s \subset k$ generated by $r$ and $x$ is n-1. \medskip\noindent step 5. let $r$ be a normal nagata domain with fraction field $k$. let $x = b/a \in k$. we have to show that the ring $s \subset k$ generated by $r$ and $x$ is n-1. note that $s_a \cong r_a$ is normal. hence by lemma \ref{lemma-characterize-n-1} it suffices to show that $s_{\mathfrak m}$ is n-1 for every maximal ideal $\mathfrak m$ of $s$. \medskip\noindent with assumptions as in the preceding paragraph, pick such a maximal ideal and set $\mathfrak n = r \cap \mathfrak m$. the residue field extension $\kappa(\mathfrak m)/\kappa(\mathfrak n)$ is finite (theorem \ref{theorem-nullstellensatz}) and generated by the image of $x$. after replacing $r$ by $r_a$ for some $a \in r$, $a \not \in \mathfrak n$ and $s$ by $s_a$, may assume there exists a monic polynomial $f(x) = x^d + \sum_{i = 1, \ldots, d} a_ix^{d - i}$ in $r[x]$ with $f(x) \in \mathfrak m$ (details omitted). let $k''/k$ be a finite extension of fields such that the polynomial $f(x)$ splits completely in $k''[x]$. let $r'$ be the integral closure of $r$ in $k''$. let $s' \subset k''$ be the subring generated by $r'$ and $x$. as $r$ is nagata we see $r'$ is finite over $r$ and nagata (lemma \ref{lemma-quasi-finite-over-nagata}). moreover, $s'$ is finite over $s$. if for every maximal ideal $\mathfrak m'$ of $s'$ the local ring $s'_{\mathfrak m'}$ is n-1, then $s'_{\mathfrak m}$ is n-1 by lemma \ref{lemma-characterize-n-1}, which in turn implies that $s_{\mathfrak m}$ is n-1 by lemma \ref{lemma-finite-extension-n-2}. after replacing $r$ by $r'$ and $s$ by $s'$, and $\mathfrak m$ by any of the maximal ideals $\mathfrak m'$ lying over $\mathfrak m$ we reach the situation where the polynomial $f$ above split completely: $f(x) = \prod_{i = 1, \ldots, d} (x - a_i)$ with $a_i \in r$. since $f(x) \in \mathfrak m$ we see that $x - a_i \in \mathfrak m$ for some $i$. finally, after replacing $x$ by $x - a_i$ we may assume that $x \in \mathfrak m$. \medskip\noindent to recapitulate: $r$ is a normal nagata domain with fraction field $k$, $x \in k$ and $s$ is the subring of $k$ generated by $x$ and $r$, finally $\mathfrak m \subset s$ is a maximal ideal with $x \in \mathfrak m$. we have to show $s_{\mathfrak m}$ is n-1. \medskip\noindent we will show that lemma \ref{lemma-criterion-analytically-unramified} applies to the local ring $s_{\mathfrak m}$ and the element $x$. this will imply that $s_{\mathfrak m}$ is analytically unramified, whereupon we see that it is n-1 by lemma \ref{lemma-analytically-unramified-easy}. \medskip\noindent we have to check properties (1), (2), (3)(a) and (3)(b). property (1) is trivial. let $i = \ker(r[x] \to s)$ where $x \mapsto x$. we claim that $i$ is generated by all linear forms $ax - b$ such that $ax = b$ in $k$. clearly all these linear forms are in $i$. if $g = a_d x^d + \ldots a_1 x + a_0 \in i$, then we see that $a_dx$ is integral over $r$ (lemma \ref{lemma-make-integral-trivial}) and hence $b := a_dx \in r$ as $r$ is normal. then $g - (a_dx - b)x^{d - 1} \in i$ and we win by induction on the degree. as a consequence we see that $$ s/xs = r[x]/(x, i) = r/j $$ where $$ j = \{b \in r \mid ax = b \text{ for some }a \in r\} = xr \cap r $$ by lemma \ref{lemma-normal-domain-intersection-localizations-height-1} we see that $s/xs = r/j$ has no embedded primes as an $r$-module, hence as an $r/j$-module, hence as an $s/xs$-module, hence as an $s$-module. this proves property (2). take such an associated prime $\mathfrak q \subset s$ with the property $\mathfrak q \subset \mathfrak m$ (so that it is an associated prime of $s_{\mathfrak m}/xs_{\mathfrak m}$ -- it does not matter for the arguments). then $\mathfrak q$ is minimal over $xs$ and hence has height $1$. by the sequence of equalities above we see that $\mathfrak p = r \cap \mathfrak q$ is an associated prime of $r/j$, and so has height $1$ (see lemma \ref{lemma-normal-domain-intersection-localizations-height-1}). thus $r_{\mathfrak p}$ is a discrete valuation ring and therefore $r_{\mathfrak p} \subset s_{\mathfrak q}$ is an equality. this shows that $s_{\mathfrak q}$ is regular. this proves property (3)(a). finally, $(s/\mathfrak q)_{\mathfrak m}$ is a localization of $s/\mathfrak q$, which is a quotient of $s/xs = r/j$. hence $(s/\mathfrak q)_{\mathfrak m}$ is a localization of a quotient of the nagata ring $r$, hence nagata (lemmas \ref{lemma-quasi-finite-over-nagata} and \ref{lemma-nagata-localize}) and hence analytically unramified (lemma \ref{lemma-local-nagata-domain-analytically-unramified}). this shows (3)(b) holds and we are done. \end{proof} \begin{proposition} \label{proposition-ubiquity-nagata} the following types of rings are nagata and in particular universally japanese: \begin{enumerate} \item fields, \item noetherian complete local rings, \item $\mathbf{z}$, \item dedekind domains with fraction field of characteristic zero, \item finite type ring extensions of any of the above. \end{enumerate} \end{proposition} \begin{proof} the noetherian complete local ring case is lemma \ref{lemma-noetherian-complete-local-nagata}. in the other cases you just check if $r/\mathfrak p$ is n-2 for every prime ideal $\mathfrak p$ of the ring. this is clear whenever $r/\mathfrak p$ is a field, i.e., $\mathfrak p$ is maximal. hence for the dedekind ring case we only need to check it when $\mathfrak p = (0)$. but since we assume the fraction field has characteristic zero lemma \ref{lemma-domain-char-zero-n-1-2} kicks in. \end{proof} \begin{example} \label{example-nonjapanese-dvr} a discrete valuation ring is nagata if and only if it is n-2 (because the quotient by the maximal ideal is a field and hence n-2). the discrete valuation ring $a$ of example \ref{example-bad-dvr-char-p} is not nagata, i.e., it is not n-2. namely, the finite extension $a \subset r = a[f]$ is not n-1. to see this say $f = \sum a_i x^i$. for every $n \geq 1$ set $g_n = \sum_{i < n} a_i x^i \in a$. then $h_n = (f - g_n)/x^n$ is an element of the fraction field of $r$ and $h_n^p \in k^p[[x]] \subset a$. hence the integral closure $r'$ of $r$ contains $h_1, h_2, h_3, \ldots$. now, if $r'$ were finite over $r$ and hence $a$, then $f = x^n h_n + g_n$ would be contained in the submodule $a + x^nr'$ for all $n$. by artin-rees this would imply $f \in a$ (lemma \ref{lemma-intersect-powers-ideal-module-zero}), a contradiction. \end{example} \begin{lemma} \label{lemma-nagata-pth-roots} let $(a, \mathfrak m)$ be a noetherian local domain which is nagata and has fraction field of characteristic $p$. if $a \in a$ has a $p$th root in $a^\wedge$, then $a$ has a $p$th root in $a$. \end{lemma} \begin{proof} let $\alpha \in a^\wedge$ be a $p$th root of $a$. to get a contradiction, assume $a$ does not have a $p$th root in $a$. then $a$ does not have a $p$th root in the fraction field $k$ of $a$. namely, if $\beta = b/c$ with $b, c \in a$ and $c \not = 0$ satisfies $\beta^p = a$, then $\alpha = b/c$ in $a^\wedge$ which implies that $c$ divides $b$ in $a$ by faithful flatness of $a \to a^\wedge$ and hence $\beta \in a$, contradiction. thus $b = a[x]/(x^p - a)$ is a domain because $k[x]/(x^p - a)$ is a field. however, the completion of $b$ isn't reduced by the assumed existence of $\alpha$. this contradicts our earlier results, as $b$ is a nagata ring (proposition \ref{proposition-nagata-universally-japanese}) and hence analytically unramified by lemma \ref{lemma-local-nagata-domain-analytically-unramified}. \end{proof} \section{ascending properties} \label{section-ascending-properties} \noindent in this section we start proving some algebraic facts concerning the ``ascent'' of properties of rings. to do this for depth of rings one uses the following result on ascending depth of modules, see \cite[iv, proposition 6.3.1]{ega}. \begin{lemma} \label{lemma-apply-grothendieck-module} \begin{reference} \cite[iv, proposition 6.3.1]{ega} \end{reference} we have $$ \text{depth}(m \otimes_r n) = \text{depth}(m) + \text{depth}(n/\mathfrak m_rn) $$ where $r \to s$ is a local homomorphism of local noetherian rings, $m$ is a finite $r$-module, and $n$ is a finite $s$-module flat over $r$. \end{lemma} \begin{proof} in the statement and in the proof below, we take the depth of $m$ as an $r$-module, the depth of $m \otimes_r n$ as an $s$-module, and the depth of $n/\mathfrak m_rn$ as an $s/\mathfrak m_rs$-module. denote $n$ the right hand side. first assume that $n$ is zero. then both $\text{depth}(m) = 0$ and $\text{depth}(n/\mathfrak m_rn) = 0$. this means there is a $z \in m$ whose annihilator is $\mathfrak m_r$ and a $\overline{y} \in n/\mathfrak m_rn$ whose annihilator is $\mathfrak m_s/\mathfrak m_rs$. let $y \in n$ be a lift of $\overline{y}$. since $n$ is flat over $r$ the map $z : r/\mathfrak m_r \to m$ produces an injective map $n/\mathfrak m_rn \to m \otimes_r n$. hence the annihilator of $z \otimes y$ is $\mathfrak m_s$. thus $\text{depth}(m \otimes_r n) = 0$ as well. \medskip\noindent assume $n > 0$. if $\text{depth}(n/\mathfrak m_rn) > 0$, then we may choose $f \in \mathfrak m_s$ mapping to $\overline{f} \in s/\mathfrak m_rs$ which is a nonzerodivisor on $n/\mathfrak m_rn$. then $\text{depth}(n/\mathfrak m_rn) = \text{depth}(n/(f, \mathfrak m_r)n) + 1$ by lemma \ref{lemma-depth-drops-by-one}. according to lemma \ref{lemma-mod-injective} the element $f \in s$ is a nonzerodivisor on $n$ and $n/fn$ is flat over $r$. hence by induction on $n$ we have $$ \text{depth}(m \otimes_r n/fn) = \text{depth}(m) + \text{depth}(n/(f, \mathfrak m_r)n). $$ because $n/fn$ is flat over $r$ the sequence $$ 0 \to m \otimes_r n \to m \otimes_r n \to m \otimes_r n/fn \to 0 $$ is exact where the first map is multiplication by $f$ (lemma \ref{lemma-flat-tor-zero}). hence by lemma \ref{lemma-depth-drops-by-one} we find that $\text{depth}(m \otimes_r n) = \text{depth}(m \otimes_r n/fn) + 1$ and we conclude that equality holds in the formula of the lemma. \medskip\noindent if $n > 0$, but $\text{depth}(n/\mathfrak m_rn) = 0$, then we can choose $f \in \mathfrak m_r$ which is a nonzerodivisor on $m$. as $n$ is flat over $r$ it is also the case that $f$ is a nonzerodivisor on $m \otimes_r n$. by induction on $n$ again we have $$ \text{depth}(m/fm \otimes_r n) = \text{depth}(m/fm) + \text{depth}(n/\mathfrak m_rn). $$ in this case $\text{depth}(m \otimes_r n) = \text{depth}(m/fm \otimes_r n) + 1$ and $\text{depth}(m) = \text{depth}(m/fm) + 1$ by lemma \ref{lemma-depth-drops-by-one} and we conclude that equality holds in the formula of the lemma. \end{proof} \begin{lemma} \label{lemma-apply-grothendieck} suppose that $r \to s$ is a flat and local ring homomorphism of noetherian local rings. then $$ \text{depth}(s) = \text{depth}(r) + \text{depth}(s/\mathfrak m_rs). $$ \end{lemma} \begin{proof} this is a special case of lemma \ref{lemma-apply-grothendieck-module}. \end{proof} \begin{lemma} \label{lemma-cm-goes-up} let $r \to s$ be a flat local homomorphism of local noetherian rings. then the following are equivalent \begin{enumerate} \item $s$ is cohen-macaulay, and \item $r$ and $s/\mathfrak m_rs$ are cohen-macaulay. \end{enumerate} \end{lemma} \begin{proof} follows from the definitions and lemmas \ref{lemma-apply-grothendieck} and \ref{lemma-dimension-base-fibre-equals-total}. \end{proof} \begin{lemma} \label{lemma-sk-goes-up} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $r$ is noetherian, \item $s$ is noetherian, \item $\varphi$ is flat, \item the fibre rings $s \otimes_r \kappa(\mathfrak p)$ are $(s_k)$, and \item $r$ has property $(s_k)$. \end{enumerate} then $s$ has property $(s_k)$. \end{lemma} \begin{proof} let $\mathfrak q$ be a prime of $s$ lying over a prime $\mathfrak p$ of $r$. by lemma \ref{lemma-apply-grothendieck} we have $$ \text{depth}(s_{\mathfrak q}) = \text{depth}(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) + \text{depth}(r_{\mathfrak p}). $$ on the other hand, we have $$ \dim(r_{\mathfrak p}) + \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) \geq \dim(s_{\mathfrak q}) $$ by lemma \ref{lemma-dimension-base-fibre-total}. (actually equality holds, by lemma \ref{lemma-dimension-base-fibre-equals-total} but strictly speaking we do not need this.) finally, as the fibre rings of the map are assumed $(s_k)$ we see that $\text{depth}(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) \geq \min(k, \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}))$. thus the lemma follows by the following string of inequalities \begin{eqnarray*} \text{depth}(s_{\mathfrak q}) & = & \text{depth}(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) + \text{depth}(r_{\mathfrak p}) \\ & \geq & \min(k, \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q})) + \min(k, \dim(r_{\mathfrak p})) \\ & = & \min(2k, \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) + k, k + \dim(r_\mathfrak p), \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) + \dim(r_{\mathfrak p})) \\ & \geq & \min(k, \dim(s_{\mathfrak q})) \end{eqnarray*} as desired. \end{proof} \begin{lemma} \label{lemma-rk-goes-up} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $r$ is noetherian, \item $s$ is noetherian \item $\varphi$ is flat, \item the fibre rings $s \otimes_r \kappa(\mathfrak p)$ have property $(r_k)$, and \item $r$ has property $(r_k)$. \end{enumerate} then $s$ has property $(r_k)$. \end{lemma} \begin{proof} let $\mathfrak q$ be a prime of $s$ lying over a prime $\mathfrak p$ of $r$. assume that $\dim(s_{\mathfrak q}) \leq k$. since $\dim(s_{\mathfrak q}) = \dim(r_{\mathfrak p}) + \dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q})$ by lemma \ref{lemma-dimension-base-fibre-equals-total} we see that $\dim(r_{\mathfrak p}) \leq k$ and $\dim(s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}) \leq k$. hence $r_{\mathfrak p}$ and $s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ are regular by assumption. it follows that $s_{\mathfrak q}$ is regular by lemma \ref{lemma-flat-over-regular-with-regular-fibre}. \end{proof} \begin{lemma} \label{lemma-reduced-goes-up-noetherian} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $r$ is noetherian, \item $s$ is noetherian \item $\varphi$ is flat, \item the fibre rings $s \otimes_r \kappa(\mathfrak p)$ are reduced, \item $r$ is reduced. \end{enumerate} then $s$ is reduced. \end{lemma} \begin{proof} for noetherian rings reduced is the same as having properties $(s_1)$ and $(r_0)$, see lemma \ref{lemma-criterion-reduced}. thus we know $r$ and the fibre rings have these properties. hence we may apply lemmas \ref{lemma-sk-goes-up} and \ref{lemma-rk-goes-up} and we see that $s$ is $(s_1)$ and $(r_0)$, in other words reduced by lemma \ref{lemma-criterion-reduced} again. \end{proof} \begin{lemma} \label{lemma-reduced-goes-up} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $\varphi$ is smooth, \item $r$ is reduced. \end{enumerate} then $s$ is reduced. \end{lemma} \begin{proof} observe that $r \to s$ is flat with regular fibres (see the list of results on smooth ring maps in section \ref{section-smooth-overview}). in particular, the fibres are reduced. thus if $r$ is noetherian, then $s$ is noetherian and we get the result from lemma \ref{lemma-reduced-goes-up-noetherian}. \medskip\noindent in the general case we may find a finitely generated $\mathbf{z}$-subalgebra $r_0 \subset r$ and a smooth ring map $r_0 \to s_0$ such that $s \cong r \otimes_{r_0} s_0$, see remark (10) in section \ref{section-smooth-overview}. now, if $x \in s$ is an element with $x^2 = 0$, then we can enlarge $r_0$ and assume that $x$ comes from an element $x_0 \in s_0$. after enlarging $r_0$ once more we may assume that $x_0^2 = 0$ in $s_0$. however, since $r_0 \subset r$ is reduced we see that $s_0$ is reduced and hence $x_0 = 0$ as desired. \end{proof} \begin{lemma} \label{lemma-normal-goes-up-noetherian} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $r$ is noetherian, \item $s$ is noetherian, \item $\varphi$ is flat, \item the fibre rings $s \otimes_r \kappa(\mathfrak p)$ are normal, and \item $r$ is normal. \end{enumerate} then $s$ is normal. \end{lemma} \begin{proof} for a noetherian ring being normal is the same as having properties $(s_2)$ and $(r_1)$, see lemma \ref{lemma-criterion-normal}. thus we know $r$ and the fibre rings have these properties. hence we may apply lemmas \ref{lemma-sk-goes-up} and \ref{lemma-rk-goes-up} and we see that $s$ is $(s_2)$ and $(r_1)$, in other words normal by lemma \ref{lemma-criterion-normal} again. \end{proof} \begin{lemma} \label{lemma-normal-goes-up} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $\varphi$ is smooth, \item $r$ is normal. \end{enumerate} then $s$ is normal. \end{lemma} \begin{proof} observe that $r \to s$ is flat with regular fibres (see the list of results on smooth ring maps in section \ref{section-smooth-overview}). in particular, the fibres are normal. thus if $r$ is noetherian, then $s$ is noetherian and we get the result from lemma \ref{lemma-normal-goes-up-noetherian}. \medskip\noindent the general case. first note that $r$ is reduced and hence $s$ is reduced by lemma \ref{lemma-reduced-goes-up}. let $\mathfrak q$ be a prime of $s$ and let $\mathfrak p$ be the corresponding prime of $r$. note that $r_{\mathfrak p}$ is a normal domain. we have to show that $s_{\mathfrak q}$ is a normal domain. to do this we may replace $r$ by $r_{\mathfrak p}$ and $s$ by $s_{\mathfrak p}$. hence we may assume that $r$ is a normal domain. \medskip\noindent assume $r \to s$ smooth, and $r$ a normal domain. we may find a finitely generated $\mathbf{z}$-subalgebra $r_0 \subset r$ and a smooth ring map $r_0 \to s_0$ such that $s \cong r \otimes_{r_0} s_0$, see remark (10) in section \ref{section-smooth-overview}. as $r_0$ is a nagata domain (see proposition \ref{proposition-ubiquity-nagata}) we see that its integral closure $r_0'$ is finite over $r_0$. moreover, as $r$ is a normal domain it is clear that $r_0' \subset r$. hence we may replace $r_0$ by $r_0'$ and $s_0$ by $r_0' \otimes_{r_0} s_0$ and assume that $r_0$ is a normal noetherian domain. by the first paragraph of the proof we conclude that $s_0$ is a normal ring (it need not be a domain of course). in this way we see that $r = \bigcup r_\lambda$ is the union of normal noetherian domains and correspondingly $s = \colim r_\lambda \otimes_{r_0} s_0$ is the colimit of normal rings. this implies that $s$ is a normal ring. some details omitted. \end{proof} \begin{lemma} \label{lemma-regular-goes-up} \begin{slogan} regularity ascends along smooth maps of rings. \end{slogan} let $\varphi : r \to s$ be a ring map. assume \begin{enumerate} \item $\varphi$ is smooth, \item $r$ is a regular ring. \end{enumerate} then $s$ is regular. \end{lemma} \begin{proof} this follows from lemma \ref{lemma-rk-goes-up} applied for all $(r_k)$ using lemma \ref{lemma-characterize-smooth-over-field} to see that the hypotheses are satisfied. \end{proof} \section{descending properties} \label{section-descending-properties} \noindent in this section we start proving some algebraic facts concerning the ``descent'' of properties of rings. it turns out that it is often ``easier'' to descend properties than it is to ascend them. in other words, the assumption on the ring map $r \to s$ are often weaker than the assumptions in the corresponding lemma of the preceding section. however, we warn the reader that the results on descent are often useless unless the corresponding ascent can also be shown! here is a typical result which illustrates this phenomenon. \begin{lemma} \label{lemma-descent-noetherian} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is faithfully flat, and \item $s$ is noetherian. \end{enumerate} then $r$ is noetherian. \end{lemma} \begin{proof} let $i_0 \subset i_1 \subset i_2 \subset \ldots$ be a growing sequence of ideals of $r$. by assumption we have $i_ns = i_{n+1}s = i_{n+2}s = \ldots$ for some $n$. by faithful flatness, extending and contracting gives the same ideal, meaning that $i = r \cap is$ for each ideal $i$ in $r$ (lemma \ref{lemma-faithfully-flat-universally-injective}). so $i_n = i_{n+1} = i_{n+2} = \ldots$ as desired. \end{proof} \begin{lemma} \label{lemma-descent-reduced} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is faithfully flat, and \item $s$ is reduced. \end{enumerate} then $r$ is reduced. \end{lemma} \begin{proof} this is clear as $r \to s$ is injective, by lemma \ref{lemma-faithfully-flat-universally-injective}. \end{proof} \begin{lemma} \label{lemma-descent-normal} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is faithfully flat, and \item $s$ is a normal ring. \end{enumerate} then $r$ is a normal ring. \end{lemma} \begin{proof} since $s$ is reduced it follows that $r$ is reduced. let $\mathfrak p$ be a prime of $r$. we have to show that $r_{\mathfrak p}$ is a normal domain. since $s_{\mathfrak p}$ is faithfully over $r_{\mathfrak p}$ too we may assume that $r$ is local with maximal ideal $\mathfrak m$. let $\mathfrak q$ be a prime of $s$ lying over $\mathfrak m$. then we see that $r \to s_{\mathfrak q}$ is faithfully flat (lemma \ref{lemma-local-flat-ff}). hence we may assume $s$ is local as well. in particular $s$ is a normal domain. since $r \to s$ is faithfully flat and $s$ is a normal domain we see that $r$ is a domain. next, suppose that $a/b$ is integral over $r$ with $a, b \in r$. then $a/b \in s$ as $s$ is normal. hence $a \in bs$. this means that $a : r \to r/br$ becomes the zero map after base change to $s$. by faithful flatness we see that $a \in br$, so $a/b \in r$. hence $r$ is normal. \end{proof} \begin{lemma} \label{lemma-descent-regular} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is faithfully flat, and \item $s$ is a regular ring. \end{enumerate} then $r$ is a regular ring. \end{lemma} \begin{proof} we see that $r$ is noetherian by lemma \ref{lemma-descent-noetherian}. let $\mathfrak p \subset r$ be a prime. choose a prime $\mathfrak q \subset s$ lying over $\mathfrak p$. then lemma \ref{lemma-flat-under-regular} applies to $r_\mathfrak p \to s_\mathfrak q$ and we conclude that $r_\mathfrak p$ is regular. since $\mathfrak p$ was arbitrary we see $r$ is regular. \end{proof} \begin{lemma} \label{lemma-descent-sk} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is faithfully flat, and \item $s$ is noetherian and has property $(s_k)$. \end{enumerate} then $r$ is noetherian and has property $(s_k)$. \end{lemma} \begin{proof} we have already seen that (1) and (2) imply that $r$ is noetherian, see lemma \ref{lemma-descent-noetherian}. let $\mathfrak p \subset r$ be a prime ideal. choose a prime $\mathfrak q \subset s$ lying over $\mathfrak p$ which corresponds to a minimal prime of the fibre ring $s \otimes_r \kappa(\mathfrak p)$. then $a = r_{\mathfrak p} \to s_{\mathfrak q} = b$ is a flat local ring homomorphism of noetherian local rings with $\mathfrak m_ab$ an ideal of definition of $b$. hence $\dim(a) = \dim(b)$ (lemma \ref{lemma-dimension-base-fibre-equals-total}) and $\text{depth}(a) = \text{depth}(b)$ (lemma \ref{lemma-apply-grothendieck}). hence since $b$ has $(s_k)$ we see that $a$ has $(s_k)$. \end{proof} \begin{lemma} \label{lemma-descent-rk} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is faithfully flat, and \item $s$ is noetherian and has property $(r_k)$. \end{enumerate} then $r$ is noetherian and has property $(r_k)$. \end{lemma} \begin{proof} we have already seen that (1) and (2) imply that $r$ is noetherian, see lemma \ref{lemma-descent-noetherian}. let $\mathfrak p \subset r$ be a prime ideal and assume $\dim(r_{\mathfrak p}) \leq k$. choose a prime $\mathfrak q \subset s$ lying over $\mathfrak p$ which corresponds to a minimal prime of the fibre ring $s \otimes_r \kappa(\mathfrak p)$. then $a = r_{\mathfrak p} \to s_{\mathfrak q} = b$ is a flat local ring homomorphism of noetherian local rings with $\mathfrak m_ab$ an ideal of definition of $b$. hence $\dim(a) = \dim(b)$ (lemma \ref{lemma-dimension-base-fibre-equals-total}). as $s$ has $(r_k)$ we conclude that $b$ is a regular local ring. by lemma \ref{lemma-flat-under-regular} we conclude that $a$ is regular. \end{proof} \begin{lemma} \label{lemma-descent-nagata} let $r \to s$ be a ring map. assume that \begin{enumerate} \item $r \to s$ is smooth and surjective on spectra, and \item $s$ is a nagata ring. \end{enumerate} then $r$ is a nagata ring. \end{lemma} \begin{proof} recall that a nagata ring is the same thing as a noetherian universally japanese ring (proposition \ref{proposition-nagata-universally-japanese}). we have already seen that $r$ is noetherian in lemma \ref{lemma-descent-noetherian}. let $r \to a$ be a finite type ring map into a domain. according to lemma \ref{lemma-check-universally-japanese} it suffices to check that $a$ is n-1. it is clear that $b = a \otimes_r s$ is a finite type $s$-algebra and hence nagata (proposition \ref{proposition-nagata-universally-japanese}). since $a \to b$ is smooth (lemma \ref{lemma-base-change-smooth}) we see that $b$ is reduced (lemma \ref{lemma-reduced-goes-up}). since $b$ is noetherian it has only a finite number of minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$ (see lemma \ref{lemma-noetherian-irreducible-components}). as $a \to b$ is flat each of these lies over $(0) \subset a$ (by going down, see lemma \ref{lemma-flat-going-down}) the total ring of fractions $q(b)$ is the product of the $l_i = \kappa(\mathfrak q_i)$ (lemmas \ref{lemma-total-ring-fractions-no-embedded-points} and \ref{lemma-minimal-prime-reduced-ring}). moreover, the integral closure $b'$ of $b$ in $q(b)$ is the product of the integral closures $b_i'$ of the $b/\mathfrak q_i$ in the factors $l_i$ (compare with lemma \ref{lemma-characterize-reduced-ring-normal}). since $b$ is universally japanese the ring extensions $b/\mathfrak q_i \subset b_i'$ are finite and we conclude that $b' = \prod b_i'$ is finite over $b$. since $a \to b$ is flat we see that any nonzerodivisor on $a$ maps to a nonzerodivisor on $b$. the corresponding map $$ q(a) \otimes_a b = (a \setminus \{0\})^{-1}a \otimes_a b = (a \setminus \{0\})^{-1}b \to q(b) $$ is injective (we used lemma \ref{lemma-tensor-localization}). via this map $a'$ maps into $b'$. this induces a map $$ a' \otimes_a b \longrightarrow b' $$ which is injective (by the above and the flatness of $a \to b$). since $b'$ is a finite $b$-module and $b$ is noetherian we see that $a' \otimes_a b$ is a finite $b$-module. hence there exist finitely many elements $x_i \in a'$ such that the elements $x_i \otimes 1$ generate $a' \otimes_a b$ as a $b$-module. finally, by faithful flatness of $a \to b$ we conclude that the $x_i$ also generated $a'$ as an $a$-module, and we win. \end{proof} \begin{remark} \label{remark-universally-catenary-does-not-descend} the property of being ``universally catenary'' does not descend; not even along \'etale ring maps. in examples, section \ref{examples-section-non-catenary-noetherian-local} there is a construction of a finite ring map $a \to b$ with $a$ local noetherian and not universally catenary, $b$ semi-local with two maximal ideals $\mathfrak m$, $\mathfrak n$ with $b_{\mathfrak m}$ and $b_{\mathfrak n}$ regular of dimension $2$ and $1$ respectively, and the same residue fields as that of $a$. moreover, $\mathfrak m_a$ generates the maximal ideal in both $b_{\mathfrak m}$ and $b_{\mathfrak n}$ (so $a \to b$ is unramified as well as finite). by lemma \ref{lemma-etale-makes-unramified-closed} there exists a local \'etale ring map $a \to a'$ such that $b \otimes_a a' = b_1 \times b_2$ decomposes with $a' \to b_i$ surjective. this shows that $a'$ has two minimal primes $\mathfrak q_i$ with $a'/\mathfrak q_i \cong b_i$. since $b_i$ is regular local (since it is \'etale over either $b_{\mathfrak m}$ or $b_{\mathfrak n}$) we conclude that $a'$ is universally catenary. \end{remark} \section{geometrically normal algebras} \label{section-geometrically-normal} \noindent in this section we put some applications of ascent and descent of properties of rings. \begin{lemma} \label{lemma-geometrically-normal} let $k$ be a field. let $a$ be a $k$-algebra. the following properties of $a$ are equivalent: \begin{enumerate} \item $k' \otimes_k a$ is a normal ring for every field extension $k'/k$, \item $k' \otimes_k a$ is a normal ring for every finitely generated field extension $k'/k$, \item $k' \otimes_k a$ is a normal ring for every finite purely inseparable extension $k'/k$, \item $k^{perf} \otimes_k a$ is a normal ring. \end{enumerate} here normal ring is defined in definition \ref{definition-ring-normal}. \end{lemma} \begin{proof} it is clear that (1) $\rightarrow$ (2) $\rightarrow$ (3) and (1) $\rightarrow$ (4). \medskip\noindent if $k'/k$ is a finite purely inseparable extension, then there is an embedding $k' \to k^{perf}$ of $k$-extensions. the ring map $k' \otimes_k a \to k^{perf} \otimes_k a$ is faithfully flat, hence $k' \otimes_k a$ is normal if $k^{perf} \otimes_k a$ is normal by lemma \ref{lemma-descent-normal}. in this way we see that (4) $\rightarrow$ (3). \medskip\noindent assume (2) and let $k'/k$ be any field extension. then we can write $k' = \colim_i k_i$ as a directed colimit of finitely generated field extensions. hence we see that $k' \otimes_k a = \colim_i k_i \otimes_k a$ is a directed colimit of normal rings. thus we see that $k' \otimes_k a$ is a normal ring by lemma \ref{lemma-colimit-normal-ring}. hence (1) holds. \medskip\noindent assume (3) and let $k/k$ be a finitely generated field extension. by lemma \ref{lemma-make-separable} we can find a diagram $$ \xymatrix{ k \ar[r] & k' \\ k \ar[u] \ar[r] & k' \ar[u] } $$ where $k'/k$, $k'/k$ are finite purely inseparable field extensions such that $k'/k'$ is separable. by lemma \ref{lemma-localization-smooth-separable} there exists a smooth $k'$-algebra $b$ such that $k'$ is the fraction field of $b$. now we can argue as follows: step 1: $k' \otimes_k a$ is a normal ring because we assumed (3). step 2: $b \otimes_{k'} k' \otimes_k a$ is a normal ring as $k' \otimes_k a \to b \otimes_{k'} k' \otimes_k a$ is smooth (lemma \ref{lemma-base-change-smooth}) and ascent of normality along smooth maps (lemma \ref{lemma-normal-goes-up}). step 3. $k' \otimes_{k'} k' \otimes_k a = k' \otimes_k a$ is a normal ring as it is a localization of a normal ring (lemma \ref{lemma-localization-normal-ring}). step 4. finally $k \otimes_k a$ is a normal ring by descent of normality along the faithfully flat ring map $k \otimes_k a \to k' \otimes_k a$ (lemma \ref{lemma-descent-normal}). this proves the lemma. \end{proof} \begin{definition} \label{definition-geometrically-normal} let $k$ be a field. a $k$-algebra $r$ is called {\it geometrically normal} over $k$ if the equivalent conditions of lemma \ref{lemma-geometrically-normal} hold. \end{definition} \begin{lemma} \label{lemma-localization-geometrically-normal-algebra} \begin{slogan} localization preserves geometric normality. \end{slogan} let $k$ be a field. a localization of a geometrically normal $k$-algebra is geometrically normal. \end{lemma} \begin{proof} this is clear as being a normal ring is checked at the localizations at prime ideals. \end{proof} \begin{lemma} \label{lemma-separable-field-extension-geometrically-normal} let $k$ be a field. let $k/k$ be a separable field extension. then $k$ is geometrically normal over $k$. \end{lemma} \begin{proof} this is true because $k^{perf} \otimes_k k$ is a field. namely, it is reduced by lemma \ref{lemma-separable-extension-preserves-reducedness}. by lemma \ref{lemma-perfection} (or by definition \ref{definition-perfection}) the field extension $k^{perf}/k$ is purely inseparable. hence by lemma \ref{lemma-radicial-integral-bijective} the ring $k^{perf} \otimes_k k$ has a unique prime ideal. a reduced ring with a unique prime ideal is a field. \end{proof} \begin{lemma} \label{lemma-geometrically-normal-tensor-normal} let $k$ be a field. let $a, b$ be $k$-algebras. assume $a$ is geometrically normal over $k$ and $b$ is a normal ring. then $a \otimes_k b$ is a normal ring. \end{lemma} \begin{proof} let $\mathfrak r$ be a prime ideal of $a \otimes_k b$. denote $\mathfrak p$, resp.\ $\mathfrak q$ the corresponding prime of $a$, resp.\ $b$. then $(a \otimes_k b)_{\mathfrak r}$ is a localization of $a_{\mathfrak p} \otimes_k b_{\mathfrak q}$. hence it suffices to prove the result for the ring $a_{\mathfrak p} \otimes_k b_{\mathfrak q}$, see lemma \ref{lemma-localization-normal-ring} and lemma \ref{lemma-localization-geometrically-normal-algebra}. thus we may assume $a$ and $b$ are domains. \medskip\noindent assume that $a$ and $b$ are domains with fractions fields $k$ and $l$. note that $b$ is the filtered colimit of its finite type normal $k$-sub algebras (as $k$ is a nagata ring, see proposition \ref{proposition-ubiquity-nagata}, and hence the integral closure of a finite type $k$-sub algebra is still a finite type $k$-sub algebra by proposition \ref{proposition-nagata-universally-japanese}). by lemma \ref{lemma-colimit-normal-ring} we reduce to the case that $b$ is of finite type over $k$. \medskip\noindent assume that $a$ and $b$ are domains with fractions fields $k$ and $l$ and $b$ of finite type over $k$. in this case the ring $k \otimes_k b$ is of finite type over $k$, hence noetherian (lemma \ref{lemma-noetherian-permanence}). in particular $k \otimes_k b$ has finitely many minimal primes (lemma \ref{lemma-noetherian-irreducible-components}). since $a \to a \otimes_k b$ is flat, this implies that $a \otimes_k b$ has finitely many minimal primes (by going down for flat ring maps -- lemma \ref{lemma-flat-going-down} -- these primes all lie over $(0) \subset a$). thus it suffices to prove that $a \otimes_k b$ is integrally closed in its total ring of fractions (lemma \ref{lemma-characterize-reduced-ring-normal}). \medskip\noindent we claim that $k \otimes_k b$ and $a \otimes_k l$ are both normal rings. if this is true then any element $x$ of $q(a \otimes_k b)$ which is integral over $a \otimes_k b$ is (by lemma \ref{lemma-normal-ring-integrally-closed}) contained in $k \otimes_k b \cap a \otimes_k l = a \otimes_k b$ and we're done. since $a \otimes_k l$ is a normal ring by assumption, it suffices to prove that $k \otimes_k b$ is normal. \medskip\noindent as $a$ is geometrically normal over $k$ we see $k$ is geometrically normal over $k$ (lemma \ref{lemma-localization-geometrically-normal-algebra}) hence $k$ is geometrically reduced over $k$. hence $k = \bigcup k_i$ is the union of finitely generated field extensions of $k$ which are geometrically reduced (lemma \ref{lemma-subalgebra-separable}). each $k_i$ is the localization of a smooth $k$-algebra (lemma \ref{lemma-localization-smooth-separable}). so $k_i \otimes_k b$ is the localization of a smooth $b$-algebra hence normal (lemma \ref{lemma-normal-goes-up}). thus $k \otimes_k b$ is a normal ring (lemma \ref{lemma-colimit-normal-ring}) and we win. \end{proof} \begin{lemma} \label{lemma-geometrically-normal-over-separable-algebraic} let $k'/k$ be a separable algebraic field extension. let $a$ be an algebra over $k'$. then $a$ is geometrically normal over $k$ if and only if it is geometrically normal over $k'$. \end{lemma} \begin{proof} let $l/k$ be a finite purely inseparable field extension. then $l' = k' \otimes_k l$ is a field (see material in fields, section \ref{fields-section-algebraic}) and $a \otimes_k l = a \otimes_{k'} l'$. hence if $a$ is geometrically normal over $k'$, then $a$ is geometrically normal over $k$. \medskip\noindent assume $a$ is geometrically normal over $k$. let $k/k'$ be a field extension. then $$ k \otimes_{k'} a = (k \otimes_k a) \otimes_{(k' \otimes_k k')} k' $$ since $k' \otimes_k k' \to k'$ is a localization by lemma \ref{lemma-separable-algebraic-diagonal}, we see that $k \otimes_{k'} a$ is a localization of a normal ring, hence normal. \end{proof} \section{geometrically regular algebras} \label{section-geometrically-regular} \noindent let $k$ be a field. let $a$ be a noetherian $k$-algebra. let $k/k$ be a finitely generated field extension. then the ring $k \otimes_k a$ is noetherian as well, see lemma \ref{lemma-noetherian-field-extension}. thus the following lemma makes sense. \begin{lemma} \label{lemma-geometrically-regular} let $k$ be a field. let $a$ be a $k$-algebra. assume $a$ is noetherian. the following properties of $a$ are equivalent: \begin{enumerate} \item $k' \otimes_k a$ is regular for every finitely generated field extension $k'/k$, and \item $k' \otimes_k a$ is regular for every finite purely inseparable extension $k'/k$. \end{enumerate} here regular ring is as in definition \ref{definition-regular}. \end{lemma} \begin{proof} the lemma makes sense by the remarks preceding the lemma. it is clear that (1) $\rightarrow$ (2). \medskip\noindent assume (2) and let $k/k$ be a finitely generated field extension. by lemma \ref{lemma-make-separable} we can find a diagram $$ \xymatrix{ k \ar[r] & k' \\ k \ar[u] \ar[r] & k' \ar[u] } $$ where $k'/k$, $k'/k$ are finite purely inseparable field extensions such that $k'/k'$ is separable. by lemma \ref{lemma-localization-smooth-separable} there exists a smooth $k'$-algebra $b$ such that $k'$ is the fraction field of $b$. now we can argue as follows: step 1: $k' \otimes_k a$ is a regular ring because we assumed (2). step 2: $b \otimes_{k'} k' \otimes_k a$ is a regular ring as $k' \otimes_k a \to b \otimes_{k'} k' \otimes_k a$ is smooth (lemma \ref{lemma-base-change-smooth}) and ascent of regularity along smooth maps (lemma \ref{lemma-regular-goes-up}). step 3. $k' \otimes_{k'} k' \otimes_k a = k' \otimes_k a$ is a regular ring as it is a localization of a regular ring (immediate from the definition). step 4. finally $k \otimes_k a$ is a regular ring by descent of regularity along the faithfully flat ring map $k \otimes_k a \to k' \otimes_k a$ (lemma \ref{lemma-descent-regular}). this proves the lemma. \end{proof} \begin{definition} \label{definition-geometrically-regular} let $k$ be a field. let $r$ be a noetherian $k$-algebra. the $k$-algebra $r$ is called {\it geometrically regular} over $k$ if the equivalent conditions of lemma \ref{lemma-geometrically-regular} hold. \end{definition} \noindent it is clear from the definition that $k \otimes_k r$ is a geometrically regular algebra over $k$ for any finitely generated field extension $k$ of $k$. we will see later (more on algebra, proposition \ref{more-algebra-proposition-characterization-geometrically-regular}) that it suffices to check $r \otimes_k k'$ is regular whenever $k \subset k' \subset k^{1/p}$ (finite). \begin{lemma} \label{lemma-geometrically-regular-descent} \begin{slogan} geometric regularity descends through faithfully flat maps of algebras \end{slogan} let $k$ be a field. let $a \to b$ be a faithfully flat $k$-algebra map. if $b$ is geometrically regular over $k$, so is $a$. \end{lemma} \begin{proof} assume $b$ is geometrically regular over $k$. let $k'/k$ be a finite, purely inseparable extension. then $a \otimes_k k' \to b \otimes_k k'$ is faithfully flat as a base change of $a \to b$ (by lemmas \ref{lemma-surjective-spec-radical-ideal} and \ref{lemma-flat-base-change}) and $b \otimes_k k'$ is regular by our assumption on $b$ over $k$. then $a \otimes_k k'$ is regular by lemma \ref{lemma-descent-regular}. \end{proof} \begin{lemma} \label{lemma-geometrically-regular-goes-up} let $k$ be a field. let $a \to b$ be a smooth ring map of $k$-algebras. if $a$ is geometrically regular over $k$, then $b$ is geometrically regular over $k$. \end{lemma} \begin{proof} let $k'/k$ be a finitely generated field extension. then $a \otimes_k k' \to b \otimes_k k'$ is a smooth ring map (lemma \ref{lemma-base-change-smooth}) and $a \otimes_k k'$ is regular. hence $b \otimes_k k'$ is regular by lemma \ref{lemma-regular-goes-up}. \end{proof} \begin{lemma} \label{lemma-geometrically-regular-over-subfields} let $k$ be a field. let $a$ be an algebra over $k$. let $k = \colim k_i$ be a directed colimit of subfields. if $a$ is geometrically regular over each $k_i$, then $a$ is geometrically regular over $k$. \end{lemma} \begin{proof} let $k'/k$ be a finite purely inseparable field extension. we can get $k'$ by adjoining finitely many variables to $k$ and imposing finitely many polynomial relations. hence we see that there exists an $i$ and a finite purely inseparable field extension $k_i'/k_i$ such that $k_i = k \otimes_{k_i} k_i'$. thus $a \otimes_k k' = a \otimes_{k_i} k_i'$ and the lemma is clear. \end{proof} \begin{lemma} \label{lemma-geometrically-regular-over-separable-algebraic} let $k'/k$ be a separable algebraic field extension. let $a$ be an algebra over $k'$. then $a$ is geometrically regular over $k$ if and only if it is geometrically regular over $k'$. \end{lemma} \begin{proof} let $l/k$ be a finite purely inseparable field extension. then $l' = k' \otimes_k l$ is a field (see material in fields, section \ref{fields-section-algebraic}) and $a \otimes_k l = a \otimes_{k'} l'$. hence if $a$ is geometrically regular over $k'$, then $a$ is geometrically regular over $k$. \medskip\noindent assume $a$ is geometrically regular over $k$. since $k'$ is the filtered colimit of finite extensions of $k$ we may assume by lemma \ref{lemma-geometrically-regular-over-subfields} that $k'/k$ is finite separable. consider the ring maps $$ k' \to a \otimes_k k' \to a. $$ note that $a \otimes_k k'$ is geometrically regular over $k'$ as a base change of $a$ to $k'$. note that $a \otimes_k k' \to a$ is the base change of $k' \otimes_k k' \to k'$ by the map $k' \to a$. since $k'/k$ is an \'etale extension of rings, we see that $k' \otimes_k k' \to k'$ is \'etale (lemma \ref{lemma-etale}). hence $a$ is geometrically regular over $k'$ by lemma \ref{lemma-geometrically-regular-goes-up}. \end{proof} \section{geometrically cohen-macaulay algebras} \label{section-geometrically-cm} \noindent this section is a bit of a misnomer, since cohen-macaulay algebras are automatically geometrically cohen-macaulay. namely, see lemma \ref{lemma-extend-field-cm-locus} and lemma \ref{lemma-cm-geometrically-cm} below. \begin{lemma} \label{lemma-tensor-fields-cm} let $k$ be a field and let $k/k$ and $l/k$ be two field extensions such that one of them is a field extension of finite type. then $k \otimes_k l$ is a noetherian cohen-macaulay ring. \end{lemma} \begin{proof} the ring $k \otimes_k l$ is noetherian by lemma \ref{lemma-noetherian-field-extension}. say $k$ is a finite extension of the purely transcendental extension $k(t_1, \ldots, t_r)$. then $k(t_1, \ldots, t_r) \otimes_k l \to k \otimes_k l$ is a finite free ring map. by lemma \ref{lemma-finite-flat-over-regular-cm} it suffices to show that $k(t_1, \ldots, t_r) \otimes_k l$ is cohen-macaulay. this is clear because it is a localization of the polynomial ring $l[t_1, \ldots, t_r]$. (see for example lemma \ref{lemma-cm-polynomial-algebra} for the fact that a polynomial ring is cohen-macaulay.) \end{proof} \begin{lemma} \label{lemma-cm-geometrically-cm} let $k$ be a field. let $s$ be a noetherian $k$-algebra. let $k/k$ be a finitely generated field extension, and set $s_k = k \otimes_k s$. let $\mathfrak q \subset s$ be a prime of $s$. let $\mathfrak q_k \subset s_k$ be a prime of $s_k$ lying over $\mathfrak q$. then $s_{\mathfrak q}$ is cohen-macaulay if and only if $(s_k)_{\mathfrak q_k}$ is cohen-macaulay. \end{lemma} \begin{proof} by lemma \ref{lemma-noetherian-field-extension} the ring $s_k$ is noetherian. hence $s_{\mathfrak q} \to (s_k)_{\mathfrak q_k}$ is a flat local homomorphism of noetherian local rings. note that the fibre $$ (s_k)_{\mathfrak q_k} / \mathfrak q (s_k)_{\mathfrak q_k} \cong (\kappa(\mathfrak q) \otimes_k k)_{\mathfrak q'} $$ is the localization of the cohen-macaulay (lemma \ref{lemma-tensor-fields-cm}) ring $\kappa(\mathfrak q) \otimes_k k$ at a suitable prime ideal $\mathfrak q'$. hence the lemma follows from lemma \ref{lemma-cm-goes-up}. \end{proof} \section{colimits and maps of finite presentation, ii} \label{section-colimits-finite-presentation} \noindent this section is a continuation of section \ref{section-colimits-flat}. \medskip\noindent we start with an application of the openness of flatness. it says that we can approximate flat modules by flat modules which is useful. \begin{lemma} \label{lemma-flat-finite-presentation-limit-flat} let $r \to s$ be a ring map. let $m$ be an $s$-module. assume that \begin{enumerate} \item $r \to s$ is of finite presentation, \item $m$ is a finitely presented $s$-module, and \item $m$ is flat over $r$. \end{enumerate} in this case we have the following: \begin{enumerate} \item there exists a finite type $\mathbf{z}$-algebra $r_0$ and a finite type ring map $r_0 \to s_0$ and a finite $s_0$-module $m_0$ such that $m_0$ is flat over $r_0$, together with a ring maps $r_0 \to r$ and $s_0 \to s$ and an $s_0$-module map $m_0 \to m$ such that $s \cong r \otimes_{r_0} s_0$ and $m = s \otimes_{s_0} m_0$. \item if $r = \colim_{\lambda \in \lambda} r_\lambda$ is written as a directed colimit, then there exists a $\lambda$ and a ring map $r_\lambda \to s_\lambda$ of finite presentation, and an $s_\lambda$-module $m_\lambda$ of finite presentation such that $m_\lambda$ is flat over $r_\lambda$ and such that $s = r \otimes_{r_\lambda} s_\lambda$ and $m = s \otimes_{s_{\lambda}} m_\lambda$. \item if $$ (r \to s, m) = \colim_{\lambda \in \lambda} (r_\lambda \to s_\lambda, m_\lambda) $$ is written as a directed colimit such that \begin{enumerate} \item $r_\mu \otimes_{r_\lambda} s_\lambda \to s_\mu$ and $s_\mu \otimes_{s_\lambda} m_\lambda \to m_\mu$ are isomorphisms for $\mu \geq \lambda$, \item $r_\lambda \to s_\lambda$ is of finite presentation, \item $m_\lambda$ is a finitely presented $s_\lambda$-module, \end{enumerate} then for all sufficiently large $\lambda$ the module $m_\lambda$ is flat over $r_\lambda$. \end{enumerate} \end{lemma} \begin{proof} we first write $(r \to s, m)$ as the directed colimit of a system $(r_\lambda \to s_\lambda, m_\lambda)$ as in as in lemma \ref{lemma-limit-module-finite-presentation}. let $\mathfrak q \subset s$ be a prime. let $\mathfrak p \subset r$, $\mathfrak q_\lambda \subset s_\lambda$, and $\mathfrak p_\lambda \subset r_\lambda$ the corresponding primes. as seen in the proof of theorem \ref{theorem-openness-flatness} $$ ((r_\lambda)_{\mathfrak p_\lambda}, (s_\lambda)_{\mathfrak q_\lambda}, (m_\lambda)_{\mathfrak q_{\lambda}}) $$ is a system as in lemma \ref{lemma-limit-module-essentially-finite-presentation}, and hence by lemma \ref{lemma-colimit-eventually-flat} we see that for some $\lambda_{\mathfrak q} \in \lambda$ for all $\lambda \geq \lambda_{\mathfrak q}$ the module $m_\lambda$ is flat over $r_\lambda$ at the prime $\mathfrak q_{\lambda}$. \medskip\noindent by theorem \ref{theorem-openness-flatness} we get an open subset $u_\lambda \subset \spec(s_\lambda)$ such that $m_\lambda$ flat over $r_\lambda$ at all the primes of $u_\lambda$. denote $v_\lambda \subset \spec(s)$ the inverse image of $u_\lambda$ under the map $\spec(s) \to \spec(s_\lambda)$. the argument above shows that for every $\mathfrak q \in \spec(s)$ there exists a $\lambda_{\mathfrak q}$ such that $\mathfrak q \in v_\lambda$ for all $\lambda \geq \lambda_{\mathfrak q}$. since $\spec(s)$ is quasi-compact we see this implies there exists a single $\lambda_0 \in \lambda$ such that $v_{\lambda_0} = \spec(s)$. \medskip\noindent the complement $\spec(s_{\lambda_0}) \setminus u_{\lambda_0}$ is $v(i)$ for some ideal $i \subset s_{\lambda_0}$. as $v_{\lambda_0} = \spec(s)$ we see that $is = s$. choose $f_1, \ldots, f_r \in i$ and $s_1, \ldots, s_n \in s$ such that $\sum f_i s_i = 1$. since $\colim s_\lambda = s$, after increasing $\lambda_0$ we may assume there exist $s_{i, \lambda_0} \in s_{\lambda_0}$ such that $\sum f_i s_{i, \lambda_0} = 1$. hence for this $\lambda_0$ we have $u_{\lambda_0} = \spec(s_{\lambda_0})$. this proves (1). \medskip\noindent proof of (2). let $(r_0 \to s_0, m_0)$ be as in (1) and suppose that $r = \colim r_\lambda$. since $r_0$ is a finite type $\mathbf{z}$ algebra, there exists a $\lambda$ and a map $r_0 \to r_\lambda$ such that $r_0 \to r_\lambda \to r$ is the given map $r_0 \to r$ (see lemma \ref{lemma-characterize-finite-presentation}). then, part (2) follows by taking $s_\lambda = r_\lambda \otimes_{r_0} s_0$ and $m_\lambda = s_\lambda \otimes_{s_0} m_0$. \medskip\noindent finally, we come to the proof of (3). let $(r_\lambda \to s_\lambda, m_\lambda)$ be as in (3). choose $(r_0 \to s_0, m_0)$ and $r_0 \to r$ as in (1). as in the proof of (2), there exists a $\lambda_0$ and a ring map $r_0 \to r_{\lambda_0}$ such that $r_0 \to r_{\lambda_0} \to r$ is the given map $r_0 \to r$. since $s_0$ is of finite presentation over $r_0$ and since $s = \colim s_\lambda$ we see that for some $\lambda_1 \geq \lambda_0$ we get an $r_0$-algebra map $s_0 \to s_{\lambda_1}$ such that the composition $s_0 \to s_{\lambda_1} \to s$ is the given map $s_0 \to s$ (see lemma \ref{lemma-characterize-finite-presentation}). for all $\lambda \geq \lambda_1$ this gives maps $$ \psi_{\lambda} : r_\lambda \otimes_{r_0} s_0 \longrightarrow r_\lambda \otimes_{r_{\lambda_1}} s_{\lambda_1} \cong s_\lambda $$ the last isomorphism by assumption. by construction $\colim_\lambda \psi_\lambda$ is an isomorphism. hence $\psi_\lambda$ is an isomorphism for all $\lambda$ large enough by lemma \ref{lemma-colimit-category-fp-algebras}. in the same vein, there exists a $\lambda_2 \geq \lambda_1$ and an $s_0$-module map $m_0 \to m_{\lambda_2}$ such that $m_0 \to m_{\lambda_2} \to m$ is the given map $m_0 \to m$ (see lemma \ref{lemma-module-map-property-in-colimit}). for $\lambda \geq \lambda_2$ there is an induced map $$ s_\lambda \otimes_{s_0} m_0 \longrightarrow s_\lambda \otimes_{s_{\lambda_2}} m_{\lambda_2} \cong m_\lambda $$ and for $\lambda$ large enough this map is an isomorphism by lemma \ref{lemma-colimit-category-fp-modules}. this implies (3) because $m_0$ is flat over $r_0$. \end{proof} \begin{lemma} \label{lemma-descend-faithfully-flat-finite-presentation} let $r \to a \to b$ be ring maps. assume $a \to b$ faithfully flat of finite presentation. then there exists a commutative diagram $$ \xymatrix{ r \ar[r] \ar@{=}[d] & a_0 \ar[d] \ar[r] & b_0 \ar[d] \\ r \ar[r] & a \ar[r] & b } $$ with $r \to a_0$ of finite presentation, $a_0 \to b_0$ faithfully flat of finite presentation and $b = a \otimes_{a_0} b_0$. \end{lemma} \begin{proof} we first prove the lemma with $r$ replaced $\mathbf{z}$. by lemma \ref{lemma-flat-finite-presentation-limit-flat} there exists a diagram $$ \xymatrix{ a_0 \ar[r] & a \\ b_0 \ar[u] \ar[r] & b \ar[u] } $$ where $a_0$ is of finite type over $\mathbf{z}$, $b_0$ is flat of finite presentation over $a_0$ such that $b = a \otimes_{a_0} b_0$. as $a_0 \to b_0$ is flat of finite presentation we see that the image of $\spec(b_0) \to \spec(a_0)$ is open, see proposition \ref{proposition-fppf-open}. hence the complement of the image is $v(i_0)$ for some ideal $i_0 \subset a_0$. as $a \to b$ is faithfully flat the map $\spec(b) \to \spec(a)$ is surjective, see lemma \ref{lemma-ff-rings}. now we use that the base change of the image is the image of the base change. hence $i_0a = a$. pick a relation $\sum f_i r_i = 1$, with $r_i \in a$, $f_i \in i_0$. then after enlarging $a_0$ to contain the elements $r_i$ (and correspondingly enlarging $b_0$) we see that $a_0 \to b_0$ is surjective on spectra also, i.e., faithfully flat. \medskip\noindent thus the lemma holds in case $r = \mathbf{z}$. in the general case, take the solution $a_0' \to b_0'$ just obtained and set $a_0 = a_0' \otimes_{\mathbf{z}} r$, $b_0 = b_0' \otimes_{\mathbf{z}} r$. \end{proof} \begin{lemma} \label{lemma-colimit-finite} let $a = \colim_{i \in i} a_i$ be a directed colimit of rings. let $0 \in i$ and $\varphi_0 : b_0 \to c_0$ a map of $a_0$-algebras. assume \begin{enumerate} \item $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is finite, \item $c_0$ is of finite type over $b_0$. \end{enumerate} then there exists an $i \geq 0$ such that the map $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is finite. \end{lemma} \begin{proof} let $x_1, \ldots, x_m$ be generators for $c_0$ over $b_0$. pick monic polynomials $p_j \in a \otimes_{a_0} b_0[t]$ such that $p_j(1 \otimes x_j) = 0$ in $a \otimes_{a_0} c_0$. for some $i \geq 0$ we can find $p_{j, i} \in a_i \otimes_{a_0} b_0[t]$ mapping to $p_j$. since $\otimes$ commutes with colimits we see that $p_{j, i}(1 \otimes x_j)$ is zero in $a_i \otimes_{a_0} c_0$ after possibly increasing $i$. then this $i$ works. \end{proof} \begin{lemma} \label{lemma-colimit-surjective} let $a = \colim_{i \in i} a_i$ be a directed colimit of rings. let $0 \in i$ and $\varphi_0 : b_0 \to c_0$ a map of $a_0$-algebras. assume \begin{enumerate} \item $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is surjective, \item $c_0$ is of finite type over $b_0$. \end{enumerate} then for some $i \geq 0$ the map $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is surjective. \end{lemma} \begin{proof} let $x_1, \ldots, x_m$ be generators for $c_0$ over $b_0$. pick $b_j \in a \otimes_{a_0} b_0$ mapping to $1 \otimes x_j$ in $a \otimes_{a_0} c_0$. for some $i \geq 0$ we can find $b_{j, i} \in a_i \otimes_{a_0} b_0$ mapping to $b_j$. after increasing $i$ we may assume that $b_{j, i}$ maps to $1 \otimes x_j$ in $a_i \otimes_{a_0} c_0$ for all $j = 1, \ldots, m$. then this $i$ works. \end{proof} \begin{lemma} \label{lemma-colimit-unramified} let $a = \colim_{i \in i} a_i$ be a directed colimit of rings. let $0 \in i$ and $\varphi_0 : b_0 \to c_0$ a map of $a_0$-algebras. assume \begin{enumerate} \item $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is unramified, \item $c_0$ is of finite type over $b_0$. \end{enumerate} then for some $i \geq 0$ the map $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is unramified. \end{lemma} \begin{proof} set $b_i = a_i \otimes_{a_0} b_0$, $c_i = a_i \otimes_{a_0} c_0$, $b = a \otimes_{a_0} b_0$, and $c = a \otimes_{a_0} c_0$. let $x_1, \ldots, x_m$ be generators for $c_0$ over $b_0$. then $\text{d}x_1, \ldots, \text{d}x_m$ generate $\omega_{c_0/b_0}$ over $c_0$ and their images generate $\omega_{c_i/b_i}$ over $c_i$ (lemmas \ref{lemma-differentials-polynomial-ring} and \ref{lemma-differential-seq}). observe that $0 = \omega_{c/b} = \colim \omega_{c_i/b_i}$ (lemma \ref{lemma-colimit-differentials}). thus there is an $i$ such that $\text{d}x_1, \ldots, \text{d}x_m$ map to zero and hence $\omega_{c_i/b_i} = 0$ as desired. \end{proof} \begin{lemma} \label{lemma-colimit-isomorphism} let $a = \colim_{i \in i} a_i$ be a directed colimit of rings. let $0 \in i$ and $\varphi_0 : b_0 \to c_0$ a map of $a_0$-algebras. assume \begin{enumerate} \item $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is an isomorphism, \item $b_0 \to c_0$ is of finite presentation. \end{enumerate} then for some $i \geq 0$ the map $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is an isomorphism. \end{lemma} \begin{proof} by lemma \ref{lemma-colimit-surjective} there exists an $i$ such that $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is surjective. since the map is of finite presentation the kernel is a finitely generated ideal. let $g_1, \ldots, g_r \in a_i \otimes_{a_0} b_0$ generate the kernel. then we may pick $i' \geq i$ such that $g_j$ map to zero in $a_{i'} \otimes_{a_0} b_0$. then $a_{i'} \otimes_{a_0} b_0 \to a_{i'} \otimes_{a_0} c_0$ is an isomorphism. \end{proof} \begin{lemma} \label{lemma-colimit-etale} let $a = \colim_{i \in i} a_i$ be a directed colimit of rings. let $0 \in i$ and $\varphi_0 : b_0 \to c_0$ a map of $a_0$-algebras. assume \begin{enumerate} \item $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is \'etale, \item $b_0 \to c_0$ is of finite presentation. \end{enumerate} then for some $i \geq 0$ the map $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is \'etale. \end{lemma} \begin{proof} write $c_0 = b_0[x_1, \ldots, x_n]/(f_{1, 0}, \ldots, f_{m, 0})$. write $b_i = a_i \otimes_{a_0} b_0$ and $c_i = a_i \otimes_{a_0} c_0$. note that $c_i = b_i[x_1, \ldots, x_n]/(f_{1, i}, \ldots, f_{m, i})$ where $f_{j, i}$ is the image of $f_{j, 0}$ in the polynomial ring over $b_i$. write $b = a \otimes_{a_0} b_0$ and $c = a \otimes_{a_0} c_0$. note that $c = b[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ where $f_j$ is the image of $f_{j, 0}$ in the polynomial ring over $b$. the assumption is that the map $$ \text{d} : (f_1, \ldots, f_m)/(f_1, \ldots, f_m)^2 \longrightarrow \bigoplus c \text{d}x_k $$ is an isomorphism. thus for sufficiently large $i$ we can find elements $$ \xi_{k, i} \in (f_{1, i}, \ldots, f_{m, i})/(f_{1, i}, \ldots, f_{m, i})^2 $$ with $\text{d}\xi_{k, i} = \text{d}x_k$ in $\bigoplus c_i \text{d}x_k$. moreover, on increasing $i$ if necessary, we see that $\sum (\partial f_{j, i}/\partial x_k) \xi_{k, i} = f_{j, i} \bmod (f_{1, i}, \ldots, f_{m, i})^2$ since this is true in the limit. then this $i$ works. \end{proof} \begin{lemma} \label{lemma-colimit-smooth} let $a = \colim_{i \in i} a_i$ be a directed colimit of rings. let $0 \in i$ and $\varphi_0 : b_0 \to c_0$ a map of $a_0$-algebras. assume \begin{enumerate} \item $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is smooth, \item $b_0 \to c_0$ is of finite presentation. \end{enumerate} then for some $i \geq 0$ the map $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is smooth. \end{lemma} \begin{proof} write $c_0 = b_0[x_1, \ldots, x_n]/(f_{1, 0}, \ldots, f_{m, 0})$. write $b_i = a_i \otimes_{a_0} b_0$ and $c_i = a_i \otimes_{a_0} c_0$. note that $c_i = b_i[x_1, \ldots, x_n]/(f_{1, i}, \ldots, f_{m, i})$ where $f_{j, i}$ is the image of $f_{j, 0}$ in the polynomial ring over $b_i$. write $b = a \otimes_{a_0} b_0$ and $c = a \otimes_{a_0} c_0$. note that $c = b[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ where $f_j$ is the image of $f_{j, 0}$ in the polynomial ring over $b$. the assumption is that the map $$ \text{d} : (f_1, \ldots, f_m)/(f_1, \ldots, f_m)^2 \longrightarrow \bigoplus c \text{d}x_k $$ is a split injection. let $\xi_k \in (f_1, \ldots, f_m)/(f_1, \ldots, f_m)^2$ be elements such that $\sum (\partial f_j/\partial x_k) \xi_k = f_j \bmod (f_1, \ldots, f_m)^2$. then for sufficiently large $i$ we can find elements $$ \xi_{k, i} \in (f_{1, i}, \ldots, f_{m, i})/(f_{1, i}, \ldots, f_{m, i})^2 $$ with $\sum (\partial f_{j, i}/\partial x_k) \xi_{k, i} = f_{j, i} \bmod (f_{1, i}, \ldots, f_{m, i})^2$ since this is true in the limit. then this $i$ works. \end{proof} \begin{lemma} \label{lemma-colimit-lci} let $a = \colim_{i \in i} a_i$ be a directed colimit of rings. let $0 \in i$ and $\varphi_0 : b_0 \to c_0$ a map of $a_0$-algebras. assume \begin{enumerate} \item $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is syntomic (resp.\ a relative global complete intersection), \item $c_0$ is of finite presentation over $b_0$. \end{enumerate} then there exists an $i \geq 0$ such that the map $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is syntomic (resp.\ a relative global complete intersection). \end{lemma} \begin{proof} assume $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is a relative global complete intersection. by lemma \ref{lemma-relative-global-complete-intersection-noetherian} there exists a finite type $\mathbf{z}$-algebra $r$, a ring map $r \to a \otimes_{a_0} b_0$, a relative global complete intersection $r \to s$, and an isomorphism $$ (a \otimes_{a_0} b_0) \otimes_r s \longrightarrow a \otimes_{a_0} c_0 $$ because $r$ is of finite type (and hence finite presentation) over $\mathbf{z}$, there exists an $i$ and a map $r \to a_i \otimes_{a_0} b_0$ lifting the map $r \to a \otimes_{a_0} b_0$, see lemma \ref{lemma-characterize-finite-presentation}. using the same lemma, there exists an $i' \geq i$ such that $(a_i \otimes_{a_0} b_0) \otimes_r s \to a \otimes_{a_0} c_0$ comes from a map $(a_i \otimes_{a_0} b_0) \otimes_r s \to a_{i'} \otimes_{a_0} c_0$. thus we may assume, after replacing $i$ by $i'$, that the displayed map comes from an $a_i \otimes_{a_0} b_0$-algebra map $$ (a_i \otimes_{a_0} b_0) \otimes_r s \longrightarrow a_i \otimes_{a_0} c_0 $$ by lemma \ref{lemma-colimit-isomorphism} after increasing $i$ this map is an isomorphism. this finishes the proof in this case because the base change of a relative global complete intersection is a relative global complete intersection by lemma \ref{lemma-base-change-relative-global-complete-intersection}. \medskip\noindent assume $a \otimes_{a_0} b_0 \to a \otimes_{a_0} c_0$ is syntomic. then there exist elements $g_1, \ldots, g_m$ in $a \otimes_{a_0} c_0$ generating the unit ideal such that $a \otimes_{a_0} b_0 \to (a \otimes_{a_0} c_0)_{g_j}$ is a relative global complete intersection, see lemma \ref{lemma-syntomic}. we can find an $i$ and elements $g_{i, j} \in a_i \otimes_{a_0} c_0$ mapping to $g_j$. after increasing $i$ we may assume $g_{i, 1}, \ldots, g_{i, m}$ generate the unit ideal of $a_i \otimes_{a_0} c_0$. the result of the previous paragraph implies that, after increasing $i$, we may assume the maps $a_i \otimes_{a_0} b_0 \to (a_i \otimes_{a_0} c_0)_{g_{i, j}}$ are relative global complete intersections. then $a_i \otimes_{a_0} b_0 \to a_i \otimes_{a_0} c_0$ is syntomic by lemma \ref{lemma-local-syntomic} (and the already used lemma \ref{lemma-syntomic}). \end{proof} \noindent the following lemma is an application of the results above which doesn't seem to fit well anywhere else. \begin{lemma} \label{lemma-fppf-fpqf} let $r \to s$ be a faithfully flat ring map of finite presentation. then there exists a commutative diagram $$ \xymatrix{ s \ar[rr] & & s' \\ & r \ar[lu] \ar[ru] } $$ where $r \to s'$ is quasi-finite, faithfully flat and of finite presentation. \end{lemma} \begin{proof} as a first step we reduce this lemma to the case where $r$ is of finite type over $\mathbf{z}$. by lemma \ref{lemma-descend-faithfully-flat-finite-presentation} there exists a diagram $$ \xymatrix{ s_0 \ar[r] & s \\ r_0 \ar[u] \ar[r] & r \ar[u] } $$ where $r_0$ is of finite type over $\mathbf{z}$, and $s_0$ is faithfully flat of finite presentation over $r_0$ such that $s = r \otimes_{r_0} s_0$. if we prove the lemma for the ring map $r_0 \to s_0$, then the lemma follows for $r \to s$ by base change, as the base change of a quasi-finite ring map is quasi-finite, see lemma \ref{lemma-quasi-finite-base-change}. (of course we also use that base changes of flat maps are flat and base changes of maps of finite presentation are of finite presentation.) \medskip\noindent assume $r \to s$ is a faithfully flat ring map of finite presentation and that $r$ is noetherian (which we may assume by the preceding paragraph). let $w \subset \spec(s)$ be the open set of lemma \ref{lemma-finite-presentation-flat-cm-locus-open}. as $r \to s$ is faithfully flat the map $\spec(s) \to \spec(r)$ is surjective, see lemma \ref{lemma-ff-rings}. by lemma \ref{lemma-generic-cm-flat-finite-presentation} the map $w \to \spec(r)$ is also surjective. hence by replacing $s$ with a product $s_{g_1} \times \ldots \times s_{g_m}$ we may assume $w = \spec(s)$; here we use that $\spec(r)$ is quasi-compact (lemma \ref{lemma-quasi-compact}), and that the map $\spec(s) \to \spec(r)$ is open (proposition \ref{proposition-fppf-open}). suppose that $\mathfrak p \subset r$ is a prime. choose a prime $\mathfrak q \subset s$ lying over $\mathfrak p$ which corresponds to a maximal ideal of the fibre ring $s \otimes_r \kappa(\mathfrak p)$. the noetherian local ring $\overline{s}_{\mathfrak q} = s_{\mathfrak q}/\mathfrak ps_{\mathfrak q}$ is cohen-macaulay, say of dimension $d$. we may choose $f_1, \ldots, f_d$ in the maximal ideal of $s_{\mathfrak q}$ which map to a regular sequence in $\overline{s}_{\mathfrak q}$. choose a common denominator $g \in s$, $g \not \in \mathfrak q$ of $f_1, \ldots, f_d$, and consider the $r$-algebra $$ s' = s_g/(f_1, \ldots, f_d). $$ by construction there is a prime ideal $\mathfrak q' \subset s'$ lying over $\mathfrak p$ and corresponding to $\mathfrak q$ (via $s_g \to s'_g$). also by construction the ring map $r \to s'$ is quasi-finite at $\mathfrak q$ as the local ring $$ s'_{\mathfrak q'}/\mathfrak ps'_{\mathfrak q'} = s_{\mathfrak q}/(f_1, \ldots, f_d) + \mathfrak ps_{\mathfrak q} = \overline{s}_{\mathfrak q}/(\overline{f}_1, \ldots, \overline{f}_d) $$ has dimension zero, see lemma \ref{lemma-isolated-point-fibre}. also by construction $r \to s'$ is of finite presentation. finally, by lemma \ref{lemma-grothendieck-regular-sequence} the local ring map $r_{\mathfrak p} \to s'_{\mathfrak q'}$ is flat (this is where we use that $r$ is noetherian). hence, by openness of flatness (theorem \ref{theorem-openness-flatness}), and openness of quasi-finiteness (lemma \ref{lemma-quasi-finite-open}) we may after replacing $g$ by $gg'$ for a suitable $g' \in s$, $g' \not \in \mathfrak q$ assume that $r \to s'$ is flat and quasi-finite. the image $\spec(s') \to \spec(r)$ is open and contains $\mathfrak p$. in other words we have shown a ring $s'$ as in the statement of the lemma exists (except possibly the faithfulness part) whose image contains any given prime. using one more time the quasi-compactness of $\spec(r)$ we see that a finite product of such rings does the job. \end{proof} \input{chapters} \bibliography{my} \bibliographystyle{amsalpha} \end{document}